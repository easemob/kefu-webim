!function(e,t,n){function i(e,t){return typeof e===t}function o(){var e,t,n,o,r,a,s;for(var c in v)if(v.hasOwnProperty(c)){if(e=[],t=v[c],t.name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(n=0;n<t.options.aliases.length;n++)e.push(t.options.aliases[n].toLowerCase());for(o=i(t.fn,"function")?t.fn():t.fn,r=0;r<e.length;r++)a=e[r],s=a.split("."),1===s.length?y[s[0]]=o:(!y[s[0]]||y[s[0]]instanceof Boolean||(y[s[0]]=new Boolean(y[s[0]])),y[s[0]][s[1]]=o),E.push((o?"":"no-")+s.join("-"))}}function r(){return"function"!=typeof t.createElement?t.createElement(arguments[0]):S?t.createElementNS.call(t,"http://www.w3.org/2000/svg",arguments[0]):t.createElement.apply(t,arguments)}function a(){var e=t.body;return e||(e=r(S?"svg":"body"),e.fake=!0),e}function s(e,n,i,o){var s,c,u,d,l="modernizr",p=r("div"),f=a();if(parseInt(i,10))for(;i--;)u=r("div"),u.id=o?o[i]:l+(i+1),p.appendChild(u);return s=r("style"),s.type="text/css",s.id="s"+l,(f.fake?f:p).appendChild(s),f.appendChild(p),s.styleSheet?s.styleSheet.cssText=e:s.appendChild(t.createTextNode(e)),p.id=l,f.fake&&(f.style.background="",f.style.overflow="hidden",d=h.style.overflow,h.style.overflow="hidden",h.appendChild(f)),c=n(p,e),f.fake?(f.parentNode.removeChild(f),h.style.overflow=d,h.offsetHeight):p.parentNode.removeChild(p),!!c}function c(e){return e.replace(/([a-z])-([a-z])/g,function(e,t,n){return t+n.toUpperCase()}).replace(/^-/,"")}function u(e,t){return!!~(""+e).indexOf(t)}function d(e,t){return function(){return e.apply(t,arguments)}}function l(e,t,n){var o;for(var r in e)if(e[r]in t)return n===!1?e[r]:(o=t[e[r]],i(o,"function")?d(o,n||t):o);return!1}function p(e){return e.replace(/([A-Z])/g,function(e,t){return"-"+t.toLowerCase()}).replace(/^ms-/,"-ms-")}function f(t,i){var o=t.length;if("CSS"in e&&"supports"in e.CSS){for(;o--;)if(e.CSS.supports(p(t[o]),i))return!0;return!1}if("CSSSupportsRule"in e){for(var r=[];o--;)r.push("("+p(t[o])+":"+i+")");return r=r.join(" or "),s("@supports ("+r+") { #modernizr { position: absolute; } }",function(e){return"absolute"==getComputedStyle(e,null).position})}return n}function m(e,t,o,a){function s(){l&&(delete R.style,delete R.modElem)}if(a=i(a,"undefined")?!1:a,!i(o,"undefined")){var d=f(e,o);if(!i(d,"undefined"))return d}for(var l,p,m,g,h,v=["modernizr","tspan","samp"];!R.style&&v.length;)l=!0,R.modElem=r(v.shift()),R.style=R.modElem.style;for(m=e.length,p=0;m>p;p++)if(g=e[p],h=R.style[g],u(g,"-")&&(g=c(g)),R.style[g]!==n){if(a||i(o,"undefined"))return s(),"pfx"==t?g:!0;try{R.style[g]=o}catch(_){}if(R.style[g]!=h)return s(),"pfx"==t?g:!0}return s(),!1}function g(e,t,n,o,r){var a=e.charAt(0).toUpperCase()+e.slice(1),s=(e+" "+I.join(a+" ")+a).split(" ");return i(t,"string")||i(t,"undefined")?m(s,t,o,r):(s=(e+" "+N.join(a+" ")+a).split(" "),l(s,t,n))}var h=t.documentElement,v=[],_={_version:"3.3.1",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var n=this;setTimeout(function(){t(n[e])},0)},addTest:function(e,t,n){v.push({name:e,fn:t,options:n})},addAsyncTest:function(e){v.push({name:null,fn:e})}},y=function(){};y.prototype=_,y=new y;var E=[],S="svg"===h.nodeName.toLowerCase();y.addTest("inlinesvg",function(){var e=r("div");return e.innerHTML="<svg/>","http://www.w3.org/2000/svg"==("undefined"!=typeof SVGRect&&e.firstChild&&e.firstChild.namespaceURI)});var T=function(){function e(e,t){var o;return e?(t&&"string"!=typeof t||(t=r(t||"div")),e="on"+e,o=e in t,!o&&i&&(t.setAttribute||(t=r("div")),t.setAttribute(e,""),o="function"==typeof t[e],t[e]!==n&&(t[e]=n),t.removeAttribute(e)),o):!1}var i=!("onblur"in t.documentElement);return e}();_.hasEvent=T;_.testStyles=s;y.addTest("oninput",function(){var n,i=r("input");if(i.setAttribute("oninput","return"),T("oninput",h)||"function"==typeof i.oninput)return!0;try{var o=t.createEvent("KeyboardEvent");n=!1;var a=function(e){n=!0,e.preventDefault(),e.stopPropagation()};o.initKeyEvent("keypress",!0,!0,e,!1,!1,!1,!1,0,"e".charCodeAt(0)),h.appendChild(i),i.addEventListener("input",a,!1),i.focus(),i.dispatchEvent(o),i.removeEventListener("input",a,!1),h.removeChild(i)}catch(s){n=!1}return n});var C="Moz O ms Webkit",I=_._config.usePrefixes?C.split(" "):[];_._cssomPrefixes=I;var b=function(t){var i,o=prefixes.length,r=e.CSSRule;if("undefined"==typeof r)return n;if(!t)return!1;if(t=t.replace(/^@/,""),i=t.replace(/-/g,"_").toUpperCase()+"_RULE",i in r)return"@"+t;for(var a=0;o>a;a++){var s=prefixes[a],c=s.toUpperCase()+"_"+i;if(c in r)return"@-"+s.toLowerCase()+"-"+t}return!1};_.atRule=b;var N=_._config.usePrefixes?C.toLowerCase().split(" "):[];_._domPrefixes=N;var O={elem:r("modernizr")};y._q.push(function(){delete O.elem});var R={style:O.elem.style};y._q.unshift(function(){delete R.style}),_.testAllProps=g;var w=_.prefixed=function(e,t,n){return 0===e.indexOf("@")?b(e):(-1!=e.indexOf("-")&&(e=c(e)),t?g(e,t,n):g(e,"pfx"))};y.addTest("peerconnection",!!w("RTCPeerConnection",e)),o(),delete _.addTest,delete _.addAsyncTest;for(var M=0;M<y._q.length;M++)y._q[M]();e.Modernizr=y}(window,document),function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;t="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,t.adapter=e()}}(function(){return function e(t,n,i){function o(a,s){if(!n[a]){if(!t[a]){var c="function"==typeof require&&require;if(!s&&c)return c(a,!0);if(r)return r(a,!0);var u=new Error("Cannot find module '"+a+"'");throw u.code="MODULE_NOT_FOUND",u}var d=n[a]={exports:{}};t[a][0].call(d.exports,function(e){var n=t[a][1][e];return o(n?n:e)},d,d.exports,e,t,n,i)}return n[a].exports}for(var r="function"==typeof require&&require,a=0;a<i.length;a++)o(i[a]);return o}({1:[function(e,t,n){"use strict";var i={};i.generateIdentifier=function(){return Math.random().toString(36).substr(2,10)},i.localCName=i.generateIdentifier(),i.splitLines=function(e){return e.trim().split("\n").map(function(e){return e.trim()})},i.splitSections=function(e){var t=e.split("\nm=");return t.map(function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"})},i.matchPrefix=function(e,t){return i.splitLines(e).filter(function(e){return 0===e.indexOf(t)})},i.parseCandidate=function(e){var t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");for(var n={foundation:t[0],component:t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],port:parseInt(t[5],10),type:t[7]},i=8;i<t.length;i+=2)switch(t[i]){case"raddr":n.relatedAddress=t[i+1];break;case"rport":n.relatedPort=parseInt(t[i+1],10);break;case"tcptype":n.tcpType=t[i+1]}return n},i.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.ip),t.push(e.port);var n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),"candidate:"+t.join(" ")},i.parseRtpMap=function(e){var t=e.substr(9).split(" "),n={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),n.name=t[0],n.clockRate=parseInt(t[1],10),n.numChannels=3===t.length?parseInt(t[2],10):1,n},i.writeRtpMap=function(e){var t=e.payloadType;return void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType),"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==e.numChannels?"/"+e.numChannels:"")+"\r\n"},i.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),uri:t[1]}},i.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+" "+e.uri+"\r\n"},i.parseFmtp=function(e){for(var t,n={},i=e.substr(e.indexOf(" ")+1).split(";"),o=0;o<i.length;o++)t=i[o].trim().split("="),n[t[0].trim()]=t[1];return n},i.writeFmtp=function(e){var t="",n=e.payloadType;if(void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var i=[];Object.keys(e.parameters).forEach(function(t){i.push(t+"="+e.parameters[t])}),t+="a=fmtp:"+n+" "+i.join(";")+"\r\n"}return t},i.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},i.writeRtcpFb=function(e){var t="",n=e.payloadType;return void 0!==e.preferredPayloadType&&(n=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach(function(e){t+="a=rtcp-fb:"+n+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"}),t},i.parseSsrcMedia=function(e){var t=e.indexOf(" "),n={ssrc:parseInt(e.substr(7,t-7),10)},i=e.indexOf(":",t);return i>-1?(n.attribute=e.substr(t+1,i-t-1),n.value=e.substr(i+1)):n.attribute=e.substr(t+1),n},i.getDtlsParameters=function(e,t){var n=i.splitLines(e);n=n.concat(i.splitLines(t));var o=n.filter(function(e){return 0===e.indexOf("a=fingerprint:")})[0].substr(14),r={role:"auto",fingerprints:[{algorithm:o.split(" ")[0],value:o.split(" ")[1]}]};return r},i.writeDtlsParameters=function(e,t){var n="a=setup:"+t+"\r\n";return e.fingerprints.forEach(function(e){n+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"}),n},i.getIceParameters=function(e,t){var n=i.splitLines(e);n=n.concat(i.splitLines(t));var o={usernameFragment:n.filter(function(e){return 0===e.indexOf("a=ice-ufrag:")})[0].substr(12),password:n.filter(function(e){return 0===e.indexOf("a=ice-pwd:")})[0].substr(10)};return o},i.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},i.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=i.splitLines(e),o=n[0].split(" "),r=3;r<o.length;r++){var a=o[r],s=i.matchPrefix(e,"a=rtpmap:"+a+" ")[0];if(s){var c=i.parseRtpMap(s),u=i.matchPrefix(e,"a=fmtp:"+a+" ");switch(c.parameters=u.length?i.parseFmtp(u[0]):{},c.rtcpFeedback=i.matchPrefix(e,"a=rtcp-fb:"+a+" ").map(i.parseRtcpFb),t.codecs.push(c),c.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(c.name.toUpperCase())}}}return i.matchPrefix(e,"a=extmap:").forEach(function(e){t.headerExtensions.push(i.parseExtmap(e))}),t},i.writeRtpDescription=function(e,t){var n="";return n+="m="+e+" ",n+=t.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=t.codecs.map(function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType}).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach(function(e){n+=i.writeRtpMap(e),n+=i.writeFmtp(e),n+=i.writeRtcpFb(e)}),n+="a=rtcp-mux\r\n"},i.parseRtpEncodingParameters=function(e){var t,n=[],o=i.parseRtpParameters(e),r=-1!==o.fecMechanisms.indexOf("RED"),a=-1!==o.fecMechanisms.indexOf("ULPFEC"),s=i.matchPrefix(e,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute}),c=s.length>0&&s[0].ssrc,u=i.matchPrefix(e,"a=ssrc-group:FID").map(function(e){var t=e.split(" ");return t.shift(),t.map(function(e){return parseInt(e,10)})});u.length>0&&u[0].length>1&&u[0][0]===c&&(t=u[0][1]),o.codecs.forEach(function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var i={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10),rtx:{payloadType:e.payloadType,ssrc:t}};n.push(i),r&&(i=JSON.parse(JSON.stringify(i)),i.fec={ssrc:t,mechanism:a?"red+ulpfec":"red"},n.push(i))}}),0===n.length&&c&&n.push({ssrc:c});var d=i.matchPrefix(e,"b=");return d.length&&(0===d[0].indexOf("b=TIAS:")?d=parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")&&(d=parseInt(d[0].substr(5),10)),n.forEach(function(e){e.maxBitrate=d})),n},i.writeSessionBoilerplate=function(){return"v=0\r\no=thisisadapterortc 8169639915646943137 2 IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},i.writeMediaSection=function(e,t,n,o){var r=i.writeRtpDescription(e.kind,t);if(r+=i.writeIceParameters(e.iceGatherer.getLocalParameters()),r+=i.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===n?"actpass":"active"),r+="a=mid:"+e.mid+"\r\n",r+=e.rtpSender&&e.rtpReceiver?"a=sendrecv\r\n":e.rtpSender?"a=sendonly\r\n":e.rtpReceiver?"a=recvonly\r\n":"a=inactive\r\n",e.rtpSender){var a="msid:"+o.id+" "+e.rtpSender.track.id+"\r\n";r+="a="+a,r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a}return r+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+i.localCName+"\r\n"},i.getDirection=function(e,t){for(var n=i.splitLines(e),o=0;o<n.length;o++)switch(n[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[o].substr(2)}return t?i.getDirection(t):"sendrecv"},t.exports=i},{}],2:[function(e,t,n){"use strict";!function(){var n=e("./utils").log,i=e("./utils").browserDetails;t.exports.browserDetails=i,t.exports.extractVersion=e("./utils").extractVersion,t.exports.disableLog=e("./utils").disableLog;var o=e("./chrome/chrome_shim")||null,r=e("./edge/edge_shim")||null,a=e("./firefox/firefox_shim")||null,s=e("./safari/safari_shim")||null;switch(i.browser){case"opera":case"chrome":if(!o||!o.shimPeerConnection)return void n("Chrome shim is not included in this adapter release.");n("adapter.js shimming chrome."),t.exports.browserShim=o,o.shimGetUserMedia(),o.shimMediaStream(),o.shimSourceObject(),o.shimPeerConnection(),o.shimOnTrack();break;case"firefox":if(!a||!a.shimPeerConnection)return void n("Firefox shim is not included in this adapter release.");n("adapter.js shimming firefox."),t.exports.browserShim=a,a.shimGetUserMedia(),a.shimSourceObject(),a.shimPeerConnection(),a.shimOnTrack();break;case"edge":if(!r||!r.shimPeerConnection)return void n("MS edge shim is not included in this adapter release.");n("adapter.js shimming edge."),t.exports.browserShim=r,r.shimGetUserMedia(),r.shimPeerConnection();break;case"safari":if(!s)return void n("Safari shim is not included in this adapter release.");n("adapter.js shimming safari."),t.exports.browserShim=s,s.shimGetUserMedia();break;default:n("Unsupported browser!")}}()},{"./chrome/chrome_shim":3,"./edge/edge_shim":5,"./firefox/firefox_shim":7,"./safari/safari_shim":9,"./utils":10}],3:[function(e,t,n){"use strict";var i=e("../utils.js").log,o=e("../utils.js").browserDetails,r={shimMediaStream:function(){window.MediaStream=window.MediaStream||window.webkitMediaStream},shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){var t=this;this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.addEventListener("addtrack",function(n){var i=new Event("track");i.track=n.track,i.receiver={track:n.track},i.streams=[e.stream],t.dispatchEvent(i)}),e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this._srcObject},set:function(e){var t=this;return this._srcObject=e,this.src&&URL.revokeObjectURL(this.src),e?(this.src=URL.createObjectURL(e),e.addEventListener("addtrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)}),void e.addEventListener("removetrack",function(){t.src&&URL.revokeObjectURL(t.src),t.src=URL.createObjectURL(e)})):void(this.src="")}}))},shimPeerConnection:function(){window.RTCPeerConnection=function(e,t){i("PeerConnection"),e&&e.iceTransportPolicy&&(e.iceTransports=e.iceTransportPolicy);var n=new webkitRTCPeerConnection(e,t),o=n.getStats.bind(n);return n.getStats=function(e,t,n){var i=this,r=arguments;if(arguments.length>0&&"function"==typeof e)return o(e,t);var a=function(e){var t={},n=e.result();return n.forEach(function(e){var n={id:e.id,timestamp:e.timestamp,type:e.type};e.names().forEach(function(t){n[t]=e.stat(t)}),t[n.id]=n}),t},s=function(e,t){var n=new Map(Object.keys(e).map(function(t){return[t,e[t]]}));return t=t||e,Object.keys(t).forEach(function(e){n[e]=t[e]}),n};if(arguments.length>=2){var c=function(e){r[1](s(a(e)))};return o.apply(this,[c,arguments[0]])}return new Promise(function(t,n){1===r.length&&"object"==typeof e?o.apply(i,[function(e){t(s(a(e)))},n]):o.apply(i,[function(e){t(s(a(e),e.result()))},n])}).then(t,n)},n},window.RTCPeerConnection.prototype=webkitRTCPeerConnection.prototype,webkitRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return webkitRTCPeerConnection.generateCertificate}}),["createOffer","createAnswer"].forEach(function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=this;if(arguments.length<1||1===arguments.length&&"object"==typeof arguments[0]){var n=1===arguments.length?arguments[0]:void 0;return new Promise(function(i,o){t.apply(e,[i,o,n])})}return t.apply(this,arguments)}}),o.version<51&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){var e=arguments,n=this,i=new Promise(function(i,o){t.apply(n,[e[0],i,o])});return e.length<2?i:i.then(function(){e[1].apply(null,[])},function(t){e.length>=3&&e[2].apply(null,[t])})}}),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=webkitRTCPeerConnection.prototype[e];webkitRTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):e.apply(this,arguments)}}};t.exports={shimMediaStream:r.shimMediaStream,shimOnTrack:r.shimOnTrack,shimSourceObject:r.shimSourceObject,shimPeerConnection:r.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils.js":10,"./getusermedia":4}],4:[function(e,t,n){"use strict";var i=e("../utils.js").log;t.exports=function(){var e=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i="object"==typeof e[n]?e[n]:{ideal:e[n]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var o=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var r={};"number"==typeof i.ideal?(r[o("min",n)]=i.ideal,t.optional.push(r),r={},r[o("max",n)]=i.ideal,t.optional.push(r)):(r[o("",n)]=i.ideal,t.optional.push(r))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[o("",n)]=i.exact):["min","max"].forEach(function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[o(e,n)]=i[e])})}}),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},t=function(t,n){if(t=JSON.parse(JSON.stringify(t)),t&&t.audio&&(t.audio=e(t.audio)),t&&"object"==typeof t.video){var o=t.video.facingMode;if(o=o&&("object"==typeof o?o:{ideal:o}),o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!navigator.mediaDevices.getSupportedConstraints||!navigator.mediaDevices.getSupportedConstraints().facingMode)&&(delete t.video.facingMode,"environment"===o.exact||"environment"===o.ideal))return navigator.mediaDevices.enumerateDevices().then(function(r){r=r.filter(function(e){return"videoinput"===e.kind});var a=r.find(function(e){return-1!==e.label.toLowerCase().indexOf("back")})||r.length&&r[r.length-1];return a&&(t.video.deviceId=o.exact?{exact:a.deviceId}:{ideal:a.deviceId}),t.video=e(t.video),i("chrome: "+JSON.stringify(t)),n(t)});t.video=e(t.video)}return i("chrome: "+JSON.stringify(t)),n(t)},n=function(e){return{name:{PermissionDeniedError:"NotAllowedError",ConstraintNotSatisfiedError:"OverconstrainedError"}[e.name]||e.name,message:e.message,constraint:e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}},o=function(e,i,o){t(e,function(e){navigator.webkitGetUserMedia(e,i,function(e){o(n(e))})})};navigator.getUserMedia=o;var r=function(e){return new Promise(function(t,n){navigator.getUserMedia(e,t,n)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:r,enumerateDevices:function(){return new Promise(function(e){var t={audio:"audioinput",video:"videoinput"};return MediaStreamTrack.getSources(function(n){e(n.map(function(e){return{label:e.label,kind:t[e.kind],deviceId:e.id,groupId:""}}))})})}}),navigator.mediaDevices.getUserMedia){var a=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(e){return t(e,function(e){return a(e).then(function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach(function(e){e.stop()}),new DOMException("","NotFoundError");return t},function(e){return Promise.reject(n(e))})})}}else navigator.mediaDevices.getUserMedia=function(e){return r(e)};"undefined"==typeof navigator.mediaDevices.addEventListener&&(navigator.mediaDevices.addEventListener=function(){i("Dummy mediaDevices.addEventListener called.")}),"undefined"==typeof navigator.mediaDevices.removeEventListener&&(navigator.mediaDevices.removeEventListener=function(){i("Dummy mediaDevices.removeEventListener called.")})}},{"../utils.js":10}],5:[function(e,t,n){"use strict";var i=e("sdp"),o=e("../utils").browserDetails,r={shimPeerConnection:function(){window.RTCIceGatherer&&(window.RTCIceCandidate||(window.RTCIceCandidate=function(e){return e}),window.RTCSessionDescription||(window.RTCSessionDescription=function(e){return e})),window.RTCPeerConnection=function(e){var t=this,n=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach(function(e){t[e]=n[e].bind(n)}),this.onicecandidate=null,this.onaddstream=null,this.ontrack=null,this.onremovestream=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,this.onnegotiationneeded=null,this.ondatachannel=null,this.localStreams=[],this.remoteStreams=[],this.getLocalStreams=function(){return t.localStreams},this.getRemoteStreams=function(){return t.remoteStreams},this.localDescription=new RTCSessionDescription({type:"",sdp:""}),this.remoteDescription=new RTCSessionDescription({type:"",sdp:""}),this.signalingState="stable",this.iceConnectionState="new",this.iceGatheringState="new",this.iceOptions={gatherPolicy:"all",iceServers:[]},e&&e.iceTransportPolicy)switch(e.iceTransportPolicy){case"all":case"relay":this.iceOptions.gatherPolicy=e.iceTransportPolicy;break;case"none":throw new TypeError('iceTransportPolicy "none" not supported')}if(this.usingBundle=e&&"max-bundle"===e.bundlePolicy,e&&e.iceServers){var i=JSON.parse(JSON.stringify(e.iceServers));this.iceOptions.iceServers=i.filter(function(e){if(e&&e.urls){var t=e.urls;return"string"==typeof t&&(t=[t]),t=t.filter(function(e){return 0===e.indexOf("turn:")&&-1!==e.indexOf("transport=udp")&&-1===e.indexOf("turn:[")||0===e.indexOf("stun:")&&o.version>=14393})[0],!!t}return!1})}this._config=e,this.transceivers=[],this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype._emitBufferedCandidates=function(){var e=this,t=i.splitSections(e.localDescription.sdp);this._localIceCandidatesBuffer.forEach(function(n){var i=!n.candidate||0===Object.keys(n.candidate).length;if(i)for(var o=1;o<t.length;o++)-1===t[o].indexOf("\r\na=end-of-candidates\r\n")&&(t[o]+="a=end-of-candidates\r\n");else-1===n.candidate.candidate.indexOf("typ endOfCandidates")&&(t[n.candidate.sdpMLineIndex+1]+="a="+n.candidate.candidate+"\r\n");if(e.localDescription.sdp=t.join(""),e.dispatchEvent(n),null!==e.onicecandidate&&e.onicecandidate(n),!n.candidate&&"complete"!==e.iceGatheringState){var r=e.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});r&&(e.iceGatheringState="complete")}}),this._localIceCandidatesBuffer=[]},window.RTCPeerConnection.prototype.getConfiguration=function(){return this._config},window.RTCPeerConnection.prototype.addStream=function(e){this.localStreams.push(e.clone()),this._maybeFireNegotiationNeeded()},window.RTCPeerConnection.prototype.removeStream=function(e){var t=this.localStreams.indexOf(e);t>-1&&(this.localStreams.splice(t,1),this._maybeFireNegotiationNeeded())},window.RTCPeerConnection.prototype.getSenders=function(){return this.transceivers.filter(function(e){return!!e.rtpSender}).map(function(e){return e.rtpSender})},window.RTCPeerConnection.prototype.getReceivers=function(){return this.transceivers.filter(function(e){return!!e.rtpReceiver}).map(function(e){return e.rtpReceiver})},window.RTCPeerConnection.prototype._getCommonCapabilities=function(e,t){var n={codecs:[],headerExtensions:[],fecMechanisms:[]};return e.codecs.forEach(function(e){for(var i=0;i<t.codecs.length;i++){var o=t.codecs[i];if(e.name.toLowerCase()===o.name.toLowerCase()&&e.clockRate===o.clockRate&&e.numChannels===o.numChannels){n.codecs.push(o),o.rtcpFeedback=o.rtcpFeedback.filter(function(t){for(var n=0;n<e.rtcpFeedback.length;n++)if(e.rtcpFeedback[n].type===t.type&&e.rtcpFeedback[n].parameter===t.parameter)return!0;return!1});break}}}),e.headerExtensions.forEach(function(e){for(var i=0;i<t.headerExtensions.length;i++){var o=t.headerExtensions[i];if(e.uri===o.uri){n.headerExtensions.push(o);break}}}),n},window.RTCPeerConnection.prototype._createIceAndDtlsTransports=function(e,t){var n=this,o=new RTCIceGatherer(n.iceOptions),r=new RTCIceTransport(o);o.onlocalcandidate=function(a){var s=new Event("icecandidate");s.candidate={sdpMid:e,sdpMLineIndex:t};var c=a.candidate,u=!c||0===Object.keys(c).length;u?(void 0===o.state&&(o.state="completed"),s.candidate.candidate="candidate:1 1 udp 1 0.0.0.0 9 typ endOfCandidates"):(c.component="RTCP"===r.component?2:1,s.candidate.candidate=i.writeCandidate(c));var d=i.splitSections(n.localDescription.sdp);-1===s.candidate.candidate.indexOf("typ endOfCandidates")?d[s.candidate.sdpMLineIndex+1]+="a="+s.candidate.candidate+"\r\n":d[s.candidate.sdpMLineIndex+1]+="a=end-of-candidates\r\n",n.localDescription.sdp=d.join("");var l=n.transceivers.every(function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state});switch(n.iceGatheringState){case"new":n._localIceCandidatesBuffer.push(s),u&&l&&n._localIceCandidatesBuffer.push(new Event("icecandidate"));break;case"gathering":n._emitBufferedCandidates(),n.dispatchEvent(s),null!==n.onicecandidate&&n.onicecandidate(s),l&&(n.dispatchEvent(new Event("icecandidate")),null!==n.onicecandidate&&n.onicecandidate(new Event("icecandidate")),n.iceGatheringState="complete");break;case"complete":}},r.onicestatechange=function(){n._updateConnectionState()};var a=new RTCDtlsTransport(r);return a.ondtlsstatechange=function(){n._updateConnectionState()},a.onerror=function(){a.state="failed",n._updateConnectionState()},{iceGatherer:o,iceTransport:r,dtlsTransport:a}},window.RTCPeerConnection.prototype._transceive=function(e,t,n){var o=this._getCommonCapabilities(e.localCapabilities,e.remoteCapabilities);t&&e.rtpSender&&(o.encodings=e.sendEncodingParameters,o.rtcp={cname:i.localCName},e.recvEncodingParameters.length&&(o.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(o)),n&&e.rtpReceiver&&("video"===e.kind&&e.recvEncodingParameters&&e.recvEncodingParameters.forEach(function(e){delete e.rtx}),o.encodings=e.recvEncodingParameters,o.rtcp={cname:e.cname},e.sendEncodingParameters.length&&(o.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(o))},window.RTCPeerConnection.prototype.setLocalDescription=function(e){var t,n,o=this;if("offer"===e.type)this._pendingOffer&&(t=i.splitSections(e.sdp),n=t.shift(),t.forEach(function(e,t){var n=i.parseRtpParameters(e);o._pendingOffer[t].localCapabilities=n}),this.transceivers=this._pendingOffer,delete this._pendingOffer);else if("answer"===e.type){t=i.splitSections(o.remoteDescription.sdp),n=t.shift();var r=i.matchPrefix(n,"a=ice-lite").length>0;t.forEach(function(e,t){var a=o.transceivers[t],s=a.iceGatherer,c=a.iceTransport,u=a.dtlsTransport,d=a.localCapabilities,l=a.remoteCapabilities,p="0"===e.split("\n",1)[0].split(" ",2)[1];if(!p&&!a.isDatachannel){var f=i.getIceParameters(e,n);if(r){var m=i.matchPrefix(e,"a=candidate:").map(function(e){return i.parseCandidate(e)}).filter(function(e){return"1"===e.component});m.length&&c.setRemoteCandidates(m)}var g=i.getDtlsParameters(e,n);r&&(g.role="server"),o.usingBundle&&0!==t||(c.start(s,f,r?"controlling":"controlled"),u.start(g));var h=o._getCommonCapabilities(d,l);o._transceive(a,h.codecs.length>0,!1)}})}switch(this.localDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-local-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}var a=arguments.length>1&&"function"==typeof arguments[1];if(a){var s=arguments[1];window.setTimeout(function(){s(),"new"===o.iceGatheringState&&(o.iceGatheringState="gathering"),o._emitBufferedCandidates()},0)}var c=Promise.resolve();return c.then(function(){a||("new"===o.iceGatheringState&&(o.iceGatheringState="gathering"),window.setTimeout(o._emitBufferedCandidates.bind(o),500))}),c},window.RTCPeerConnection.prototype.setRemoteDescription=function(e){var t=this,n=new MediaStream,o=[],r=i.splitSections(e.sdp),a=r.shift(),s=i.matchPrefix(a,"a=ice-lite").length>0;switch(this.usingBundle=i.matchPrefix(a,"a=group:BUNDLE ").length>0,r.forEach(function(r,c){var u=i.splitLines(r),d=u[0].substr(2).split(" "),l=d[0],p="0"===d[1],f=i.getDirection(r,a),m=i.matchPrefix(r,"a=mid:");if(m=m.length?m[0].substr(6):i.generateIdentifier(),"application"===l&&"DTLS/SCTP"===d[2])return void(t.transceivers[c]={mid:m,isDatachannel:!0});var g,h,v,_,y,E,S,T,C,I,b,N,O=i.parseRtpParameters(r);p||(b=i.getIceParameters(r,a),N=i.getDtlsParameters(r,a),N.role="client"),T=i.parseRtpEncodingParameters(r);var R,w=i.matchPrefix(r,"a=ssrc:").map(function(e){return i.parseSsrcMedia(e)}).filter(function(e){return"cname"===e.attribute})[0];w&&(R=w.value);var M=i.matchPrefix(r,"a=end-of-candidates",a).length>0,x=i.matchPrefix(r,"a=candidate:").map(function(e){return i.parseCandidate(e)}).filter(function(e){return"1"===e.component});if("offer"!==e.type||p)"answer"!==e.type||p||(g=t.transceivers[c],h=g.iceGatherer,v=g.iceTransport,_=g.dtlsTransport,y=g.rtpSender,E=g.rtpReceiver,S=g.sendEncodingParameters,C=g.localCapabilities,t.transceivers[c].recvEncodingParameters=T,t.transceivers[c].remoteCapabilities=O,t.transceivers[c].cname=R,(s||M)&&x.length&&v.setRemoteCandidates(x),t.usingBundle&&0!==c||(v.start(h,b,"controlling"),_.start(N)),t._transceive(g,"sendrecv"===f||"recvonly"===f,"sendrecv"===f||"sendonly"===f),!E||"sendrecv"!==f&&"sendonly"!==f?delete g.rtpReceiver:(I=E.track,o.push([I,E]),n.addTrack(I)));else{var A=t.usingBundle&&c>0?{iceGatherer:t.transceivers[0].iceGatherer,iceTransport:t.transceivers[0].iceTransport,dtlsTransport:t.transceivers[0].dtlsTransport}:t._createIceAndDtlsTransports(m,c);if(M&&A.iceTransport.setRemoteCandidates(x),C=RTCRtpReceiver.getCapabilities(l),C.codecs=C.codecs.filter(function(e){return"rtx"!==e.name}),S=[{ssrc:1001*(2*c+2)}],E=new RTCRtpReceiver(A.dtlsTransport,l),I=E.track,o.push([I,E]),n.addTrack(I),t.localStreams.length>0&&t.localStreams[0].getTracks().length>=c){var k;"audio"===l?k=t.localStreams[0].getAudioTracks()[0]:"video"===l&&(k=t.localStreams[0].getVideoTracks()[0]),k&&(y=new RTCRtpSender(k,A.dtlsTransport))}t.transceivers[c]={iceGatherer:A.iceGatherer,iceTransport:A.iceTransport,dtlsTransport:A.dtlsTransport,
localCapabilities:C,remoteCapabilities:O,rtpSender:y,rtpReceiver:E,kind:l,mid:m,cname:R,sendEncodingParameters:S,recvEncodingParameters:T},t._transceive(t.transceivers[c],!1,"sendrecv"===f||"sendonly"===f)}}),this.remoteDescription={type:e.type,sdp:e.sdp},e.type){case"offer":this._updateSignalingState("have-remote-offer");break;case"answer":this._updateSignalingState("stable");break;default:throw new TypeError('unsupported type "'+e.type+'"')}return n.getTracks().length&&(t.remoteStreams.push(n),window.setTimeout(function(){var e=new Event("addstream");e.stream=n,t.dispatchEvent(e),null!==t.onaddstream&&window.setTimeout(function(){t.onaddstream(e)},0),o.forEach(function(i){var o=i[0],r=i[1],a=new Event("track");a.track=o,a.receiver=r,a.streams=[n],t.dispatchEvent(e),null!==t.ontrack&&window.setTimeout(function(){t.ontrack(a)},0)})},0)),arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.close=function(){this.transceivers.forEach(function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()}),this._updateSignalingState("closed")},window.RTCPeerConnection.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this.dispatchEvent(t),null!==this.onsignalingstatechange&&this.onsignalingstatechange(t)},window.RTCPeerConnection.prototype._maybeFireNegotiationNeeded=function(){var e=new Event("negotiationneeded");this.dispatchEvent(e),null!==this.onnegotiationneeded&&this.onnegotiationneeded(e)},window.RTCPeerConnection.prototype._updateConnectionState=function(){var e,t=this,n={"new":0,closed:0,connecting:0,checking:0,connected:0,completed:0,failed:0};if(this.transceivers.forEach(function(e){n[e.iceTransport.state]++,n[e.dtlsTransport.state]++}),n.connected+=n.completed,e="new",n.failed>0?e="failed":n.connecting>0||n.checking>0?e="connecting":n.disconnected>0?e="disconnected":n["new"]>0?e="new":(n.connected>0||n.completed>0)&&(e="connected"),e!==t.iceConnectionState){t.iceConnectionState=e;var i=new Event("iceconnectionstatechange");this.dispatchEvent(i),null!==this.oniceconnectionstatechange&&this.oniceconnectionstatechange(i)}},window.RTCPeerConnection.prototype.createOffer=function(){var e=this;if(this._pendingOffer)throw new Error("createOffer called while there is a pending offer.");var t;1===arguments.length&&"function"!=typeof arguments[0]?t=arguments[0]:3===arguments.length&&(t=arguments[2]);var n=[],o=0,r=0;if(this.localStreams.length&&(o=this.localStreams[0].getAudioTracks().length,r=this.localStreams[0].getVideoTracks().length),t){if(t.mandatory||t.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==t.offerToReceiveAudio&&(o=t.offerToReceiveAudio),void 0!==t.offerToReceiveVideo&&(r=t.offerToReceiveVideo)}for(this.localStreams.length&&this.localStreams[0].getTracks().forEach(function(e){n.push({kind:e.kind,track:e,wantReceive:"audio"===e.kind?o>0:r>0}),"audio"===e.kind?o--:"video"===e.kind&&r--});o>0||r>0;)o>0&&(n.push({kind:"audio",wantReceive:!0}),o--),r>0&&(n.push({kind:"video",wantReceive:!0}),r--);var a=i.writeSessionBoilerplate(),s=[];n.forEach(function(t,n){var o=t.track,r=t.kind,a=i.generateIdentifier(),c=e.usingBundle&&n>0?{iceGatherer:s[0].iceGatherer,iceTransport:s[0].iceTransport,dtlsTransport:s[0].dtlsTransport}:e._createIceAndDtlsTransports(a,n),u=RTCRtpSender.getCapabilities(r);u.codecs=u.codecs.filter(function(e){return"rtx"!==e.name}),u.codecs.forEach(function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1")});var d,l,p=[{ssrc:1001*(2*n+1)}];o&&(d=new RTCRtpSender(o,c.dtlsTransport)),t.wantReceive&&(l=new RTCRtpReceiver(c.dtlsTransport,r)),s[n]={iceGatherer:c.iceGatherer,iceTransport:c.iceTransport,dtlsTransport:c.dtlsTransport,localCapabilities:u,remoteCapabilities:null,rtpSender:d,rtpReceiver:l,kind:r,mid:a,sendEncodingParameters:p,recvEncodingParameters:null}}),this.usingBundle&&(a+="a=group:BUNDLE "+s.map(function(e){return e.mid}).join(" ")+"\r\n"),n.forEach(function(t,n){var o=s[n];a+=i.writeMediaSection(o,o.localCapabilities,"offer",e.localStreams[0])}),this._pendingOffer=s;var c=new RTCSessionDescription({type:"offer",sdp:a});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,c),Promise.resolve(c)},window.RTCPeerConnection.prototype.createAnswer=function(){var e=this,t=i.writeSessionBoilerplate();this.usingBundle&&(t+="a=group:BUNDLE "+this.transceivers.map(function(e){return e.mid}).join(" ")+"\r\n"),this.transceivers.forEach(function(n){if(n.isDatachannel)return void(t+="m=application 0 DTLS/SCTP 5000\r\nc=IN IP4 0.0.0.0\r\na=mid:"+n.mid+"\r\n");var o=e._getCommonCapabilities(n.localCapabilities,n.remoteCapabilities);t+=i.writeMediaSection(n,o,"answer",e.localStreams[0])});var n=new RTCSessionDescription({type:"answer",sdp:t});return arguments.length&&"function"==typeof arguments[0]&&window.setTimeout(arguments[0],0,n),Promise.resolve(n)},window.RTCPeerConnection.prototype.addIceCandidate=function(e){if(null===e)this.transceivers.forEach(function(e){e.iceTransport.addRemoteCandidate({})});else{var t=e.sdpMLineIndex;if(e.sdpMid)for(var n=0;n<this.transceivers.length;n++)if(this.transceivers[n].mid===e.sdpMid){t=n;break}var o=this.transceivers[t];if(o){var r=Object.keys(e.candidate).length>0?i.parseCandidate(e.candidate):{};if("tcp"===r.protocol&&(0===r.port||9===r.port))return;if("1"!==r.component)return;"endOfCandidates"===r.type&&(r={}),o.iceTransport.addRemoteCandidate(r);var a=i.splitSections(this.remoteDescription.sdp);a[t+1]+=(r.type?e.candidate.trim():"a=end-of-candidates")+"\r\n",this.remoteDescription.sdp=a.join("")}}return arguments.length>1&&"function"==typeof arguments[1]&&window.setTimeout(arguments[1],0),Promise.resolve()},window.RTCPeerConnection.prototype.getStats=function(){var e=[];this.transceivers.forEach(function(t){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(n){t[n]&&e.push(t[n].getStats())})});var t=arguments.length>1&&"function"==typeof arguments[1]&&arguments[1];return new Promise(function(n){var i=new Map;Promise.all(e).then(function(e){e.forEach(function(e){Object.keys(e).forEach(function(t){i.set(t,e[t]),i[t]=e[t]})}),t&&window.setTimeout(t,0,i),n(i)})})}}};t.exports={shimPeerConnection:r.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":6,sdp:1}],6:[function(e,t,n){"use strict";t.exports=function(){var e=function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}},t=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(n){return t(n)["catch"](function(t){return Promise.reject(e(t))})}}},{}],7:[function(e,t,n){"use strict";var i=e("../utils").browserDetails,o={shimOnTrack:function(){"object"!=typeof window||!window.RTCPeerConnection||"ontrack"in window.RTCPeerConnection.prototype||Object.defineProperty(window.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&(this.removeEventListener("track",this._ontrack),this.removeEventListener("addstream",this._ontrackpoly)),this.addEventListener("track",this._ontrack=e),this.addEventListener("addstream",this._ontrackpoly=function(e){e.stream.getTracks().forEach(function(t){var n=new Event("track");n.track=t,n.receiver={track:t},n.streams=[e.stream],this.dispatchEvent(n)}.bind(this))}.bind(this))}})},shimSourceObject:function(){"object"==typeof window&&(!window.HTMLMediaElement||"srcObject"in window.HTMLMediaElement.prototype||Object.defineProperty(window.HTMLMediaElement.prototype,"srcObject",{get:function(){return this.mozSrcObject},set:function(e){this.mozSrcObject=e}}))},shimPeerConnection:function(){if("object"==typeof window&&(window.RTCPeerConnection||window.mozRTCPeerConnection)){window.RTCPeerConnection||(window.RTCPeerConnection=function(e,t){if(i.version<38&&e&&e.iceServers){for(var n=[],o=0;o<e.iceServers.length;o++){var r=e.iceServers[o];if(r.hasOwnProperty("urls"))for(var a=0;a<r.urls.length;a++){var s={url:r.urls[a]};0===r.urls[a].indexOf("turn")&&(s.username=r.username,s.credential=r.credential),n.push(s)}else n.push(e.iceServers[o])}e.iceServers=n}return new mozRTCPeerConnection(e,t)},window.RTCPeerConnection.prototype=mozRTCPeerConnection.prototype,mozRTCPeerConnection.generateCertificate&&Object.defineProperty(window.RTCPeerConnection,"generateCertificate",{get:function(){return mozRTCPeerConnection.generateCertificate}}),window.RTCSessionDescription=mozRTCSessionDescription,window.RTCIceCandidate=mozRTCIceCandidate),["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(e){var t=RTCPeerConnection.prototype[e];RTCPeerConnection.prototype[e]=function(){return arguments[0]=new("addIceCandidate"===e?RTCIceCandidate:RTCSessionDescription)(arguments[0]),t.apply(this,arguments)}});var e=RTCPeerConnection.prototype.addIceCandidate;RTCPeerConnection.prototype.addIceCandidate=function(){return null===arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):e.apply(this,arguments)};var t=function(e){var t=new Map;return Object.keys(e).forEach(function(n){t.set(n,e[n]),t[n]=e[n]}),t},n=RTCPeerConnection.prototype.getStats;RTCPeerConnection.prototype.getStats=function(e,i,o){return n.apply(this,[e||null]).then(function(e){return t(e)}).then(i,o)}}}};t.exports={shimOnTrack:o.shimOnTrack,shimSourceObject:o.shimSourceObject,shimPeerConnection:o.shimPeerConnection,shimGetUserMedia:e("./getusermedia")}},{"../utils":10,"./getusermedia":8}],8:[function(e,t,n){"use strict";var i=e("../utils").log,o=e("../utils").browserDetails;t.exports=function(){var e=function(e){return{name:{SecurityError:"NotAllowedError",PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:{"The operation is insecure.":"The request is not allowed by the user agent or the platform in the current context."}[e.message]||e.message,constraint:e.constraint,toString:function(){return this.name+(this.message&&": ")+this.message}}},t=function(t,n,r){var a=function(e){if("object"!=typeof e||e.require)return e;var t=[];return Object.keys(e).forEach(function(n){if("require"!==n&&"advanced"!==n&&"mediaSource"!==n){var i=e[n]="object"==typeof e[n]?e[n]:{ideal:e[n]};if((void 0!==i.min||void 0!==i.max||void 0!==i.exact)&&t.push(n),void 0!==i.exact&&("number"==typeof i.exact?i.min=i.max=i.exact:e[n]=i.exact,delete i.exact),void 0!==i.ideal){e.advanced=e.advanced||[];var o={};"number"==typeof i.ideal?o[n]={min:i.ideal,max:i.ideal}:o[n]=i.ideal,e.advanced.push(o),delete i.ideal,Object.keys(i).length||delete e[n]}}}),t.length&&(e.require=t),e};return t=JSON.parse(JSON.stringify(t)),o.version<38&&(i("spec: "+JSON.stringify(t)),t.audio&&(t.audio=a(t.audio)),t.video&&(t.video=a(t.video)),i("ff37: "+JSON.stringify(t))),navigator.mozGetUserMedia(t,n,function(t){r(e(t))})},n=function(e){return new Promise(function(n,i){t(e,n,i)})};if(navigator.mediaDevices||(navigator.mediaDevices={getUserMedia:n,addEventListener:function(){},removeEventListener:function(){}}),navigator.mediaDevices.enumerateDevices=navigator.mediaDevices.enumerateDevices||function(){return new Promise(function(e){var t=[{kind:"audioinput",deviceId:"default",label:"",groupId:""},{kind:"videoinput",deviceId:"default",label:"",groupId:""}];e(t)})},o.version<41){var r=navigator.mediaDevices.enumerateDevices.bind(navigator.mediaDevices);navigator.mediaDevices.enumerateDevices=function(){return r().then(void 0,function(e){if("NotFoundError"===e.name)return[];throw e})}}if(o.version<49){var a=navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);navigator.mediaDevices.getUserMedia=function(t){return a(t).then(function(e){if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach(function(e){e.stop()}),new DOMException("The object can not be found here.","NotFoundError");return e},function(t){return Promise.reject(e(t))})}}navigator.getUserMedia=function(e,n,i){return o.version<44?t(e,n,i):(console.warn("navigator.getUserMedia has been replaced by navigator.mediaDevices.getUserMedia"),void navigator.mediaDevices.getUserMedia(e).then(n,i))}}},{"../utils":10}],9:[function(e,t,n){"use strict";var i={shimGetUserMedia:function(){navigator.getUserMedia=navigator.webkitGetUserMedia}};t.exports={shimGetUserMedia:i.shimGetUserMedia}},{}],10:[function(e,t,n){"use strict";var i=!0,o={disableLog:function(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(i=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},log:function(){if("object"==typeof window){if(i)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},extractVersion:function(e,t,n){var i=e.match(t);return i&&i.length>=n&&parseInt(i[n],10)},detectBrowser:function(){var e={};if(e.browser=null,e.version=null,"undefined"==typeof window||!window.navigator)return e.browser="Not a browser.",e;if(navigator.mozGetUserMedia)e.browser="firefox",e.version=this.extractVersion(navigator.userAgent,/Firefox\/([0-9]+)\./,1);else if(navigator.webkitGetUserMedia)if(window.webkitRTCPeerConnection)e.browser="chrome",e.version=this.extractVersion(navigator.userAgent,/Chrom(e|ium)\/([0-9]+)\./,2);else{if(!navigator.userAgent.match(/Version\/(\d+).(\d+)/))return e.browser="Unsupported webkit-based browser with GUM support but no WebRTC support.",e;e.browser="safari",e.version=this.extractVersion(navigator.userAgent,/AppleWebKit\/([0-9]+)\./,1)}else{if(!navigator.mediaDevices||!navigator.userAgent.match(/Edge\/(\d+).(\d+)$/))return e.browser="Not a supported browser.",e;e.browser="edge",e.version=this.extractVersion(navigator.userAgent,/Edge\/(\d+).(\d+)$/,2)}return e}};t.exports={log:o.log,disableLog:o.disableLog,browserDetails:o.detectBrowser(),extractVersion:o.extractVersion}},{}]},{},[2])(2)});var WebIM={};WebIM.Emoji={path:"static/img/faces/",map:{"[):]":"ee_1.png","[:D]":"ee_2.png","[;)]":"ee_3.png","[:-o]":"ee_4.png","[:p]":"ee_5.png","[(H)]":"ee_6.png","[:@]":"ee_7.png","[:s]":"ee_8.png","[:$]":"ee_9.png","[:(]":"ee_10.png","[:'(]":"ee_11.png","[:|]":"ee_12.png","[(a)]":"ee_13.png","[8o|]":"ee_14.png","[8-|]":"ee_15.png","[+o(]":"ee_16.png","[<o)]":"ee_17.png","[|-)]":"ee_18.png","[*-)]":"ee_19.png","[:-#]":"ee_20.png","[:-*]":"ee_21.png","[^o)]":"ee_22.png","[8-)]":"ee_23.png","[(|)]":"ee_24.png","[(u)]":"ee_25.png","[(S)]":"ee_26.png","[(*)]":"ee_27.png","[(#)]":"ee_28.png","[(R)]":"ee_29.png","[({)]":"ee_30.png","[(})]":"ee_31.png","[(k)]":"ee_32.png","[(F)]":"ee_33.png","[(W)]":"ee_34.png","[(D)]":"ee_35.png"}},WebIM.config={isAutoLogin:!0,isWindowSDK:!1,isSandBox:!1,isDebug:!1,autoReconnectNumMax:2,autoReconnectInterval:2,isWebRTC:/WebKit/.test(navigator.userAgent)&&/^https\:$/.test(window.location.protocol),isHttpDNS:!1},function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="./",t(0)}({0:function(e,t,n){e.exports=n(230)},223:function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e=function(){},o=n(224).code,r=10485760,a=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},s=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}},c=function(t){t=t||!0;var n=a()||s();if("withCredentials"in n)return n;if(!t)return n;if("undefined"==typeof window.XDomainRequest)return n;var i=new XDomainRequest;return i.readyState=0,i.status=100,i.onreadystatechange=e,i.onload=function(){i.readyState=4,i.status=200;var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(i.responseText),i.responseXML=e,i.response=i.responseText,i.onreadystatechange()},i.ontimeout=i.onerror=function(){i.readyState=4,i.status=500,i.onreadystatechange()},i},u=function(){if("ActiveXObject"in window)try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){return 0}else if(navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"];return 0}(),d=c(),l="undefined"!=typeof FormData,p="undefined"!=typeof Blob,f=d.setRequestHeader||!1,m=d.overrideMimeType||!1,g=f&&l,h=g||u,v=f&&(p||m);Object.keys||(Object.keys=function(){var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],o=n.length;return function(r){if("object"!==("undefined"==typeof r?"undefined":i(r))&&("function"!=typeof r||null===r))throw new TypeError("Object.keys called on non-object");var a,s,c=[];for(a in r)e.call(r,a)&&c.push(a);if(t)for(s=0;o>s;s++)e.call(r,n[s])&&c.push(n[s]);return c}}());var _={hasFormData:l,hasBlob:p,emptyfn:e,isCanSetRequestHeader:f,hasOverrideMimeType:m,isCanUploadFileAsync:g,isCanUploadFile:h,isCanDownLoadFile:v,isSupportWss:function(){var e=[/MQQBrowser[\/]5([.]\d+)?\sTBS/];if(!window.WebSocket)return!1;for(var t=window.navigator.userAgent,n=0,i=e.length;i>n;n++)if(e[n].test(t))return!1;return!0}(),getIEVersion:function(){var e,t=navigator.userAgent,n={4:8,5:9,6:10,7:11};return e=t.match(/MSIE (\d+)/i),e&&e[1]?+e[1]:(e=t.match(/Trident\/(\d+)/i),e&&e[1]?n[e[1]]||null:null)}(),stringify:function(e){if("undefined"!=typeof JSON&&JSON.stringify)return JSON.stringify(e);var t="",n=[],o=function r(e){var o=!1;"[object Array]"===Object.prototype.toString.call(e)?(n.push("]","["),o=!0):"[object Object]"===Object.prototype.toString.call(e)&&n.push("}","{");for(var a in e)"[object Null]"===Object.prototype.toString.call(e[a])?e[a]="null":"[object Undefined]"===Object.prototype.toString.call(e[a])&&(e[a]="undefined"),t+=e[a]&&"object"===i(e[a])?","+(o?"":'"'+a+'":'+(o?'"':""))+r(e[a]):',"'+(o?"":a+'":"')+e[a]+'"';return""!=t&&(t=t.slice(1)),n.pop()+t+n.pop()};return o(e)},login:function(t){var t=t||{},n=t.success||e,i=t.error||e,r=t.appKey||"",a=r.split("#");if(2!==a.length)return i({type:o.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var s=a[0],c=a[1],u=u||t.https,d=t.user||"",l=t.pwd||"",p=t.apiUrl,f={grant_type:"password",username:d,password:l,timestamp:+new Date},m=_.stringify(f),t={url:p+"/"+s+"/"+c+"/token",dataType:"json",data:m,success:n,error:i};return _.ajax(t)},getFileUrl:function(e){var t={url:"",filename:"",filetype:"",data:""},n="string"==typeof e?document.getElementById(e):e;if(!_.isCanUploadFileAsync||!n)return t;try{if(window.URL.createObjectURL){var i=n.files;if(i.length>0){var o=i.item(0);t.data=o,t.url=window.URL.createObjectURL(o),t.filename=o.name||""}}else{var o=document.getElementById(e).value;t.url=o;var r=o.lastIndexOf("/"),a=o.lastIndexOf("\\"),s=Math.max(r,a);0>s?t.filename=o:t.filename=o.substring(s+1)}var c=t.filename.lastIndexOf(".");return-1!=c&&(t.filetype=t.filename.substring(c+1).toLowerCase()),t}catch(u){throw u}},getFileSize:function(e){var t=0;if(e)if(e.files)e.files.length>0&&(t=e.files[0].size);else if(e.select&&"ActiveXObject"in window){e.select();var n=new ActiveXObject("Scripting.FileSystemObject"),e=n.GetFile(e.value);t=e.Size}if(console.log("fileSize: ",t),t>1e7)return!1;var i=Math.round(t/1e3);if(1e3>i)t=i+" KB";else if(i>=1e3){var o=i/1e3;if(1e3>o)t=o.toFixed(1)+" MB";else{var r=o/1e3;t=r.toFixed(1)+" GB"}}return t},hasFlash:u,trim:function(e){return e="string"==typeof e?e:"",e.trim?e.trim():e.replace(/^\s|\s$/g,"")},parseEmoji:function(e){if("undefined"==typeof WebIM.Emoji||"undefined"==typeof WebIM.Emoji.map)return e;var t=WebIM.Emoji;for(var n in t.map)if(t.map.hasOwnProperty(n))for(;e.indexOf(n)>-1;)e=e.replace(n,'<img class="emoji" src="'+t.path+t.map[n]+'" />');return e},parseLink:function(e){var t=/(https?\:\/\/|www\.)([a-zA-Z0-9-]+(\.[a-zA-Z0-9]+)+)(\:[0-9]{2,4})?\/?((\.[:_0-9a-zA-Z-]+)|[:_0-9a-zA-Z-]*\/?)*\??[:_#@*&%0-9a-zA-Z-\/=]*/gm;return e=e.replace(t,function(e){var t=/^https?/gm.test(e);return"<a href='"+(t?e:"//"+e)+"' target='_blank'>"+e+"</a>"})},parseJSON:function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e+"");var t,n=null,i=_.trim(e+"");return i&&!_.trim(i.replace(/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g,function(e,i,o,r){return t&&i&&(n=0),0===n?e:(t=o||i,n+=!r-!o,"")}))?Function("return "+i)():Function("Invalid JSON: "+e)()},parseUploadResponse:function(e){return e.indexOf("callback")>-1?e.slice(9,-1):e},parseDownloadResponse:function(e){return e&&e.type&&"application/json"===e.type||0>Object.prototype.toString.call(e).indexOf("Blob")?this.url+"?token=":window.URL.createObjectURL(e)},uploadFile:function(t){var t=t||{};t.onFileUploadProgress=t.onFileUploadProgress||e,t.onFileUploadComplete=t.onFileUploadComplete||e,t.onFileUploadError=t.onFileUploadError||e,t.onFileUploadCanceled=t.onFileUploadCanceled||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_NO_LOGIN,id:t.id});var i,a,s,c=t.appKey||this.context.appKey||"";if(c&&(s=c.split("#"),i=s[0],a=s[1]),!i&&!a)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});var u=t.apiUrl,d=u+"/"+i+"/"+a+"/chatfiles";if(!_.isCanUploadFileAsync)return void(_.hasFlash&&"function"==typeof t.flashUpload?t.flashUpload&&t.flashUpload(d,t):t.onFileUploadError({type:o.WEBIM_UPLOADFILE_BROWSER_ERROR,id:t.id}));var l=t.file.data?t.file.data.size:void 0;if(l>r)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});if(0>=l)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});var p=_.xmlrequest(),f=function(e){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id,xhr:p})};p.upload&&p.upload.addEventListener("progress",t.onFileUploadProgress,!1),p.addEventListener?(p.addEventListener("abort",t.onFileUploadCanceled,!1),p.addEventListener("load",function(e){try{var n=_.parseJSON(p.responseText);try{t.onFileUploadComplete(n)}catch(e){t.onFileUploadError({type:o.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}}catch(e){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p})}},!1),p.addEventListener("error",f,!1)):p.onreadystatechange&&(p.onreadystatechange=function(){if(4===p.readyState)if(200===ajax.status)try{var e=_.parseJSON(p.responseText);t.onFileUploadComplete(e)}catch(n){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p})}else t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p});else p.abort(),t.onFileUploadCanceled()}),p.open("POST",d),p.setRequestHeader("restrict-access","true"),p.setRequestHeader("Accept","*/*"),p.setRequestHeader("Authorization","Bearer "+n);var m=new FormData;m.append("file",t.file.data),p.send(m)},download:function(t){t.onFileDownloadComplete=t.onFileDownloadComplete||e,t.onFileDownloadError=t.onFileDownloadError||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_NO_LOGIN,id:t.id});var i=function(e){t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r})};if(!_.isCanDownLoadFile)return void t.onFileDownloadComplete();var r=_.xmlrequest();"addEventListener"in r?(r.addEventListener("load",function(e){t.onFileDownloadComplete(r.response,r)},!1),r.addEventListener("error",i,!1)):"onreadystatechange"in r&&(r.onreadystatechange=function(){4===r.readyState?200===ajax.status?t.onFileDownloadComplete(r.response,r):t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r}):(r.abort(),t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r}))});var a=t.method||"GET",s=t.responseType||"blob",c=t.mimeType||"text/plain; charset=x-user-defined";r.open(a,t.url),"undefined"!=typeof Blob?r.responseType=s:r.overrideMimeType(c);var u={"X-Requested-With":"XMLHttpRequest",Accept:"application/octet-stream","share-secret":t.secret,Authorization:"Bearer "+n},d=t.headers||{};for(var l in d)u[l]=d[l];for(var l in u)u[l]&&r.setRequestHeader(l,u[l]);r.send(null)},parseTextMessage:function(e,t){if("string"==typeof e){if("[object Object]"!==Object.prototype.toString.call(t))return{isemoji:!1,body:[{type:"txt",data:e}]};var n=e,i=[],o=/\[[^[\]]{2,3}\]/gm,r=n.match(o);if(!r||r.length<1)return{isemoji:!1,body:[{type:"txt",data:e}]};for(var a=!1,s=0;s<r.length;s++){var c=n.substring(0,n.indexOf(r[s])),u=WebIM.Emoji.map[r[s]];if(c&&i.push({type:"txt",data:c}),u){var d=WebIM.Emoji.map?WebIM.Emoji.path+u:null;d?(a=!0,i.push({type:"emoji",data:d})):i.push({type:"txt",data:r[s]});var l=n.indexOf(r[s])+r[s].length;n=n.substring(l)}else i.push({type:"txt",data:r[s]})}return n&&i.push({type:"txt",data:n}),a?{isemoji:a,body:i}:{isemoji:!1,body:[{type:"txt",data:e}]}}},xmlrequest:c,getXmlFirstChild:function(e,t){var n=e.getElementsByTagName(t);return 0==n.length?null:n[0]},ajax:function(t){var n=t.dataType||"text",i=t.success||e,r=t.error||e,a=_.xmlrequest();a.onreadystatechange=function(){if(4===a.readyState){var e=a.status||0;if(200===e){try{switch(n){case"text":return void i(a.responseText);case"json":var t=_.parseJSON(a.responseText);return void i(t,a);case"xml":return void(a.responseXML&&a.responseXML.documentElement?i(a.responseXML.documentElement,a):r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:a.responseText}))}i(a.response||a.responseText,a)}catch(s){r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:s})}return}return void r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:a.responseText})}0===a.readyState&&r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:a.responseText})},t.responseType&&a.responseType&&(a.responseType=t.responseType),t.mimeType&&_.hasOverrideMimeType&&a.overrideMimeType(t.mimeType);var s=t.type||"POST",c=t.data||null,u="";if("get"===s.toLowerCase()&&c){for(var d in c)c.hasOwnProperty(d)&&(u+=d+"="+c[d]+"&");u=u?u.slice(0,-1):u,t.url+=(t.url.indexOf("?")>0?"&":"?")+(u?u+"&":u)+"_v="+(new Date).getTime(),c=null,u=null}if(a.open(s,t.url),_.isCanSetRequestHeader){var l=t.headers||{};for(var p in l)l.hasOwnProperty(p)&&a.setRequestHeader(p,l[p])}return a.send(c),a},ts:function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),i=e.getSeconds(),o=e.getMilliseconds();return(10>t?"0"+t:t)+":"+(10>n?"0"+n:n)+":"+(10>i?"0"+i:i)+":"+o+" "},getObjectKey:function(e,t){for(var n in e)if(e[n]==t)return n;return""}};t.utils=_}()},224:function(e,t){"use strict";!function(){t.code={WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR:0,WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_OPEN_USERGRID_ERROR:3,WEBIM_CONNCTION_ATTACH_ERROR:4,WEBIM_CONNCTION_ATTACH_USERGRID_ERROR:5,WEBIM_CONNCTION_REOPEN_ERROR:6,WEBIM_CONNCTION_SERVER_CLOSE_ERROR:7,WEBIM_CONNCTION_SERVER_ERROR:8,WEBIM_CONNCTION_IQ_ERROR:9,WEBIM_CONNCTION_PING_ERROR:10,WEBIM_CONNCTION_NOTIFYVERSION_ERROR:11,WEBIM_CONNCTION_GETROSTER_ERROR:12,WEBIM_CONNCTION_CROSSDOMAIN_ERROR:13,WEBIM_CONNCTION_LISTENING_OUTOF_MAXRETRIES:14,WEBIM_CONNCTION_RECEIVEMSG_CONTENTERROR:15,WEBIM_CONNCTION_DISCONNECTED:16,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_JOINROOM_ERROR:18,WEBIM_CONNCTION_GETROOM_ERROR:19,WEBIM_CONNCTION_GETROOMINFO_ERROR:20,WEBIM_CONNCTION_GETROOMMEMBER_ERROR:21,WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR:22,WEBIM_CONNCTION_LOAD_CHATROOM_ERROR:23,WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR:24,WEBIM_CONNCTION_JOINCHATROOM_ERROR:25,WEBIM_CONNCTION_QUITCHATROOM_ERROR:26,WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR:27,WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR:28,WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR:29,WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR:30,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31,WEBIM_CONNCTION_CLIENT_OFFLINE:32,WEBIM_CONNCTION_CLIENT_LOGOUT:33,WEBIM_CONNCTION_CLIENT_TOO_MUCH_ERROR:34,WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP:35,WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP:36,WEBIM_CONNECTION_ACCEPT_JOIN_GROUP:37,WEBIM_CONNECTION_DECLINE_JOIN_GROUP:38,WEBIM_CONNECTION_CLOSED:39,WEBIM_UPLOADFILE_BROWSER_ERROR:100,WEBIM_UPLOADFILE_ERROR:101,WEBIM_UPLOADFILE_NO_LOGIN:102,WEBIM_UPLOADFILE_NO_FILE:103,WEBIM_DOWNLOADFILE_ERROR:200,WEBIM_DOWNLOADFILE_NO_LOGIN:201,WEBIM_DOWNLOADFILE_BROWSER_ERROR:202,WEBIM_MESSAGE_REC_TEXT:300,WEBIM_MESSAGE_REC_TEXT_ERROR:301,WEBIM_MESSAGE_REC_EMOTION:302,WEBIM_MESSAGE_REC_PHOTO:303,WEBIM_MESSAGE_REC_AUDIO:304,WEBIM_MESSAGE_REC_AUDIO_FILE:305,WEBIM_MESSAGE_REC_VEDIO:306,WEBIM_MESSAGE_REC_VEDIO_FILE:307,WEBIM_MESSAGE_REC_FILE:308,WEBIM_MESSAGE_SED_TEXT:309,WEBIM_MESSAGE_SED_EMOTION:310,WEBIM_MESSAGE_SED_PHOTO:311,WEBIM_MESSAGE_SED_AUDIO:312,WEBIM_MESSAGE_SED_AUDIO_FILE:313,WEBIM_MESSAGE_SED_VEDIO:314,WEBIM_MESSAGE_SED_VEDIO_FILE:315,WEBIM_MESSAGE_SED_FILE:316,WEBIM_MESSAGE_SED_ERROR:317,STATUS_INIT:400,STATUS_DOLOGIN_USERGRID:401,STATUS_DOLOGIN_IM:402,STATUS_OPENED:403,STATUS_CLOSING:404,STATUS_CLOSED:405,STATUS_ERROR:406}}()},230:function(e,t,n){"use strict";e.exports=n(231)},231:function(module,exports,__webpack_require__){"use strict";function _parsePrivacy(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("value"),a=o.getAttribute("order"),s=o.getAttribute("type");if(r){var c=_parseNameFromJidFn(r);t[c]={type:s,order:a,jid:r,name:c}}}return t}function _parseGroupBlacklist(e){var t={},n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("jid"),a=o.getAttribute("affiliation"),s=o.getAttribute("nick");if(r){var c=_parseNameFromJidFn(r);t[c]={jid:r,affiliation:a,nick:s,name:c}}}return t}function _setText(e,t){"textContent"in e?e.textContent=t:"text"in e&&(e.text=t)}var _version="1.4.2",_code=__webpack_require__(224).code,_utils=__webpack_require__(223).utils,_msg=__webpack_require__(232),_message=_msg._msg,_msgHash={},Queue=__webpack_require__(233).Queue;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.XDomainRequest&&(XDomainRequest.prototype.oldsend=XDomainRequest.prototype.send,XDomainRequest.prototype.send=function(){XDomainRequest.prototype.oldsend.apply(this,arguments),this.readyState=2}),Strophe.Request.prototype._newXHR=function(){var e=_utils.xmlrequest(!0);return e.overrideMimeType&&e.overrideMimeType("text/xml"),e.onreadystatechange=this.func.bind(null,this),e},Strophe.Websocket.prototype._closeSocket=function(){if(this.socket){var e=this;setTimeout(function(){try{e.socket.close()}catch(t){}},0)}else this.socket=null},Strophe.Websocket.prototype._onMessage=function(e){WebIM&&WebIM.config.isDebug&&console.log(WebIM.utils.ts()+"recv:",e.data);var t,n;if(0===e.data.indexOf("<close ")){t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement;var i=t.getAttribute("see-other-uri");return void(i?(this._conn._changeConnectStatus(Strophe.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=i,this._connect()):this._conn._doDisconnect("receive <close> from server"))}if(0===e.data.search("<open ")){if(t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement,!this._handleStreamStart(t))return}else n=this._streamWrap(e.data),t=(new DOMParser).parseFromString(n,"text/xml").documentElement;if(!this._check_streamerror(t,Strophe.Status.ERROR))return this._conn.disconnecting&&"presence"===t.firstChild.nodeName&&"unavailable"===t.firstChild.getAttribute("type")?(this._conn.xmlInput(t),void this._conn.rawInput(Strophe.serialize(t))):void this._conn._dataRecv(t,e.data)};var _listenNetwork=function(e,t){window.addEventListener?(window.addEventListener("online",e),window.addEventListener("offline",t)):window.attachEvent&&(document.body?(document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)):window.attachEvent("load",function(){
document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)}))},_parseRoom=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r=o.getAttribute("jid"),a=r.split("@")[0],s={jid:r,name:o.getAttribute("name"),roomId:a.split("_")[1]};t.push(s)}return t},_parseRoomOccupants=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var o=n[i],r={jid:o.getAttribute("jid"),name:o.getAttribute("name")};t.push(r)}return t},_parseResponseMessage=function _parseResponseMessage(msginfo){var parseMsgData={errorMsg:!0,data:[]},msgBodies=msginfo.getElementsByTagName("body");if(msgBodies){for(var i=0;i<msgBodies.length;i++){var msgBody=msgBodies[i],childNodes=msgBody.childNodes;if(childNodes&&childNodes.length>0){var childNode=msgBody.childNodes[0];if(childNode.nodeType==Strophe.ElementType.TEXT){var jsondata=childNode.wholeText||childNode.nodeValue;jsondata=jsondata.replace("\n","<br>");try{var data=eval("("+jsondata+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}}var delayTags=msginfo.getElementsByTagName("delay");if(delayTags&&delayTags.length>0){var delayTag=delayTags[0],delayMsgTime=delayTag.getAttribute("stamp");delayMsgTime&&(parseMsgData.delayTimeStamp=delayMsgTime)}}else{var childrens=msginfo.childNodes;if(childrens&&childrens.length>0){var child=msginfo.childNodes[0];if(child.nodeType==Strophe.ElementType.TEXT)try{var data=eval("("+child.nodeValue+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}return parseMsgData},_parseNameFromJidFn=function(e,t){t=t||"";var n=e,i=n.indexOf("_");-1!==i&&(n=n.substring(i+1));var o=n.indexOf("@"+t);return-1!==o&&(n=n.substring(0,o)),n},_parseFriend=function(e,t,n){var i=[],o=e.getElementsByTagName("item");if(o)for(var r=0;r<o.length;r++){var a=o[r],s=a.getAttribute("jid");if(s){var c=a.getAttribute("subscription"),u={subscription:c,jid:s},d=a.getAttribute("ask");d&&(u.ask=d);var l=a.getAttribute("name");if(l)u.name=l;else{var p=_parseNameFromJidFn(s);u.name=p}var f=[];Strophe.forEachChild(a,"group",function(e){f.push(Strophe.getText(e))}),u.groups=f,i.push(u),t&&"from"==c&&t.subscribe({toJid:s}),t&&"to"==c&&t.subscribed({toJid:s})}}return i},_login=function(e,t){var n=e.access_token||"";if(""==n){_utils.stringify(e);return void t.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:e})}t.context.accessToken=e.access_token,t.context.accessTokenExpires=e.expires_in;var i=null;i=t.isOpening()&&t.context.stropheConn?t.context.stropheConn:t.isOpened()&&t.context.stropheConn?t.getStrophe():t.getStrophe();var o=function(e,n){_loginCallback(e,n,t)};t.context.stropheConn=i,t.route?i.connect(t.context.jid,"$t$"+n,o,t.wait,t.hold,t.route):i.connect(t.context.jid,"$t$"+n,o,t.wait,t.hold)},_parseMessageType=function(e){var t="normal",n=e.getElementsByTagName("received");if(n&&n.length>0&&"urn:xmpp:receipts"===n[0].namespaceURI)t="received";else{var i=e.getElementsByTagName("invite");i&&i.length>0&&(t="invite")}return t},_handleMessageQueue=function(e){for(var t in _msgHash)_msgHash.hasOwnProperty(t)&&_msgHash[t].send(e)},_loginCallback=function(e,t,n){var i,o;if("conflict"===t&&(i=!0),e==Strophe.Status.CONNFAIL)o={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},i&&(o.conflict=!0),n.onError(o);else if(e==Strophe.Status.ATTACHED||e==Strophe.Status.CONNECTED){n.autoReconnectNumTotal=0,n.intervalId=setInterval(function(){n.handelSendQueue()},200);var r=function(e){var t=_parseMessageType(e);return"received"===t?(n.handleReceivedMessage(e),!0):"invite"===t?(n.handleInviteMessage(e),!0):(n.handleMessage(e),!0)},a=function(e){return n.handlePresence(e),!0},s=function(e){return n.handlePing(e),!0},c=function(e){return n.handleIqRoster(e),!0},u=function(e){return n.handleIqPrivacy(e),!0},d=function(e){return n.handleIq(e),!0};n.addHandler(r,null,"message",null,null,null),n.addHandler(a,null,"presence",null,null,null),n.addHandler(s,"urn:xmpp:ping","iq","get",null,null),n.addHandler(c,"jabber:iq:roster","iq","set",null,null),n.addHandler(u,"jabber:iq:privacy","iq","set",null,null),n.addHandler(d,null,"iq",null,null,null),n.context.status=_code.STATUS_OPENED;var l=[_code.WEBIM_MESSAGE_REC_TEXT,_code.WEBIM_MESSAGE_REC_EMOJI];_utils.isCanDownLoadFile&&(l.push(_code.WEBIM_MESSAGE_REC_PHOTO),l.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE));var p=[_code.WEBIM_MESSAGE_SED_TEXT];_utils.isCanUploadFile&&(p.push(_code.WEBIM_MESSAGE_REC_PHOTO),p.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE)),n.notifyVersion(),n.retry&&_handleMessageQueue(n),n.heartBeat(),n.isAutoLogin&&n.setPresence(),n.onOpened({canReceive:l,canSend:p,accessToken:n.context.accessToken})}else if(e==Strophe.Status.DISCONNECTING)n.isOpened()&&(n.stopHeartBeat(),n.context.status=_code.STATUS_CLOSING,o={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},i&&(o.conflict=!0),n.onError(o));else if(e==Strophe.Status.DISCONNECTED){if(n.isOpened()){if(n.autoReconnectNumTotal<n.autoReconnectNumMax)return void n.reconnect();o={type:_code.WEBIM_CONNCTION_DISCONNECTED},n.onError(o)}n.context.status=_code.STATUS_CLOSED,n.clear(),n.onClosed()}else e==Strophe.Status.AUTHFAIL?(o={type:_code.WEBIM_CONNCTION_AUTH_ERROR},i&&(o.conflict=!0),n.onError(o),n.clear()):e==Strophe.Status.ERROR&&(n.context.status=_code.STATUS_ERROR,o={type:_code.WEBIM_CONNCTION_SERVER_ERROR},i&&(o.conflict=!0),n.onError(o));n.context.status_now=e},_getJid=function(e,t){var n=e.toJid||"";if(""===n){var i=t.context.appKey||"",o=i+"_"+e.to+"@"+t.domain;e.resource&&(o=o+"/"+e.resource),n=o}return n},_getJidByName=function(e,t){var n={to:e};return _getJid(n,t)},_validCheck=function(e,t){if(e=e||{},""==e.user)return t.onError({type:_code.WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR}),!1;var n=e.user+""||"",i=e.appKey||"",o=i.split("#");if(2!==o.length)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var r=o[0],a=o[1];if(!r)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;if(!a)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var s=i+"_"+n.toLowerCase()+"@"+t.domain,c=e.resource||"webim";return t.isMultiLoginSessions&&(c+=n+(new Date).getTime()+Math.floor(1e6*Math.random().toFixed(6))),t.context.jid=s+"/"+c,t.context.userId=n,t.context.appKey=i,t.context.appName=a,t.context.orgName=r,!0},_getXmppUrl=function(e,t){if(/^(ws|http)s?:\/\/?/.test(e))return e;var n={prefix:"http",base:"://"+e,suffix:"/http-bind/"};return t&&_utils.isSupportWss?(n.prefix="wss",n.suffix="/ws/"):t?n.prefix="https":window.WebSocket&&(n.prefix="ws",n.suffix="/ws/"),n.prefix+n.base+n.suffix},connection=function e(t){if(!this instanceof e)return new e(t);var t=t||{};this.isHttpDNS=t.isHttpDNS||!1,this.isMultiLoginSessions=t.isMultiLoginSessions||!1,this.wait=t.wait||30,this.retry=t.retry||!1,this.https=t.https||"https:"===location.protocol,this.url=_getXmppUrl(t.url,this.https),this.hold=t.hold||1,this.route=t.route||null,this.domain=t.domain||"easemob.com",this.inactivity=t.inactivity||30,this.heartBeatWait=t.heartBeatWait||4500,this.maxRetries=t.maxRetries||5,this.isAutoLogin=t.isAutoLogin===!1?!1:!0,this.pollingTime=t.pollingTime||800,this.stropheConn=!1,this.autoReconnectNumMax=t.autoReconnectNumMax||0,this.autoReconnectNumTotal=0,this.autoReconnectInterval=t.autoReconnectInterval||0,this.context={status:_code.STATUS_INIT},this.sendQueue=new Queue,this.intervalId=null,this.apiUrl=t.apiUrl||"",this.isWindowSDK=t.isWindowSDK||!1,this.dnsArr=["https://rs.easemob.com","https://rsbak.easemob.com","http://182.92.174.78","http://112.126.66.111"],this.dnsIndex=0,this.dnsTotal=this.dnsArr.length,this.restHosts=null,this.restIndex=0,this.restTotal=0,this.xmppHosts=null,this.xmppIndex=0,this.xmppTotal=0};connection.prototype.registerUser=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"signup")):this.signup(e)},connection.prototype.handelSendQueue=function(){var e=this.sendQueue.pop();null!==e&&this.sendReceiptsMessage(e)},connection.prototype.listen=function(e){this.onOpened=e.onOpened||_utils.emptyfn,this.onClosed=e.onClosed||_utils.emptyfn,this.onTextMessage=e.onTextMessage||_utils.emptyfn,this.onEmojiMessage=e.onEmojiMessage||_utils.emptyfn,this.onPictureMessage=e.onPictureMessage||_utils.emptyfn,this.onAudioMessage=e.onAudioMessage||_utils.emptyfn,this.onVideoMessage=e.onVideoMessage||_utils.emptyfn,this.onFileMessage=e.onFileMessage||_utils.emptyfn,this.onLocationMessage=e.onLocationMessage||_utils.emptyfn,this.onCmdMessage=e.onCmdMessage||_utils.emptyfn,this.onPresence=e.onPresence||_utils.emptyfn,this.onRoster=e.onRoster||_utils.emptyfn,this.onError=e.onError||_utils.emptyfn,this.onReceivedMessage=e.onReceivedMessage||_utils.emptyfn,this.onInviteMessage=e.onInviteMessage||_utils.emptyfn,this.onOffline=e.onOffline||_utils.emptyfn,this.onOnline=e.onOnline||_utils.emptyfn,this.onConfirmPop=e.onConfirmPop||_utils.emptyfn,this.onUpdateMyGroupList=e.onUpdateMyGroupList||_utils.emptyfn,this.onUpdateMyRoster=e.onUpdateMyRoster||_utils.emptyfn,this.onBlacklistUpdate=e.onBlacklistUpdate||_utils.emptyfn,_listenNetwork(this.onOnline,this.onOffline)},connection.prototype.heartBeat=function(){var e=this,t=!/^ws|wss/.test(e.url)||/mobile/.test(navigator.userAgent);if(!this.heartBeatID&&t){var n={toJid:this.domain,type:"normal"};this.heartBeatID=setInterval(function(){e.ping(n)},this.heartBeatWait)}},connection.prototype.stopHeartBeat=function(){"number"==typeof this.heartBeatID&&(this.heartBeatID=clearInterval(this.heartBeatID))},connection.prototype.sendReceiptsMessage=function(e){var t=$msg({from:this.context.jid||"",to:this.domain,id:e.id||""}).c("received",{xmlns:"urn:xmpp:receipts",id:e.id||""});this.sendCommand(t.tree())},connection.prototype.cacheReceiptsMessage=function(e){this.sendQueue.push(e)},connection.prototype.getStrophe=function(){if("https:"!=location.protocol&&this.isHttpDNS){var e="",t=this.xmppHosts[this.xmppIndex],n=_utils.getXmlFirstChild(t,"domain"),i=_utils.getXmlFirstChild(t,"ip");if(i){e=i.textContent;var o=_utils.getXmlFirstChild(t,"port");"80"!=o.textContent&&(e+=":"+o.textContent)}else e=n.textContent;if(""!=e){var r=/(.+\/\/).+(\/.+)/;this.url=this.url.replace(r,"$1"+e+"$2")}}var a=new Strophe.Connection(this.url,{inactivity:this.inactivity,maxRetries:this.maxRetries,pollingTime:this.pollingTime});return a},connection.prototype.getHostsByTag=function(e,t){var n=_utils.getXmlFirstChild(e,t);if(!n)return console.log(t+" hosts error"),null;var i=n.getElementsByTagName("hosts");return 0==i.length?(console.log(t+" hosts error2"),null):i[0].getElementsByTagName("host")},connection.prototype.getRestFromHttpDNS=function(e,t){if(this.restIndex>this.restTotal)return void console.log("rest hosts all tried,quit");var n="",i=this.restHosts[this.restIndex],o=_utils.getXmlFirstChild(i,"domain"),r=_utils.getXmlFirstChild(i,"ip");if(r){var a=_utils.getXmlFirstChild(i,"port");n=("https:"===location.protocol?"https:":"http:")+"//"+r.textContent+":"+a.textContent}else n=("https:"===location.protocol?"https:":"http:")+"//"+o.textContent;""!=n&&(this.apiUrl=n,e.apiUrl=n),"login"==t?this.login(e):this.signup(e)},connection.prototype.getHttpDNS=function(e,t){if(this.restHosts)return void this.getRestFromHttpDNS(e,t);var n=this,i=function(i,o){i=(new DOMParser).parseFromString(i,"text/xml").documentElement;var r=n.getHostsByTag(i,"rest");if(!r)return void console.log("rest hosts error3");n.restHosts=r,n.restTotal=r.length;var a=n.getHostsByTag(i,"xmpp");return a?(n.xmppHosts=a,n.xmppTotal=a.length,void n.getRestFromHttpDNS(e,t)):void console.log("xmpp hosts error3")},o=function(i,o,r){console.log("getHttpDNS error",i,r),n.dnsIndex++,n.dnsIndex<n.dnsTotal&&n.getHttpDNS(e,t)},r={url:this.dnsArr[this.dnsIndex]+"/easemob/server.xml",dataType:"text",type:"GET",data:{app_key:encodeURIComponent(e.appKey)},success:i||_utils.emptyfn,error:o||_utils.emptyfn};_utils.ajax(r)},connection.prototype.signup=function(e){var t=this,n=e.orgName||"",i=e.appName||"",o=e.appKey||"",r=e.success||EMPTYFN,a=e.error||EMPTYFN;if(!n&&!i&&o){var s=o.split("#");2===s.length&&(n=s[0],i=s[1])}if(!n&&!i)return void a({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR});var c=function(n,i,o){return"https:"!=location.protocol&&t.isHttpDNS&&t.restIndex+1<t.restTotal?(t.restIndex++,void t.getRestFromHttpDNS(e,"signup")):(t.clear(),void a(n))},u=e.https||u,d=e.apiUrl,l=d+"/"+n+"/"+i+"/users",p={username:e.username,password:e.password,nickname:e.nickname||""},f=_utils.stringify(p),m={url:l,dataType:"json",data:f,success:r,error:c};_utils.ajax(m)},connection.prototype.open=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"login")):this.login(e)},connection.prototype.login=function(e){var t=_validCheck(e,this);if(t){var n=this;if(!n.isOpened())if(e.accessToken)e.access_token=e.accessToken,_login(e,n);else{var i=e.apiUrl,o=this.context.userId,r=e.pwd||"",a=this.context.appName,s=this.context.orgName,c=function(e,t){n.context.status=_code.STATUS_DOLOGIN_IM,n.context.restTokenData=e,_login(e,n)},u=function(t,i,o){return"https:"!=location.protocol&&n.isHttpDNS&&n.restIndex+1<n.restTotal?(n.restIndex++,void n.getRestFromHttpDNS(e,"login")):(n.clear(),void(t.error&&t.error_description?n.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:t,xhr:i}):n.onError({type:_code.WEBIM_CONNCTION_OPEN_ERROR,data:t,xhr:i})))};this.context.status=_code.STATUS_DOLOGIN_USERGRID;var d={grant_type:"password",username:o,password:r,timestamp:+new Date},l=_utils.stringify(d),p={url:i+"/"+s+"/"+a+"/token",dataType:"json",data:l,success:c||_utils.emptyfn,error:u||_utils.emptyfn};_utils.ajax(p)}}},connection.prototype.attach=function(e){var t=_validCheck(e,this);if(t){e=e||{};var n=e.accessToken||"";if(""==n)return void this.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR});var i=e.sid||"";if(""===i)return void this.onError({type:_code.WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR});var o=e.rid||"";if(""===o)return void this.onError({type:_code.WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR});var r=this.getStrophe();this.context.accessToken=n,this.context.stropheConn=r,this.context.status=_code.STATUS_DOLOGIN_IM;var a=this,s=function(e,t){_loginCallback(e,t,a)},c=this.context.jid,u=this.wait,d=this.hold,l=this.wind||5;r.attach(c,i,o,s,u,d,l)}},connection.prototype.close=function(e){this.stopHeartBeat();var t=this.context.status;t!=_code.STATUS_INIT&&(this.isClosed()||this.isClosing()||(this.context.status=_code.STATUS_CLOSING,this.context.stropheConn.disconnect(e)))},connection.prototype.addHandler=function(e,t,n,i,o,r,a){this.context.stropheConn.addHandler(e,t,n,i,o,r,a)},connection.prototype.notifyVersion=function(e,t){var n=(_getJid({},this),$iq({from:this.context.jid||"",to:this.domain,type:"result"}).c("query",{xmlns:"jabber:iq:version"}).c("name").t("easemob").up().c("version").t(_version).up().c("os").t("webim")),e=e||_utils.emptyfn,i=t||this.onError,o=function(e){i({type:_code.WEBIM_CONNCTION_NOTIFYVERSION_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),e,o)},connection.prototype.handlePresence=function(e){if(!this.isClosed()){var t=e.getAttribute("from")||"",n=e.getAttribute("to")||"",i=e.getAttribute("type")||"",o=e.getAttribute("presence_type")||"",r=_parseNameFromJidFn(t),a=_parseNameFromJidFn(n),s={from:r,to:a,fromJid:t,toJid:n,type:i,chatroom:e.getElementsByTagName("roomtype").length?!0:!1},c=e.getElementsByTagName("show");if(c&&c.length>0){var u=c[0];s.show=Strophe.getText(u)}var d=e.getElementsByTagName("status");if(d&&d.length>0){var l=d[0];s.status=Strophe.getText(l),s.code=l.getAttribute("code")}var p=e.getElementsByTagName("priority");if(p&&p.length>0){var f=p[0];s.priority=Strophe.getText(f)}var m=e.getElementsByTagName("error");if(m&&m.length>0){var m=m[0];s.error={code:m.getAttribute("code")}}var g=e.getElementsByTagName("destroy");if(g&&g.length>0){var g=g[0];s.destroy=!0;var h=g.getElementsByTagName("reason");h&&h.length>0&&(s.reason=Strophe.getText(h[0]))}var v=e.getElementsByTagName("item");if(v&&v.length>0){var _=v[0],y=_.getAttribute("role"),E=_.getAttribute("jid");if("none"==y&&E){var S=_parseNameFromJidFn(E),T=_.getElementsByTagName("actor")[0],C=T.getAttribute("nick");s.actor=C,s.kicked=S}"moderator"==y&&"201"==s.code&&(s.type="joinPublicGroupSuccess")}var I=e.getElementsByTagName("apply");if(I&&I.length>0){I=I[0];var b=I.getAttribute("toNick"),N=I.getAttribute("to"),O=I.getAttribute("from"),R=_parseNameFromJidFn(N);_parseNameFromJidFn(O);s.toNick=b,s.groupName=R,s.type="joinGroupNotifications";var h=I.getElementsByTagName("reason");h&&h.length>0&&(s.reason=Strophe.getText(h[0]))}if(s.chatroom){s.presence_type=o,s.original_type=s.type;var w=t.slice(t.lastIndexOf("/")+1);w===this.context.userId&&(""!==s.type||s.code?("unavailable"===o||"unavailable"===s.type)&&(s.status?110==s.code?s.type="leaveChatRoom":s.error&&406==s.error.code&&(s.type="reachChatRoomCapacity"):s.type="leaveChatRoom"):s.type="joinChatRoomSuccess")}else s.presence_type=o,s.original_type=i,/subscribe/.test(s.type)||(""!=i||s.status||s.error?("unavailable"===o||"unavailable"===i)&&(s.destroy?s.type="deleteGroupChat":(307==s.code||321==s.code)&&(s.type="leaveGroup")):s.type="joinPublicGroupSuccess");this.onPresence(s,e)}},connection.prototype.handlePing=function(e){if(!this.isClosed()){var t=e.getAttribute("id"),n=e.getAttribute("from"),i=e.getAttribute("to"),o=$iq({from:i,to:n,id:t,type:"result"});this.sendCommand(o.tree())}},connection.prototype.handleIq=function(e){return!0},connection.prototype.handleIqPrivacy=function(e){var t=e.getElementsByTagName("list");0!=t.length&&this.getBlacklist()},connection.prototype.handleIqRoster=function(e){var t=e.getAttribute("id"),n=e.getAttribute("from")||"",i=(_parseNameFromJidFn(n),this.context.jid),o=(this.context.userId,$iq({type:"result",id:t,from:i}));this.sendCommand(o.tree());var r=e.getElementsByTagName("query");if(r&&r.length>0){var a=r[0],s=_parseFriend(a,this,n);this.onRoster(s)}return!0},connection.prototype.handleMessage=function(e){var t=this;if(!this.isClosed()){var n=e.getAttribute("id")||"";this.cacheReceiptsMessage({id:n});var i=_parseResponseMessage(e);if(i.errorMsg)return void this.handlePresence(e);var o=e.getElementsByTagName("error"),r="",a="",s=!1;if(o.length>0){s=!0,r=o[0].getAttribute("code");var c=o[0].getElementsByTagName("text");a=c[0].textContent||c[0].text,log("handle error",r,a)}var u=i.data;for(var d in u)if(u.hasOwnProperty(d)){var l=u[d];if(l.from&&l.to){var p=(l.from+"").toLowerCase(),f=(l.to+"").toLowerCase(),m=l.ext||{},g="",h=e.getElementsByTagName("roomtype");g=h.length?h[0].getAttribute("type")||"chat":e.getAttribute("type")||"chat";var v=l.bodies;if(v&&0!=v.length){var _=l.bodies[0],y=_.type;try{switch(y){case"txt":var E=_.msg,S=_utils.parseTextMessage(E,WebIM.Emoji);if(S.isemoji){var l={id:n,type:g,from:p,to:f,delay:i.delayTimeStamp,data:S.body,ext:m};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onEmojiMessage(l)}else{var l={id:n,type:g,from:p,to:f,delay:i.delayTimeStamp,data:E,ext:m};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onTextMessage(l)}break;case"img":var T=0,C=0;_.size&&(T=_.size.width,C=_.size.height);var l={id:n,type:g,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+_.url.substr(_.url.indexOf("/",9)):_.url,secret:_.secret,filename:_.filename,thumb:_.thumb,thumb_secret:_.thumb_secret,file_length:_.file_length||"",width:T,height:C,filetype:_.filetype||"",accessToken:this.context.accessToken||"",ext:m,delay:i.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onPictureMessage(l);break;case"audio":var l={id:n,type:g,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+_.url.substr(_.url.indexOf("/",9)):_.url,secret:_.secret,filename:_.filename,length:_.length||"",file_length:_.file_length||"",filetype:_.filetype||"",accessToken:this.context.accessToken||"",ext:m,delay:i.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onAudioMessage(l);break;case"file":var l={id:n,type:g,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+_.url.substr(_.url.indexOf("/",9)):_.url,secret:_.secret,filename:_.filename,file_length:_.file_length,accessToken:this.context.accessToken||"",ext:m,delay:i.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onFileMessage(l);break;case"loc":var l={id:n,type:g,from:p,to:f,addr:_.addr,lat:_.lat,lng:_.lng,ext:m,delay:i.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onLocationMessage(l);break;case"video":var l={id:n,type:g,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+_.url.substr(_.url.indexOf("/",9)):_.url,secret:_.secret,filename:_.filename,file_length:_.file_length,accessToken:this.context.accessToken||"",ext:m,delay:i.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onVideoMessage(l);break;case"cmd":var l={id:n,from:p,to:f,action:_.action,ext:m,delay:i.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=a,l.errorCode=r,this.onCmdMessage(l)}}catch(I){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:I})}}}}}},connection.prototype.handleReceivedMessage=function(e){try{this.onReceivedMessage(e)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}var n,i,o=e.getElementsByTagName("received");if(o.length>0&&(n=o[0].childNodes&&o[0].childNodes.length>0?o[0].childNodes[0].nodeValue:o[0].innerHTML||o[0].innerText,i=o[0].getAttribute("mid")),_msgHash[n]){try{_msgHash[n].msg.success instanceof Function&&_msgHash[n].msg.success(n,i)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}delete _msgHash[n]}},connection.prototype.handleInviteMessage=function(e){var t=null,n=e.getElementsByTagName("invite"),i=e.getElementsByTagName("reason")[0],o=i.textContent,r=e.getAttribute("id")||"";if(this.sendReceiptsMessage({id:r}),n&&n.length>0){var a=n[0].getAttribute("from");t=_parseNameFromJidFn(a)}var s=e.getElementsByTagName("x"),c=null;if(s&&s.length>0)for(var u=0;u<s.length;u++)if("jabber:x:conference"===s[u].namespaceURI){var d=s[u].getAttribute("jid");c=_parseNameFromJidFn(d)}this.onInviteMessage({type:"invite",from:t,roomid:c,reason:o})},connection.prototype.sendCommand=function(e,t){this.isOpened()?this.context.stropheConn.send(e):this.onError({type:_code.WEBIM_CONNCTION_DISCONNECTED,reconnect:!0})},connection.prototype.getUniqueId=function(e){var t=new Date,n=new Date(2010,1,1),i=t.getTime()-n.getTime(),o=parseInt(i).toString(16);return"string"==typeof e||"number"==typeof e?e+"_"+o:"WEBIM_"+o},connection.prototype.send=function(e){var t=this;if(this.isWindowSDK)WebIM.doQuery('{"type":"sendMessage","to":"'+e.to+'","message_type":"'+e.type+'","msg":"'+encodeURI(e.msg)+'","chatType":"'+e.chatType+'"}',function(e){},function(e,n){var i={data:{data:"send"},type:_code.WEBIM_MESSAGE_SED_ERROR};t.onError(i)});else if("[object Object]"===Object.prototype.toString.call(e)){var n=this.context.appKey||"",i=n+"_"+e.to+"@"+this.domain;e.group&&(i=n+"_"+e.to+"@conference."+this.domain),e.resource&&(i=i+"/"+e.resource),e.toJid=i,e.id=e.id||this.getUniqueId(),_msgHash[e.id]=new _message(e),_msgHash[e.id].send(this)}else"string"==typeof e&&_msgHash[e]&&_msgHash[e].send(this)},connection.prototype.addRoster=function(e){var t=_getJid(e,this),n=e.name||"",i=e.groups||"",o=$iq({type:"set"});if(o.c("query",{xmlns:"jabber:iq:roster"}),o.c("item",{jid:t,name:n}),i)for(var r=0;r<i.length;r++)o.c("group").t(i[r]).up();var a=e.success||_utils.emptyfn,s=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(o.tree(),a,s)},connection.prototype.removeRoster=function(e){var t=_getJid(e,this),n=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:t,subscription:"remove"}),i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(n,i,o)},connection.prototype.getRoster=function(e){var t=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"}),e=e||{},n=e.success||this.onRoster,i=function(e){var t=[],i=e.getElementsByTagName("query");if(i&&i.length>0){var o=i[0];t=_parseFriend(o)}n(t,e)},o=e.error||this.onError,r=function(e){o({type:_code.WEBIM_CONNCTION_GETROSTER_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(t.tree(),i,r):o({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.subscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribe"});e.message&&n.c("status").t(e.message).up(),e.nick&&n.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(e.nick),this.sendCommand(n.tree())},connection.prototype.subscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.unsubscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribe"});e.message&&n.c("status").t(e.message),this.sendCommand(n.tree())},connection.prototype.unsubscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.joinPublicGroup=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=function(e){o({type:_code.WEBIM_CONNCTION_JOINROOM_ERROR,data:e})},a=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC});this.context.stropheConn.sendIQ(a.tree(),i,r)},connection.prototype.listRooms=function(e){var t=$iq({to:e.server||"conference."+this.domain,from:this.context.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),n=e.success||_utils.emptyfn,i=e.error||this.onError,o=function(e){var t=[];t=_parseRoom(e);try{n(t)}catch(o){i({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:o})}},r=e.error||_utils.emptyfn,a=function(e){r({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:e})};this.context.stropheConn.sendIQ(t.tree(),o,a)},connection.prototype.queryRoomMember=function(e){var t=(this.domain,[]),n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",{xmlns:Strophe.NS.MUC+"#admin"}).c("item",{affiliation:"member"}),i=e.success||_utils.emptyfn,o=function(e){var n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var r=n[o],a={jid:r.getAttribute("jid"),affiliation:"member"};t.push(a)}i(t)},r=e.error||_utils.emptyfn,a=function(e){r({type:_code.WEBIM_CONNCTION_GETROOMMEMBER_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),o,a)},connection.prototype.queryRoomInfo=function(e){var t=this.domain,n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+t,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_INFO}),i=e.success||_utils.emptyfn,o=[],r=function(e){var n="",r=e.getElementsByTagName("feature");switch(r&&(n=r[1].getAttribute("var")+"|"+r[3].getAttribute("var")+"|"+r[4].getAttribute("var")),n){case"muc_public|muc_membersonly|muc_notallowinvites":n="PUBLIC_JOIN_APPROVAL";break;case"muc_public|muc_open|muc_notallowinvites":n="PUBLIC_JOIN_OPEN";break;case"muc_hidden|muc_membersonly|muc_allowinvites":n="PRIVATE_MEMBER_INVITE";break;case"muc_hidden|muc_membersonly|muc_notallowinvites":n="PRIVATE_OWNER_INVITE"}var a=e.getElementsByTagName("field"),s={};if(a){for(var c=0;c<a.length;c++){var u=a[c],d=u.getAttribute("var"),l=d.split("_")[1];switch(d){case"muc#roominfo_occupants":case"muc#roominfo_maxusers":case"muc#roominfo_affiliations":case"muc#roominfo_description":s[l]=u.textContent||u.text||"";break;case"muc#roominfo_owner":var p={jid:(u.textContent||u.text)+"@"+t,affiliation:"owner"};o.push(p),s[l]=u.textContent||u.text}}s.name=e.getElementsByTagName("identity")[0].getAttribute("name")}log(n,o,s),i(n,o,s)},a=e.error||_utils.emptyfn,s=function(e){a({type:_code.WEBIM_CONNCTION_GETROOMINFO_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),r,s)},connection.prototype.queryRoomOccupants=function(e){var t=e.success||_utils.emptyfn,n=function(e){var n=[];n=_parseRoomOccupants(e),t(n)},i=e.error||_utils.emptyfn,o=function(e){i({type:_code.WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR,data:e})},r={xmlns:Strophe.NS.DISCO_ITEMS},a=$iq({from:this.context.jid,to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",r);this.context.stropheConn.sendIQ(a.tree(),n,o)},connection.prototype.setUserSig=function(e){var t=$pres({xmlns:"jabber:client"});e=e||"",t.c("status").t(e),this.sendCommand(t.tree())},connection.prototype.setPresence=function(e,t){var n=$pres({xmlns:"jabber:client"});e&&(t?(n.c("show").t(e),n.up().c("status").t(t)):n.c("show").t(e)),this.sendCommand(n.tree())},connection.prototype.getPresence=function(){var e=$pres({xmlns:"jabber:client"});this.sendCommand(e.tree())},connection.prototype.ping=function(e){var e=e||{},t=_getJid(e,this),n=$iq({from:this.context.jid||"",to:t,type:"get"}).c("ping",{xmlns:"urn:xmpp:ping"}),i=e.success||_utils.emptyfn,o=e.error||this.onError,r=function(e){o({type:_code.WEBIM_CONNCTION_PING_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(n.tree(),i,r):o({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.isOpened=function(){return this.context.status==_code.STATUS_OPENED},connection.prototype.isOpening=function(){var e=this.context.status;return e==_code.STATUS_DOLOGIN_USERGRID||e==_code.STATUS_DOLOGIN_IM},connection.prototype.isClosing=function(){return this.context.status==_code.STATUS_CLOSING},connection.prototype.isClosed=function(){return this.context.status==_code.STATUS_CLOSED},connection.prototype.clear=function(){var e=this.context.appKey;if(this.errorType!=_code.WEBIM_CONNCTION_DISCONNECTED&&(this.context={status:_code.STATUS_INIT,appKey:e}),this.intervalId&&clearInterval(this.intervalId),this.restIndex=0,this.xmppIndex=0,this.errorType==_code.WEBIM_CONNCTION_CLIENT_LOGOUT||-1==this.errorType){var t={data:{data:"clear"},type:_code.WEBIM_CONNCTION_CLIENT_LOGOUT};this.onError(t)}},connection.prototype.getChatRooms=function(e){if(!_utils.isCanSetRequestHeader)return void t.onError({type:_code.WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR});var t=this,n=e.accessToken||this.context.accessToken;if(n){var i=e.apiUrl,o=this.context.appName,r=this.context.orgName;if(!o||!r)return void t.onError({type:_code.WEBIM_CONNCTION_AUTH_ERROR});var a=function(t,n){"function"==typeof e.success&&e.success(t)},s=function(e,n,i){e.error&&e.error_description&&t.onError({type:_code.WEBIM_CONNCTION_LOAD_CHATROOM_ERROR,msg:e.error_description,data:e,xhr:n})},c={pagenum:parseInt(e.pagenum)||1,pagesize:parseInt(e.pagesize)||20},u={url:i+"/"+r+"/"+o+"/chatrooms",dataType:"json",type:"GET",headers:{Authorization:"Bearer "+n},data:c,success:a||_utils.emptyfn,error:s||_utils.emptyfn};_utils.ajax(u)}else t.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR})},connection.prototype.joinChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=function(e){o({type:_code.WEBIM_CONNCTION_JOINCHATROOM_ERROR,data:e})},a=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"member",role:"participant"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(a.tree(),i,r)},connection.prototype.quitChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=function(e){o({type:_code.WEBIM_CONNCTION_QUITCHATROOM_ERROR,data:e})},a=$pres({from:this.context.jid,to:n,type:"unavailable"}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"none",role:"none"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(a.tree(),i,r)},connection.prototype._onReceiveInviteFromGroup=function(info){info=eval("("+info+")");
var self=this,options={title:"Group invitation",msg:info.user+" invites you to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" agreed to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteDeclineFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" rejected to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onAutoAcceptInvitationFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation",msg:"You had joined into the group:"+info.group_name+" automatically.Inviter:"+info.user,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onLeaveGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been out of the group:"+info.group_id+".Reason:"+info.msg,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveJoinGroupApplication=function(info){info=eval("("+info+")");var self=this,options={title:"Group join application",msg:info.user+" applys to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_JOIN_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_JOIN_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You had joined into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveRejectionFromGroup=function(){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been rejected to join into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onUpdateMyGroupList=function(e){this.onUpdateMyGroupList(e)},connection.prototype._onUpdateMyRoster=function(e){this.onUpdateMyRoster(e)},connection.prototype.reconnect=function(){console.log("reconnect");var e=this;setTimeout(function(){_login(e.context.restTokenData,e)},1e3*(0==this.autoReconnectNumTotal?0:this.autoReconnectInterval)),this.autoReconnectNumTotal++},connection.prototype.closed=function(){var e={data:{data:"Closed error"},type:_code.WEBIM_CONNECTION_CLOSED};this.onError(e)},connection.prototype.getBlacklist=function(e){e=e||{};var t=$iq({type:"get"}),n=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,o=this;t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),this.context.stropheConn.sendIQ(t.tree(),function(e){o.onBlacklistUpdate(_parsePrivacy(e)),n()},function(){o.onBlacklistUpdate([]),i()})},connection.prototype.addToBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},i=e.type||"jid",o=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn,a=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),s=Object.keys(n),c=s.length,u=2,d=0;c>d;d++){var l=n[s[d]],i=l.type||"jid",p=l.jid;a=a.c("item",{action:"deny",order:u++,type:i,value:p}).c("message"),d!==c-1&&(a=a.up().up())}this.context.stropheConn.sendIQ(a.tree(),o,r)},connection.prototype.removeFromBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},i=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,r=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),a=Object.keys(n),s=a.length,c=0;s>c;c++){var u=n[a[c]],d=u.type||"jid",l=u.jid,p=u.order;r=r.c("item",{action:"deny",order:p,type:d,value:l}).c("message"),c!==s-1&&(r=r.up().up())}this.context.stropheConn.sendIQ(r.tree(),i,o)},connection.prototype._getGroupJid=function(e){var t=this.context.appKey||"";return t+"_"+e+"@conference."+this.domain},connection.prototype.addToGroupBlackList=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=_getJid(e,this),o="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"outcast",jid:i}),this.context.stropheConn.sendIQ(a.tree(),t,n)},connection.prototype.getGroupBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i="admin",o=this._getGroupJid(e.roomId),r=$iq({type:"get",to:o});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"outcast"}),this.context.stropheConn.sendIQ(r.tree(),function(e){log("getGroupBlackList"),t(_parseGroupBlacklist(e))},function(){n()})},connection.prototype.removeGroupMemberFromBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=_getJid(e,this),o="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"member",jid:i}),this.context.stropheConn.sendIQ(a.tree(),function(e){t()},function(){n()})},connection.prototype.changeGroupSubject=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i="owner",o=this._getGroupJid(e.roomId),r=$iq({type:"set",to:o});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("x",{type:"submit",xmlns:"jabber:x:data"}).c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up().c("field",{"var":"muc#roomconfig_roomname"}).c("value").t(e.subject).up().up().c("field",{"var":"muc#roomconfig_roomdesc"}).c("value").t(e.description),this.context.stropheConn.sendIQ(r.tree(),function(e){t()},function(){n()})},connection.prototype.destroyGroup=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i="owner",o=this._getGroupJid(e.roomId),r=$iq({type:"set",to:o});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("destroy").c("reason").t(e.reason||""),this.context.stropheConn.sendIQ(r.tree(),function(e){t()},function(){n()})},connection.prototype.leaveGroupBySelf=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=_getJid(e,this),o="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"none",jid:i}),this.context.stropheConn.sendIQ(a.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.leaveGroup=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=e.list||[],o="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r}),s=a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}),c=Object.keys(i),u=c.length,d=0;u>d;d++){var l=i[c[d]],p=_getJidByName(l,this);s=s.c("item",{affiliation:"none",jid:p}).up().c("item",{role:"none",jid:p}).up()}this.context.stropheConn.sendIQ(a.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.addGroupMembers=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,i=e.list||[],o="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r}),s=a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}),c=i.length,u=0;c>u;u++){var d=i[u],l=_getJidByName(d,this);s=s.c("item",{affiliation:"member",jid:l}).up();var p=$msg({to:r}).c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("invite",{to:l}).c("reason").t(e.reason||"");this.sendCommand(p.tree())}this.context.stropheConn.sendIQ(a.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.acceptInviteFromGroup=function(e){e.success=function(){},this.addGroupMembers(e)},connection.prototype.rejectInviteFromGroup=function(e){},connection.prototype.createGroup=function(e){var t=+new Date,n=this._getGroupJid(t),i=n+"/"+this.context.userId,o=$pres({to:i}).c("x",{xmlns:"http://jabber.org/protocol/muc"}).up().c("create",{xmlns:"http://jabber.org/protocol/muc"}).up();this.sendCommand(o.tree());var r=this;setTimeout(function(){var i=$iq({type:"get",to:n}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"});r.context.stropheConn.sendIQ(i.tree(),function(i){if("setAttribute"in i){var o=i.getElementsByTagName("x")[0];o.setAttribute("type","submit")}else Strophe.forEachChild(i,"x",function(e){e.setAttribute("type","submit")});Strophe.info("step 5 ----------"),Strophe.forEachChild(o,"field",function(t){var n=t.getAttribute("var"),i=t.getElementsByTagName("value")[0];switch(Strophe.info(n),n){case"muc#roomconfig_roomname":_setText(i,e.subject||"");break;case"muc#roomconfig_roomdesc":_setText(i,e.description||"");break;case"muc#roomconfig_publicroom":_setText(i,+e.optionsPublic);break;case"muc#roomconfig_membersonly":_setText(i,+e.optionsMembersOnly);break;case"muc#roomconfig_moderatedroom":_setText(i,+e.optionsModerate);break;case"muc#roomconfig_persistentroom":_setText(i,1);break;case"muc#roomconfig_allowinvites":_setText(i,+e.optionsAllowInvites);break;case"muc#roomconfig_allowvisitornickchange":_setText(i,0);break;case"muc#roomconfig_allowvisitorstatus":_setText(i,0);break;case"allow_private_messages":_setText(i,0);break;case"allow_private_messages_from_visitors":_setText(i,"nobody")}});var a=$iq({to:n,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(o);r.context.stropheConn.sendIQ(a.tree(),function(n){r.addGroupMembers({list:e.members,roomId:t})},function(e){})},function(e){})},1e3)};var WebIM=window.WebIM||{};WebIM.connection=connection,WebIM.utils=_utils,WebIM.statusCode=_code,WebIM.message=_msg.message,WebIM.doQuery=function(e,t,n){"undefined"!=typeof window.cefQuery&&window.cefQuery({request:e,persistent:!1,onSuccess:t,onFailure:n})},module.exports=WebIM},232:function(e,t,n){"use strict";!function(){var e=n(223).utils,i=function r(e,t){return!this instanceof r?new r(e):(this._msg={},"function"==typeof r[e]&&(r[e].prototype.setGroup=this.setGroup,this._msg=new r[e](t)),this._msg)};i.prototype.setGroup=function(e){this.body.group=e},i.txt=function(e){this.id=e,this.type="txt",this.body={}},i.txt.prototype.set=function(e){this.value=e.msg,this.body={id:this.id,to:e.to,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success,fail:e.fail},!e.roomType&&delete this.body.roomType},i.cmd=function(e){this.id=e,this.type="cmd",this.body={}},i.cmd.prototype.set=function(e){this.value="",this.body={to:e.to,action:e.action,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success},!e.roomType&&delete this.body.roomType},i.location=function(e){this.id=e,this.type="loc",this.body={}},i.location.prototype.set=function(e){this.body={to:e.to,type:this.type,roomType:e.roomType,addr:e.addr,lat:e.lat,lng:e.lng,ext:e.ext||{}}},i.img=function(e){this.id=e,this.type="img",this.body={}},i.img.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.body={id:this.id,file:this.value,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,width:t.width,height:t.height,body:t.body,uploadError:t.uploadError,uploadComplete:t.uploadComplete},!t.roomType&&delete this.body.roomType},i.audio=function(e){this.id=e,this.type="audio",this.body={}},i.audio.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},length:t.length||0,roomType:t.roomType,file_length:t.file_length,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},i.file=function(e){this.id=e,this.type="file",this.body={}},i.file.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},i.video=function(e){},i.video.prototype.set=function(e){};var o=function a(e){return!this instanceof a?new a(e,conn):void(this.msg=e)};o.prototype.send=function(t){var n=this,i=function(n){n.ext=n.ext||{},n.ext.weichat=n.ext.weichat||{},n.ext.weichat.originType=n.ext.weichat.originType||"webim";var i={from:t.context.userId||"",to:n.to,bodies:[n.body],ext:n.ext||{}},o=e.stringify(i),r=$msg({type:n.group||"chat",to:n.toJid,id:n.id,xmlns:"jabber:client"}).c("body").t(o);n.roomType&&r.up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"}),setTimeout(function(){"undefined"!=typeof _msgHash&&_msgHash[n.id]&&_msgHash[n.id].msg.fail instanceof Function&&_msgHash[n.id].msg.fail(n.id)},6e4),t.sendCommand(r.tree(),n.id)};if(n.msg.file){if(n.msg.body&&n.msg.body.url)return void i(n.msg);var o=n.msg.onFileUploadComplete,r=function(e){if(e.entities[0]["file-metadata"]){var r=e.entities[0]["file-metadata"]["content-length"];n.msg.file_length=r,n.msg.filetype=e.entities[0]["file-metadata"]["content-type"],r>204800&&(n.msg.thumbnail=!0)}n.msg.body={type:n.msg.type||"file",url:("https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+e.uri.substr(e.uri.indexOf("/",9)):e.uri)+"/"+e.entities[0].uuid,secret:e.entities[0]["share-secret"],filename:n.msg.file.filename||n.msg.filename,size:{width:n.msg.width||0,height:n.msg.height||0},length:n.msg.length||0,file_length:n.msg.file_length||0,filetype:n.msg.filetype},i(n.msg),o instanceof Function&&o(e,n.msg.id)};n.msg.onFileUploadComplete=r,e.uploadFile.call(t,n.msg)}else n.msg.body={type:"chat"===n.msg.type?"txt":n.msg.type,msg:n.msg.msg},"cmd"===n.msg.type?n.msg.body.action=n.msg.action:"loc"===n.msg.type&&(n.msg.body.addr=n.msg.addr,n.msg.body.lat=n.msg.lat,n.msg.body.lng=n.msg.lng),i(n.msg)},t._msg=o,t.message=i}()},233:function(e,t){"use strict";!function(){function e(e){this.array=void 0===e?[]:new Array(e)}e.prototype={length:function(){return this.array.length},at:function(e){return this.array[e]},set:function(e,t){this.array[e]=t},push:function(e){return this.array.push(e)},slice:function(e,t){return this.array=this.array.slice(e,t)},concat:function(e){this.array=this.array.concat(e)},remove:function(e,t){t=void 0===t?1:t,this.array.splice(e,t)},join:function(e){return this.array.join(e)},clear:function(){this.array.length=0}};var n=function(){this._array_h=new e};n.prototype={_index:0,push:function(e){this._array_h.push(e)},pop:function(){var e=null;return this._array_h.length()&&(e=this._array_h.at(this._index),2*++this._index>=this._array_h.length()&&(this._array_h.slice(this._index),this._index=0)),e},head:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(t-1)),e},tail:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(this._index)),e},length:function(){return this._array_h.length()-this._index},empty:function(){return 0===this._array_h.length()},clear:function(){this._array_h.clear()}},t.Queue=n}()}}),function(e){function t(i){if(n[i])return n[i].exports;var o=n[i]={exports:{},id:i,loaded:!1};return e[i].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};return t.m=e,t.c=n,t.p="./",t(0)}({0:function(e,t,n){e.exports=n(228)},228:function(e,t,n){var i,o;(function(e){"use strict";var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a=n(230),s=n(231);window.WebIM="undefined"!=typeof WebIM?WebIM:{},WebIM.WebRTC=WebIM.WebRTC||{},WebIM.WebRTC.Call=s,WebIM.WebRTC.Util=a,"object"===r(e)&&"object"===r(e.exports)?e.exports=WebIM.WebRTC:(i=[],o=function(){return WebIM.WebRTC}.apply(t,i),!(void 0!==o&&(e.exports=o))),/Chrome/.test(navigator.userAgent)&&(WebIM.WebRTC.supportPRAnswer=navigator.userAgent.split("Chrome/")[1].split(".")[0]>=50?!0:!1)}).call(t,n(229)(e))},229:function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},230:function(e,t){"use strict";function n(){}var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var i,o=e,r=[];if(n=n||o.length,t)for(i=0;t>i;i++)r[i]=o[0|Math.random()*n];else{var a;for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",i=0;36>i;i++)r[i]||(a=0|16*Math.random(),r[i]=o[19==i?3&a|8:a])}return r.join("")},Math.uuidFast=function(){for(var t,n=e,i=new Array(36),o=0,r=0;36>r;r++)8==r||13==r||18==r||23==r?i[r]="-":14==r?i[r]="4":(2>=o&&(o=33554432+16777216*Math.random()|0),t=15&o,o>>=4,i[r]=n[19==r?3&t|8:t]);return i.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}}();var o=function(){function e(e,n){var i=[];i.push(e);for(var o in n)i.push(n[o]);t.log.apply(t,i)}var t=this,n={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,FATAL:5},i=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"];this.log=function(){var e=arguments[0];e=arguments[0]="["+i[e]+"] ";arguments[1];WebIM&&WebIM.config&&WebIM.config.isDebug&&console.log.apply(console,arguments)},this.trace=function(){this.log&&e(n.TRACE,arguments)},this.debug=function(){this.log&&e(n.DEBUG,arguments)},this.info=function(){this.log&&e(n.INFO,arguments)},this.warn=function(){this.log&&e(n.WARN,arguments)},this.error=function(){this.log&&e(n.ERROR,arguments)},this.fatal=function(){this.log&&e(n.FATAL,arguments)}};n.prototype.logger=new o,n.prototype.parseJSON=function(e){return JSON.parse(e)};var r=(n.prototype.stringifyJSON=function(e){return JSON.stringify(e)},{}),a=r.toString,s=r.hasOwnProperty,c=s.toString,u=c.call(Object);n.prototype.isPlainObject=function(e){var t,n;return e&&"[object Object]"===a.call(e)?(t=Object.getPrototypeOf(e))?(n=s.call(t,"constructor")&&t.constructor,"function"==typeof n&&c.call(n)===u):!0:!1};n.prototype.isArray=Array.isArray,n.prototype.isEmptyObject=function(e){var t;for(t in e)return!1;return!0},n.prototype.type=function(e){return null==e?e+"":"object"===("undefined"==typeof e?"undefined":i(e))||"function"==typeof e?r[a.call(e)]||"object":"undefined"==typeof e?"undefined":i(e)},n.prototype.extend=function(){var e,t,n,o,r,a,s=this,c=arguments[0]||{},u=1,d=arguments.length,l=!1;for("boolean"==typeof c&&(l=c,c=arguments[u]||{},u++),"object"===("undefined"==typeof c?"undefined":i(c))||s.isFunction(c)||(c={}),u===d&&(c=this,u--);d>u;u++)if(null!=(e=arguments[u]))for(t in e)n=c[t],o=e[t],c!==o&&(l&&o&&(s.isPlainObject(o)||(r=s.isArray(o)))?(r?(r=!1,a=n&&s.isArray(n)?n:[]):a=n&&s.isPlainObject(n)?n:{},c[t]=s.extend(l,a,o)):void 0!==o&&(c[t]=o));return c},n.prototype.hasLocalStorage=function(e){return null==localStorage.getItem(e)||"{}"==localStorage.getItem(e)?!1:!0},n.prototype.toggleClass=function(e,t){return e.hasClass(t)?void e.removeClass(t):void e.addClass(t)},n.prototype.setCookie=function(e,t,n){var i=new Date;i.setTime(i.getTime()+60*n*60*1e3),document.cookie=e+"="+escape(t)+";expires="+i.toGMTString()},n.prototype.getCookie=function(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null},n.prototype.parseURL=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null},e.exports=new n},231:function(e,t,n){"use strict";var i=n(230),o=n(232),r=n(233),a=n(234),s=n(235),c=r.RouteTo,u=r.Api,d=i.logger,l={api:null,caller:"",connection:null,pattern:null,listener:{onAcceptCall:function(e,t){},onRinging:function(e){},onTermCall:function(){},onIceConnectionStateChange:function(e){}},mediaStreamConstaints:{audio:!0,video:!0},init:function(){var e=this;if("undefined"==typeof e.connection)throw"Caller need a instance of Easemob.im.Connection";e.api=e.api||new u({imConnection:e.connection,rtcHandler:new o({imConnection:e.connection})}),e.api.onInitC=function(){e._onInitC.apply(e,arguments)},e.api.onIceConnectionStateChange=function(){e.listener.onIceConnectionStateChange.apply(e,arguments)}},makeVideoCall:function(e,t){var n={};i.extend(n,this.mediaStreamConstaints),this.call(e,n,t)},makeVoiceCall:function(e,t){var n=this,o={};i.extend(o,n.mediaStreamConstaints),n.mediaStreamConstaints.video=!1,n.call(e,o,t)},acceptCall:function(){var e=this;e.pattern.accept()},endCall:function(e){var t=this;t.caller="",t.pattern.termCall()},call:function(e,t,n){var i=this;this.callee=this.api.jid(e);var o=new c({rtKey:"",sid:n,success:function(e){d.debug("iq to server success",e)},fail:function(e){d.debug("iq to server error",e),i.onError(e)}});this.api.reqP2P(o,t.video?1:0,t.audio?1:0,this.api.jid(e),function(e,t){return"0"==t.online?void i.listener.onError({message:"callee is not online!"}):(i._onGotServerP2PConfig(e,t),void i.pattern.initC(i.mediaStreamConstaints,n))})},_onInitC:function(e,t,n,i,o){var r=this;r.callee=e,r._rtcCfg=t.rtcCfg,r._WebRTCCfg=t.WebRTC,r.sessId=t.sessId,r.rtcId=t.rtcId,r.switchPattern(),r.pattern._onInitC(e,t,n,i,o)},_onGotServerP2PConfig:function(e,t){var n=this;0==t.result&&(n._p2pConfig=t,n._rtcCfg=t.rtcCfg,n._rtcCfg2=t.rtcCfg2,n.sessId=t.sessId,n.rtcId="Channel_webIM",n._rtKey=n._rtkey=t.rtKey||t.rtkey,n._rtFlag=n._rtflag=t.rtFlag||t.rtflag,n._WebRTCCfg=t.WebRTC,n.admtok=t.admtok,n.tkt=t.tkt,n.switchPattern())},switchPattern:function(){var e=this;!e._WebRTCCfg&&(e.pattern=new s({callee:e.callee,_p2pConfig:e._p2pConfig,_rtcCfg:e._rtcCfg,_rtcCfg2:e._rtcCfg2,_rtKey:e._rtKey||e._rtkey,_rtFlag:e._rtFlag||e._rtflag,_sessId:e.sessId,_rtcId:e.rtcId,webRtc:new a({onGotLocalStream:e.listener.onGotLocalStream,onGotRemoteStream:e.listener.onGotRemoteStream,onError:e.listener.onError}),api:e.api,onAcceptCall:e.listener&&e.listener.onAcceptCall||function(){},onRinging:e.listener&&e.listener.onRinging||function(){},onTermCall:e.listener&&e.listener.onTermCall||function(){}}))}};e.exports=function(e){i.extend(!0,this,l,e||{}),this.init()}},232:function(e,t,n){"use strict";var i=n(230),o=i.logger,r=n(233),a=r.RouteTo,s="urn:xmpp:media-conference",c={_apiCallbacks:{},imConnection:null,_connectedSid:"",init:function(){var e,t=this,n=t.imConnection;n.addHandler=function(i,r,a,c,u,d,l){"function"!=typeof e&&(e=function(e){try{t.handleRtcMessage(e)}catch(n){throw o.error(n.stack||n),n}return!0},n.addHandler(e,s,"iq","set",null,null),n.addHandler(e,s,"iq","get",null,null)),n.context.stropheConn.addHandler(i,r,a,c,u,d,l)}},handleRtcMessage:function(e){var t=this,n=(e.getAttribute("id"),e.getAttribute("from")||"");n.lastIndexOf("/")>=0&&(n=n.substring(0,n.lastIndexOf("/")));var r=e.getElementsByTagName("rtkey")[0].innerHTML,s=e.getElementsByTagName("sid")[0].innerHTML;(t._fromSessionID||(t._fromSessionID={}))[n]=s;var c=e.getElementsByTagName("content"),u=(e.getElementsByTagName("stream_type")[0].innerHTML,c[0].innerHTML),d=i.parseJSON(u),l=d,p=d.tsxId;if(t.ctx=d.ctx,o.debug("Recv [op = "+l.op+"] [tsxId="+p+"]\r\n json :",e),n.indexOf("@")>=0)if(""==t._connectedSid&&102==l.op)t._connectedSid=s;else if(t._connectedSid!=s){if(102==l.op){var f=new a({to:n,rtKey:r,sid:s,success:function(e){o.debug("iq to server success",e)},fail:function(e){o.debug("iq to server error",e),t.onError(e)}}),m={data:{op:107,sessId:l.sessId,rtcId:l.rtcId,reason:"busy"},reason:"busy"};t.sendRtcMessage(f,m)}return}if(107==l.op&&(t._connectedSid="",t._fromSessionID={}),l.sdp&&("string"==typeof l.sdp&&(l.sdp=i.parseJSON(l.sdp)),l.sdp.type&&(l.sdp.type=l.sdp.type.toLowerCase())),l.cands){"string"==typeof l.cands&&(l.cands=i.parseJSON(l.cands));for(var g=0;g<l.cands.length;g++)"string"==typeof l.cands[g]&&(l.cands[g]=i.parseJSON(l.cands[g])),l.cands[g].sdpMLineIndex=l.cands[g].mlineindex,l.cands[g].sdpMid=l.cands[g].mid,delete l.cands[g].mlineindex,delete l.cands[g].mid}if(l.rtcCfg&&"string"==typeof l.rtcCfg&&(l.rtcCfg=i.parseJSON(l.rtcCfg)),l.rtcCfg2&&"string"==typeof l.rtcCfg2&&(l.rtcCfg2=i.parseJSON(l.rtcCfg2)),l.WebRTC&&"string"==typeof l.WebRTC&&(l.WebRTC=i.parseJSON(l.WebRTC)),p&&t._apiCallbacks[p])try{t._apiCallbacks[p].callback&&t._apiCallbacks[p].callback(n,l)}catch(h){throw h}finally{delete t._apiCallbacks[p]}else t.onRecvRtcMessage(n,l,r,p,s);return!0},onRecvRtcMessage:function(e,t,n,r,a){o.debug(" form : "+e+" \r\n json :"+i.stringifyJSON(rtcJSON))},convertRtcOptions:function(e){var t=e.data.sdp;if(t){var n={type:t.type,sdp:t.sdp};t=n,t.type=t.type.toUpperCase(),t=i.stringifyJSON(t),e.data.sdp=t}var o=e.data.cands;if(o){if(i.isArray(o));else{var r=[];r.push(o),o=r}for(var a in o)if(o[a]instanceof RTCIceCandidate){var s={type:"candidate",candidate:o[a].candidate,mlineindex:o[a].sdpMLineIndex,mid:o[a].sdpMid};o[a]=i.stringifyJSON(s)}e.data.cands=o}var c=e.data.rtcCfg;c&&"string"!=typeof c&&(e.data.rtcCfg=i.stringifyJSON(c));var u=e.data.WebRTC;u&&"string"!=typeof u&&(e.data.WebRTC=i.stringifyJSON(u))},sendRtcMessage:function(e,t,n){var r=this,a=r.imConnection,c=e.tsxId||a.getUniqueId(),u=e.to||a.domain,d=e.sid||r._fromSessionID&&r._fromSessionID[u];d=d||a.getUniqueId("CONFR_"),(r._fromSessionID||(r._fromSessionID={}))[u]=d,u.indexOf("@")>=0&&""==r._connectedSid&&102==t.data.op&&(r._connectedSid=d);var l=e.rtKey||e.rtkey;l||(l="");var p=e.rtflag;p||(p=1),t.data||(t.data={}),t.data.tsxId=c,r.ctx&&(t.data.ctx=r.ctx),r.convertRtcOptions(t);var f="VIDEO",m=e.id||a.getUniqueId("CONFR_"),g=$iq({id:m,to:u,from:a.context.jid,type:e.type||"get"}).c("query",{xmlns:s}).c("MediaReqExt").c("rtkey").t(l).up().c("rtflag").t(p).up().c("stream_type").t(f).up().c("sid").t(d).up().c("content").t(i.stringifyJSON(t.data));107==t.data.op&&t.reason&&g.up().c("reaseon").t(t.reason),o.debug("Send [op = "+t.data.op+"] : \r\n",g.tree()),n&&(r._apiCallbacks[c]={callback:n});var h=function(t){e.success(t)}||function(e){o.debug("send result. op:"+t.data.op+".",e)},v=function(t){e.fail(t)}||function(e){o.debug(e)};a.context.stropheConn.sendIQ(g.tree(),h,v),107==t.data.op&&r._connectedSid&&(e.sid&&r._connectedSid!=e.sid||(r._connectedSid="",r._fromSessionID={}))}},u=function(e){i.extend(!0,this,c,e||{}),this.init()};e.exports=u},233:function(e,t,n){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=n(230),r=o.logger,a={rtFlag:1,success:function(e){},fail:function(e){}},s=function u(e){if(!(this instanceof u)){var t=function(e){var t=this;o.extend(!0,t,e||{})};return o.extend(!0,t.prototype,a,e||{}),t}var n=this;o.extend(!0,n,a,e||{})};t.RouteTo=s;var c={imConnection:null,rtcHandler:null,events:{0:"onReqP2P",1:"onNewCfr",2:"onDelCfr",3:"onReqTkt",100:"onPing",101:"onPong",102:"onInitC",103:"onReqC",104:"onAcptC",105:"onTcklC",106:"onAnsC",107:"onTermC",300:"onEvEnter",301:"onEvExit",302:"onEvPub",303:"onEvUnpub",304:"onEvMems",204:"onEvClose",onServerError:"onServerError"},register:function(e){if("object"===("undefined"==typeof e?"undefined":i(e)))for(var t in e)this.bind(t,e[t])},bind:function(e,t){var n,i=this;(n=i.events[e])?i[n]=t:(n=i.events[e]="on_"+e,i[n]=t)},jid:function(e){return/^.+#.+_.+@.+$/g.test(e)?e:this.imConnection.context.appKey+"_"+e+"@"+this.imConnection.domain},reqP2P:function(e,t,n,i,o){r.debug("req p2p ...");var a={data:{op:0,video:t,audio:n,peer:i}};this.rtcHandler.sendRtcMessage(e,a,o)},newCfr:function(e,t,n,i){r.debug("newCfr ...");var o=this,a={data:{op:1}};t&&(a.data.reqTkt=t),n&&(a.data.password=n),o.rtcHandler.sendRtcMessage(e,a,i)},enter:function(e,t,n,i,o,a,s){r.debug("enter ...");var c=this,u={data:{op:200}};t&&(u.data.WebRTCId=t),n&&(u.data.reqMembers=n),i&&(u.data.tkt=i),o&&(u.data.nonce=o),a&&(u.data.digest=a),c.rtcHandler.sendRtcMessage(e,u,s)},ping:function(e,t,n){r.debug("ping ...");var i=this,o={data:{op:100}};t&&(o.data.sessId=t),i.rtcHandler.sendRtcMessage(e,o,n)},reqTkt:function(e,t,n){r.debug("reqTkt ...");var i=this,o={data:{op:3}};t&&(o.data.WebRTCId=t),i.rtcHandler.sendRtcMessage(e,o,n)},initC:function(e,t,n,i,o,a,s,c,u,d,l,p){r.debug("initC ...");var f={data:{op:102}};t&&(f.data.WebRTCId=t),n&&(f.data.tkt=n),i&&(f.data.sessId=i),o&&(f.data.rtcId=o),a&&(f.data.pubS=a),s&&(f.data.subS=s),c&&(f.data.sdp=c),u&&(f.data.cands=u),d&&(f.data.rtcCfg=d),l&&(f.data.WebRTC=l),this.rtcHandler.sendRtcMessage(e,f,p)},tcklC:function(e,t,n,i,o,a){r.debug("tcklC ...");var s=this,c={data:{op:105}};t&&(c.data.sessId=t),n&&(c.data.rtcId=n),i&&(c.data.sdp=i),o&&(c.data.cands=o),s.rtcHandler.sendRtcMessage(e,c,a)},ansC:function(e,t,n,i,o,a){r.debug("ansC ...");var s=this,c={data:{op:106}};t&&(c.data.sessId=t),n&&(c.data.rtcId=n),i&&(c.data.sdp=i),o&&(c.data.cands=o),s.rtcHandler.sendRtcMessage(e,c,a)},acptC:function(e,t,n,i,o,a,s){r.debug("acptC ...");var c=this,u={data:{op:104}};t&&(u.data.sessId=t),n&&(u.data.rtcId=n),i&&(u.data.sdp=i),o&&(u.data.cands=o),a&&(u.data.ans=a),c.rtcHandler.sendRtcMessage(e,u,s)},getMems:function(e,t,n,i){r.debug("getMems ...");var o=this,a={data:{op:203}};t&&(a.data.WebRTCId=t),n&&(a.data.sessId=n),o.rtcHandler.sendRtcMessage(e,a,i)},subC:function(e,t,n,i,o){r.debug("subC ...");var a=this,s={data:{op:205}};t&&(s.data.sessId=t),n&&(s.data.rtcId=n),i&&(s.data.subS=i),a.rtcHandler.sendRtcMessage(e,s,o)},usubC:function(e,t,n,i){r.debug("usubC ...");var o=this,a={data:{op:206}};t&&(a.data.sessId=t),n&&(a.data.rtcId=n),o.rtcHandler.sendRtcMessage(e,a,i)},termC:function(e,t,n,i,o){r.debug("termC ...");var a=this,s={data:{op:107}};t&&(s.data.sessId=t),n&&(s.data.rtcId=n),i&&(s.reason=i),a.rtcHandler.sendRtcMessage(e,s,o)},exit:function(e,t,n,i){r.debug("exit ...");var o=this,a={data:{op:201}};t&&(a.data.WebRTCId=t),n&&(a.data.sessId=n),o.rtcHandler.sendRtcMessage(e,a,i)},delCfr:function(e,t,n,i){r.debug("delCfr ...");var o=this,a={data:{op:2}};t&&(a.data.WebRTCId=t),n&&(a.data.admtok=n),o.rtcHandler.sendRtcMessage(e,a,i)}};t.Api=function(e){function t(e,t,i,o,a){if(0!=t.result&&n.onServerError)n.onServerError.call(n,e,t,i,o,a);else{var s;n.events[t.op]&&(s=n[n.events[t.op]])?s.call(n,e,t,i,o,a):r.info("can not handle(recvRtcMessage) the op: "+t.op,t)}}var n=this;o.extend(!0,this,c,e||{}),this.rtcHandler.onRecvRtcMessage=t}},234:function(e,t,n){"use strict";var i=n(230),o=i.logger,r={headerSection:null,audioSection:null,videoSection:null,_parseHeaderSection:function(e){var t=e.indexOf("m=audio");return t>=0?e.slice(0,t):(t=e.indexOf("m=video"),t>=0?e.slice(0,t):e)},_parseAudioSection:function(e){var t=e.indexOf("m=audio");if(t>=0){var n=e.indexOf("m=video");return e.slice(t,0>n?e.length:n)}},_parseVideoSection:function(e){var t=e.indexOf("m=video");return t>=0?e.slice(t):void 0},spiltSection:function(e){var t=this;t.headerSection=t._parseHeaderSection(e),
t.audioSection=t._parseAudioSection(e),t.videoSection=t._parseVideoSection(e)},removeSSRC:function(e){for(var t=[],n=e.split(/a=ssrc:[^\n]+/g),i=0;i<n.length;i++)"\n"!=n[i]&&t.push(n[i]);return t.join("\n")},updateHeaderMsidSemantic:function(e){var t=this,n="a=msid-semantic: WMS "+e,i=t.headerSection.split(/a=msid\-semantic: WMS.*/g),o=[];switch(i.length){case 1:o.push(i[0]);break;case 2:o.push(i[0]),o.push(n),o.push("\n");break;case 3:o.push(i[0]),o.push(n),o.push("\n"),o.push(i[2]),o.push("\n")}return t.headerSection=o.join("")},updateAudioSSRCSection:function(e,t,n,i){var o=this;o.audioSection&&(o.audioSection=o.removeSSRC(o.audioSection)+o.ssrcSection(e,t,n,i))},updateVideoSSRCSection:function(e,t,n,i){var o=this;o.videoSection&&(o.videoSection=o.removeSSRC(o.videoSection)+o.ssrcSection(e,t,n,i))},getUpdatedSDP:function(){var e=this,t="";return e.headerSection&&(t+=e.headerSection),e.audioSection&&(t+=e.audioSection),e.videoSection&&(t+=e.videoSection),t},parseMsidSemantic:function(e){var t=this,n=/a=msid\-semantic: WMS (\S+)/gi,i=t._parseLine(e,n);return i&&2==i.length&&(t.msidSemantic={line:i[0],WMS:i[1]}),t.msidSemantic},ssrcSection:function(e,t,n,i){var o=["a=ssrc:"+e+" cname:"+t,"a=ssrc:"+e+" msid:"+n+" "+i,"a=ssrc:"+e+" mslabel:"+n,"a=ssrc:"+e+" label:"+i,""];return o.join("\n")},parseSSRC:function(e){var t=this,n=new RegExp("a=(ssrc):(\\d+) (\\S+):(\\S+)","ig"),i=t._parseLine(e,n);if(i){for(var o={lines:[],updateSSRCSection:t.ssrcSection},r=0;r<i.length;r++){var a=i[r];if(a.indexOf("a=ssrc")>=0)o.lines.push(a);else switch(a){case"ssrc":case"cname":case"msid":case"mslabel":case"label":o[a]=i[++r]}}return o}},_parseLine:function(e,t){for(var n,i=[];null!=(n=t.exec(e));)for(var o=0;o<n.length;o++)i.push(n[o]);return i.length>0?i:void 0}},a=function(e){i.extend(this,r),this.spiltSection(e)},s={mediaStreamConstaints:{audio:!0,video:!0},localStream:null,rtcPeerConnection:null,offerOptions:{offerToReceiveAudio:1,offerToReceiveVideo:1},createMedia:function(e,t){function n(e){o.debug("[WebRTC-API] got local stream"),i.localStream=e;var n=i.localStream.getVideoTracks(),r=i.localStream.getAudioTracks();n.length>0&&o.debug("[WebRTC-API] Using video device: "+n[0].label),r.length>0&&o.debug("[WebRTC-API] Using audio device: "+r[0].label),t?t(i,e):i.onGotStream(e)}var i=this;return e&&"function"==typeof e&&(t=e,e=null),o.debug("[WebRTC-API] begin create media ......"),navigator.mediaDevices.getUserMedia(e||i.mediaStreamConstaints).then(n).then(i.onCreateMedia)["catch"](function(e){o.debug("[WebRTC-API] getUserMedia() error: ",e),i.onError(e)})},setLocalVideoSrcObject:function(e){this.onGotLocalStream(e),o.debug("[WebRTC-API] you can see yourself !")},createRtcPeerConnection:function(e){o.debug("[WebRTC-API] begin create RtcPeerConnection ......");var t=this;e?(!e.iceServers&&(e.iceServers=[]),e.rtcpMuxPolicy="require",e.bundlePolicy="max-bundle",e.relayOnly&&(e.iceTransportPolicy="relay")):e=null,o.debug("[WebRTC-API] RtcPeerConnection config:",e),t.startTime=window.performance.now();var n=t.rtcPeerConnection=new RTCPeerConnection(e);o.debug("[WebRTC-API] Created local peer connection object",n),n.onicecandidate=function(e){("icecandidate"!=e.type||null!=e.candidate&&!/ tcp /.test(e.candidate.candidate))&&t.onIceCandidate(e)},n.onicestatechange=function(e){t.onIceStateChange(e)},n.oniceconnectionstatechange=function(e){t.onIceStateChange(e)},n.onaddstream=function(e){t._onGotRemoteStream(e)}},_uploadLocalStream:function(){this.rtcPeerConnection.addStream(this.localStream),o.debug("[WebRTC-API] Added local stream to RtcPeerConnection")},createOffer:function(e,t){var n=this;return n._uploadLocalStream(),o.debug("[WebRTC-API] createOffer start..."),n.rtcPeerConnection.createOffer(n.offerOptions).then(function(t){n.offerDescription=t,o.debug("[WebRTC-API] Offer "),o.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSessionDescriptionSuccess,n.onSetSessionDescriptionError).then(function(){(e||n.onCreateOfferSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createPRAnswer:function(e,t){var n=this;return o.info(" createPRAnswer start"),n.rtcPeerConnection.createAnswer().then(function(t){o.debug("[WebRTC-API] _____________PRAnswer "),t.type="pranswer",t.sdp=t.sdp.replace(/a=recvonly/g,"a=inactive"),n.prAnswerDescription=t,o.debug("[WebRTC-API] inactive PRAnswer "),o.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){var i=new a(t.sdp);i.updateHeaderMsidSemantic("MS_0000"),i.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),i.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=i.getUpdatedSDP(),o.debug("[WebRTC-API] Send PRAnswer "),(e||n.onCreatePRAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createAnswer:function(e,t){var n=this;return n._uploadLocalStream(),o.info("[WebRTC-API] createAnswer start"),n.rtcPeerConnection.createAnswer().then(function(t){o.debug("[WebRTC-API] _____________________Answer "),t.type="answer";var i=new a(t.sdp),r=i.parseMsidSemantic(i.headerSection),s=i.parseSSRC(i.audioSection),c=i.parseSSRC(i.videoSection);i.updateAudioSSRCSection(1e3,"CHROME0000",r.WMS,s.label),i.updateVideoSSRCSection(2e3,"CHROME0000",r.WMS,c.label),t.sdp=i.getUpdatedSDP(),n.answerDescription=t,o.debug("[WebRTC-API] Answer "),o.debug("[WebRTC-API] setLocalDescription start"),n.rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){var i=new a(t.sdp);i.updateHeaderMsidSemantic("MS_0000"),i.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),i.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=i.getUpdatedSDP(),o.debug("[WebRTC-API] Send Answer "),(e||n.onCreateAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},close:function(){var e=this;try{e.rtcPeerConnection&&e.rtcPeerConnection.close()}catch(t){}e.localStream&&e.localStream.getTracks().forEach(function(e){e.stop()}),e.localStream=null},addIceCandidate:function(e){var t=this;if(t.rtcPeerConnection){o.debug("[WebRTC-API] Add ICE candidate: \n",e);var n=i.isArray(e)?e:[];!i.isArray(e)&&n.push(e);for(var r=0;r<n.length;r++)e=n[r],t.rtcPeerConnection.addIceCandidate(new RTCIceCandidate(e)).then(t.onAddIceCandidateSuccess,t.onAddIceCandidateError)}},setRemoteDescription:function(e){var t=this;return o.debug("[WebRTC-API] setRemoteDescription start. "),e=new RTCSessionDescription(e),t.rtcPeerConnection.setRemoteDescription(e).then(t.onSetRemoteSuccess,t.onSetSessionDescriptionError)},iceConnectionState:function(){var e=this;return e.rtcPeerConnection.iceConnectionState},onCreateMedia:function(){o.debug("[WebRTC-API] media created.")},_onGotRemoteStream:function(e){o.debug("[WebRTC-API] onGotRemoteStream.",e),this.onGotRemoteStream(e.stream),o.debug("[WebRTC-API] received remote stream, you will see the other.")},onGotStream:function(e){o.debug("[WebRTC-API] on got a local stream")},onSetRemoteSuccess:function(){o.info("[WebRTC-API] onSetRemoteSuccess complete")},onSetLocalSuccess:function(){o.info("[WebRTC-API] setLocalDescription complete")},onAddIceCandidateSuccess:function(){o.debug("[WebRTC-API] addIceCandidate success")},onAddIceCandidateError:function(e){o.debug("[WebRTC-API] failed to add ICE Candidate: "+e.toString())},onIceCandidate:function(e){o.debug("[WebRTC-API] onIceCandidate : ICE candidate: \n"+e.candidate)},onIceStateChange:function(e){o.debug("[WebRTC-API] onIceStateChange : ICE state change event: ",e)},onCreateSessionDescriptionError:function(e){o.error("[WebRTC-API] Failed to create session description: "+e.toString())},onCreateOfferSuccess:function(e){o.debug("[WebRTC-API] create offer success")},onCreatePRAnswerSuccess:function(e){o.debug("[WebRTC-API] create answer success")},onCreateAnswerSuccess:function(e){o.debug("[WebRTC-API] create answer success")},onSetSessionDescriptionError:function(e){o.error("[WebRTC-API] onSetSessionDescriptionError : Failed to set session description: "+e.toString())},onSetLocalSessionDescriptionSuccess:function(){o.debug("[WebRTC-API] onSetLocalSessionDescriptionSuccess : setLocalDescription complete")}};e.exports=function(e){i.extend(!0,this,s,e||{})}},235:function(e,t,n){"use strict";var i=n(230),o=n(233).RouteTo,r=i.logger,a=o({success:function(e){r.debug("iq to server success",e)},fail:function(e){r.debug("iq to server error",e)}}),s={_pingIntervalId:null,_p2pConfig:null,_rtcCfg:null,_rtcCfg2:null,_rtKey:null,_rtFlag:null,webRtc:null,api:null,callee:null,consult:!1,init:function(){var e=this;e.api.onPing=function(){e._onPing.apply(e,arguments)},e.api.onTcklC=function(){e._onTcklC.apply(e,arguments)},e.api.onAcptC=function(){e._onAcptC.apply(e,arguments)},e.api.onAnsC=function(){e._onAnsC.apply(e,arguments)},e.api.onTermC=function(){e._onTermC.apply(e,arguments)},e.webRtc.onIceCandidate=function(){e._onIceCandidate.apply(e,arguments)},e.webRtc.onIceStateChange=function(){e._onIceStateChange.apply(e,arguments)}},_ping:function(){function e(){var e=new a({to:t.callee,rtKey:t._rtKey});t.api.ping(e,t._sessId,function(e,t){r.debug("ping result",t)})}var t=this;t._pingIntervalId=window.setInterval(e,59e3)},_onPing:function(e,t,n,i,o){r.debug("_onPing from",o)},initC:function(e,t){var n=this;n.sid=t,n.createLocalMedia(e)},createLocalMedia:function(e){var t=this;t.consult=!1,this.webRtc.createMedia(e,function(e,n){e.setLocalVideoSrcObject(n),t.webRtc.createRtcPeerConnection(t._rtcCfg),t.webRtc.createOffer(function(e){t._onGotWebRtcOffer(e),t._onHandShake()})})},_onGotWebRtcOffer:function(e){var t=this,n=new a({sid:t.sid,to:t.callee,rtKey:t._rtKey});t.api.initC(n,null,null,t._sessId,t._rtcId,null,null,e,null,t._rtcCfg2,null,function(e,t){r.debug("initc result",t)}),t._ping()},_onAcptC:function(e,t){var n=this;t.ans&&1==t.ans&&(r.info("[WebRTC-API] _onAcptC : 104, ans = 1, it is a answer. will onAcceptCall"),n.onAcceptCall(e,t),n._onAnsC(e,t)),WebIM.WebRTC.supportPRAnswer?(r.info("[WebRTC-API] _onAcptC : recv pranswer. "),(t.sdp||t.cands)&&(t.sdp&&n.webRtc.setRemoteDescription(t.sdp),t.cands&&n._onTcklC(e,t),n.onAcceptCall(e,t))):(r.info("[WebRTC-API] _onAcptC : not supported pranswer. drop it. will onAcceptCall"),n.onAcceptCall(e,t))},onAcceptCall:function(e,t){},_onAnsC:function(e,t){var n=this;r.info("[WebRTC-API] _onAnsC : recv answer. "),t.sdp&&n.webRtc.setRemoteDescription(t.sdp),t.cands&&n._onTcklC(e,t)},_onInitC:function(e,t,n,i,o){var a=this;a.consult=!1,a.callee=e,a._rtcCfg2=t.rtcCfg,a._rtKey=n,a._tsxId=i,a._fromSid=o,a._rtcId=t.rtcId,a._sessId=t.sessId,a.webRtc.createRtcPeerConnection(a._rtcCfg2),t.cands&&a._onTcklC(e,t),t.sdp&&a.webRtc.setRemoteDescription(t.sdp).then(function(){a._onHandShake(e,t),WebIM.WebRTC.supportPRAnswer?a.webRtc.createPRAnswer(function(e){a._onGotWebRtcPRAnswer(e),setTimeout(function(){r.info("[WebRTC-API] onRinging : after send pranswer. ",a.callee),a.onRinging(a.callee)},500)}):(setTimeout(function(){r.info("[WebRTC-API] onRinging : After iniC, cause by: not supported pranswer. ",a.callee),a.onRinging(a.callee)},500),a._ping())})},_onGotWebRtcPRAnswer:function(e){var t=this,n=new a({to:t.callee,rtKey:t._rtKey});t.api.acptC(n,t._sessId,t._rtcId,e),t._ping()},onRinging:function(e){},accept:function(){function e(){r.info("createAndSendAnswer : ...... "),t.webRtc.createAnswer(function(e){var n=new a({to:t.callee,rtKey:t._rtKey});WebIM.WebRTC.supportPRAnswer?t.api.ansC(n,t._sessId,t._rtcId,e):t.api.acptC(n,t._sessId,t._rtcId,e,null,1)})}var t=this;t.webRtc.createMedia(function(t,n){t.setLocalVideoSrcObject(n),e()})},_onHandShake:function(e,t){var n=this;n.consult=!0,r.info("hand shake over. may switch cands."),t&&setTimeout(function(){n._onTcklC(e,t)},100),setTimeout(function(){n._onIceCandidate()},100)},_onTcklC:function(e,t){var n=this;if(n.consult)r.info("[WebRTC-API] recv and add cands."),n._recvCands&&n._recvCands.length>0&&n.webRtc.addIceCandidate(n._recvCands),t&&t.cands&&n.webRtc.addIceCandidate(t.cands);else if(t&&t.cands&&t.cands.length>0){for(var i=0;i<t.cands.length;i++)(n._recvCands||(n._recvCands=[])).push(t.cands[i]);r.debug("[_onTcklC] temporary memory[recv] ice candidate. util consult = true")}},_onIceStateChange:function(e){var t=this;e&&r.debug("[WebRTC-API] "+t.webRtc.iceConnectionState()+" |||| ice state is "+e.target.iceConnectionState),t.api.onIceConnectionStateChange(t.webRtc.iceConnectionState())},_onIceCandidate:function(e){var t=this;if(t.consult){var n=function(e){r.debug("send ice candidate...");var n=new a({to:t.callee,rtKey:t._rtKey});e&&t.api.tcklC(n,t._sessId,t._rtcId,null,e)};t._cands&&t._cands.length>0&&(n(t._cands),t._cands=[]),e&&e.candidate&&n(e.candidate)}else e&&e.candidate&&(t._cands||(t._cands=[])).push(e.candidate),r.debug("[_onIceCandidate] temporary memory[send] ice candidate. util consult = true")},termCall:function(e){var t=this;t._pingIntervalId&&window.clearInterval(t._pingIntervalId);var n=new a({to:t.callee,rtKey:t._rtKey});t.hangup||t.api.termC(n,t._sessId,t._rtcId,e),t.webRtc.close(),t.hangup=!0,t.onTermCall(e)},_onTermC:function(e,t){var n=this;n.hangup=!0,n.termCall(t.reason)},onTermCall:function(){}};e.exports=function(e){var t=this;i.extend(!0,this,s,e||{}),t.init()}}}),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;for(n=0>n?Math.ceil(n):Math.floor(n),0>n&&(n+=t);t>n;n++)if(n in this&&this[n]===e)return n;return-1}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,i;if(null===this)throw new TypeError("this is null or not defined");var o=Object(this),r=o.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),i=0;r>i;){var a;i in o&&(a=o[i],e.call(n,a,i,o)),i++}}),function(e){"use strict";e.console||(e.console={});for(var t,n,i=e.console,o=function(){},r=["memory"],a="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profiles,profileEnd,show,table,time,timeEnd,timeline,timelineEnd,timeStamp,trace,warn".split(",");t=r.pop();)i[t]||(i[t]={});for(;n=a.pop();)i[n]||(i[n]=o)}("undefined"==typeof window?this:window),function(){function e(e){var t=Object.prototype.toString.call(e);return"object"==typeof e&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(t)&&"number"==typeof e.length&&(0===e.length||"object"==typeof e[0]&&e[0].nodeType>0)}function t(e,t){i(e,t)||(e.className+=" "+t)}function n(e,t){i(e,t)&&(e.className=(" "+e.className+" ").replace(new RegExp(" "+t+" ","g")," ").trim())}function i(e,t){return!!~(" "+e.className+" ").indexOf(" "+t+" ")}function o(t,n){if("function"==typeof n){var i,o,r,a=e(t)?t:[t],s=[];for(i=2,o=arguments.length;o>i;++i)s.push(arguments[i]);for(i=0,o=a.length;o>i;++i)(r=a[i])&&n.apply(null,[r].concat(s))}}function r(e,t,n,i){e.addEventListener?e.addEventListener(t,n,i):e.attachEvent&&(e["_"+t]=function(){n.apply(e,arguments)},e.attachEvent("on"+t,e["_"+t]))}function a(e,t,n){var i="_"+t,o="on"+t;e.removeEventListener&&n?e.removeEventListener(t,n):e.detachEvent&&(e.detachEvent(o,e[i]),delete e[i])}function s(e,t){if(e){var n,i,o=document.createElement("div"),r=document.createDocumentFragment();for(o.innerHTML=t,n=o.childNodes,i=n[0];n.length>0;)r.appendChild(n[0]);return e.appendChild(r),i}}window.easemobim=window.easemobim||{};var c=/mobile/i.test(navigator.userAgent),u=/Trident\/4\.0/.test(navigator.userAgent);easemobim.utils={isTop:window.top===window.self,isNodeList:e,isAndroid:/android/i.test(navigator.userAgent),isQQBrowser:/MQQBrowser/i.test(navigator.userAgent),isIOS:/(iPad|iPhone|iPod)/i.test(navigator.userAgent),isMobile:c,click:c&&"ontouchstart"in window?"touchstart":"click",isBrowserMinimized:function(){return"hidden"===document.visibilityState||document.hidden},appendHTMLTo:s,appendHTMLToBody:function(e){return s(document.body,e)},createElementFromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes[0]},addCssRules:function(e){var t=document.createElement("style");return u?(t.setAttribute("type","text/css"),t.styleSheet.cssText=e,void document.querySelector("head").appendChild(t)):(t.styleSheet?t.styleSheet.cssText=e:t.appendChild(document.createTextNode(e)),void document.head.appendChild(t))},getBrief:function(e,t){return"string"!=typeof e?"":e.length>t?e.slice(0,t)+"...":e},formatDate:function(e,t){var n=e?new Date(e):new Date,i=t||"Md hh:mm",o={"M+":n.getMonth()+1,"d+":n.getDate(),"h+":n.getHours(),"m+":n.getMinutes(),"s+":n.getSeconds()};/(y+)/.test(i)&&(i=i.replace(RegExp.$1,(n.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in o)new RegExp("("+r+")").test(i)&&(i=i.replace(RegExp.$1,1===RegExp.$1.length?o[r]:("00"+o[r]).substr((""+o[r]).length)));return i},filesizeFormat:function(e){var t,n,i=["B","KB","MB","GB","TB","PB","EB","ZB"];return e>0?(t=Math.floor(Math.log(e)/Math.log(1024)),n=(e/Math.pow(1024,t)).toFixed(2)+" "+i[t]):n=0===e?"0 B":"",n},uuid:function(){for(var e=[],t="0123456789abcdef",n=0;36>n;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},convertFalse:function(e){return e="undefined"==typeof e?"":e,"false"===e?!1:e},removeDom:function(e){e&&(e.remove?e.remove():e.parentNode&&e.parentNode.removeChild(e))},live:function(e,t,n,i){var o=this,r=i||document;o.on(r,t,function(t){var i,o,a,s=t||window.event,c=s.target||s.srcElement,u=c.parentNode,d=r.querySelectorAll(e);for(i=0,o=d.length;o>i;++i)a=d[i],a===c?n.call(c,s):a===u&&n.call(u,s)})},on:function(e,t,n,i){t.split(" ").forEach(function(t){t&&o(e,r,t,n,i)})},off:function(e,t,n){t.split(" ").forEach(function(t){t&&o(e,a,t,n)})},one:function(e,t,n,i){if(e&&t){var o=function(){n.apply(this,arguments),a(e,t,o)};r(e,t,o,i)}},trigger:function(e,t){if(document.createEvent){var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!1),e.dispatchEvent(n)}else e.fireEvent("on"+t)},extend:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n],o=Object.prototype.toString.call(i);void 0===i?e[n]=i:"[object Array]"===o?(e[n]=[],this.extend(e[n],i)):"[object Object]"===o?(e[n]={},this.extend(e[n],i)):e[n]=i}return e},addClass:function(e,n){return o(e,t,n),e},removeClass:function(e,t){return o(e,n,t),e},hasClass:function(e,t){return e?i(e,t):!1},toggleClass:function(e,o,r){if(e&&o){var a="undefined"==typeof r?!i(e,o):r;a?t(e,o):n(e,o)}},getDataByPath:function(e,t){function n(){var e=i.shift();return"string"!=typeof e?o:"object"==typeof o&&null!==o?(o=o[e],n()):void 0}var i=t.split("."),o=e;return n()},query:function(e){var t=new RegExp("[?&]"+e+"=([^&]*)(?=&|$)"),n=t.exec(location.search);return n?n[1]:""},setStore:function(e,t){try{localStorage.setItem(e,t)}catch(n){}},getStore:function(e){try{return localStorage.getItem(e)}catch(t){}},clearStore:function(e){try{localStorage.removeItem(e)}catch(t){}},clearAllStore:function(){try{localStorage.clear()}catch(e){}},set:function(e,t,n){var i=new Date,o=i.getTime()+24*(n||30)*3600*1e3;i.setTime(o),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+";path=/;expires="+i.toGMTString()},get:function(e){var t=document.cookie.match("(^|;) ?"+encodeURIComponent(e)+"=([^;]*)(;|$)");return t?decodeURIComponent(t[2]):""},getAvatarsFullPath:function(e,t){if(e){e=e.replace(/^(https?:)?\/\/?/,"");var n=~e.indexOf("img-cn"),i=~e.indexOf("ossimages");return n&&!i?t+"/ossimages/"+e:"//"+e}},copy:function(e){return this.extend({},e)}}}(),easemobim._const=function(){return{loadingSvg:['<div class="em-widget-loading">','<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70">','<circle opacity=".3" fill="none" stroke="#000" stroke-width="4" stroke-miterlimit="10" cx="35" cy="35" r="11"/>','<path fill="none" stroke="#E5E5E5" stroke-width="4" stroke-linecap="round" stroke-miterlimit="10" d="M24 35c0-6.1 4.9-11 11-11 2.8 0 5.3 1 7.3 2.8"/>',"</svg>","</div>"].join(""),agentStatusText:{Idle:"()",Online:"()",Busy:"()",Leave:"()",Hidden:"()",Offline:"()",Logout:"()",Other:""},eventMessageText:{NOTE:""},SYSTEM_EVENT_MSG_TEXT:{ServiceSessionCreatedEvent:"",ServiceSessionClosedEvent:"",ServiceSessionTransferedEvent:"",ServiceSessionTransferedToAgentQueueEvent:"",ServiceSessionOpenedEvent:""},SYSTEM_EVENT:{SESSION_CREATED:"ServiceSessionCreatedEvent",SESSION_OPENED:"ServiceSessionOpenedEvent",SESSION_CLOSED:"ServiceSessionClosedEvent",SESSION_TRANSFERED:"ServiceSessionTransferedEvent",SESSION_TRANSFERING:"ServiceSessionTransferedToAgentQueueEvent",SESSION_RESTORED:"session.restored",SESSION_NOT_CREATED:"session.not.created",AGENT_INFO_UPDATE:"agent.info.update",OFFICIAL_ACCOUNT_SWITCHED:"official.account.switched",NEW_OFFICIAL_ACCOUNT_FOUND:"new.official.account.found",SYSTEM_OFFICIAL_ACCOUNT_UPDATED:"system.official.account.updated",OFFICIAL_ACCOUNT_LIST_GOT:"official.account.list.got",MARKETING_MESSAGE_RECEIVED:"marketing.message.received",SATISFACTION_EVALUATION_MESSAGE_RECEIVED:"satisfaction.evaluation.message.received",CHAT_WINDOW_OPENED:"chat.window.opened",CHAT_WINDOW_CLOSED:"chat.window.closed",MESSAGE_SENT:"message.sent",MESSAGE_APPENDED:"message.appended",block:null},themeMap:{"":"theme-1","":"theme-2","":"theme-3","":"theme-4","":"theme-5","":"theme-6","":"theme-7","":"theme-8","":"theme-9","":"theme-10"},IM:{WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31},EVENTS:{NOTIFY:"notify",RECOVERY:"recoveryTitle",SHOW:"showChat",CLOSE:"closeChat",CACHEUSER:"setUser",DRAGREADY:"dragReady",DRAGEND:"dragEnd",SLIDE:"titleSlide",ONMESSAGE:"onMessage",ONSESSIONCLOSED:"onSessionClosed",EXT:"ext",TEXTMSG:"textmsg",ONREADY:"onready",ON_OFFDUTY:"onOffDuty",SET_ITEM:"setItem",UPDATE_URL:"updateURL",REQUIRE_URL:"requireURL",INIT_CONFIG:"initConfig",SHOW_IMG:"showIMG",RESIZE_IFRAME:"resizeIframe",ADD_PROMPT:"add.prompt",REMOVE_PROMPT:"remove.prompt",block:null},GRAY_LIST_KEYS:["audioVideo","msgPredictEnable","waitListNumberEnable","agentInputStateEnable"],ERROR_MSG:{VISITOR_DOES_NOT_EXIST:"visitor does not exist.",SESSION_DOES_NOT_EXIST:"session does not exist.",block:null},SESSION_STATE:{WAIT:"Wait",PROCESSING:"Processing",TERMINAL:"Terminal",ABORT:"Abort",RESOLVED:"Resolved",PREPARE:"Prepare"},AGENT_ROLE:{AGENT:1,ROBOT:6},UPLOAD_FILESIZE_LIMIT:10485760,FIRST_CHANNEL_MESSAGE_TIMEOUT:1e4,FIRST_CHANNEL_IMG_MESSAGE_TIMEOUT:15e3,SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT:1,FIRST_CHANNEL_CONNECTION_TIMEOUT:2e4,HEART_BEAT_INTERVAL:6e4,SECOND_CHANNEL_MESSAGE_RECEIVE_INTERVAL:6e4,MESSAGE_PREDICT_MAX_LENGTH:100,MAX_TEXT_MESSAGE_LENGTH:1500,GET_HISTORY_MESSAGE_COUNT_EACH_TIME:10,AGENT_INPUT_STATE_INTERVAL:1e3,MESSAGE_TIME_SPAN_INTERVAL:6e4,for_block_only:null}}(),window.easemobim=window.easemobim||{},window.easemobim.emajax=function(){var e=function(){},t=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},n=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}};return function(i){function o(){var e,t=d.status||0;if(4===d.readyState){if(200===t){if("text"===a)return void s(d.responseText,d);if("json"===a){try{e=JSON.parse(d.responseText),s(e,d)}catch(n){}return}return void s(d.response||d.responseText,d)}if("json"==a){try{e=JSON.parse(d.responseText),c(e,d,"")}catch(n){c(d.responseText,d,"")}return}return void c(d.responseText,d,"")}0===d.readyState&&c(d.responseText,d,"")}var r,a=i.dataType||"text",s=i.success||e,c=i.error||e,u=i.useXDomainRequestInIE,d=t()||n(),l=i.type||"GET",p=i.data||{},f="",m=i.headers||{},g=i.isFileUpload;if(u&&window.XDomainRequest)return d=new XDomainRequest,d.onload=function(){var e={};try{e=JSON.parse(d.responseText)}catch(t){}s(e,d)},d.ontimeout=function(){c(d.responseText,d,"XDomainRequest timeout.")},d.onerror=function(){c(d.responseText,d,"XDomainRequest error.")},d.open("POST",i.url),d.send(JSON.stringify(p)),d;if(d.onreadystatechange=o,"get"===l.toLowerCase()){for(var h in p)p.hasOwnProperty(h)&&(f+=h+"="+p[h]+"&");f=f?f.slice(0,-1):f,i.url+=(i.url.indexOf("?")>0?"&":"?")+(f?f+"&":f)+"_v="+(new Date).getTime()}else{if(g){var v=new FormData;return v.append("file",p.file),d.open("POST",i.url),d.setRequestHeader("Authorization",p.auth),d.send(v),d}p=JSON.stringify(p)}if(d.open(l,i.url),d.setRequestHeader){m["Content-Type"]=m["Content-Type"]||"application/json";for(r in m)m.hasOwnProperty(r)&&d.setRequestHeader(r,m[r])}return d.send(p),d}}(),window.easemobim=window.easemobim||{},window.easemobIM=window.easemobIM||{},easemobIM.Transfer=easemobim.Transfer=function(){"use strict";var e=function(){var e=!0;try{window.postMessage({toString:function(){e=!1}},"*")}catch(t){}return e}(),t=function(e,t,n){var i,o,r,a=!1,s=e.data;if("object"==typeof s)i=s;else if("string"==typeof s){try{i=JSON.parse(s)}catch(c){}if("object"!=typeof i)return}if(n&&n.length)for(o=0,r=n.length;r>o;o++)i.key===n[o]&&(a=!0,"function"==typeof t&&t(i));else"function"==typeof t&&t(i);if(!a&&n)for(o=0,r=n.length;r>o;o++)if("data"===n[o]){"function"==typeof t&&t(i);break}},n=function(e,t,i){return this instanceof n?(this.key=t,this.iframe=document.getElementById(e),this.origin=location.protocol+"//"+location.host,void(this.useObject=i)):new n(e)};return n.prototype.send=function(t,n){return t.origin=this.origin,t.key=this.key,this.to?t.to=this.to:n&&(t.to=n),e&&(this.useObject||t.useObject)||(t=JSON.stringify(t)),this.iframe?this.iframe.contentWindow.postMessage(t,"*"):window.parent.postMessage(t,"*"),this},n.prototype.listen=function(e,n){var i=this;return window.addEventListener?window.addEventListener("message",function(o){t.call(i,o,e,n)},!1):window.attachEvent&&window.attachEvent("onmessage",function(o){t.call(i,o,e,n)}),this},n}(),window.app={},app.Dict=function(){var e=function(){this.list={}};return e.prototype.set=function(e,t){"undefined"==typeof this.list[e]&&(this.list[e]=t)},e.prototype.get=function(e){return this.list.hasOwnProperty(e)?this.list[e]:null},e.prototype.remove=function(e){"undefined"!=typeof this.list[e]&&delete this.list[e]},e}(),app.List=function(){var e=function(){this.list=[]};return e.prototype.add=function(e){~this.list.indexOf(e)||this.list.push(e)},e.prototype.remove=function(e){var t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)},e.prototype.getAll=function(){return this.list},e.prototype.getLength=function(){return this.list.length},e.prototype.removeAll=function(){this.list.length=0},e}(),app.Poller=function(){var e=function(e,t){this.fn=e,this.isStarted=!1,this.timerHandler=null,this.interval=t};return e.prototype.start=function(){this.isStarted||(this.isStarted=!0,setTimeout(this.fn,0),this.timerHandler=setInterval(this.fn,this.interval))},e.prototype.stop=function(){this.isStarted&&(this.isStarted=!1,clearInterval(this.timerHandler))},e.prototype.isStarted=function(){return this.isStarted},e}(),app.retryThrottle=function(e,t){if("function"!=typeof e)throw"unexpect type of fn.";var n=t||{},i=_.now(),o=n.retryLimit||3,r=n.resetTime||6e5,a=n.waitTime||3e3,s=0,c=_.throttle(e,a);return function(){_.now()-i<r?o>s&&(s++,c()):(i=_.now(),s=1,c())}},app.eventListener=function(){function e(e,t){n[e]||(n[e]=[]),n[e].push(t)}function t(e,t){t.push(e),_.each(n[e],function(e){e.apply(null,t)})}var n={};return{add:e,excuteCallbacks:t}}(),app.profile={ctaEnable:!1,systemAgentAvatar:null,isChatWindowOpen:null,isAgentNicknameEnable:null,currentBrowsingURL:null,isInOfficeHours:!1,imgFileList:new app.Dict,hasHumanAgentOnline:!1,hasRobotAgentOnline:!1,officialAccountList:[],commandMessageToBeSendList:[],tenantAvatar:null,defaultAvatar:null,currentOfficialAccount:{},systemOfficialAccount:{}},app.uikit=function(e){function t(t){c.innerText=t,e.removeClass(s,"hide")}function n(){e.addClass(s,"hide")}function i(e){t(e),setTimeout(n,2e3)}function o(t){function n(){e.addClass(m,"hide")}function i(){e.removeClass(m,"hide")}function o(){e.toggle(m,"hide")}function r(){d(),n()}function s(){l()||n()}t=t||{};var c,u,d,l,p=t.className,f=t.contentDom||"",m=e.createElementFromHTML('<div class="em-dialog hide"></div>');return p&&e.addClass(m,p),"string"==typeof f&&(f=e.createElementFromHTML(f)),f&&m.appendChild(f),document.body.appendChild(m),{addButton:function(t){t=t||{};var n=t.hideCancel,i=t.confirmText||"";d=t.cancel||a,l=t.confirm||a;var o=e.createElementFromHTML(['<div class="footer">','<button class="cancel-btn"></button>','<button class="confirm-btn bg-color"></button>',"</div>"].join(""));return c=o.querySelector(".cancel-btn"),u=o.querySelector(".confirm-btn"),u.innerText=i,n&&e.addClass(c,"hide"),m.appendChild(o),e.on(c,"click",r),e.on(u,"click",s),this},show:function(){return i(),this},hide:function(){return n(),this},toggle:function(){return o(),this},destroy:function(){e.off(c,"click",r),e.off(u,"click",s),e.removeDom(m)},el:m}}function r(t){var n=e.createElementFromHTML(["<div>",'<i class="icon-circle"><i class="icon-good"></i></i>',"<p></p>","</div>"].join(""));n.querySelector("p").innerText=t;var i=o({contentDom:n,className:"mini em-success-prompt"}).show();setTimeout(i.destroy,2e3)}var a=function(){},s=document.querySelector(".em-widget-error-prompt"),c=s.querySelector("span");return{prompt:t,tip:i,createDialog:o,showSuccess:r}}(easemobim.utils),app.genDomFromMsg=function(e,t,n,i){function o(e){if(!e||0===e.length)return"";var t="";return t=e.replace(/&amp;/g,"&"),t=t.replace(/<(?=[^o][^)])/g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/\"/g,"&quot;")}function r(e){return"string"!=typeof e?"":e.replace(/&amp;/g,"&").replace(/&#39;/g,"'").replace(/&lt;/g,"<")}function a(e){var t=e.type,n=e.data,i="";switch(t){case"txt":n=o(r(n)),i="<pre>"+d(l(n))+"</pre>";break;case"emoji":i="<pre>"+_.map(n,function(e){var t,n=e.type,i=e.data;return"txt"===n?t=d(i):"emoji"===n&&(t='<img class="emoji" src="'+i+'">'),t}).join("")+"</pre>";break;case"img":i='<a href="javascript:;"><img class="em-widget-imgview" src="'+e.url+'"/></a>';break;case"list":i="<p>"+d(o(n))+"</p>"+e.list;break;case"file":i='<i class="icon-attachment container-icon-attachment"></i><span class="file-info"><p class="filename">'+e.filename+'</p><p class="filesize">'+easemobim.utils.filesizeFormat(e.fileLength)+"</p></span><a target='_blank' href='"+e.url+"' class='icon-download container-icon-download' title='"+e.filename+"'></a>";break;default:throw"unexpected value type."}return i}function s(e){var t,o=n.getDataByPath(e,"ext.weichat.official_account.type"),r=n.getDataByPath(e,"ext.weichat.official_account.img"),a=n.getDataByPath(e,"fromUser.img"),s=i.systemAgentAvatar;return t="CUSTOM"===o?r:i.isAgentNicknameEnable?a||s:i.tenantAvatar||i.defaultAvatar,t||i.tenantAvatar||i.defaultAvatar}function c(e,t,n){var i=e.id,o=e.type,r="",c=document.createElement("div"),d=t?"left":"right";return c.className="em-widget-"+d,i&&(c.id=i),"left"===d&&(r+='<img class="avatar" src="'+s(e)+'">'),r+='<div class="em-widget-msg-wrapper">',r+='<i class="icon-corner-'+d+'"></i>',t||n||!i||(r+='<div id="'+i+'_failed" data-type="'+o+'" class="em-widget-msg-status hide"><span></span><i class="icon-circle"><i class="icon-exclamation"></i></i></div><div id="'+i+'_loading" class="em-widget-msg-loading">'+u+"</div>"),r+='<div class="em-widget-msg-container em-widget-msg-'+o+'">',r+=a(e),r+="</div>",r+="</div>",c.innerHTML=r,c}var u=Modernizr.inlinesvg?t.loadingSvg:'<img src="//kefu.easemob.com/webim/static/img/loading.gif" width="20" style="margin-top:10px;"/>',d=WebIM.utils.parseLink,l=WebIM.utils.parseEmoji;return c}(window,easemobim._const,easemobim.utils,app.profile),app.apiHelper=function(e,t,n){function i(){q=new easemobim.Transfer("cross-origin-iframe","data",!0),
q.listen(function(e){var t,n,i,o=e.call,r=e.timespan,a=0===e.status;Y[o]&&Y[o][r]&&(t=Y[o][r],delete Y[o][r],n=t.success,i=t.error,a?"function"==typeof n&&n(e):"function"==typeof i&&i(e))},["api"])}function o(e,n,i,o){var r=t.uuid();Y[e]=Y[e]||{},Y[e][r]={success:i,error:o},q.send({api:e,data:n,timespan:r,useObject:!0})}function r(){return new Promise(function(e,t){o("getCurrentServiceSession",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,imServiceNumber:H.toUser,id:H.user.username},function(t){e(t.data)},function(e){t(e)})})}function a(){return new Promise(function(e,t){var i=H.user.token;i?e(i):n({url:location.protocol+"//"+H.restServer+"/"+H.orgName+"/"+H.appName+"/token",useXDomainRequestInIE:!0,dataType:"json",data:{grant_type:"password",username:H.user.username,password:H.user.password},type:"POST",success:function(t){var n=t.access_token;H.user.token=n,e(n)},error:function(e){t(e)}})})}function s(){return new Promise(function(e,n){H.isWebChannelConfig?e(H.notice):o("getSlogan",{tenantId:H.tenantId},function(n){var i=t.getDataByPath(n,"data.0.optionValue"),o={enabled:!!i,content:i};e(o)},function(e){n(e)})})}function c(){return new Promise(function(e,n){H.isWebChannelConfig?e(H.themeName):o("getTheme",{tenantId:H.tenantId},function(n){var i=t.getDataByPath(n,"data.0.optionValue");e(i)},function(e){n(e)})})}function u(e){return new Promise(function(n,i){o("getConfig",{configId:e},function(e){var i=t.getDataByPath(e,"data.entity");n(i)},function(e){i(e)})})}function d(){return new Promise(function(e,n){V.projectId?e(V.projectId):a().then(function(i){o("getProject",{tenantId:H.tenantId,"easemob-target-username":H.toUser,"easemob-appkey":H.appKey.replace("#","%23"),"easemob-username":H.user.username,headers:{Authorization:"Easemob IM "+i}},function(i){var o=t.getDataByPath(i,"data.entities.0.id");o?(V.projectId=o,e(o)):n("no project id exist.")},function(e){n(e)})})})}function l(e){e.data;return new Promise(function(n,i){o("createTicket",{tenantId:H.tenantId,"easemob-target-username":H.toUser,"easemob-appkey":H.appKey.replace("#","%23"),"easemob-username":H.user.username,origin_type:"webim",headers:{Authorization:"Easemob IM "+e.token},projectId:e.projectId,subject:"",content:e.content,status_id:"",priority_id:"",category_id:"",creator:{name:e.name,avatar:"",email:e.mail,phone:e.phone,qq:"",company:"",description:""},attachments:null},function(e){isSending=!1,t.getDataByPath(e,"data.id")?n():i("unknown errow.")},function(e){i(e)})})}function p(){return new Promise(function(n,i){V.visitorId?n(V.visitorId):a().then(function(r){o("getVisitorInfo",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,userName:H.user.username,imServiceNumber:H.toUser,token:r},function(o){var r=t.getDataByPath(o,"data.entity.userId");r?(V.visitorId=r,n(r)):i(e.ERROR_MSG.VISITOR_DOES_NOT_EXIST)},function(e){i(e)})})})}function f(){return new Promise(function(e,n){Promise.all([p(),a()]).then(function(i){var r=i[0],a=i[1];o("getOfficalAccounts",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,userName:H.user.username,visitorId:r,token:a},function(n){var i=t.getDataByPath(n,"data.entities");_.isArray(i)?e(i):(e([]),console.error("unexpect data format: ",i))},function(e){n(e)})})["catch"](function(e){n(e)})})}function m(n,i){return new Promise(function(r,s){Promise.all([p(),a()]).then(function(a){var c=a[0],u=a[1];o("getOfficalAccountMessage",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,userName:H.user.username,token:u,visitorId:c,officialAccountId:n,direction:"before",size:e.GET_HISTORY_MESSAGE_COUNT_EACH_TIME,startId:i},function(e){var n=t.getDataByPath(e,"data.entities");_.isArray(n)?r(n):s("unexpect data format.")},function(e){s(e)})})["catch"](function(e){s(e)})})}function g(){return new Promise(function(e,n){o("getDutyStatus_2",{channelType:"easemob",originType:"webim",channelId:H.channelId,tenantId:H.tenantId,queueName:H.emgroup,agentUsername:H.agentName},function(n){e(!t.getDataByPath(n,"data.entity"))},function(t){console.error("unable to get duty state: ",t),e(!0)})})}function h(){return new Promise(function(t,n){o("graylist",{},function(n){var i={},o=n.data||{};_.each(e.GRAY_LIST_KEYS,function(e){i[e]=_.contains(o[e],+H.tenantId)}),t(i)},function(e){console.error("unable to get gray list: ",e),t({})})})}function v(){return new Promise(function(e,t){o("getRobertGreeting_2",{channelType:"easemob",originType:"webim",channelId:H.channelId,tenantId:H.tenantId,agentUsername:H.agentName,queueName:H.emgroup},function(t){e(t.data.entity||{})},function(e){t(e)})})}function y(){return new Promise(function(e,t){"boolean"==typeof V.isRobotOpen?e(V.isRobotOpen):o("getRobertIsOpen",{channelType:"easemob",originType:"webim",channelId:H.channelId,tenantId:H.tenantId,agentUsername:H.agentName,queueName:H.emgroup},function(t){var n=t.data.entity;V.isRobotOpen=n,e(n)},function(e){t(e)})})}function E(){return new Promise(function(e,t){o("getSystemGreeting",{tenantId:H.tenantId},function(t){e(t.data)},function(e){t(e)})})}function S(){return new Promise(function(e,n){o("getExSession_2",{username:H.user.username,orgName:H.orgName,appName:H.appName,imServiceNumber:H.toUser,channelType:"easemob",originType:"webim",channelId:H.channelId,queueName:H.emgroup,agentUsername:H.agentName,tenantId:H.tenantId},function(i){var o=t.getDataByPath(i,"data.entity");o?e(o):n("unexpected data format.")},function(e){n(e)})})}function T(e){return new Promise(function(n,i){return H.user.token?void o("getAgentStatus",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,agentUserId:e,userName:H.user.username,token:H.user.token,imServiceNumber:H.toUser},function(e){n(t.getDataByPath(e,"data.state"))},function(e){i(e)}):void n()})}function C(n){return new Promise(function(i,r){Promise.all([p(),a()]).then(function(a){var s=a[0],c=a[1];o("getLastSession",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,imServiceNumber:H.toUser,officialAccountId:n,userName:H.user.username,visitorId:s,token:c},function(n){var o=t.getDataByPath(n,"data.entity");o?i(o):r(e.ERROR_MSG.SESSION_DOES_NOT_EXIST)},function(e){r(e)})})["catch"](function(e){r(e)})})}function I(){return new Promise(function(e,n){o("getSkillgroupMenu",{tenantId:H.tenantId},function(n){e(t.getDataByPath(n,"data.entities.0"))},function(e){n(e)})})}function b(e){return new Promise(function(t,n){a().then(function(i){o("reportVisitorAttributes",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,imServiceNumber:H.toUser,sessionId:e,userName:H.user.username,referer:document.referrer,token:i},function(e){t()},function(e){n(e)})})})}function N(e,t){return new Promise(function(n,i){Promise.all([p(),a()]).then(function(r){var a=r[0],s=r[1];o("messagePredict_2",{sessionId:e,visitor_user_id:a,content:t,timestamp:_.now(),orgName:H.orgName,appName:H.appName,userName:H.user.username,imServiceNumber:H.toUser,token:s},function(e){n()},function(e){i(e)})})})}function O(e){return new Promise(function(t,n){a().then(function(i){o("getAgentInputState",{username:H.user.username,orgName:H.orgName,appName:H.appName,tenantId:H.tenantId,serviceSessionId:e,token:i},function(e){t(e.data.entity)},function(e){n(e)})})})}function R(e,t){return new Promise(function(n,i){o("getWaitListNumber",{tenantId:H.tenantId,queueId:t,serviceSessionId:e},function(e){n(e.data.entity)},function(e){i(e)})})}function w(){return new Promise(function(e,n){o("getNickNameOption",{tenantId:H.tenantId},function(n){var i=t.getDataByPath(n,"data.0.optionValue");e("true"===i)},function(e){n(e)})})}function M(e){return new Promise(function(t,n){a().then(function(i){o("closeServiceSession",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,userName:H.user.username,token:H.user.token,serviceSessionId:e},function(e){t()},function(e){n(e)})})})}function x(){return new Promise(function(e,t){o("createVisitor",{orgName:H.orgName,appName:H.appName,imServiceNumber:H.toUser,tenantId:H.tenantId},function(t){e(t.data)},function(e){t(e)})})}function A(){return new Promise(function(e,t){o("getPassword",{userId:H.user.username,tenantId:H.tenantId},function(n){var i=n.data;i?e(i):t("unable to get password.")},function(e){t(e)})})}function k(){return new Promise(function(e,t){o("getRelevanceList",{tenantId:H.tenantId},function(n){var i=n.data;_.isArray(i)&&!_.isEmpty(i)?e(i):t("")},function(e){t(e)})})}function P(e){return new Promise(function(t,n){o("deleteEvent",{userId:e},function(e){t()},function(e){n(e)})})}function D(e,t,n){return new Promise(function(i,r){o("reportEvent",{type:"VISIT_URL",tenantId:H.tenantId,url:e,userId:{type:t,id:n}},function(e){var t=e.data;t?i(t):r("unexpected resopnse data.")},function(e){r(e)})})}function L(){return new Promise(function(e,n){o("receiveMsgChannel",{orgName:H.orgName,appName:H.appName,easemobId:H.toUser,tenantId:H.tenantId,visitorEasemobId:H.user.username},function(i){var o=t.getDataByPath(i,"data.status"),r=t.getDataByPath(i,"data.entities");"OK"===o?e(r):n("unexpected response data.")},function(e){n(e)})})}function B(e,t){return new Promise(function(n,i){o("sendMsgChannel",{from:H.user.username,to:H.toUser,tenantId:H.tenantId,bodies:[e],ext:t,orgName:H.orgName,appName:H.appName,originType:"webim"},function(e){n(e.data)},function(e){i(e)})})}function U(e){return new Promise(function(t,n){a().then(function(i){o("uploadImgMsgChannel",{userName:H.user.username,tenantId:H.tenantId,file:e,auth:"Bearer "+i,orgName:H.orgName,appName:H.appName},function(e){t(e.data)},function(e){n(e)})})})}function W(e){return new Promise(function(n,i){Promise.all([p(),a()]).then(function(r){var a=r[0],s=r[1];o("reportMarketingTaskDelivered",{marketingTaskId:e,tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,userName:H.user.username,token:s,visitor_id:a},function(e){var o=t.getDataByPath(e,"data.status");"OK"===o?n():i("unexpected reaponse status."),n(e.data)},function(e){i(e)})})})}function j(e){return new Promise(function(n,i){Promise.all([p(),a()]).then(function(r){var a=r[0],s=r[1];o("reportMarketingTaskOpened",{marketingTaskId:e,tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,userName:H.user.username,token:s,visitor_id:a},function(e){var o=t.getDataByPath(e,"data.status");"OK"===o?n():i("unexpected reaponse status."),n(e.data)},function(e){i(e)})})})}function F(e){return new Promise(function(n,i){Promise.all([p(),a()]).then(function(r){var a=r[0],s=r[1];o("reportMarketingTaskReplied",{marketingTaskId:e,tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,userName:H.user.username,token:s,visitor_id:a},function(e){var o=t.getDataByPath(e,"data.status");"OK"===o?n():i("unexpected reaponse status."),n(e.data)},function(e){i(e)})})})}function G(e){return new Promise(function(n,i){a().then(function(r){o("getLatestMarketingTask",{tenantId:H.tenantId,orgName:H.orgName,appName:H.appName,officialAccountId:e,userName:H.user.username,token:r},function(e){var i=t.getDataByPath(e,"data.entity");n(i)},function(e){i(e)})})})}var H,q,V={},Y={};return{getCurrentServiceSession:r,getToken:a,getNotice:s,getTheme:c,getConfig:u,getProjectId:d,createTicket:l,getVisitorId:p,getOfficalAccounts:f,getOfficalAccountMessage:m,getDutyStatus:g,getGrayList:h,getRobertGreeting:v,getRobertIsOpen:y,getSystemGreeting:E,getExSession:S,getAgentStatus:T,getLastSession:C,getSkillgroupMenu:I,reportVisitorAttributes:b,reportPredictMessage:N,getAgentInputState:O,getWaitListNumber:R,getNickNameOption:w,closeServiceSession:M,createVisitor:x,getPassword:A,getRelevanceList:k,deleteEvent:P,reportEvent:D,receiveMsgChannel:L,sendMsgChannel:B,uploadImgMsgChannel:U,reportMarketingTaskDelivered:W,reportMarketingTaskOpened:j,reportMarketingTaskReplied:F,getLatestMarketingTask:G,initApiTransfer:i,api:o,setCacheItem:function(e,t){V[e]=t},clearCacheItem:function(e){V[e]=void 0},init:function(e){H=e}}}(easemobim._const,easemobim.utils,easemobim.emajax),app.channel=function(e,t,n,i,o,r,a,s){"strict";function c(n){var i=setTimeout(function(){n()},e.FIRST_CHANNEL_CONNECTION_TIMEOUT);B=new WebIM.connection({url:L.xmppServer,retry:!0,isMultiLoginSessions:L.resources,heartBeatWait:e.HEART_BEAT_INTERVAL}),B.listen({onOpened:function(e){clearTimeout(i),D=e.accessToken,B.setPresence(),n(e)},onTextMessage:function(e){m(e,"txt")},onEmojiMessage:function(e){m(e,"emoji")},onPictureMessage:function(e){m(e,"img")},onFileMessage:function(e){m(e,"file")},onCmdMessage:function(e){m(e,"cmd")},onOnline:function(){t.isMobile&&G()},onOffline:function(){t.isMobile&&B.close(),Modernizr.peerconnection&&app.videoChat.onOffline()},onError:function(t){t.reconnect?G():t.type===e.IM.WEBIM_CONNCTION_AUTH_ERROR?G():t.type===e.IM.WEBIM_CONNCTION_CALLBACK_INNER_ERROR?console.error(t.data):console.error(t)}}),G()}function u(e,t){if(t)switch(e){case"txt":O(t,0);break;default:B.send(t)}}function d(n,i){var o=t.uuid(),a=new WebIM.message.txt(o);a.set({msg:n,to:L.toUser,success:function(e){},fail:function(e){}}),i&&_.extend(a.body,i),E(a),y(a,o),B.send(a.body),j.set(o,a),M(o),n&&(b({id:o,type:"txt",data:n},{isReceived:!1,isHistory:!1}),S({hasTransferedToKefu:""===n||""===n}),r.excuteCallbacks(e.SYSTEM_EVENT.MESSAGE_SENT,[]))}function l(n,i){var o=t.uuid(),a=new WebIM.message.cmd(o);a.set({to:L.toUser,action:"TransferToKf",ext:{weichat:{ctrlArgs:{id:n,serviceSessionId:i}}}}),y(a,o),B.send(a.body),j.set(o,a),M(o),S({hasTransferedToKefu:!0}),r.excuteCallbacks(e.SYSTEM_EVENT.MESSAGE_SENT,[])}function p(n,i){var o=t.uuid(),a=new WebIM.message.img(o);i&&(i.value=""),a.set({apiUrl:location.protocol+"//"+L.restServer,file:n,accessToken:D,to:L.toUser,uploadError:function(e){var n=e.id,i=document.getElementById(n+"_loading"),o=document.querySelector("#"+n+" .em-widget-msg-container");o&&(o.innerHTML='<i class="icon-broken-pic"></i>'),t.addClass(i,"hide")},success:function(e){v(e)},fail:function(e){h(e)}}),E(a),y(a,o),b({id:o,type:"img",url:n.url},{isReceived:!1,isHistory:!1}),B.send(a.body),j.set(o,a),x(o,n.data),s.imgFileList.set(n.url,n.data),r.excuteCallbacks(e.SYSTEM_EVENT.MESSAGE_SENT,[])}function f(n,i){var o=t.uuid(),a=new WebIM.message.file(o);i&&(i.value=""),a.set({apiUrl:location.protocol+"//"+L.restServer,file:n,to:L.toUser,uploadError:function(e){var n=e.id,i=document.getElementById(n+"_loading"),o=document.querySelector("#"+n+" .em-widget-msg-container");o&&(o.innerHTML='<i class="icon-broken-pic"></i>'),t.addClass(i,"hide")},success:function(e){v(e)},fail:function(e){h(e)}}),E(a),b({id:o,type:"file",url:n.url,filename:n.filename,fileLength:n.data.size},{isReceived:!1,isHistory:!1}),B.send(a.body),r.excuteCallbacks(e.SYSTEM_EVENT.MESSAGE_SENT,[])}function m(n,i,o){var a,s,c,u,d=i||n&&n.type,l=t.getDataByPath(n,"ext.weichat.event.eventName"),p=t.getDataByPath(n,"ext.weichat.event.eventObj"),f=t.getDataByPath(n,"ext.weichat.msgId"),m=!n.from||n.from.toLowerCase()!==L.user.username.toLowerCase(),g=t.getDataByPath(n,"ext.weichat.official_account"),h=t.getDataByPath(n,"ext.weichat.marketing.marketing_task_id"),v=g&&g.official_account_id;if(!F.get(f)&&(f&&F.set(f,n),o||!n.from||n.from.toLowerCase()==L.toUser.toLowerCase()||n.noprompt)){switch(g&&N(g),u=I(v),"inviteEnquiry"===t.getDataByPath(n,"ext.weichat.ctrlType")?d="satisfactionEvaluation":m&&t.getDataByPath(n,"ext.msgtype.choice")?d="robotList":"TransferToKfHint"===t.getDataByPath(n,"ext.weichat.ctrlType")?d="robotTransfer":"ServiceSessionWillScheduleTimeoutEvent"===l&&p&&"true"===p.ticketEnable&&(d="transferToTicket"),d){case"txt":a=n,a.type=d,a.brief=a.data.replace(/\n/gm," ");break;case"emoji":a=n,a.type=d,a.brief=_.map(a.data,function(e){return"emoji"===e.type?"[]":e.data}).join("").replace(/\n/gm," ");break;case"img":a=n,a.type=d,a.brief="[]";break;case"file":a=n,a.type=d,a.brief="[]";break;case"cmd":var y=n.action;if("KF-ACK"===y)return void w(n.ext.weichat.ack_for_msg_id);if("KEFU_MESSAGE_RECALL"===y){var E=n.ext.weichat.recall_msg_id,S=document.getElementById(E);t.addClass(S,"hide")}break;case"satisfactionEvaluation":s=n.ext.weichat.ctrlArgs.inviteId,c=n.ext.weichat.ctrlArgs.serviceSessionId,a=n,a.type="list",a.data="",a.list=['<div class="em-btn-list"><button class="bg-hover-color js_satisfybtn" data-inviteid="'+s+'" data-servicesessionid="'+c+'"></button></div>'],a.brief="[]",!o&&r.excuteCallbacks(e.SYSTEM_EVENT.SATISFACTION_EVALUATION_MESSAGE_RECEIVED,[u,s,c]);break;case"robotList":a=n,a.type="list",a.list='<div class="em-btn-list">'+_.map(n.ext.msgtype.choice.items,function(e){var t=e.id,n=e.name,i="js_robotbtn ";return i+="TransferToKf"===e.id?"white bg-color border-color bg-hover-color-dark":"bg-hover-color",'<button class="'+i+'" data-id="'+t+'">'+n+"</button>"}).join("")||"</div>",a.data=n.ext.msgtype.choice.title,a.brief="[]";break;case"skillgroupMenu":a=n,a.type="list",a.list='<div class="em-btn-list">'+_.map(n.data.children,function(e){var t=e.queueName,n=e.menuName,i="js_skillgroupbtn bg-hover-color";return'<button class="'+i+'" data-queue-name="'+t+'">'+n+"</button>"}).join("")||"</div>",a.data=n.data.menuName,a.brief="[]";break;case"robotTransfer":var C=n.ext.weichat.ctrlArgs;a=n,a.type="list",a.data=a.data||t.getDataByPath(n,"ext.weichat.ctrlArgs.label"),a.list=['<div class="em-btn-list">','<button class="white bg-color border-color bg-hover-color-dark js_robotTransferBtn" ','data-sessionid="'+C.serviceSessionId+'" ','data-id="'+C.id+'">'+C.label+"</button>","</div>"].join(""),a.brief="[]";break;case"transferToTicket":a=n,a.type="list",a.list=['<div class="em-btn-list">','<button class="white bg-color border-color bg-hover-color-dark js-transfer-to-ticket">',"","</button>","</div>"].join(""),a.brief="[]";break;default:console.error("unexpected msg type")}if(!o)if(h&&"txt"===d&&r.excuteCallbacks(e.SYSTEM_EVENT.MARKETING_MESSAGE_RECEIVED,[u,h,n]),l)T(l,p,n);else{var O=t.getDataByPath(n,"ext.weichat.agent");O&&(u.agentNickname=O.userNickname,u.agentAvatar=O.avatar,r.excuteCallbacks(e.SYSTEM_EVENT.AGENT_INFO_UPDATE,[u]))}a&&("txt"!==d||a.data)&&(a.id=f,b(a,{isReceived:m,isHistory:o,officialAccount:u,timestamp:n.timestamp}),o||(n.noprompt||A(a,u),a.value=a.data,transfer.send({event:e.EVENTS.ONMESSAGE,data:{from:n.from,to:n.to,message:a}})))}}function g(e){var n,i=e.body||{},o=t.getDataByPath(i,"bodies.0")||{},r=o.url,a=moment(e.created_at,"YYYY-MM-DDTHH:mm:ss.SSSZZ").valueOf();return i.from!==L.user.username&&(n=o.file_length),r&&!/^https?/.test(r)&&(r=location.protocol+L.domain+r),{data:o.msg,url:r,filename:o.filename,action:o.action,type:o.type,msgId:e.msg_id,fromUser:e.from_user,timestamp:a,fileLength:n,ext:i.ext,to:i.to,from:i.from}}function h(e){t.addClass(document.getElementById(e+"_loading"),"hide"),t.removeClass(document.getElementById(e+"_failed"),"hide")}function v(e){t.addClass(document.getElementById(e+"_loading"),"hide"),t.addClass(document.getElementById(e+"_failed"),"hide")}function y(e,t){e.body.ext.weichat.msg_id_for_ack=t}function E(e){var t=s.currentOfficialAccount||s.systemOfficialAccount,n=t.official_account_id,i=t.bindAgentUsername,o=t.bindSkillGroupName;e.body.ext=e.body.ext||{},e.body.ext.weichat=e.body.ext.weichat||{},o?e.body.ext.weichat.queueName=o:L.emgroup&&(e.body.ext.weichat.queueName=L.emgroup),_.isEmpty(L.visitor)||(e.body.ext.weichat.visitor=L.visitor),i?e.body.ext.weichat.agentUsername=i:L.agentName&&(e.body.ext.weichat.agentUsername=L.agentName),L.grUserId&&(e.body.ext.weichat.visitor=e.body.ext.weichat.visitor||{},e.body.ext.weichat.visitor.gr_user_id=L.grUserId),"default"!==n&&(e.body.ext.weichat.official_account={official_account_id:n})}function S(t){var n=t&&t.hasTransferedToKefu,i=t&&t.officialAccountId,o=I(i),r=o.sessionState,a=n?s.hasHumanAgentOnline:s.hasHumanAgentOnline||s.hasRobotAgentOnline;a||k||r===e.SESSION_STATE.PROCESSING||(k=!0,C(e.eventMessageText.NOTE,{ext:{weichat:{official_account:o}}}))}function T(n,i,o){var a=e.SYSTEM_EVENT_MSG_TEXT[n],s=t.getDataByPath(o,"ext.weichat.official_account.official_account_id"),c=I(s);switch(a&&C(a,o),n){case e.SYSTEM_EVENT.SESSION_TRANSFERED:c.agentId=i.userId,c.agentType=i.agentType,c.agentAvatar=i.avatar,c.agentNickname=i.agentUserNiceName,c.sessionState=e.SESSION_STATE.PROCESSING,c.isSessionOpen=!0;break;case e.SYSTEM_EVENT.SESSION_TRANSFERING:c.sessionState=e.SESSION_STATE.WAIT,c.isSessionOpen=!0,c.skillGroupId=null;break;case e.SYSTEM_EVENT.SESSION_CLOSED:c.sessionState=e.SESSION_STATE.ABORT,c.agentId=null,c.sessionId=null,c.skillGroupId=null,c.isSessionOpen=!1,c.hasReportedAttributes=!1,transfer.send({event:e.EVENTS.ONSESSIONCLOSED});break;case e.SYSTEM_EVENT.SESSION_OPENED:c.sessionState=e.SESSION_STATE.PROCESSING,c.agentType=i.agentType,c.agentId=i.userId,c.sessionId=i.sessionId,c.agentAvatar=i.avatar,c.agentNickname=i.agentUserNiceName,c.isSessionOpen=!0;break;case e.SYSTEM_EVENT.SESSION_CREATED:c.sessionState=e.SESSION_STATE.WAIT,c.sessionId=i.sessionId,c.isSessionOpen=!0}r.excuteCallbacks(n,[c]),S({officialAccountId:s})}function C(e,n){if(!L.hideStatus){var i=t.getDataByPath(n,"ext.weichat.official_account.official_account_id"),o=I(i);o.messageView.appendEventMsg(e)}}function I(e){return e?_.findWhere(s.officialAccountList,{official_account_id:e}):s.systemOfficialAccount}function b(t,n){var i=n||{},o=i.isReceived,a=i.isHistory,c=i.officialAccount||s.currentOfficialAccount||s.systemOfficialAccount;c.messageView.appendMsg(t,i),!o||a||t.noprompt||r.excuteCallbacks(e.SYSTEM_EVENT.MESSAGE_APPENDED,[c,t])}function N(t){var i=t.official_account_id,o=_.findWhere(s.officialAccountList,{official_account_id:i});if(!o){var a=t.type,c=t.img,u=t.name,d={official_account_id:i,type:a,img:c,name:u};if("SYSTEM"===a)_.isEmpty(s.systemOfficialAccount)?(s.systemOfficialAccount=d,s.officialAccountList.push(d),d.unopenedMarketingTaskIdList=new n,d.unrepliedMarketingTaskIdList=new n,d.unreadMessageIdList=new n,r.excuteCallbacks(e.SYSTEM_EVENT.NEW_OFFICIAL_ACCOUNT_FOUND,[d])):s.systemOfficialAccount.official_account_id!==i&&(s.systemOfficialAccount.official_account_id=i,s.systemOfficialAccount.img=c,s.systemOfficialAccount.name=u,r.excuteCallbacks(e.SYSTEM_EVENT.SYSTEM_OFFICIAL_ACCOUNT_UPDATED,[]));else{if("CUSTOM"!==a)throw"unexpected official_account type.";s.ctaEnable=!0,s.officialAccountList.push(d),d.unopenedMarketingTaskIdList=new n,d.unrepliedMarketingTaskIdList=new n,d.unreadMessageIdList=new n,r.excuteCallbacks(e.SYSTEM_EVENT.NEW_OFFICIAL_ACCOUNT_FOUND,[d])}}}function O(n,i){var r=j.get(n),a=t.getDataByPath(r,"body.body"),s=t.getDataByPath(r,"body.ext"),c="number"==typeof i?i:e.SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT;o.sendMsgChannel(a,s).then(function(){w(n)},function(){c>0?O(n,--c):h(n)})}function R(t,n,i){var r=j.get(t),a="number"==typeof i?i:e.SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT;o.uploadImgMsgChannel(n).then(function(e){r.body.body={filename:e.fileName,type:"img",url:e.url},O(t,0)},function(){a>0?R(r,n,--a):h(t)})}function w(e){clearTimeout(W.get(e)),W.remove(e),v(e),j.remove(e)}function M(t){W.set(t,setTimeout(function(){O(t)},e.FIRST_CHANNEL_MESSAGE_TIMEOUT))}function x(t,n){W.set(t,setTimeout(function(){R(t,n)},e.FIRST_CHANNEL_IMG_MESSAGE_TIMEOUT))}function A(n,i){if(!t.isTop){var o=i.type,r=t.getBrief(n.brief,15),a="CUSTOM"===o?i.img:s.systemAgentAvatar||s.tenantAvatar||s.defaultAvatar;(t.isBrowserMinimized()||!s.isChatWindowOpen)&&(U.playSound(),transfer.send({event:e.EVENTS.SLIDE}),transfer.send({event:e.EVENTS.NOTIFY,data:{avatar:a,title:"",brief:r}}))}}var k,P,D,L,B,U,W=new i,j=new i,F=new i,G=a(function(){var e={user:L.user.username,appKey:L.appKey,apiUrl:location.protocol+"//"+L.restServer};L.user.token?e.accessToken=L.user.token:e.pwd=L.user.password,B.open(e),Modernizr.peerconnection&&s.grayList.audioVideo&&app.videoChat.init(B)},{resetTime:6e5,waitTime:2e3,retryLimit:3}),H={init:function(){L=s.config,U=app.chat},initConnection:c,reSend:u,sendTransferToKf:l,sendText:d,sendImg:p,sendFile:f,attemptToAppendOfficialAccount:N,handleHistoryMsg:function(e){m(g(e),null,!0)},initSecondChannle:function(){P=clearInterval(P),P=setInterval(function(){o.receiveMsgChannel().then(function(e){_.each(e,function(e){m(g({body:e}),null,!1)})})},e.SECOND_CHANNEL_MESSAGE_RECEIVE_INTERVAL)},handleMessage:m};return H}(easemobim._const,easemobim.utils,app.List,app.Dict,app.apiHelper,app.eventListener,app.retryThrottle,app.profile),app.createSessionList=function(e,t,n,i,o,r){function a(e,t,n){var i=g.get(e),o=i.querySelector(".latest-message"),r=i.querySelector(".latest-timestamp");r.innerText=n,o.innerText=t,p.insertBefore(i,p.firstChild)}function s(e,n){var i=g.get(e),o=i.querySelector(".unread-count");n&&"number"==typeof n?n>99?(o.innerText="...",t.removeClass(o,"hide")):(o.innerText=n,t.removeClass(o,"hide")):t.addClass(o,"hide")}function c(e,t){var n=e.official_account_id,i=d(e),o=g.get(t);p.replaceChild(i,o),g.set(n,i),g.remove(t)}function u(e){var t=e.official_account_id,n=d(e);p.appendChild(n),g.set(t,n)}function d(e){var n=e.name,i=e.official_account_id,r=e.img||o.defaultAvatar;return t.createElementFromHTML(['<li class="session-item" data-id="'+i+'">','<img class="avatar" src="'+r+'">','<span class="name">'+n+"</span>",'<span class="latest-message"></span>','<span class="latest-timestamp"></span>','<span class="unread-count hide"></span>',"</li>"].join(""))}var l,p,f,m=function(){},g=new n;return function(e){var n=e||{};return f=n.itemOnClickCallback||m,l=i.createDialog({className:"session-list",contentDom:"<ul></ul>"}),p=l.el.querySelector("ul"),t.live("li.session-item","click",function(){var e=this.getAttribute("data-id");f(e),l.hide()},p),{appendItem:u,updateItem:c,updateLatestMessage:a,updateUnreadCount:s,show:l.show}}}(easemobim._const,easemobim.utils,app.Dict,app.uikit,app.profile,app.eventListener),app.createMessageView=function(e,t,n,i,o,r,a){var s='<div class="chat-container hide"></div>',c=document.querySelector(".chat-wrapper");return function(i){function u(e){return _.map(b.slice(0,e),function(e){var n=t.formatDate(e.date),i=e.isReceived?"":"",o=e.msg.brief;return"["+n+"] "+i+"\n"+o}).join("\n")}function d(e){p(),t.appendHTMLTo(S,['<div class="em-widget-event">',"<span>"+e+"</span>","</div>"].join("")),g()}function l(e,n){var i=n||{},o=i.isReceived,r=i.isHistory,a=i.timestamp||_.now(),s=app.genDomFromMsg(e,o,r),c=s.querySelector(".em-widget-imgview");r?(S.insertBefore(s,S.firstChild),p(a,r)):(p(a,r),c?(S.appendChild(s),g(),t.one(c,"load",function(){g()})):(S.appendChild(s),g()));var u={isReceived:o,msg:e,date:a};r?b.push(u):b.unshift(u)}function p(n,i){var o=t.createElementFromHTML(['<div class="em-widget-date">',"<span>"+t.formatDate(n)+"</span>","</div>"].join("")),r=n||_.now();i?C-r>e.MESSAGE_TIME_SPAN_INTERVAL&&S.insertBefore(o,S.firstChild):r-I>e.MESSAGE_TIME_SPAN_INTERVAL&&S.appendChild(o),C>r&&(C=r),r>I&&(I=r)}function f(t){y||o.getOfficalAccountMessage(E.official_account_id,T).then(function(n){var i=n.length,o=n[i-1]||{},a=o.id;T=a,y=i<e.GET_HISTORY_MESSAGE_COUNT_EACH_TIME||0>=a,_.each(n,r.handleHistoryMsg),"function"==typeof t&&t()})}function m(){var e,i,o;t.isMobile?(t.live("div.em-widget-date","touchstart",function(e){i=t.getDataByPath(e,"touches.0.pageY")},S),t.live("div.em-widget-date","touchmove",function(n){o=t.getDataByPath(n,"touches.0.pageY"),o-i>8&&this.getBoundingClientRect().top>=0&&(clearTimeout(e),e=setTimeout(function(){f()},100))},S)):t.on(S,"mousewheel DOMMouseScroll",function(t){if(E===n.currentOfficialAccount){var i=this;(t.wheelDelta/120>0||t.detail<0)&&(clearTimeout(e),e=setTimeout(function(){i.getBoundingClientRect().top>=0&&f()},400))}})}function g(){c.scrollTop=c.scrollHeight-c.offsetHeight+9999}function h(){t.addClass(S,"hide")}function v(){t.removeClass(S,"hide")}var y,E=i.officialAccount,S=t.createElementFromHTML(s),T=0,C=new Date(2099,0).getTime(),I=new Date(1970,0).getTime(),b=[];return c.appendChild(S),a.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_LIST_GOT,function(){var t=E.official_account_id;f(g),m(),o.getLastSession(t).then(function(t){E.agentId=t.agent_id,E.sessionId=t.session_id,E.sessionState=t.state,E.agentType=t.agent_type,E.skillGroupId=t.skill_group_id,E.isSessionOpen=t.state===e.SESSION_STATE.PROCESSING||t.state===e.SESSION_STATE.WAIT,a.excuteCallbacks(e.SYSTEM_EVENT.SESSION_RESTORED,[E])},function(t){if(t!==e.ERROR_MSG.SESSION_DOES_NOT_EXIST)throw t;a.excuteCallbacks(e.SYSTEM_EVENT.SESSION_NOT_CREATED,[E])})}),{show:v,hide:h,scrollToBottom:g,appendMsg:l,appendEventMsg:d,getRecentMsg:u,el:S}}}(easemobim._const,easemobim.utils,app.profile,app.uikit,app.apiHelper,app.channel,app.eventListener),app.promptCtaDialog=function(e,t,n,i,o){function r(){t.off(p,"click",u),t.off(f,"click",c)}function a(){p=l.querySelector(".btn-close"),f=l.querySelector(".btn-reply"),t.on(p,"click",u),t.on(f,"click",c)}function s(){t.addClass(l,"hide")}function c(){s(),m(h)}function u(){s(),g(h)}function d(e){var n=e||{},i=n.avatar||"",o=n.title||"",r=n.content||"",a=n.className||"";return t.createElementFromHTML(['<div class="em-dialog '+a+'">','<span class="indicator bg-border-bottom-color"></span>','<div class="bg-color header">','<img class="avatar" src="'+i+'">','<span class="title">'+o+"</span>",'<span class="btn-close icon-close"></span>',"</div>",'<div class="body">','<p class="content">'+r+"</p>","</div>",'<div class="footer">','<button class="btn-reply bg-color icon-message"></button>',"</div>","</div>"].join(""))}var l,p,f,m,g,h,v=function(){};return function(e){var t=e||{},n=d(t);return m=t.replyCallback||v,g=t.closeCallback||v,h=t.callbackMessage||null,l?(r(),document.body.replaceChild(n,l)):document.body.appendChild(n),l=n,a(),{hide:s}}}(easemobim._const,easemobim.utils,app.Dict,app.uikit,app.profile),app.initAgentStatePoller=function(e,t,n,i,o){function r(i){if(i===n.currentOfficialAccount&&i&&n.isChatWindowOpen&&!t.isBrowserMinimized()){var r=i.agentId,s=i.agentType,c=i.isSessionOpen;s===e.AGENT_ROLE.ROBOT?a("Online"):n.isAgentNicknameEnable&&r&&c?o.getAgentStatus(r).then(function(e){i.agentState=e,a(e)}):a(null)}}function a(t){var n=e.agentStatusText[t||"Other"];s.innerText=n}var s,c;return function(){var t=document.querySelector(".em-widget-header");s=t.querySelector(".em-header-status-text"),c=setInterval(function(){var e=n.currentOfficialAccount;r(e)},5e3),i.add(e.SYSTEM_EVENT.SESSION_OPENED,r),i.add(e.SYSTEM_EVENT.SESSION_TRANSFERED,r),i.add(e.SYSTEM_EVENT.SESSION_CLOSED,r),i.add(e.SYSTEM_EVENT.SESSION_TRANSFERING,r),i.add(e.SYSTEM_EVENT.SESSION_RESTORED,r),i.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,function(e){a(e.status)})}}(easemobim._const,easemobim.utils,app.profile,app.eventListener,app.apiHelper),app.initAgentInputStatePoller=function(e,t,n,i,o){function r(o){if(o===n.currentOfficialAccount&&o&&n.isChatWindowOpen&&!t.isBrowserMinimized()){var r=o.sessionState,a=o.sessionId,u=o.agentType;a&&r===e.SESSION_STATE.PROCESSING&&u!==e.AGENT_ROLE.ROBOT?i.getAgentInputState(a).then(function(e){var n=e.timestamp,i=e.input_state_tips;n>c&&(c=n,t.toggleClass(s,"hide",!i))}):t.addClass(s,"hide")}}var a,s,c=0;return function(){if(n.grayList.agentInputStateEnable){var t=document.querySelector(".em-widget-header");s=t.querySelector(".em-agent-input-state"),a=setInterval(function(){var e=n.currentOfficialAccount;r(e)},e.AGENT_INPUT_STATE_INTERVAL),o.add(e.SYSTEM_EVENT.SESSION_OPENED,r),o.add(e.SYSTEM_EVENT.SESSION_CLOSED,r),o.add(e.SYSTEM_EVENT.SESSION_TRANSFERED,r),o.add(e.SYSTEM_EVENT.SESSION_RESTORED,r),o.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,r)}}}(easemobim._const,easemobim.utils,app.profile,app.apiHelper,app.eventListener),app.initTransferToKefuButton=function(e,t,n,i,o){function r(i){if(n.currentOfficialAccount===i){var r=i.sessionState,s=i.agentType,c=i.type,u=s===e.AGENT_ROLE.ROBOT;"CUSTOM"===c?t.addClass(a,"hide"):r===e.SESSION_STATE.PROCESSING?t.toggleClass(a,"hide",!u):o.getRobertIsOpen().then(function(e){t.toggleClass(a,"hide",!e)})}}var a;return function(){if(n.config.toolbar.transferToKefu){var o=document.querySelector(".em-widget-send-wrapper");toKefuBtn=o.querySelector(".em-widget-to-kefu"),t.on(a,"click",function(){channel.sendTransferToKf(),t.addClass(a,"hide")}),i.add(e.SYSTEM_EVENT.SESSION_OPENED,r),
i.add(e.SYSTEM_EVENT.SESSION_TRANSFERED,r),i.add(e.SYSTEM_EVENT.SESSION_RESTORED,r),i.add(e.SYSTEM_EVENT.SESSION_NOT_CREATED,r),i.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,r)}}}(easemobim._const,easemobim.utils,app.profile,app.eventListener,app.apiHelper),app.initQueuingNumberPoller=function(e,t,n,i,o){function r(i){if(i===n.currentOfficialAccount&&i&&n.isChatWindowOpen&&!t.isBrowserMinimized()){var r=i.sessionState,s=i.skillGroupId,c=i.sessionId,u=i.official_account_id;r===e.SESSION_STATE.WAIT&&c?s?o.getWaitListNumber(c,s).then(function(e){var t=e.visitorUserWaitingNumber,n=e.visitorUserWaitingTimestamp;n>d&&(d=n,a(t))}):o.getLastSession(u).then(function(e){i.skillGroupId=e.skill_group_id}):a(null)}}function a(e){e&&"no"!==e?(t.removeClass(c,"hide"),u.innerHTML=e):t.addClass(c,"hide")}var s,c,u,d=0;return function(){if(n.grayList.waitListNumberEnable){var t=document.querySelector(".em-widget-send-wrapper");c=t.querySelector(".queuing-number-status"),u=c.querySelector("label"),s=setInterval(function(){var e=n.currentOfficialAccount;r(e)},1e3),i.add(e.SYSTEM_EVENT.SESSION_OPENED,r),i.add(e.SYSTEM_EVENT.SESSION_CLOSED,r),i.add(e.SYSTEM_EVENT.SESSION_TRANSFERED,r),i.add(e.SYSTEM_EVENT.SESSION_CREATED,r),i.add(e.SYSTEM_EVENT.SESSION_RESTORED,r),i.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,r)}}}(easemobim._const,easemobim.utils,app.profile,app.eventListener,app.apiHelper),app.initAgentNicknameUpdate=function(e,t,n,i){function o(e){if(e===n.currentOfficialAccount){var i=e.agentNickname,o=e.agentAvatar,a=e.isSessionOpen,s=e.type;"SYSTEM"===s&&(n.systemAgentAvatar=a?t.getAvatarsFullPath(o,n.config.domain):null),"CUSTOM"===s?r.innerText=e.name:n.isAgentNicknameEnable&&i&&a&&""!==i?r.innerText=i:r.innerText=n.defaultAgentName}}var r;return function(){var t=document.querySelector(".em-widget-header");r=t.querySelector(".em-widget-header-nickname"),i.add(e.SYSTEM_EVENT.SESSION_OPENED,o),i.add(e.SYSTEM_EVENT.SESSION_TRANSFERED,o),i.add(e.SYSTEM_EVENT.SESSION_TRANSFERING,o),i.add(e.SYSTEM_EVENT.SESSION_CLOSED,o),i.add(e.SYSTEM_EVENT.AGENT_INFO_UPDATE,o),i.add(e.SYSTEM_EVENT.SESSION_RESTORED,o),i.add(e.SYSTEM_EVENT.SESSION_NOT_CREATED,o),i.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,o)}}(easemobim._const,easemobim.utils,app.profile,app.eventListener),app.initSessionList=function(e,t,n,i,o,r,a,s){function c(){var e=_.chain(n.officialAccountList).map(function(e){return e.unreadMessageIdList.getLength()}).reduce(function(e,t){return e+t}).value(),i=!!e;t.toggleClass(v,"hide",!i)}function u(e){var t=e.official_account_id;e.unreadMessageIdList.removeAll(),y.updateUnreadCount(t,null),c()}function d(e){if("SYSTEM"!==e.type&&!e.hasGotMarketingInfo){var n=e.official_account_id;e.hasGotMarketingInfo=!0,o.getLatestMarketingTask(n).then(function(n){e.bindSkillGroupName=t.getDataByPath(n,"schedule_info.skillgroup_name"),e.bindAgentUsername=t.getDataByPath(n,"schedule_info.agent_username")})}}function l(e){_.each(e.unrepliedMarketingTaskIdList.getAll(),function(t){e.unrepliedMarketingTaskIdList.remove(t),o.reportMarketingTaskReplied(t)})}function p(e){_.each(e.unopenedMarketingTaskIdList.getAll(),function(t){e.unopenedMarketingTaskIdList.remove(t),o.reportMarketingTaskOpened(t)})}function f(e,i,r){var a=e.img,c=e.official_account_id,u=r.data,d=t.getDataByPath(r,"ext.weichat.marketing.name"),l=t.getDataByPath(r,"ext.weichat.marketing.schedule_info")||{};e.bindSkillGroupName=l.skillgroup_name,e.bindAgentUsername=l.agent_username,e.hasGotMarketingInfo=!0,e!==n.currentOfficialAccount&&n.currentOfficialAccount&&(S=s({title:d,replyCallback:m,content:u,avatar:a,className:"cta-prompt",callbackMessage:c})),n.isChatWindowOpen&&e===n.currentOfficialAccount?o.reportMarketingTaskOpened(i):e.unopenedMarketingTaskIdList.add(i),e.unrepliedMarketingTaskIdList.add(i),o.reportMarketingTaskDelivered(i)}function m(t){var o=_.findWhere(n.officialAccountList,{official_account_id:t});_.each(n.officialAccountList,function(e){e.messageView.hide()}),o.messageView.show(),n.currentOfficialAccount=o,i.excuteCallbacks(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,[o])}function g(e){var i=e.type;e.messageView=a({officialAccount:e}),y||(y=r({itemOnClickCallback:m}),t.on(h,"click",function(){y.show(),S&&S.hide(),n.currentOfficialAccount=null,t.addClass(E,"hide")})),y.appendItem(e),"CUSTOM"===i&&t.removeClass(h,"hide")}var h,v,y,E,S;return function(){var o=document.querySelector(".em-widget-header");h=o.querySelector(".session-list-btn"),v=h.querySelector(".notice"),E=o.querySelector(".status-bar"),i.add(e.SYSTEM_EVENT.MESSAGE_SENT,function(){var e=n.currentOfficialAccount;e&&l(e)}),i.add(e.SYSTEM_EVENT.MARKETING_MESSAGE_RECEIVED,f),i.add(e.SYSTEM_EVENT.NEW_OFFICIAL_ACCOUNT_FOUND,g),i.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,function(e){e.messageView.scrollToBottom(),t.removeClass(E,"hide"),d(e),p(e),u(e)}),i.add(e.SYSTEM_EVENT.CHAT_WINDOW_OPENED,function(){var e=n.currentOfficialAccount;_.isEmpty(e)||(e.messageView.scrollToBottom(),p(e),u(e))}),i.add(e.SYSTEM_EVENT.SYSTEM_OFFICIAL_ACCOUNT_UPDATED,function(){y.updateItem(n.systemOfficialAccount,"default")}),i.add(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_LIST_GOT,function(){n.ctaEnable&&t.trigger(h,"click")}),i.add(e.SYSTEM_EVENT.MESSAGE_APPENDED,function(e,i){if(e!==n.currentOfficialAccount){var o=i.brief,r=t.formatDate(_.now()),a=e.official_account_id;e.unreadMessageIdList.add(i.id),y.updateLatestMessage(a,o,r),y.updateUnreadCount(a,e.unreadMessageIdList.getLength()),c()}})}}(easemobim._const,easemobim.utils,app.profile,app.eventListener,app.apiHelper,app.createSessionList,app.createMessageView,app.promptCtaDialog),app.initGetGreetings=function(e,t,n,i,o,r){function a(e){e===n.systemOfficialAccount&&(e.isSessionOpen||Promise.all([o.getSystemGreeting(),o.getRobertGreeting(),o.getSkillgroupMenu()]).then(function(e){var t=e[0],n=e[1],i=e[2],o=n.greetingTextType,a=n.greetingText,s={};switch(t&&r.handleMessage({data:t,noprompt:!0},"txt"),o){case 0:r.handleMessage({data:a,noprompt:!0},"txt");break;case 1:s=JSON.parse(a.replace(/&amp;quot;/g,'"')),s.ext&&r.handleMessage({ext:s.ext,noprompt:!0});break;case void 0:break;default:console.error("unknown robot greeting type.")}i&&r.handleMessage({data:i,type:"skillgroupMenu",noprompt:!0})}))}return function(){i.add(e.SYSTEM_EVENT.SESSION_RESTORED,a),i.add(e.SYSTEM_EVENT.SESSION_NOT_CREATED,a)}}(easemobim._const,easemobim.utils,app.profile,app.eventListener,app.apiHelper,app.channel),app.initPasteImage=function(e,t,n){function i(t){/^image\/\w+$/.test(e.getDataByPath(t,"clipboardData.items.0.type"))&&(o=t.clipboardData.items[0].getAsFile(),r=window.URL.createObjectURL(o),a.src=r,s.show())}var o,r,a=document.createElement("img"),s=t.createDialog({contentDom:a,className:"mini paste-image"}).addButton({confirmText:"",confirm:function(){n.sendImg({data:o,url:r})}});return function(){e.on(document.querySelector(".em-widget-send-wrapper .em-widget-textarea"),"paste",i)}}(easemobim.utils,app.uikit,app.channel),app.satisfaction=function(e,t,n){function i(){d.blur(),d.value="",e.removeClass(u,"sel")}function o(e,t,i,o){n.sendText("",{ext:{weichat:{ctrlType:"enquiry",ctrlArgs:{inviteId:o||"",serviceSessionId:i||"",detail:t,summary:e}}}})}var r,a,s=e.createElementFromHTML(["<div>","<h3></h3>","<ul>",'<li idx="1">H</li>','<li idx="2">H</li>','<li idx="3">H</li>','<li idx="4">H</li>','<li idx="5">H</li>',"</ul>",'<textarea spellcheck="false" placeholder=""></textarea>',"</div>"].join("")),c=s.querySelector("ul"),u=c.querySelectorAll("li"),d=s.querySelector("textarea"),l=t.createDialog({contentDom:s,className:"satisfaction mini"}).addButton({confirmText:"",confirm:function(){var e=c.querySelectorAll("li.sel").length;return 0===e?(t.tip(""),!0):(o(e,d.value,r,a),i(),void t.showSuccess(""))}});return e.on(c,"click",function(t){var n=t||window.event,i=n.target||n.srcElement,o=+i.getAttribute("idx")||0;_.each(u,function(t,n){e.toggleClass(t,"sel",o>n)})}),{show:function(e,t){r=t,a=e,l.show()}}}(easemobim.utils,app.uikit,app.channel),easemobim.imgView=function(e,t,n){var i=document.querySelector("div.img-view"),o=i.querySelector("img");return e.on(i,"click",function(){e.addClass(i,"hide")},!1),{show:function(r){e.isTop||e.isMobile?(o.setAttribute("src",r),e.removeClass(i,"hide")):transfer.send({event:t.EVENTS.SHOW_IMG,data:{imgSrc:r,imgFile:n.imgFileList.get(r)}})}}}(easemobim.utils,easemobim._const,app.profile),app.wechat=function(){var e=/MicroMessenger/.test(navigator.userAgent),t=easemobim.utils.query("wechatAuth"),n=easemobim.utils.query("appid"),i=easemobim.utils.query("code"),o=easemobim.utils.query("tenantId");return e&&t&&o&&n?function(e){var t=function(e){easemobim.emajax({url:"/v1/weixin/admin/appid",type:"GET",success:function(t){e(t)},error:function(t){e(null)}})},r=function(e,t){easemobim.emajax({url:"/v1/weixin/sns/userinfo/"+n+"/"+e,data:{tenantId:o},type:"GET",success:function(e){t(e)},error:function(e){var t=location.href.replace(/&code=[^&]+/,"");t.indexOf("appid")!==t.lastIndexOf("appid")&&(t=t.replace(/&appid=wx[^&]+/,"")),location.href=t}})};i?r(i,function(t){t?e(t):e()}):t(function(t){t?location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+n+"&redirect_uri="+encodeURIComponent(location.href)+"&response_type=code&scope=snsapi_userinfo&state=STATE&component_appid="+t+"#wechat_redirect":e()})}:function(e){e()}}(),app.videoChat=function(e,t,n){function i(e){o=n.config,s.style.display="",a.classList.remove("hide"),a.addEventListener("click",function(){f.show()},!1),s.addEventListener("click",function(e){var t=e.target.className;Object.keys(E).forEach(function(e){~t.indexOf(e)&&E[e]()})},!1),m=new WebIM.WebRTC.Call({connection:e,mediaStreamConstaints:{audio:!0,video:!0},listener:{onAcceptCall:function(e,t){console.log("onAcceptCall",e,t)},onGotRemoteStream:function(e){console.log("onGotRemoteStream",e),l.src=URL.createObjectURL(e),h=e,l.play()},onGotLocalStream:function(e){console.log("onGotLocalStream",e),p.src=URL.createObjectURL(e),g=e,p.play()},onRinging:function(e){console.log("onRinging",e),p.muted=!0,l.muted=!1,_.isConnected=!1,d.classList.add("hide"),u.classList.add("hide"),r.classList.add("has-video"),v.start(""),c.classList.remove("hide")},onTermCall:function(){console.log("onTermCall"),y()},onError:function(e){console.log(e&&e.message?e.message:"An error occured when calling webrtc")}}})}var o,r=document.getElementById("em-kefu-webim-chat"),a=document.querySelector(".em-video-invite"),s=document.querySelector(".em-widget-video"),c=s.querySelector(".btn-accept-call"),u=s.querySelector(".toolbar-control"),d=s.querySelector(".sub-win"),l=s.querySelector("video.main"),p=s.querySelector("video.sub"),f=e.createDialog({contentDom:['<p class="prompt">',"","</p>"].join(""),className:"rtc-video-confirm"}).addButton({confirm:function(){t.sendText("",{ext:{type:"rtcmedia/video",msgtype:{liveStreamInvitation:{msg:"",orgName:o.orgName,appName:o.appName,userName:o.user.username,imServiceNumber:o.toUser,restServer:o.restServer,xmppServer:o.xmppServer,resource:"webim"}}}})}}),m=null,g=null,h=null,v={timer:null,counter:0,prompt:s.querySelector(".status p.prompt"),timeSpan:s.querySelector(".status p.time-escape"),start:function(e){function t(e){return new Date(1e3*e).toISOString().slice(-"00:00.000Z".length).slice(0,"00:00".length)}var n=this;n.counter=0,n.prompt.innerHTML=e,n.timeSpan.innerHTML="00:00",n.timer=setInterval(function(){n.timeSpan.innerHTML=t(++n.counter)},1e3)},stop:function(){var e=this;clearInterval(e.timer)}},_={isConnected:!1,timer:null,delay:3e3,closingPrompt:s.querySelector(".full-screen-prompt"),timeSpan:s.querySelector(".full-screen-prompt p.time-escape"),show:function(){var e=this;e.isConnected?e.timeSpan.innerHTML=v.timeSpan.innerHTML:e.timeSpan.innerHTML="00:00",e.closingPrompt.classList.remove("hide"),setTimeout(function(){r.classList.remove("has-video"),e.closingPrompt.classList.add("hide")},e.delay)}},y=function(){v.stop(),_.show(),g&&g.getTracks().forEach(function(e){e.stop()}),h&&h.getTracks().forEach(function(e){e.stop()}),l.src="",p.src=""},E={"btn-end-call":function(){try{m.endCall()}catch(e){console.error("end call:",e)}finally{y()}},"btn-accept-call":function(){_.isConnected=!0,c.classList.add("hide"),u.classList.remove("hide"),d.classList.remove("hide"),v.stop(),v.start(""),m.acceptCall()},"btn-toggle":function(){g&&g.getVideoTracks().forEach(function(e){e.enabled=!e.enabled})},"btn-change":function(){var e;e=p.src,p.src=l.src,l.src=e,p.play(),l.play(),p.muted=!p.muted,l.muted=!l.muted},"btn-minimize":function(){s.classList.add("minimized")},"btn-maximize":function(){s.classList.remove("minimized")}};return{init:i,onOffline:function(){console.log("onOffline"),y()}}}(app.uikit,app.channel,app.profile),app.chat=function(e,t,n,i,o,r,a,s,c,u,d,l,p,f,m){function g(){a.add(e.SYSTEM_EVENT.SESSION_OPENED,v),a.add(e.SYSTEM_EVENT.SESSION_RESTORED,v),a.add(e.SYSTEM_EVENT.SATISFACTION_EVALUATION_MESSAGE_RECEIVED,function(e,t,n){e===r.currentOfficialAccount&&s.show(t,n)})}function h(){B=r.config,R(),y();var n=t.createElementFromHTML('<div class="em-model"></div>'),i=t.createElementFromHTML(['<div class="em-dialog off-duty-prompt">','<div class="bg-color header"></div>','<div class="body">','<p class="content">710 23-711 8244001111118</p>',"</div>","</div>"].join(""));j.imChat.appendChild(n),j.imChat.appendChild(i),j.sendBtn.innerHTML="",transfer.send({event:e.EVENTS.ONREADY})}function v(e){if(!e.hasReportedAttributes){var t=(e.official_account_id,e.sessionId),n=e.isSessionOpen;n&&t&&(e.hasReportedAttributes=!0,i.reportVisitorAttributes(t))}}function y(){(t.isTop||!B.minimum)&&t.removeClass(j.imChat,"hide"),document.querySelector(".em-widget-pop-bar").innerText=B.buttonText,t.isMobile&&t.addClass(document.body,"em-mobile"),B.ticket&&t.removeClass(j.noteBtn,"hide"),B.minimum&&!t.isTop&&t.removeClass(j.minifyBtn,"hide"),WebIM.utils.isCanUploadFileAsync&&(t.removeClass(j.sendImgBtn,"hide"),t.removeClass(j.sendFileBtn,"hide")),B.ui.H5Title.enabled&&(document.title=B.ui.H5Title.content),window.HTMLAudioElement&&!t.isMobile&&B.soundReminder&&t.removeClass(j.audioBtn,"hide"),t.isMobile&&!B.hideKeyboard&&t.removeClass(j.switchKeyboardBtn,"hide"),B.satisfaction&&t.removeClass(j.satisfaction,"hide")}function E(){if(window.HTMLAudioElement&&!t.isMobile&&B.soundReminder){var e=document.createElement("audio"),n=document.querySelector(".em-widget-header .btn-audio"),i=!1,o=_.throttle(function(){e.play()},3e3,{trailing:!1});e.src=B.staticPath+"/mp3/msg.m4a",t.on(n,"click",function(){i=!i,t.toggleClass(n,"icon-slience",i),t.toggleClass(n,"icon-bell",!i)}),G.playSound=function(){i||o()}}}function S(){if(B.logo.enabled){var e=document.querySelector(".em-widget-tenant-logo"),n=e.querySelector("img");t.removeClass(e,"hide"),n.src=B.logo.url}}function T(){var e=document.querySelector(".em-widget-tip .content"),n=document.querySelector(".em-widget-tip .tip-close");i.getNotice().then(function(i){if(i.enabled){var o=i.content;e.innerHTML=WebIM.utils.parseLink(o),t.addClass(j.imChat,"has-tip"),t.on(n,t.click,function(){t.removeClass(j.imChat,"has-tip")})}})}function C(){function e(){var e=WebIM.Emoji.path,t=7;return _.chain(WebIM.Emoji.map).map(function(t,n){return'<div class="em-bar-emoji-bg e-face"><img class="e-face emoji" src="'+e+t+'" data-value='+n+" /></div>"}).groupBy(function(e,n){return Math.floor(n/t)}).map(function(e){return'<li class="e-face">'+e.join("")+"</li>"}).value().join("")}t.on(j.emojiBtn,t.click,function(){j.textInput.blur(),t.toggleClass(j.emojiWrapper,"hide"),D||(D=!0,j.emojiContainer.innerHTML=e())}),t.live("img.emoji",t.click,function(e){!t.isMobile&&j.textInput.focus(),j.textInput.value+=this.getAttribute("data-value"),t.trigger(j.textInput,"change")},j.emojiWrapper),t.on(document,t.click,function(e){var n=window.event||e,i=n.srcElement||n.target;t.hasClass(i,"e-face")||t.addClass(j.emojiWrapper,"hide")})}function I(){switch(B.offDutyType){case"none":var n=t.createElementFromHTML('<div class="em-model"></div>'),i=t.createElementFromHTML(['<div class="em-dialog off-duty-prompt">','<div class="bg-color header"></div>','<div class="body">','<p class="content">'+B.offDutyWord+"</p>","</div>","</div>"].join(""));j.imChat.appendChild(n),j.imChat.appendChild(i),j.sendBtn.innerHTML="";break;default:app.leaveMessage({hideCloseBtn:!0})}transfer.send({event:e.EVENTS.ON_OFFDUTY})}function b(){var e=t.getDataByPath(r,"currentOfficialAccount.messageView.scrollToBottom");"function"==typeof e&&e()}function N(){function e(){var e=this.value?this.scrollHeight:o;this.style.height=e+"px",this.scrollTop=9999,n()}function n(){var e=j.editorView.getBoundingClientRect().height;"up"===i?(j.emojiWrapper.style.top=43+e+"px",j.queuingNumberStatus.style.top=e+"px"):(j.chatWrapper.style.bottom=e+"px",j.emojiWrapper.style.bottom=e+"px"),b()}var i,o=j.textInput.clientHeight;t.on(j.switchKeyboardBtn,"click",function(){var e=t.hasClass(this,"icon-keyboard-down"),n=j.editorView.getBoundingClientRect().height;switch(i=e?"down":"up",t.toggleClass(this,"icon-keyboard-up",e),t.toggleClass(this,"icon-keyboard-down",!e),i){case"up":j.editorView.style.bottom="auto",j.editorView.style.zIndex="3",j.editorView.style.top="43px",j.chatWrapper.style.bottom="0",j.emojiWrapper.style.bottom="auto",j.emojiWrapper.style.top=43+n+"px",j.queuingNumberStatus.style.top=n+"px";break;case"down":j.editorView.style.bottom="0",j.editorView.style.zIndex="3",j.editorView.style.top="auto",j.chatWrapper.style.bottom=n+"px",j.emojiWrapper.style.bottom=n+"px",j.emojiWrapper.style.top="auto",j.queuingNumberStatus.style.top="-26px",b()}}),t.on(j.textInput,"input change",e)}function O(){return new Promise(function(t,n){i.getOfficalAccounts().then(function(n){_.each(n,o.attemptToAppendOfficialAccount),r.ctaEnable||(r.currentOfficialAccount=r.systemOfficialAccount,r.systemOfficialAccount.messageView.show()),a.excuteCallbacks(e.SYSTEM_EVENT.OFFICIAL_ACCOUNT_LIST_GOT,[]),t()},function(i){i===e.ERROR_MSG.VISITOR_DOES_NOT_EXIST?(o.attemptToAppendOfficialAccount({type:"SYSTEM",official_account_id:"default",img:null}),r.currentOfficialAccount=r.systemOfficialAccount,r.systemOfficialAccount.messageView.show(),a.excuteCallbacks(e.SYSTEM_EVENT.SESSION_NOT_CREATED,[r.systemOfficialAccount]),t()):n(i)})})}function R(){function a(){var e=!j.textInput.value.trim();t.toggleClass(j.sendBtn,"disabled",!L||e),r.grayList.msgPredictEnable&&!e&&L&&c(j.textInput.value)}t.isTop||(t.on(j.minifyBtn,"click",function(){transfer.send({event:e.EVENTS.CLOSE})}),t.on(document,"mouseover",function(){transfer.send({event:e.EVENTS.RECOVERY})})),t.on(j.chatWrapper,"click",function(){j.textInput.blur()}),t.live("img.em-widget-imgview","click",function(){var e=this.getAttribute("src");easemobim.imgView.show(e)}),!B.dragenable||t.isTop||t.isMobile||(j.dragBar.style.cursor="move",t.on(j.dragBar,"mousedown",function(t){var n=window.event||t;return j.textInput.blur(),transfer.send({event:e.EVENTS.DRAGREADY,data:{x:n.clientX,y:n.clientY}}),!1},!1)),t.live("div.em-widget-msg-status","click",function(){var e=this.getAttribute("id").slice(0,-"_failed".length),n=this.getAttribute("data-type");o.reSend(n,e),t.addClass(this,"hide"),t.removeClass(document.getElementById(e+"_loading"),"hide")}),t.live("button.js_robotTransferBtn","click",function(){var e=this.getAttribute("data-id"),t=this.getAttribute("data-sessionid");this.clicked||(this.clicked=!0,o.sendTransferToKf(e,t))}),t.live("button.js-transfer-to-ticket","click",function(){var e=r.currentOfficialAccount;if(e){var n=e.isSessionOpen,o=e.sessionId;n&&i.closeServiceSession(o),app.leaveMessage({preData:{name:B.visitor.trueName,phone:B.visitor.phone,mail:B.visitor.email,content:t.getBrief("\n"+e.messageView.getRecentMsg(10),1e3)}})}}),t.live("button.js_robotbtn","click",function(){o.sendText(this.innerText,{ext:{msgtype:{choice:{menuid:this.getAttribute("data-id")}}}})}),t.live("button.js_skillgroupbtn","click",function(){o.sendText(this.innerText,{ext:{weichat:{queueName:this.getAttribute("data-queue-name")}}})}),t.live("button.js_satisfybtn","click",function(){var e=this.getAttribute("data-servicesessionid"),t=this.getAttribute("data-inviteid");s.show(t,e)});var c=_.throttle(function(n){var o=r.currentOfficialAccount||{},a=o.sessionId,s=o.sessionState,c=o.agentType,u=t.getBrief(n,e.MESSAGE_PREDICT_MAX_LENGTH);s===e.SESSION_STATE.PROCESSING&&c!==e.AGENT_ROLE.ROBOT&&a&&i.reportPredictMessage(a,u)},1e3);Modernizr.oninput?t.on(j.textInput,"input change",a):t.on(j.textInput,"keyup change",a),t.isMobile&&t.on(j.textInput,"focus touchstart",function(){j.textInput.style.overflowY="auto",b()}),t.on(j.fileInput,"change",function(){var i=j.fileInput,r=t.getDataByPath(i,"files.0.size");i.value&&(r>e.UPLOAD_FILESIZE_LIMIT?(n.tip("10MB"),i.value=""):o.sendFile(WebIM.utils.getFileUrl(i),i))}),t.isQQBrowser&&t.isAndroid&&j.imgInput.setAttribute("accept","image/*"),t.on(j.imgInput,"change",function(){var i=j.imgInput,r=t.getDataByPath(i,"files.0.size");i.value&&(r>e.UPLOAD_FILESIZE_LIMIT?(n.tip("10MB"),i.value=""):o.sendImg(WebIM.utils.getFileUrl(i),i))}),t.on(j.sendFileBtn,"click",function(){L?j.fileInput.click():n.tip("...")}),t.on(j.sendImgBtn,"click",function(){L?j.imgInput.click():n.tip("...")}),t.on(j.noteBtn,"click",function(){app.leaveMessage()}),t.on(j.satisfaction,"click",function(){j.textInput.blur(),s.show()}),t.on(j.textInput,"keydown",function(e){13!==e.keyCode||t.isMobile||e.ctrlKey||e.shiftKey||(e.preventDefault&&e.preventDefault(),t.trigger(j.sendBtn,"click"))}),t.on(j.sendBtn,"click",function(){var i=j.textInput.value;t.hasClass(this,"disabled")||(i.length>e.MAX_TEXT_MESSAGE_LENGTH?n.tip(""):(o.sendText(i),j.textInput.value="",t.trigger(j.textInput,"change")))})}function w(){r.isChatWindowOpen=!1,B.hide||(t.addClass(j.imChat,"hide"),t.removeClass(j.imBtn,"hide")),a.excuteCallbacks(e.SYSTEM_EVENT.CHAT_WINDOW_CLOSED,[])}function M(){r.isChatWindowOpen=!0,t.addClass(j.imBtn,"hide"),t.removeClass(j.imChat,"hide"),b(),r.isInOfficeHours&&j.textInput.offsetHeight>0&&j.textInput.focus(),transfer.send({event:e.EVENTS.RECOVERY}),a.excuteCallbacks(e.SYSTEM_EVENT.CHAT_WINDOW_OPENED,[])}function x(){if(!L){for(L=!0,j.sendBtn.innerHTML="",t.trigger(j.textInput,"change"),(B.minimum===!1||B.eventCollector===!0)&&transfer.send({event:e.EVENTS.SHOW});r.commandMessageToBeSendList.length>0;)o.sendText("",r.commandMessageToBeSendList.pop());transfer.send({event:e.EVENTS.ONREADY}),B.extMsg&&o.sendText("",{ext:B.extMsg})}}function A(){return new Promise(function(e,t){o.initConnection(function(t){t&&(B.user.token=B.user.token||t.accessToken),e()})})}function k(){B=r.config,o.init(),r.isChatWindowOpen=!0,E(),y(),C(),R(),p(),P()}function P(){Promise.all([i.getDutyStatus(),i.getGrayList(),i.getToken()]).then(function(e){var n=e[0],a=e[1];r.grayList=a,r.isInOfficeHours=n||"chat"===B.offDutyType,r.isInOfficeHours?(Promise.all([O(),A()]).then(x),i.getExSession().then(function(e){r.hasHumanAgentOnline=e.onlineHumanAgentCount>0,r.hasRobotAgentOnline=e.onlineRobotAgentCount>0}),i.getNickNameOption().then(function(e){r.isAgentNicknameEnable=e}),g(),c(),u(),d(),l(),m(),f(),o.initSecondChannle(),app.initPasteImage(),S(),T(),t.isMobile&&N()):I()},function(e){if("user not found"!==e.error_description||!B.isUsernameFromCookie)throw e;F()})}var D,L,B,U=document.querySelector(".em-widget-header"),W=document.querySelector(".em-widget-send-wrapper"),j={imBtn:document.getElementById("em-widgetPopBar"),imChat:document.getElementById("em-kefu-webim-chat"),agentStatusText:U.querySelector(".em-header-status-text"),dragBar:U.querySelector(".drag-bar"),minifyBtn:U.querySelector(".btn-min"),audioBtn:U.querySelector(".btn-audio"),switchKeyboardBtn:U.querySelector(".btn-keyboard"),emojiBtn:W.querySelector(".em-bar-emoji"),sendImgBtn:W.querySelector(".em-widget-img"),sendFileBtn:W.querySelector(".em-widget-file"),sendBtn:W.querySelector(".em-widget-send"),satisfaction:W.querySelector(".em-widget-satisfaction"),textInput:W.querySelector(".em-widget-textarea"),noteBtn:W.querySelector(".em-widget-note"),queuingNumberStatus:W.querySelector(".queuing-number-status"),imgInput:document.querySelector(".upload-img-container"),fileInput:document.querySelector(".upload-file-container"),emojiContainer:document.querySelector(".em-bar-emoji-container"),chatWrapper:document.querySelector(".chat-wrapper"),emojiWrapper:document.querySelector(".em-bar-emoji-wrapper"),topBar:U,editorView:W,block:null},F=_.once(function(){console.warn("user not found in current appKey, attempt to recreate user."),i.createVisitor().then(function(n){B.user.username=n.userId,B.user.password=n.userPassword,P(),t.isTop?t.set("root"+B.tenantId+B.emgroup,B.user.username):transfer.send({event:e.EVENTS.CACHEUSER,data:{username:B.user.username,group:B.user.emgroup}})})}),G={doms:j,init:k,showUpdateingPage:h,close:w,show:M,playSound:function(){},block:null};return G}(easemobim._const,easemobim.utils,app.uikit,app.apiHelper,app.channel,app.profile,app.eventListener,app.satisfaction,app.initAgentInputStatePoller,app.initAgentStatePoller,app.initQueuingNumberPoller,app.initTransferToKefuButton,app.initSessionList,app.initGetGreetings,app.initAgentNicknameUpdate),app.leaveMessage=function(e,t,n){function i(){Promise.all([n.getToken(),n.getProjectId()]).then(function(e){var i=e[0],r=e[1];n.createTicket({token:i,projectId:r,name:u.value,phone:d.value,mail:l.value,content:c.value}).then(function(){a=!1,t.showSuccess(""),o()},function(e){a=!1,t.tip(""),console.error(e)})})["catch"](function(e){t.tip("token"),console.error(e)})}function o(){u.value="",d.value="",l.value="",c.value=""}function r(e){c.value=e.content||"",u.value=e.name||"",d.value=e.phone||"",l.value=e.mail||""}var a=!1,s=e.createElementFromHTML(['<div class="wrapper">',"<h3></h3>",'<input type="text" class="name" placeholder="">','<input type="text" class="phone" placeholder="">','<input type="text" class="mail" placeholder="">','<textarea spellcheck="false" placeholder=""></textarea>',"</div>"].join("")),c=s.querySelector("textarea"),u=s.querySelector(".name"),d=s.querySelector(".phone"),l=s.querySelector(".mail"),p=t.createDialog({contentDom:s,className:"ticket"}).addButton({confirmText:"",confirm:function(){return a?t.tip("..."):!u.value||u.value.length>140?t.tip(""):d.value&&/^[0-9+][0-9-]{10,17}$/.test(d.value)?l.value&&/^[0-9a-z][_.0-9a-z-]{0,30}[0-9a-z]@([0-9a-z][0-9a-z-]{0,30}[.]){1,3}[a-z]{2,4}$/i.test(l.value)?!c.value||c.value.length>1500?t.tip("1500"):(a=!0,setTimeout(function(){a=!1},1e4),i()):t.tip(""):t.tip(""),{preventDefult:!0}}}),f=p.el.querySelector(".cancel-btn");return function(t){t=t||{},t.preData&&r(t.preData),t.hideCloseBtn&&e.addClass(f,"hide"),p.show()}}(easemobim.utils,app.uikit,app.apiHelper),app.eventCollector=function(e,t,n,i,o,r){function a(e,s){var c=o.currentBrowsingURL;transfer.send({event:t.EVENTS.REQUIRE_URL}),c&&i.reportEvent(c,e,s).then(function(e){var i=e.type,o=e.userName,s=e.orgName,c=e.appName,u=e.message,m=e.agentNickname,h=e.agentAvatar;switch(v=!!u,i){case"OK":break;case"INIT_CALL":l()&&(o&&(g=s+"#"+c+"_"+o,p.stop(),p=new n(function(){a("VISITOR",g)},y)),d(),v?(transfer.send({event:t.EVENTS.ADD_PROMPT}),_=r({title:m,content:u,avatar:h,className:"cta-prompt bottom",replyCallback:function(){f(e),transfer.send({event:t.EVENTS.REMOVE_PROMPT})},closeCallback:function(){transfer.send({event:t.EVENTS.REMOVE_PROMPT})}})):f(e));break;default:throw"unexpected event type."}})}function s(n){f||(f=n),m||(m=o.config),e.isTop||(transfer.send({event:t.EVENTS.REQUIRE_URL}),m?p?p.start():m.user.username?u(m.user.username):c():console.error("not config yet."))}function c(){var i=m.guestId||e.uuid();transfer.send({event:t.EVENTS.SET_ITEM,data:{key:"guestId",value:i}}),p=new n(function(){a("GUEST",i)},y),p.start()}function u(e){i.getRelevanceList().then(function(t){var o=t[0],r=m.appKey.split("#");m.orgName=r[0]||o.orgName,m.appName=r[1]||o.appName,m.toUser=m.to||o.imServiceNumber,m.restServer=m.restServer||o.restDomain;var s=m.restServer?m.restServer.match(/vip\d/):"";s=s&&s.length?"-"+s[0]:"",m.xmppServer=m.xmppServer||"im-api"+s+".easemob.com",g=m.orgName+"#"+m.appName+"_"+e,p=new n(function(){a("VISITOR",g)},y),i.getCurrentServiceSession().then(function(e){h=!!e,!h&&p.start()})},function(e){throw e})}function d(){p&&p.stop(),g&&i.deleteEvent(g)}function l(){return p&&p.isStarted}var p,f,m,g,h,v,_,y=5e3;return{startToReport:s,stopReporting:d,hasProcessingSession:function(){return h},hasCtaInvite:function(){return v},hideCtaPrompt:function(){_&&_.hide(),transfer.send({event:t.EVENTS.REMOVE_PROMPT})},isStarted:l}}(easemobim.utils,easemobim._const,app.Poller,app.apiHelper,app.profile,app.promptCtaDialog),function(e,t,n,i,o,r,a,s,c){"use strict";function u(){v={},v.tenantId=t.query("tenantId"),v.configId=t.query("configId"),v.offDutyType=t.query("offDutyType"),v.grUserId=t.query("grUserId"),v.to=t.convertFalse(t.query("to")),v.xmppServer=t.convertFalse(t.query("xmppServer")),v.restServer=t.convertFalse(t.query("restServer")),v.agentName=t.convertFalse(t.query("agentName")),v.resources=t.convertFalse(t.query("resources")),v.hideStatus=t.convertFalse(t.query("hideStatus")),v.satisfaction=t.convertFalse(t.query("sat")),v.wechatAuth=t.convertFalse(t.query("wechatAuth")),v.hideKeyboard=t.convertFalse(t.query("hideKeyboard")),v.appKey=t.convertFalse(decodeURIComponent(t.query("appKey"))),v.domain=v.domain||"//"+location.host,v.offDutyWord=decodeURIComponent(t.query("offDutyWord")),v.ticket=""===t.query("ticket")?!0:t.convertFalse(t.query("ticket")),v.emgroup=decodeURIComponent(t.query("emgroup")),v.user={};var e=t.query("user"),n=t.get("root"+v.tenantId+v.emgroup);e?v.user.username=e:n&&(v.user.username=n,v.isUsernameFromCookie=!0),s.config=v,c.transfer={send:function(){}},m()}function d(){var n=document.getElementById("em-widgetPopBar");c.transfer=new easemobim.Transfer(null,"main",!0).listen(function(t){var n=t.event,i=t.data;switch(n){case e.EVENTS.SHOW:o.isStarted()&&(o.stopReporting(),g()),o.hasProcessingSession()&&g(),o.hasCtaInvite()&&(g(),o.hideCtaPrompt()),r.show();break;case e.EVENTS.CLOSE:r.close();break;case e.EVENTS.EXT:a.sendText("",i.ext);break;case e.EVENTS.TEXTMSG:a.sendText(i.data,i.ext);break;case e.EVENTS.UPDATE_URL:s.currentBrowsingURL=i;break;case e.EVENTS.INIT_CONFIG:c.transfer.to=i.parentId,v=i,s.config=v,m()}},["easemob"]),t.removeClass(n,"hide"),t.on(n,"click",function(){transfer.send({event:e.EVENTS.SHOW})})}function l(){i.init(v),t.isMobile||!v.eventCollector||o.isStarted()?g():o.startToReport(function(e){g(e)}),i.getTheme().then(function(n){var i=e.themeMap[n];i&&t.addClass(document.body,i)})}function p(){if(v.offDutyWord=v.offDutyWord||"",v.emgroup=v.emgroup||"",v.offDutyWord)try{v.offDutyWord=decodeURIComponent(v.offDutyWord)}catch(e){}if(v.emgroup)try{v.emgroup=decodeURIComponent(v.emgroup)}catch(e){}v.user=v.user||{},v.visitor=v.visitor||{},v.channel={},v.ui={H5Title:{}},v.toolbar={},v.chat={},s.defaultAvatar=(v.staticPath||"static")+"/img/default_avatar.png",v.previewObj?(f(v.previewObj),l()):v.configId?i.getConfig(v.configId).then(function(e){v.tenantId=e.tenantId,f(e.configJson),l()}):l()}function f(t){v.isWebChannelConfig=!0,v.channel=t.channel,v.ui=t.ui,v.toolbar=t.toolbar,v.chat=t.chat,v.appKey=t.channel.appKey,v.to=t.channel.to,v.agentName=t.channel.agentName,v.emgroup=t.channel.emgroup,v.dragenable=t.ui.dragenable,v.hide=t.ui.hide,v.logo=t.ui.logo,v.notice=t.ui.notice,v.themeName=t.ui.themeName,v.autoConnect=t.toolbar.autoConnect,v.hideKeyboard=t.toolbar.hideKeyboard,v.minimum=t.toolbar.minimum,v.offDutyWord=t.toolbar.offDutyWord,v.offDutyType=t.toolbar.offDutyType,v.popupOnInitialized=t.toolbar.popupOnInitialized,v.satisfaction=t.toolbar.satisfaction,v.soundReminder=t.toolbar.soundReminder,
v.ticket=t.toolbar.ticket,v.resources=t.chat.resources,v.hideStatus=t.chat.hideStatus,transfer.send({event:e.EVENTS.RESET_IFRAME,data:{dialogHeight:v.dialogHeight,dialogWidth:v.dialogWidth,dialogPosition:v.dialogPosition}})}function m(){var e=document.getElementById("cross-origin-iframe");e.src=v.domain+"/webim/transfer.html?v=bluemoon_47.13.3.2",t.on(e,"load",function(){i.initApiTransfer(),p()})}function g(o){y||(y=!0,i.getRelevanceList().then(function(n){var a,c=v.appKey,u=c.split("#"),d=u[0],l=u[1],p=v.toUser||v.to;"number"==typeof p&&(p=p.toString(10)),c&&p&&(a=_.where(n,{orgName:d,appName:l,imServiceNumber:p})[0]),a||(a=a||n[0],console.log("mismatched channel, use default.")),s.tenantAvatar=t.getAvatarsFullPath(a.tenantAvatar,v.domain),s.defaultAgentName=a.tenantName,v.logo=v.logo||{enabled:!!a.tenantLogo,url:a.tenantLogo},v.toUser=a.imServiceNumber,v.orgName=a.orgName,v.appName=a.appName,v.channelId=a.channelId,v.appKey=v.orgName+"#"+v.appName,v.restServer=v.restServer||a.restDomain,v.xmppServer=v.xmppServer||a.xmppServer,o?(v.toUser=o.agentImName,v.appName=o.appName,v.orgName=o.orgName,v.appKey=o.orgName+"#"+o.appName,o.userName?(v.user={username:o.userName,password:o.userPassword},s.commandMessageToBeSendList.push({ext:{weichat:{agentUsername:o.agentUserName}}}),r.init(),r.show(),transfer.send({event:e.EVENTS.SHOW}),transfer.send({event:e.EVENTS.CACHEUSER,data:{username:o.userName,group:v.user.emgroup}})):i.getPassword().then(function(t){v.user.password=t,s.commandMessageToBeSendList.push({ext:{weichat:{agentUsername:o.agentUserName}}}),r.init(),r.show(),transfer.send({event:e.EVENTS.SHOW})},function(e){throw console.error(""),e})):v.user.username&&(v.user.password||v.user.token)?r.init():v.wechatAuth?app.wechat(function(e){try{e=JSON.parse(e)}catch(t){e=null}if(e){var n=v.tenantId+"_"+v.orgName+"_"+v.appName+"_"+v.toUser+"_"+e.openid;v.visitor.userNickname=e.nickname,easemobim.emajax({url:"/v1/webimplugin/visitors/wechat/"+n+"?tenantId="+v.tenantId,data:{orgName:v.orgName,appName:v.appName,imServiceNumber:v.toUser},type:"POST",success:function(e){try{e=JSON.parse(e)}catch(t){e=null}e&&"OK"===e.status?(v.user.username=e.entity.userId,v.user.password=e.entity.userPassword,r.init()):h()},error:function(e){h()}})}else h()}):v.user.username?i.getPassword().then(function(e){v.user.password=e,r.init()},function(e){h()}):h()},function(e){if(""===e)throw n.prompt(e),e;r.showUpdateingPage()}))}function h(){i.createVisitor().then(function(n){v.user.username=n.userId,v.user.password=n.userPassword,t.isTop?t.set("root"+v.tenantId+v.emgroup,v.user.username):transfer.send({event:e.EVENTS.CACHEUSER,data:{username:v.user.username,group:v.user.emgroup}}),r.init()})}var v,y;t.isTop?u():d()}(easemobim._const,easemobim.utils,app.uikit,app.apiHelper,app.eventCollector,app.chat,app.channel,app.profile,window);