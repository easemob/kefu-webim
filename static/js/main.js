!function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t,n){n(1),n(51),e.exports=n(52)},function(e,t,n){"use strict";function o(){d={},d.tenantId=f.query("tenantId"),d.configId=f.query("configId"),d.offDutyType=f.query("offDutyType"),d.grUserId=f.query("grUserId"),d.to=f.convertFalse(f.query("to")),d.xmppServer=f.convertFalse(f.query("xmppServer")),d.restServer=f.convertFalse(f.query("restServer")),d.agentName=f.convertFalse(f.query("agentName")),d.resources=f.convertFalse(f.query("resources")),d.hideStatus=f.convertFalse(f.query("hideStatus")),d.satisfaction=f.convertFalse(f.query("sat")),d.wechatAuth=f.convertFalse(f.query("wechatAuth")),d.hideKeyboard=f.convertFalse(f.query("hideKeyboard")),d.appKey=f.convertFalse(decodeURIComponent(f.query("appKey"))),d.domain=d.domain||"//"+location.host,d.offDutyWord=decodeURIComponent(f.query("offDutyWord")),d.ticket=""===f.query("ticket")||f.convertFalse(f.query("ticket")),d.emgroup=decodeURIComponent(f.query("emgroup")),d.user={};var e=f.query("user"),t=f.get("root"+d.tenantId+d.emgroup);e?d.user.username=e:t&&(d.user.username=t,d.isUsernameFromCookie=!0),T.config=d,window.transfer={send:function(){}},c()}function i(){var e=document.getElementById("em-widgetPopBar");window.transfer=new h(null,"main",(!0)).listen(function(e){var t=e.event,n=e.data;switch(t){case m.EVENTS.SHOW:y.isStarted()&&(y.stopReporting(),u()),y.hasProcessingSession()&&u(),y.hasCtaInvite()&&(u(),y.hideCtaPrompt()),v.show();break;case m.EVENTS.CLOSE:v.close();break;case m.EVENTS.EXT:S.sendText("",n.ext);break;case m.EVENTS.TEXTMSG:S.sendText(n.data,n.ext);break;case m.EVENTS.UPDATE_URL:T.currentBrowsingURL=n;break;case m.EVENTS.INIT_CONFIG:window.transfer.to=n.parentId,d=n,T.config=d,c()}},["easemob"]),f.removeClass(e,"hide"),f.on(e,"click",function(){transfer.send({event:m.EVENTS.SHOW})})}function r(){E.init(d),f.isMobile||!d.eventCollector||y.isStarted()?u():y.startToReport(function(e){u(e)}),E.getTheme().then(function(e){var t=m.themeMap[e];t&&f.addClass(document.body,t)})}function a(){if(d.offDutyWord=d.offDutyWord||"现在是下班时间。",d.emgroup=d.emgroup||"",d.offDutyWord)try{d.offDutyWord=decodeURIComponent(d.offDutyWord)}catch(e){}if(d.emgroup)try{d.emgroup=decodeURIComponent(d.emgroup)}catch(e){}d.user=d.user||{},d.visitor=d.visitor||{},d.channel={},d.ui={H5Title:{}},d.toolbar={},d.chat={},T.defaultAvatar=(d.staticPath||"static")+"/img/default_avatar.png",d.previewObj?(s(d.previewObj),r()):d.configId?E.getConfig(d.configId).then(function(e){d.tenantId=e.tenantId,s(e.configJson),r()}):r()}function s(e){d.isWebChannelConfig=!0,d.channel=e.channel,d.ui=e.ui,d.toolbar=e.toolbar,d.chat=e.chat,d.appKey=e.channel.appKey,d.to=e.channel.to,d.agentName=e.channel.agentName,d.emgroup=e.channel.emgroup,d.dragenable=e.ui.dragenable,d.hide=e.ui.hide,d.logo=e.ui.logo,d.notice=e.ui.notice,d.themeName=e.ui.themeName,d.autoConnect=e.toolbar.autoConnect,d.hideKeyboard=e.toolbar.hideKeyboard,d.minimum=e.toolbar.minimum,d.offDutyWord=e.toolbar.offDutyWord,d.offDutyType=e.toolbar.offDutyType,d.popupOnInitialized=e.toolbar.popupOnInitialized,d.satisfaction=e.toolbar.satisfaction,d.soundReminder=e.toolbar.soundReminder,d.ticket=e.toolbar.ticket,d.resources=e.chat.resources,d.hideStatus=e.chat.hideStatus,transfer.send({event:m.EVENTS.RESET_IFRAME,data:{dialogHeight:d.dialogHeight,dialogWidth:d.dialogWidth,dialogPosition:d.dialogPosition}})}function c(){var e=document.getElementById("cross-origin-iframe");e.src=d.domain+"/webim/transfer.html?v=pre_47.14.9",f.on(e,"load",function(){E.initApiTransfer(),a()})}function u(e){p||(p=!0,E.getRelevanceList().then(function(t){var n,o=d.appKey,i=o.split("#"),r=i[0],a=i[1],s=d.toUser||d.to;"number"==typeof s&&(s=s.toString(10)),o&&s&&(n=_.where(t,{orgName:r,appName:a,imServiceNumber:s})[0]),n||(n=n||t[0],console.log("mismatched channel, use default.")),T.tenantAvatar=f.getAvatarsFullPath(n.tenantAvatar,d.domain),T.defaultAgentName=n.tenantName,d.logo=d.logo||{enabled:!!n.tenantLogo,url:n.tenantLogo},d.toUser=n.imServiceNumber,d.orgName=n.orgName,d.appName=n.appName,d.channelId=n.channelId,d.appKey=d.orgName+"#"+d.appName,d.restServer=d.restServer||n.restDomain,d.xmppServer=d.xmppServer||n.xmppServer,e?(d.toUser=e.agentImName,d.appName=e.appName,d.orgName=e.orgName,d.appKey=e.orgName+"#"+e.appName,e.userName?(d.user={username:e.userName,password:e.userPassword},T.commandMessageToBeSendList.push({ext:{weichat:{agentUsername:e.agentUserName}}}),v.init(),v.show(),transfer.send({event:m.EVENTS.SHOW}),transfer.send({event:m.EVENTS.CACHEUSER,data:{username:e.userName,group:d.user.emgroup}})):E.getPassword().then(function(t){d.user.password=t,T.commandMessageToBeSendList.push({ext:{weichat:{agentUsername:e.agentUserName}}}),v.init(),v.show(),transfer.send({event:m.EVENTS.SHOW})},function(e){throw console.error("用户不存在！"),e})):d.user.username&&(d.user.password||d.user.token)?v.init():d.wechatAuth?N(function(e){d.user.username=e.userId,d.user.password=e.userPassword,v.init()},function(e){l()}):d.user.username?E.getPassword().then(function(e){d.user.password=e,v.init()},function(e){l()}):l()},function(e){throw g.prompt(e),e}))}function l(){E.createVisitor().then(function(e){if(d.user.username=e.userId,d.user.password=e.userPassword,f.isTop)f.set("root"+(d.configId||d.tenantId+d.emgroup),d.user.username);else{var t=d.configId||d.to+d.tenantId+d.emgroup;transfer.send({event:m.EVENTS.CACHEUSER,data:{key:t,value:d.user.username}})}v.init()})}n(2).polyfill(),n(5),n(6),n(8),n(10);var d,p,f=n(12),m=n(13),h=n(14),g=(n(15),n(16)),E=n(17),y=n(18),v=n(23),S=n(31),T=n(19),N=n(50);f.isTop?o():i()},function(e,t,n){(function(t,o){!function(t,n){e.exports=n()}(this,function(){"use strict";function e(e){var t=typeof e;return null!==e&&("object"===t||"function"===t)}function i(e){return"function"==typeof e}function r(e){X=e}function a(e){z=e}function s(){return function(){return t.nextTick(p)}}function c(){return"undefined"!=typeof J?function(){J(p)}:d()}function u(){var e=0,t=new Z(p),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}function l(){var e=new MessageChannel;return e.port1.onmessage=p,function(){return e.port2.postMessage(0)}}function d(){var e=setTimeout;return function(){return e(p,1)}}function p(){for(var e=0;e<K;e+=2){var t=ne[e],n=ne[e+1];t(n),ne[e]=void 0,ne[e+1]=void 0}K=0}function f(){try{var e=n(4);return J=e.runOnLoop||e.runOnContext,c()}catch(t){return d()}}function m(e,t){var n=arguments,o=this,i=new this.constructor(g);void 0===i[ie]&&D(i);var r=o._state;return r?!function(){var e=n[r-1];z(function(){return A(r,i,e,o._result)})}():R(o,i,e,t),i}function h(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(g);return I(n,e),n}function g(){}function _(){return new TypeError("You cannot resolve a promise with itself")}function E(){return new TypeError("A promises callback cannot return that same promise.")}function y(e){try{return e.then}catch(t){return ce.error=t,ce}}function v(e,t,n,o){try{e.call(t,n,o)}catch(i){return i}}function S(e,t,n){z(function(e){var o=!1,i=v(n,t,function(n){o||(o=!0,t!==n?I(e,n):b(e,n))},function(t){o||(o=!0,C(e,t))},"Settle: "+(e._label||" unknown promise"));!o&&i&&(o=!0,C(e,i))},e)}function T(e,t){t._state===ae?b(e,t._result):t._state===se?C(e,t._result):R(t,void 0,function(t){return I(e,t)},function(t){return C(e,t)})}function N(e,t,n){t.constructor===e.constructor&&n===m&&t.constructor.resolve===h?T(e,t):n===ce?(C(e,ce.error),ce.error=null):void 0===n?b(e,t):i(n)?S(e,t,n):b(e,t)}function I(t,n){t===n?C(t,_()):e(n)?N(t,n,y(n)):b(t,n)}function O(e){e._onerror&&e._onerror(e._result),x(e)}function b(e,t){e._state===re&&(e._result=t,e._state=ae,0!==e._subscribers.length&&z(x,e))}function C(e,t){e._state===re&&(e._state=se,e._result=t,z(O,e))}function R(e,t,n,o){var i=e._subscribers,r=i.length;e._onerror=null,i[r]=t,i[r+ae]=n,i[r+se]=o,0===r&&e._state&&z(x,e)}function x(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var o=void 0,i=void 0,r=e._result,a=0;a<t.length;a+=3)o=t[a],i=t[a+n],o?A(n,o,i,r):i(r);e._subscribers.length=0}}function w(){this.error=null}function M(e,t){try{return e(t)}catch(n){return ue.error=n,ue}}function A(e,t,n,o){var r=i(n),a=void 0,s=void 0,c=void 0,u=void 0;if(r){if(a=M(n,o),a===ue?(u=!0,s=a.error,a.error=null):c=!0,t===a)return void C(t,E())}else a=o,c=!0;t._state!==re||(r&&c?I(t,a):u?C(t,s):e===ae?b(t,a):e===se&&C(t,a))}function k(e,t){try{t(function(t){I(e,t)},function(t){C(e,t)})}catch(n){C(e,n)}}function L(){return le++}function D(e){e[ie]=le++,e._state=void 0,e._result=void 0,e._subscribers=[]}function B(e,t){this._instanceConstructor=e,this.promise=new e(g),this.promise[ie]||D(this.promise),Y(t)?(this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?b(this.promise,this._result):(this.length=this.length||0,this._enumerate(t),0===this._remaining&&b(this.promise,this._result))):C(this.promise,P())}function P(){return new Error("Array Methods must be provided an Array")}function U(e){return new B(this,e).promise}function F(e){var t=this;return new t(Y(e)?function(n,o){for(var i=e.length,r=0;r<i;r++)t.resolve(e[r]).then(n,o)}:function(e,t){return t(new TypeError("You must pass an array to race."))})}function j(e){var t=this,n=new t(g);return C(n,e),n}function W(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function G(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function q(e){this[ie]=L(),this._result=this._state=void 0,this._subscribers=[],g!==e&&("function"!=typeof e&&W(),this instanceof q?k(this,e):G())}function H(){var e=void 0;if("undefined"!=typeof o)e=o;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var n=e.Promise;if(n){var i=null;try{i=Object.prototype.toString.call(n.resolve())}catch(t){}if("[object Promise]"===i&&!n.cast)return}e.Promise=q}var V=void 0;V=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var Y=V,K=0,J=void 0,X=void 0,z=function(e,t){ne[K]=e,ne[K+1]=t,K+=2,2===K&&(X?X(p):oe())},Q="undefined"!=typeof window?window:void 0,$=Q||{},Z=$.MutationObserver||$.WebKitMutationObserver,ee="undefined"==typeof self&&"undefined"!=typeof t&&"[object process]"==={}.toString.call(t),te="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,ne=new Array(1e3),oe=void 0;oe=ee?s():Z?u():te?l():void 0===Q?f():d();var ie=Math.random().toString(36).substring(16),re=void 0,ae=1,se=2,ce=new w,ue=new w,le=0;return B.prototype._enumerate=function(e){for(var t=0;this._state===re&&t<e.length;t++)this._eachEntry(e[t],t)},B.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,o=n.resolve;if(o===h){var i=y(e);if(i===m&&e._state!==re)this._settledAt(e._state,t,e._result);else if("function"!=typeof i)this._remaining--,this._result[t]=e;else if(n===q){var r=new n(g);N(r,e,i),this._willSettleAt(r,t)}else this._willSettleAt(new n(function(t){return t(e)}),t)}else this._willSettleAt(o(e),t)},B.prototype._settledAt=function(e,t,n){var o=this.promise;o._state===re&&(this._remaining--,e===se?C(o,n):this._result[t]=n),0===this._remaining&&b(o,this._result)},B.prototype._willSettleAt=function(e,t){var n=this;R(e,void 0,function(e){return n._settledAt(ae,t,e)},function(e){return n._settledAt(se,t,e)})},q.all=U,q.race=F,q.resolve=h,q.reject=j,q._setScheduler=r,q._setAsap=a,q._asap=z,q.prototype={constructor:q,then:m,"catch":function(e){return this.then(null,e)}},q.polyfill=H,q.Promise=q,q})}).call(t,n(3),function(){return this}())},function(e,t){function n(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function i(e){if(l===setTimeout)return setTimeout(e,0);if((l===n||!l)&&setTimeout)return l=setTimeout,setTimeout(e,0);try{return l(e,0)}catch(t){try{return l.call(null,e,0)}catch(t){return l.call(this,e,0)}}}function r(e){if(d===clearTimeout)return clearTimeout(e);if((d===o||!d)&&clearTimeout)return d=clearTimeout,clearTimeout(e);try{return d(e)}catch(t){try{return d.call(null,e)}catch(t){return d.call(this,e)}}}function a(){h&&f&&(h=!1,f.length?m=f.concat(m):g=-1,m.length&&s())}function s(){if(!h){var e=i(a);h=!0;for(var t=m.length;t;){for(f=m,m=[];++g<t;)f&&f[g].run();g=-1,t=m.length}f=null,h=!1,r(e)}}function c(e,t){this.fun=e,this.array=t}function u(){}var l,d,p=e.exports={};!function(){try{l="function"==typeof setTimeout?setTimeout:n}catch(e){l=n}try{d="function"==typeof clearTimeout?clearTimeout:o}catch(e){d=o}}();var f,m=[],h=!1,g=-1;p.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];m.push(new c(e,t)),1!==m.length||h||i(s)},c.prototype.run=function(){this.fun.apply(null,this.array)},p.title="browser",p.browser=!0,p.env={},p.argv=[],p.version="",p.versions={},p.on=u,p.addListener=u,p.once=u,p.off=u,p.removeListener=u,p.removeAllListeners=u,p.emit=u,p.prependListener=u,p.prependOnceListener=u,p.listeners=function(e){return[]},p.binding=function(e){throw new Error("process.binding is not supported")},p.cwd=function(){return"/"},p.chdir=function(e){throw new Error("process.chdir is not supported")},p.umask=function(){return 0}},function(e,t){},function(e,t){window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;for(n=n<0?Math.ceil(n):Math.floor(n),n<0&&(n+=t);n<t;n++)if(n in this&&this[n]===e)return n;return-1}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,o;if(null===this)throw new TypeError("this is null or not defined");var i=Object(this),r=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),o=0;o<r;){var a;o in i&&(a=i[o],e.call(n,a,o,i)),o++}}),function(e){"use strict";e.console||(e.console={});for(var t,n,o=e.console,i=function(){},r=["memory"],a="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profiles,profileEnd,show,table,time,timeEnd,timeline,timelineEnd,timeStamp,trace,warn".split(",");t=r.pop();)o[t]||(o[t]={});for(;n=a.pop();)o[n]||(o[n]=i)}("undefined"==typeof window?this:window)},function(e,t,n){(function(t){e.exports=t.Modernizr=n(7)}).call(t,function(){return this}())},function(e,t){function n(e,t){return typeof e===t}function o(){var e,t,o,i,r,a,s;for(var c in g)if(g.hasOwnProperty(c)){if(e=[],t=g[c],t.name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(o=0;o<t.options.aliases.length;o++)e.push(t.options.aliases[o].toLowerCase());for(i=n(t.fn,"function")?t.fn():t.fn,r=0;r<e.length;r++)a=e[r],s=a.split("."),1===s.length?E[s[0]]=i:(!E[s[0]]||E[s[0]]instanceof Boolean||(E[s[0]]=new Boolean(E[s[0]])),E[s[0]][s[1]]=i),y.push((i?"":"no-")+s.join("-"))}}function i(){return"function"!=typeof document.createElement?document.createElement(arguments[0]):v?document.createElementNS.call(document,"http://www.w3.org/2000/svg",arguments[0]):document.createElement.apply(document,arguments)}function r(){var e=document.body;return e||(e=i(v?"svg":"body"),e.fake=!0),e}function a(e,t,n,o){var a,s,c,u,l="modernizr",d=i("div"),p=r();if(parseInt(n,10))for(;n--;)c=i("div"),c.id=o?o[n]:l+(n+1),d.appendChild(c);return a=i("style"),a.type="text/css",a.id="s"+l,(p.fake?p:d).appendChild(a),p.appendChild(d),a.styleSheet?a.styleSheet.cssText=e:a.appendChild(document.createTextNode(e)),d.id=l,p.fake&&(p.style.background="",p.style.overflow="hidden",u=h.style.overflow,h.style.overflow="hidden",h.appendChild(p)),s=t(d,e),p.fake?(p.parentNode.removeChild(p),h.style.overflow=u,h.offsetHeight):d.parentNode.removeChild(d),!!s}function s(e){return e.replace(/([a-z])-([a-z])/g,function(e,t,n){return t+n.toUpperCase()}).replace(/^-/,"")}function c(e,t){return!!~(""+e).indexOf(t)}function u(e,t){return function(){return e.apply(t,arguments)}}function l(e,t,o){var i;for(var r in e)if(e[r]in t)return o===!1?e[r]:(i=t[e[r]],n(i,"function")?u(i,o||t):i);return!1}function d(e){return e.replace(/([A-Z])/g,function(e,t){return"-"+t.toLowerCase()}).replace(/^ms-/,"-ms-")}function p(e,t){var n=e.length;if("CSS"in window&&"supports"in window.CSS){for(;n--;)if(window.CSS.supports(d(e[n]),t))return!0;return!1}if("CSSSupportsRule"in window){for(var o=[];n--;)o.push("("+d(e[n])+":"+t+")");return o=o.join(" or "),a("@supports ("+o+") { #modernizr { position: absolute; } }",function(e){return"absolute"==getComputedStyle(e,null).position})}}function f(e,t,o,r){function a(){l&&(delete C.style,delete C.modElem)}if(r=!n(r,"undefined")&&r,!n(o,"undefined")){var u=p(e,o);if(!n(u,"undefined"))return u}for(var l,d,f,m,h,g=["modernizr","tspan","samp"];!C.style&&g.length;)l=!0,C.modElem=i(g.shift()),C.style=C.modElem.style;for(f=e.length,d=0;d<f;d++)if(m=e[d],h=C.style[m],c(m,"-")&&(m=s(m)),void 0!==C.style[m]){if(r||n(o,"undefined"))return a(),"pfx"!=t||m;try{C.style[m]=o}catch(_){}if(C.style[m]!=h)return a(),"pfx"!=t||m}return a(),!1}function m(e,t,o,i,r){var a=e.charAt(0).toUpperCase()+e.slice(1),s=(e+" "+N.join(a+" ")+a).split(" ");return n(t,"string")||n(t,"undefined")?f(s,t,i,r):(s=(e+" "+O.join(a+" ")+a).split(" "),l(s,t,o))}var h=document.documentElement,g=[],_={_version:"3.3.1",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var n=this;setTimeout(function(){t(n[e])},0)},addTest:function(e,t,n){g.push({name:e,fn:t,options:n})},addAsyncTest:function(e){g.push({name:null,fn:e})}},E=function(){};E.prototype=_,E=new E;var y=[],v="svg"===h.nodeName.toLowerCase();E.addTest("inlinesvg",function(){var e=i("div");return e.innerHTML="<svg/>","http://www.w3.org/2000/svg"==("undefined"!=typeof SVGRect&&e.firstChild&&e.firstChild.namespaceURI)});var S=function(){function e(e,n){var o;return!!e&&(n&&"string"!=typeof n||(n=i(n||"div")),e="on"+e,o=e in n,!o&&t&&(n.setAttribute||(n=i("div")),n.setAttribute(e,""),o="function"==typeof n[e],void 0!==n[e]&&(n[e]=void 0),n.removeAttribute(e)),o)}var t=!("onblur"in document.documentElement);return e}();_.hasEvent=S;_.testStyles=a;E.addTest("oninput",function(){var e,t=i("input");if(t.setAttribute("oninput","return"),S("oninput",h)||"function"==typeof t.oninput)return!0;try{var n=document.createEvent("KeyboardEvent");e=!1;var o=function(t){e=!0,t.preventDefault(),t.stopPropagation()};n.initKeyEvent("keypress",!0,!0,window,!1,!1,!1,!1,0,"e".charCodeAt(0)),h.appendChild(t),t.addEventListener("input",o,!1),t.focus(),t.dispatchEvent(n),t.removeEventListener("input",o,!1),h.removeChild(t)}catch(r){e=!1}return e});var T="Moz O ms Webkit",N=_._config.usePrefixes?T.split(" "):[];_._cssomPrefixes=N;var I=function(e){var t,n=prefixes.length,o=window.CSSRule;if("undefined"!=typeof o){if(!e)return!1;if(e=e.replace(/^@/,""),t=e.replace(/-/g,"_").toUpperCase()+"_RULE",t in o)return"@"+e;for(var i=0;i<n;i++){var r=prefixes[i],a=r.toUpperCase()+"_"+t;if(a in o)return"@-"+r.toLowerCase()+"-"+e}return!1}};_.atRule=I;var O=_._config.usePrefixes?T.toLowerCase().split(" "):[];_._domPrefixes=O;var b={elem:i("modernizr")};E._q.push(function(){delete b.elem});var C={style:b.elem.style};E._q.unshift(function(){delete C.style}),_.testAllProps=m;var R=_.prefixed=function(e,t,n){return 0===e.indexOf("@")?I(e):(e.indexOf("-")!=-1&&(e=s(e)),t?m(e,t,n):m(e,"pfx"))};E.addTest("peerconnection",!!R("RTCPeerConnection",window)),o(),delete _.addTest,delete _.addAsyncTest;for(var x=0;x<E._q.length;x++)E._q[x]();e.exports=E},function(e,t,n){(function(t){e.exports=t.WebIM=n(9)}).call(t,function(){return this}())},function(e,t){var n={};n.Emoji={path:"static/img/faces/",map:{"[):]":"ee_1.png","[:D]":"ee_2.png","[;)]":"ee_3.png","[:-o]":"ee_4.png","[:p]":"ee_5.png","[(H)]":"ee_6.png","[:@]":"ee_7.png","[:s]":"ee_8.png","[:$]":"ee_9.png","[:(]":"ee_10.png","[:'(]":"ee_11.png","[:|]":"ee_12.png","[(a)]":"ee_13.png","[8o|]":"ee_14.png","[8-|]":"ee_15.png","[+o(]":"ee_16.png","[<o)]":"ee_17.png","[|-)]":"ee_18.png","[*-)]":"ee_19.png","[:-#]":"ee_20.png","[:-*]":"ee_21.png","[^o)]":"ee_22.png","[8-)]":"ee_23.png","[(|)]":"ee_24.png","[(u)]":"ee_25.png","[(S)]":"ee_26.png","[(*)]":"ee_27.png","[(#)]":"ee_28.png","[(R)]":"ee_29.png","[({)]":"ee_30.png","[(})]":"ee_31.png","[(k)]":"ee_32.png","[(F)]":"ee_33.png","[(W)]":"ee_34.png","[(D)]":"ee_35.png"}},n.config={isAutoLogin:!0,isWindowSDK:!1,isSandBox:!1,isDebug:!1,autoReconnectNumMax:2,autoReconnectInterval:2,isWebRTC:/WebKit/.test(navigator.userAgent)&&/^https\:$/.test(window.location.protocol),isHttpDNS:!1},e.exports=n},function(e,t,n){(function(t){e.exports=t._=n(11)}).call(t,function(){return this}())},function(e,t,n){var o,i;(function(){function n(e){function t(t,n,o,i,r,a){for(;r>=0&&r<a;r+=e){var s=i?i[r]:r;o=n(o,t[s],s,t)}return o}return function(n,o,i,r){o=N(o,r,4);var a=!w(n)&&T.keys(n),s=(a||n).length,c=e>0?0:s-1;return arguments.length<3&&(i=n[a?a[c]:c],c+=e),t(n,o,i,a,c,s)}}function r(e){return function(t,n,o){n=I(n,o);for(var i=x(t),r=e>0?0:i-1;r>=0&&r<i;r+=e)if(n(t[r],r,t))return r;return-1}}function a(e,t,n){return function(o,i,r){var a=0,s=x(o);if("number"==typeof r)e>0?a=r>=0?r:Math.max(r+s,a):s=r>=0?Math.min(r+1,s):r+s+1;else if(n&&r&&s)return r=n(o,i),o[r]===i?r:-1;if(i!==i)return r=t(m.call(o,a,s),T.isNaN),r>=0?r+a:-1;for(r=e>0?a:s-1;r>=0&&r<s;r+=e)if(o[r]===i)return r;return-1}}function s(e,t){var n=D.length,o=e.constructor,i=T.isFunction(o)&&o.prototype||d,r="constructor";for(T.has(e,r)&&!T.contains(t,r)&&t.push(r);n--;)r=D[n],r in e&&e[r]!==i[r]&&!T.contains(t,r)&&t.push(r)}var c=this,u=c._,l=Array.prototype,d=Object.prototype,p=Function.prototype,f=l.push,m=l.slice,h=d.toString,g=d.hasOwnProperty,_=Array.isArray,E=Object.keys,y=p.bind,v=Object.create,S=function(){},T=function(e){return e instanceof T?e:this instanceof T?void(this._wrapped=e):new T(e)};"undefined"!=typeof e&&e.exports&&(t=e.exports=T),t._=T,T.VERSION="1.8.3";var N=function(e,t,n){if(void 0===t)return e;switch(null==n?3:n){case 1:return function(n){return e.call(t,n)};case 2:return function(n,o){return e.call(t,n,o)};case 3:return function(n,o,i){return e.call(t,n,o,i)};case 4:return function(n,o,i,r){return e.call(t,n,o,i,r)}}return function(){return e.apply(t,arguments)}},I=function(e,t,n){return null==e?T.identity:T.isFunction(e)?N(e,t,n):T.isObject(e)?T.matcher(e):T.property(e)};T.iteratee=function(e,t){return I(e,t,1/0)};var O=function(e,t){return function(n){var o=arguments.length;if(o<2||null==n)return n;for(var i=1;i<o;i++)for(var r=arguments[i],a=e(r),s=a.length,c=0;c<s;c++){var u=a[c];t&&void 0!==n[u]||(n[u]=r[u])}return n}},b=function(e){if(!T.isObject(e))return{};if(v)return v(e);S.prototype=e;var t=new S;return S.prototype=null,t},C=function(e){return function(t){return null==t?void 0:t[e]}},R=Math.pow(2,53)-1,x=C("length"),w=function(e){var t=x(e);return"number"==typeof t&&t>=0&&t<=R};T.each=T.forEach=function(e,t,n){t=N(t,n);var o,i;if(w(e))for(o=0,i=e.length;o<i;o++)t(e[o],o,e);else{var r=T.keys(e);for(o=0,i=r.length;o<i;o++)t(e[r[o]],r[o],e)}return e},T.map=T.collect=function(e,t,n){t=I(t,n);for(var o=!w(e)&&T.keys(e),i=(o||e).length,r=Array(i),a=0;a<i;a++){var s=o?o[a]:a;r[a]=t(e[s],s,e)}return r},T.reduce=T.foldl=T.inject=n(1),T.reduceRight=T.foldr=n(-1),T.find=T.detect=function(e,t,n){var o;if(o=w(e)?T.findIndex(e,t,n):T.findKey(e,t,n),void 0!==o&&o!==-1)return e[o]},T.filter=T.select=function(e,t,n){var o=[];return t=I(t,n),T.each(e,function(e,n,i){t(e,n,i)&&o.push(e)}),o},T.reject=function(e,t,n){return T.filter(e,T.negate(I(t)),n)},T.every=T.all=function(e,t,n){t=I(t,n);for(var o=!w(e)&&T.keys(e),i=(o||e).length,r=0;r<i;r++){var a=o?o[r]:r;if(!t(e[a],a,e))return!1}return!0},T.some=T.any=function(e,t,n){t=I(t,n);for(var o=!w(e)&&T.keys(e),i=(o||e).length,r=0;r<i;r++){var a=o?o[r]:r;if(t(e[a],a,e))return!0}return!1},T.contains=T.includes=T.include=function(e,t,n,o){return w(e)||(e=T.values(e)),("number"!=typeof n||o)&&(n=0),T.indexOf(e,t,n)>=0},T.invoke=function(e,t){var n=m.call(arguments,2),o=T.isFunction(t);return T.map(e,function(e){var i=o?t:e[t];return null==i?i:i.apply(e,n)})},T.pluck=function(e,t){return T.map(e,T.property(t))},T.where=function(e,t){return T.filter(e,T.matcher(t))},T.findWhere=function(e,t){return T.find(e,T.matcher(t))},T.max=function(e,t,n){var o,i,r=-(1/0),a=-(1/0);if(null==t&&null!=e){e=w(e)?e:T.values(e);for(var s=0,c=e.length;s<c;s++)o=e[s],o>r&&(r=o)}else t=I(t,n),T.each(e,function(e,n,o){i=t(e,n,o),(i>a||i===-(1/0)&&r===-(1/0))&&(r=e,a=i)});return r},T.min=function(e,t,n){var o,i,r=1/0,a=1/0;if(null==t&&null!=e){e=w(e)?e:T.values(e);for(var s=0,c=e.length;s<c;s++)o=e[s],o<r&&(r=o)}else t=I(t,n),T.each(e,function(e,n,o){i=t(e,n,o),(i<a||i===1/0&&r===1/0)&&(r=e,a=i)});return r},T.shuffle=function(e){for(var t,n=w(e)?e:T.values(e),o=n.length,i=Array(o),r=0;r<o;r++)t=T.random(0,r),t!==r&&(i[r]=i[t]),i[t]=n[r];return i},T.sample=function(e,t,n){return null==t||n?(w(e)||(e=T.values(e)),e[T.random(e.length-1)]):T.shuffle(e).slice(0,Math.max(0,t))},T.sortBy=function(e,t,n){return t=I(t,n),T.pluck(T.map(e,function(e,n,o){return{value:e,index:n,criteria:t(e,n,o)}}).sort(function(e,t){var n=e.criteria,o=t.criteria;if(n!==o){if(n>o||void 0===n)return 1;if(n<o||void 0===o)return-1}return e.index-t.index}),"value")};var M=function(e){return function(t,n,o){var i={};return n=I(n,o),T.each(t,function(o,r){var a=n(o,r,t);e(i,o,a)}),i}};T.groupBy=M(function(e,t,n){T.has(e,n)?e[n].push(t):e[n]=[t]}),T.indexBy=M(function(e,t,n){e[n]=t}),T.countBy=M(function(e,t,n){T.has(e,n)?e[n]++:e[n]=1}),T.toArray=function(e){return e?T.isArray(e)?m.call(e):w(e)?T.map(e,T.identity):T.values(e):[]},T.size=function(e){return null==e?0:w(e)?e.length:T.keys(e).length},T.partition=function(e,t,n){t=I(t,n);var o=[],i=[];return T.each(e,function(e,n,r){(t(e,n,r)?o:i).push(e)}),[o,i]},T.first=T.head=T.take=function(e,t,n){if(null!=e)return null==t||n?e[0]:T.initial(e,e.length-t)},T.initial=function(e,t,n){return m.call(e,0,Math.max(0,e.length-(null==t||n?1:t)))},T.last=function(e,t,n){if(null!=e)return null==t||n?e[e.length-1]:T.rest(e,Math.max(0,e.length-t))},T.rest=T.tail=T.drop=function(e,t,n){return m.call(e,null==t||n?1:t)},T.compact=function(e){return T.filter(e,T.identity)};var A=function(e,t,n,o){for(var i=[],r=0,a=o||0,s=x(e);a<s;a++){var c=e[a];if(w(c)&&(T.isArray(c)||T.isArguments(c))){t||(c=A(c,t,n));var u=0,l=c.length;for(i.length+=l;u<l;)i[r++]=c[u++]}else n||(i[r++]=c)}return i};T.flatten=function(e,t){return A(e,t,!1)},T.without=function(e){return T.difference(e,m.call(arguments,1))},T.uniq=T.unique=function(e,t,n,o){T.isBoolean(t)||(o=n,n=t,t=!1),null!=n&&(n=I(n,o));for(var i=[],r=[],a=0,s=x(e);a<s;a++){var c=e[a],u=n?n(c,a,e):c;t?(a&&r===u||i.push(c),r=u):n?T.contains(r,u)||(r.push(u),i.push(c)):T.contains(i,c)||i.push(c)}return i},T.union=function(){return T.uniq(A(arguments,!0,!0))},T.intersection=function(e){for(var t=[],n=arguments.length,o=0,i=x(e);o<i;o++){var r=e[o];if(!T.contains(t,r)){for(var a=1;a<n&&T.contains(arguments[a],r);a++);a===n&&t.push(r)}}return t},T.difference=function(e){var t=A(arguments,!0,!0,1);return T.filter(e,function(e){return!T.contains(t,e)})},T.zip=function(){return T.unzip(arguments)},T.unzip=function(e){for(var t=e&&T.max(e,x).length||0,n=Array(t),o=0;o<t;o++)n[o]=T.pluck(e,o);return n},T.object=function(e,t){for(var n={},o=0,i=x(e);o<i;o++)t?n[e[o]]=t[o]:n[e[o][0]]=e[o][1];return n},T.findIndex=r(1),T.findLastIndex=r(-1),T.sortedIndex=function(e,t,n,o){n=I(n,o,1);for(var i=n(t),r=0,a=x(e);r<a;){var s=Math.floor((r+a)/2);n(e[s])<i?r=s+1:a=s}return r},T.indexOf=a(1,T.findIndex,T.sortedIndex),T.lastIndexOf=a(-1,T.findLastIndex),T.range=function(e,t,n){null==t&&(t=e||0,e=0),n=n||1;for(var o=Math.max(Math.ceil((t-e)/n),0),i=Array(o),r=0;r<o;r++,e+=n)i[r]=e;return i};var k=function(e,t,n,o,i){if(!(o instanceof t))return e.apply(n,i);var r=b(e.prototype),a=e.apply(r,i);return T.isObject(a)?a:r};T.bind=function(e,t){if(y&&e.bind===y)return y.apply(e,m.call(arguments,1));if(!T.isFunction(e))throw new TypeError("Bind must be called on a function");var n=m.call(arguments,2),o=function(){return k(e,o,t,this,n.concat(m.call(arguments)))};return o},T.partial=function(e){var t=m.call(arguments,1),n=function(){for(var o=0,i=t.length,r=Array(i),a=0;a<i;a++)r[a]=t[a]===T?arguments[o++]:t[a];for(;o<arguments.length;)r.push(arguments[o++]);return k(e,n,this,this,r)};return n},T.bindAll=function(e){var t,n,o=arguments.length;if(o<=1)throw new Error("bindAll must be passed function names");for(t=1;t<o;t++)n=arguments[t],e[n]=T.bind(e[n],e);return e},T.memoize=function(e,t){var n=function(o){var i=n.cache,r=""+(t?t.apply(this,arguments):o);return T.has(i,r)||(i[r]=e.apply(this,arguments)),i[r]};return n.cache={},n},T.delay=function(e,t){var n=m.call(arguments,2);return setTimeout(function(){return e.apply(null,n)},t)},T.defer=T.partial(T.delay,T,1),T.throttle=function(e,t,n){var o,i,r,a=null,s=0;n||(n={});var c=function(){s=n.leading===!1?0:T.now(),a=null,r=e.apply(o,i),a||(o=i=null)};return function(){var u=T.now();s||n.leading!==!1||(s=u);var l=t-(u-s);return o=this,i=arguments,l<=0||l>t?(a&&(clearTimeout(a),a=null),s=u,r=e.apply(o,i),a||(o=i=null)):a||n.trailing===!1||(a=setTimeout(c,l)),r}},T.debounce=function(e,t,n){var o,i,r,a,s,c=function(){var u=T.now()-a;u<t&&u>=0?o=setTimeout(c,t-u):(o=null,n||(s=e.apply(r,i),o||(r=i=null)))};return function(){r=this,i=arguments,a=T.now();var u=n&&!o;return o||(o=setTimeout(c,t)),u&&(s=e.apply(r,i),r=i=null),s}},T.wrap=function(e,t){return T.partial(t,e)},T.negate=function(e){return function(){return!e.apply(this,arguments)}},T.compose=function(){var e=arguments,t=e.length-1;return function(){for(var n=t,o=e[t].apply(this,arguments);n--;)o=e[n].call(this,o);return o}},T.after=function(e,t){return function(){if(--e<1)return t.apply(this,arguments)}},T.before=function(e,t){var n;return function(){return--e>0&&(n=t.apply(this,arguments)),e<=1&&(t=null),n}},T.once=T.partial(T.before,2);var L=!{toString:null}.propertyIsEnumerable("toString"),D=["valueOf","isPrototypeOf","toString","propertyIsEnumerable","hasOwnProperty","toLocaleString"];T.keys=function(e){if(!T.isObject(e))return[];if(E)return E(e);var t=[];for(var n in e)T.has(e,n)&&t.push(n);return L&&s(e,t),t},T.allKeys=function(e){if(!T.isObject(e))return[];var t=[];for(var n in e)t.push(n);return L&&s(e,t),t},T.values=function(e){for(var t=T.keys(e),n=t.length,o=Array(n),i=0;i<n;i++)o[i]=e[t[i]];return o},T.mapObject=function(e,t,n){t=I(t,n);for(var o,i=T.keys(e),r=i.length,a={},s=0;s<r;s++)o=i[s],a[o]=t(e[o],o,e);return a},T.pairs=function(e){for(var t=T.keys(e),n=t.length,o=Array(n),i=0;i<n;i++)o[i]=[t[i],e[t[i]]];return o},T.invert=function(e){for(var t={},n=T.keys(e),o=0,i=n.length;o<i;o++)t[e[n[o]]]=n[o];return t},T.functions=T.methods=function(e){var t=[];for(var n in e)T.isFunction(e[n])&&t.push(n);return t.sort()},T.extend=O(T.allKeys),T.extendOwn=T.assign=O(T.keys),T.findKey=function(e,t,n){t=I(t,n);for(var o,i=T.keys(e),r=0,a=i.length;r<a;r++)if(o=i[r],t(e[o],o,e))return o},T.pick=function(e,t,n){var o,i,r={},a=e;if(null==a)return r;T.isFunction(t)?(i=T.allKeys(a),o=N(t,n)):(i=A(arguments,!1,!1,1),o=function(e,t,n){return t in n},a=Object(a));for(var s=0,c=i.length;s<c;s++){var u=i[s],l=a[u];o(l,u,a)&&(r[u]=l)}return r},T.omit=function(e,t,n){if(T.isFunction(t))t=T.negate(t);else{var o=T.map(A(arguments,!1,!1,1),String);
t=function(e,t){return!T.contains(o,t)}}return T.pick(e,t,n)},T.defaults=O(T.allKeys,!0),T.create=function(e,t){var n=b(e);return t&&T.extendOwn(n,t),n},T.clone=function(e){return T.isObject(e)?T.isArray(e)?e.slice():T.extend({},e):e},T.tap=function(e,t){return t(e),e},T.isMatch=function(e,t){var n=T.keys(t),o=n.length;if(null==e)return!o;for(var i=Object(e),r=0;r<o;r++){var a=n[r];if(t[a]!==i[a]||!(a in i))return!1}return!0};var B=function(e,t,n,o){if(e===t)return 0!==e||1/e===1/t;if(null==e||null==t)return e===t;e instanceof T&&(e=e._wrapped),t instanceof T&&(t=t._wrapped);var i=h.call(e);if(i!==h.call(t))return!1;switch(i){case"[object RegExp]":case"[object String]":return""+e==""+t;case"[object Number]":return+e!==+e?+t!==+t:0===+e?1/+e===1/t:+e===+t;case"[object Date]":case"[object Boolean]":return+e===+t}var r="[object Array]"===i;if(!r){if("object"!=typeof e||"object"!=typeof t)return!1;var a=e.constructor,s=t.constructor;if(a!==s&&!(T.isFunction(a)&&a instanceof a&&T.isFunction(s)&&s instanceof s)&&"constructor"in e&&"constructor"in t)return!1}n=n||[],o=o||[];for(var c=n.length;c--;)if(n[c]===e)return o[c]===t;if(n.push(e),o.push(t),r){if(c=e.length,c!==t.length)return!1;for(;c--;)if(!B(e[c],t[c],n,o))return!1}else{var u,l=T.keys(e);if(c=l.length,T.keys(t).length!==c)return!1;for(;c--;)if(u=l[c],!T.has(t,u)||!B(e[u],t[u],n,o))return!1}return n.pop(),o.pop(),!0};T.isEqual=function(e,t){return B(e,t)},T.isEmpty=function(e){return null==e||(w(e)&&(T.isArray(e)||T.isString(e)||T.isArguments(e))?0===e.length:0===T.keys(e).length)},T.isElement=function(e){return!(!e||1!==e.nodeType)},T.isArray=_||function(e){return"[object Array]"===h.call(e)},T.isObject=function(e){var t=typeof e;return"function"===t||"object"===t&&!!e},T.each(["Arguments","Function","String","Number","Date","RegExp","Error"],function(e){T["is"+e]=function(t){return h.call(t)==="[object "+e+"]"}}),T.isArguments(arguments)||(T.isArguments=function(e){return T.has(e,"callee")}),"function"!=typeof/./&&"object"!=typeof Int8Array&&(T.isFunction=function(e){return"function"==typeof e||!1}),T.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))},T.isNaN=function(e){return T.isNumber(e)&&e!==+e},T.isBoolean=function(e){return e===!0||e===!1||"[object Boolean]"===h.call(e)},T.isNull=function(e){return null===e},T.isUndefined=function(e){return void 0===e},T.has=function(e,t){return null!=e&&g.call(e,t)},T.noConflict=function(){return c._=u,this},T.identity=function(e){return e},T.constant=function(e){return function(){return e}},T.noop=function(){},T.property=C,T.propertyOf=function(e){return null==e?function(){}:function(t){return e[t]}},T.matcher=T.matches=function(e){return e=T.extendOwn({},e),function(t){return T.isMatch(t,e)}},T.times=function(e,t,n){var o=Array(Math.max(0,e));t=N(t,n,1);for(var i=0;i<e;i++)o[i]=t(i);return o},T.random=function(e,t){return null==t&&(t=e,e=0),e+Math.floor(Math.random()*(t-e+1))},T.now=Date.now||function(){return(new Date).getTime()};var P={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","`":"&#x60;"},U=T.invert(P),F=function(e){var t=function(t){return e[t]},n="(?:"+T.keys(e).join("|")+")",o=RegExp(n),i=RegExp(n,"g");return function(e){return e=null==e?"":""+e,o.test(e)?e.replace(i,t):e}};T.escape=F(P),T.unescape=F(U),T.result=function(e,t,n){var o=null==e?void 0:e[t];return void 0===o&&(o=n),T.isFunction(o)?o.call(e):o};var j=0;T.uniqueId=function(e){var t=++j+"";return e?e+t:t},T.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var W=/(.)^/,G={"'":"'","\\":"\\","\r":"r","\n":"n","\u2028":"u2028","\u2029":"u2029"},q=/\\|'|\r|\n|\u2028|\u2029/g,H=function(e){return"\\"+G[e]};T.template=function(e,t,n){!t&&n&&(t=n),t=T.defaults({},t,T.templateSettings);var o=RegExp([(t.escape||W).source,(t.interpolate||W).source,(t.evaluate||W).source].join("|")+"|$","g"),i=0,r="__p+='";e.replace(o,function(t,n,o,a,s){return r+=e.slice(i,s).replace(q,H),i=s+t.length,n?r+="'+\n((__t=("+n+"))==null?'':_.escape(__t))+\n'":o?r+="'+\n((__t=("+o+"))==null?'':__t)+\n'":a&&(r+="';\n"+a+"\n__p+='"),t}),r+="';\n",t.variable||(r="with(obj||{}){\n"+r+"}\n"),r="var __t,__p='',__j=Array.prototype.join,print=function(){__p+=__j.call(arguments,'');};\n"+r+"return __p;\n";try{var a=new Function(t.variable||"obj","_",r)}catch(s){throw s.source=r,s}var c=function(e){return a.call(this,e,T)},u=t.variable||"obj";return c.source="function("+u+"){\n"+r+"}",c},T.chain=function(e){var t=T(e);return t._chain=!0,t};var V=function(e,t){return e._chain?T(t).chain():t};T.mixin=function(e){T.each(T.functions(e),function(t){var n=T[t]=e[t];T.prototype[t]=function(){var e=[this._wrapped];return f.apply(e,arguments),V(this,n.apply(T,e))}})},T.mixin(T),T.each(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=l[e];T.prototype[e]=function(){var n=this._wrapped;return t.apply(n,arguments),"shift"!==e&&"splice"!==e||0!==n.length||delete n[0],V(this,n)}}),T.each(["concat","join","slice"],function(e){var t=l[e];T.prototype[e]=function(){return V(this,t.apply(this._wrapped,arguments))}}),T.prototype.value=function(){return this._wrapped},T.prototype.valueOf=T.prototype.toJSON=T.prototype.value,T.prototype.toString=function(){return""+this._wrapped},o=[],i=function(){return T}.apply(t,o),!(void 0!==i&&(e.exports=i))}).call(this)},function(e,t){"use strict";function n(e){var t=Object.prototype.toString.call(e);return"object"==typeof e&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(t)&&"number"==typeof e.length&&(0===e.length||"object"==typeof e[0]&&e[0].nodeType>0)}function o(e,t){r(e,t)||(e.className+=" "+t)}function i(e,t){r(e,t)&&(e.className=(" "+e.className+" ").replace(new RegExp(" "+t+" ","g")," ").trim())}function r(e,t){return!!~(" "+e.className+" ").indexOf(" "+t+" ")}function a(e,t){if("function"==typeof t){var o,i,r,a=n(e)?e:[e],s=[];for(o=2,i=arguments.length;o<i;++o)s.push(arguments[o]);for(o=0,i=a.length;o<i;++o)(r=a[o])&&t.apply(null,[r].concat(s))}}function s(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent&&(e["_"+t]=function(){n.apply(e,arguments)},e.attachEvent("on"+t,e["_"+t]))}function c(e,t,n){var o="_"+t,i="on"+t;e.removeEventListener&&n?e.removeEventListener(t,n):e.detachEvent&&(e.detachEvent(i,e[o]),delete e[o])}function u(e,t){if(e){var n,o,i=document.createElement("div"),r=document.createDocumentFragment();for(i.innerHTML=t,n=i.childNodes,o=n[0];n.length>0;)r.appendChild(n[0]);return e.appendChild(r),o}}var l=/mobile/i.test(navigator.userAgent);e.exports={isTop:window.top===window.self,isNodeList:n,isAndroid:/android/i.test(navigator.userAgent),isQQBrowser:/MQQBrowser/i.test(navigator.userAgent),isIOS:/(iPad|iPhone|iPod)/i.test(navigator.userAgent),isMobile:l,click:l&&"ontouchstart"in window?"touchstart":"click",isBrowserMinimized:function(){return"hidden"===document.visibilityState||document.hidden},appendHTMLTo:u,appendHTMLToBody:function(e){return u(document.body,e)},createElementFromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes[0]},getBrief:function(e,t){return"string"!=typeof e?"":e.length>t?e.slice(0,t)+"...":e},formatDate:function(e,t){var n=e?new Date(e):new Date,o=t||"M月d日 hh:mm",i={"M+":n.getMonth()+1,"d+":n.getDate(),"h+":n.getHours(),"m+":n.getMinutes(),"s+":n.getSeconds()};/(y+)/.test(o)&&(o=o.replace(RegExp.$1,(n.getFullYear()+"").substr(4-RegExp.$1.length)));for(var r in i)new RegExp("("+r+")").test(o)&&(o=o.replace(RegExp.$1,1===RegExp.$1.length?i[r]:("00"+i[r]).substr((""+i[r]).length)));return o},filesizeFormat:function(e){var t,n,o=["B","KB","MB","GB","TB","PB","EB","ZB"];return e>0?(t=Math.floor(Math.log(e)/Math.log(1024)),n=(e/Math.pow(1024,t)).toFixed(2)+" "+o[t]):n=0===e?"0 B":"",n},uuid:function(){for(var e=[],t="0123456789abcdef",n=0;n<36;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},convertFalse:function(e){return e="undefined"==typeof e?"":e,"false"!==e&&e},removeDom:function(e){e&&(e.remove?e.remove():e.parentNode&&e.parentNode.removeChild(e))},live:function(e,t,n,o){var i=this,r=o||document;i.on(r,t,function(t){var o,i,a,s=t||window.event,c=s.target||s.srcElement,u=c.parentNode,l=r.querySelectorAll(e);for(o=0,i=l.length;o<i;++o)a=l[o],a===c?n.call(c,s):a===u&&n.call(u,s)})},on:function(e,t,n,o){t.split(" ").forEach(function(t){t&&a(e,s,t,n,o)})},off:function(e,t,n){t.split(" ").forEach(function(t){t&&a(e,c,t,n)})},one:function(e,t,n,o){if(e&&t){var i=function(){n.apply(this,arguments),c(e,t,i)};s(e,t,i,o)}},trigger:function(e,t){if(document.createEvent){var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!1),e.dispatchEvent(n)}else e.fireEvent("on"+t)},extend:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var o=t[n],i=Object.prototype.toString.call(o);void 0===o?e[n]=o:"[object Array]"===i?(e[n]=[],this.extend(e[n],o)):"[object Object]"===i?(e[n]={},this.extend(e[n],o)):e[n]=o}return e},addClass:function(e,t){return a(e,o,t),e},removeClass:function(e,t){return a(e,i,t),e},hasClass:function(e,t){return!!e&&r(e,t)},toggleClass:function(e,t,n){if(e&&t){var a="undefined"==typeof n?!r(e,t):n;a?o(e,t):i(e,t)}},getDataByPath:function(e,t){function n(){var e=o.shift();return"string"!=typeof e?i:"object"==typeof i&&null!==i?(i=i[e],n()):void 0}var o=t.split("."),i=e;return n()},query:function(e){var t=new RegExp("[?&]"+e+"=([^&]*)(?=&|$)"),n=t.exec(location.search);return n?n[1]:""},setStore:function(e,t){try{localStorage.setItem(e,t)}catch(n){}},getStore:function(e){try{return localStorage.getItem(e)}catch(t){}},clearStore:function(e){try{localStorage.removeItem(e)}catch(t){}},clearAllStore:function(){try{localStorage.clear()}catch(e){}},set:function(e,t,n){var o=new Date,i=o.getTime()+24*(n||30)*3600*1e3;o.setTime(i),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+";path=/;expires="+o.toGMTString()},get:function(e){var t=document.cookie.match("(^|;) ?"+encodeURIComponent(e)+"=([^;]*)(;|$)");return t?decodeURIComponent(t[2]):""},getAvatarsFullPath:function(e,t){if(e){e=e.replace(/^(https?:)?\/\/?/,"");var n=~e.indexOf("img-cn"),o=~e.indexOf("ossimages");return n&&!o?t+"/ossimages/"+e:"//"+e}},copy:function(e){return this.extend({},e)}}},function(e,t){e.exports={loadingSvg:['<div class="em-widget-loading">','<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70">','<circle opacity=".3" fill="none" stroke="#000" stroke-width="4" stroke-miterlimit="10" cx="35" cy="35" r="11"/>','<path fill="none" stroke="#E5E5E5" stroke-width="4" stroke-linecap="round" stroke-miterlimit="10" d="M24 35c0-6.1 4.9-11 11-11 2.8 0 5.3 1 7.3 2.8"/>',"</svg>","</div>"].join(""),agentStatusText:{Idle:"(离线)",Online:"(空闲)",Busy:"(忙碌)",Leave:"(离开)",Hidden:"(隐身)",Offline:"(离线)",Logout:"(离线)",Other:""},eventMessageText:{NOTE:"当前暂无客服在线，请您留下联系方式，稍后我们将主动联系您"},SYSTEM_EVENT_MSG_TEXT:{ServiceSessionCreatedEvent:"会话创建成功",ServiceSessionClosedEvent:"会话已结束",ServiceSessionTransferedEvent:"会话已被转接至其他客服",ServiceSessionTransferedToAgentQueueEvent:"会话转接中，请稍候",ServiceSessionOpenedEvent:"会话已被客服接起"},SYSTEM_EVENT:{SESSION_CREATED:"ServiceSessionCreatedEvent",SESSION_OPENED:"ServiceSessionOpenedEvent",SESSION_CLOSED:"ServiceSessionClosedEvent",SESSION_TRANSFERED:"ServiceSessionTransferedEvent",SESSION_TRANSFERING:"ServiceSessionTransferedToAgentQueueEvent",SESSION_RESTORED:"session.restored",SESSION_NOT_CREATED:"session.not.created",AGENT_INFO_UPDATE:"agent.info.update",OFFICIAL_ACCOUNT_SWITCHED:"official.account.switched",NEW_OFFICIAL_ACCOUNT_FOUND:"new.official.account.found",SYSTEM_OFFICIAL_ACCOUNT_UPDATED:"system.official.account.updated",OFFICIAL_ACCOUNT_LIST_GOT:"official.account.list.got",MARKETING_MESSAGE_RECEIVED:"marketing.message.received",SATISFACTION_EVALUATION_MESSAGE_RECEIVED:"satisfaction.evaluation.message.received",MESSAGE_PROMPT:"message.prompt",CHAT_WINDOW_OPENED:"chat.window.opened",CHAT_WINDOW_CLOSED:"chat.window.closed",IM_CONNECTION_OPENED:"im.connection.opened",OFFLINE:"offline",MESSAGE_SENT:"message.sent",MESSAGE_APPENDED:"message.appended"},themeMap:{"天空之城":"theme-1","丛林物语":"theme-2","红瓦洋房":"theme-3","鲜美橙汁":"theme-4","青草田间":"theme-5","湖光山色":"theme-6","冷峻山峰":"theme-7","月色池塘":"theme-8","天籁湖光":"theme-9","商务风格":"theme-10"},IM:{WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31},EVENTS:{NOTIFY:"notify",RECOVERY:"recoveryTitle",SHOW:"showChat",CLOSE:"closeChat",CACHEUSER:"setUser",DRAGREADY:"dragReady",DRAGEND:"dragEnd",SLIDE:"titleSlide",ONMESSAGE:"onMessage",ONSESSIONCLOSED:"onSessionClosed",EXT:"ext",TEXTMSG:"textmsg",ONREADY:"onready",ON_OFFDUTY:"onOffDuty",SET_ITEM:"setItem",UPDATE_URL:"updateURL",REQUIRE_URL:"requireURL",INIT_CONFIG:"initConfig",SHOW_IMG:"showIMG",RESIZE_IFRAME:"resizeIframe",ADD_PROMPT:"add.prompt",REMOVE_PROMPT:"remove.prompt"},GRAY_LIST_KEYS:["audioVideo","msgPredictEnable","waitListNumberEnable","agentInputStateEnable","noteCategory"],ERROR_MSG:{VISITOR_DOES_NOT_EXIST:"visitor does not exist.",SESSION_DOES_NOT_EXIST:"session does not exist."},SESSION_STATE:{WAIT:"Wait",PROCESSING:"Processing",TERMINAL:"Terminal",ABORT:"Abort",RESOLVED:"Resolved",PREPARE:"Prepare"},AGENT_ROLE:{AGENT:1,ROBOT:6},UPLOAD_FILESIZE_LIMIT:10485760,FIRST_CHANNEL_MESSAGE_TIMEOUT:1e4,FIRST_CHANNEL_IMG_MESSAGE_TIMEOUT:15e3,SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT:1,FIRST_CHANNEL_CONNECTION_TIMEOUT:2e4,HEART_BEAT_INTERVAL:6e4,SECOND_CHANNEL_MESSAGE_RECEIVE_INTERVAL:6e4,MESSAGE_PREDICT_MAX_LENGTH:100,MAX_TEXT_MESSAGE_LENGTH:1500,GET_HISTORY_MESSAGE_COUNT_EACH_TIME:10,AGENT_INPUT_STATE_INTERVAL:1e3,MESSAGE_TIME_SPAN_INTERVAL:6e4,for_block_only:null}},function(e,t){"use strict";function n(e,t,n){var o,i,r,a=!1,s=e.data;if("object"==typeof s)o=s;else if("string"==typeof s){try{o=JSON.parse(s)}catch(c){}if("object"!=typeof o)return}if(n&&n.length)for(i=0,r=n.length;i<r;i++)o.key===n[i]&&(a=!0,"function"==typeof t&&t(o));else"function"==typeof t&&t(o);if(!a&&n)for(i=0,r=n.length;i<r;i++)if("data"===n[i]){"function"==typeof t&&t(o);break}}var o=function(){var e=!0;try{window.postMessage({toString:function(){e=!1}},"*")}catch(t){}return e}(),i=function(e,t,n){return this instanceof i?(this.key=t,this.iframe=document.getElementById(e),this.origin=location.protocol+"//"+location.host,void(this.useObject=n)):new i(e)};i.prototype.send=function(e,t){return e.origin=this.origin,e.key=this.key,this.to?e.to=this.to:t&&(e.to=t),o&&(this.useObject||e.useObject)||(e=JSON.stringify(e)),this.iframe?this.iframe.contentWindow.postMessage(e,"*"):window.parent.postMessage(e,"*"),this},i.prototype.listen=function(e,t){var o=this;return window.addEventListener?window.addEventListener("message",function(i){n.call(o,i,e,t)},!1):window.attachEvent&&window.attachEvent("onmessage",function(i){n.call(o,i,e,t)}),this},e.exports=i},function(e,t){"use strict";var n=function(){},o=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},i=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}};e.exports=function(e){function t(){var e,t=l.status||0;if(4===l.readyState){if(200===t){if("text"===a)return void s(l.responseText,l);if("json"===a){try{e=JSON.parse(l.responseText),s(e,l)}catch(n){}return}return void s(l.response||l.responseText,l)}if("json"==a){try{e=JSON.parse(l.responseText),c(e,l,"服务器返回错误信息")}catch(n){c(l.responseText,l,"服务器返回错误信息")}return}return void c(l.responseText,l,"服务器返回错误信息")}0===l.readyState&&c(l.responseText,l,"服务器异常")}var r,a=e.dataType||"text",s=e.success||n,c=e.error||n,u=e.useXDomainRequestInIE,l=o()||i(),d=e.type||"GET",p=e.data||{},f="",m=e.headers||{},h=e.isFileUpload;if(u&&window.XDomainRequest)return l=new XDomainRequest,l.onload=function(){var e={};try{e=JSON.parse(l.responseText)}catch(t){}s(e,l)},l.ontimeout=function(){c(l.responseText,l,"XDomainRequest timeout.")},l.onerror=function(){c(l.responseText,l,"XDomainRequest error.")},l.open("POST",e.url),l.send(JSON.stringify(p)),l;if(l.onreadystatechange=t,"get"===d.toLowerCase()){for(var g in p)p.hasOwnProperty(g)&&(f+=g+"="+p[g]+"&");f=f?f.slice(0,-1):f,e.url+=(e.url.indexOf("?")>0?"&":"?")+(f?f+"&":f)+"_v="+(new Date).getTime()}else{if(h){var _=new FormData;return _.append("file",p.file),l.open("POST",e.url),l.setRequestHeader("Authorization",p.auth),l.send(_),l}p=JSON.stringify(p)}if(l.open(d,e.url),l.setRequestHeader){m["Content-Type"]=m["Content-Type"]||"application/json";for(r in m)m.hasOwnProperty(r)&&l.setRequestHeader(r,m[r])}return l.send(p),l}},function(e,t,n){function o(e){d.innerText=e,c.removeClass(l,"hide")}function i(){c.addClass(l,"hide")}function r(e){o(e),setTimeout(i,2e3)}function a(e){function t(){c.addClass(m,"hide")}function n(){c.removeClass(m,"hide")}function o(){c.toggle(m,"hide")}function i(){l(),t()}function r(){d()!==!1&&t()}e=e||{};var a,s,l,d,p=e.className,f=e.contentDom||"",m=c.createElementFromHTML('<div class="em-dialog hide"></div>');return p&&c.addClass(m,p),"string"==typeof f&&(f=c.createElementFromHTML(f)),f&&m.appendChild(f),document.body.appendChild(m),{addButton:function(e){e=e||{};var t=e.hideCancel,n=e.confirmText||"确定";l=e.cancel||u,d=e.confirm||u;var o=c.createElementFromHTML(['<div class="footer">','<button class="cancel-btn">取消</button>','<button class="confirm-btn bg-color"></button>',"</div>"].join(""));return a=o.querySelector(".cancel-btn"),s=o.querySelector(".confirm-btn"),s.innerText=n,t&&c.addClass(a,"hide"),m.appendChild(o),c.on(a,"click",i),c.on(s,"click",r),this},show:function(){return n(),this},hide:function(){return t(),this},toggle:function(){return o(),this},destroy:function(){c.off(a,"click",i),c.off(s,"click",r),c.removeDom(m)},el:m}}function s(e){var t=c.createElementFromHTML(["<div>",'<i class="icon-circle"><i class="icon-good"></i></i>',"<p></p>","</div>"].join(""));t.querySelector("p").innerText=e;var n=a({contentDom:t,className:"mini em-success-prompt"}).show();setTimeout(n.destroy,2e3)}var c=n(12),u=function(){},l=document.querySelector(".em-widget-error-prompt"),d=l.querySelector("span");e.exports={prompt:o,tip:r,createDialog:a,showSuccess:s}},function(e,t,n){function o(){z=new ee("cross-origin-iframe","data",(!0)),z.listen(function(e){var t,n,o,i=e.call,r=e.timespan,a=0===e.status;ne[i]&&ne[i][r]&&(t=ne[i][r],delete ne[i][r],n=t.success,o=t.error,a?"function"==typeof n&&n(e):"function"==typeof o&&o(e))},["api"])}function i(e,t,n,o){var i=Q.uuid();ne[e]=ne[e]||{},ne[e][i]={success:n,error:o},z.send({api:e,data:t,timespan:i,useObject:!0})}function r(){return new Promise(function(e,t){i("getCurrentServiceSession",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,imServiceNumber:X.toUser,id:X.user.username},function(t){e(t.data)},function(e){t(e)})})}function a(){return new Promise(function(e,t){var n=X.user.token;n?e(n):Z({url:location.protocol+"//"+X.restServer+"/"+X.orgName+"/"+X.appName+"/token",useXDomainRequestInIE:!0,dataType:"json",data:{grant_type:"password",username:X.user.username,password:X.user.password},type:"POST",success:function(t){var n=t.access_token;X.user.token=n,e(n)},error:function(e){t(e)}})})}function s(){return new Promise(function(e,t){X.isWebChannelConfig?e(X.notice):i("getSlogan",{tenantId:X.tenantId},function(t){var n=Q.getDataByPath(t,"data.0.optionValue"),o={enabled:!!n,content:n};e(o)},function(e){t(e)})})}function c(){return new Promise(function(e,t){X.isWebChannelConfig?e(X.themeName):i("getTheme",{tenantId:X.tenantId},function(t){var n=Q.getDataByPath(t,"data.0.optionValue");e(n)},function(e){t(e)})})}function u(e){return new Promise(function(t,n){i("getConfig",{configId:e},function(e){var n=Q.getDataByPath(e,"data.entity");t(n)},function(e){n(e)})})}function l(){return new Promise(function(e,t){te.projectId?e(te.projectId):a().then(function(n){i("getProject",{tenantId:X.tenantId,"easemob-target-username":X.toUser,"easemob-appkey":X.appKey.replace("#","%23"),"easemob-username":X.user.username,headers:{Authorization:"Easemob IM "+n}},function(n){var o=Q.getDataByPath(n,"data.entities.0.id");o?(te.projectId=o,e(o)):t("no project id exist.")},function(e){t(e)})})})}function d(){return new Promise(function(e,t){Promise.all([a(),l()]).then(function(n){var o=n[0],r=n[1];i("getNoteCategories",{tenantId:X.tenantId,"easemob-target-username":X.toUser,"easemob-appkey":X.appKey.replace("#","%23"),"easemob-username":X.user.username,headers:{Authorization:"Easemob IM "+o},projectId:r},function(t){var n=Q.getDataByPath(t,"data.entities");e(n)},function(e){t(e)})})})}function p(e){return new Promise(function(t,n){i("createTicket",{tenantId:X.tenantId,"easemob-target-username":X.toUser,"easemob-appkey":X.appKey.replace("#","%23"),"easemob-username":X.user.username,origin_type:"webim",headers:{Authorization:"Easemob IM "+e.token},projectId:e.projectId,subject:"",content:e.content,status_id:"",priority_id:"",category_id:e.category_id,creator:{name:e.name,avatar:"",email:e.mail,phone:e.phone,qq:"",company:"",description:""},attachments:null},function(e){isSending=!1,Q.getDataByPath(e,"data.id")?t():n("unknown errow.")},function(e){n(e)})})}function f(){return new Promise(function(e,t){te.visitorId?e(te.visitorId):a().then(function(n){i("getVisitorInfo",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,imServiceNumber:X.toUser,token:n},function(n){var o=Q.getDataByPath(n,"data.entity.userId");o?(te.visitorId=o,e(o)):t($.ERROR_MSG.VISITOR_DOES_NOT_EXIST)},function(e){t(e)})})})}function m(){return new Promise(function(e,t){Promise.all([f(),a()]).then(function(n){var o=n[0],r=n[1];i("getOfficalAccounts",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,visitorId:o,token:r},function(t){var n=Q.getDataByPath(t,"data.entities");_.isArray(n)?e(n):(e([]),console.error("unexpect data format: ",n))},function(e){t(e)})})["catch"](function(e){t(e)})})}function h(e,t){return new Promise(function(n,o){Promise.all([f(),a()]).then(function(r){var a=r[0],s=r[1];i("getOfficalAccountMessage",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,token:s,visitorId:a,officialAccountId:e,direction:"before",size:$.GET_HISTORY_MESSAGE_COUNT_EACH_TIME,startId:t},function(e){var t=Q.getDataByPath(e,"data.entities");_.isArray(t)?n(t):o("unexpect data format.")},function(e){o(e)})})["catch"](function(e){o(e)})})}function g(){return new Promise(function(e,t){i("getDutyStatus_2",{channelType:"easemob",originType:"webim",channelId:X.channelId,tenantId:X.tenantId,queueName:X.emgroup,agentUsername:X.agentName},function(t){e(!Q.getDataByPath(t,"data.entity"))},function(t){console.error("unable to get duty state: ",t),e(!0)})})}function E(){return new Promise(function(e,t){i("graylist",{},function(t){var n={},o=t.data||{};_.each($.GRAY_LIST_KEYS,function(e){n[e]=_.contains(o[e],+X.tenantId)}),e(n)},function(t){console.error("unable to get gray list: ",t),e({})})})}function y(){return new Promise(function(e,t){i("getRobertGreeting_2",{channelType:"easemob",originType:"webim",channelId:X.channelId,tenantId:X.tenantId,agentUsername:X.agentName,queueName:X.emgroup},function(t){e(t.data.entity||{})},function(e){t(e)})})}function v(){return new Promise(function(e,t){"boolean"==typeof te.isRobotOpen?e(te.isRobotOpen):i("getRobertIsOpen",{channelType:"easemob",originType:"webim",channelId:X.channelId,tenantId:X.tenantId,agentUsername:X.agentName,queueName:X.emgroup},function(t){var n=t.data.entity;te.isRobotOpen=n,e(n)},function(e){t(e)})})}function S(){return new Promise(function(e,t){i("getSystemGreeting",{tenantId:X.tenantId},function(t){e(t.data)},function(e){t(e)})})}function T(){return new Promise(function(e,t){i("getExSession_2",{username:X.user.username,orgName:X.orgName,appName:X.appName,imServiceNumber:X.toUser,channelType:"easemob",originType:"webim",channelId:X.channelId,queueName:X.emgroup,agentUsername:X.agentName,tenantId:X.tenantId},function(n){var o=Q.getDataByPath(n,"data.entity");o?e(o):t("unexpected data format.")},function(e){t(e)})})}function N(e){return new Promise(function(t,n){return X.user.token?void i("getAgentStatus",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,agentUserId:e,userName:X.user.username,token:X.user.token,imServiceNumber:X.toUser},function(e){t(Q.getDataByPath(e,"data.state"))},function(e){n(e)}):void t()})}function I(e){return new Promise(function(t,n){Promise.all([f(),a()]).then(function(o){var r=o[0],a=o[1];i("getLastSession",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,imServiceNumber:X.toUser,officialAccountId:e,userName:X.user.username,visitorId:r,token:a},function(e){var o=Q.getDataByPath(e,"data.entity");o?t(o):n($.ERROR_MSG.SESSION_DOES_NOT_EXIST)},function(e){n(e)})})["catch"](function(e){n(e)})})}function O(){return new Promise(function(e,t){i("getSkillgroupMenu",{tenantId:X.tenantId},function(t){e(Q.getDataByPath(t,"data.entities.0"))},function(e){t(e)})})}function b(e){return new Promise(function(t,n){a().then(function(o){i("reportVisitorAttributes",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,imServiceNumber:X.toUser,sessionId:e,userName:X.user.username,referer:document.referrer,token:o},function(e){t()},function(e){n(e)})})})}function C(e,t){return new Promise(function(n,o){Promise.all([f(),a()]).then(function(r){var a=r[0],s=r[1];i("messagePredict_2",{sessionId:e,visitor_user_id:a,content:t,timestamp:_.now(),orgName:X.orgName,appName:X.appName,userName:X.user.username,imServiceNumber:X.toUser,token:s},function(e){n()},function(e){o(e)})})})}function R(e){return new Promise(function(t,n){a().then(function(o){i("getAgentInputState",{username:X.user.username,orgName:X.orgName,appName:X.appName,tenantId:X.tenantId,serviceSessionId:e,token:o},function(e){t(e.data.entity)},function(e){n(e)})})})}function x(e,t){return new Promise(function(n,o){i("getWaitListNumber",{tenantId:X.tenantId,queueId:t,serviceSessionId:e},function(e){n(e.data.entity)},function(e){o(e)})})}function w(){return new Promise(function(e,t){i("getNickNameOption",{tenantId:X.tenantId},function(t){var n=Q.getDataByPath(t,"data.0.optionValue");e("true"===n)},function(e){t(e)})})}function M(e){return new Promise(function(t,n){a().then(function(o){i("closeServiceSession",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,token:X.user.token,serviceSessionId:e},function(e){t()},function(e){n(e)})})})}function A(){return new Promise(function(e,t){i("createVisitor",{orgName:X.orgName,appName:X.appName,imServiceNumber:X.toUser,tenantId:X.tenantId},function(n){var o=n.data;o?e(n.data):t("error when attempt to create webim visitor")},function(e){t(e)})})}function k(){return new Promise(function(e,t){i("getPassword",{userId:X.user.username,tenantId:X.tenantId},function(n){var o=n.data;o?e(o):t("unable to get password.")},function(e){t(e)})})}function L(){return new Promise(function(e,t){i("getRelevanceList",{tenantId:X.tenantId},function(n){var o=n.data;_.isArray(o)&&!_.isEmpty(o)?e(o):t("未创建关联")},function(e){t(e)})})}function D(e){return new Promise(function(t,n){i("deleteEvent",{userId:e},function(e){t()},function(e){n(e)})})}function B(e,t,n){return new Promise(function(o,r){i("reportEvent",{type:"VISIT_URL",tenantId:X.tenantId,url:e,userId:{type:t,id:n}},function(e){var t=e.data;t?o(t):r("unexpected resopnse data.")},function(e){r(e)})})}function P(){return new Promise(function(e,t){i("receiveMsgChannel",{orgName:X.orgName,appName:X.appName,easemobId:X.toUser,tenantId:X.tenantId,visitorEasemobId:X.user.username},function(n){var o=Q.getDataByPath(n,"data.status"),i=Q.getDataByPath(n,"data.entities");"OK"===o?e(i):t("unexpected response data.")},function(e){t(e)})})}function U(e,t){return new Promise(function(n,o){i("sendMsgChannel",{from:X.user.username,to:X.toUser,tenantId:X.tenantId,bodies:[e],ext:t,orgName:X.orgName,appName:X.appName,originType:"webim"},function(e){n(e.data)},function(e){o(e)})})}function F(e){return new Promise(function(t,n){a().then(function(o){i("uploadImgMsgChannel",{userName:X.user.username,tenantId:X.tenantId,file:e,auth:"Bearer "+o,orgName:X.orgName,appName:X.appName},function(e){t(e.data)},function(e){n(e)})})})}function j(e){return new Promise(function(t,n){Promise.all([f(),a()]).then(function(o){var r=o[0],a=o[1];i("reportMarketingTaskDelivered",{marketingTaskId:e,tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,token:a,visitor_id:r},function(e){var o=Q.getDataByPath(e,"data.status");"OK"===o?t():n("unexpected reaponse status."),t(e.data)},function(e){n(e)})})})}function W(e){return new Promise(function(t,n){Promise.all([f(),a()]).then(function(o){var r=o[0],a=o[1];i("reportMarketingTaskOpened",{marketingTaskId:e,tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,token:a,visitor_id:r},function(e){var o=Q.getDataByPath(e,"data.status");"OK"===o?t():n("unexpected reaponse status."),t(e.data)},function(e){n(e)})})})}function G(e){return new Promise(function(t,n){Promise.all([f(),a()]).then(function(o){var r=o[0],a=o[1];i("reportMarketingTaskReplied",{marketingTaskId:e,tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,token:a,visitor_id:r},function(e){var o=Q.getDataByPath(e,"data.status");"OK"===o?t():n("unexpected reaponse status."),t(e.data)},function(e){n(e)})})})}function q(e){return new Promise(function(t,n){a().then(function(o){i("getLatestMarketingTask",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,officialAccountId:e,userName:X.user.username,token:o},function(e){var n=Q.getDataByPath(e,"data.entity");t(n)},function(e){n(e)})})})}function H(){return new Promise(function(e,t){te.evaluationDegrees?e(te.evaluationDegrees):a().then(function(n){i("getEvaluationDegrees",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,token:n},function(n){var o=Q.getDataByPath(n,"data.entities");_.isArray(o)?(te.evaluationDegrees=o,e(o)):t("unexpected reaponse value.")},function(e){t(e)})})})}function V(e){return new Promise(function(t,n){te.appraiseTags[e]?t(te.appraiseTags[e]):a().then(function(o){i("getAppraiseTags",{tenantId:X.tenantId,orgName:X.orgName,appName:X.appName,userName:X.user.username,token:o,evaluateId:e},function(o){var i=Q.getDataByPath(o,"data.entities");i?(te.appraiseTags[e]=i,t(i)):n("unexpected reaponse value.")},function(e){n(e)})})})}function Y(){return new Promise(function(e,t){Z({url:"/v1/weixin/admin/appid",type:"GET",success:function(n){n?e(n):t("unexpected response value.")},error:function(e){t(e)}})})}function K(e,t,n){return new Promise(function(o,i){Z({url:"/v1/weixin/sns/userinfo/"+t+"/"+n+"?tenantId="+e,type:"GET",success:function(e){var t;try{t=JSON.parse(e)}catch(n){}t?o(t):i("unexpected response value.")},error:function(e){o(e)}})})}function J(e){return new Promise(function(t,n){Z({url:"/v1/webimplugin/visitors/wechat/"+[X.tenantId,X.orgName,X.appName,X.toUser,e].join("_")+"?tenantId="+X.tenantId,data:{orgName:X.orgName,appName:X.appName,imServiceNumber:X.toUser},type:"POST",success:function(e){var o;try{o=JSON.parse(e)}catch(i){}"OK"===(o&&o.status)?t(o.entity):n()},error:function(e){n()}})})}var X,z,Q=n(12),$=n(13),Z=n(15),ee=n(14),te={appraiseTags:{}},ne={};e.exports={getCurrentServiceSession:r,getToken:a,getNotice:s,getTheme:c,getConfig:u,getProjectId:l,createTicket:p,getVisitorId:f,getOfficalAccounts:m,getOfficalAccountMessage:h,getDutyStatus:g,getGrayList:E,getRobertGreeting:y,getRobertIsOpen:v,getSystemGreeting:S,getExSession:T,getAgentStatus:N,getLastSession:I,getSkillgroupMenu:O,getNoteCategories:d,reportVisitorAttributes:b,reportPredictMessage:C,getAgentInputState:R,getWaitListNumber:x,getNickNameOption:w,closeServiceSession:M,createVisitor:A,getPassword:k,getRelevanceList:L,deleteEvent:D,reportEvent:B,receiveMsgChannel:P,sendMsgChannel:U,uploadImgMsgChannel:F,reportMarketingTaskDelivered:j,reportMarketingTaskOpened:W,reportMarketingTaskReplied:G,getLatestMarketingTask:q,getEvaluationDegrees:H,
getAppraiseTags:V,getWechatComponentId:Y,getWechatProfile:K,createWechatImUser:J,initApiTransfer:o,api:i,setCacheItem:function(e,t){te[e]=t},clearCacheItem:function(e){te[e]=void 0},init:function(e){X=e}}},function(e,t,n){function o(e,t){var n=y.currentBrowsingURL;transfer.send({event:_.EVENTS.REQUIRE_URL}),n&&E.reportEvent(n,e,t).then(function(e){var t=e.type,n=e.userName,i=e.orgName,r=e.appName,a=e.message,d=e.agentNickname,f=e.agentAvatar||y.defaultAvatar;switch(m=!!a,t){case"OK":break;case"INIT_CALL":c()&&(n&&(p=i+"#"+r+"_"+n,u.stop(),u=new v(function(){o("VISITOR",p)},T)),s(),m?(transfer.send({event:_.EVENTS.ADD_PROMPT}),h=S({title:d,content:a,avatar:f,className:"cta-prompt bottom",replyCallback:function(){l(e),transfer.send({event:_.EVENTS.REMOVE_PROMPT})},closeCallback:function(){transfer.send({event:_.EVENTS.REMOVE_PROMPT})}})):l(e));break;default:throw"unexpected event type."}})}function i(e){l||(l=e),d||(d=y.config),g.isTop||(transfer.send({event:_.EVENTS.REQUIRE_URL}),d?u?u.start():d.user.username?a(d.user.username):r():console.error("not config yet."))}function r(){var e=d.guestId||g.uuid();transfer.send({event:_.EVENTS.SET_ITEM,data:{key:"guestId",value:e}}),u=new v(function(){o("GUEST",e)},T),u.start()}function a(e){E.getRelevanceList().then(function(t){var n=t[0],i=d.appKey.split("#");d.orgName=i[0]||n.orgName,d.appName=i[1]||n.appName,d.toUser=d.to||n.imServiceNumber,d.restServer=d.restServer||n.restDomain;var r=d.restServer?d.restServer.match(/vip\d/):"";r=r&&r.length?"-"+r[0]:"",d.xmppServer=d.xmppServer||"im-api"+r+".easemob.com",p=d.orgName+"#"+d.appName+"_"+e,u=new v(function(){o("VISITOR",p)},T),E.getCurrentServiceSession().then(function(e){f=!!e,!f&&u.start()})},function(e){throw e})}function s(){u&&u.stop(),p&&E.deleteEvent(p)}function c(){return u&&u.isStarted}var u,l,d,p,f,m,h,g=n(12),_=n(13),E=n(17),y=n(19),v=n(21),S=n(22),T=5e3;e.exports={startToReport:i,stopReporting:s,hasProcessingSession:function(){return f},hasCtaInvite:function(){return m},hideCtaPrompt:function(){h&&h.hide(),transfer.send({event:_.EVENTS.REMOVE_PROMPT})},isStarted:c}},function(e,t,n){var o=n(20),i={ctaEnable:!1,systemAgentAvatar:null,isChatWindowOpen:null,isAgentNicknameEnable:null,currentBrowsingURL:null,isInOfficeHours:!1,imgFileList:new o,hasHumanAgentOnline:!1,hasRobotAgentOnline:!1,officialAccountList:[],commandMessageToBeSendList:[],tenantAvatar:null,defaultAvatar:null,currentOfficialAccount:{},systemOfficialAccount:{}};e.exports=i},function(e,t){var n=function(){this.list={}};n.prototype.set=function(e,t){"undefined"==typeof this.list[e]&&(this.list[e]=t)},n.prototype.get=function(e){return this.list.hasOwnProperty(e)?this.list[e]:null},n.prototype.remove=function(e){"undefined"!=typeof this.list[e]&&delete this.list[e]},e.exports=n},function(e,t){var n=function(e,t){this.fn=e,this.isStarted=!1,this.timerHandler=null,this.interval=t};n.prototype.start=function(){this.isStarted||(this.isStarted=!0,setTimeout(this.fn,0),this.timerHandler=setInterval(this.fn,this.interval))},n.prototype.stop=function(){this.isStarted&&(this.isStarted=!1,clearInterval(this.timerHandler))},n.prototype.isStarted=function(){return this.isStarted},e.exports=n},function(e,t,n){function o(){h.off(l,"click",s),h.off(d,"click",a)}function i(){l=u.querySelector(".btn-close"),d=u.querySelector(".btn-reply"),h.on(l,"click",s),h.on(d,"click",a)}function r(){h.addClass(u,"hide")}function a(){r(),p(m)}function s(){r(),f(m)}function c(e){var t=e||{},n=t.avatar||"",o=t.title||"",i=t.content||"",r=t.className||"";return h.createElementFromHTML(['<div class="em-dialog '+r+'">','<span class="indicator bg-border-bottom-color"></span>','<div class="bg-color header">','<img class="avatar" src="'+n+'">','<span class="title">'+o+"</span>",'<span class="btn-close icon-close"></span>',"</div>",'<div class="body">','<p class="content">'+i+"</p>","</div>",'<div class="footer">','<button class="btn-reply bg-color icon-message">回复</button>',"</div>","</div>"].join(""))}var u,l,d,p,f,m,h=n(12),g=function(){};e.exports=function(e){var t=e||{},n=c(t);return p=t.replyCallback||g,f=t.closeCallback||g,m=t.callbackMessage||null,u?(o(),document.body.replaceChild(n,u)):document.body.appendChild(n),u=n,i(),{hide:r}}},function(e,t,n){function o(){w.add(C.SYSTEM_EVENT.SESSION_OPENED,i),w.add(C.SYSTEM_EVENT.SESSION_RESTORED,i),w.add(C.SYSTEM_EVENT.SATISFACTION_EVALUATION_MESSAGE_RECEIVED,function(e,t,n){e===A.currentOfficialAccount&&k.show(t,n)})}function i(e){if(!e.hasReportedAttributes){var t=e.sessionId,n=e.isSessionOpen;n&&t&&(e.hasReportedAttributes=!0,x.reportVisitorAttributes(t))}}function r(){(b.isTop||!I.minimum)&&b.removeClass(K.imChat,"hide"),document.querySelector(".em-widget-pop-bar").innerText=I.buttonText,b.isMobile&&b.addClass(document.body,"em-mobile"),I.ticket&&b.removeClass(K.noteBtn,"hide"),I.minimum&&!b.isTop&&b.removeClass(K.minifyBtn,"hide"),O.utils.isCanUploadFileAsync&&(b.removeClass(K.sendImgBtn,"hide"),b.removeClass(K.sendFileBtn,"hide")),I.ui.H5Title.enabled&&(document.title=I.ui.H5Title.content),window.HTMLAudioElement&&!b.isMobile&&I.soundReminder&&b.removeClass(K.audioBtn,"hide"),b.isMobile&&!I.hideKeyboard&&b.removeClass(K.switchKeyboardBtn,"hide"),I.satisfaction&&b.removeClass(K.satisfaction,"hide")}function a(){if(window.HTMLAudioElement&&!b.isMobile&&I.soundReminder){var e=document.createElement("audio"),t=document.querySelector(".em-widget-header .btn-audio"),n=!1,o=_.throttle(function(){e.play()},3e3,{trailing:!1});e.src=I.staticPath+"/mp3/msg.m4a",b.on(t,"click",function(){n=!n,b.toggleClass(t,"icon-slience",n),b.toggleClass(t,"icon-bell",!n)}),w.add(C.SYSTEM_EVENT.MESSAGE_PROMPT,function(){!n&&o()})}}function s(){if(I.logo.enabled){var e=document.querySelector(".em-widget-tenant-logo"),t=e.querySelector("img");b.removeClass(e,"hide"),t.src=I.logo.url}}function c(){var e=document.querySelector(".em-widget-tip .content"),t=document.querySelector(".em-widget-tip .tip-close");x.getNotice().then(function(n){if(n.enabled){var o=n.content;e.innerHTML=O.utils.parseLink(o),b.addClass(K.imChat,"has-tip"),b.on(t,b.click,function(){b.removeClass(K.imChat,"has-tip")})}})}function u(){function e(){var e=O.Emoji.path,t=7;return _.chain(O.Emoji.map).map(function(t,n){return'<div class="em-bar-emoji-bg e-face"><img class="e-face emoji" src="'+e+t+'" data-value='+n+" /></div>"}).groupBy(function(e,n){return Math.floor(n/t)}).map(function(e){return'<li class="e-face">'+e.join("")+"</li>"}).value().join("")}b.on(K.emojiBtn,b.click,function(){K.textInput.blur(),b.toggleClass(K.emojiWrapper,"hide"),T||(T=!0,K.emojiContainer.innerHTML=e())}),b.live("img.emoji",b.click,function(e){!b.isMobile&&K.textInput.focus(),K.textInput.value+=this.getAttribute("data-value"),b.trigger(K.textInput,"change")},K.emojiWrapper),b.on(document,b.click,function(e){var t=window.event||e,n=t.srcElement||t.target;b.hasClass(n,"e-face")||b.addClass(K.emojiWrapper,"hide")})}function l(){switch(I.offDutyType){case"none":var e=b.createElementFromHTML('<div class="em-model"></div>'),t=b.createElementFromHTML(['<div class="em-dialog off-duty-prompt">','<div class="bg-color header">提示</div>','<div class="body">','<p class="content">'+I.offDutyWord+"</p>","</div>","</div>"].join(""));K.imChat.appendChild(e),K.imChat.appendChild(t),K.sendBtn.innerHTML="发送";break;default:D({hideCloseBtn:!0})}transfer.send({event:C.EVENTS.ON_OFFDUTY})}function d(){var e=b.getDataByPath(A,"currentOfficialAccount.messageView.scrollToBottom");"function"==typeof e&&e()}function p(){function e(){var e=this.value?this.scrollHeight:o;this.style.height=e+"px",this.scrollTop=9999,t()}function t(){var e=K.editorView.getBoundingClientRect().height;"up"===n?(K.emojiWrapper.style.top=43+e+"px",K.queuingNumberStatus.style.top=e+"px"):(K.chatWrapper.style.bottom=e+"px",K.emojiWrapper.style.bottom=e+"px"),d()}var n,o=K.textInput.clientHeight;b.on(K.switchKeyboardBtn,"click",function(){var e=b.hasClass(this,"icon-keyboard-down"),t=K.editorView.getBoundingClientRect().height;switch(n=e?"down":"up",b.toggleClass(this,"icon-keyboard-up",e),b.toggleClass(this,"icon-keyboard-down",!e),n){case"up":K.editorView.style.bottom="auto",K.editorView.style.zIndex="3",K.editorView.style.top="43px",K.chatWrapper.style.bottom="0",K.emojiWrapper.style.bottom="auto",K.emojiWrapper.style.top=43+t+"px",K.queuingNumberStatus.style.top=t+"px";break;case"down":K.editorView.style.bottom="0",K.editorView.style.zIndex="3",K.editorView.style.top="auto",K.chatWrapper.style.bottom=t+"px",K.emojiWrapper.style.bottom=t+"px",K.emojiWrapper.style.top="auto",K.queuingNumberStatus.style.top="-26px",d()}}),b.on(K.textInput,"input change",e)}function f(){return new Promise(function(e,t){x.getOfficalAccounts().then(function(t){_.each(t,M.attemptToAppendOfficialAccount),A.ctaEnable||(A.currentOfficialAccount=A.systemOfficialAccount,A.systemOfficialAccount.messageView.show()),w.excuteCallbacks(C.SYSTEM_EVENT.OFFICIAL_ACCOUNT_LIST_GOT,[]),e()},function(n){n===C.ERROR_MSG.VISITOR_DOES_NOT_EXIST?(M.attemptToAppendOfficialAccount({type:"SYSTEM",official_account_id:"default",img:null}),A.currentOfficialAccount=A.systemOfficialAccount,A.systemOfficialAccount.messageView.show(),w.excuteCallbacks(C.SYSTEM_EVENT.SESSION_NOT_CREATED,[A.systemOfficialAccount]),e()):t(n)})})}function m(){function e(){var e=!K.textInput.value.trim();b.toggleClass(K.sendBtn,"disabled",!N||e),A.grayList.msgPredictEnable&&!e&&N&&t(K.textInput.value)}b.isTop||(b.on(K.minifyBtn,"click",function(){transfer.send({event:C.EVENTS.CLOSE})}),b.on(document,"mouseover",function(){transfer.send({event:C.EVENTS.RECOVERY})})),b.on(K.chatWrapper,"click",function(){K.textInput.blur()}),b.live("img.em-widget-imgview","click",function(){var e=this.getAttribute("src");L.show(e)}),!I.dragenable||b.isTop||b.isMobile||(K.dragBar.style.cursor="move",b.on(K.dragBar,"mousedown",function(e){var t=window.event||e;return K.textInput.blur(),transfer.send({event:C.EVENTS.DRAGREADY,data:{x:t.clientX,y:t.clientY}}),!1},!1)),b.live("div.em-widget-msg-status","click",function(){var e=this.getAttribute("id").slice(0,-"_failed".length),t=this.getAttribute("data-type");M.reSend(t,e),b.addClass(this,"hide"),b.removeClass(document.getElementById(e+"_loading"),"hide")}),b.live("button.js_robotTransferBtn","click",function(){var e=this.getAttribute("data-id"),t=this.getAttribute("data-sessionid");this.clicked||(this.clicked=!0,M.sendTransferToKf(e,t))}),b.live("button.js-transfer-to-ticket","click",function(){var e=A.currentOfficialAccount;if(e){var t=e.isSessionOpen,n=e.sessionId;t&&x.closeServiceSession(n),D({preData:{name:I.visitor.trueName,phone:I.visitor.phone,mail:I.visitor.email,content:b.getBrief("\n"+e.messageView.getRecentMsg(10),1e3)}})}}),b.live("button.js_robotbtn","click",function(){M.sendText(this.innerText,{ext:{msgtype:{choice:{menuid:this.getAttribute("data-id")}}}})}),b.live("button.js_skillgroupbtn","click",function(){M.sendText(this.innerText,{ext:{weichat:{queueName:this.getAttribute("data-queue-name")}}})}),b.live("button.js_satisfybtn","click",function(){var e=this.getAttribute("data-servicesessionid"),t=this.getAttribute("data-inviteid");k.show(t,e)});var t=_.throttle(function(e){var t=A.currentOfficialAccount||{},n=t.sessionId,o=t.sessionState,i=t.agentType,r=b.getBrief(e,C.MESSAGE_PREDICT_MAX_LENGTH);o===C.SESSION_STATE.PROCESSING&&i!==C.AGENT_ROLE.ROBOT&&n&&x.reportPredictMessage(n,r)},1e3);Modernizr.oninput?b.on(K.textInput,"input change",e):b.on(K.textInput,"keyup change",e),b.isMobile&&b.on(K.textInput,"focus touchstart",function(){K.textInput.style.overflowY="auto",d()}),b.on(K.fileInput,"change",function(){var e=K.fileInput,t=b.getDataByPath(e,"files.0.size");e.value&&(t>C.UPLOAD_FILESIZE_LIMIT?(R.tip("文件大小不能超过10MB"),e.value=""):M.sendFile(O.utils.getFileUrl(e),e))}),b.isQQBrowser&&b.isAndroid&&K.imgInput.setAttribute("accept","image/*"),b.on(K.imgInput,"change",function(){var e=K.imgInput,t=b.getDataByPath(e,"files.0.size");e.value&&(t>C.UPLOAD_FILESIZE_LIMIT?(R.tip("文件大小不能超过10MB"),e.value=""):M.sendImg(O.utils.getFileUrl(e),e))}),b.on(K.sendFileBtn,"click",function(){N?K.fileInput.click():R.tip("正在连接中...")}),b.on(K.sendImgBtn,"click",function(){N?K.imgInput.click():R.tip("正在连接中...")}),b.on(K.noteBtn,"click",function(){D()}),b.on(K.satisfaction,"click",function(){K.textInput.blur(),k.show()}),b.on(K.textInput,"keydown",function(e){13!==e.keyCode||b.isMobile||e.ctrlKey||e.shiftKey||(e.preventDefault&&e.preventDefault(),b.trigger(K.sendBtn,"click"))}),b.on(K.sendBtn,"click",function(){var e=K.textInput.value;b.hasClass(this,"disabled")||(e.length>C.MAX_TEXT_MESSAGE_LENGTH?R.tip("输入字数过多"):(M.sendText(e),K.textInput.value="",b.trigger(K.textInput,"change")))})}function h(){A.isChatWindowOpen=!1,I.hide||(b.addClass(K.imChat,"hide"),b.removeClass(K.imBtn,"hide")),w.excuteCallbacks(C.SYSTEM_EVENT.CHAT_WINDOW_CLOSED,[])}function g(){A.isChatWindowOpen=!0,b.addClass(K.imBtn,"hide"),b.removeClass(K.imChat,"hide"),d(),A.isInOfficeHours&&K.textInput.offsetHeight>0&&K.textInput.focus(),transfer.send({event:C.EVENTS.RECOVERY}),w.excuteCallbacks(C.SYSTEM_EVENT.CHAT_WINDOW_OPENED,[])}function E(){if(!N){for(N=!0,K.sendBtn.innerHTML="发送",b.trigger(K.textInput,"change"),I.minimum!==!1&&I.eventCollector!==!0||transfer.send({event:C.EVENTS.SHOW});A.commandMessageToBeSendList.length>0;)M.sendText("",A.commandMessageToBeSendList.pop());transfer.send({event:C.EVENTS.ONREADY}),I.extMsg&&M.sendText("",{ext:I.extMsg})}}function y(){return new Promise(function(e,t){M.initConnection(function(t){t&&(I.user.token=I.user.token||t.accessToken),e()})})}function v(){I=A.config,M.init(),A.isChatWindowOpen=!0,a(),r(),u(),m(),G(),S()}function S(){Promise.all([x.getDutyStatus(),x.getGrayList(),x.getToken()]).then(function(e){var t=e[0],n=e[1];A.grayList=n,A.isInOfficeHours=t||"chat"===I.offDutyType,A.isInOfficeHours?(P.initEventListener(),Promise.all([f(),y()]).then(E),x.getExSession().then(function(e){A.hasHumanAgentOnline=e.onlineHumanAgentCount>0,A.hasRobotAgentOnline=e.onlineRobotAgentCount>0}),x.getNickNameOption().then(function(e){A.isAgentNicknameEnable=e}),o(),U(),F(),j(),W(),H(),q(),M.initSecondChannle(),B(),s(),c(),b.isMobile&&p()):l()},function(e){if("user not found"!==e.error_description||!I.isUsernameFromCookie)throw e;J()})}var T,N,I,O=n(24),b=n(12),C=n(13),R=n(16),x=n(17),w=n(30),M=n(31),A=n(19),k=n(34),L=n(35),D=n(36),B=n(38),P=n(39),U=n(40),F=n(41),j=n(42),W=n(43),G=n(44),q=n(48),H=n(49),V=document.querySelector(".em-widget-header"),Y=document.querySelector(".em-widget-send-wrapper"),K={imBtn:document.getElementById("em-widgetPopBar"),imChat:document.getElementById("em-kefu-webim-chat"),agentStatusText:V.querySelector(".em-header-status-text"),dragBar:V.querySelector(".drag-bar"),minifyBtn:V.querySelector(".btn-min"),audioBtn:V.querySelector(".btn-audio"),switchKeyboardBtn:V.querySelector(".btn-keyboard"),emojiBtn:Y.querySelector(".em-bar-emoji"),sendImgBtn:Y.querySelector(".em-widget-img"),sendFileBtn:Y.querySelector(".em-widget-file"),sendBtn:Y.querySelector(".em-widget-send"),satisfaction:Y.querySelector(".em-widget-satisfaction"),textInput:Y.querySelector(".em-widget-textarea"),noteBtn:Y.querySelector(".em-widget-note"),queuingNumberStatus:Y.querySelector(".queuing-number-status"),imgInput:document.querySelector(".upload-img-container"),fileInput:document.querySelector(".upload-file-container"),emojiContainer:document.querySelector(".em-bar-emoji-container"),chatWrapper:document.querySelector(".chat-wrapper"),emojiWrapper:document.querySelector(".em-bar-emoji-wrapper"),topBar:V,editorView:Y,block:null},J=_.once(function(){console.warn("user not found in current appKey, attempt to recreate user."),x.createVisitor().then(function(e){if(I.user.username=e.userId,I.user.password=e.userPassword,S(),b.isTop)b.set("root"+(I.configId||I.tenantId+I.emgroup),I.user.username);else{var t=I.configId||I.to+I.tenantId+I.emgroup;transfer.send({event:C.EVENTS.CACHEUSER,data:{key:t,value:I.user.username}})}})});e.exports=chat={doms:K,init:v,close:h,show:g}},function(e,t,n){e.exports=n(25)},function(module,exports,__webpack_require__){function _parsePrivacy(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],r=i.getAttribute("value"),a=i.getAttribute("order"),s=i.getAttribute("type");if(r){var c=_parseNameFromJidFn(r);t[c]={type:s,order:a,jid:r,name:c}}}return t}function _parseGroupBlacklist(e){var t={},n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],r=i.getAttribute("jid"),a=i.getAttribute("affiliation"),s=i.getAttribute("nick");if(r){var c=_parseNameFromJidFn(r);t[c]={jid:r,affiliation:a,nick:s,name:c}}}return t}function _setText(e,t){"textContent"in e?e.textContent=t:"text"in e&&(e.text=t)}var _version="1.4.2",_code=__webpack_require__(26).code,_utils=__webpack_require__(27).utils,_msg=__webpack_require__(28),_message=_msg._msg,_msgHash={},Queue=__webpack_require__(29).Queue;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.XDomainRequest&&(XDomainRequest.prototype.oldsend=XDomainRequest.prototype.send,XDomainRequest.prototype.send=function(){XDomainRequest.prototype.oldsend.apply(this,arguments),this.readyState=2}),Strophe.Request.prototype._newXHR=function(){var e=_utils.xmlrequest(!0);return e.overrideMimeType&&e.overrideMimeType("text/xml"),e.onreadystatechange=this.func.bind(null,this),e},Strophe.Websocket.prototype._closeSocket=function(){if(this.socket){var e=this;setTimeout(function(){try{e.socket.close()}catch(t){}},0)}else this.socket=null},Strophe.Websocket.prototype._onMessage=function(e){WebIM&&WebIM.config.isDebug&&console.log(WebIM.utils.ts()+"recv:",e.data);var t,n;if(0===e.data.indexOf("<close ")){t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement;var o=t.getAttribute("see-other-uri");return void(o?(this._conn._changeConnectStatus(Strophe.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=o,this._connect()):this._conn._doDisconnect("receive <close> from server"))}if(0===e.data.search("<open ")){if(t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement,!this._handleStreamStart(t))return}else n=this._streamWrap(e.data),t=(new DOMParser).parseFromString(n,"text/xml").documentElement;if(!this._check_streamerror(t,Strophe.Status.ERROR))return this._conn.disconnecting&&"presence"===t.firstChild.nodeName&&"unavailable"===t.firstChild.getAttribute("type")?(this._conn.xmlInput(t),void this._conn.rawInput(Strophe.serialize(t))):void this._conn._dataRecv(t,e.data)};var _listenNetwork=function(e,t){window.addEventListener?(window.addEventListener("online",e),window.addEventListener("offline",t)):window.attachEvent&&(document.body?(document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)):window.attachEvent("load",function(){document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)}))},_parseRoom=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],r=i.getAttribute("jid"),a=r.split("@")[0],s={jid:r,name:i.getAttribute("name"),roomId:a.split("_")[1]};t.push(s)}return t},_parseRoomOccupants=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],r={jid:i.getAttribute("jid"),name:i.getAttribute("name")};t.push(r)}return t},_parseResponseMessage=function(msginfo){var parseMsgData={errorMsg:!0,data:[]},msgBodies=msginfo.getElementsByTagName("body");if(msgBodies){for(var i=0;i<msgBodies.length;i++){var msgBody=msgBodies[i],childNodes=msgBody.childNodes;if(childNodes&&childNodes.length>0){var childNode=msgBody.childNodes[0];if(childNode.nodeType==Strophe.ElementType.TEXT){var jsondata=childNode.wholeText||childNode.nodeValue;jsondata=jsondata.replace("\n","<br>");try{var data=eval("("+jsondata+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}}var delayTags=msginfo.getElementsByTagName("delay");if(delayTags&&delayTags.length>0){var delayTag=delayTags[0],delayMsgTime=delayTag.getAttribute("stamp");delayMsgTime&&(parseMsgData.delayTimeStamp=delayMsgTime)}}else{var childrens=msginfo.childNodes;if(childrens&&childrens.length>0){var child=msginfo.childNodes[0];if(child.nodeType==Strophe.ElementType.TEXT)try{var data=eval("("+child.nodeValue+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}return parseMsgData},_parseNameFromJidFn=function(e,t){t=t||"";var n=e,o=n.indexOf("_");o!==-1&&(n=n.substring(o+1));var i=n.indexOf("@"+t);return i!==-1&&(n=n.substring(0,i)),n},_parseFriend=function(e,t,n){var o=[],i=e.getElementsByTagName("item");if(i)for(var r=0;r<i.length;r++){var a=i[r],s=a.getAttribute("jid");if(s){var c=a.getAttribute("subscription"),u={subscription:c,jid:s},l=a.getAttribute("ask");l&&(u.ask=l);var d=a.getAttribute("name");if(d)u.name=d;else{var p=_parseNameFromJidFn(s);u.name=p}var f=[];Strophe.forEachChild(a,"group",function(e){f.push(Strophe.getText(e))}),u.groups=f,o.push(u),t&&"from"==c&&t.subscribe({toJid:s}),t&&"to"==c&&t.subscribed({toJid:s})}}return o},_login=function(e,t){var n=e.access_token||"";if(""==n){_utils.stringify(e);return void t.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:e})}t.context.accessToken=e.access_token,t.context.accessTokenExpires=e.expires_in;var o=null;o=t.isOpening()&&t.context.stropheConn?t.context.stropheConn:t.isOpened()&&t.context.stropheConn?t.getStrophe():t.getStrophe();var i=function(e,n){_loginCallback(e,n,t)};t.context.stropheConn=o,t.route?o.connect(t.context.jid,"$t$"+n,i,t.wait,t.hold,t.route):o.connect(t.context.jid,"$t$"+n,i,t.wait,t.hold)},_parseMessageType=function(e){var t="normal",n=e.getElementsByTagName("received");if(n&&n.length>0&&"urn:xmpp:receipts"===n[0].namespaceURI)t="received";else{var o=e.getElementsByTagName("invite");o&&o.length>0&&(t="invite")}return t},_handleMessageQueue=function(e){for(var t in _msgHash)_msgHash.hasOwnProperty(t)&&_msgHash[t].send(e)},_loginCallback=function(e,t,n){var o,i;if("conflict"===t&&(o=!0),e==Strophe.Status.CONNFAIL)i={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},o&&(i.conflict=!0),n.onError(i);else if(e==Strophe.Status.ATTACHED||e==Strophe.Status.CONNECTED){n.intervalId=setInterval(function(){n.handelSendQueue()},200);var r=function(e){var t=_parseMessageType(e);return"received"===t?(n.handleReceivedMessage(e),!0):"invite"===t?(n.handleInviteMessage(e),!0):(n.handleMessage(e),!0)},a=function(e){return n.handlePresence(e),!0},s=function(e){return n.handlePing(e),!0},c=function(e){return n.handleIqRoster(e),!0},u=function(e){return n.handleIqPrivacy(e),!0},l=function(e){return n.handleIq(e),!0};n.addHandler(r,null,"message",null,null,null),n.addHandler(a,null,"presence",null,null,null),n.addHandler(s,"urn:xmpp:ping","iq","get",null,null),n.addHandler(c,"jabber:iq:roster","iq","set",null,null),n.addHandler(u,"jabber:iq:privacy","iq","set",null,null),n.addHandler(l,null,"iq",null,null,null),n.context.status=_code.STATUS_OPENED;var d=[_code.WEBIM_MESSAGE_REC_TEXT,_code.WEBIM_MESSAGE_REC_EMOJI];_utils.isCanDownLoadFile&&(d.push(_code.WEBIM_MESSAGE_REC_PHOTO),d.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE));var p=[_code.WEBIM_MESSAGE_SED_TEXT];_utils.isCanUploadFile&&(p.push(_code.WEBIM_MESSAGE_REC_PHOTO),p.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE)),n.notifyVersion(),n.retry&&_handleMessageQueue(n),n.heartBeat(),n.isAutoLogin&&n.setPresence(),n.onOpened({canReceive:d,canSend:p,accessToken:n.context.accessToken})}else if(e==Strophe.Status.DISCONNECTING)n.isOpened()&&(n.stopHeartBeat(),n.context.status=_code.STATUS_CLOSING,i={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},o&&(i.conflict=!0),n.onError(i));else if(e==Strophe.Status.DISCONNECTED){if(n.isOpened()){if(n.autoReconnectNumTotal<n.autoReconnectNumMax)return void n.reconnect();i={type:_code.WEBIM_CONNCTION_DISCONNECTED},n.onError(i)}n.context.status=_code.STATUS_CLOSED,n.clear(),n.onClosed()}else e==Strophe.Status.AUTHFAIL?(i={type:_code.WEBIM_CONNCTION_AUTH_ERROR},o&&(i.conflict=!0),n.onError(i),n.clear()):e==Strophe.Status.ERROR&&(n.context.status=_code.STATUS_ERROR,i={type:_code.WEBIM_CONNCTION_SERVER_ERROR},o&&(i.conflict=!0),n.onError(i));n.context.status_now=e},_getJid=function(e,t){var n=e.toJid||"";if(""===n){var o=t.context.appKey||"",i=o+"_"+e.to+"@"+t.domain;e.resource&&(i=i+"/"+e.resource),n=i}return n},_getJidByName=function(e,t){var n={to:e};return _getJid(n,t)},_validCheck=function(e,t){if(e=e||{},""==e.user)return t.onError({type:_code.WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR}),!1;var n=e.user+""||"",o=e.appKey||"",i=o.split("#");if(2!==i.length)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var r=i[0],a=i[1];if(!r)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;if(!a)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var s=o+"_"+n.toLowerCase()+"@"+t.domain,c=e.resource||"webim";return t.isMultiLoginSessions&&(c+=n+(new Date).getTime()+Math.floor(1e6*Math.random().toFixed(6))),t.context.jid=s+"/"+c,t.context.userId=n,t.context.appKey=o,t.context.appName=a,t.context.orgName=r,!0},_getXmppUrl=function(e,t){if(/^(ws|http)s?:\/\/?/.test(e))return e;var n={prefix:"http",base:"://"+e,suffix:"/http-bind/"};return t&&_utils.isSupportWss?(n.prefix="wss",n.suffix="/ws/"):t?n.prefix="https":window.WebSocket&&(n.prefix="ws",n.suffix="/ws/"),n.prefix+n.base+n.suffix},connection=function(e){if(!this instanceof connection)return new connection(e);var e=e||{};this.isHttpDNS=e.isHttpDNS||!1,this.isMultiLoginSessions=e.isMultiLoginSessions||!1,this.wait=e.wait||30,this.retry=e.retry||!1,this.https=e.https||"https:"===location.protocol,this.url=_getXmppUrl(e.url,this.https),this.hold=e.hold||1,this.route=e.route||null,this.domain=e.domain||"easemob.com",this.inactivity=e.inactivity||30,this.heartBeatWait=e.heartBeatWait||4500,this.maxRetries=e.maxRetries||5,this.isAutoLogin=e.isAutoLogin!==!1,this.pollingTime=e.pollingTime||800,this.stropheConn=!1,this.autoReconnectNumMax=e.autoReconnectNumMax||0,this.autoReconnectNumTotal=0,this.autoReconnectInterval=e.autoReconnectInterval||0,this.context={status:_code.STATUS_INIT},this.sendQueue=new Queue,this.intervalId=null,this.apiUrl=e.apiUrl||"",this.isWindowSDK=e.isWindowSDK||!1,this.dnsArr=["https://rs.easemob.com","https://rsbak.easemob.com","http://182.92.174.78","http://112.126.66.111"],this.dnsIndex=0,this.dnsTotal=this.dnsArr.length,this.restHosts=null,this.restIndex=0,this.restTotal=0,this.xmppHosts=null,this.xmppIndex=0,this.xmppTotal=0};connection.prototype.registerUser=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"signup")):this.signup(e)},connection.prototype.handelSendQueue=function(){var e=this.sendQueue.pop();null!==e&&this.sendReceiptsMessage(e)},connection.prototype.listen=function(e){this.onOpened=e.onOpened||_utils.emptyfn,this.onClosed=e.onClosed||_utils.emptyfn,this.onTextMessage=e.onTextMessage||_utils.emptyfn,this.onEmojiMessage=e.onEmojiMessage||_utils.emptyfn,this.onPictureMessage=e.onPictureMessage||_utils.emptyfn,this.onAudioMessage=e.onAudioMessage||_utils.emptyfn,this.onVideoMessage=e.onVideoMessage||_utils.emptyfn,this.onFileMessage=e.onFileMessage||_utils.emptyfn,this.onLocationMessage=e.onLocationMessage||_utils.emptyfn,this.onCmdMessage=e.onCmdMessage||_utils.emptyfn,this.onPresence=e.onPresence||_utils.emptyfn,this.onRoster=e.onRoster||_utils.emptyfn,this.onError=e.onError||_utils.emptyfn,this.onReceivedMessage=e.onReceivedMessage||_utils.emptyfn,this.onInviteMessage=e.onInviteMessage||_utils.emptyfn,this.onOffline=e.onOffline||_utils.emptyfn,this.onOnline=e.onOnline||_utils.emptyfn,this.onConfirmPop=e.onConfirmPop||_utils.emptyfn,this.onUpdateMyGroupList=e.onUpdateMyGroupList||_utils.emptyfn,this.onUpdateMyRoster=e.onUpdateMyRoster||_utils.emptyfn,this.onBlacklistUpdate=e.onBlacklistUpdate||_utils.emptyfn,_listenNetwork(this.onOnline,this.onOffline)},connection.prototype.heartBeat=function(){var e=this,t=!/^ws|wss/.test(e.url)||/mobile/.test(navigator.userAgent);if(!this.heartBeatID&&t){var n={toJid:this.domain,type:"normal"};this.heartBeatID=setInterval(function(){e.ping(n)},this.heartBeatWait)}},connection.prototype.stopHeartBeat=function(){"number"==typeof this.heartBeatID&&(this.heartBeatID=clearInterval(this.heartBeatID))},connection.prototype.sendReceiptsMessage=function(e){var t=$msg({from:this.context.jid||"",to:this.domain,id:e.id||""}).c("received",{xmlns:"urn:xmpp:receipts",id:e.id||""});this.sendCommand(t.tree())},connection.prototype.cacheReceiptsMessage=function(e){this.sendQueue.push(e)},connection.prototype.getStrophe=function(){if("https:"!=location.protocol&&this.isHttpDNS){var e="",t=this.xmppHosts[this.xmppIndex],n=_utils.getXmlFirstChild(t,"domain"),o=_utils.getXmlFirstChild(t,"ip");if(o){e=o.textContent;var i=_utils.getXmlFirstChild(t,"port");"80"!=i.textContent&&(e+=":"+i.textContent)}else e=n.textContent;if(""!=e){var r=/(.+\/\/).+(\/.+)/;this.url=this.url.replace(r,"$1"+e+"$2")}}var a=new Strophe.Connection(this.url,{inactivity:this.inactivity,maxRetries:this.maxRetries,pollingTime:this.pollingTime});return a},connection.prototype.getHostsByTag=function(e,t){var n=_utils.getXmlFirstChild(e,t);if(!n)return console.log(t+" hosts error"),null;var o=n.getElementsByTagName("hosts");return 0==o.length?(console.log(t+" hosts error2"),null):o[0].getElementsByTagName("host")},connection.prototype.getRestFromHttpDNS=function(e,t){if(this.restIndex>this.restTotal)return void console.log("rest hosts all tried,quit");var n="",o=this.restHosts[this.restIndex],i=_utils.getXmlFirstChild(o,"domain"),r=_utils.getXmlFirstChild(o,"ip");if(r){var a=_utils.getXmlFirstChild(o,"port");n=("https:"===location.protocol?"https:":"http:")+"//"+r.textContent+":"+a.textContent}else n=("https:"===location.protocol?"https:":"http:")+"//"+i.textContent;""!=n&&(this.apiUrl=n,e.apiUrl=n),"login"==t?this.login(e):this.signup(e)},connection.prototype.getHttpDNS=function(e,t){if(this.restHosts)return void this.getRestFromHttpDNS(e,t);var n=this,o=function(o,i){o=(new DOMParser).parseFromString(o,"text/xml").documentElement;var r=n.getHostsByTag(o,"rest");if(!r)return void console.log("rest hosts error3");n.restHosts=r,n.restTotal=r.length;var a=n.getHostsByTag(o,"xmpp");return a?(n.xmppHosts=a,n.xmppTotal=a.length,void n.getRestFromHttpDNS(e,t)):void console.log("xmpp hosts error3")},i=function(o,i,r){console.log("getHttpDNS error",o,r),n.dnsIndex++,n.dnsIndex<n.dnsTotal&&n.getHttpDNS(e,t)},r={url:this.dnsArr[this.dnsIndex]+"/easemob/server.xml",dataType:"text",type:"GET",data:{app_key:encodeURIComponent(e.appKey)},success:o||_utils.emptyfn,error:i||_utils.emptyfn};_utils.ajax(r)},connection.prototype.signup=function(e){var t=this,n=e.orgName||"",o=e.appName||"",i=e.appKey||"",r=e.success||EMPTYFN,a=e.error||EMPTYFN;if(!n&&!o&&i){var s=i.split("#");2===s.length&&(n=s[0],o=s[1])}if(!n&&!o)return void a({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR});var c=function(n,o,i){return"https:"!=location.protocol&&t.isHttpDNS&&t.restIndex+1<t.restTotal?(t.restIndex++,void t.getRestFromHttpDNS(e,"signup")):(t.clear(),void a(n))},u=e.https||u,l=e.apiUrl,d=l+"/"+n+"/"+o+"/users",p={username:e.username,password:e.password,nickname:e.nickname||""},f=_utils.stringify(p),m={url:d,dataType:"json",data:f,success:r,error:c};_utils.ajax(m)},connection.prototype.open=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"login")):this.login(e)},connection.prototype.login=function(e){var t=_validCheck(e,this);if(t){var n=this;if(!n.isOpened())if(e.accessToken)e.access_token=e.accessToken,_login(e,n);else{var o=e.apiUrl,i=this.context.userId,r=e.pwd||"",a=this.context.appName,s=this.context.orgName,c=function(e,t){n.context.status=_code.STATUS_DOLOGIN_IM,n.context.restTokenData=e,_login(e,n)},u=function(t,o,i){return"https:"!=location.protocol&&n.isHttpDNS&&n.restIndex+1<n.restTotal?(n.restIndex++,
void n.getRestFromHttpDNS(e,"login")):(n.clear(),void(t.error&&t.error_description?n.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:t,xhr:o}):n.onError({type:_code.WEBIM_CONNCTION_OPEN_ERROR,data:t,xhr:o})))};this.context.status=_code.STATUS_DOLOGIN_USERGRID;var l={grant_type:"password",username:i,password:r,timestamp:+new Date},d=_utils.stringify(l),p={url:o+"/"+s+"/"+a+"/token",dataType:"json",data:d,success:c||_utils.emptyfn,error:u||_utils.emptyfn};_utils.ajax(p)}}},connection.prototype.attach=function(e){var t=_validCheck(e,this);if(t){e=e||{};var n=e.accessToken||"";if(""==n)return void this.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR});var o=e.sid||"";if(""===o)return void this.onError({type:_code.WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR});var i=e.rid||"";if(""===i)return void this.onError({type:_code.WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR});var r=this.getStrophe();this.context.accessToken=n,this.context.stropheConn=r,this.context.status=_code.STATUS_DOLOGIN_IM;var a=this,s=function(e,t){_loginCallback(e,t,a)},c=this.context.jid,u=this.wait,l=this.hold,d=this.wind||5;r.attach(c,o,i,s,u,l,d)}},connection.prototype.close=function(e){this.stopHeartBeat();var t=this.context.status;t!=_code.STATUS_INIT&&(this.isClosed()||this.isClosing()||(this.context.status=_code.STATUS_CLOSING,this.context.stropheConn.disconnect(e)))},connection.prototype.addHandler=function(e,t,n,o,i,r,a){this.context.stropheConn.addHandler(e,t,n,o,i,r,a)},connection.prototype.notifyVersion=function(e,t){var n=(_getJid({},this),$iq({from:this.context.jid||"",to:this.domain,type:"result"}).c("query",{xmlns:"jabber:iq:version"}).c("name").t("easemob").up().c("version").t(_version).up().c("os").t("webim")),e=e||_utils.emptyfn,o=t||this.onError,i=function(e){o({type:_code.WEBIM_CONNCTION_NOTIFYVERSION_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),e,i)},connection.prototype.handlePresence=function(e){if(!this.isClosed()){var t=e.getAttribute("from")||"",n=e.getAttribute("to")||"",o=e.getAttribute("type")||"",i=e.getAttribute("presence_type")||"",r=_parseNameFromJidFn(t),a=_parseNameFromJidFn(n),s={from:r,to:a,fromJid:t,toJid:n,type:o,chatroom:!!e.getElementsByTagName("roomtype").length},c=e.getElementsByTagName("show");if(c&&c.length>0){var u=c[0];s.show=Strophe.getText(u)}var l=e.getElementsByTagName("status");if(l&&l.length>0){var d=l[0];s.status=Strophe.getText(d),s.code=d.getAttribute("code")}var p=e.getElementsByTagName("priority");if(p&&p.length>0){var f=p[0];s.priority=Strophe.getText(f)}var m=e.getElementsByTagName("error");if(m&&m.length>0){var m=m[0];s.error={code:m.getAttribute("code")}}var h=e.getElementsByTagName("destroy");if(h&&h.length>0){var h=h[0];s.destroy=!0;var g=h.getElementsByTagName("reason");g&&g.length>0&&(s.reason=Strophe.getText(g[0]))}var _=e.getElementsByTagName("item");if(_&&_.length>0){var E=_[0],y=E.getAttribute("role"),v=E.getAttribute("jid");if("none"==y&&v){var S=_parseNameFromJidFn(v),T=E.getElementsByTagName("actor")[0],N=T.getAttribute("nick");s.actor=N,s.kicked=S}"moderator"==y&&"201"==s.code&&(s.type="joinPublicGroupSuccess")}var I=e.getElementsByTagName("apply");if(I&&I.length>0){I=I[0];var O=I.getAttribute("toNick"),b=I.getAttribute("to"),C=I.getAttribute("from"),R=_parseNameFromJidFn(b);_parseNameFromJidFn(C);s.toNick=O,s.groupName=R,s.type="joinGroupNotifications";var g=I.getElementsByTagName("reason");g&&g.length>0&&(s.reason=Strophe.getText(g[0]))}if(s.chatroom){s.presence_type=i,s.original_type=s.type;var x=t.slice(t.lastIndexOf("/")+1);x===this.context.userId&&(""!==s.type||s.code?"unavailable"!==i&&"unavailable"!==s.type||(s.status?110==s.code?s.type="leaveChatRoom":s.error&&406==s.error.code&&(s.type="reachChatRoomCapacity"):s.type="leaveChatRoom"):s.type="joinChatRoomSuccess")}else s.presence_type=i,s.original_type=o,/subscribe/.test(s.type)||(""!=o||s.status||s.error?"unavailable"!==i&&"unavailable"!==o||(s.destroy?s.type="deleteGroupChat":307!=s.code&&321!=s.code||(s.type="leaveGroup")):s.type="joinPublicGroupSuccess");this.onPresence(s,e)}},connection.prototype.handlePing=function(e){if(!this.isClosed()){var t=e.getAttribute("id"),n=e.getAttribute("from"),o=e.getAttribute("to"),i=$iq({from:o,to:n,id:t,type:"result"});this.sendCommand(i.tree())}},connection.prototype.handleIq=function(e){return!0},connection.prototype.handleIqPrivacy=function(e){var t=e.getElementsByTagName("list");0!=t.length&&this.getBlacklist()},connection.prototype.handleIqRoster=function(e){var t=e.getAttribute("id"),n=e.getAttribute("from")||"",o=(_parseNameFromJidFn(n),this.context.jid),i=(this.context.userId,$iq({type:"result",id:t,from:o}));this.sendCommand(i.tree());var r=e.getElementsByTagName("query");if(r&&r.length>0){var a=r[0],s=_parseFriend(a,this,n);this.onRoster(s)}return!0},connection.prototype.handleMessage=function(e){var t=this;if(!this.isClosed()){var n=e.getAttribute("id")||"";this.cacheReceiptsMessage({id:n});var o=_parseResponseMessage(e);if(o.errorMsg)return void this.handlePresence(e);var i=e.getElementsByTagName("error"),r="",a="",s=!1;if(i.length>0){s=!0,r=i[0].getAttribute("code");var c=i[0].getElementsByTagName("text");a=c[0].textContent||c[0].text,log("handle error",r,a)}var u=o.data;for(var l in u)if(u.hasOwnProperty(l)){var d=u[l];if(d.from&&d.to){var p=(d.from+"").toLowerCase(),f=(d.to+"").toLowerCase(),m=d.ext||{},h="",g=e.getElementsByTagName("roomtype");h=g.length?g[0].getAttribute("type")||"chat":e.getAttribute("type")||"chat";var _=d.bodies;if(_&&0!=_.length){var E=d.bodies[0],y=E.type;try{switch(y){case"txt":var v=E.msg,S=_utils.parseTextMessage(v,WebIM.Emoji);if(S.isemoji){var d={id:n,type:h,from:p,to:f,delay:o.delayTimeStamp,data:S.body,ext:m};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onEmojiMessage(d)}else{var d={id:n,type:h,from:p,to:f,delay:o.delayTimeStamp,data:v,ext:m};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onTextMessage(d)}break;case"img":var T=0,N=0;E.size&&(T=E.size.width,N=E.size.height);var d={id:n,type:h,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+E.url.substr(E.url.indexOf("/",9)):E.url,secret:E.secret,filename:E.filename,thumb:E.thumb,thumb_secret:E.thumb_secret,file_length:E.file_length||"",width:T,height:N,filetype:E.filetype||"",accessToken:this.context.accessToken||"",ext:m,delay:o.delayTimeStamp};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onPictureMessage(d);break;case"audio":var d={id:n,type:h,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+E.url.substr(E.url.indexOf("/",9)):E.url,secret:E.secret,filename:E.filename,length:E.length||"",file_length:E.file_length||"",filetype:E.filetype||"",accessToken:this.context.accessToken||"",ext:m,delay:o.delayTimeStamp};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onAudioMessage(d);break;case"file":var d={id:n,type:h,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+E.url.substr(E.url.indexOf("/",9)):E.url,secret:E.secret,filename:E.filename,file_length:E.file_length,accessToken:this.context.accessToken||"",ext:m,delay:o.delayTimeStamp};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onFileMessage(d);break;case"loc":var d={id:n,type:h,from:p,to:f,addr:E.addr,lat:E.lat,lng:E.lng,ext:m,delay:o.delayTimeStamp};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onLocationMessage(d);break;case"video":var d={id:n,type:h,from:p,to:f,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+E.url.substr(E.url.indexOf("/",9)):E.url,secret:E.secret,filename:E.filename,file_length:E.file_length,accessToken:this.context.accessToken||"",ext:m,delay:o.delayTimeStamp};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onVideoMessage(d);break;case"cmd":var d={id:n,from:p,to:f,action:E.action,ext:m,delay:o.delayTimeStamp};!d.delay&&delete d.delay,d.error=s,d.errorText=a,d.errorCode=r,this.onCmdMessage(d)}}catch(I){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:I})}}}}}},connection.prototype.handleReceivedMessage=function(e){try{this.onReceivedMessage(e)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}var n,o,i=e.getElementsByTagName("received");if(i.length>0&&(n=i[0].childNodes&&i[0].childNodes.length>0?i[0].childNodes[0].nodeValue:i[0].innerHTML||i[0].innerText,o=i[0].getAttribute("mid")),_msgHash[n]){try{_msgHash[n].msg.success instanceof Function&&_msgHash[n].msg.success(n,o)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}delete _msgHash[n]}},connection.prototype.handleInviteMessage=function(e){var t=null,n=e.getElementsByTagName("invite"),o=e.getElementsByTagName("reason")[0],i=o.textContent,r=e.getAttribute("id")||"";if(this.sendReceiptsMessage({id:r}),n&&n.length>0){var a=n[0].getAttribute("from");t=_parseNameFromJidFn(a)}var s=e.getElementsByTagName("x"),c=null;if(s&&s.length>0)for(var u=0;u<s.length;u++)if("jabber:x:conference"===s[u].namespaceURI){var l=s[u].getAttribute("jid");c=_parseNameFromJidFn(l)}this.onInviteMessage({type:"invite",from:t,roomid:c,reason:i})},connection.prototype.sendCommand=function(e,t){this.isOpened()?this.context.stropheConn.send(e):this.onError({type:_code.WEBIM_CONNCTION_DISCONNECTED,reconnect:!0})},connection.prototype.getUniqueId=function(e){var t=new Date,n=new Date(2010,1,1),o=t.getTime()-n.getTime(),i=parseInt(o).toString(16);return"string"==typeof e||"number"==typeof e?e+"_"+i:"WEBIM_"+i},connection.prototype.send=function(e){var t=this;if(this.isWindowSDK)WebIM.doQuery('{"type":"sendMessage","to":"'+e.to+'","message_type":"'+e.type+'","msg":"'+encodeURI(e.msg)+'","chatType":"'+e.chatType+'"}',function(e){},function(e,n){var o={data:{data:"send"},type:_code.WEBIM_MESSAGE_SED_ERROR};t.onError(o)});else if("[object Object]"===Object.prototype.toString.call(e)){var n=this.context.appKey||"",o=n+"_"+e.to+"@"+this.domain;e.group&&(o=n+"_"+e.to+"@conference."+this.domain),e.resource&&(o=o+"/"+e.resource),e.toJid=o,e.id=e.id||this.getUniqueId(),_msgHash[e.id]=new _message(e),_msgHash[e.id].send(this)}else"string"==typeof e&&_msgHash[e]&&_msgHash[e].send(this)},connection.prototype.addRoster=function(e){var t=_getJid(e,this),n=e.name||"",o=e.groups||"",i=$iq({type:"set"});if(i.c("query",{xmlns:"jabber:iq:roster"}),i.c("item",{jid:t,name:n}),o)for(var r=0;r<o.length;r++)i.c("group").t(o[r]).up();var a=e.success||_utils.emptyfn,s=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(i.tree(),a,s)},connection.prototype.removeRoster=function(e){var t=_getJid(e,this),n=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:t,subscription:"remove"}),o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(n,o,i)},connection.prototype.getRoster=function(e){var t=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"}),e=e||{},n=e.success||this.onRoster,o=function(e){var t=[],o=e.getElementsByTagName("query");if(o&&o.length>0){var i=o[0];t=_parseFriend(i)}n(t,e)},i=e.error||this.onError,r=function(e){i({type:_code.WEBIM_CONNCTION_GETROSTER_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(t.tree(),o,r):i({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.subscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribe"});e.message&&n.c("status").t(e.message).up(),e.nick&&n.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(e.nick),this.sendCommand(n.tree())},connection.prototype.subscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.unsubscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribe"});e.message&&n.c("status").t(e.message),this.sendCommand(n.tree())},connection.prototype.unsubscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.joinPublicGroup=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,r=function(e){i({type:_code.WEBIM_CONNCTION_JOINROOM_ERROR,data:e})},a=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC});this.context.stropheConn.sendIQ(a.tree(),o,r)},connection.prototype.listRooms=function(e){var t=$iq({to:e.server||"conference."+this.domain,from:this.context.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),n=e.success||_utils.emptyfn,o=e.error||this.onError,i=function(e){var t=[];t=_parseRoom(e);try{n(t)}catch(i){o({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:i})}},r=e.error||_utils.emptyfn,a=function(e){r({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:e})};this.context.stropheConn.sendIQ(t.tree(),i,a)},connection.prototype.queryRoomMember=function(e){var t=(this.domain,[]),n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",{xmlns:Strophe.NS.MUC+"#admin"}).c("item",{affiliation:"member"}),o=e.success||_utils.emptyfn,i=function(e){var n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var r=n[i],a={jid:r.getAttribute("jid"),affiliation:"member"};t.push(a)}o(t)},r=e.error||_utils.emptyfn,a=function(e){r({type:_code.WEBIM_CONNCTION_GETROOMMEMBER_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),i,a)},connection.prototype.queryRoomInfo=function(e){var t=this.domain,n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+t,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_INFO}),o=e.success||_utils.emptyfn,i=[],r=function(e){var n="",r=e.getElementsByTagName("feature");switch(r&&(n=r[1].getAttribute("var")+"|"+r[3].getAttribute("var")+"|"+r[4].getAttribute("var")),n){case"muc_public|muc_membersonly|muc_notallowinvites":n="PUBLIC_JOIN_APPROVAL";break;case"muc_public|muc_open|muc_notallowinvites":n="PUBLIC_JOIN_OPEN";break;case"muc_hidden|muc_membersonly|muc_allowinvites":n="PRIVATE_MEMBER_INVITE";break;case"muc_hidden|muc_membersonly|muc_notallowinvites":n="PRIVATE_OWNER_INVITE"}var a=e.getElementsByTagName("field"),s={};if(a){for(var c=0;c<a.length;c++){var u=a[c],l=u.getAttribute("var"),d=l.split("_")[1];switch(l){case"muc#roominfo_occupants":case"muc#roominfo_maxusers":case"muc#roominfo_affiliations":case"muc#roominfo_description":s[d]=u.textContent||u.text||"";break;case"muc#roominfo_owner":var p={jid:(u.textContent||u.text)+"@"+t,affiliation:"owner"};i.push(p),s[d]=u.textContent||u.text}}s.name=e.getElementsByTagName("identity")[0].getAttribute("name")}log(n,i,s),o(n,i,s)},a=e.error||_utils.emptyfn,s=function(e){a({type:_code.WEBIM_CONNCTION_GETROOMINFO_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),r,s)},connection.prototype.queryRoomOccupants=function(e){var t=e.success||_utils.emptyfn,n=function(e){var n=[];n=_parseRoomOccupants(e),t(n)},o=e.error||_utils.emptyfn,i=function(e){o({type:_code.WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR,data:e})},r={xmlns:Strophe.NS.DISCO_ITEMS},a=$iq({from:this.context.jid,to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",r);this.context.stropheConn.sendIQ(a.tree(),n,i)},connection.prototype.setUserSig=function(e){var t=$pres({xmlns:"jabber:client"});e=e||"",t.c("status").t(e),this.sendCommand(t.tree())},connection.prototype.setPresence=function(e,t){var n=$pres({xmlns:"jabber:client"});e&&(t?(n.c("show").t(e),n.up().c("status").t(t)):n.c("show").t(e)),this.sendCommand(n.tree())},connection.prototype.getPresence=function(){var e=$pres({xmlns:"jabber:client"});this.sendCommand(e.tree())},connection.prototype.ping=function(e){var e=e||{},t=_getJid(e,this),n=$iq({from:this.context.jid||"",to:t,type:"get"}).c("ping",{xmlns:"urn:xmpp:ping"}),o=e.success||_utils.emptyfn,i=e.error||this.onError,r=function(e){i({type:_code.WEBIM_CONNCTION_PING_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(n.tree(),o,r):i({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.isOpened=function(){return this.context.status==_code.STATUS_OPENED},connection.prototype.isOpening=function(){var e=this.context.status;return e==_code.STATUS_DOLOGIN_USERGRID||e==_code.STATUS_DOLOGIN_IM},connection.prototype.isClosing=function(){return this.context.status==_code.STATUS_CLOSING},connection.prototype.isClosed=function(){return this.context.status==_code.STATUS_CLOSED},connection.prototype.clear=function(){var e=this.context.appKey;if(this.errorType!=_code.WEBIM_CONNCTION_DISCONNECTED&&(this.context={status:_code.STATUS_INIT,appKey:e}),this.intervalId&&clearInterval(this.intervalId),this.restIndex=0,this.xmppIndex=0,this.errorType==_code.WEBIM_CONNCTION_CLIENT_LOGOUT||this.errorType==-1){var t={data:{data:"clear"},type:_code.WEBIM_CONNCTION_CLIENT_LOGOUT};this.onError(t)}},connection.prototype.getChatRooms=function(e){if(!_utils.isCanSetRequestHeader)return void t.onError({type:_code.WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR});var t=this,n=e.accessToken||this.context.accessToken;if(n){var o=e.apiUrl,i=this.context.appName,r=this.context.orgName;if(!i||!r)return void t.onError({type:_code.WEBIM_CONNCTION_AUTH_ERROR});var a=function(t,n){"function"==typeof e.success&&e.success(t)},s=function(e,n,o){e.error&&e.error_description&&t.onError({type:_code.WEBIM_CONNCTION_LOAD_CHATROOM_ERROR,msg:e.error_description,data:e,xhr:n})},c={pagenum:parseInt(e.pagenum)||1,pagesize:parseInt(e.pagesize)||20},u={url:o+"/"+r+"/"+i+"/chatrooms",dataType:"json",type:"GET",headers:{Authorization:"Bearer "+n},data:c,success:a||_utils.emptyfn,error:s||_utils.emptyfn};_utils.ajax(u)}else t.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR})},connection.prototype.joinChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,r=function(e){i({type:_code.WEBIM_CONNCTION_JOINCHATROOM_ERROR,data:e})},a=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"member",role:"participant"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(a.tree(),o,r)},connection.prototype.quitChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,r=function(e){i({type:_code.WEBIM_CONNCTION_QUITCHATROOM_ERROR,data:e})},a=$pres({from:this.context.jid,to:n,type:"unavailable"}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"none",role:"none"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(a.tree(),o,r)},connection.prototype._onReceiveInviteFromGroup=function(info){info=eval("("+info+")");var self=this,options={title:"Group invitation",msg:info.user+" invites you to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" agreed to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteDeclineFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" rejected to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onAutoAcceptInvitationFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation",msg:"You had joined into the group:"+info.group_name+" automatically.Inviter:"+info.user,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onLeaveGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been out of the group:"+info.group_id+".Reason:"+info.msg,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveJoinGroupApplication=function(info){info=eval("("+info+")");var self=this,options={title:"Group join application",msg:info.user+" applys to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_JOIN_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_JOIN_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You had joined into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveRejectionFromGroup=function(){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been rejected to join into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onUpdateMyGroupList=function(e){this.onUpdateMyGroupList(e)},connection.prototype._onUpdateMyRoster=function(e){this.onUpdateMyRoster(e)},connection.prototype.reconnect=function(){var e=this;setTimeout(function(){_login(e.context.restTokenData,e)},1e3*(0==this.autoReconnectNumTotal?0:this.autoReconnectInterval)),this.autoReconnectNumTotal++},connection.prototype.closed=function(){var e={data:{data:"Closed error"},type:_code.WEBIM_CONNECTION_CLOSED};this.onError(e)},connection.prototype.getBlacklist=function(e){e=e||{};var t=$iq({type:"get"}),n=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,i=this;t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),this.context.stropheConn.sendIQ(t.tree(),function(e){i.onBlacklistUpdate(_parsePrivacy(e)),n()},function(){i.onBlacklistUpdate([]),o()})},connection.prototype.addToBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},o=e.type||"jid",i=e.success||_utils.emptyfn,r=e.error||_utils.emptyfn,a=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),s=Object.keys(n),c=s.length,u=2,l=0;l<c;l++){var d=n[s[l]],o=d.type||"jid",p=d.jid;a=a.c("item",{action:"deny",order:u++,type:o,value:p}).c("message"),l!==c-1&&(a=a.up().up())}this.context.stropheConn.sendIQ(a.tree(),i,r)},connection.prototype.removeFromBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,r=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),a=Object.keys(n),s=a.length,c=0;c<s;c++){var u=n[a[c]],l=u.type||"jid",d=u.jid,p=u.order;r=r.c("item",{action:"deny",order:p,type:l,value:d}).c("message"),c!==s-1&&(r=r.up().up())}this.context.stropheConn.sendIQ(r.tree(),o,i)},connection.prototype._getGroupJid=function(e){var t=this.context.appKey||"";return t+"_"+e+"@conference."+this.domain},connection.prototype.addToGroupBlackList=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=_getJid(e,this),i="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"outcast",jid:o}),this.context.stropheConn.sendIQ(a.tree(),t,n)},connection.prototype.getGroupBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o="admin",i=this._getGroupJid(e.roomId),r=$iq({type:"get",to:i});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"outcast"}),this.context.stropheConn.sendIQ(r.tree(),function(e){log("getGroupBlackList"),t(_parseGroupBlacklist(e))},function(){n()})},connection.prototype.removeGroupMemberFromBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=_getJid(e,this),i="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"member",jid:o}),this.context.stropheConn.sendIQ(a.tree(),function(e){t()},function(){n()})},connection.prototype.changeGroupSubject=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o="owner",i=this._getGroupJid(e.roomId),r=$iq({type:"set",to:i});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("x",{type:"submit",xmlns:"jabber:x:data"}).c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up().c("field",{"var":"muc#roomconfig_roomname"}).c("value").t(e.subject).up().up().c("field",{"var":"muc#roomconfig_roomdesc"}).c("value").t(e.description),this.context.stropheConn.sendIQ(r.tree(),function(e){t()},function(){n()})},connection.prototype.destroyGroup=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o="owner",i=this._getGroupJid(e.roomId),r=$iq({type:"set",to:i});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("destroy").c("reason").t(e.reason||""),this.context.stropheConn.sendIQ(r.tree(),function(e){t()},function(){n()})},connection.prototype.leaveGroupBySelf=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=_getJid(e,this),i="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"none",jid:o}),this.context.stropheConn.sendIQ(a.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.leaveGroup=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=e.list||[],i="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r}),s=a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}),c=Object.keys(o),u=c.length,l=0;l<u;l++){var d=o[c[l]],p=_getJidByName(d,this);s=s.c("item",{affiliation:"none",jid:p}).up().c("item",{role:"none",jid:p}).up()}this.context.stropheConn.sendIQ(a.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.addGroupMembers=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=e.list||[],i="admin",r=this._getGroupJid(e.roomId),a=$iq({type:"set",to:r}),s=a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}),c=o.length,u=0;u<c;u++){var l=o[u],d=_getJidByName(l,this);s=s.c("item",{affiliation:"member",jid:d}).up();var p=$msg({to:r}).c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("invite",{to:d}).c("reason").t(e.reason||"");this.sendCommand(p.tree())}this.context.stropheConn.sendIQ(a.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.acceptInviteFromGroup=function(e){e.success=function(){},this.addGroupMembers(e)},connection.prototype.rejectInviteFromGroup=function(e){},connection.prototype.createGroup=function(e){var t=+new Date,n=this._getGroupJid(t),o=n+"/"+this.context.userId,i=$pres({to:o}).c("x",{xmlns:"http://jabber.org/protocol/muc"}).up().c("create",{xmlns:"http://jabber.org/protocol/muc"}).up();this.sendCommand(i.tree());var r=this;setTimeout(function(){var o=$iq({type:"get",to:n}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"});r.context.stropheConn.sendIQ(o.tree(),function(o){if("setAttribute"in o){var i=o.getElementsByTagName("x")[0];i.setAttribute("type","submit")}else Strophe.forEachChild(o,"x",function(e){e.setAttribute("type","submit")});Strophe.info("step 5 ----------"),Strophe.forEachChild(i,"field",function(t){var n=t.getAttribute("var"),o=t.getElementsByTagName("value")[0];switch(Strophe.info(n),n){case"muc#roomconfig_roomname":_setText(o,e.subject||"");break;case"muc#roomconfig_roomdesc":_setText(o,e.description||"");break;case"muc#roomconfig_publicroom":_setText(o,+e.optionsPublic);break;case"muc#roomconfig_membersonly":_setText(o,+e.optionsMembersOnly);break;case"muc#roomconfig_moderatedroom":_setText(o,+e.optionsModerate);break;case"muc#roomconfig_persistentroom":_setText(o,1);break;case"muc#roomconfig_allowinvites":_setText(o,+e.optionsAllowInvites);break;case"muc#roomconfig_allowvisitornickchange":_setText(o,0);break;case"muc#roomconfig_allowvisitorstatus":_setText(o,0);break;case"allow_private_messages":_setText(o,0);break;case"allow_private_messages_from_visitors":_setText(o,"nobody")}});var a=$iq({to:n,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(i);r.context.stropheConn.sendIQ(a.tree(),function(n){r.addGroupMembers({list:e.members,roomId:t})},function(e){})},function(e){})},1e3)};var WebIM=window.WebIM||{};WebIM.connection=connection,WebIM.utils=_utils,WebIM.statusCode=_code,WebIM.message=_msg.message,WebIM.doQuery=function(e,t,n){"undefined"!=typeof window.cefQuery&&window.cefQuery({request:e,persistent:!1,onSuccess:t,onFailure:n})},module.exports=WebIM},function(e,t){!function(){t.code={WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR:0,WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_OPEN_USERGRID_ERROR:3,WEBIM_CONNCTION_ATTACH_ERROR:4,WEBIM_CONNCTION_ATTACH_USERGRID_ERROR:5,WEBIM_CONNCTION_REOPEN_ERROR:6,WEBIM_CONNCTION_SERVER_CLOSE_ERROR:7,WEBIM_CONNCTION_SERVER_ERROR:8,WEBIM_CONNCTION_IQ_ERROR:9,WEBIM_CONNCTION_PING_ERROR:10,WEBIM_CONNCTION_NOTIFYVERSION_ERROR:11,WEBIM_CONNCTION_GETROSTER_ERROR:12,WEBIM_CONNCTION_CROSSDOMAIN_ERROR:13,WEBIM_CONNCTION_LISTENING_OUTOF_MAXRETRIES:14,WEBIM_CONNCTION_RECEIVEMSG_CONTENTERROR:15,WEBIM_CONNCTION_DISCONNECTED:16,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_JOINROOM_ERROR:18,WEBIM_CONNCTION_GETROOM_ERROR:19,WEBIM_CONNCTION_GETROOMINFO_ERROR:20,WEBIM_CONNCTION_GETROOMMEMBER_ERROR:21,WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR:22,WEBIM_CONNCTION_LOAD_CHATROOM_ERROR:23,WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR:24,WEBIM_CONNCTION_JOINCHATROOM_ERROR:25,WEBIM_CONNCTION_QUITCHATROOM_ERROR:26,WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR:27,WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR:28,WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR:29,WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR:30,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31,WEBIM_CONNCTION_CLIENT_OFFLINE:32,WEBIM_CONNCTION_CLIENT_LOGOUT:33,WEBIM_CONNCTION_CLIENT_TOO_MUCH_ERROR:34,WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP:35,WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP:36,WEBIM_CONNECTION_ACCEPT_JOIN_GROUP:37,WEBIM_CONNECTION_DECLINE_JOIN_GROUP:38,WEBIM_CONNECTION_CLOSED:39,WEBIM_UPLOADFILE_BROWSER_ERROR:100,WEBIM_UPLOADFILE_ERROR:101,WEBIM_UPLOADFILE_NO_LOGIN:102,WEBIM_UPLOADFILE_NO_FILE:103,WEBIM_DOWNLOADFILE_ERROR:200,WEBIM_DOWNLOADFILE_NO_LOGIN:201,WEBIM_DOWNLOADFILE_BROWSER_ERROR:202,WEBIM_MESSAGE_REC_TEXT:300,WEBIM_MESSAGE_REC_TEXT_ERROR:301,WEBIM_MESSAGE_REC_EMOTION:302,WEBIM_MESSAGE_REC_PHOTO:303,WEBIM_MESSAGE_REC_AUDIO:304,WEBIM_MESSAGE_REC_AUDIO_FILE:305,WEBIM_MESSAGE_REC_VEDIO:306,WEBIM_MESSAGE_REC_VEDIO_FILE:307,WEBIM_MESSAGE_REC_FILE:308,WEBIM_MESSAGE_SED_TEXT:309,WEBIM_MESSAGE_SED_EMOTION:310,WEBIM_MESSAGE_SED_PHOTO:311,WEBIM_MESSAGE_SED_AUDIO:312,WEBIM_MESSAGE_SED_AUDIO_FILE:313,WEBIM_MESSAGE_SED_VEDIO:314,WEBIM_MESSAGE_SED_VEDIO_FILE:315,WEBIM_MESSAGE_SED_FILE:316,WEBIM_MESSAGE_SED_ERROR:317,STATUS_INIT:400,STATUS_DOLOGIN_USERGRID:401,STATUS_DOLOGIN_IM:402,STATUS_OPENED:403,STATUS_CLOSING:404,STATUS_CLOSED:405,STATUS_ERROR:406}}()},function(e,t,n){!function(){var e=function(){},o=n(26).code,i=10485760,r=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},a=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}},s=function(t){t=t||!0;var n=r()||a();if("withCredentials"in n)return n;if(!t)return n;if("undefined"==typeof window.XDomainRequest)return n;
var o=new XDomainRequest;return o.readyState=0,o.status=100,o.onreadystatechange=e,o.onload=function(){o.readyState=4,o.status=200;var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(o.responseText),o.responseXML=e,o.response=o.responseText,o.onreadystatechange()},o.ontimeout=o.onerror=function(){o.readyState=4,o.status=500,o.onreadystatechange()},o},c=function(){if("ActiveXObject"in window)try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){return 0}else if(navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"];return 0}(),u=s(),l="undefined"!=typeof FormData,d="undefined"!=typeof Blob,p=u.setRequestHeader||!1,f=u.overrideMimeType||!1,m=p&&l,h=m||c,g=p&&(d||f);Object.keys||(Object.keys=function(){"use strict";var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],o=n.length;return function(i){if("object"!=typeof i&&("function"!=typeof i||null===i))throw new TypeError("Object.keys called on non-object");var r,a,s=[];for(r in i)e.call(i,r)&&s.push(r);if(t)for(a=0;a<o;a++)e.call(i,n[a])&&s.push(n[a]);return s}}());var _={hasFormData:l,hasBlob:d,emptyfn:e,isCanSetRequestHeader:p,hasOverrideMimeType:f,isCanUploadFileAsync:m,isCanUploadFile:h,isCanDownLoadFile:g,isSupportWss:function(){var e=[/MQQBrowser[\/]5([.]\d+)?\sTBS/];if(!window.WebSocket)return!1;for(var t=window.navigator.userAgent,n=0,o=e.length;n<o;n++)if(e[n].test(t))return!1;return!0}(),getIEVersion:function(){var e,t=navigator.userAgent,n={4:8,5:9,6:10,7:11};return e=t.match(/MSIE (\d+)/i),e&&e[1]?+e[1]:(e=t.match(/Trident\/(\d+)/i),e&&e[1]?n[e[1]]||null:null)}(),stringify:function(e){if("undefined"!=typeof JSON&&JSON.stringify)return JSON.stringify(e);var t="",n=[],o=function(e){var i=!1;"[object Array]"===Object.prototype.toString.call(e)?(n.push("]","["),i=!0):"[object Object]"===Object.prototype.toString.call(e)&&n.push("}","{");for(var r in e)"[object Null]"===Object.prototype.toString.call(e[r])?e[r]="null":"[object Undefined]"===Object.prototype.toString.call(e[r])&&(e[r]="undefined"),t+=e[r]&&"object"==typeof e[r]?","+(i?"":'"'+r+'":'+(i?'"':""))+o(e[r]):',"'+(i?"":r+'":"')+e[r]+'"';return""!=t&&(t=t.slice(1)),n.pop()+t+n.pop()};return o(e)},login:function(t){var t=t||{},n=t.success||e,i=t.error||e,r=t.appKey||"",a=r.split("#");if(2!==a.length)return i({type:o.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var s=a[0],c=a[1],u=u||t.https,l=t.user||"",d=t.pwd||"",p=t.apiUrl,f={grant_type:"password",username:l,password:d,timestamp:+new Date},m=_.stringify(f),t={url:p+"/"+s+"/"+c+"/token",dataType:"json",data:m,success:n,error:i};return _.ajax(t)},getFileUrl:function(e){var t={url:"",filename:"",filetype:"",data:""},n="string"==typeof e?document.getElementById(e):e;if(!_.isCanUploadFileAsync||!n)return t;try{if(window.URL.createObjectURL){var o=n.files;if(o.length>0){var i=o.item(0);t.data=i,t.url=window.URL.createObjectURL(i),t.filename=i.name||""}}else{var i=document.getElementById(e).value;t.url=i;var r=i.lastIndexOf("/"),a=i.lastIndexOf("\\"),s=Math.max(r,a);s<0?t.filename=i:t.filename=i.substring(s+1)}var c=t.filename.lastIndexOf(".");return c!=-1&&(t.filetype=t.filename.substring(c+1).toLowerCase()),t}catch(u){throw u}},getFileSize:function(e){var t=0;if(e)if(e.files)e.files.length>0&&(t=e.files[0].size);else if(e.select&&"ActiveXObject"in window){e.select();var n=new ActiveXObject("Scripting.FileSystemObject"),e=n.GetFile(e.value);t=e.Size}if(console.log("fileSize: ",t),t>1e7)return!1;var o=Math.round(t/1e3);if(o<1e3)t=o+" KB";else if(o>=1e3){var i=o/1e3;if(i<1e3)t=i.toFixed(1)+" MB";else{var r=i/1e3;t=r.toFixed(1)+" GB"}}return t},hasFlash:c,trim:function(e){return e="string"==typeof e?e:"",e.trim?e.trim():e.replace(/^\s|\s$/g,"")},parseEmoji:function(e){if("undefined"==typeof WebIM.Emoji||"undefined"==typeof WebIM.Emoji.map)return e;var t=WebIM.Emoji;for(var n in t.map)if(t.map.hasOwnProperty(n))for(;e.indexOf(n)>-1;)e=e.replace(n,'<img class="emoji" src="'+t.path+t.map[n]+'" />');return e},parseLink:function(e){var t=/(https?\:\/\/|www\.)([a-zA-Z0-9-]+(\.[a-zA-Z0-9]+)+)(\:[0-9]{2,4})?\/?((\.[:_0-9a-zA-Z-]+)|[:_0-9a-zA-Z-]*\/?)*\??[:_#@*&%0-9a-zA-Z-\/=]*/gm;return e=e.replace(t,function(e){var t=/^https?/gm.test(e);return"<a href='"+(t?e:"//"+e)+"' target='_blank'>"+e+"</a>"})},parseJSON:function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e+"");var t,n=null,o=_.trim(e+"");return o&&!_.trim(o.replace(/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g,function(e,o,i,r){return t&&o&&(n=0),0===n?e:(t=i||o,n+=!r-!i,"")}))?Function("return "+o)():Function("Invalid JSON: "+e)()},parseUploadResponse:function(e){return e.indexOf("callback")>-1?e.slice(9,-1):e},parseDownloadResponse:function(e){return e&&e.type&&"application/json"===e.type||0>Object.prototype.toString.call(e).indexOf("Blob")?this.url+"?token=":window.URL.createObjectURL(e)},uploadFile:function(t){var t=t||{};t.onFileUploadProgress=t.onFileUploadProgress||e,t.onFileUploadComplete=t.onFileUploadComplete||e,t.onFileUploadError=t.onFileUploadError||e,t.onFileUploadCanceled=t.onFileUploadCanceled||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_NO_LOGIN,id:t.id});var r,a,s,c=t.appKey||this.context.appKey||"";if(c&&(s=c.split("#"),r=s[0],a=s[1]),!r&&!a)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});var u=t.apiUrl,l=u+"/"+r+"/"+a+"/chatfiles";if(!_.isCanUploadFileAsync)return void(_.hasFlash&&"function"==typeof t.flashUpload?t.flashUpload&&t.flashUpload(l,t):t.onFileUploadError({type:o.WEBIM_UPLOADFILE_BROWSER_ERROR,id:t.id}));var d=t.file.data?t.file.data.size:void 0;if(d>i)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});if(d<=0)return void t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id});var p=_.xmlrequest(),f=function(e){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,id:t.id,xhr:p})};p.upload&&p.upload.addEventListener("progress",t.onFileUploadProgress,!1),p.addEventListener?(p.addEventListener("abort",t.onFileUploadCanceled,!1),p.addEventListener("load",function(e){try{var n=_.parseJSON(p.responseText);try{t.onFileUploadComplete(n)}catch(e){t.onFileUploadError({type:o.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}}catch(e){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p})}},!1),p.addEventListener("error",f,!1)):p.onreadystatechange&&(p.onreadystatechange=function(){if(4===p.readyState)if(200===ajax.status)try{var e=_.parseJSON(p.responseText);t.onFileUploadComplete(e)}catch(n){t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p})}else t.onFileUploadError({type:o.WEBIM_UPLOADFILE_ERROR,data:p.responseText,id:t.id,xhr:p});else p.abort(),t.onFileUploadCanceled()}),p.open("POST",l),p.setRequestHeader("restrict-access","true"),p.setRequestHeader("Accept","*/*"),p.setRequestHeader("Authorization","Bearer "+n);var m=new FormData;m.append("file",t.file.data),p.send(m)},download:function(t){t.onFileDownloadComplete=t.onFileDownloadComplete||e,t.onFileDownloadError=t.onFileDownloadError||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_NO_LOGIN,id:t.id});var i=function(e){t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r})};if(!_.isCanDownLoadFile)return void t.onFileDownloadComplete();var r=_.xmlrequest();"addEventListener"in r?(r.addEventListener("load",function(e){t.onFileDownloadComplete(r.response,r)},!1),r.addEventListener("error",i,!1)):"onreadystatechange"in r&&(r.onreadystatechange=function(){4===r.readyState?200===ajax.status?t.onFileDownloadComplete(r.response,r):t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r}):(r.abort(),t.onFileDownloadError({type:o.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:r}))});var a=t.method||"GET",s=t.responseType||"blob",c=t.mimeType||"text/plain; charset=x-user-defined";r.open(a,t.url),"undefined"!=typeof Blob?r.responseType=s:r.overrideMimeType(c);var u={"X-Requested-With":"XMLHttpRequest",Accept:"application/octet-stream","share-secret":t.secret,Authorization:"Bearer "+n},l=t.headers||{};for(var d in l)u[d]=l[d];for(var d in u)u[d]&&r.setRequestHeader(d,u[d]);r.send(null)},parseTextMessage:function(e,t){if("string"==typeof e){if("[object Object]"!==Object.prototype.toString.call(t))return{isemoji:!1,body:[{type:"txt",data:e}]};var n=e,o=[],i=/\[[^[\]]{2,3}\]/gm,r=n.match(i);if(!r||r.length<1)return{isemoji:!1,body:[{type:"txt",data:e}]};for(var a=!1,s=0;s<r.length;s++){var c=n.substring(0,n.indexOf(r[s])),u=WebIM.Emoji.map[r[s]];if(c&&o.push({type:"txt",data:c}),u){var l=WebIM.Emoji.map?WebIM.Emoji.path+u:null;l?(a=!0,o.push({type:"emoji",data:l})):o.push({type:"txt",data:r[s]});var d=n.indexOf(r[s])+r[s].length;n=n.substring(d)}else o.push({type:"txt",data:r[s]})}return n&&o.push({type:"txt",data:n}),a?{isemoji:a,body:o}:{isemoji:!1,body:[{type:"txt",data:e}]}}},xmlrequest:s,getXmlFirstChild:function(e,t){var n=e.getElementsByTagName(t);return 0==n.length?null:n[0]},ajax:function(t){var n=t.dataType||"text",i=t.success||e,r=t.error||e,a=_.xmlrequest();a.onreadystatechange=function(){if(4===a.readyState){var e=a.status||0;if(200===e){try{switch(n){case"text":return void i(a.responseText);case"json":var t=_.parseJSON(a.responseText);return void i(t,a);case"xml":return void(a.responseXML&&a.responseXML.documentElement?i(a.responseXML.documentElement,a):r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:a.responseText}))}i(a.response||a.responseText,a)}catch(s){r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:s})}return}return void r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:a.responseText})}0===a.readyState&&r({type:o.WEBIM_CONNCTION_AJAX_ERROR,data:a.responseText})},t.responseType&&a.responseType&&(a.responseType=t.responseType),t.mimeType&&_.hasOverrideMimeType&&a.overrideMimeType(t.mimeType);var s=t.type||"POST",c=t.data||null,u="";if("get"===s.toLowerCase()&&c){for(var l in c)c.hasOwnProperty(l)&&(u+=l+"="+c[l]+"&");u=u?u.slice(0,-1):u,t.url+=(t.url.indexOf("?")>0?"&":"?")+(u?u+"&":u)+"_v="+(new Date).getTime(),c=null,u=null}if(a.open(s,t.url),_.isCanSetRequestHeader){var d=t.headers||{};for(var p in d)d.hasOwnProperty(p)&&a.setRequestHeader(p,d[p])}return a.send(c),a},ts:function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),o=e.getSeconds(),i=e.getMilliseconds();return(t<10?"0"+t:t)+":"+(n<10?"0"+n:n)+":"+(o<10?"0"+o:o)+":"+i+" "},getObjectKey:function(e,t){for(var n in e)if(e[n]==t)return n;return""}};t.utils=_}()},function(e,t,n){!function(){"use strict";var e=n(27).utils,o=function(e,t){return!this instanceof o?new o(e):(this._msg={},"function"==typeof o[e]&&(o[e].prototype.setGroup=this.setGroup,this._msg=new o[e](t)),this._msg)};o.prototype.setGroup=function(e){this.body.group=e},o.txt=function(e){this.id=e,this.type="txt",this.body={}},o.txt.prototype.set=function(e){this.value=e.msg,this.body={id:this.id,to:e.to,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success,fail:e.fail},!e.roomType&&delete this.body.roomType},o.cmd=function(e){this.id=e,this.type="cmd",this.body={}},o.cmd.prototype.set=function(e){this.value="",this.body={to:e.to,action:e.action,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success},!e.roomType&&delete this.body.roomType},o.location=function(e){this.id=e,this.type="loc",this.body={}},o.location.prototype.set=function(e){this.body={to:e.to,type:this.type,roomType:e.roomType,addr:e.addr,lat:e.lat,lng:e.lng,ext:e.ext||{}}},o.img=function(e){this.id=e,this.type="img",this.body={}},o.img.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.body={id:this.id,file:this.value,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,width:t.width,height:t.height,body:t.body,uploadError:t.uploadError,uploadComplete:t.uploadComplete},!t.roomType&&delete this.body.roomType},o.audio=function(e){this.id=e,this.type="audio",this.body={}},o.audio.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},length:t.length||0,roomType:t.roomType,file_length:t.file_length,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},o.file=function(e){this.id=e,this.type="file",this.body={}},o.file.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},o.video=function(e){},o.video.prototype.set=function(e){};var i=function(e){return!this instanceof i?new i(e,conn):void(this.msg=e)};i.prototype.send=function(t){var n=this,o=function(n){n.ext=n.ext||{},n.ext.weichat=n.ext.weichat||{},n.ext.weichat.originType=n.ext.weichat.originType||"webim";var o={from:t.context.userId||"",to:n.to,bodies:[n.body],ext:n.ext||{}},i=e.stringify(o),r=$msg({type:n.group||"chat",to:n.toJid,id:n.id,xmlns:"jabber:client"}).c("body").t(i);n.roomType&&r.up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"}),setTimeout(function(){"undefined"!=typeof _msgHash&&_msgHash[n.id]&&_msgHash[n.id].msg.fail instanceof Function&&_msgHash[n.id].msg.fail(n.id)},6e4),t.sendCommand(r.tree(),n.id)};if(n.msg.file){if(n.msg.body&&n.msg.body.url)return void o(n.msg);var i=n.msg.onFileUploadComplete,r=function(e){if(e.entities[0]["file-metadata"]){var r=e.entities[0]["file-metadata"]["content-length"];n.msg.file_length=r,n.msg.filetype=e.entities[0]["file-metadata"]["content-type"],r>204800&&(n.msg.thumbnail=!0)}n.msg.body={type:n.msg.type||"file",url:("https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+e.uri.substr(e.uri.indexOf("/",9)):e.uri)+"/"+e.entities[0].uuid,secret:e.entities[0]["share-secret"],filename:n.msg.file.filename||n.msg.filename,size:{width:n.msg.width||0,height:n.msg.height||0},length:n.msg.length||0,file_length:n.msg.file_length||0,filetype:n.msg.filetype},o(n.msg),i instanceof Function&&i(e,n.msg.id)};n.msg.onFileUploadComplete=r,e.uploadFile.call(t,n.msg)}else n.msg.body={type:"chat"===n.msg.type?"txt":n.msg.type,msg:n.msg.msg},"cmd"===n.msg.type?n.msg.body.action=n.msg.action:"loc"===n.msg.type&&(n.msg.body.addr=n.msg.addr,n.msg.body.lat=n.msg.lat,n.msg.body.lng=n.msg.lng),o(n.msg)},t._msg=i,t.message=o}()},function(e,t){!function(){function e(e){this.array=void 0===e?[]:new Array(e)}e.prototype={length:function(){return this.array.length},at:function(e){return this.array[e]},set:function(e,t){this.array[e]=t},push:function(e){return this.array.push(e)},slice:function(e,t){return this.array=this.array.slice(e,t)},concat:function(e){this.array=this.array.concat(e)},remove:function(e,t){t=void 0===t?1:t,this.array.splice(e,t)},join:function(e){return this.array.join(e)},clear:function(){this.array.length=0}};var n=function(){this._array_h=new e};n.prototype={_index:0,push:function(e){this._array_h.push(e)},pop:function(){var e=null;return this._array_h.length()&&(e=this._array_h.at(this._index),2*++this._index>=this._array_h.length()&&(this._array_h.slice(this._index),this._index=0)),e},head:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(t-1)),e},tail:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(this._index)),e},length:function(){return this._array_h.length()-this._index},empty:function(){return 0===this._array_h.length()},clear:function(){this._array_h.clear()}},t.Queue=n}()},function(e,t){function n(e,t){i[e]||(i[e]=[]),i[e].push(t)}function o(e,t){t.push(e),_.each(i[e],function(e){e.apply(null,t)})}var i={};e.exports={add:n,excuteCallbacks:o}},function(e,t,n){function o(e){var t=setTimeout(function(){e()},D.FIRST_CHANNEL_CONNECTION_TIMEOUT);A=new k.connection({url:M.xmppServer,retry:!0,isMultiLoginSessions:M.resources,heartBeatWait:D.HEART_BEAT_INTERVAL}),A.listen({onOpened:function(n){clearTimeout(t),w=n.accessToken,A.setPresence(),e(n)},onTextMessage:function(e){u(e,"txt")},onEmojiMessage:function(e){u(e,"emoji")},onPictureMessage:function(e){u(e,"img")},onFileMessage:function(e){u(e,"file")},onCmdMessage:function(e){u(e,"cmd")},onOnline:function(){L.isMobile&&V()},onOffline:function(){L.isMobile&&A.close(),j.excuteCallbacks(D.SYSTEM_EVENT.OFFLINE,[])},onError:function(e){e.reconnect?V():e.type===D.IM.WEBIM_CONNCTION_AUTH_ERROR?V():e.type===D.IM.WEBIM_CONNCTION_CALLBACK_INNER_ERROR?console.error(e.data):console.error(e)}}),V()}function i(e,t){if(t)switch(e){case"txt":T(t,0);break;default:A.send(t)}}function r(e,t){var n=L.uuid(),o=new k.message.txt(n);o.set({msg:e,to:M.toUser,success:function(e){},fail:function(e){}}),t&&_.extend(o.body,t),m(o),f(o,n),A.send(o.body),q.set(n,o),O(n),e&&(v({id:n,type:"txt",data:e},{isReceived:!1,isHistory:!1}),h({hasTransferedToKefu:"转人工"===e||"转人工客服"===e}),j.excuteCallbacks(D.SYSTEM_EVENT.MESSAGE_SENT,[]))}function a(e,t){var n=L.uuid(),o=new k.message.cmd(n);o.set({to:M.toUser,action:"TransferToKf",ext:{weichat:{ctrlArgs:{id:e,serviceSessionId:t}}}}),f(o,n),A.send(o.body),q.set(n,o),O(n),h({hasTransferedToKefu:!0}),j.excuteCallbacks(D.SYSTEM_EVENT.MESSAGE_SENT,[])}function s(e,t){var n=L.uuid(),o=new k.message.img(n);t&&(t.value=""),o.set({apiUrl:location.protocol+"//"+M.restServer,file:e,accessToken:w,to:M.toUser,uploadError:function(e){var t=e.id,n=document.getElementById(t+"_loading"),o=document.querySelector("#"+t+" .em-widget-msg-container");o&&(o.innerHTML='<i class="icon-broken-pic"></i>'),L.addClass(n,"hide")},success:function(e){p(e)},fail:function(e){d(e)}}),m(o),f(o,n),v({id:n,type:"img",url:e.url},{isReceived:!1,isHistory:!1}),A.send(o.body),q.set(n,o),b(n,e.data),U.imgFileList.set(e.url,e.data),j.excuteCallbacks(D.SYSTEM_EVENT.MESSAGE_SENT,[])}function c(e,t){var n=L.uuid(),o=new k.message.file(n);t&&(t.value=""),o.set({apiUrl:location.protocol+"//"+M.restServer,file:e,to:M.toUser,uploadError:function(e){var t=e.id,n=document.getElementById(t+"_loading"),o=document.querySelector("#"+t+" .em-widget-msg-container");o&&(o.innerHTML='<i class="icon-broken-pic"></i>'),L.addClass(n,"hide")},success:function(e){p(e)},fail:function(e){d(e)}}),m(o),v({id:n,type:"file",url:e.url,filename:e.filename,fileLength:e.data.size},{isReceived:!1,isHistory:!1}),A.send(o.body),j.excuteCallbacks(D.SYSTEM_EVENT.MESSAGE_SENT,[])}function u(e,t,n){var o,i,r,a,s=t||e&&e.type,c=L.getDataByPath(e,"ext.weichat.event.eventName"),u=L.getDataByPath(e,"ext.weichat.event.eventObj"),l=L.getDataByPath(e,"ext.weichat.msgId"),d=!e.from||e.from.toLowerCase()!==M.user.username.toLowerCase(),p=L.getDataByPath(e,"ext.weichat.official_account"),f=L.getDataByPath(e,"ext.weichat.marketing.marketing_task_id"),m=p&&p.official_account_id;if(!H.get(l)&&(l&&H.set(l,e),n||!e.from||e.from.toLowerCase()==M.toUser.toLowerCase()||e.noprompt)){switch(p&&S(p),a=y(m),"inviteEnquiry"===L.getDataByPath(e,"ext.weichat.ctrlType")?s="satisfactionEvaluation":d&&L.getDataByPath(e,"ext.msgtype.choice")?s="robotList":"TransferToKfHint"===L.getDataByPath(e,"ext.weichat.ctrlType")?s="robotTransfer":"ServiceSessionWillScheduleTimeoutEvent"===c&&u&&"true"===u.ticketEnable&&(s="transferToTicket"),s){case"txt":o=e,o.type=s,o.brief=o.data.replace(/\n/gm," ");break;case"emoji":o=e,o.type=s,o.brief=_.map(o.data,function(e){return"emoji"===e.type?"[表情]":e.data}).join("").replace(/\n/gm," ");break;case"img":o=e,o.type=s,o.brief="[图片]";break;case"file":o=e,o.type=s,o.brief="[文件]";break;case"cmd":var h=e.action;if("KF-ACK"===h)return void I(e.ext.weichat.ack_for_msg_id);if("KEFU_MESSAGE_RECALL"===h){var E=e.ext.weichat.recall_msg_id,T=document.getElementById(E);L.addClass(T,"hide")}break;case"satisfactionEvaluation":i=e.ext.weichat.ctrlArgs.inviteId,r=e.ext.weichat.ctrlArgs.serviceSessionId,o=e,o.type="list",o.data="请对我的服务做出评价",o.list=['<div class="em-btn-list"><button class="bg-hover-color js_satisfybtn" data-inviteid="'+i+'" data-servicesessionid="'+r+'">立即评价</button></div>'],o.brief="[菜单]",!n&&j.excuteCallbacks(D.SYSTEM_EVENT.SATISFACTION_EVALUATION_MESSAGE_RECEIVED,[a,i,r]);break;case"article":o=e,o.type="article";break;case"robotList":o=e,o.type="list",o.list='<div class="em-btn-list">'+_.map(e.ext.msgtype.choice.items,function(e){var t=e.id,n=e.name,o="js_robotbtn ";return o+="TransferToKf"===e.id?"white bg-color border-color bg-hover-color-dark":"bg-hover-color",'<button class="'+o+'" data-id="'+t+'">'+n+"</button>"}).join("")||"</div>",o.data=e.ext.msgtype.choice.title,o.brief="[菜单]";break;case"skillgroupMenu":o=e,o.type="list",o.list='<div class="em-btn-list">'+_.map(e.data.children,function(e){var t=e.queueName,n=e.menuName,o="js_skillgroupbtn bg-hover-color";return'<button class="'+o+'" data-queue-name="'+t+'">'+n+"</button>"}).join("")||"</div>",o.data=e.data.menuName,o.brief="[菜单]";break;case"robotTransfer":var N=e.ext.weichat.ctrlArgs;o=e,o.type="list",o.data=o.data||L.getDataByPath(e,"ext.weichat.ctrlArgs.label"),o.list=['<div class="em-btn-list">','<button class="white bg-color border-color bg-hover-color-dark js_robotTransferBtn" ','data-sessionid="'+N.serviceSessionId+'" ','data-id="'+N.id+'">'+N.label+"</button>","</div>"].join(""),o.brief="[菜单]";break;case"transferToTicket":o=e,o.type="list",o.list=['<div class="em-btn-list">','<button class="white bg-color border-color bg-hover-color-dark js-transfer-to-ticket">',"留言","</button>","</div>"].join(""),o.brief="[菜单]";break;default:console.error("unexpected msg type")}if(!n)if(f&&"txt"===s&&j.excuteCallbacks(D.SYSTEM_EVENT.MARKETING_MESSAGE_RECEIVED,[a,f,e]),c)g(c,u,e);else{var O=L.getDataByPath(e,"ext.weichat.agent");O&&(a.agentNickname=O.userNickname,a.agentAvatar=O.avatar,j.excuteCallbacks(D.SYSTEM_EVENT.AGENT_INFO_UPDATE,[a]))}!o||"txt"===s&&!o.data||"article"===s&&_.isEmpty(L.getDataByPath(e,"ext.msgtype.articles"))||(o.id=l,v(o,{isReceived:d,isHistory:n,officialAccount:a,timestamp:e.timestamp}),n||(e.noprompt||C(o,a),o.value=o.data,transfer.send({event:D.EVENTS.ONMESSAGE,data:{from:e.from,to:e.to,message:o}})))}}function l(e){var t,n=e.body||{},o=L.getDataByPath(n,"bodies.0")||{},i=o.url,r=e.timestamp||n.timestamp;return n.from!==M.user.username&&(t=o.file_length),i&&!/^https?/.test(i)&&(i=location.protocol+M.domain+i),{data:o.msg,url:i,filename:o.filename,action:o.action,type:o.type,msgId:e.msg_id,fromUser:e.from_user,timestamp:r,fileLength:t,ext:n.ext,to:n.to,from:n.from}}function d(e){L.addClass(document.getElementById(e+"_loading"),"hide"),L.removeClass(document.getElementById(e+"_failed"),"hide")}function p(e){L.addClass(document.getElementById(e+"_loading"),"hide"),L.addClass(document.getElementById(e+"_failed"),"hide")}function f(e,t){e.body.ext.weichat.msg_id_for_ack=t}function m(e){var t=U.currentOfficialAccount||U.systemOfficialAccount,n=t.official_account_id,o=t.bindAgentUsername,i=t.bindSkillGroupName;e.body.ext=e.body.ext||{},e.body.ext.weichat=e.body.ext.weichat||{},i?e.body.ext.weichat.queueName=i:M.emgroup&&(e.body.ext.weichat.queueName=e.body.ext.weichat.queueName||M.emgroup),_.isEmpty(M.visitor)||(e.body.ext.weichat.visitor=M.visitor),o?e.body.ext.weichat.agentUsername=o:M.agentName&&(e.body.ext.weichat.agentUsername=M.agentName),M.grUserId&&(e.body.ext.weichat.visitor=e.body.ext.weichat.visitor||{},e.body.ext.weichat.visitor.gr_user_id=M.grUserId),"default"!==n&&(e.body.ext.weichat.official_account={official_account_id:n})}function h(e){var t=e&&e.hasTransferedToKefu,n=e&&e.officialAccountId,o=y(n),i=o.sessionState,r=t?U.hasHumanAgentOnline:U.hasHumanAgentOnline||U.hasRobotAgentOnline;r||R||i===D.SESSION_STATE.PROCESSING||(R=!0,E(D.eventMessageText.NOTE,{ext:{weichat:{official_account:o}}}))}function g(e,t,n){var o=D.SYSTEM_EVENT_MSG_TEXT[e],i=L.getDataByPath(n,"ext.weichat.official_account.official_account_id"),r=y(i);switch(o&&E(o,n),e){case D.SYSTEM_EVENT.SESSION_TRANSFERED:r.agentId=t.userId,r.agentType=t.agentType,r.agentAvatar=t.avatar,r.agentNickname=t.agentUserNiceName,r.sessionState=D.SESSION_STATE.PROCESSING,r.isSessionOpen=!0;break;case D.SYSTEM_EVENT.SESSION_TRANSFERING:r.sessionState=D.SESSION_STATE.WAIT,r.isSessionOpen=!0,r.skillGroupId=null;break;case D.SYSTEM_EVENT.SESSION_CLOSED:r.sessionState=D.SESSION_STATE.ABORT,r.agentId=null,r.sessionId=null,r.skillGroupId=null,r.isSessionOpen=!1,r.hasReportedAttributes=!1,transfer.send({event:D.EVENTS.ONSESSIONCLOSED});break;case D.SYSTEM_EVENT.SESSION_OPENED:r.sessionState=D.SESSION_STATE.PROCESSING,r.agentType=t.agentType,r.agentId=t.userId,r.sessionId=t.sessionId,r.agentAvatar=t.avatar,r.agentNickname=t.agentUserNiceName,r.isSessionOpen=!0;break;case D.SYSTEM_EVENT.SESSION_CREATED:r.sessionState=D.SESSION_STATE.WAIT,r.sessionId=t.sessionId,r.isSessionOpen=!0}j.excuteCallbacks(e,[r]),h({officialAccountId:i})}function E(e,t){if(!M.hideStatus){var n=L.getDataByPath(t,"ext.weichat.official_account.official_account_id"),o=y(n);o.messageView.appendEventMsg(e)}}function y(e){return e?_.findWhere(U.officialAccountList,{official_account_id:e}):U.systemOfficialAccount}function v(e,t){var n=t||{},o=n.isReceived,i=n.isHistory,r=n.officialAccount||U.currentOfficialAccount||U.systemOfficialAccount;r.messageView.appendMsg(e,n),!o||i||e.noprompt||j.excuteCallbacks(D.SYSTEM_EVENT.MESSAGE_APPENDED,[r,e])}function S(e){var t=e.official_account_id,n=_.findWhere(U.officialAccountList,{official_account_id:t});if(!n){var o=e.type,i=e.img,r=e.name,a={official_account_id:t,type:o,img:i,name:r};if("SYSTEM"===o)_.isEmpty(U.systemOfficialAccount)?(U.systemOfficialAccount=a,U.officialAccountList.push(a),a.unopenedMarketingTaskIdList=new P,a.unrepliedMarketingTaskIdList=new P,a.unreadMessageIdList=new P,j.excuteCallbacks(D.SYSTEM_EVENT.NEW_OFFICIAL_ACCOUNT_FOUND,[a])):U.systemOfficialAccount.official_account_id!==t&&(U.systemOfficialAccount.official_account_id=t,U.systemOfficialAccount.img=i,U.systemOfficialAccount.name=r,j.excuteCallbacks(D.SYSTEM_EVENT.SYSTEM_OFFICIAL_ACCOUNT_UPDATED,[]));else{if("CUSTOM"!==o)throw"unexpected official_account type.";U.ctaEnable=!0,U.officialAccountList.push(a),a.unopenedMarketingTaskIdList=new P,a.unrepliedMarketingTaskIdList=new P,a.unreadMessageIdList=new P,j.excuteCallbacks(D.SYSTEM_EVENT.NEW_OFFICIAL_ACCOUNT_FOUND,[a])}}}function T(e,t){var n=q.get(e),o=L.getDataByPath(n,"body.body"),i=L.getDataByPath(n,"body.ext"),r="number"==typeof t?t:D.SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT;W.sendMsgChannel(o,i).then(function(){I(e)},function(){r>0?T(e,--r):d(e)})}function N(e,t,n){var o=q.get(e),i="number"==typeof n?n:D.SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT;W.uploadImgMsgChannel(t).then(function(t){o.body.body={filename:t.fileName,type:"img",url:t.url},T(e,0)},function(){i>0?N(o,t,--i):d(e)})}function I(e){clearTimeout(G.get(e)),G.remove(e),p(e),q.remove(e)}function O(e){G.set(e,setTimeout(function(){T(e)},D.FIRST_CHANNEL_MESSAGE_TIMEOUT))}function b(e,t){G.set(e,setTimeout(function(){N(e,t)},D.FIRST_CHANNEL_IMG_MESSAGE_TIMEOUT))}function C(e,t){var n=t.type,o=e.brief,i="CUSTOM"===n?t.img:U.systemAgentAvatar||U.tenantAvatar||U.defaultAvatar;!L.isBrowserMinimized()&&U.isChatWindowOpen||(j.excuteCallbacks(D.SYSTEM_EVENT.MESSAGE_PROMPT,[]),transfer.send({event:D.EVENTS.SLIDE}),transfer.send({event:D.EVENTS.NOTIFY,data:{avatar:i,title:"新消息",brief:o}}))}var R,x,w,M,A,k=n(24),L=n(12),D=n(13),B=n(20),P=n(32),U=n(19),F=n(33),j=n(30),W=n(17),G=new B,q=new B,H=new B,V=F.retryThrottle(function(){var e={user:M.user.username,appKey:M.appKey,apiUrl:location.protocol+"//"+M.restServer};M.user.token?e.accessToken=M.user.token:e.pwd=M.user.password,A.open(e),j.excuteCallbacks(D.SYSTEM_EVENT.IM_CONNECTION_OPENED,[A])},{resetTime:6e5,waitTime:2e3,retryLimit:3});e.exports={init:function(){M=U.config},initConnection:o,reSend:i,sendTransferToKf:a,sendText:r,sendImg:s,sendFile:c,attemptToAppendOfficialAccount:S,handleHistoryMsg:function(e){u(l(e),null,!0)},initSecondChannle:function(){x=clearInterval(x),x=setInterval(function(){W.receiveMsgChannel().then(function(e){_.each(e,function(e){u(l({body:e}),null,!1)})})},D.SECOND_CHANNEL_MESSAGE_RECEIVE_INTERVAL)},handleMessage:u}},function(e,t){var n=function(){this.list=[]};n.prototype.add=function(e){~this.list.indexOf(e)||this.list.push(e)},n.prototype.remove=function(e){var t=this.list.indexOf(e);t>=0&&this.list.splice(t,1)},n.prototype.getAll=function(){return this.list},n.prototype.getLength=function(){return this.list.length},n.prototype.removeAll=function(){this.list.length=0},e.exports=n},function(e,t){function n(e,t){if("function"!=typeof e)throw"unexpect type of fn.";var n=t||{},o=_.now(),i=n.retryLimit||3,r=n.resetTime||6e5,a=n.waitTime||3e3,s=0,c=_.throttle(e,a);return function(){_.now()-o<r?s<i&&(s++,c()):(o=_.now(),s=1,c())}}e.exports={retryThrottle:n}},function(e,t,n){function o(){E.blur(),E.value="",l=null,d.removeClass(s,"sel"),y.innerHTML=""}function i(e,t,n,o,i){m.sendText("",{ext:{weichat:{ctrlType:"enquiry",ctrlArgs:{inviteId:o||"",serviceSessionId:n||"",detail:t,summary:e,appraiseTags:i}}}})}function r(){f.getEvaluationDegrees().then(function(e){g.innerHTML=_.chain(e).sortBy("level").map(function(e,t){var n=t+1,o=e.name,i=e.id,r=e.score;return'<li data-level="'+n+'" title="'+o+'" data-evaluate-id="'+i+'" data-score="'+r+'">H</li>'}).value().join(""),s=g.querySelectorAll("li")})}function a(e){f.getAppraiseTags(e).then(function(e){y.innerHTML=_.map(e,function(e){var t=e.name,n=e.id;return'<span data-label-id = "'+n+'" class="tag">'+t+"</span>"}).join(""),d.removeClass(y,"hide")})}var s,c,u,l,d=n(12),p=n(16),f=n(17),m=n(31),h=d.createElementFromHTML(["<div>","<h3>请对我的服务做出评价</h3>","<ul></ul>",'<div class="tag-container"></div>','<textarea spellcheck="false" placeholder="请输入留言"></textarea>',"</div>"].join("")),g=h.querySelector("ul"),E=h.querySelector("textarea"),y=h.querySelector(".tag-container"),v=p.createDialog({contentDom:h,className:"satisfaction"}).addButton({confirmText:"提交",confirm:function(){var e=y.querySelectorAll(".selected"),t=y.querySelectorAll(".tag"),n=E.value,r=_.map(e,function(e){return{id:e.getAttribute("data-label-id"),name:e.innerText}});return l?t.length>0&&0===e.length?(p.tip("请先选择标签"),!1):(i(l,n,c,u,r),p.showSuccess("提交成功"),o(),void 0):(p.tip("请先选择星级"),!1)}});d.live("li","click",function(e){var t=this.getAttribute("data-evaluate-id"),n=+this.getAttribute("data-level");l=this.getAttribute("data-score"),n&&_.each(s,function(e,t){d.toggleClass(e,"sel",t<n)}),t&&a(t)},g),d.live("span.tag","click",function(e){d.toggleClass(this,"selected")},y),e.exports={show:function(e,t){c=t,u=e,r(),v.show()}}},function(e,t,n){var o=n(12),i=n(13),r=n(19),a=document.querySelector("div.img-view"),s=a.querySelector("img");o.on(a,"click",function(){o.addClass(a,"hide")},!1),e.exports={show:function(e){o.isTop||o.isMobile?(s.setAttribute("src",e),o.removeClass(a,"hide")):transfer.send({event:i.EVENTS.SHOW_IMG,data:{imgSrc:e,imgFile:r.imgFileList.get(e)}})}}},function(e,t,n){function o(){u.grayList.noteCategory&&l.getNoteCategories().then(function(e){if(!_.isEmpty(e)){s.removeClass(y,"hide");var t=_.map(e,function(e){return{sign:e.id,desc:e.name}});d({list:t,container:y})}})}function i(){Promise.all([l.getToken(),l.getProjectId()]).then(function(e){var t=e[0],n=e[1];l.createTicket({
token:t,projectId:n,name:h.value,phone:g.value,mail:E.value,content:m.value,category_id:y.selectValue}).then(function(){p=!1,c.showSuccess("留言发送成功"),r()},function(e){p=!1,c.tip("留言失败，请稍后重试"),console.error(e)})})["catch"](function(e){c.tip("留言失败，token无效"),console.error(e)})}function r(){h.value="",g.value="",E.value="",m.value=""}function a(e){m.value=e.content||"",h.value=e.name||"",g.value=e.phone||"",E.value=e.mail||""}var s=n(12),c=n(16),u=n(19),l=n(17),d=n(37),p=!1,f=s.createElementFromHTML(['<div class="wrapper">',"<h3>请填写以下内容以方便我们及时联系您</h3>",'<input type="text" class="name" placeholder="姓名">','<input type="text" class="phone" placeholder="电话">','<input type="text" class="mail" placeholder="邮箱">','<div class="note-category hide"></div>','<textarea spellcheck="false" placeholder="请输入留言"></textarea>',"</div>"].join("")),m=f.querySelector("textarea"),h=f.querySelector(".name"),g=f.querySelector(".phone"),E=f.querySelector(".mail"),y=f.querySelector(".note-category"),v=c.createDialog({contentDom:f,className:"ticket"}).addButton({confirmText:"留言",confirm:function(){return p?c.tip("留言提交中..."):!h.value||h.value.length>140?c.tip("姓名输入不正确"):!g.value||g.value.length>24?c.tip("电话输入不正确"):!E.value||E.value.length>127?c.tip("邮箱输入不正确"):!m.value||m.value.length>1500?c.tip("留言内容不能为空，长度小于1500字"):(p=!0,setTimeout(function(){p=!1},1e4),i()),!1}}),S=v.el.querySelector(".cancel-btn");e.exports=function(e){e=e||{},o(),e.preData&&a(e.preData),e.hideCloseBtn&&s.addClass(S,"hide"),v.show()}},function(e,t,n){function o(){g.live("li.itm-select","click",u,p),g.on(d,"click",s),g.on(document,"click",function(e){var t=window.event||e,n=t.srcElement||t.target;g.hasClass(n,"em-select")||g.hasClass(n.parentNode,"em-select")||c()})}function i(){var e=r(l);p.style.top=e.top+1+"px",p.style.left=e.left+1+"px",p.style.width=e.width+"px"}function r(e){for(var t=0,n=0,o=e;o!==document.body&&null!==o;)n+=o.offsetLeft,t+=o.offsetTop,o=o.offsetParent;return{width:e.clientWidth,height:e.clientHeight,left:n,top:t}}function a(){var e='<ul class="em-popuplist hide '+m+'">';return e+=_.map(h,function(e){return'<li class="itm-select" data-sign="'+e.sign+'">'+e.desc+"</li>"}).join(""),e+="</ul>",g.createElementFromHTML(e)}function s(){g.removeClass(p,"hide")}function c(){g.addClass(p,"hide")}function u(e){l.selectValue=this.getAttribute("data-sign"),d.querySelector(".em-select-desc").innerText=this.innerText}var l,d,p,f,m,h,g=n(12);e.exports=function(e){if(e=e||{},f=e.selectClassName||"",m=e.popuplistClassName||"",l=e.container,h=e.list,_.isArray(h)&&!_.isEmpty(h)&&l){var t=g.createElementFromHTML('<div class="em-select '+f+'"><label class="em-select-desc"></label><span class="icon-arrow-up-down em-select-icon"></span></div>');d?l.replaceChild(t,d):l.appendChild(t),d=t;var n=a(e);p?document.body.replaceChild(n,p):document.body.appendChild(n),p=n,i(),o(),l.selectValue=h[0].sign,d.querySelector(".em-select-desc").innerText=h[0].desc}}},function(e,t,n){function o(e){/^image\/\w+$/.test(a.getDataByPath(e,"clipboardData.items.0.type"))&&(i=e.clipboardData.items[0].getAsFile(),r=window.URL.createObjectURL(i),u.src=r,l.show())}var i,r,a=n(12),s=n(16),c=n(31),u=document.createElement("img"),l=s.createDialog({contentDom:u,className:"mini paste-image"}).addButton({confirmText:"发送",confirm:function(){c.sendImg({data:i,url:r})}});e.exports=function(){a.on(document.querySelector(".em-widget-send-wrapper .em-widget-textarea"),"paste",o)}},function(e,t,n){function o(){I.stop(),O.show(),T&&T.getTracks().forEach(function(e){e.stop()}),N&&N.getTracks().forEach(function(e){e.stop()}),E.src="",y.src=""}function i(){Modernizr.peerconnection&&l.grayList.audioVideo&&(d.add(s.SYSTEM_EVENT.IM_CONNECTION_OPENED,r),d.add(s.SYSTEM_EVENT.OFFLINE,o))}function r(e){a=l.config,m.style.display="",f.classList.remove("hide"),f.addEventListener("click",function(){v.show()},!1),m.addEventListener("click",function(e){var t=e.target.className;Object.keys(b).forEach(function(e){~t.indexOf(e)&&b[e]()})},!1),S=new WebIM.WebRTC.Call({connection:e,mediaStreamConstaints:{audio:!0,video:!0},listener:{onAcceptCall:function(e,t){console.log("onAcceptCall",e,t)},onGotRemoteStream:function(e){console.log("onGotRemoteStream",e),E.src=URL.createObjectURL(e),N=e,E.play()},onGotLocalStream:function(e){console.log("onGotLocalStream",e),y.src=URL.createObjectURL(e),T=e,y.play()},onRinging:function(e){console.log("onRinging",e),y.muted=!0,E.muted=!1,O.isConnected=!1,_.classList.add("hide"),g.classList.add("hide"),p.classList.add("has-video"),I.start("视频连接请求，等待你的确认"),h.classList.remove("hide")},onTermCall:function(){console.log("onTermCall"),o()},onError:function(e){console.log(e&&e.message?e.message:"An error occured when calling webrtc")}}})}var a,s=n(13),c=n(16),u=n(31),l=n(19),d=n(30),p=document.getElementById("em-kefu-webim-chat"),f=document.querySelector(".em-video-invite"),m=document.querySelector(".em-widget-video"),h=m.querySelector(".btn-accept-call"),g=m.querySelector(".toolbar-control"),_=m.querySelector(".sub-win"),E=m.querySelector("video.main"),y=m.querySelector("video.sub"),v=c.createDialog({contentDom:['<p class="prompt">',"您要邀请客服为您进行实时视频服务么？点击确认发送邀请，等待客服接受后即可体验实时视频服务。","</p>"].join(""),className:"rtc-video-confirm"}).addButton({confirm:function(){u.sendText("邀请客服进行实时视频",{ext:{type:"rtcmedia/video",msgtype:{liveStreamInvitation:{msg:"邀请客服进行实时视频",orgName:a.orgName,appName:a.appName,userName:a.user.username,imServiceNumber:a.toUser,restServer:a.restServer,xmppServer:a.xmppServer,resource:"webim"}}}})}}),S=null,T=null,N=null,I={timer:null,counter:0,prompt:m.querySelector(".status p.prompt"),timeSpan:m.querySelector(".status p.time-escape"),start:function(e){function t(e){return new Date(1e3*e).toISOString().slice(-"00:00.000Z".length).slice(0,"00:00".length)}var n=this;n.counter=0,n.prompt.innerHTML=e,n.timeSpan.innerHTML="00:00",n.timer=setInterval(function(){n.timeSpan.innerHTML=t(++n.counter)},1e3)},stop:function(){var e=this;clearInterval(e.timer)}},O={isConnected:!1,timer:null,delay:3e3,closingPrompt:m.querySelector(".full-screen-prompt"),timeSpan:m.querySelector(".full-screen-prompt p.time-escape"),show:function(){var e=this;e.isConnected?e.timeSpan.innerHTML=I.timeSpan.innerHTML:e.timeSpan.innerHTML="00:00",e.closingPrompt.classList.remove("hide"),setTimeout(function(){p.classList.remove("has-video"),e.closingPrompt.classList.add("hide")},e.delay)}},b={"btn-end-call":function(){try{S.endCall()}catch(e){console.error("end call:",e)}finally{o()}},"btn-accept-call":function(){O.isConnected=!0,h.classList.add("hide"),g.classList.remove("hide"),_.classList.remove("hide"),I.stop(),I.start("视频通话中"),S.acceptCall()},"btn-toggle":function(){T&&T.getVideoTracks().forEach(function(e){e.enabled=!e.enabled})},"btn-change":function(){var e;e=y.src,y.src=E.src,E.src=e,y.play(),E.play(),y.muted=!y.muted,E.muted=!E.muted},"btn-minimize":function(){m.classList.add("minimized")},"btn-maximize":function(){m.classList.remove("minimized")}};e.exports={initEventListener:i}},function(e,t,n){function o(e){if(e===c.currentOfficialAccount&&e&&c.isChatWindowOpen&&!s.isBrowserMinimized()){var t=e.sessionState,n=e.sessionId,o=e.agentType;n&&t===a.SESSION_STATE.PROCESSING&&o!==a.AGENT_ROLE.ROBOT?l.getAgentInputState(n).then(function(e){var t=e.timestamp,n=e.input_state_tips;t>d&&(d=t,s.toggleClass(r,"hide",!n))}):s.addClass(r,"hide")}}var i,r,a=n(13),s=n(12),c=n(19),u=n(30),l=n(17),d=0;e.exports=function(){if(c.grayList.agentInputStateEnable){var e=document.querySelector(".em-widget-header");r=e.querySelector(".em-agent-input-state"),i=setInterval(function(){var e=c.currentOfficialAccount;o(e)},a.AGENT_INPUT_STATE_INTERVAL),u.add(a.SYSTEM_EVENT.SESSION_OPENED,o),u.add(a.SYSTEM_EVENT.SESSION_CLOSED,o),u.add(a.SYSTEM_EVENT.SESSION_TRANSFERED,o),u.add(a.SYSTEM_EVENT.SESSION_RESTORED,o),u.add(a.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,o)}}},function(e,t,n){function o(e){if(e===u.currentOfficialAccount&&e&&u.isChatWindowOpen&&!c.isBrowserMinimized()){var t=e.agentId,n=e.agentType,o=e.isSessionOpen;n===s.AGENT_ROLE.ROBOT?i("Online"):u.isAgentNicknameEnable&&t&&o?d.getAgentStatus(t).then(function(t){e.agentState=t,i(t)}):i(null)}}function i(e){var t=s.agentStatusText[e||"Other"];r.innerText=t}var r,a,s=n(13),c=n(12),u=n(19),l=n(30),d=n(17);e.exports=function(){var e=document.querySelector(".em-widget-header");r=e.querySelector(".em-header-status-text"),a=setInterval(function(){var e=u.currentOfficialAccount;o(e)},5e3),l.add(s.SYSTEM_EVENT.SESSION_OPENED,o),l.add(s.SYSTEM_EVENT.SESSION_TRANSFERED,o),l.add(s.SYSTEM_EVENT.SESSION_CLOSED,o),l.add(s.SYSTEM_EVENT.SESSION_TRANSFERING,o),l.add(s.SYSTEM_EVENT.SESSION_RESTORED,o),l.add(s.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,function(e){i(e.status)})}},function(e,t,n){function o(e){if(e===l.currentOfficialAccount&&e&&l.isChatWindowOpen&&!u.isBrowserMinimized()){var t=e.sessionState,n=e.skillGroupId,o=e.sessionId,r=e.official_account_id;t===c.SESSION_STATE.WAIT&&o?n?p.getWaitListNumber(o,n).then(function(e){var t=e.visitorUserWaitingNumber,n=e.visitorUserWaitingTimestamp;n>f&&(f=n,i(t))}):p.getLastSession(r).then(function(t){e.skillGroupId=t.skill_group_id}):i(null)}}function i(e){e&&"no"!==e?(u.removeClass(a,"hide"),s.innerHTML=e):u.addClass(a,"hide")}var r,a,s,c=n(13),u=n(12),l=n(19),d=n(30),p=n(17),f=0;e.exports=function(){if(l.grayList.waitListNumberEnable){var e=document.querySelector(".em-widget-send-wrapper");a=e.querySelector(".queuing-number-status"),s=a.querySelector("label"),r=setInterval(function(){var e=l.currentOfficialAccount;o(e)},1e3),d.add(c.SYSTEM_EVENT.SESSION_OPENED,o),d.add(c.SYSTEM_EVENT.SESSION_CLOSED,o),d.add(c.SYSTEM_EVENT.SESSION_TRANSFERED,o),d.add(c.SYSTEM_EVENT.SESSION_CREATED,o),d.add(c.SYSTEM_EVENT.SESSION_RESTORED,o),d.add(c.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,o)}}},function(e,t,n){function o(e){if(s.currentOfficialAccount===e){var t=e.sessionState,n=e.agentType,o=e.type,c=n===r.AGENT_ROLE.ROBOT;"CUSTOM"===o?a.addClass(i,"hide"):t===r.SESSION_STATE.PROCESSING?a.toggleClass(i,"hide",!c):u.getRobertIsOpen().then(function(e){a.toggleClass(i,"hide",!e)})}}var i,r=n(13),a=n(12),s=n(19),c=n(30),u=n(17),l=n(31);e.exports=function(){if(s.config.toolbar.transferToKefu){var e=document.querySelector(".em-widget-send-wrapper");i=e.querySelector(".em-widget-to-kefu"),a.on(i,"click",function(){l.sendTransferToKf(),a.addClass(i,"hide")}),c.add(r.SYSTEM_EVENT.SESSION_OPENED,o),c.add(r.SYSTEM_EVENT.SESSION_TRANSFERED,o),c.add(r.SYSTEM_EVENT.SESSION_RESTORED,o),c.add(r.SYSTEM_EVENT.SESSION_NOT_CREATED,o),c.add(r.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,o)}}},function(e,t,n){function o(){var e=_.chain(y.officialAccountList).map(function(e){return e.unreadMessageIdList.getLength()}).reduce(function(e,t){return e+t}).value(),t=!!e;E.toggleClass(p,"hide",!t)}function i(e){var t=e.official_account_id;e.unreadMessageIdList.removeAll(),f.updateUnreadCount(t,null),o()}function r(e){if("SYSTEM"!==e.type&&!e.hasGotMarketingInfo){var t=e.official_account_id;e.hasGotMarketingInfo=!0,S.getLatestMarketingTask(t).then(function(t){e.bindSkillGroupName=E.getDataByPath(t,"schedule_info.skillgroup_name"),e.bindAgentUsername=E.getDataByPath(t,"schedule_info.agent_username")})}}function a(e){_.each(e.unrepliedMarketingTaskIdList.getAll(),function(t){e.unrepliedMarketingTaskIdList.remove(t),S.reportMarketingTaskReplied(t)})}function s(e){_.each(e.unopenedMarketingTaskIdList.getAll(),function(t){e.unopenedMarketingTaskIdList.remove(t),S.reportMarketingTaskOpened(t)})}function c(e,t,n){var o=e.img,i=e.official_account_id,r=n.data,a=E.getDataByPath(n,"ext.weichat.marketing.name"),s=E.getDataByPath(n,"ext.weichat.marketing.schedule_info")||{};e.bindSkillGroupName=s.skillgroup_name,e.bindAgentUsername=s.agent_username,e.hasGotMarketingInfo=!0,e!==y.currentOfficialAccount&&y.currentOfficialAccount&&(h=I({title:a,replyCallback:u,content:r,avatar:o,className:"cta-prompt",callbackMessage:i})),y.isChatWindowOpen&&e===y.currentOfficialAccount?S.reportMarketingTaskOpened(t):e.unopenedMarketingTaskIdList.add(t),e.unrepliedMarketingTaskIdList.add(t),S.reportMarketingTaskDelivered(t)}function u(e){var t=_.findWhere(y.officialAccountList,{official_account_id:e});_.each(y.officialAccountList,function(e){e.messageView.hide()}),t.messageView.show(),y.currentOfficialAccount=t,v.excuteCallbacks(g.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,[t])}function l(e){var t=e.type;e.messageView=N({officialAccount:e}),f||(f=T({itemOnClickCallback:u}),E.on(d,"click",function(){f.show(),h&&h.hide(),y.currentOfficialAccount=null,E.addClass(m,"hide")})),f.appendItem(e),"CUSTOM"===t&&E.removeClass(d,"hide")}var d,p,f,m,h,g=n(13),E=n(12),y=n(19),v=n(30),S=n(17),T=n(45),N=n(46),I=n(22);e.exports=function(){var e=document.querySelector(".em-widget-header");d=e.querySelector(".session-list-btn"),p=d.querySelector(".notice"),m=e.querySelector(".status-bar"),v.add(g.SYSTEM_EVENT.MESSAGE_SENT,function(){var e=y.currentOfficialAccount;e&&a(e)}),v.add(g.SYSTEM_EVENT.MARKETING_MESSAGE_RECEIVED,c),v.add(g.SYSTEM_EVENT.NEW_OFFICIAL_ACCOUNT_FOUND,l),v.add(g.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,function(e){e.messageView.scrollToBottom(),E.removeClass(m,"hide"),r(e),s(e),i(e)}),v.add(g.SYSTEM_EVENT.CHAT_WINDOW_OPENED,function(){var e=y.currentOfficialAccount;_.isEmpty(e)||(e.messageView.scrollToBottom(),s(e),i(e))}),v.add(g.SYSTEM_EVENT.SYSTEM_OFFICIAL_ACCOUNT_UPDATED,function(){f.updateItem(y.systemOfficialAccount,"default")}),v.add(g.SYSTEM_EVENT.OFFICIAL_ACCOUNT_LIST_GOT,function(){y.ctaEnable&&E.trigger(d,"click")}),v.add(g.SYSTEM_EVENT.MESSAGE_APPENDED,function(e,t){if(e!==y.currentOfficialAccount){var n=t.brief,i=E.formatDate(_.now()),r=e.official_account_id;e.unreadMessageIdList.add(t.id),f.updateLatestMessage(r,n,i),f.updateUnreadCount(r,e.unreadMessageIdList.getLength()),o()}})}},function(e,t,n){function o(e,t,n){var o=g.get(e),i=o.querySelector(".latest-message"),r=o.querySelector(".latest-timestamp");r.innerText=n,i.innerText=t,u.insertBefore(o,u.firstChild)}function i(e,t){var n=g.get(e),o=n.querySelector(".unread-count");t&&"number"==typeof t?t>99?(o.innerText="...",d.removeClass(o,"hide")):(o.innerText=t,d.removeClass(o,"hide")):d.addClass(o,"hide")}function r(e,t){var n=e.official_account_id,o=s(e),i=g.get(t);u.replaceChild(o,i),g.set(n,o),g.remove(t)}function a(e){var t=e.official_account_id,n=s(e);u.appendChild(n),g.set(t,n)}function s(e){var t=e.name,n=e.official_account_id,o=e.img||p.defaultAvatar;return d.createElementFromHTML(['<li class="session-item" data-id="'+n+'">','<img class="avatar" src="'+o+'">','<span class="name">'+t+"</span>",'<span class="latest-message"></span>','<span class="latest-timestamp"></span>','<span class="unread-count hide"></span>',"</li>"].join(""))}var c,u,l,d=n(12),p=n(19),f=n(20),m=n(16),h=function(){},g=new f;e.exports=function(e){var t=e||{};return l=t.itemOnClickCallback||h,c=m.createDialog({className:"session-list",contentDom:"<ul></ul>"}),u=c.el.querySelector("ul"),d.live("li.session-item","click",function(){var e=this.getAttribute("data-id");l(e),c.hide()},u),{appendItem:a,updateItem:r,updateLatestMessage:o,updateUnreadCount:i,show:c.show}}},function(e,t,n){var o=n(12),i=n(13),r=n(19),a=n(47),s=n(30),c=n(17),u=n(31),l='<div class="chat-container hide"></div>',d=document.querySelector(".chat-wrapper");e.exports=function(e){function t(e){return _.map(b.slice(0,e),function(e){var t=o.formatDate(e.date),n=e.isReceived?"客服坐席":"访客",i=e.msg.brief;return"["+t+"] "+n+"\n"+i}).join("\n")}function n(e){f(),o.appendHTMLTo(T,['<div class="em-widget-event">',"<span>"+e+"</span>","</div>"].join("")),g()}function p(e,t){var n=t||{},i=n.isReceived,r=n.isHistory,s=n.timestamp||_.now(),c=a(e,i,r),u=c.querySelector(".em-widget-imgview");r?(T.insertBefore(c,T.firstChild),f(s,r)):(f(s,r),u?(T.appendChild(c),g(),o.one(u,"load",function(){g()})):(T.appendChild(c),g()));var l={isReceived:i,msg:e,date:s};r?b.push(l):b.unshift(l)}function f(e,t){var n=o.createElementFromHTML(['<div class="em-widget-date">',"<span>"+o.formatDate(r)+"</span>","</div>"].join("")),r=e||_.now();t?I-r>i.MESSAGE_TIME_SPAN_INTERVAL&&T.insertBefore(n,T.firstChild):r-O>i.MESSAGE_TIME_SPAN_INTERVAL&&T.appendChild(n),r<I&&(I=r),r>O&&(O=r)}function m(e){v||c.getOfficalAccountMessage(S.official_account_id,N).then(function(t){var n=t.length,o=t[n-1]||{},r=o.id;N=r,v=n<i.GET_HISTORY_MESSAGE_COUNT_EACH_TIME||r<=0,_.each(t,u.handleHistoryMsg),"function"==typeof e&&e()})}function h(){var e,t,n;o.isMobile?(o.live("div.em-widget-date","touchstart",function(e){t=o.getDataByPath(e,"touches.0.pageY")},T),o.live("div.em-widget-date","touchmove",function(i){n=o.getDataByPath(i,"touches.0.pageY"),n-t>8&&this.getBoundingClientRect().top>=0&&(clearTimeout(e),e=setTimeout(function(){m()},100))},T)):o.on(T,"mousewheel DOMMouseScroll",function(t){if(S===r.currentOfficialAccount){var n=this;(t.wheelDelta/120>0||t.detail<0)&&(clearTimeout(e),e=setTimeout(function(){n.getBoundingClientRect().top>=0&&m()},400))}})}function g(){d.scrollTop=d.scrollHeight-d.offsetHeight+9999}function E(){o.addClass(T,"hide")}function y(){o.removeClass(T,"hide")}var v,S=e.officialAccount,T=o.createElementFromHTML(l),N=0,I=new Date(2099,0).getTime(),O=new Date(1970,0).getTime(),b=[];return d.appendChild(T),s.add(i.SYSTEM_EVENT.OFFICIAL_ACCOUNT_LIST_GOT,function(){var e=S.official_account_id;m(g),h(),c.getLastSession(e).then(function(e){S.agentId=e.agent_id,S.sessionId=e.session_id,S.sessionState=e.state,S.agentType=e.agent_type,S.skillGroupId=e.skill_group_id,S.isSessionOpen=e.state===i.SESSION_STATE.PROCESSING||e.state===i.SESSION_STATE.WAIT,s.excuteCallbacks(i.SYSTEM_EVENT.SESSION_RESTORED,[S])},function(e){if(e!==i.ERROR_MSG.SESSION_DOES_NOT_EXIST)throw e;s.excuteCallbacks(i.SYSTEM_EVENT.SESSION_NOT_CREATED,[S])})}),{show:y,hide:E,scrollToBottom:g,appendMsg:p,appendEventMsg:n,getRecentMsg:t,el:T}}},function(e,t,n){function o(e){if(!e||0===e.length)return"";var t="";return t=e.replace(/&amp;/g,"&"),t=t.replace(/<(?=[^o][^)])/g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/\"/g,"&quot;")}function i(e){return"string"!=typeof e?"":e.replace(/&amp;/g,"&").replace(/&#39;/g,"'").replace(/&lt;/g,"<")}function r(e){var t=e.type,n=e.data,r="";switch(t){case"txt":n=o(i(n)),r="<pre>"+f(m(n))+"</pre>";break;case"emoji":r="<pre>"+_.map(n,function(e){var t,n=e.type,o=e.data;return"txt"===n?t=f(o):"emoji"===n&&(t='<img class="emoji" src="'+o+'">'),t}).join("")+"</pre>";break;case"img":r='<a href="javascript:;"><img class="em-widget-imgview" src="'+e.url+'"/></a>';break;case"list":r="<p>"+f(o(n))+"</p>"+e.list;break;case"file":r='<i class="icon-attachment container-icon-attachment"></i><span class="file-info"><p class="filename">'+e.filename+'</p><p class="filesize">'+u.filesizeFormat(e.fileLength)+'</p></span><a target="_blank" href="'+e.url+'" class="icon-download container-icon-download" title="'+e.filename+'" download="'+e.filename+'"></a>';break;default:throw"unexpected value type."}return r}function a(e){var t,n=u.getDataByPath(e,"ext.weichat.official_account.type"),o=u.getDataByPath(e,"ext.weichat.official_account.img"),i=u.getDataByPath(e,"fromUser.img"),r=d.systemAgentAvatar;return t="CUSTOM"===n?o:d.isAgentNicknameEnable?i||r:d.tenantAvatar||d.defaultAvatar,t||d.tenantAvatar||d.defaultAvatar}function s(e,t,n){var o=e.id,i=e.type,s="",c=document.createElement("div"),l=t?"left":"right";if("article"===i){var d,f=u.getDataByPath(e,"ext.msgtype.articles");if(1===f.length){var m=u.formatDate(f[0].createdTime,"M月d日");d='<div class="article-msg-outer article-item only-one-article"><div class="body"><h3 class="title">'+f[0].title+'</h3><p class="create-time">'+m+'</p><div class="cover"><img src="'+f[0].thumbUrl+'"/></div><div class="desc"><p>'+f[0].digest+'</p></div></div><div class="footer"><span class="look-article">阅读全文</span><i class="icon-arrow-right"></i></div><a class="article-link" target="_blank" href="'+f[0].url+'"></a></div>'}else d='<div class="article-msg-outer more-articles">'+_.map(f,function(e,t){var n="";return n=0===t?'<div class="article-item first-item"><h3 class="title">'+e.title+"</h3>":'<div class="article-item rest-item"><div class="title-wrapper"><p class="title">'+e.title+"</p></div>",n+='<img class="cover-img" src="'+e.thumbUrl+'"/><a class="article-link" target="_blank" href="'+e.url+'"></a></div>'}).join("")||"</div>";return c.className="article-message-wrapper",c.innerHTML=d,c}return c.className="em-widget-"+l,o&&(c.id=o),"left"===l&&(s+='<img class="avatar" src="'+a(e)+'">'),s+='<div class="em-widget-msg-wrapper">',s+='<i class="icon-corner-'+l+'"></i>',t||n||!o||(s+='<div id="'+o+'_failed" data-type="'+i+'" class="em-widget-msg-status hide"><span>发送失败</span><i class="icon-circle"><i class="icon-exclamation"></i></i></div><div id="'+o+'_loading" class="em-widget-msg-loading">'+p+"</div>"),s+='<div class="em-widget-msg-container em-widget-msg-'+i+'">',s+=r(e),s+="</div>",s+="</div>",c.innerHTML=s,c}var c=n(24),u=n(12),l=n(13),d=n(19),p=Modernizr.inlinesvg?l.loadingSvg:'<img src="//kefu.easemob.com/webim/static/img/loading.gif" width="20" style="margin-top:10px;"/>',f=c.utils.parseLink,m=c.utils.parseEmoji;e.exports=s},function(e,t,n){function o(e){e===r.systemOfficialAccount&&(e.isSessionOpen||Promise.all([s.getSystemGreeting(),s.getRobertGreeting(),s.getSkillgroupMenu()]).then(function(e){var t=e[0],n=e[1],o=e[2],i=n.greetingTextType,r=n.greetingText,a={};switch(t&&c.handleMessage({data:t,noprompt:!0},"txt"),i){case 0:c.handleMessage({data:r,noprompt:!0},"txt");break;case 1:a=JSON.parse(r.replace(/&amp;quot;/g,'"')),a.ext&&c.handleMessage({ext:a.ext,noprompt:!0});break;case void 0:break;default:console.error("unknown robot greeting type.")}o&&c.handleMessage({data:o,type:"skillgroupMenu",noprompt:!0})}))}var i=n(13),r=n(19),a=n(30),s=n(17),c=n(31);e.exports=function(){a.add(i.SYSTEM_EVENT.SESSION_RESTORED,o),a.add(i.SYSTEM_EVENT.SESSION_NOT_CREATED,o)}},function(e,t,n){function o(e){if(e===s.currentOfficialAccount){var t=e.agentNickname,n=e.agentAvatar,o=e.isSessionOpen,r=e.type;"SYSTEM"===r&&(s.systemAgentAvatar=o?a.getAvatarsFullPath(n,s.config.domain):null),"CUSTOM"===r?i.innerText=e.name:s.isAgentNicknameEnable&&t&&o&&"调度员"!==t?i.innerText=t:i.innerText=s.defaultAgentName}}var i,r=n(13),a=n(12),s=n(19),c=n(30);e.exports=function(){var e=document.querySelector(".em-widget-header");i=e.querySelector(".em-widget-header-nickname"),c.add(r.SYSTEM_EVENT.SESSION_OPENED,o),c.add(r.SYSTEM_EVENT.SESSION_TRANSFERED,o),c.add(r.SYSTEM_EVENT.SESSION_TRANSFERING,o),c.add(r.SYSTEM_EVENT.SESSION_CLOSED,o),c.add(r.SYSTEM_EVENT.AGENT_INFO_UPDATE,o),c.add(r.SYSTEM_EVENT.SESSION_RESTORED,o),c.add(r.SYSTEM_EVENT.SESSION_NOT_CREATED,o),c.add(r.SYSTEM_EVENT.OFFICIAL_ACCOUNT_SWITCHED,o)}},function(e,t,n){var o=n(12),i=(n(15),n(17)),r=n(19),a=/MicroMessenger/.test(navigator.userAgent),s=o.query("appid"),c=o.query("code"),u=o.query("tenantId");e.exports=function(e,t){return a&&u&&s?void(c?i.getWechatProfile(u,s,c).then(function(n){r.config.visitor.userNickname=n.nickname,i.createWechatImUser(n.openid).then(function(t){e(t)},function(e){console.warn(e),t()})},function(e){if("unexpected response value."===e)t();else{var n=location.href.replace(/&code=[^&]+/,"");n.indexOf("appid")!==n.lastIndexOf("appid")&&(n=n.replace(/&appid=wx[^&]+/,"")),location.href=n}}):i.getWechatComponentId().then(function(e){location.href="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+s+"&redirect_uri="+encodeURIComponent(location.href)+"&response_type=code&scope=snsapi_userinfo&state=STATE&component_appid="+e+"#wechat_redirect"},function(e){console.warn(e),t()})):void t()}},function(e,t,n){e.exports=n.p+"../css/im.css"},function(e,t,n){e.exports=n.p+"../../im.html"}]);
//# sourceMappingURL=main.js.map