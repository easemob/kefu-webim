!function(e,t,n){function o(e,t){return typeof e===t}function i(){var e,t,n,i,a,r,s;for(var c in y)if(y.hasOwnProperty(c)){if(e=[],t=y[c],t.name&&(e.push(t.name.toLowerCase()),t.options&&t.options.aliases&&t.options.aliases.length))for(n=0;n<t.options.aliases.length;n++)e.push(t.options.aliases[n].toLowerCase());for(i=o(t.fn,"function")?t.fn():t.fn,a=0;a<e.length;a++)r=e[a],s=r.split("."),1===s.length?_[s[0]]=i:(!_[s[0]]||_[s[0]]instanceof Boolean||(_[s[0]]=new Boolean(_[s[0]])),_[s[0]][s[1]]=i),E.push((i?"":"no-")+s.join("-"))}}function a(){return"function"!=typeof t.createElement?t.createElement(arguments[0]):b?t.createElementNS.call(t,"http://www.w3.org/2000/svg",arguments[0]):t.createElement.apply(t,arguments)}function r(){var e=t.body;return e||(e=a(b?"svg":"body"),e.fake=!0),e}function s(e,n,o,i){var s,c,d,u,l="modernizr",m=a("div"),p=r();if(parseInt(o,10))for(;o--;)d=a("div"),d.id=i?i[o]:l+(o+1),m.appendChild(d);return s=a("style"),s.type="text/css",s.id="s"+l,(p.fake?p:m).appendChild(s),p.appendChild(m),s.styleSheet?s.styleSheet.cssText=e:s.appendChild(t.createTextNode(e)),m.id=l,p.fake&&(p.style.background="",p.style.overflow="hidden",u=h.style.overflow,h.style.overflow="hidden",h.appendChild(p)),c=n(m,e),p.fake?(p.parentNode.removeChild(p),h.style.overflow=u,h.offsetHeight):m.parentNode.removeChild(m),!!c}function c(e){return e.replace(/([a-z])-([a-z])/g,function(e,t,n){return t+n.toUpperCase()}).replace(/^-/,"")}function d(e,t){return!!~(""+e).indexOf(t)}function u(e,t){return function(){return e.apply(t,arguments)}}function l(e,t,n){var i;for(var a in e)if(e[a]in t)return n===!1?e[a]:(i=t[e[a]],o(i,"function")?u(i,n||t):i);return!1}function m(e){return e.replace(/([A-Z])/g,function(e,t){return"-"+t.toLowerCase()}).replace(/^ms-/,"-ms-")}function p(t,o){var i=t.length;if("CSS"in e&&"supports"in e.CSS){for(;i--;)if(e.CSS.supports(m(t[i]),o))return!0;return!1}if("CSSSupportsRule"in e){for(var a=[];i--;)a.push("("+m(t[i])+":"+o+")");return a=a.join(" or "),s("@supports ("+a+") { #modernizr { position: absolute; } }",function(e){return"absolute"==getComputedStyle(e,null).position})}return n}function f(e,t,i,r){function s(){l&&(delete x.style,delete x.modElem)}if(r=o(r,"undefined")?!1:r,!o(i,"undefined")){var u=p(e,i);if(!o(u,"undefined"))return u}for(var l,m,f,g,h,y=["modernizr","tspan","samp"];!x.style&&y.length;)l=!0,x.modElem=a(y.shift()),x.style=x.modElem.style;for(f=e.length,m=0;f>m;m++)if(g=e[m],h=x.style[g],d(g,"-")&&(g=c(g)),x.style[g]!==n){if(r||o(i,"undefined"))return s(),"pfx"==t?g:!0;try{x.style[g]=i}catch(v){}if(x.style[g]!=h)return s(),"pfx"==t?g:!0}return s(),!1}function g(e,t,n,i,a){var r=e.charAt(0).toUpperCase()+e.slice(1),s=(e+" "+T.join(r+" ")+r).split(" ");return o(t,"string")||o(t,"undefined")?f(s,t,i,a):(s=(e+" "+O.join(r+" ")+r).split(" "),l(s,t,n))}var h=t.documentElement,y=[],v={_version:"3.3.1",_config:{classPrefix:"",enableClasses:!0,enableJSClass:!0,usePrefixes:!0},_q:[],on:function(e,t){var n=this;setTimeout(function(){t(n[e])},0)},addTest:function(e,t,n){y.push({name:e,fn:t,options:n})},addAsyncTest:function(e){y.push({name:null,fn:e})}},_=function(){};_.prototype=v,_=new _;var E=[],b="svg"===h.nodeName.toLowerCase();_.addTest("inlinesvg",function(){var e=a("div");return e.innerHTML="<svg/>","http://www.w3.org/2000/svg"==("undefined"!=typeof SVGRect&&e.firstChild&&e.firstChild.namespaceURI)});var I=function(){function e(e,t){var i;return e?(t&&"string"!=typeof t||(t=a(t||"div")),e="on"+e,i=e in t,!i&&o&&(t.setAttribute||(t=a("div")),t.setAttribute(e,""),i="function"==typeof t[e],t[e]!==n&&(t[e]=n),t.removeAttribute(e)),i):!1}var o=!("onblur"in t.documentElement);return e}();v.hasEvent=I;v.testStyles=s;_.addTest("oninput",function(){var n,o=a("input");if(o.setAttribute("oninput","return"),I("oninput",h)||"function"==typeof o.oninput)return!0;try{var i=t.createEvent("KeyboardEvent");n=!1;var r=function(e){n=!0,e.preventDefault(),e.stopPropagation()};i.initKeyEvent("keypress",!0,!0,e,!1,!1,!1,!1,0,"e".charCodeAt(0)),h.appendChild(o),o.addEventListener("input",r,!1),o.focus(),o.dispatchEvent(i),o.removeEventListener("input",r,!1),h.removeChild(o)}catch(s){n=!1}return n});var N="Moz O ms Webkit",T=v._config.usePrefixes?N.split(" "):[];v._cssomPrefixes=T;var S=function(t){var o,i=prefixes.length,a=e.CSSRule;if("undefined"==typeof a)return n;if(!t)return!1;if(t=t.replace(/^@/,""),o=t.replace(/-/g,"_").toUpperCase()+"_RULE",o in a)return"@"+t;for(var r=0;i>r;r++){var s=prefixes[r],c=s.toUpperCase()+"_"+o;if(c in a)return"@-"+s.toLowerCase()+"-"+t}return!1};v.atRule=S;var O=v._config.usePrefixes?N.toLowerCase().split(" "):[];v._domPrefixes=O;var C={elem:a("modernizr")};_._q.push(function(){delete C.elem});var x={style:C.elem.style};_._q.unshift(function(){delete x.style}),v.testAllProps=g;var R=v.prefixed=function(e,t,n){return 0===e.indexOf("@")?S(e):(-1!=e.indexOf("-")&&(e=c(e)),t?g(e,t,n):g(e,"pfx"))};_.addTest("peerconnection",!!R("RTCPeerConnection",e)),i(),delete v.addTest,delete v.addAsyncTest;for(var w=0;w<_._q.length;w++)_._q[w]();e.Modernizr=_}(window,document);var WebIM={};WebIM.Emoji={path:"static/img/faces/",map:{"[):]":"ee_1.png","[:D]":"ee_2.png","[;)]":"ee_3.png","[:-o]":"ee_4.png","[:p]":"ee_5.png","[(H)]":"ee_6.png","[:@]":"ee_7.png","[:s]":"ee_8.png","[:$]":"ee_9.png","[:(]":"ee_10.png","[:'(]":"ee_11.png","[:|]":"ee_12.png","[(a)]":"ee_13.png","[8o|]":"ee_14.png","[8-|]":"ee_15.png","[+o(]":"ee_16.png","[<o)]":"ee_17.png","[|-)]":"ee_18.png","[*-)]":"ee_19.png","[:-#]":"ee_20.png","[:-*]":"ee_21.png","[^o)]":"ee_22.png","[8-)]":"ee_23.png","[(|)]":"ee_24.png","[(u)]":"ee_25.png","[(S)]":"ee_26.png","[(*)]":"ee_27.png","[(#)]":"ee_28.png","[(R)]":"ee_29.png","[({)]":"ee_30.png","[(})]":"ee_31.png","[(k)]":"ee_32.png","[(F)]":"ee_33.png","[(W)]":"ee_34.png","[(D)]":"ee_35.png"}},WebIM.config={isAutoLogin:!0,isWindowSDK:!1,isSandBox:!1,isDebug:!1,autoReconnectNumMax:2,autoReconnectInterval:2,isWebRTC:/WebKit/.test(navigator.userAgent)&&/^https\:$/.test(window.location.protocol),isHttpDNS:!1},function(e){function t(o){if(n[o])return n[o].exports;var i=n[o]={exports:{},id:o,loaded:!1};return e[o].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};return t.m=e,t.c=n,t.p="./",t(0)}({0:function(e,t,n){e.exports=n(230)},223:function(e,t,n){"use strict";var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e=function(){},i=n(224).code,a=10485760,r=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},s=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}},c=function(t){t=t||!0;var n=r()||s();if("withCredentials"in n)return n;if(!t)return n;if("undefined"==typeof window.XDomainRequest)return n;var o=new XDomainRequest;return o.readyState=0,o.status=100,o.onreadystatechange=e,o.onload=function(){o.readyState=4,o.status=200;var e=new ActiveXObject("Microsoft.XMLDOM");e.async="false",e.loadXML(o.responseText),o.responseXML=e,o.response=o.responseText,o.onreadystatechange()},o.ontimeout=o.onerror=function(){o.readyState=4,o.status=500,o.onreadystatechange()},o},d=function(){if("ActiveXObject"in window)try{return new ActiveXObject("ShockwaveFlash.ShockwaveFlash")}catch(e){return 0}else if(navigator.plugins&&navigator.plugins.length>0)return navigator.plugins["Shockwave Flash"];return 0}(),u=c(),l="undefined"!=typeof FormData,m="undefined"!=typeof Blob,p=u.setRequestHeader||!1,f=u.overrideMimeType||!1,g=p&&l,h=g||d,y=p&&(m||f);Object.keys||(Object.keys=function(){var e=Object.prototype.hasOwnProperty,t=!{toString:null}.propertyIsEnumerable("toString"),n=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],i=n.length;return function(a){if("object"!==("undefined"==typeof a?"undefined":o(a))&&("function"!=typeof a||null===a))throw new TypeError("Object.keys called on non-object");var r,s,c=[];for(r in a)e.call(a,r)&&c.push(r);if(t)for(s=0;i>s;s++)e.call(a,n[s])&&c.push(n[s]);return c}}());var v={hasFormData:l,hasBlob:m,emptyfn:e,isCanSetRequestHeader:p,hasOverrideMimeType:f,isCanUploadFileAsync:g,isCanUploadFile:h,isCanDownLoadFile:y,isSupportWss:function(){var e=[/MQQBrowser[\/]5([.]\d+)?\sTBS/];if(!window.WebSocket)return!1;for(var t=window.navigator.userAgent,n=0,o=e.length;o>n;n++)if(e[n].test(t))return!1;return!0}(),getIEVersion:function(){var e,t=navigator.userAgent,n={4:8,5:9,6:10,7:11};return e=t.match(/MSIE (\d+)/i),e&&e[1]?+e[1]:(e=t.match(/Trident\/(\d+)/i),e&&e[1]?n[e[1]]||null:null)}(),stringify:function(e){if("undefined"!=typeof JSON&&JSON.stringify)return JSON.stringify(e);var t="",n=[],i=function a(e){var i=!1;"[object Array]"===Object.prototype.toString.call(e)?(n.push("]","["),i=!0):"[object Object]"===Object.prototype.toString.call(e)&&n.push("}","{");for(var r in e)"[object Null]"===Object.prototype.toString.call(e[r])?e[r]="null":"[object Undefined]"===Object.prototype.toString.call(e[r])&&(e[r]="undefined"),t+=e[r]&&"object"===o(e[r])?","+(i?"":'"'+r+'":'+(i?'"':""))+a(e[r]):',"'+(i?"":r+'":"')+e[r]+'"';return""!=t&&(t=t.slice(1)),n.pop()+t+n.pop()};return i(e)},login:function(t){var t=t||{},n=t.success||e,o=t.error||e,a=t.appKey||"",r=a.split("#");if(2!==r.length)return o({type:i.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var s=r[0],c=r[1],d=d||t.https,u=t.user||"",l=t.pwd||"",m=t.apiUrl,p={grant_type:"password",username:u,password:l,timestamp:+new Date},f=v.stringify(p),t={url:m+"/"+s+"/"+c+"/token",dataType:"json",data:f,success:n,error:o};return v.ajax(t)},getFileUrl:function(e){var t={url:"",filename:"",filetype:"",data:""},n="string"==typeof e?document.getElementById(e):e;if(!v.isCanUploadFileAsync||!n)return t;try{if(window.URL.createObjectURL){var o=n.files;if(o.length>0){var i=o.item(0);t.data=i,t.url=window.URL.createObjectURL(i),t.filename=i.name||""}}else{var i=document.getElementById(e).value;t.url=i;var a=i.lastIndexOf("/"),r=i.lastIndexOf("\\"),s=Math.max(a,r);0>s?t.filename=i:t.filename=i.substring(s+1)}var c=t.filename.lastIndexOf(".");return-1!=c&&(t.filetype=t.filename.substring(c+1).toLowerCase()),t}catch(d){throw d}},getFileSize:function(e){var t=0;if(e)if(e.files)e.files.length>0&&(t=e.files[0].size);else if(e.select&&"ActiveXObject"in window){e.select();var n=new ActiveXObject("Scripting.FileSystemObject"),e=n.GetFile(e.value);t=e.Size}if(console.log("fileSize: ",t),t>1e7)return!1;var o=Math.round(t/1e3);if(1e3>o)t=o+" KB";else if(o>=1e3){var i=o/1e3;if(1e3>i)t=i.toFixed(1)+" MB";else{var a=i/1e3;t=a.toFixed(1)+" GB"}}return t},hasFlash:d,trim:function(e){return e="string"==typeof e?e:"",e.trim?e.trim():e.replace(/^\s|\s$/g,"")},parseEmoji:function(e){if("undefined"==typeof WebIM.Emoji||"undefined"==typeof WebIM.Emoji.map)return e;var t=WebIM.Emoji;for(var n in t.map)if(t.map.hasOwnProperty(n))for(;e.indexOf(n)>-1;)e=e.replace(n,'<img class="emoji" src="'+t.path+t.map[n]+'" />');return e},parseLink:function(e){var t=/(https?\:\/\/|www\.)([a-zA-Z0-9-]+(\.[a-zA-Z0-9]+)+)(\:[0-9]{2,4})?\/?((\.[:_0-9a-zA-Z-]+)|[:_0-9a-zA-Z-]*\/?)*\??[:_#@*&%0-9a-zA-Z-\/=]*/gm;return e=e.replace(t,function(e){var t=/^https?/gm.test(e);return"<a href='"+(t?e:"//"+e)+"' target='_blank'>"+e+"</a>"})},parseJSON:function(e){if(window.JSON&&window.JSON.parse)return window.JSON.parse(e+"");var t,n=null,o=v.trim(e+"");return o&&!v.trim(o.replace(/(,)|(\[|{)|(}|])|"(?:[^"\\\r\n]|\\["\\\/bfnrt]|\\u[\da-fA-F]{4})*"\s*:?|true|false|null|-?(?!0\d)\d+(?:\.\d+|)(?:[eE][+-]?\d+|)/g,function(e,o,i,a){return t&&o&&(n=0),0===n?e:(t=i||o,n+=!a-!i,"")}))?Function("return "+o)():Function("Invalid JSON: "+e)()},parseUploadResponse:function(e){return e.indexOf("callback")>-1?e.slice(9,-1):e},parseDownloadResponse:function(e){return e&&e.type&&"application/json"===e.type||0>Object.prototype.toString.call(e).indexOf("Blob")?this.url+"?token=":window.URL.createObjectURL(e)},uploadFile:function(t){var t=t||{};t.onFileUploadProgress=t.onFileUploadProgress||e,t.onFileUploadComplete=t.onFileUploadComplete||e,t.onFileUploadError=t.onFileUploadError||e,t.onFileUploadCanceled=t.onFileUploadCanceled||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileUploadError({type:i.WEBIM_UPLOADFILE_NO_LOGIN,id:t.id});var o,r,s,c=t.appKey||this.context.appKey||"";if(c&&(s=c.split("#"),o=s[0],r=s[1]),!o&&!r)return void t.onFileUploadError({type:i.WEBIM_UPLOADFILE_ERROR,id:t.id});var d=t.apiUrl,u=d+"/"+o+"/"+r+"/chatfiles";if(!v.isCanUploadFileAsync)return void(v.hasFlash&&"function"==typeof t.flashUpload?t.flashUpload&&t.flashUpload(u,t):t.onFileUploadError({type:i.WEBIM_UPLOADFILE_BROWSER_ERROR,id:t.id}));var l=t.file.data?t.file.data.size:void 0;if(l>a)return void t.onFileUploadError({type:i.WEBIM_UPLOADFILE_ERROR,id:t.id});if(0>=l)return void t.onFileUploadError({type:i.WEBIM_UPLOADFILE_ERROR,id:t.id});var m=v.xmlrequest(),p=function(e){t.onFileUploadError({type:i.WEBIM_UPLOADFILE_ERROR,id:t.id,xhr:m})};m.upload&&m.upload.addEventListener("progress",t.onFileUploadProgress,!1),m.addEventListener?(m.addEventListener("abort",t.onFileUploadCanceled,!1),m.addEventListener("load",function(e){try{var n=v.parseJSON(m.responseText);try{t.onFileUploadComplete(n)}catch(e){t.onFileUploadError({type:i.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:e})}}catch(e){t.onFileUploadError({type:i.WEBIM_UPLOADFILE_ERROR,data:m.responseText,id:t.id,xhr:m})}},!1),m.addEventListener("error",p,!1)):m.onreadystatechange&&(m.onreadystatechange=function(){if(4===m.readyState)if(200===ajax.status)try{var e=v.parseJSON(m.responseText);t.onFileUploadComplete(e)}catch(n){t.onFileUploadError({type:i.WEBIM_UPLOADFILE_ERROR,data:m.responseText,id:t.id,xhr:m})}else t.onFileUploadError({type:i.WEBIM_UPLOADFILE_ERROR,data:m.responseText,id:t.id,xhr:m});else m.abort(),t.onFileUploadCanceled()}),m.open("POST",u),m.setRequestHeader("restrict-access","true"),m.setRequestHeader("Accept","*/*"),m.setRequestHeader("Authorization","Bearer "+n);var f=new FormData;f.append("file",t.file.data),m.send(f)},download:function(t){t.onFileDownloadComplete=t.onFileDownloadComplete||e,t.onFileDownloadError=t.onFileDownloadError||e;var n=t.accessToken||this.context.accessToken;if(!n)return void t.onFileDownloadError({type:i.WEBIM_DOWNLOADFILE_NO_LOGIN,id:t.id});var o=function(e){t.onFileDownloadError({type:i.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:a})};if(!v.isCanDownLoadFile)return void t.onFileDownloadComplete();var a=v.xmlrequest();"addEventListener"in a?(a.addEventListener("load",function(e){t.onFileDownloadComplete(a.response,a)},!1),a.addEventListener("error",o,!1)):"onreadystatechange"in a&&(a.onreadystatechange=function(){4===a.readyState?200===ajax.status?t.onFileDownloadComplete(a.response,a):t.onFileDownloadError({type:i.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:a}):(a.abort(),t.onFileDownloadError({type:i.WEBIM_DOWNLOADFILE_ERROR,id:t.id,xhr:a}))});var r=t.method||"GET",s=t.responseType||"blob",c=t.mimeType||"text/plain; charset=x-user-defined";a.open(r,t.url),"undefined"!=typeof Blob?a.responseType=s:a.overrideMimeType(c);var d={"X-Requested-With":"XMLHttpRequest",Accept:"application/octet-stream","share-secret":t.secret,Authorization:"Bearer "+n},u=t.headers||{};for(var l in u)d[l]=u[l];for(var l in d)d[l]&&a.setRequestHeader(l,d[l]);a.send(null)},parseTextMessage:function(e,t){if("string"==typeof e){if("[object Object]"!==Object.prototype.toString.call(t))return{isemoji:!1,body:[{type:"txt",data:e}]};var n=e,o=[],i=/\[[^[\]]{2,3}\]/gm,a=n.match(i);if(!a||a.length<1)return{isemoji:!1,body:[{type:"txt",data:e}]};for(var r=!1,s=0;s<a.length;s++){var c=n.substring(0,n.indexOf(a[s])),d=WebIM.Emoji.map[a[s]];if(c&&o.push({type:"txt",data:c}),d){var u=WebIM.Emoji.map?WebIM.Emoji.path+d:null;u?(r=!0,o.push({type:"emoji",data:u})):o.push({type:"txt",data:a[s]});var l=n.indexOf(a[s])+a[s].length;n=n.substring(l)}else o.push({type:"txt",data:a[s]})}return n&&o.push({type:"txt",data:n}),r?{isemoji:r,body:o}:{isemoji:!1,body:[{type:"txt",data:e}]}}},xmlrequest:c,getXmlFirstChild:function(e,t){var n=e.getElementsByTagName(t);return 0==n.length?null:n[0]},ajax:function(t){var n=t.dataType||"text",o=t.success||e,a=t.error||e,r=v.xmlrequest();r.onreadystatechange=function(){if(4===r.readyState){var e=r.status||0;if(200===e){try{switch(n){case"text":return void o(r.responseText);case"json":var t=v.parseJSON(r.responseText);return void o(t,r);case"xml":return void(r.responseXML&&r.responseXML.documentElement?o(r.responseXML.documentElement,r):a({type:i.WEBIM_CONNCTION_AJAX_ERROR,data:r.responseText}))}o(r.response||r.responseText,r)}catch(s){a({type:i.WEBIM_CONNCTION_AJAX_ERROR,data:s})}return}return void a({type:i.WEBIM_CONNCTION_AJAX_ERROR,data:r.responseText})}0===r.readyState&&a({type:i.WEBIM_CONNCTION_AJAX_ERROR,data:r.responseText})},t.responseType&&r.responseType&&(r.responseType=t.responseType),t.mimeType&&v.hasOverrideMimeType&&r.overrideMimeType(t.mimeType);var s=t.type||"POST",c=t.data||null,d="";if("get"===s.toLowerCase()&&c){for(var u in c)c.hasOwnProperty(u)&&(d+=u+"="+c[u]+"&");d=d?d.slice(0,-1):d,t.url+=(t.url.indexOf("?")>0?"&":"?")+(d?d+"&":d)+"_v="+(new Date).getTime(),c=null,d=null}if(r.open(s,t.url),v.isCanSetRequestHeader){var l=t.headers||{};for(var m in l)l.hasOwnProperty(m)&&r.setRequestHeader(m,l[m])}return r.send(c),r},ts:function(){var e=new Date,t=e.getHours(),n=e.getMinutes(),o=e.getSeconds(),i=e.getMilliseconds();return(10>t?"0"+t:t)+":"+(10>n?"0"+n:n)+":"+(10>o?"0"+o:o)+":"+i+" "},getObjectKey:function(e,t){for(var n in e)if(e[n]==t)return n;return""}};t.utils=v}()},224:function(e,t){"use strict";!function(){t.code={WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR:0,WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_OPEN_USERGRID_ERROR:3,WEBIM_CONNCTION_ATTACH_ERROR:4,WEBIM_CONNCTION_ATTACH_USERGRID_ERROR:5,WEBIM_CONNCTION_REOPEN_ERROR:6,WEBIM_CONNCTION_SERVER_CLOSE_ERROR:7,WEBIM_CONNCTION_SERVER_ERROR:8,WEBIM_CONNCTION_IQ_ERROR:9,WEBIM_CONNCTION_PING_ERROR:10,WEBIM_CONNCTION_NOTIFYVERSION_ERROR:11,WEBIM_CONNCTION_GETROSTER_ERROR:12,WEBIM_CONNCTION_CROSSDOMAIN_ERROR:13,WEBIM_CONNCTION_LISTENING_OUTOF_MAXRETRIES:14,WEBIM_CONNCTION_RECEIVEMSG_CONTENTERROR:15,WEBIM_CONNCTION_DISCONNECTED:16,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_JOINROOM_ERROR:18,WEBIM_CONNCTION_GETROOM_ERROR:19,WEBIM_CONNCTION_GETROOMINFO_ERROR:20,WEBIM_CONNCTION_GETROOMMEMBER_ERROR:21,WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR:22,WEBIM_CONNCTION_LOAD_CHATROOM_ERROR:23,WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR:24,WEBIM_CONNCTION_JOINCHATROOM_ERROR:25,WEBIM_CONNCTION_QUITCHATROOM_ERROR:26,WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR:27,WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR:28,WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR:29,WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR:30,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31,WEBIM_CONNCTION_CLIENT_OFFLINE:32,WEBIM_CONNCTION_CLIENT_LOGOUT:33,WEBIM_CONNCTION_CLIENT_TOO_MUCH_ERROR:34,WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP:35,WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP:36,WEBIM_CONNECTION_ACCEPT_JOIN_GROUP:37,WEBIM_CONNECTION_DECLINE_JOIN_GROUP:38,WEBIM_CONNECTION_CLOSED:39,WEBIM_UPLOADFILE_BROWSER_ERROR:100,WEBIM_UPLOADFILE_ERROR:101,WEBIM_UPLOADFILE_NO_LOGIN:102,WEBIM_UPLOADFILE_NO_FILE:103,WEBIM_DOWNLOADFILE_ERROR:200,WEBIM_DOWNLOADFILE_NO_LOGIN:201,WEBIM_DOWNLOADFILE_BROWSER_ERROR:202,WEBIM_MESSAGE_REC_TEXT:300,WEBIM_MESSAGE_REC_TEXT_ERROR:301,WEBIM_MESSAGE_REC_EMOTION:302,WEBIM_MESSAGE_REC_PHOTO:303,WEBIM_MESSAGE_REC_AUDIO:304,WEBIM_MESSAGE_REC_AUDIO_FILE:305,WEBIM_MESSAGE_REC_VEDIO:306,WEBIM_MESSAGE_REC_VEDIO_FILE:307,WEBIM_MESSAGE_REC_FILE:308,WEBIM_MESSAGE_SED_TEXT:309,WEBIM_MESSAGE_SED_EMOTION:310,WEBIM_MESSAGE_SED_PHOTO:311,WEBIM_MESSAGE_SED_AUDIO:312,WEBIM_MESSAGE_SED_AUDIO_FILE:313,WEBIM_MESSAGE_SED_VEDIO:314,WEBIM_MESSAGE_SED_VEDIO_FILE:315,WEBIM_MESSAGE_SED_FILE:316,WEBIM_MESSAGE_SED_ERROR:317,STATUS_INIT:400,STATUS_DOLOGIN_USERGRID:401,STATUS_DOLOGIN_IM:402,STATUS_OPENED:403,STATUS_CLOSING:404,STATUS_CLOSED:405,STATUS_ERROR:406}}()},230:function(e,t,n){"use strict";e.exports=n(231)},231:function(module,exports,__webpack_require__){"use strict";function _parsePrivacy(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],a=i.getAttribute("value"),r=i.getAttribute("order"),s=i.getAttribute("type");if(a){var c=_parseNameFromJidFn(a);t[c]={type:s,order:r,jid:a,name:c}}}return t}function _parseGroupBlacklist(e){var t={},n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],a=i.getAttribute("jid"),r=i.getAttribute("affiliation"),s=i.getAttribute("nick");if(a){var c=_parseNameFromJidFn(a);t[c]={jid:a,affiliation:r,nick:s,name:c}}}return t}function _setText(e,t){"textContent"in e?e.textContent=t:"text"in e&&(e.text=t)}var _version="1.4.2",_code=__webpack_require__(224).code,_utils=__webpack_require__(223).utils,_msg=__webpack_require__(232),_message=_msg._msg,_msgHash={},Queue=__webpack_require__(233).Queue;window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,window.XDomainRequest&&(XDomainRequest.prototype.oldsend=XDomainRequest.prototype.send,XDomainRequest.prototype.send=function(){XDomainRequest.prototype.oldsend.apply(this,arguments),this.readyState=2}),Strophe.Request.prototype._newXHR=function(){var e=_utils.xmlrequest(!0);return e.overrideMimeType&&e.overrideMimeType("text/xml"),e.onreadystatechange=this.func.bind(null,this),e},Strophe.Websocket.prototype._closeSocket=function(){if(this.socket){var e=this;setTimeout(function(){try{e.socket.close()}catch(t){}},0)}else this.socket=null},Strophe.Websocket.prototype._onMessage=function(e){WebIM&&WebIM.config.isDebug&&console.log(WebIM.utils.ts()+"recv:",e.data);var t,n;if(0===e.data.indexOf("<close ")){t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement;var o=t.getAttribute("see-other-uri");return void(o?(this._conn._changeConnectStatus(Strophe.Status.REDIRECT,"Received see-other-uri, resetting connection"),this._conn.reset(),this._conn.service=o,this._connect()):this._conn._doDisconnect("receive <close> from server"))}if(0===e.data.search("<open ")){if(t=(new DOMParser).parseFromString(e.data,"text/xml").documentElement,!this._handleStreamStart(t))return}else n=this._streamWrap(e.data),t=(new DOMParser).parseFromString(n,"text/xml").documentElement;if(!this._check_streamerror(t,Strophe.Status.ERROR))return this._conn.disconnecting&&"presence"===t.firstChild.nodeName&&"unavailable"===t.firstChild.getAttribute("type")?(this._conn.xmlInput(t),void this._conn.rawInput(Strophe.serialize(t))):void this._conn._dataRecv(t,e.data)};var _listenNetwork=function(e,t){window.addEventListener?(window.addEventListener("online",e),window.addEventListener("offline",t)):window.attachEvent&&(document.body?(document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)):window.attachEvent("load",function(){document.body.attachEvent("ononline",e),document.body.attachEvent("onoffline",t)}))},_parseRoom=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],a=i.getAttribute("jid"),r=a.split("@")[0],s={jid:a,name:i.getAttribute("name"),roomId:r.split("_")[1]};t.push(s)}return t},_parseRoomOccupants=function(e){var t=[],n=e.getElementsByTagName("item");if(n)for(var o=0;o<n.length;o++){var i=n[o],a={jid:i.getAttribute("jid"),name:i.getAttribute("name")};t.push(a)}return t},_parseResponseMessage=function _parseResponseMessage(msginfo){var parseMsgData={errorMsg:!0,data:[]},msgBodies=msginfo.getElementsByTagName("body");if(msgBodies){for(var i=0;i<msgBodies.length;i++){var msgBody=msgBodies[i],childNodes=msgBody.childNodes;if(childNodes&&childNodes.length>0){var childNode=msgBody.childNodes[0];if(childNode.nodeType==Strophe.ElementType.TEXT){var jsondata=childNode.wholeText||childNode.nodeValue;jsondata=jsondata.replace("\n","<br>");try{var data=eval("("+jsondata+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}}var delayTags=msginfo.getElementsByTagName("delay");if(delayTags&&delayTags.length>0){var delayTag=delayTags[0],delayMsgTime=delayTag.getAttribute("stamp");delayMsgTime&&(parseMsgData.delayTimeStamp=delayMsgTime)}}else{var childrens=msginfo.childNodes;if(childrens&&childrens.length>0){var child=msginfo.childNodes[0];if(child.nodeType==Strophe.ElementType.TEXT)try{var data=eval("("+child.nodeValue+")");parseMsgData.errorMsg=!1,parseMsgData.data=[data]}catch(e){}}}return parseMsgData},_parseNameFromJidFn=function(e,t){t=t||"";var n=e,o=n.indexOf("_");-1!==o&&(n=n.substring(o+1));var i=n.indexOf("@"+t);return-1!==i&&(n=n.substring(0,i)),n},_parseFriend=function(e,t,n){var o=[],i=e.getElementsByTagName("item");if(i)for(var a=0;a<i.length;a++){var r=i[a],s=r.getAttribute("jid");if(s){var c=r.getAttribute("subscription"),d={subscription:c,jid:s},u=r.getAttribute("ask");u&&(d.ask=u);var l=r.getAttribute("name");if(l)d.name=l;else{var m=_parseNameFromJidFn(s);d.name=m}var p=[];Strophe.forEachChild(r,"group",function(e){p.push(Strophe.getText(e))}),d.groups=p,o.push(d),t&&"from"==c&&t.subscribe({toJid:s}),t&&"to"==c&&t.subscribed({toJid:s})}}return o},_login=function(e,t){var n=e.access_token||"";if(""==n){_utils.stringify(e);return void t.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:e})}t.context.accessToken=e.access_token,t.context.accessTokenExpires=e.expires_in;var o=null;o=t.isOpening()&&t.context.stropheConn?t.context.stropheConn:t.isOpened()&&t.context.stropheConn?t.getStrophe():t.getStrophe();var i=function(e,n){_loginCallback(e,n,t)};t.context.stropheConn=o,t.route?o.connect(t.context.jid,"$t$"+n,i,t.wait,t.hold,t.route):o.connect(t.context.jid,"$t$"+n,i,t.wait,t.hold)},_parseMessageType=function(e){var t="normal",n=e.getElementsByTagName("received");if(n&&n.length>0&&"urn:xmpp:receipts"===n[0].namespaceURI)t="received";else{var o=e.getElementsByTagName("invite");o&&o.length>0&&(t="invite")}return t},_handleMessageQueue=function(e){for(var t in _msgHash)_msgHash.hasOwnProperty(t)&&_msgHash[t].send(e)},_loginCallback=function(e,t,n){var o,i;if("conflict"===t&&(o=!0),e==Strophe.Status.CONNFAIL)i={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},o&&(i.conflict=!0),n.onError(i);else if(e==Strophe.Status.ATTACHED||e==Strophe.Status.CONNECTED){n.autoReconnectNumTotal=0,n.intervalId=setInterval(function(){n.handelSendQueue()},200);var a=function(e){var t=_parseMessageType(e);return"received"===t?(n.handleReceivedMessage(e),!0):"invite"===t?(n.handleInviteMessage(e),!0):(n.handleMessage(e),!0)},r=function(e){return n.handlePresence(e),!0},s=function(e){return n.handlePing(e),!0},c=function(e){return n.handleIqRoster(e),!0},d=function(e){return n.handleIqPrivacy(e),!0},u=function(e){return n.handleIq(e),!0};n.addHandler(a,null,"message",null,null,null),n.addHandler(r,null,"presence",null,null,null),n.addHandler(s,"urn:xmpp:ping","iq","get",null,null),n.addHandler(c,"jabber:iq:roster","iq","set",null,null),n.addHandler(d,"jabber:iq:privacy","iq","set",null,null),n.addHandler(u,null,"iq",null,null,null),n.context.status=_code.STATUS_OPENED;var l=[_code.WEBIM_MESSAGE_REC_TEXT,_code.WEBIM_MESSAGE_REC_EMOJI];_utils.isCanDownLoadFile&&(l.push(_code.WEBIM_MESSAGE_REC_PHOTO),l.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE));var m=[_code.WEBIM_MESSAGE_SED_TEXT];_utils.isCanUploadFile&&(m.push(_code.WEBIM_MESSAGE_REC_PHOTO),m.push(_code.WEBIM_MESSAGE_REC_AUDIO_FILE)),n.notifyVersion(),n.retry&&_handleMessageQueue(n),n.heartBeat(),n.isAutoLogin&&n.setPresence(),n.onOpened({canReceive:l,canSend:m,accessToken:n.context.accessToken})}else if(e==Strophe.Status.DISCONNECTING)n.isOpened()&&(n.stopHeartBeat(),n.context.status=_code.STATUS_CLOSING,i={type:_code.WEBIM_CONNCTION_SERVER_CLOSE_ERROR,msg:t,reconnect:!0},o&&(i.conflict=!0),n.onError(i));else if(e==Strophe.Status.DISCONNECTED){if(n.isOpened()){if(n.autoReconnectNumTotal<n.autoReconnectNumMax)return void n.reconnect();i={type:_code.WEBIM_CONNCTION_DISCONNECTED},n.onError(i)}n.context.status=_code.STATUS_CLOSED,n.clear(),n.onClosed()}else e==Strophe.Status.AUTHFAIL?(i={type:_code.WEBIM_CONNCTION_AUTH_ERROR},o&&(i.conflict=!0),n.onError(i),n.clear()):e==Strophe.Status.ERROR&&(n.context.status=_code.STATUS_ERROR,i={type:_code.WEBIM_CONNCTION_SERVER_ERROR},o&&(i.conflict=!0),n.onError(i));n.context.status_now=e},_getJid=function(e,t){var n=e.toJid||"";if(""===n){var o=t.context.appKey||"",i=o+"_"+e.to+"@"+t.domain;e.resource&&(i=i+"/"+e.resource),n=i}return n},_getJidByName=function(e,t){var n={to:e};return _getJid(n,t)},_validCheck=function(e,t){if(e=e||{},""==e.user)return t.onError({type:_code.WEBIM_CONNCTION_USER_NOT_ASSIGN_ERROR}),!1;var n=e.user+""||"",o=e.appKey||"",i=o.split("#");if(2!==i.length)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var a=i[0],r=i[1];if(!a)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;if(!r)return t.onError({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR}),!1;var s=o+"_"+n.toLowerCase()+"@"+t.domain,c=e.resource||"webim";return t.isMultiLoginSessions&&(c+=n+(new Date).getTime()+Math.floor(1e6*Math.random().toFixed(6))),t.context.jid=s+"/"+c,t.context.userId=n,t.context.appKey=o,t.context.appName=r,t.context.orgName=a,!0},_getXmppUrl=function(e,t){if(/^(ws|http)s?:\/\/?/.test(e))return e;var n={prefix:"http",base:"://"+e,suffix:"/http-bind/"};return t&&_utils.isSupportWss?(n.prefix="wss",n.suffix="/ws/"):t?n.prefix="https":window.WebSocket&&(n.prefix="ws",n.suffix="/ws/"),n.prefix+n.base+n.suffix},connection=function e(t){if(!this instanceof e)return new e(t);var t=t||{};this.isHttpDNS=t.isHttpDNS||!1,this.isMultiLoginSessions=t.isMultiLoginSessions||!1,this.wait=t.wait||30,this.retry=t.retry||!1,this.https=t.https||"https:"===location.protocol,this.url=_getXmppUrl(t.url,this.https),this.hold=t.hold||1,this.route=t.route||null,this.domain=t.domain||"easemob.com",this.inactivity=t.inactivity||30,this.heartBeatWait=t.heartBeatWait||4500,this.maxRetries=t.maxRetries||5,this.isAutoLogin=t.isAutoLogin===!1?!1:!0,this.pollingTime=t.pollingTime||800,this.stropheConn=!1,this.autoReconnectNumMax=t.autoReconnectNumMax||0,this.autoReconnectNumTotal=0,this.autoReconnectInterval=t.autoReconnectInterval||0,this.context={status:_code.STATUS_INIT},this.sendQueue=new Queue,this.intervalId=null,this.apiUrl=t.apiUrl||"",this.isWindowSDK=t.isWindowSDK||!1,this.dnsArr=["https://rs.easemob.com","https://rsbak.easemob.com","http://182.92.174.78","http://112.126.66.111"],this.dnsIndex=0,this.dnsTotal=this.dnsArr.length,this.restHosts=null,this.restIndex=0,this.restTotal=0,this.xmppHosts=null,this.xmppIndex=0,this.xmppTotal=0};connection.prototype.registerUser=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"signup")):this.signup(e)},connection.prototype.handelSendQueue=function(){var e=this.sendQueue.pop();null!==e&&this.sendReceiptsMessage(e)},connection.prototype.listen=function(e){this.onOpened=e.onOpened||_utils.emptyfn,this.onClosed=e.onClosed||_utils.emptyfn,this.onTextMessage=e.onTextMessage||_utils.emptyfn,this.onEmojiMessage=e.onEmojiMessage||_utils.emptyfn,this.onPictureMessage=e.onPictureMessage||_utils.emptyfn,this.onAudioMessage=e.onAudioMessage||_utils.emptyfn,this.onVideoMessage=e.onVideoMessage||_utils.emptyfn,this.onFileMessage=e.onFileMessage||_utils.emptyfn,this.onLocationMessage=e.onLocationMessage||_utils.emptyfn,this.onCmdMessage=e.onCmdMessage||_utils.emptyfn,this.onPresence=e.onPresence||_utils.emptyfn,this.onRoster=e.onRoster||_utils.emptyfn,this.onError=e.onError||_utils.emptyfn,this.onReceivedMessage=e.onReceivedMessage||_utils.emptyfn,this.onInviteMessage=e.onInviteMessage||_utils.emptyfn,this.onOffline=e.onOffline||_utils.emptyfn,this.onOnline=e.onOnline||_utils.emptyfn,this.onConfirmPop=e.onConfirmPop||_utils.emptyfn,this.onUpdateMyGroupList=e.onUpdateMyGroupList||_utils.emptyfn,this.onUpdateMyRoster=e.onUpdateMyRoster||_utils.emptyfn,
this.onBlacklistUpdate=e.onBlacklistUpdate||_utils.emptyfn,_listenNetwork(this.onOnline,this.onOffline)},connection.prototype.heartBeat=function(){var e=this,t=!/^ws|wss/.test(e.url)||/mobile/.test(navigator.userAgent);if(!this.heartBeatID&&t){var n={toJid:this.domain,type:"normal"};this.heartBeatID=setInterval(function(){e.ping(n)},this.heartBeatWait)}},connection.prototype.stopHeartBeat=function(){"number"==typeof this.heartBeatID&&(this.heartBeatID=clearInterval(this.heartBeatID))},connection.prototype.sendReceiptsMessage=function(e){var t=$msg({from:this.context.jid||"",to:this.domain,id:e.id||""}).c("received",{xmlns:"urn:xmpp:receipts",id:e.id||""});this.sendCommand(t.tree())},connection.prototype.cacheReceiptsMessage=function(e){this.sendQueue.push(e)},connection.prototype.getStrophe=function(){if("https:"!=location.protocol&&this.isHttpDNS){var e="",t=this.xmppHosts[this.xmppIndex],n=_utils.getXmlFirstChild(t,"domain"),o=_utils.getXmlFirstChild(t,"ip");if(o){e=o.textContent;var i=_utils.getXmlFirstChild(t,"port");"80"!=i.textContent&&(e+=":"+i.textContent)}else e=n.textContent;if(""!=e){var a=/(.+\/\/).+(\/.+)/;this.url=this.url.replace(a,"$1"+e+"$2")}}var r=new Strophe.Connection(this.url,{inactivity:this.inactivity,maxRetries:this.maxRetries,pollingTime:this.pollingTime});return r},connection.prototype.getHostsByTag=function(e,t){var n=_utils.getXmlFirstChild(e,t);if(!n)return console.log(t+" hosts error"),null;var o=n.getElementsByTagName("hosts");return 0==o.length?(console.log(t+" hosts error2"),null):o[0].getElementsByTagName("host")},connection.prototype.getRestFromHttpDNS=function(e,t){if(this.restIndex>this.restTotal)return void console.log("rest hosts all tried,quit");var n="",o=this.restHosts[this.restIndex],i=_utils.getXmlFirstChild(o,"domain"),a=_utils.getXmlFirstChild(o,"ip");if(a){var r=_utils.getXmlFirstChild(o,"port");n=("https:"===location.protocol?"https:":"http:")+"//"+a.textContent+":"+r.textContent}else n=("https:"===location.protocol?"https:":"http:")+"//"+i.textContent;""!=n&&(this.apiUrl=n,e.apiUrl=n),"login"==t?this.login(e):this.signup(e)},connection.prototype.getHttpDNS=function(e,t){if(this.restHosts)return void this.getRestFromHttpDNS(e,t);var n=this,o=function(o,i){o=(new DOMParser).parseFromString(o,"text/xml").documentElement;var a=n.getHostsByTag(o,"rest");if(!a)return void console.log("rest hosts error3");n.restHosts=a,n.restTotal=a.length;var r=n.getHostsByTag(o,"xmpp");return r?(n.xmppHosts=r,n.xmppTotal=r.length,void n.getRestFromHttpDNS(e,t)):void console.log("xmpp hosts error3")},i=function(o,i,a){console.log("getHttpDNS error",o,a),n.dnsIndex++,n.dnsIndex<n.dnsTotal&&n.getHttpDNS(e,t)},a={url:this.dnsArr[this.dnsIndex]+"/easemob/server.xml",dataType:"text",type:"GET",data:{app_key:encodeURIComponent(e.appKey)},success:o||_utils.emptyfn,error:i||_utils.emptyfn};_utils.ajax(a)},connection.prototype.signup=function(e){var t=this,n=e.orgName||"",o=e.appName||"",i=e.appKey||"",a=e.success||EMPTYFN,r=e.error||EMPTYFN;if(!n&&!o&&i){var s=i.split("#");2===s.length&&(n=s[0],o=s[1])}if(!n&&!o)return void r({type:_code.WEBIM_CONNCTION_APPKEY_NOT_ASSIGN_ERROR});var c=function(n,o,i){return"https:"!=location.protocol&&t.isHttpDNS&&t.restIndex+1<t.restTotal?(t.restIndex++,void t.getRestFromHttpDNS(e,"signup")):(t.clear(),void r(n))},d=e.https||d,u=e.apiUrl,l=u+"/"+n+"/"+o+"/users",m={username:e.username,password:e.password,nickname:e.nickname||""},p=_utils.stringify(m),f={url:l,dataType:"json",data:p,success:a,error:c};_utils.ajax(f)},connection.prototype.open=function(e){"https:"!=location.protocol&&this.isHttpDNS?(this.dnsIndex=0,this.getHttpDNS(e,"login")):this.login(e)},connection.prototype.login=function(e){var t=_validCheck(e,this);if(t){var n=this;if(!n.isOpened())if(e.accessToken)e.access_token=e.accessToken,_login(e,n);else{var o=e.apiUrl,i=this.context.userId,a=e.pwd||"",r=this.context.appName,s=this.context.orgName,c=function(e,t){n.context.status=_code.STATUS_DOLOGIN_IM,n.context.restTokenData=e,_login(e,n)},d=function(t,o,i){return"https:"!=location.protocol&&n.isHttpDNS&&n.restIndex+1<n.restTotal?(n.restIndex++,void n.getRestFromHttpDNS(e,"login")):(n.clear(),void(t.error&&t.error_description?n.onError({type:_code.WEBIM_CONNCTION_OPEN_USERGRID_ERROR,data:t,xhr:o}):n.onError({type:_code.WEBIM_CONNCTION_OPEN_ERROR,data:t,xhr:o})))};this.context.status=_code.STATUS_DOLOGIN_USERGRID;var u={grant_type:"password",username:i,password:a,timestamp:+new Date},l=_utils.stringify(u),m={url:o+"/"+s+"/"+r+"/token",dataType:"json",data:l,success:c||_utils.emptyfn,error:d||_utils.emptyfn};_utils.ajax(m)}}},connection.prototype.attach=function(e){var t=_validCheck(e,this);if(t){e=e||{};var n=e.accessToken||"";if(""==n)return void this.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR});var o=e.sid||"";if(""===o)return void this.onError({type:_code.WEBIM_CONNCTION_SESSIONID_NOT_ASSIGN_ERROR});var i=e.rid||"";if(""===i)return void this.onError({type:_code.WEBIM_CONNCTION_RID_NOT_ASSIGN_ERROR});var a=this.getStrophe();this.context.accessToken=n,this.context.stropheConn=a,this.context.status=_code.STATUS_DOLOGIN_IM;var r=this,s=function(e,t){_loginCallback(e,t,r)},c=this.context.jid,d=this.wait,u=this.hold,l=this.wind||5;a.attach(c,o,i,s,d,u,l)}},connection.prototype.close=function(e){this.stopHeartBeat();var t=this.context.status;t!=_code.STATUS_INIT&&(this.isClosed()||this.isClosing()||(this.context.status=_code.STATUS_CLOSING,this.context.stropheConn.disconnect(e)))},connection.prototype.addHandler=function(e,t,n,o,i,a,r){this.context.stropheConn.addHandler(e,t,n,o,i,a,r)},connection.prototype.notifyVersion=function(e,t){var n=(_getJid({},this),$iq({from:this.context.jid||"",to:this.domain,type:"result"}).c("query",{xmlns:"jabber:iq:version"}).c("name").t("easemob").up().c("version").t(_version).up().c("os").t("webim")),e=e||_utils.emptyfn,o=t||this.onError,i=function(e){o({type:_code.WEBIM_CONNCTION_NOTIFYVERSION_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),e,i)},connection.prototype.handlePresence=function(e){if(!this.isClosed()){var t=e.getAttribute("from")||"",n=e.getAttribute("to")||"",o=e.getAttribute("type")||"",i=e.getAttribute("presence_type")||"",a=_parseNameFromJidFn(t),r=_parseNameFromJidFn(n),s={from:a,to:r,fromJid:t,toJid:n,type:o,chatroom:e.getElementsByTagName("roomtype").length?!0:!1},c=e.getElementsByTagName("show");if(c&&c.length>0){var d=c[0];s.show=Strophe.getText(d)}var u=e.getElementsByTagName("status");if(u&&u.length>0){var l=u[0];s.status=Strophe.getText(l),s.code=l.getAttribute("code")}var m=e.getElementsByTagName("priority");if(m&&m.length>0){var p=m[0];s.priority=Strophe.getText(p)}var f=e.getElementsByTagName("error");if(f&&f.length>0){var f=f[0];s.error={code:f.getAttribute("code")}}var g=e.getElementsByTagName("destroy");if(g&&g.length>0){var g=g[0];s.destroy=!0;var h=g.getElementsByTagName("reason");h&&h.length>0&&(s.reason=Strophe.getText(h[0]))}var y=e.getElementsByTagName("item");if(y&&y.length>0){var v=y[0],_=v.getAttribute("role"),E=v.getAttribute("jid");if("none"==_&&E){var b=_parseNameFromJidFn(E),I=v.getElementsByTagName("actor")[0],N=I.getAttribute("nick");s.actor=N,s.kicked=b}"moderator"==_&&"201"==s.code&&(s.type="joinPublicGroupSuccess")}var T=e.getElementsByTagName("apply");if(T&&T.length>0){T=T[0];var S=T.getAttribute("toNick"),O=T.getAttribute("to"),C=T.getAttribute("from"),x=_parseNameFromJidFn(O);_parseNameFromJidFn(C);s.toNick=S,s.groupName=x,s.type="joinGroupNotifications";var h=T.getElementsByTagName("reason");h&&h.length>0&&(s.reason=Strophe.getText(h[0]))}if(s.chatroom){s.presence_type=i,s.original_type=s.type;var R=t.slice(t.lastIndexOf("/")+1);R===this.context.userId&&(""!==s.type||s.code?("unavailable"===i||"unavailable"===s.type)&&(s.status?110==s.code?s.type="leaveChatRoom":s.error&&406==s.error.code&&(s.type="reachChatRoomCapacity"):s.type="leaveChatRoom"):s.type="joinChatRoomSuccess")}else s.presence_type=i,s.original_type=o,/subscribe/.test(s.type)||(""!=o||s.status||s.error?("unavailable"===i||"unavailable"===o)&&(s.destroy?s.type="deleteGroupChat":(307==s.code||321==s.code)&&(s.type="leaveGroup")):s.type="joinPublicGroupSuccess");this.onPresence(s,e)}},connection.prototype.handlePing=function(e){if(!this.isClosed()){var t=e.getAttribute("id"),n=e.getAttribute("from"),o=e.getAttribute("to"),i=$iq({from:o,to:n,id:t,type:"result"});this.sendCommand(i.tree())}},connection.prototype.handleIq=function(e){return!0},connection.prototype.handleIqPrivacy=function(e){var t=e.getElementsByTagName("list");0!=t.length&&this.getBlacklist()},connection.prototype.handleIqRoster=function(e){var t=e.getAttribute("id"),n=e.getAttribute("from")||"",o=(_parseNameFromJidFn(n),this.context.jid),i=(this.context.userId,$iq({type:"result",id:t,from:o}));this.sendCommand(i.tree());var a=e.getElementsByTagName("query");if(a&&a.length>0){var r=a[0],s=_parseFriend(r,this,n);this.onRoster(s)}return!0},connection.prototype.handleMessage=function(e){var t=this;if(!this.isClosed()){var n=e.getAttribute("id")||"";this.cacheReceiptsMessage({id:n});var o=_parseResponseMessage(e);if(o.errorMsg)return void this.handlePresence(e);var i=e.getElementsByTagName("error"),a="",r="",s=!1;if(i.length>0){s=!0,a=i[0].getAttribute("code");var c=i[0].getElementsByTagName("text");r=c[0].textContent||c[0].text,log("handle error",a,r)}var d=o.data;for(var u in d)if(d.hasOwnProperty(u)){var l=d[u];if(l.from&&l.to){var m=(l.from+"").toLowerCase(),p=(l.to+"").toLowerCase(),f=l.ext||{},g="",h=e.getElementsByTagName("roomtype");g=h.length?h[0].getAttribute("type")||"chat":e.getAttribute("type")||"chat";var y=l.bodies;if(y&&0!=y.length){var v=l.bodies[0],_=v.type;try{switch(_){case"txt":var E=v.msg,b=_utils.parseTextMessage(E,WebIM.Emoji);if(b.isemoji){var l={id:n,type:g,from:m,to:p,delay:o.delayTimeStamp,data:b.body,ext:f};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onEmojiMessage(l)}else{var l={id:n,type:g,from:m,to:p,delay:o.delayTimeStamp,data:E,ext:f};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onTextMessage(l)}break;case"img":var I=0,N=0;v.size&&(I=v.size.width,N=v.size.height);var l={id:n,type:g,from:m,to:p,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,thumb:v.thumb,thumb_secret:v.thumb_secret,file_length:v.file_length||"",width:I,height:N,filetype:v.filetype||"",accessToken:this.context.accessToken||"",ext:f,delay:o.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onPictureMessage(l);break;case"audio":var l={id:n,type:g,from:m,to:p,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,length:v.length||"",file_length:v.file_length||"",filetype:v.filetype||"",accessToken:this.context.accessToken||"",ext:f,delay:o.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onAudioMessage(l);break;case"file":var l={id:n,type:g,from:m,to:p,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,file_length:v.file_length,accessToken:this.context.accessToken||"",ext:f,delay:o.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onFileMessage(l);break;case"loc":var l={id:n,type:g,from:m,to:p,addr:v.addr,lat:v.lat,lng:v.lng,ext:f,delay:o.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onLocationMessage(l);break;case"video":var l={id:n,type:g,from:m,to:p,url:"https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+v.url.substr(v.url.indexOf("/",9)):v.url,secret:v.secret,filename:v.filename,file_length:v.file_length,accessToken:this.context.accessToken||"",ext:f,delay:o.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onVideoMessage(l);break;case"cmd":var l={id:n,from:m,to:p,action:v.action,ext:f,delay:o.delayTimeStamp};!l.delay&&delete l.delay,l.error=s,l.errorText=r,l.errorCode=a,this.onCmdMessage(l)}}catch(T){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:T})}}}}}},connection.prototype.handleReceivedMessage=function(e){try{this.onReceivedMessage(e)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}var n,o,i=e.getElementsByTagName("received");if(i.length>0&&(n=i[0].childNodes&&i[0].childNodes.length>0?i[0].childNodes[0].nodeValue:i[0].innerHTML||i[0].innerText,o=i[0].getAttribute("mid")),_msgHash[n]){try{_msgHash[n].msg.success instanceof Function&&_msgHash[n].msg.success(n,o)}catch(t){this.onError({type:_code.WEBIM_CONNCTION_CALLBACK_INNER_ERROR,data:t})}delete _msgHash[n]}},connection.prototype.handleInviteMessage=function(e){var t=null,n=e.getElementsByTagName("invite"),o=e.getElementsByTagName("reason")[0],i=o.textContent,a=e.getAttribute("id")||"";if(this.sendReceiptsMessage({id:a}),n&&n.length>0){var r=n[0].getAttribute("from");t=_parseNameFromJidFn(r)}var s=e.getElementsByTagName("x"),c=null;if(s&&s.length>0)for(var d=0;d<s.length;d++)if("jabber:x:conference"===s[d].namespaceURI){var u=s[d].getAttribute("jid");c=_parseNameFromJidFn(u)}this.onInviteMessage({type:"invite",from:t,roomid:c,reason:i})},connection.prototype.sendCommand=function(e,t){this.isOpened()?this.context.stropheConn.send(e):this.onError({type:_code.WEBIM_CONNCTION_DISCONNECTED,reconnect:!0})},connection.prototype.getUniqueId=function(e){var t=new Date,n=new Date(2010,1,1),o=t.getTime()-n.getTime(),i=parseInt(o).toString(16);return"string"==typeof e||"number"==typeof e?e+"_"+i:"WEBIM_"+i},connection.prototype.send=function(e){var t=this;if(this.isWindowSDK)WebIM.doQuery('{"type":"sendMessage","to":"'+e.to+'","message_type":"'+e.type+'","msg":"'+encodeURI(e.msg)+'","chatType":"'+e.chatType+'"}',function(e){},function(e,n){var o={data:{data:"send"},type:_code.WEBIM_MESSAGE_SED_ERROR};t.onError(o)});else if("[object Object]"===Object.prototype.toString.call(e)){var n=this.context.appKey||"",o=n+"_"+e.to+"@"+this.domain;e.group&&(o=n+"_"+e.to+"@conference."+this.domain),e.resource&&(o=o+"/"+e.resource),e.toJid=o,e.id=e.id||this.getUniqueId(),_msgHash[e.id]=new _message(e),_msgHash[e.id].send(this)}else"string"==typeof e&&_msgHash[e]&&_msgHash[e].send(this)},connection.prototype.addRoster=function(e){var t=_getJid(e,this),n=e.name||"",o=e.groups||"",i=$iq({type:"set"});if(i.c("query",{xmlns:"jabber:iq:roster"}),i.c("item",{jid:t,name:n}),o)for(var a=0;a<o.length;a++)i.c("group").t(o[a]).up();var r=e.success||_utils.emptyfn,s=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(i.tree(),r,s)},connection.prototype.removeRoster=function(e){var t=_getJid(e,this),n=$iq({type:"set"}).c("query",{xmlns:"jabber:iq:roster"}).c("item",{jid:t,subscription:"remove"}),o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn;this.context.stropheConn.sendIQ(n,o,i)},connection.prototype.getRoster=function(e){var t=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"}),e=e||{},n=e.success||this.onRoster,o=function(e){var t=[],o=e.getElementsByTagName("query");if(o&&o.length>0){var i=o[0];t=_parseFriend(i)}n(t,e)},i=e.error||this.onError,a=function(e){i({type:_code.WEBIM_CONNCTION_GETROSTER_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(t.tree(),o,a):i({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.subscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribe"});e.message&&n.c("status").t(e.message).up(),e.nick&&n.c("nick",{xmlns:"http://jabber.org/protocol/nick"}).t(e.nick),this.sendCommand(n.tree())},connection.prototype.subscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"subscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.unsubscribe=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribe"});e.message&&n.c("status").t(e.message),this.sendCommand(n.tree())},connection.prototype.unsubscribed=function(e){var t=_getJid(e,this),n=$pres({to:t,type:"unsubscribed"});e.message&&n.c("status").t(e.message).up(),this.sendCommand(n.tree())},connection.prototype.joinPublicGroup=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,a=function(e){i({type:_code.WEBIM_CONNCTION_JOINROOM_ERROR,data:e})},r=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC});this.context.stropheConn.sendIQ(r.tree(),o,a)},connection.prototype.listRooms=function(e){var t=$iq({to:e.server||"conference."+this.domain,from:this.context.jid,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_ITEMS}),n=e.success||_utils.emptyfn,o=e.error||this.onError,i=function(e){var t=[];t=_parseRoom(e);try{n(t)}catch(i){o({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:i})}},a=e.error||_utils.emptyfn,r=function(e){a({type:_code.WEBIM_CONNCTION_GETROOM_ERROR,data:e})};this.context.stropheConn.sendIQ(t.tree(),i,r)},connection.prototype.queryRoomMember=function(e){var t=(this.domain,[]),n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",{xmlns:Strophe.NS.MUC+"#admin"}).c("item",{affiliation:"member"}),o=e.success||_utils.emptyfn,i=function(e){var n=e.getElementsByTagName("item");if(n)for(var i=0;i<n.length;i++){var a=n[i],r={jid:a.getAttribute("jid"),affiliation:"member"};t.push(r)}o(t)},a=e.error||_utils.emptyfn,r=function(e){a({type:_code.WEBIM_CONNCTION_GETROOMMEMBER_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),i,r)},connection.prototype.queryRoomInfo=function(e){var t=this.domain,n=$iq({to:this.context.appKey+"_"+e.roomId+"@conference."+t,type:"get"}).c("query",{xmlns:Strophe.NS.DISCO_INFO}),o=e.success||_utils.emptyfn,i=[],a=function(e){var n="",a=e.getElementsByTagName("feature");switch(a&&(n=a[1].getAttribute("var")+"|"+a[3].getAttribute("var")+"|"+a[4].getAttribute("var")),n){case"muc_public|muc_membersonly|muc_notallowinvites":n="PUBLIC_JOIN_APPROVAL";break;case"muc_public|muc_open|muc_notallowinvites":n="PUBLIC_JOIN_OPEN";break;case"muc_hidden|muc_membersonly|muc_allowinvites":n="PRIVATE_MEMBER_INVITE";break;case"muc_hidden|muc_membersonly|muc_notallowinvites":n="PRIVATE_OWNER_INVITE"}var r=e.getElementsByTagName("field"),s={};if(r){for(var c=0;c<r.length;c++){var d=r[c],u=d.getAttribute("var"),l=u.split("_")[1];switch(u){case"muc#roominfo_occupants":case"muc#roominfo_maxusers":case"muc#roominfo_affiliations":case"muc#roominfo_description":s[l]=d.textContent||d.text||"";break;case"muc#roominfo_owner":var m={jid:(d.textContent||d.text)+"@"+t,affiliation:"owner"};i.push(m),s[l]=d.textContent||d.text}}s.name=e.getElementsByTagName("identity")[0].getAttribute("name")}log(n,i,s),o(n,i,s)},r=e.error||_utils.emptyfn,s=function(e){r({type:_code.WEBIM_CONNCTION_GETROOMINFO_ERROR,data:e})};this.context.stropheConn.sendIQ(n.tree(),a,s)},connection.prototype.queryRoomOccupants=function(e){var t=e.success||_utils.emptyfn,n=function(e){var n=[];n=_parseRoomOccupants(e),t(n)},o=e.error||_utils.emptyfn,i=function(e){o({type:_code.WEBIM_CONNCTION_GETROOMOCCUPANTS_ERROR,data:e})},a={xmlns:Strophe.NS.DISCO_ITEMS},r=$iq({from:this.context.jid,to:this.context.appKey+"_"+e.roomId+"@conference."+this.domain,type:"get"}).c("query",a);this.context.stropheConn.sendIQ(r.tree(),n,i)},connection.prototype.setUserSig=function(e){var t=$pres({xmlns:"jabber:client"});e=e||"",t.c("status").t(e),this.sendCommand(t.tree())},connection.prototype.setPresence=function(e,t){var n=$pres({xmlns:"jabber:client"});e&&(t?(n.c("show").t(e),n.up().c("status").t(t)):n.c("show").t(e)),this.sendCommand(n.tree())},connection.prototype.getPresence=function(){var e=$pres({xmlns:"jabber:client"});this.sendCommand(e.tree())},connection.prototype.ping=function(e){var e=e||{},t=_getJid(e,this),n=$iq({from:this.context.jid||"",to:t,type:"get"}).c("ping",{xmlns:"urn:xmpp:ping"}),o=e.success||_utils.emptyfn,i=e.error||this.onError,a=function(e){i({type:_code.WEBIM_CONNCTION_PING_ERROR,data:e})};this.isOpened()?this.context.stropheConn.sendIQ(n.tree(),o,a):i({type:_code.WEBIM_CONNCTION_DISCONNECTED})},connection.prototype.isOpened=function(){return this.context.status==_code.STATUS_OPENED},connection.prototype.isOpening=function(){var e=this.context.status;return e==_code.STATUS_DOLOGIN_USERGRID||e==_code.STATUS_DOLOGIN_IM},connection.prototype.isClosing=function(){return this.context.status==_code.STATUS_CLOSING},connection.prototype.isClosed=function(){return this.context.status==_code.STATUS_CLOSED},connection.prototype.clear=function(){var e=this.context.appKey;if(this.errorType!=_code.WEBIM_CONNCTION_DISCONNECTED&&(this.context={status:_code.STATUS_INIT,appKey:e}),this.intervalId&&clearInterval(this.intervalId),this.restIndex=0,this.xmppIndex=0,this.errorType==_code.WEBIM_CONNCTION_CLIENT_LOGOUT||-1==this.errorType){var t={data:{data:"clear"},type:_code.WEBIM_CONNCTION_CLIENT_LOGOUT};this.onError(t)}},connection.prototype.getChatRooms=function(e){if(!_utils.isCanSetRequestHeader)return void t.onError({type:_code.WEBIM_CONNCTION_NOT_SUPPORT_CHATROOM_ERROR});var t=this,n=e.accessToken||this.context.accessToken;if(n){var o=e.apiUrl,i=this.context.appName,a=this.context.orgName;if(!i||!a)return void t.onError({type:_code.WEBIM_CONNCTION_AUTH_ERROR});var r=function(t,n){"function"==typeof e.success&&e.success(t)},s=function(e,n,o){e.error&&e.error_description&&t.onError({type:_code.WEBIM_CONNCTION_LOAD_CHATROOM_ERROR,msg:e.error_description,data:e,xhr:n})},c={pagenum:parseInt(e.pagenum)||1,pagesize:parseInt(e.pagesize)||20},d={url:o+"/"+a+"/"+i+"/chatrooms",dataType:"json",type:"GET",headers:{Authorization:"Bearer "+n},data:c,success:r||_utils.emptyfn,error:s||_utils.emptyfn};_utils.ajax(d)}else t.onError({type:_code.WEBIM_CONNCTION_TOKEN_NOT_ASSIGN_ERROR})},connection.prototype.joinChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,a=function(e){i({type:_code.WEBIM_CONNCTION_JOINCHATROOM_ERROR,data:e})},r=$pres({from:this.context.jid,to:n}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"member",role:"participant"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(r.tree(),o,a)},connection.prototype.quitChatRoom=function(e){var t=this.context.appKey+"_"+e.roomId+"@conference."+this.domain,n=t+"/"+this.context.userId,o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,a=function(e){i({type:_code.WEBIM_CONNCTION_QUITCHATROOM_ERROR,data:e})},r=$pres({from:this.context.jid,to:n,type:"unavailable"}).c("x",{xmlns:Strophe.NS.MUC+"#user"}).c("item",{affiliation:"none",role:"none"}).up().up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"});this.context.stropheConn.sendIQ(r.tree(),o,a)},connection.prototype._onReceiveInviteFromGroup=function(info){info=eval("("+info+")");var self=this,options={title:"Group invitation",msg:info.user+" invites you to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_INVITATION_FROM_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineInvitationFromGroup","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineInvitationFromGroup error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_INVITATION_FROM_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" agreed to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveInviteDeclineFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation response",msg:info.user+" rejected to join into group:"+info.group_id,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onAutoAcceptInvitationFromGroup=function(info){info=eval("("+info+")");var options={title:"Group invitation",msg:"You had joined into the group:"+info.group_name+" automatically.Inviter:"+info.user,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onLeaveGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been out of the group:"+info.group_id+".Reason:"+info.msg,agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveJoinGroupApplication=function(info){info=eval("("+info+")");var self=this,options={title:"Group join application",msg:info.user+" applys to join into group:"+info.group_id,agree:function(){WebIM.doQuery('{"type":"acceptJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"acceptJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_ACCEPT_JOIN_GROUP};self.onError(n)})},reject:function(){WebIM.doQuery('{"type":"declineJoinGroupApplication","id":"'+info.group_id+'","user":"'+info.user+'"}',function(e){},function(e,t){var n={data:{data:"declineJoinGroupApplication error:"+t},type:_code.WEBIM_CONNECTION_DECLINE_JOIN_GROUP};self.onError(n)})}};this.onConfirmPop(options)},connection.prototype._onReceiveAcceptionFromGroup=function(info){info=eval("("+info+")");var options={title:"Group notification",msg:"You had joined into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onReceiveRejectionFromGroup=function(){info=eval("("+info+")");var options={title:"Group notification",msg:"You have been rejected to join into the group:"+info.group_name+".",agree:function(){}};this.onConfirmPop(options)},connection.prototype._onUpdateMyGroupList=function(e){this.onUpdateMyGroupList(e)},connection.prototype._onUpdateMyRoster=function(e){this.onUpdateMyRoster(e)},connection.prototype.reconnect=function(){console.log("reconnect");var e=this;setTimeout(function(){_login(e.context.restTokenData,e)},1e3*(0==this.autoReconnectNumTotal?0:this.autoReconnectInterval)),this.autoReconnectNumTotal++},connection.prototype.closed=function(){var e={data:{data:"Closed error"},type:_code.WEBIM_CONNECTION_CLOSED};this.onError(e)},connection.prototype.getBlacklist=function(e){e=e||{};var t=$iq({type:"get"}),n=e.success||_utils.emptyfn,o=e.error||_utils.emptyfn,i=this;t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),this.context.stropheConn.sendIQ(t.tree(),function(e){i.onBlacklistUpdate(_parsePrivacy(e)),n()},function(){i.onBlacklistUpdate([]),o()})},connection.prototype.addToBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},o=e.type||"jid",i=e.success||_utils.emptyfn,a=e.error||_utils.emptyfn,r=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),s=Object.keys(n),c=s.length,d=2,u=0;c>u;u++){var l=n[s[u]],o=l.type||"jid",m=l.jid;r=r.c("item",{action:"deny",order:d++,type:o,value:m}).c("message"),u!==c-1&&(r=r.up().up())}this.context.stropheConn.sendIQ(r.tree(),i,a)},connection.prototype.removeFromBlackList=function(e){for(var t=$iq({type:"set"}),n=e.list||{},o=e.success||_utils.emptyfn,i=e.error||_utils.emptyfn,a=t.c("query",{xmlns:"jabber:iq:privacy"}).c("list",{name:"special"}),r=Object.keys(n),s=r.length,c=0;s>c;c++){var d=n[r[c]],u=d.type||"jid",l=d.jid,m=d.order;a=a.c("item",{action:"deny",order:m,type:u,value:l}).c("message"),c!==s-1&&(a=a.up().up())}this.context.stropheConn.sendIQ(a.tree(),o,i)},connection.prototype._getGroupJid=function(e){var t=this.context.appKey||"";return t+"_"+e+"@conference."+this.domain},connection.prototype.addToGroupBlackList=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=_getJid(e,this),i="admin",a=this._getGroupJid(e.roomId),r=$iq({type:"set",to:a});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"outcast",jid:o}),this.context.stropheConn.sendIQ(r.tree(),t,n)},connection.prototype.getGroupBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o="admin",i=this._getGroupJid(e.roomId),a=$iq({type:"get",to:i});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("item",{affiliation:"outcast"}),this.context.stropheConn.sendIQ(a.tree(),function(e){log("getGroupBlackList"),t(_parseGroupBlacklist(e))},function(){n()})},connection.prototype.removeGroupMemberFromBlacklist=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=_getJid(e,this),i="admin",a=this._getGroupJid(e.roomId),r=$iq({type:"set",to:a});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"member",jid:o}),this.context.stropheConn.sendIQ(r.tree(),function(e){t()},function(){n()})},connection.prototype.changeGroupSubject=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o="owner",i=this._getGroupJid(e.roomId),a=$iq({type:"set",to:i});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("x",{type:"submit",xmlns:"jabber:x:data"}).c("field",{"var":"FORM_TYPE"}).c("value").t("http://jabber.org/protocol/muc#roomconfig").up().up().c("field",{"var":"muc#roomconfig_roomname"}).c("value").t(e.subject).up().up().c("field",{"var":"muc#roomconfig_roomdesc"}).c("value").t(e.description),this.context.stropheConn.sendIQ(a.tree(),function(e){t()},function(){n()})},connection.prototype.destroyGroup=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o="owner",i=this._getGroupJid(e.roomId),a=$iq({type:"set",to:i});a.c("query",{xmlns:"http://jabber.org/protocol/muc#"+o}).c("destroy").c("reason").t(e.reason||""),this.context.stropheConn.sendIQ(a.tree(),function(e){t()},function(){n()})},connection.prototype.leaveGroupBySelf=function(e){var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=_getJid(e,this),i="admin",a=this._getGroupJid(e.roomId),r=$iq({type:"set",to:a});r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}).c("item",{affiliation:"none",jid:o}),this.context.stropheConn.sendIQ(r.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.leaveGroup=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=e.list||[],i="admin",a=this._getGroupJid(e.roomId),r=$iq({type:"set",to:a}),s=r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}),c=Object.keys(o),d=c.length,u=0;d>u;u++){var l=o[c[u]],m=_getJidByName(l,this);s=s.c("item",{affiliation:"none",jid:m}).up().c("item",{role:"none",jid:m}).up()}this.context.stropheConn.sendIQ(r.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.addGroupMembers=function(e){for(var t=e.success||_utils.emptyfn,n=e.error||_utils.emptyfn,o=e.list||[],i="admin",a=this._getGroupJid(e.roomId),r=$iq({type:"set",to:a}),s=r.c("query",{xmlns:"http://jabber.org/protocol/muc#"+i}),c=o.length,d=0;c>d;d++){var u=o[d],l=_getJidByName(u,this);s=s.c("item",{affiliation:"member",jid:l}).up();var m=$msg({to:a}).c("x",{xmlns:"http://jabber.org/protocol/muc#user"}).c("invite",{to:l}).c("reason").t(e.reason||"");this.sendCommand(m.tree())}this.context.stropheConn.sendIQ(r.tree(),function(e){t(e)},function(e){n(e)})},connection.prototype.acceptInviteFromGroup=function(e){e.success=function(){},this.addGroupMembers(e)},connection.prototype.rejectInviteFromGroup=function(e){},connection.prototype.createGroup=function(e){var t=+new Date,n=this._getGroupJid(t),o=n+"/"+this.context.userId,i=$pres({to:o}).c("x",{xmlns:"http://jabber.org/protocol/muc"}).up().c("create",{xmlns:"http://jabber.org/protocol/muc"}).up();this.sendCommand(i.tree());var a=this;setTimeout(function(){var o=$iq({type:"get",to:n}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"});a.context.stropheConn.sendIQ(o.tree(),function(o){if("setAttribute"in o){var i=o.getElementsByTagName("x")[0];i.setAttribute("type","submit")}else Strophe.forEachChild(o,"x",function(e){
e.setAttribute("type","submit")});Strophe.info("step 5 ----------"),Strophe.forEachChild(i,"field",function(t){var n=t.getAttribute("var"),o=t.getElementsByTagName("value")[0];switch(Strophe.info(n),n){case"muc#roomconfig_roomname":_setText(o,e.subject||"");break;case"muc#roomconfig_roomdesc":_setText(o,e.description||"");break;case"muc#roomconfig_publicroom":_setText(o,+e.optionsPublic);break;case"muc#roomconfig_membersonly":_setText(o,+e.optionsMembersOnly);break;case"muc#roomconfig_moderatedroom":_setText(o,+e.optionsModerate);break;case"muc#roomconfig_persistentroom":_setText(o,1);break;case"muc#roomconfig_allowinvites":_setText(o,+e.optionsAllowInvites);break;case"muc#roomconfig_allowvisitornickchange":_setText(o,0);break;case"muc#roomconfig_allowvisitorstatus":_setText(o,0);break;case"allow_private_messages":_setText(o,0);break;case"allow_private_messages_from_visitors":_setText(o,"nobody")}});var r=$iq({to:n,type:"set"}).c("query",{xmlns:"http://jabber.org/protocol/muc#owner"}).cnode(i);a.context.stropheConn.sendIQ(r.tree(),function(n){a.addGroupMembers({list:e.members,roomId:t})},function(e){})},function(e){})},1e3)};var WebIM=window.WebIM||{};WebIM.connection=connection,WebIM.utils=_utils,WebIM.statusCode=_code,WebIM.message=_msg.message,WebIM.doQuery=function(e,t,n){"undefined"!=typeof window.cefQuery&&window.cefQuery({request:e,persistent:!1,onSuccess:t,onFailure:n})},module.exports=WebIM},232:function(e,t,n){"use strict";!function(){var e=n(223).utils,o=function a(e,t){return!this instanceof a?new a(e):(this._msg={},"function"==typeof a[e]&&(a[e].prototype.setGroup=this.setGroup,this._msg=new a[e](t)),this._msg)};o.prototype.setGroup=function(e){this.body.group=e},o.txt=function(e){this.id=e,this.type="txt",this.body={}},o.txt.prototype.set=function(e){this.value=e.msg,this.body={id:this.id,to:e.to,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success,fail:e.fail},!e.roomType&&delete this.body.roomType},o.cmd=function(e){this.id=e,this.type="cmd",this.body={}},o.cmd.prototype.set=function(e){this.value="",this.body={to:e.to,action:e.action,msg:this.value,type:this.type,roomType:e.roomType,ext:e.ext||{},success:e.success},!e.roomType&&delete this.body.roomType},o.location=function(e){this.id=e,this.type="loc",this.body={}},o.location.prototype.set=function(e){this.body={to:e.to,type:this.type,roomType:e.roomType,addr:e.addr,lat:e.lat,lng:e.lng,ext:e.ext||{}}},o.img=function(e){this.id=e,this.type="img",this.body={}},o.img.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.body={id:this.id,file:this.value,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,width:t.width,height:t.height,body:t.body,uploadError:t.uploadError,uploadComplete:t.uploadComplete},!t.roomType&&delete this.body.roomType},o.audio=function(e){this.id=e,this.type="audio",this.body={}},o.audio.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},length:t.length||0,roomType:t.roomType,file_length:t.file_length,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},o.file=function(e){this.id=e,this.type="file",this.body={}},o.file.prototype.set=function(t){t.file=t.file||e.getFileUrl(t.fileInputId),this.value=t.file,this.filename=t.filename||this.value.filename,this.body={id:this.id,file:this.value,filename:this.filename,apiUrl:t.apiUrl,to:t.to,type:this.type,ext:t.ext||{},roomType:t.roomType,onFileUploadError:t.onFileUploadError,onFileUploadComplete:t.onFileUploadComplete,success:t.success,fail:t.fail,flashUpload:t.flashUpload,body:t.body},!t.roomType&&delete this.body.roomType},o.video=function(e){},o.video.prototype.set=function(e){};var i=function r(e){return!this instanceof r?new r(e,conn):void(this.msg=e)};i.prototype.send=function(t){var n=this,o=function(n){n.ext=n.ext||{},n.ext.weichat=n.ext.weichat||{},n.ext.weichat.originType=n.ext.weichat.originType||"webim";var o={from:t.context.userId||"",to:n.to,bodies:[n.body],ext:n.ext||{}},i=e.stringify(o),a=$msg({type:n.group||"chat",to:n.toJid,id:n.id,xmlns:"jabber:client"}).c("body").t(i);n.roomType&&a.up().c("roomtype",{xmlns:"easemob:x:roomtype",type:"chatroom"}),setTimeout(function(){"undefined"!=typeof _msgHash&&_msgHash[n.id]&&_msgHash[n.id].msg.fail instanceof Function&&_msgHash[n.id].msg.fail(n.id)},6e4),t.sendCommand(a.tree(),n.id)};if(n.msg.file){if(n.msg.body&&n.msg.body.url)return void o(n.msg);var i=n.msg.onFileUploadComplete,a=function(e){if(e.entities[0]["file-metadata"]){var a=e.entities[0]["file-metadata"]["content-length"];n.msg.file_length=a,n.msg.filetype=e.entities[0]["file-metadata"]["content-type"],a>204800&&(n.msg.thumbnail=!0)}n.msg.body={type:n.msg.type||"file",url:("https:"!=location.protocol&&t.isHttpDNS?t.apiUrl+e.uri.substr(e.uri.indexOf("/",9)):e.uri)+"/"+e.entities[0].uuid,secret:e.entities[0]["share-secret"],filename:n.msg.file.filename||n.msg.filename,size:{width:n.msg.width||0,height:n.msg.height||0},length:n.msg.length||0,file_length:n.msg.file_length||0,filetype:n.msg.filetype},o(n.msg),i instanceof Function&&i(e,n.msg.id)};n.msg.onFileUploadComplete=a,e.uploadFile.call(t,n.msg)}else n.msg.body={type:"chat"===n.msg.type?"txt":n.msg.type,msg:n.msg.msg},"cmd"===n.msg.type?n.msg.body.action=n.msg.action:"loc"===n.msg.type&&(n.msg.body.addr=n.msg.addr,n.msg.body.lat=n.msg.lat,n.msg.body.lng=n.msg.lng),o(n.msg)},t._msg=i,t.message=o}()},233:function(e,t){"use strict";!function(){function e(e){this.array=void 0===e?[]:new Array(e)}e.prototype={length:function(){return this.array.length},at:function(e){return this.array[e]},set:function(e,t){this.array[e]=t},push:function(e){return this.array.push(e)},slice:function(e,t){return this.array=this.array.slice(e,t)},concat:function(e){this.array=this.array.concat(e)},remove:function(e,t){t=void 0===t?1:t,this.array.splice(e,t)},join:function(e){return this.array.join(e)},clear:function(){this.array.length=0}};var n=function(){this._array_h=new e};n.prototype={_index:0,push:function(e){this._array_h.push(e)},pop:function(){var e=null;return this._array_h.length()&&(e=this._array_h.at(this._index),2*++this._index>=this._array_h.length()&&(this._array_h.slice(this._index),this._index=0)),e},head:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(t-1)),e},tail:function(){var e=null,t=this._array_h.length();return t&&(e=this._array_h.at(this._index)),e},length:function(){return this._array_h.length()-this._index},empty:function(){return 0===this._array_h.length()},clear:function(){this._array_h.clear()}},t.Queue=n}()}}),window.URL=window.URL||window.webkitURL||window.mozURL||window.msURL,Array.prototype.indexOf||(Array.prototype.indexOf=function(e){var t=this.length,n=Number(arguments[1])||0;for(n=0>n?Math.ceil(n):Math.floor(n),0>n&&(n+=t);t>n;n++)if(n in this&&this[n]===e)return n;return-1}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var n,o;if(null===this)throw new TypeError("this is null or not defined");var i=Object(this),a=i.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(n=t),o=0;a>o;){var r;o in i&&(r=i[o],e.call(n,r,o,i)),o++}}),function(e){"use strict";e.console||(e.console={});for(var t,n,o=e.console,i=function(){},a=["memory"],r="assert,clear,count,debug,dir,dirxml,error,exception,group,groupCollapsed,groupEnd,info,log,markTimeline,profile,profiles,profileEnd,show,table,time,timeEnd,timeline,timelineEnd,timeStamp,trace,warn".split(",");t=a.pop();)o[t]||(o[t]={});for(;n=r.pop();)o[n]||(o[n]=i)}("undefined"==typeof window?this:window),function(){function e(e){var t=Object.prototype.toString.call(e);return"object"==typeof e&&/^\[object (HTMLCollection|NodeList|Object)\]$/.test(t)&&"number"==typeof e.length&&(0===e.length||"object"==typeof e[0]&&e[0].nodeType>0)}function t(e,t){o(e,t)||(e.className+=" "+t)}function n(e,t){o(e,t)&&(e.className=(" "+e.className+" ").replace(new RegExp(" "+t+" ","g")," ").trim())}function o(e,t){return!!~(" "+e.className+" ").indexOf(" "+t+" ")}function i(t,n){if("function"==typeof n){var o,i,a,r=e(t)?t:[t],s=[];for(o=2,i=arguments.length;i>o;++o)s.push(arguments[o]);for(o=0,i=r.length;i>o;++o)(a=r[o])&&(1===a.nodeType||9===a.nodeType||11===a.nodeType)&&n.apply(null,[a].concat(s))}}function a(e,t,n,o){e.addEventListener?e.addEventListener(t,n,o):e.attachEvent?(e["_"+t]=function(){n.apply(e,arguments)},e.attachEvent("on"+t,e["_"+t])):e["on"+t]=n}function r(e,t,n){var o="_"+t,i="on"+t;e.removeEventListener&&n?e.removeEventListener(t,n):e.detachEvent?(e.detachEvent(i,e[o]),delete e[o]):e[i]=null}window.easemobim=window.easemobim||{};var s=/mobile/i.test(navigator.userAgent);easemobim.utils={isTop:window.top===window.self,isNodeList:e,formatDate:function(e,t){var n=e?new Date(e):new Date,o=t||"M月d日 hh:mm",i={"M+":n.getMonth()+1,"d+":n.getDate(),"h+":n.getHours(),"m+":n.getMinutes(),"s+":n.getSeconds()};/(y+)/.test(o)&&(o=o.replace(RegExp.$1,(n.getFullYear()+"").substr(4-RegExp.$1.length)));for(var a in i)new RegExp("("+a+")").test(o)&&(o=o.replace(RegExp.$1,1===RegExp.$1.length?i[a]:("00"+i[a]).substr((""+i[a]).length)));return o},filesizeFormat:function(e){var t,n,o=["B","KB","MB","GB","TB","PB","EB","ZB"];return e>0?(t=Math.floor(Math.log(e)/Math.log(1024)),n=(e/Math.pow(1024,t)).toFixed(2)+" "+o[t]):n=0===e?"0 B":"",n},uuid:function(){for(var e=[],t="0123456789abcdef",n=0;36>n;n++)e[n]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")},convertFalse:function(e){return e="undefined"==typeof e?"":e,"false"===e?!1:e},$Remove:function(e){e&&(e.remove?e.remove():e.parentNode&&e.parentNode.removeChild(e))},live:function(e,t,n,o){var i=this,a=o||document;i.on(a,t,function(t){var o,i,r=t||window.event,s=r.target||r.srcElement,c=a.querySelectorAll(e);for(o=0,i=c.length;i>o;++o)c[o]===s&&n.call(s,r)})},on:function(e,t,n,o){t.split(" ").forEach(function(t){t&&i(e,a,t,n,o)})},off:function(e,t,n){t.split(" ").forEach(function(t){t&&i(e,r,t,n)})},one:function(e,t,n,o){if(e&&t){var i=function(){n.apply(this,arguments),r(e,t,i)};a(e,t,i,o)}},trigger:function(e,t){if(document.createEvent){var n=document.createEvent("HTMLEvents");n.initEvent(t,!0,!1),e.dispatchEvent(n)}else e.fireEvent("on"+t)},extend:function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var o=Object.prototype.toString.call(t[n]);"[object Array]"===o?(e[n]=[],this.extend(e[n],t[n])):"[object Object]"===o?(e[n]={},this.extend(e[n],t[n])):e[n]=t[n]}return e},addClass:function(e,n){return i(e,t,n),e},removeClass:function(e,t){return i(e,n,t),e},hasClass:function(e,t){return e?o(e,t):!1},toggleClass:function(e,i,a){if(e&&i){var r="undefined"==typeof a?!o(e,i):a;r?t(e,i):n(e,i)}},getDataByPath:function(e,t){function n(){var e=o.shift();return"string"!=typeof e?i:"object"==typeof i&&null!==i?(i=i[e],n()):void 0}var o=t.split("."),i=e;return n()},query:function(e){var t=new RegExp("[?&]"+e+"=([^&]*)(?=&|$)"),n=t.exec(location.search);return n?n[1]:""},isAndroid:/android/i.test(navigator.useragent),isIOS:/(iPad|iPhone|iPod)/i.test(navigator.userAgent),isMobile:s,click:s&&"ontouchstart"in window?"touchstart":"click",isMin:function(){return"hidden"===document.visibilityState||document.hidden},setStore:function(e,t){try{localStorage.setItem(e,t)}catch(n){}},getStore:function(e){try{return localStorage.getItem(e)}catch(t){}},clearStore:function(e){try{localStorage.removeItem(e)}catch(t){}},clearAllStore:function(){try{localStorage.clear()}catch(e){}},set:function(e,t,n){var o=new Date,i=o.getTime()+24*(n||30)*3600*1e3;o.setTime(i),document.cookie=encodeURIComponent(e)+"="+encodeURIComponent(t)+";path=/;expires="+o.toGMTString()},get:function(e){var t=document.cookie.match("(^|;) ?"+encodeURIComponent(e)+"=([^;]*)(;|$)");return t?decodeURIComponent(t[2]):""},getAvatarsFullPath:function(e,t){if(e){e=e.replace(/^(https?:)?\/\/?/,"");var n=~e.indexOf("img-cn"),o=~e.indexOf("ossimages");return n&&!o?t+"/ossimages/"+e:"//"+e}},getConfig:function(e){for(var t,n={},o=document.scripts,i=0,a=o.length;a>i;i++)if(~o[i].src.indexOf("easemob.js")){t=o[i].src;break}if(!t)return{json:n,domain:""};for(var r,s=t.indexOf("?"),c=~t.indexOf("//")?t.indexOf("//"):0,d=t.slice(c,t.indexOf("/",c+2)),u=t.slice(s+1).split("&"),l=0,m=u.length;m>l;l++)r=u[l].split("="),n[r[0]]=r.length>1?decodeURIComponent(r[1]):"";return{json:n,domain:d}},updateAttribute:function(e,t,n){var o=e||location.protocol+n+"/im.html?tenantId=";for(var i in t)t.hasOwnProperty(i)&&"undefined"!=typeof t[i]&&(~o.indexOf(i+"=")?o=o.replace(new RegExp(i+"=[^&#?]*","gim"),i+"="+(""!==t[i]?t[i]:"")):o+="&"+i+"="+(""!==t[i]?t[i]:""));return o},copy:function(e){return this.extend({},e)},code:function(){var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",t={encode:function(t){var n,o,i,a,r,s,c,d="",u=0;do n=t.charCodeAt(u++),o=t.charCodeAt(u++),i=t.charCodeAt(u++),a=n>>2,r=(3&n)<<4|o>>4,s=(15&o)<<2|i>>6,c=63&i,isNaN(o)?s=c=64:isNaN(i)&&(c=64),d=d+e.charAt(a)+e.charAt(r)+e.charAt(s)+e.charAt(c);while(u<t.length);return d},decode:function(t){var n,o,i,a,r,s,c,d="",u=0;t=t.replace(/[^A-Za-z0-9\+\/\=]/g,"");do a=e.indexOf(t.charAt(u++)),r=e.indexOf(t.charAt(u++)),s=e.indexOf(t.charAt(u++)),c=e.indexOf(t.charAt(u++)),n=a<<2|r>>4,o=(15&r)<<4|s>>2,i=(3&s)<<6|c,d+=String.fromCharCode(n),64!=s&&(d+=String.fromCharCode(o)),64!=c&&(d+=String.fromCharCode(i));while(u<t.length);return d}};return t}()}}(),function(){easemobim._const={agentStatusText:{Idle:"(离线)",Online:"(空闲)",Busy:"(忙碌)",Leave:"(离开)",Hidden:"(隐身)",Offline:"(离线)",Logout:"(离线)",Other:""},agentStatusClassName:{Idle:"online",Online:"online",Busy:"busy",Leave:"leave",Hidden:"hidden",Offline:"offline",Logout:"offline",Other:"hide"},eventMessageText:{TRANSFERING:"会话转接中，请稍候",TRANSFER:"会话已被转接至其他客服",LINKED:"会话已被客服接起",CLOSED:"会话已结束",NOTE:"当前暂无客服在线，请您留下联系方式，稍后我们将主动联系您",CREATE:"会话创建成功"},themeMap:{"天空之城":"theme-1","丛林物语":"theme-2","红瓦洋房":"theme-3","鲜美橙汁":"theme-4","青草田间":"theme-5","湖光山色":"theme-6","冷峻山峰":"theme-7","月色池塘":"theme-8","天籁湖光":"theme-9","商务风格":"theme-10"},IM:{WEBIM_CONNCTION_OPEN_ERROR:1,WEBIM_CONNCTION_AUTH_ERROR:2,WEBIM_CONNCTION_AJAX_ERROR:17,WEBIM_CONNCTION_CALLBACK_INNER_ERROR:31},EVENTS:{NOTIFY:"notify",RECOVERY:"recoveryTitle",SHOW:"showChat",CLOSE:"closeChat",CACHEUSER:"setUser",DRAGREADY:"dragReady",DRAGEND:"dragEnd",SLIDE:"titleSlide",ONMESSAGE:"onMessage",ONSESSIONCLOSED:"onSessionClosed",EXT:"ext",TEXTMSG:"textmsg",ONREADY:"onready",SET_ITEM:"setItem",UPDATE_URL:"updateURL",REQUIRE_URL:"requireURL",INIT_CONFIG:"initConfig"},UPLOAD_FILESIZE_LIMIT:10485760,FIRST_CHANNEL_MESSAGE_TIMEOUT:1e4,SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT:1,FIRST_CHANNEL_CONNECTION_TIMEOUT:2e4,HEART_BEAT_INTERVAL:6e4,SECOND_CHANNEL_MESSAGE_RECEIVE_INTERVAL:6e4,MESSAGE_PREDICT_MAX_LENGTH:100,MAX_TEXT_MESSAGE_LENGTH:1500,GET_HISTORY_MESSAGE_COUNT_EACH_TIME:10,for_block_only:null}}(),function(){var e=function(){},t=function(){try{return new window.XMLHttpRequest}catch(e){return!1}},n=function(){try{return new window.ActiveXObject("Microsoft.XMLHTTP")}catch(e){return!1}},o=function(o){var i=o.dataType||"text",a=o.success||e,r=o.error||e,s=t()||n();s.onreadystatechange=function(){var e;if(4===s.readyState){var t=s.status||0;if(200===t){if("text"===i)return void a(s.responseText,s);if("json"===i){try{e=JSON.parse(s.responseText),a(e,s)}catch(n){}return}return void a(s.response||s.responseText,s)}if("json"==i){try{e=JSON.parse(s.responseText),r(e,s,"服务器返回错误信息")}catch(n){r(s.responseText,s,"服务器返回错误信息")}return}return void r(s.responseText,s,"服务器返回错误信息")}0===s.readyState&&r(s.responseText,s,"服务器异常")};var c=o.type||"GET",d=o.data||{},u="";if("get"===c.toLowerCase()){for(var l in d)d.hasOwnProperty(l)&&(u+=l+"="+d[l]+"&");u=u?u.slice(0,-1):u,o.url+=(o.url.indexOf("?")>0?"&":"?")+(u?u+"&":u)+"_v="+(new Date).getTime(),d=null}else d._v=(new Date).getTime(),d=JSON.stringify(d);if(s.open(c,o.url),s.setRequestHeader){var m=o.headers||{};m["Content-Type"]=m["Content-Type"]||"application/json";for(var p in m)m.hasOwnProperty(p)&&s.setRequestHeader(p,m[p])}return s.send(d),s};window.easemobim=window.easemobim||{},window.easemobim.emajax=o}(),window.easemobim=window.easemobim||{},window.easemobIM=window.easemobIM||{},easemobIM.Transfer=easemobim.Transfer=function(){"use strict";var e=function(e,t,n){if("string"==typeof e.data){var o,i,a=JSON.parse(e.data),r=!1;if(n&&n.length)for(o=0,i=n.length;i>o;o++)a.key===n[o]&&(r=!0,"function"==typeof t&&t(a));else"function"==typeof t&&t(a);if(!r&&n)for(o=0,i=n.length;i>o;o++)if("data"===n[o]){"function"==typeof t&&t(a);break}}},t=function(e,n){return this instanceof t?(this.key=n,this.iframe=document.getElementById(e),void(this.origin=location.protocol+"//"+location.host)):new t(e)};return t.prototype.send=function(e,t){return e.origin=this.origin,e.key=this.key,t&&(e.to=t),e=JSON.stringify(e),this.iframe?this.iframe.contentWindow.postMessage(e,"*"):window.parent.postMessage(e,"*"),this},t.prototype.listen=function(t,n){var o=this;return window.addEventListener?window.addEventListener("message",function(i){e.call(o,i,t,n)},!1):window.attachEvent&&window.attachEvent("onmessage",function(i){e.call(o,i,t,n)}),this},t}(),function(){var e=new easemobim.Transfer(null,"api"),t=function(t){var n=null;return t.msg.data&&t.msg.data.headers&&(n=t.msg.data.headers,delete t.msg.data.headers),{url:t.url,headers:n,data:t.excludeData?null:t.msg.data,type:t.type||"GET",success:function(n){try{n=JSON.parse(n)}catch(o){}e.send({call:t.msg.api,timespan:t.msg.timespan,status:0,data:n})},error:function(n){try{n=JSON.parse(n)}catch(o){}e.send({call:t.msg.api,timespan:t.msg.timespan,status:1,data:n})}}};e.listen(function(n){switch(e.targetOrigin=n.origin,n.api){case"getRelevanceList":easemobim.emajax(t({url:"/v1/webimplugin/targetChannels",msg:n}));break;case"getDutyStatus":easemobim.emajax(t({url:"/v1/webimplugin/showMessage",msg:n}));break;case"getWechatVisitor":easemobim.emajax(t({url:"/v1/webimplugin/visitors/wechat/"+n.data.openid+"?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"createVisitor":easemobim.emajax(t({url:"/v1/webimplugin/visitors?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"getSession":easemobim.emajax(t({url:"/v1/webimplugin/visitors/"+n.data.id+"/schedule-data?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getExSession":easemobim.emajax(t({url:"/v1/webimplugin/visitors/"+n.data.id+"/schedule-data-ex?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getPassword":easemobim.emajax(t({url:"/v1/webimplugin/visitors/password",msg:n}));break;case"getGroup":easemobim.emajax(t({url:"/v1/webimplugin/visitors/"+n.data.id+"/ChatGroupId?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getGroupNew":easemobim.emajax(t({url:"/v1/webimplugin/tenant/"+n.data.tenantId+"/visitors/"+n.data.id+"/ChatGroupId?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"getHistory":easemobim.emajax(t({url:"/v1/webimplugin/visitors/msgHistory",msg:n}));break;case"getSlogan":easemobim.emajax(t({url:"/v1/webimplugin/notice/options",msg:n}));break;case"getTheme":easemobim.emajax(t({url:"/v1/webimplugin/theme/options",msg:n}));break;case"getSystemGreeting":easemobim.emajax(t({url:"/v1/webimplugin/welcome",msg:n}));break;case"getRobertGreeting":easemobim.emajax(t({url:"/v1/Tenants/"+n.data.tenantId+"/robots/visitor/greetings/"+n.data.originType+"?tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"sendVisitorInfo":easemobim.emajax(t({url:"/v1/webimplugin/tenants/"+n.data.tenantId+"/visitors/"+n.data.visitorId+"/attributes?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"getProject":easemobim.emajax(t({url:"/tenants/"+n.data.tenantId+"/projects",msg:n}));break;case"createTicket":easemobim.emajax(t({url:"/tenants/"+n.data.tenantId+"/projects/"+n.data.projectId+"/tickets?tenantId="+n.data.tenantId+"&easemob-target-username="+n.data["easemob-target-username"]+"&easemob-appkey="+n.data["easemob-appkey"]+"&easemob-username="+n.data["easemob-username"],msg:n,type:"POST"}));break;case"receiveMsgChannel":easemobim.emajax(t({url:"/v1/imgateway/messages",msg:n}));break;case"sendMsgChannel":easemobim.emajax(t({url:"/v1/imgateway/messages?tenantId="+n.data.tenantId,msg:n,type:"POST"}));break;case"getAgentStatus":easemobim.emajax(t({url:"/v1/tenants/"+n.data.tenantId+"/agents/"+n.data.agentUserId+"/agentstate",msg:n}));break;case"getNickNameOption":easemobim.emajax(t({url:"/v1/webimplugin/agentnicename/options?tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"reportEvent":easemobim.emajax(t({url:"/v1/event_collector/events",msg:n,type:"POST"}));break;case"deleteEvent":easemobim.emajax(t({url:"/v1/event_collector/event/"+encodeURIComponent(n.data.userId),msg:n,type:"DELETE",excludeData:!0}));break;case"mediaStreamUpdateStatus":var o=n.data.streamId;delete n.data.streamId,easemobim.emajax(t({url:"/v1/rtcmedia/media_streams/"+o,msg:n,type:"PUT"}));break;case"graylist":easemobim.emajax(t({url:"/management/graylist",msg:n,excludeData:!0}));break;case"getCurrentServiceSession":easemobim.emajax(t({url:"/v1/webimplugin/tenant/"+n.data.tenantId+"/visitors/"+n.data.id+"/CurrentServiceSession?techChannelInfo="+n.data.orgName+"%23"+n.data.appName+"%23"+n.data.imServiceNumber+"&tenantId="+n.data.tenantId,msg:n,excludeData:!0}));break;case"messagePredict":var i=n.data.tenantId,a=n.data.agentId;delete n.data.tenantId,delete n.data.agentId,easemobim.emajax(t({url:"/v1/webimplugin/agents/"+a+"/messagePredict?tenantId="+i,msg:n,type:"POST"}));break;case"getSessionQueueId":var r=n.data.visitorUsername;easemobim.emajax(t({url:"/v1/visitors/"+r+"/waitings/sessions",msg:n,type:"GET"}));break;case"getWaitListNumber":easemobim.emajax(t({url:"/v1/visitors/waitings/data",msg:n,type:"GET"}))}},["data"])}(),function(){function e(e){if(!e||0===e.length)return"";var t="";return t=e.replace(/&amp;/g,"&"),t=t.replace(/<(?=[^o][^)])/g,"&lt;"),t=t.replace(/>/g,"&gt;"),t=t.replace(/\"/g,"&quot;")}function t(e){if(!e||0===e.length)return"";var t="";return t=e.replace(/&amp;/g,"&"),t=t.replace(/&#39;/g,"'"),t=t.replace(/&lt;/g,"<")}function n(n){var o=n.type,i=n.value,s="";switch(o){case"txt":i=e(t(i)),s="<pre>"+a(r(i))+"</pre>";break;case"img":s=i?'<a href="javascript:;"><img class="em-widget-imgview" src="'+i.url+'"/></a>':'<i class="icon-broken-pic"></i>';break;case"list":s="<p>"+a(e(i))+"</p>"+n.listDom;break;case"file":s=i?'<i class="icon-attachment container-icon-attachment"></i><span class="file-info"><p class="filename">'+n.filename+'</p><p class="filesize">'+easemobim.utils.filesizeFormat(i.filesize)+"</p></span><a target='_blank' href='"+i.url+"' class='icon-download container-icon-download' title='"+n.filename+"'></a>":'<i class="icon-broken-pic"></i>'}return s}function o(e,t){var o=e.id,a=e.type,r="",s=[],c=document.createElement("div"),d=t?"left":"right";return c.className="em-widget-"+d,o&&(c.id=o),"left"===d&&(r+='<img class="avatar" src="'+window.benz_global.avatar+'">',r+='<span class="agent-name">'+window.benz_global.agentName+"</span>"),r+='<div class="em-widget-msg-wrapper">',r+='<i class="icon-corner-'+d+'"></i>',!t&&o&&(r+='<div id="'+o+'_failed" data-type="txt" class="em-widget-msg-status hide"><span>发送失败</span><i class="icon-circle"><i class="icon-exclamation"></i></i></div><div id="'+o+'_loading" class="em-widget-msg-loading">'+i+"</div>"),r+='<div class="em-widget-msg-container em-widget-msg-'+a+'">',r+=n(e),s.push("</div>"),s.push("</div>"),r+=_.reduceRight(s,function(e,t){return e+t},""),c.innerHTML=r,c}var i=Modernizr.inlinesvg?['<div class="em-widget-loading">','<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 70 70">','<circle opacity=".3" fill="none" stroke="#000" stroke-width="4" stroke-miterlimit="10" cx="35" cy="35" r="11"/>','<path fill="none" stroke="#E5E5E5" stroke-width="4" stroke-linecap="round" stroke-miterlimit="10" d="M24 35c0-6.1 4.9-11 11-11 2.8 0 5.3 1 7.3 2.8"/>','<image width="20" style="margin-top:10px"/>',"</svg>","</div>"].join(""):'<img src="//kefu.easemob.com/webim/static/img/loading.gif" width="20" style="margin-top:10px;"/>',a=WebIM.utils.parseLink,r=WebIM.utils.parseEmoji;WebIM.message.list=function(e){this.id=e,this.type="list",this.brief="",this.body={}},WebIM.message.list.prototype.set=function(e){this.value=e.value,this.listDom=e.list},easemobim.genDomFromMsg=o}(),easemobim.paste=function(e){function t(e){/^image\/\w+$/.test(i.getDataByPath(e,"clipboardData.items.0.type"))&&(n=e.clipboardData.items[0].getAsFile(),o=window.URL.createObjectURL(n),c.src=o,i.removeClass(a,"hide"))}var n,o,i=easemobim.utils,a=document.querySelector(".em-widget-paste-wrapper"),r=a.querySelector(".em-widget-cancel"),s=a.querySelector(".em-widget-confirm"),c=a.querySelector("img");return i.on(r,"click",function(){i.addClass(a,"hide")}),i.on(s,"click",function(){e.channel.sendImg({data:n,url:o}),i.addClass(a,"hide")}),{init:function(){i.on(easemobim.textarea,"paste",t)}}},function(e){easemobim.leaveMessage=function(t,n){var o,i,a,r,s,c=!1;if(!d){var d=document.querySelector(".em-widget-offline"),u=d.querySelector("textarea"),l=d.querySelector(".contact"),m=d.querySelector(".phone"),p=d.querySelector(".mail"),f=d.querySelector(".btn-ok"),g=d.querySelector(".btn-cancel"),h=d.querySelector(".em-widget-success-prompt");return e.on(g,e.click,function(){e.addClass(d,"hide")}),e.on(f,e.click,function(){c?t.errorPrompt("留言提交中..."):o&&i?!l.value||l.value.length>140?t.errorPrompt("姓名输入不正确"):!m.value||m.value.length>24?t.errorPrompt("电话输入不正确"):!p.value||p.value.length>127?t.errorPrompt("邮箱输入不正确"):!u.value||u.value.length>2e3?t.errorPrompt("留言内容不能为空，长度小于2000字"):(c=!0,setTimeout(function(){c=!1},1e4),easemobim.api("createTicket",{tenantId:n,"easemob-target-username":i,"easemob-appkey":r,"easemob-username":s,origin_type:"webim",headers:{Authorization:"Easemob IM "+a},projectId:o,subject:"",content:u.value,status_id:"",priority_id:"",category_id:"",creator:{name:l.value,avatar:"",email:p.value,phone:m.value,qq:"",company:"",description:""},attachments:null},function(n){c=!1,n&&n.data&&n.data.id?(e.removeClass(h,"hide"),setTimeout(function(){e.addClass(h,"hide")},1500),l.value="",m.value="",p.value="",u.value=""):t.errorPrompt("留言失败，请稍后重试")})):t.errorPrompt("留言失败，token无效")}),{auth:function(t,c){a=t,i=c.toUser,s=c.user.username,r=c.appKey.replace("#","%23"),o||easemobim.api("getProject",{tenantId:n,"easemob-target-username":i,"easemob-appkey":r,"easemob-username":s,headers:{Authorization:"Easemob IM "+a}},function(t){o=e.getDataByPath(t,"data.entities.0.id")})},show:function(t){e.toggleClass(g,"hide",!!t),e.removeClass(d,"hide")}}}}}(easemobim.utils),easemobim.satisfaction=function(e){var t,n,o=document.querySelector(".em-widget-satisfaction-dialog"),i=easemobim.utils,a=document.querySelector(".em-widget-satisfaction"),r=o.getElementsByTagName("ul")[0],s=r.getElementsByTagName("li"),c=o.getElementsByTagName("textarea")[0],d=o.getElementsByTagName("button"),u=d[0],l=d[1],m=o.getElementsByTagName("div")[1];i.on(a,i.click,function(){t=null,n=null,i.removeClass(o,"hide"),clearInterval(e.focusText)}),i.live("button.js_satisfybtn","click",function(){t=this.getAttribute("data-servicesessionid"),n=this.getAttribute("data-inviteid"),i.removeClass(o,"hide"),clearInterval(e.focusText)}),i.on(u,"click",function(){i.addClass(o,"hide")}),i.on(l,"click",function(){var a=r.querySelectorAll("li.sel").length;return 0===a?void e.errorPrompt("请先选择星级"):(e.channel.sendSatisfaction(a,c.value,t,n),c.blur(),i.removeClass(m,"hide"),void setTimeout(function(){c.value="",_.each(s,function(e){i.removeClass(e,"sel")}),i.addClass(m,"hide"),i.addClass(o,"hide")},1500))}),i.on(r,"click",function(e){var t=e||window.event,n=t.target||t.srcElement,o=+n.getAttribute("idx")||0;_.each(s,function(e,t){i.toggleClass(e,"sel",o>t)})})},easemobim.imgView=function(e){var t=document.querySelector("div.img-view"),n=t.querySelector("img");return e.on(t,"click",function(){e.addClass(t,"hide")},!1),{show:function(o){n.setAttribute("src",o),e.removeClass(t,"hide")}}}(easemobim.utils),function(){var e=/MicroMessenger/.test(navigator.userAgent),t=easemobim.utils.query("wechatAuth"),n=easemobim.utils.query("appid"),o=easemobim.utils.query("code"),i=easemobim.utils.query("tenantId");e&&t&&i&&n&&(easemobim.wechat=function(e){var t=function(e){easemobim.emajax({url:"/v1/weixin/admin/appid",success:function(t){e(t)},error:function(t){e(null)}})},a=function(e,t){easemobim.emajax({url:"/v1/weixin/sns/userinfo/"+n+"/"+e,data:{tenantId:i},type:"GET",success:function(e){t(e)},error:function(e){var t=location.href.replace(/&code=[^&]+/,"");t.indexOf("appid")!==t.lastIndexOf("appid")&&(t=t.replace(/&appid=wx[^&]+/,"")),location.href=t}})};o?a(o,function(t){return t?void e(t):void e()}):t(function(t){if(!t)return void e();var o=encodeURIComponent(location.href),i="https://open.weixin.qq.com/connect/oauth2/authorize?appid="+n+"&redirect_uri="+o+"&response_type=code&scope=snsapi_userinfo&state=STATE&component_appid="+t+"#wechat_redirect";location.href=i})})}(),function(){var e=function(){this.list={}};e.prototype.set=function(e,t){return"undefined"==typeof this.list[e]&&(this.list[e]=t),this},e.prototype.get=function(e){return this.list.hasOwnProperty(e)?this.list[e]:null},e.prototype.remove=function(e){"undefined"!=typeof this.list[e]&&delete this.list[e]},easemobim.site=e}(),function(){var e=function(e,t){this.fn=e,this.isStarted=!1,this.timerHandler=null,this.interval=t};e.prototype.start=function(){this.isStarted||(this.isStarted=!0,setTimeout(this.fn,0),this.timerHandler=setInterval(this.fn,this.interval))},e.prototype.stop=function(){this.isStarted&&(this.isStarted=!1,clearInterval(this.timerHandler))},e.prototype.isStarted=function(){return this.isStarted},easemobim.Polling=e}(),easemobim.channel=function(e){function t(){s("receiveMsgChannel",{orgName:e.orgName,appName:e.appName,easemobId:e.toUser,tenantId:e.tenantId,visitorEasemobId:e.user.username},function(e){e.data&&"OK"===e.data.status&&_.each(e.data.entities,function(e){try{m.handleReceive(e,e.bodies[0].type,!1)}catch(t){}})})}function n(t,i){var a,d=t.id;a="number"==typeof i?i:c.SECOND_MESSAGE_CHANNEL_MAX_RETRY_COUNT,s("sendMsgChannel",{from:e.user.username,to:e.toUser,tenantId:e.tenantId,bodies:[{type:"txt",msg:t.value}],ext:t.body?t.body.ext:null,orgName:e.orgName,appName:e.appName,originType:"webim"},function(){o(d)},function(){a>0?n(t,--a):(r.addClass(document.getElementById(d+"_loading"),"hide"),r.removeClass(document.getElementById(d+"_failed"),"hide"))})}function o(e){clearTimeout(d.get(e)),d.remove(e),r.$Remove(document.getElementById(e+"_loading")),r.$Remove(document.getElementById(e+"_failed")),u.get(e)&&a.handleEventStatus(null,null,"转人工"===u.get(e).value||"转人工客服"===u.get(e).value),u.remove(e)}function i(e){d.set(e,setTimeout(function(){n(u.get(e))},c.FIRST_CHANNEL_MESSAGE_TIMEOUT))}var a=this,r=easemobim.utils,s=easemobim.api,c=easemobim._const,d=new easemobim.site,u=new easemobim.site,l=new easemobim.site,m={getConnection:function(){return new WebIM.connection({url:e.xmppServer,retry:!0,
isMultiLoginSessions:e.resources,heartBeatWait:c.HEART_BEAT_INTERVAL})},reSend:function(e,t){if(t){var o=u.get(t);switch(e){case"txt":n(o,0)}}},appendAck:function(e,t){e.body.ext.weichat.msg_id_for_ack=t},sendSatisfaction:function(e,t,n,o){m.sendText("",!1,{ext:{weichat:{ctrlType:"enquiry",ctrlArgs:{inviteId:o||"",serviceSessionId:n||"",detail:t,summary:e}}}})},sendText:function(t,n,o){var s=r.uuid(),c=new WebIM.message.txt(n?null:s);if(c.set({msg:t,to:e.toUser,success:function(e){},fail:function(e){}}),o&&_.extend(c.body,o),n){if(!t)return;a.appendMsg(e.user.username,n,c,!0)}else{if(i(s),a.setExt(c),m.appendAck(c,s),a.conn.send(c.body),u.set(s,c),!t)return;a.appendDate((new Date).getTime(),e.toUser),a.appendMsg(e.user.username,e.toUser,c)}},sendTransferToKf:function(t,n){var o=r.uuid();i(o);var s=new WebIM.message.cmd(o);s.set({to:e.toUser,action:"TransferToKf",ext:{weichat:{ctrlArgs:{id:t,serviceSessionId:n}}}}),m.appendAck(s,o),a.conn.send(s.body),u.set(o,s),a.handleEventStatus(null,null,!0)},sendImg:function(t,n){var o=r.uuid(),i=new WebIM.message.img(n?null:o);i.set({apiUrl:location.protocol+"//"+e.restServer,file:t,accessToken:a.token,to:e.toUser,uploadError:function(e){setTimeout(function(){var t=e.id,n=document.getElementById(t+"_loading"),o=document.querySelector("#"+t+" .em-widget-msg-container");o&&(o.innerHTML='<i class="icon-broken-pic"></i>'),r.addClass(n,"hide"),a.scrollBottom()},50)},uploadComplete:function(){a.handleEventStatus()},success:function(e){r.$Remove(document.getElementById(e+"_loading")),r.$Remove(document.getElementById(e+"_failed"))},fail:function(e){r.addClass(document.getElementById(e+"_loading"),"hide"),r.removeClass(document.getElementById(e+"_failed"),"hide")}}),n?a.appendMsg(e.user.username,t.to,i,!0):(a.setExt(i),a.conn.send(i.body),a.appendDate((new Date).getTime(),e.toUser),a.appendMsg(e.user.username,e.toUser,i))},sendFile:function(t,n){var o=r.uuid(),i=new WebIM.message.file(n?null:o);i.set({apiUrl:location.protocol+"//"+e.restServer,file:t,to:e.toUser,uploadError:function(e){var t=e.id,n=document.getElementById(t+"_loading"),o=document.querySelector("#"+t+" .em-widget-msg-container");o&&(o.innerHTML='<i class="icon-broken-pic"></i>'),r.addClass(n,"hide"),a.scrollBottom()},uploadComplete:function(){a.handleEventStatus()},success:function(e){r.$Remove(document.getElementById(e+"_loading")),r.$Remove(document.getElementById(e+"_failed"))},fail:function(e){r.addClass(document.getElementById(e+"_loading"),"hide"),r.removeClass(document.getElementById(e+"_failed"),"hide")}}),n?a.appendMsg(e.user.username,t.to,i,!0):(a.setExt(i),a.conn.send(i.body),a.appendDate((new Date).getTime(),e.toUser),a.appendMsg(e.user.username,e.toUser,i))},handleReceive:function(t,n,i){var d,u,m=t.msgId||r.getDataByPath(t,"ext.weichat.msgId");if(!l.get(m)&&(m&&l.set(m,1),i||!t.from||t.from.toLowerCase()==e.toUser.toLowerCase()||t.noprompt)){switch("inviteEnquiry"===r.getDataByPath(t,"ext.weichat.ctrlType")?n="satisfactionEvaluation":r.getDataByPath(t,"ext.msgtype.choice")?n="robotList":"TransferToKfHint"===r.getDataByPath(t,"ext.weichat.ctrlType")?n="robotTransfer":"live/video"===r.getDataByPath(t,"ext.type")&&(n="liveStreaming/video"),n){case"txt":case"emoji":u=new WebIM.message.txt(m),u.set({msg:i?t.data:a.getSafeTextValue(t)});break;case"cmd":var p=t.action||r.getDataByPath(t,"bodies.0.action");if("KF-ACK"===p)return void o(t.ext.weichat.ack_for_msg_id);if("KEFU_MESSAGE_RECALL"===p){var f=t.ext.weichat.recall_msg_id,g=document.getElementById(f);r.$Remove(g)}break;case"img":u=new WebIM.message.img(m),u.set({file:{url:t.url||r.getDataByPath(t,"bodies.0.url")}});break;case"file":u=new WebIM.message.file(m),u.set({file:{url:t.url||r.getDataByPath(t,"bodies.0.url"),filename:t.filename||r.getDataByPath(t,"bodies.0.filename"),filesize:t.file_length||r.getDataByPath(t,"bodies.0.file_length")}});break;case"satisfactionEvaluation":if(u=new WebIM.message.list,u.set({value:"请对我的服务做出评价",list:['<div class="em-widget-list-btns"><button class="em-widget-list-btn bg-hover-color js_satisfybtn" data-inviteid="'+t.ext.weichat.ctrlArgs.inviteId+'" data-servicesessionid="'+t.ext.weichat.ctrlArgs.serviceSessionId+'">立即评价</button></div>']}),!i){var h=document.createElement("BUTTON");h.className="js_satisfybtn",h.style.display="none",h.setAttribute("data-inviteid",t.ext.weichat.ctrlArgs.inviteId),h.setAttribute("data-servicesessionid",t.ext.weichat.ctrlArgs.serviceSessionId),document.body.appendChild(h),r.trigger(h,"click"),easemobim.textarea.blur()}break;case"robotList":u=new WebIM.message.list;var y=t.ext.msgtype.choice.items||t.ext.msgtype.choice.list;if(y.length>0){d='<div class="em-widget-list-btns">';for(var v=0,_=y.length;_>v;v++)d+="TransferToKf"===y[v].id?'<button class="em-widget-list-btn-white bg-color border-color bg-hover-color-dark js_robotbtn" data-id="'+y[v].id+'">'+(y[v].name||y[v])+"</button>":'<button class="em-widget-list-btn bg-hover-color js_robotbtn" data-id="'+y[v].id+'">'+(y[v].name||y[v])+"</button>";d+="</div>"}u.set({value:t.ext.msgtype.choice.title,list:d});break;case"robotTransfer":u=new WebIM.message.list;var E=t.ext.weichat.ctrlArgs,b=t.data||r.getDataByPath(t,"bodies.0.msg")||r.getDataByPath(t,"ext.weichat.ctrlArgs.label");d=['<div class="em-widget-list-btns">','<button class="em-widget-list-btn-white bg-color border-color bg-hover-color-dark js_robotTransferBtn" ','data-sessionid="'+E.serviceSessionId+'" ','data-id="'+E.id+'">'+E.label+"</button>","</div>"].join(""),u.set({value:b,list:d});break;case"liveStreaming/video":u=new WebIM.message.txt(m),u.set({value:i?t.data:a.getSafeTextValue(t)}),!i&&r.isMobile&&easemobim.liveStreaming&&easemobim.liveStreaming.open(t.ext.msgtype.streamId)}if(!i)switch(r.getDataByPath(t,"ext.weichat.event.eventName")){case"ServiceSessionTransferedEvent":a.handleEventStatus("transferd",t.ext.weichat.event.eventObj);break;case"ServiceSessionTransferedToAgentQueueEvent":a.waitListNumber.start(),a.handleEventStatus("transfering",t.ext.weichat.event.eventObj);break;case"ServiceSessionClosedEvent":a.hasSentAttribute=!1,a.waitListNumber.stop(),e.agentUserId=null,a.stopGettingAgentStatus(),a.setEnterpriseInfo(),a.clearAgentStatus(),a.handleEventStatus("close"),!r.isTop&&transfer.send({event:c.EVENTS.ONSESSIONCLOSED},window.transfer.to);break;case"ServiceSessionOpenedEvent":a.hasAgentOnline=!0,a.waitListNumber.stop(),a.handleEventStatus("linked",t.ext.weichat.event.eventObj),a.hasSentAttribute||s("getExSession",{id:e.user.username,orgName:e.orgName,appName:e.appName,imServiceNumber:e.toUser,tenantId:e.tenantId},function(e){a.sendAttribute(e)});break;case"ServiceSessionCreatedEvent":a.handleEventStatus("create"),a.waitListNumber.start(),a.hasSentAttribute||s("getExSession",{id:e.user.username,orgName:e.orgName,appName:e.appName,imServiceNumber:e.toUser,tenantId:e.tenantId},function(e){a.sendAttribute(e)});break;default:var I=r.getDataByPath(t,"ext.weichat.agent");I&&a.handleEventStatus("reply",I)}u&&u.value&&(i?a.appendMsg(t.from,t.to,u,!0):(t.noprompt||a.messagePrompt(u),a.appendDate((new Date).getTime(),t.from),a.resetSpan(),u.id=m,a.appendMsg(t.from,t.to,u),a.scrollBottom(50),!r.isTop&&transfer.send({event:c.EVENTS.ONMESSAGE,data:{from:t.from,to:t.to,message:u}},window.transfer.to)))}},listen:function(t){var n=t||{receiveMessage:!0},o={onOpened:function(e){clearTimeout(p),a.reOpen&&clearTimeout(a.reOpen),a.token=e.accessToken,a.conn.setPresence();try{a.handleReady(e)}catch(t){console.warn(t)}},onTextMessage:function(e){a.receiveMsg(e,"txt")},onEmojiMessage:function(e){a.receiveMsg(e,"emoji")},onPictureMessage:function(e){a.receiveMsg(e,"img")},onFileMessage:function(e){a.receiveMsg(e,"file")},onCmdMessage:function(e){a.receiveMsg(e,"cmd")},onOnline:function(){r.isMobile&&a.open()},onOffline:function(){r.isMobile&&a.conn.close(),console.log("onOffline-channel"),Modernizr.peerconnection&&WebIM.WebRTC&&easemobim.videoChat&&e.grayList.audioVideo&&easemobim.videoChat.onOffline()},onError:function(t){t.reconnect?a.open():t.type===c.IM.WEBIM_CONNCTION_AUTH_ERROR?a.reOpen||(a.reOpen=setTimeout(function(){a.open()},2e3)):t.type===c.IM.WEBIM_CONNCTION_OPEN_ERROR&&t.data.type===c.IM.WEBIM_CONNCTION_AJAX_ERROR&&/user not found/.test(t.data.data)&&e.isUsernameFromCookie?(console.warn(t.data),easemobim.reCreateImUser()):t.type===c.IM.WEBIM_CONNCTION_CALLBACK_INNER_ERROR?console.error(t.data):(console.warn(t),"function"==typeof e.onerror&&e.onerror(t))}};n.receiveMessage||(delete o.onTextMessage,delete o.onEmojiMessage,delete o.onPictureMessage,delete o.onFileMessage,delete o.onCmdMessage),a.conn.listen(o)},handleHistory:function(t){_.each(t,function(t,n){var o=t.body,i=r.getDataByPath(o,"bodies.0"),s=o.from===e.user.username;if(i){if(s)switch(i.type){case"img":i.url=/^http/.test(i.url)?i.url:e.base+i.url,i.to=o.to,a.channel.sendImg(i,!0);break;case"file":i.url=/^http/.test(i.url)?i.url:e.base+i.url,i.to=o.to,a.channel.sendFile(i,!0);break;case"txt":a.channel.sendText(i.msg,!0)}else if("inviteEnquiry"===r.getDataByPath(o,"ext.weichat.ctrlType"))o.msgId=t.msgId,a.receiveMsg(o,"",!0);else if(r.getDataByPath(o,"ext.msgtype.choice")||"TransferToKfHint"===r.getDataByPath(o,"ext.weichat.ctrlType"))a.receiveMsg(o,"",!0);else{if(1===r.getDataByPath(o,"ext.weichat.recall_flag"))return;a.receiveMsg({msgId:t.msgId,data:"txt"===i.type?a.getSafeTextValue(o):i.msg,filename:i.filename,file_length:i.file_length,url:/^http/.test(i.url)?i.url:e.base+i.url,from:o.from,to:o.to},i.type,!0)}"cmd"===i.type||"txt"===i.type&&!i.msg||l.get(t.msgId)||a.appendDate(t.timestamp||o.timestamp,s?o.to:o.from,!0)}})},initSecondChannle:function(){a.receiveMsgTimer=setInterval(t,c.SECOND_CHANNEL_MESSAGE_RECEIVE_INTERVAL)}},p=setTimeout(function(){a.handleReady()},c.FIRST_CHANNEL_CONNECTION_TIMEOUT);return m},easemobim.liveStreaming=function(){function e(){document.activeElement===l?d.classList.add("hide"):d.classList.remove("hide")}function t(){p.addEventListener("click",function(e){c.src=a,v.updateStatus("PLAYING"),c.play(),s.classList.remove("hide"),m.classList.add("hide")},!1),c.addEventListener("loadeddata",function(e){console.log(e.type),console.log("size",c.videoWidth,c.videoHeight)},!1),r.isIOS?(l.addEventListener("focus",E,!1),l.addEventListener("blur",E,!1),document.body.addEventListener("touchmove",E,!1)):(l.addEventListener("focus",e,!1),l.addEventListener("blur",e,!1))}function n(){var e,t;"undefined"!=typeof document.hidden?(e="hidden",t="visibilitychange"):"undefined"!=typeof document.msHidden?(e="msHidden",t="msvisibilitychange"):"undefined"!=typeof document.webkitHidden?(e="webkitHidden",t="webkitvisibilitychange"):e="unsupport","unsupport"!==e&&document.addEventListener(t,function(){document[e]?c.pause():c.play()},!1)}function o(){["loadedmetadata","loadstart","stalled","canplaythrough","suspend","pause","playing","error","waiting","progress","webkitbeginfullscreen","timeupdate","webkitendfullscreen"].forEach(function(e){c.addEventListener(e,function(e){console.log(e.type,e)})})}function i(e,t){easemobim.api("mediaStreamUpdateStatus",{visitorUpdateStatusRequest:{status:e},streamId:t},function(e){var t=r.getDataByPath(e,"data.visitorUpdateStatusResponse.status"),n=r.getDataByPath(e,"data.visitorUpdateStatusResponse.streamUri");switch(t){case"STARTED":a=n,f.classList.remove("disabled"),s.classList.add("playing");break;case"STOPPED":case"ABNORMAL":s.classList.remove("playing"),u.innerHTML="00:00",v.stop(),c.pause(),c.src="",y.start(),r.set("streamId","");break;case"INIT":}})}var a,r=easemobim.utils,s=document.querySelector(".em-live-streaming-wrapper"),c=s.querySelector("video"),d=s.querySelector(".status-panel"),u=s.querySelector(".status-panel .time"),l=document.querySelector(".em-widget-textarea"),m=document.querySelector(".live-video-wait"),p=m.querySelector(".start-btn"),f=m.querySelector(".footer"),g=document.querySelector(".live-video-closing"),h=g.querySelector(".time-remaining"),y={timer:null,start:function(){function e(){n--,h.innerText=n,0>n&&(t.timer=clearInterval(t.timer),g.classList.add("hide"),f.classList.remove("disabled"),s.classList.add("hide"),history.back())}var t=this,n=5;this.timer=clearInterval(this.timer),this.timer=setInterval(e,1e3),g.classList.remove("hide"),h.innerText=n}},v={timer:null,interval:3e3,status:"IDLE",start:function(e){function t(){i(n.status,e)}var n=this;setTimeout(t,0),this.timer=setInterval(t,this.interval)},stop:function(){this.timer=clearInterval(this.timer),this.updateStatus("IDLE")},updateStatus:function(e){this.status=e}},E=_.throttle(function(){e();var t=s.getBoundingClientRect().top,n=-document.body.getBoundingClientRect().top;console.log(t,n),t&&(s.style.top=n+"px")},600,{leading:!1});return{init:function(e){t(),o(),n();var i=r.get("streamId");i&&v.start(i)},open:function(e){v.start(e),r.set("streamId",e,1)}}}(),function(){easemobim.chat=function(e){function t(){var t=e.ext;!n&&t&&(n=!0,_.isArray(t)?_.each(t,function(e){var t=!!i.getDataByPath(e,"msgtype.track"),n=!!i.getDataByPath(e,"msgtype.order");!t&&!n&&o.sendText("",!1,{ext:e})}):o.sendText("",!1,{ext:t}))}var n,o,i=easemobim.utils,a=easemobim._const,r=easemobim.api;easemobim.imBtn=document.getElementById("em-widgetPopBar"),easemobim.imChat=document.getElementById("em-kefu-webim-chat"),easemobim.imChatBody=document.getElementById("em-widgetBody"),easemobim.send=document.getElementById("em-widgetSend"),easemobim.textarea=easemobim.send.querySelector(".em-widget-textarea"),easemobim.sendBtn=easemobim.send.querySelector(".em-widget-send"),easemobim.sendImgBtn=easemobim.send.querySelector(".em-widget-img"),easemobim.sendFileBtn=easemobim.send.querySelector(".em-widget-file"),easemobim.noteBtn=document.querySelector(".em-widget-note"),easemobim.dragHeader=document.getElementById("em-widgetDrag"),easemobim.dragBar=easemobim.dragHeader.querySelector(".drag-bar"),easemobim.avatar=document.querySelector(".em-widgetHeader-portrait"),easemobim.swfupload=null;var s={agentStatusText:document.querySelector(".em-header-status-text"),agentWaitNumber:document.querySelector(".em-header-status-text-queue-number"),agentStatusSymbol:document.getElementById("em-widgetAgentStatus"),nickname:document.querySelector(".em-widgetHeader-nickname"),imgInput:document.querySelector(".upload-img-container"),fileInput:document.querySelector(".upload-file-container"),emojiContainer:document.querySelector(".em-bar-emoji-container"),chatWrapper:document.querySelector(".em-widget-chat"),emojiWrapper:document.querySelector(".em-bar-emoji-wrapper"),emojiBtn:easemobim.send.querySelector(".em-bar-emoji"),block:null};return easemobim.doms=s,window.benz_global={},e.agentUserId=null,{init:function(){this.channel=o=easemobim.channel.call(this,e),this.conn=this.channel.getConnection(),this.scbT=0,this.msgTimeSpan={},this.opened=!0,this.soundReminder(),this.initEmoji(),this.bindEvents()},handleReady:function(t){var n=this;if(!n.readyHandled)if(n.readyHandled=!0,easemobim.sendBtn.innerHTML="发送",i.trigger(easemobim.textarea,"change"),(e.minimum===!1||e.eventCollector===!0)&&transfer.send({event:a.EVENTS.SHOW},window.transfer.to),t&&e.user&&(e.user.token=e.user.token||t.accessToken),easemobim.leaveMessage&&easemobim.leaveMessage.auth(n.token,e),this.cachedCommandMessage&&(n.channel.sendText("",!1,this.cachedCommandMessage),this.cachedCommandMessage=null),e.liveVideoInvite&&n.channel.sendText("邀请您进行实时视频",!1,null),i.isTop){var o=e.visitor,r=(e.tenantId||"")+(e.emgroup||"");if(!o){o=i.getStore(r+"visitor");try{e.visitor=JSON.parse(o)}catch(s){}i.clearStore(e.tenantId+e.emgroup+"visitor")}if(e.ext)return;var c,d=i.getStore(r+"ext");try{c=JSON.parse(d)}catch(s){}c&&(n.channel.sendText("",!1,{ext:c}),i.clearStore(e.tenantId+e.emgroup+"ext"))}else transfer.send({event:a.EVENTS.ONREADY},window.transfer.to)},setExt:function(t){t.body.ext=t.body.ext||{},t.body.ext.weichat=t.body.ext.weichat||{},e.emgroup&&(t.body.ext.weichat.queueName=decodeURIComponent(e.emgroup)),e.visitor&&(t.body.ext.weichat.visitor=e.visitor),e.agentName&&(t.body.ext.weichat.agentUsername=e.agentName),e.language&&(t.body.ext.weichat.language=e.language),e.grUserId&&(t.body.ext.weichat.visitor=t.body.ext.weichat.visitor||{},t.body.ext.weichat.visitor.gr_user_id=e.grUserId)},ready:function(){function t(){n.setEnterpriseInfo(),e.logo&&n.setLogo(),n.channel.listen({receiveMessage:e.isInOfficehours}),n.open(),e.isInOfficehours?(n.setNotice(),n.getSession(),n.getNickNameOption(),!e.isNewUser&&!n.hasGotHistoryMsg&&n.getHistory(function(){n.scrollBottom(),n.hasGotHistoryMsg=!0}),!e.isNewUser&&n.initHistoryPuller(),n.waitListNumber.start(),n.channel.initSecondChannle(),i.isMobile&&easemobim.liveStreaming&&easemobim.liveStreaming.init(n.channel.sendText)):n.setOffline()}var n=this;getDutyStatusPromise=new Promise(function(t,n){r("getDutyStatus",{tenantId:e.tenantId},function(n){e.isInOfficehours=!n.data||"chat"===e.offDutyType,t()},function(e){n(e)})}),getGrayListPromise=new Promise(function(t,n){r("graylist",{},function(n){var o={},i=n.data||{};_.each(["audioVideo","msgPredictEnable","waitListNumberEnable"],function(t){o[t]=_.contains(i[t],+e.tenantId)}),e.grayList=o,t()},function(e){n(e)})}),Promise.all([getDutyStatusPromise,getGrayListPromise]).then(function(){t()},function(e){throw e})},initAutoGrow:function(){function e(){var e=this.value?this.scrollHeight:o;this.style.height=e+"px",this.scrollTop=9999,t()}function t(){var e=easemobim.send.getBoundingClientRect().height;"up"===n.direction?s.emojiWrapper.style.top=43+e+"px":(easemobim.imChatBody.style.bottom=e+"px",s.emojiWrapper.style.bottom=e+"px"),n.scrollBottom(800)}var n=this,o=easemobim.textarea.clientHeight;n.isAutoGrowInitialized||(n.isAutoGrowInitialized=!0,i.on(easemobim.textarea,"input change",e))},initHistoryPuller:function(){var e=this;!function(){var t,n,o;i.live("div.em-widget-date","touchstart",function(e){var t=e.touches;e.touches&&e.touches.length>0&&(n=t[0].pageY)}),i.live("div.em-widget-date","touchmove",function(i){var a=i.touches;i.touches&&i.touches.length>0&&(o=a[0].pageY,o-n>8&&this.getBoundingClientRect().top>=0&&(clearTimeout(t),t=setTimeout(function(){e.getHistory()},100)))}),i.on(s.chatWrapper,"mousewheel DOMMouseScroll",function(n){var o=this;(n.wheelDelta/120>0||n.detail<0)&&(clearTimeout(t),t=setTimeout(function(){o.getBoundingClientRect().top>=0&&e.getHistory()},400))})}()},getHistory:function(t){var n=this,o=n.groupId,i=n.currHistoryMsgSeqId||0;n.hasHistoryMessage!==!1&&(o?r("getHistory",{fromSeqId:i,size:a.GET_HISTORY_MESSAGE_COUNT_EACH_TIME,chatGroupId:o,tenantId:e.tenantId},function(e){var o=e.data||[],i=o[o.length-1]||{},a=i.chatGroupSeqId-1;n.currHistoryMsgSeqId=a,n.hasHistoryMessage=a>0,n.channel.handleHistory(o),"function"==typeof t&&t()}):r("getGroupNew",{id:e.user.username,orgName:e.orgName,appName:e.appName,imServiceNumber:e.toUser,tenantId:e.tenantId},function(e){e.data&&(n.groupId=e.data,n.getHistory(t))}))},getGreeting:function(){var t=this;t.greetingGetted||(t.greetingGetted=!0,r("getSystemGreeting",{tenantId:e.tenantId},function(n){var o=n.data;o&&t.receiveMsg({ext:{weichat:{html_safe_body:{msg:o}}},type:"txt",noprompt:!0},"txt"),r("getRobertGreeting",{tenantId:e.tenantId,originType:"webim"},function(e){var n=i.getDataByPath(e,"data.greetingTextType"),o=i.getDataByPath(e,"data.greetingText"),a={};if("number"==typeof n)switch(n){case 0:t.receiveMsg({ext:{weichat:{html_safe_body:{msg:o}}},type:"txt",noprompt:!0},"txt");break;case 1:try{a=JSON.parse(o.replace(/&quot;/g,'"'))}catch(r){console.warn("unexpected JSON string.",r)}a.ext?t.receiveMsg({ext:a.ext,noprompt:!0}):console.warn("The menu does not exist.");break;default:console.warn("unknown greeting type.")}})}))},getNickNameOption:function(){r("getNickNameOption",{tenantId:e.tenantId},function(t){e.nickNameOption="true"===i.getDataByPath(t,"data.0.optionValue")})},getSession:function(){var t=this;r("getExSession",{id:e.user.username,orgName:e.orgName,appName:e.appName,imServiceNumber:e.toUser,tenantId:e.tenantId},function(n){var o=n.data||{},i=o.serviceSession;t.hasHumanAgentOnline=o.onlineHumanAgentCount>0,t.hasAgentOnline=o.onlineHumanAgentCount+o.onlineRobotAgentCount>0,i?(e.agentUserId=i.agentUserId,t.startToGetAgentStatus(),t.sendAttribute(n)):t.getGreeting()})},sendAttribute:function(t){var n=i.getDataByPath(t,"data.serviceSession.visitorUser.userId");!this.hasSentAttribute&&n&&(this.hasSentAttribute=!0,e.visitorUserId=n,r("sendVisitorInfo",{tenantId:e.tenantId,visitorId:n,referer:document.referrer}))},setEnterpriseInfo:function(){this.setAgentProfile({tenantName:e.defaultAgentName,avatar:e.tenantAvatar})},startToGetAgentStatus:function(){},stopGettingAgentStatus:function(){e.agentStatusTimer=clearInterval(e.agentStatusTimer)},clearAgentStatus:function(){s.agentStatusSymbol.className="hide",s.agentStatusText.innerText=""},updateAgentStatus:function(){var t=this;return e.agentUserId&&e.nickNameOption&&e.user.token?void r("getAgentStatus",{tenantId:e.tenantId,orgName:e.orgName,appName:e.appName,agentUserId:e.agentUserId,userName:e.user.username,token:e.user.token,imServiceNumber:e.toUser},function(e){var t=i.getDataByPath(e,"data.state");t&&(s.agentStatusText.innerText=a.agentStatusText[t],s.agentStatusSymbol.className="em-widget-agent-status "+a.agentStatusClassName[t])}):void t.stopGettingAgentStatus()},waitListNumber:function(){function t(){e.grayList.waitListNumberEnable&&(a=!0,clearInterval(c),r("getSessionQueueId",{tenantId:e.tenantId,visitorUsername:e.user.username,techChannelInfo:e.orgName+"%23"+e.appName+"%23"+e.toUser},function(e){var t,o,i=e.data.entity;i&&"Wait"===i.state&&(t=i.queueId,o=i.serviceSessionId,a&&(c=setInterval(function(){n(t,o)},1e3)))}))}function n(t,n){r("getWaitListNumber",{tenantId:e.tenantId,queueId:t,serviceSessionId:n},function(e){var t=e.data.entity;"no"===t.visitorUserWaitingNumber?i.addClass(s.agentWaitNumber,"hide"):t.visitorUserWaitingTimestamp>d&&(d=t.visitorUserWaitingTimestamp,i.removeClass(s.agentWaitNumber,"hide"),s.agentWaitNumber.querySelector("label").innerHTML=t.visitorUserWaitingNumber)})}function o(){clearInterval(c),d=0,a=!1,i.addClass(s.agentWaitNumber,"hide")}var a=!1,c=null,d=0;return{start:t,stop:o}}(),setAgentProfile:function(t){var n=t.avatar?i.getAvatarsFullPath(t.avatar,e.domain):e.tenantAvatar||e.defaultAvatar;t.tenantName?(window.benz_global.agentName=t.tenantName,window.benz_global.avatar=n):t.userNickname&&e.nickNameOption&&"调度员"!==t.userNickname&&(window.benz_global.agentName=t.userNickname,n&&(window.benz_global.avatar=n)),this.currentAvatar=n},setLogo:function(){i.removeClass(document.querySelector(".em-widget-tenant-logo"),"hide"),document.querySelector(".em-widget-tenant-logo img").src=e.logo},setNotice:function(){var t=this;t.sloganGot||(t.sloganGot=!0,r("getSlogan",{tenantId:e.tenantId},function(e){var t=i.getDataByPath(e,"data.0.optionValue");t&&(document.querySelector(".em-widget-tip .content").innerHTML=WebIM.utils.parseLink(t),i.addClass(easemobim.imChat,"has-tip"),i.on(document.querySelector(".em-widget-tip .tip-close"),i.click,function(){i.removeClass(easemobim.imChat,"has-tip")}))}))},initEmoji:function(){function t(){var e=WebIM.Emoji.path,t=7;return _.chain(WebIM.Emoji.map).map(function(t,n){return'<div class="em-bar-emoji-bg e-face"><img class="e-face emoji" src="'+e+t+'" data-value='+n+" /></div>"}).groupBy(function(e,n){return Math.floor(n/t)}).map(function(e){return'<li class="e-face">'+e.join("")+"</li>"}).value().join("")}var n=this;!n.isEmojiInitilized&&e.liveVideoInvite&&(n.isEmojiInitilized=!0,s.emojiContainer.innerHTML=t()),i.on(s.emojiBtn,i.click,function(){easemobim.textarea.blur(),i.toggleClass(s.emojiWrapper,"hide"),n.isEmojiInitilized||(n.isEmojiInitilized=!0,s.emojiContainer.innerHTML=t())}),i.live("img.emoji",i.click,function(e){!i.isMobile&&easemobim.textarea.focus(),easemobim.textarea.value+=this.getAttribute("data-value"),i.trigger(easemobim.textarea,"change")},s.emojiWrapper),i.on(document,i.click,function(e){var t=window.event||e,n=t.srcElement||t.target;i.hasClass(n,"e-face")||i.addClass(s.emojiWrapper,"hide")})},errorPrompt:function(e,t){var n=this;n.ePrompt||(n.ePrompt=document.querySelector(".em-widget-error-prompt")),n.ePromptContent||(n.ePromptContent=n.ePrompt.querySelector("span")),n.ePromptContent.innerHTML=e,i.removeClass(n.ePrompt,"hide"),t||setTimeout(function(){i.addClass(n.ePrompt,"hide")},2e3)},getSafeTextValue:function(e){return i.getDataByPath(e,"ext.weichat.html_safe_body.msg")||i.getDataByPath(e,"bodies.0.msg")||""},setOffline:function(){switch(e.offDutyType){case"none":var t=e.offDutyWord||"现在是下班时间。";try{t=decodeURIComponent(t)}catch(n){}var o=new WebIM.message.txt;o.set({msg:t}),this.appendMsg(e.toUser,e.user.username,o),i.addClass(easemobim.send,"em-widget-send-disable"),easemobim.sendBtn.innerHTML="发送";break;default:easemobim.leaveMessage.show(!e.isInOfficehours)}},close:function(){this.opened=!1,e.hide||(i.addClass(easemobim.imChat,"hide"),i.removeClass(easemobim.imBtn,"hide"))},show:function(){var t=this;t.opened=!0,t.scrollBottom(50),i.addClass(easemobim.imBtn,"hide"),i.removeClass(easemobim.imChat,"hide"),e.isInOfficehours&&easemobim.textarea.offsetHeight>0&&easemobim.textarea.focus(),!i.isTop&&transfer.send({event:a.EVENTS.RECOVERY},window.transfer.to)},appendDate:function(e,t,n){var o=s.chatWrapper,a=document.createElement("div");a.innerHTML="<span>"+i.formatDate(e)+"</span>",i.addClass(a,"em-widget-date"),n?o.insertBefore(a,o.firstChild):t?(this.msgTimeSpan[t]&&e-this.msgTimeSpan[t]>6e4&&o.appendChild(a),this.resetSpan(t)):o.appendChild(a)},resetSpan:function(e){this.msgTimeSpan[e]=(new Date).getTime()},open:function(){var t=this,n={user:e.user.username,appKey:e.appKey,apiUrl:location.protocol+"//"+e.restServer};e.user.token?n.accessToken=e.user.token:n.pwd=e.user.password,t.conn.open(n),Modernizr.peerconnection&&WebIM.WebRTC&&easemobim.videoChat&&e.grayList.audioVideo&&easemobim.videoChat.init(t.conn,t.channel.sendText,e)},soundReminder:function(){if(window.HTMLAudioElement&&!i.isMobile&&e.soundReminder){var t=this,n=document.createElement("audio"),o=document.querySelector(".em-widgetHeader-audio"),a=!1,r=_.throttle(function(){n.play()},3e3,{trailing:!1});n.src=e.staticPath+"/mp3/msg.m4a",i.on(o,"click",function(){a=!a,i.toggleClass(o,"icon-slience",a),i.toggleClass(o,"icon-bell",!a)}),t.soundReminder=function(){a||!i.isMin()&&t.opened||r()}}},bindEvents:function(){function n(){var t=!easemobim.textarea.value.trim();i.toggleClass(easemobim.sendBtn,"disabled",!o.readyHandled||t),e.grayList.msgPredictEnable&&!t&&c(easemobim.textarea.value)}var o=this;i.isTop||(i.on(document.querySelector(".em-widgetHeader-min"),"click",function(){transfer.send({event:a.EVENTS.CLOSE},window.transfer.to)}),i.on(easemobim.imBtn,i.click,function(){transfer.send({event:a.EVENTS.SHOW},window.transfer.to)}),i.on(document,"mouseover",function(){transfer.send({event:a.EVENTS.RECOVERY},window.transfer.to)})),i.on(easemobim.imChatBody,"click",function(){easemobim.textarea.blur()}),i.live("img.em-widget-imgview","click",function(){easemobim.imgView.show(this.getAttribute("src"))}),e.dragenable&&!i.isTop&&(easemobim.dragBar.style.cursor="move",i.on(easemobim.dragBar,"mousedown",function(e){var t=window.event||e;return easemobim.textarea.blur(),transfer.send({event:a.EVENTS.DRAGREADY,data:{x:t.clientX,y:t.clientY}},window.transfer.to),!1},!1)),i.live("div.em-widget-msg-status",i.click,function(){var e=this.getAttribute("id").slice(0,-"_failed".length);i.addClass(this,"hide"),i.removeClass(document.getElementById(e+"_loading"),"hide"),"txt"===this.getAttribute("data-type")?o.channel.reSend("txt",e):o.conn.send(e)}),i.live("button.js_robotTransferBtn",i.click,function(){var e=this.getAttribute("data-id"),t=this.getAttribute("data-sessionid");this.clicked||(this.clicked=!0,o.channel.sendTransferToKf(e,t))}),i.live("button.js_robotbtn",i.click,function(){o.channel.sendText(this.innerText,null,{ext:{msgtype:{choice:{menuid:this.getAttribute("data-id")}}}})});var c=_.throttle(function(t){e.agentUserId&&e.visitorUserId&&r("messagePredict",{tenantId:e.tenantId,visitor_user_id:e.visitorUserId,agentId:e.agentUserId,content:t.slice(0,a.MESSAGE_PREDICT_MAX_LENGTH),timestamp:_.now()})},1e3);if(Modernizr.oninput?i.on(easemobim.textarea,"input change",n):i.on(easemobim.textarea,"keyup change",n),i.isMobile){var d=function(){easemobim.textarea.style.overflowY="auto",o.scrollBottom(800)};i.on(easemobim.textarea,"focus",d),i.one(easemobim.textarea,"touchstart",d),i.on(document.querySelector(".em-widgetHeader-keyboard"),i.click,function(){var e=i.hasClass(this,"icon-keyboard-down"),t=easemobim.send.getBoundingClientRect().height;switch(o.direction=e?"down":"up",i.toggleClass(this,"icon-keyboard-up",e),i.toggleClass(this,"icon-keyboard-down",!e),o.direction){case"up":easemobim.send.style.bottom="auto",easemobim.send.style.zIndex="3",easemobim.send.style.top="43px",easemobim.imChatBody.style.bottom="0",s.emojiWrapper.style.bottom="auto",s.emojiWrapper.style.top=43+t+"px";break;case"down":easemobim.send.style.bottom="0",easemobim.send.style.zIndex="3",easemobim.send.style.top="auto",easemobim.imChatBody.style.bottom=t+"px",s.emojiWrapper.style.bottom=t+"px",s.emojiWrapper.style.top="auto",o.scrollBottom(50)}})}i.on(s.fileInput,"change",function(){var e=s.fileInput,t=i.getDataByPath(e,"files.0.size");e.value&&(t<a.UPLOAD_FILESIZE_LIMIT?o.channel.sendFile(WebIM.utils.getFileUrl(e)):o.errorPrompt("文件大小不能超过10MB"))}),i.on(s.imgInput,"change",function(){var e=s.imgInput,t=i.getDataByPath(e,"files.0.size");e.value&&(/\.(png|jpg|jpeg|gif)$/i.test(e.value)?t>a.UPLOAD_FILESIZE_LIMIT?o.errorPrompt("文件大小不能超过10MB"):o.channel.sendImg(WebIM.utils.getFileUrl(e)):o.errorPrompt("不支持的图片格式"))}),i.on(easemobim.sendFileBtn,"click",function(){o.readyHandled?s.fileInput.click():o.errorPrompt("正在连接中...")}),i.on(easemobim.sendImgBtn,"click",function(){o.readyHandled?s.imgInput.click():o.errorPrompt("正在连接中...")}),i.on(easemobim.noteBtn,"click",function(){easemobim.leaveMessage.show()}),i.on(easemobim.textarea,"keydown",function(e){13!==e.keyCode||i.isMobile||e.ctrlKey||e.shiftKey||(e.preventDefault&&e.preventDefault(),i.trigger(easemobim.sendBtn,"click"))}),i.on(easemobim.sendBtn,"click",function(){var e=easemobim.textarea.value;t(),i.hasClass(this,"disabled")||(e.length>a.MAX_TEXT_MESSAGE_LENGTH?o.errorPrompt("输入字数过多"):(o.channel.sendText(e),easemobim.textarea.value="",i.trigger(easemobim.textarea,"change")))})},scrollBottom:function(e){var t=easemobim.imChatBody;e?(clearTimeout(this.scbT),this.scbT=setTimeout(function(){t.scrollTop=t.scrollHeight-t.offsetHeight+9999},e)):t.scrollTop=t.scrollHeight-t.offsetHeight+9999},handleEventStatus:function(t,n,o){var i=o?this.hasHumanAgentOnline:this.hasAgentOnline;i||this.noteShow||(this.noteShow=!0,this.appendEventMsg(a.eventMessageText.NOTE)),"reply"===t&&n?(e.agentUserId&&this.startToGetAgentStatus(),this.setAgentProfile({userNickname:n.userNickname,avatar:n.avatar})):"create"===t?this.appendEventMsg(a.eventMessageText.CREATE):"close"===t?this.appendEventMsg(a.eventMessageText.CLOSED):"transferd"===t?this.appendEventMsg(a.eventMessageText.TRANSFER):"transfering"===t?this.appendEventMsg(a.eventMessageText.TRANSFERING):"linked"===t&&this.appendEventMsg(a.eventMessageText.LINKED),("transferd"===t||"linked"===t)&&this.handleAgentStatusChanged(n)},handleAgentStatusChanged:function(t){t&&(e.agentUserId=t.userId,this.updateAgentStatus(),this.startToGetAgentStatus(),this.setAgentProfile({userNickname:t.agentUserNiceName,avatar:t.avatar}))},appendEventMsg:function(t){if(!e.hideStatus){var n=document.createElement("div");n.innerHTML="<span>"+t+"</span>",n.className="em-widget-event",this.appendDate((new Date).getTime()),s.chatWrapper.appendChild(n),this.scrollBottom(i.isMobile?800:null)}},appendMsg:function(t,n,o,a){var r,c=this,d=!(t&&e.user.username&&t===e.user.username),u=s.chatWrapper,l=easemobim.genDomFromMsg(o,d),m=l.querySelector(".em-widget-imgview"),p=o.value,f="string"==typeof p&&p.match(/^__demo_id_(\w{8})__$/i);if(f){
easemobim.demo;switch(f[1]){case"4aa746d1":l.innerHTML=["<h1>E级长轴轿车-专为中国市场量身打造</h1>","<h2>4月1日</h2>",'<img src="static/benz-demo/image1.png">',"<p>延续经典梅赛德斯-奔驰轿车外观，发动机罩上有三叉星徽，优雅之余不失商务气息。浅色材质彰显出优雅而独特的美感。</p>",'<div class="footer">',"	<span>阅读全文</span>",'	<span class="svg-icon-arrow-right"></span>',"</div>",'<a href="static/benz-demo/article-1.html"></a>'].join(""),l.className="msg-view",m=l.querySelector("img");break;case"daad3787":l.innerHTML=["<h1>心怀担当，人生自有为。全新梅赛德斯-奔驰GLC SUV</h1>","<h2>4月1日</h2>",'<img src="static/benz-demo/image7.png">',"<p>以圆润流线设计尽展夺目锋芒；动态操控选择控制器，五种驾驶模式掌控人生跌宕起伏。</p>",'<div class="footer">',"	<span>阅读全文</span>",'	<span class="svg-icon-arrow-right"></span>',"</div>",'<a href="static/benz-demo/article-2.html"></a>'].join(""),l.className="msg-view",m=l.querySelector("img");break;case"1d0f2ff0":r=l.querySelector(".em-widget-msg-txt"),r.innerHTML='<video src="static/benz-demo/video-1.mp4" poster="static/benz-demo/preview-1.png" style="max-width:12.25rem;"></video>',m=r.querySelector("video");break;case"db9a16fd":r=l.querySelector(".em-widget-msg-txt"),r.innerHTML='<video src="static/benz-demo/video-2.mp4" poster="static/benz-demo/preview-2.png" style="max-width:12.25rem;"></video>',m=r.querySelector("video");break;case"bc268983":case"5a6a5c07":case"b607ada9":case"407d95e4":case"8e1afa36":case"15abea83":case"33317460":case"feb5630e":case"d1fcf400":case"fc5d3559":default:throw"unknown demo id."}}a?u.insertBefore(l,u.firstChild):m?(u.appendChild(l),c.scrollBottom(i.isMobile?800:null),i.one(m,"load",function(){c.scrollBottom()})):(u.appendChild(l),c.scrollBottom(i.isMobile?800:null))},messagePrompt:function(e){if(!i.isTop){var t,n,o=this;switch(e.type){case"txt":case"list":t=e.value.replace(/\n/gm,""),n=t.length>15?t.slice(0,15)+"...":t;break;case"img":n="[图片]";break;case"file":n="[文件]";break;default:n=""}o.opened&&transfer.send({event:a.EVENTS.RECOVERY},window.transfer.to),(i.isMin()||!o.opened)&&(o.soundReminder(),transfer.send({event:a.EVENTS.SLIDE},window.transfer.to),transfer.send({event:a.EVENTS.NOTIFY,data:{avatar:this.currentAvatar,title:"新消息",brief:n}},window.transfer.to))}},receiveMsg:function(e,t,n){this.channel.handleReceive(e,t,n)}}}}(),function(){easemobim.api=function(e,t,n,o){easemobim.api[e]=easemobim.api[e]||{};var i=(new Date).getTime();easemobim.api[e][i]={success:n,error:o},easemobim.getData.send({api:e,data:t,timespan:i}).listen(function(e){if(easemobim.api[e.call]&&easemobim.api[e.call][e.timespan]){var t=easemobim.api[e.call][e.timespan];delete easemobim.api[e.call][e.timespan],0!==e.status?"function"==typeof t.error&&t.error(e):"function"==typeof t.success&&t.success(e)}},["api"])}}(),function(e,t,n,o){function i(t,n){transfer.send({event:o.EVENTS.REQUIRE_URL},window.transfer.to),g&&easemobim.api("reportEvent",{type:"VISIT_URL",url:g,userId:{type:t,id:n}},function(t){var n=t.data;switch(n&&n.type){case"OK":break;case"INIT_CALL":u()&&(n.userName&&(f=n.orgName+"#"+n.appName+"_"+n.userName,l.stop(),l=new e(function(){i("VISITOR",f)},h)),d(),m(n))}})}function a(){f&&n("deleteEvent",{userId:f})}function r(e,n){m||(m=n),p||(p=e),t.isTop||(transfer.send({event:o.EVENTS.REQUIRE_URL},window.transfer.to),p?l?l.start():p.user.username?c(p.user.username):s():console.log("not config yet."))}function s(){var n=p.guestId||t.uuid();transfer.send({event:o.EVENTS.SET_ITEM,data:{key:"guestId",value:n}},window.transfer.to),l=new e(function(){i("GUEST",n)},h),l.start()}function c(t){n("getRelevanceList",{tenantId:p.tenantId},function(o){if(!o.data.length)throw"未创建关联";var a=p.appKey.split("#"),r=o.data[0],s=a[0]||r.orgName,c=a[1]||r.appName,d=r.imServiceNumber;p.restServer=p.restServer||r.restDomain;var u=p.restServer?p.restServer.match(/vip\d/):"";u=u&&u.length?"-"+u[0]:"",p.xmppServer=p.xmppServer||"im-api"+u+".easemob.com",f=s+"#"+c+"_"+t,l=new e(function(){i("VISITOR",f)},h),n("getCurrentServiceSession",{tenantId:p.tenantId,orgName:s,appName:c,imServiceNumber:d,id:t},function(e){e.data||l.start()})})}function d(){l&&l.stop(),a()}function u(){return l&&l.isStarted}var l,m,p,f,g,h=5e3;easemobim.eventCollector={startToReport:r,stopReporting:d,isStarted:u,updateURL:function(e){g=e}}}(easemobim.Polling,easemobim.utils,easemobim.api,easemobim._const),function(e,t){"use strict";function n(){if(s.isTop){var t=s.query("tenantId");r={};try{r=JSON.parse(s.code.decode(s.getStore("emconfig"+t)))}catch(n){}r.tenantId=t,r.hide=!0,r.offDutyType=s.query("offDutyType"),r.grUserId=s.query("grUserId"),r.to=s.convertFalse(s.query("to")),r.xmppServer=s.convertFalse(s.query("xmppServer")),r.restServer=s.convertFalse(s.query("restServer")),r.agentName=s.convertFalse(s.query("agentName")),r.resources=s.convertFalse(s.query("resources")),r.hideStatus=s.convertFalse(s.query("hideStatus")),r.satisfaction=s.convertFalse(s.query("sat")),r.wechatAuth=s.convertFalse(s.query("wechatAuth")),r.hideKeyboard=s.convertFalse(s.query("hideKeyboard")),r.appKey=s.convertFalse(decodeURIComponent(s.query("appKey"))),r.domain=r.domain||"//"+location.host,r.offDutyWord=decodeURIComponent(s.query("offDutyWord")),r.language=s.query("language")||"zh_CN",r.ticket=""===s.query("ticket")?!0:s.convertFalse(s.query("ticket")),r.liveVideoInvite=!!s.convertFalse(s.query("liveVideoInvite"));var d;try{d=JSON.parse(decodeURIComponent(s.code.decode(s.query("ext"))))}catch(n){}d&&(r.visitor=d.visitor,r.ext=d.ext);try{r.emgroup=decodeURIComponent(s.query("emgroup"))}catch(n){r.emgroup=s.query("emgroup")}r.user=r.user||{};var m=s.query("user"),p=s.get("root"+r.tenantId+r.emgroup),f=r.user.username;m&&m===f||(m?r.user={username:m}:p?(r.user={username:p},r.isUsernameFromCookie=!0):r.user={}),r.hideStatus=!0,a=easemobim.chat(r),i(r,o)}else e.transfer=new easemobim.Transfer(null,"main").listen(function(t){switch(t.event){case c.EVENTS.SHOW:u.isStarted()?(u.stopReporting(),l.init(r),l.open()):l.open();break;case c.EVENTS.CLOSE:l.close();break;case c.EVENTS.EXT:a.channel.sendText("",!1,t.data.ext);break;case c.EVENTS.TEXTMSG:a.channel.sendText(t.data.data,!1,t.data.ext);break;case c.EVENTS.UPDATE_URL:easemobim.eventCollector.updateURL(t.data);break;case c.EVENTS.INIT_CONFIG:t.data.hideStatus=!0,a=easemobim.chat(t.data),e.transfer.to=t.data.parentId,i(t.data,o),r=t.data}},["easemob"])}function o(e){e.base=location.protocol+e.domain,easemobim.leaveMessage=easemobim.leaveMessage(a,e.tenantId),easemobim.paste(a).init(),easemobim.satisfaction(a),e.eventCollector&&!u.isStarted()?(u.startToReport(e,function(t){l.init(e,t)}),s.one(easemobim.imBtn,"click",function(){l.init(e),l.open()})):l.init(e)}function i(t,n){var o=document.getElementById("cross-origin-iframe");o.src=t.domain+"/webim/transfer.html?v=benz.43.15.15",s.on(o,"load",function(){easemobim.getData=new easemobim.Transfer("cross-origin-iframe","data"),n(t)}),s.toggleClass(document.getElementById("em-widgetPopBar"),"hide",s.isTop||!t.minimum||t.hide),s.toggleClass(document.getElementById("em-kefu-webim-chat"),"hide",!(s.isTop||!t.minimum)),document.querySelector(".em-widget-pop-bar").innerText=t.buttonText,s.isMobile&&s.addClass(document.body,"em-mobile"),s.toggleClass(document.querySelector(".em-widgetHeader-min"),"hide",!t.minimum||s.isTop),s.toggleClass(document.querySelector(".em-widget-img"),"hide",!WebIM.utils.isCanUploadFileAsync),s.toggleClass(document.querySelector(".em-widgetHeader-audio"),"hide",!e.HTMLAudioElement||s.isMobile||!t.soundReminder),s.toggleClass(document.querySelector(".em-widgetHeader-keyboard"),"hide",!s.isMobile||t.hideKeyboard),t.liveVideoInvite&&(s.removeClass(document.querySelector(".live-video-wait"),"hide"),s.on(document.querySelector(".live-video-wait .back-btn"),"click",function(){history.back()}))}var a,r,s=easemobim.utils,c=easemobim._const,d=easemobim.api,u=easemobim.eventCollector;n();var l={init:function(t,n){var o=this;t.toUser=t.toUser||t.to,t.orgName=t.appKey.split("#")[0],t.appName=t.appKey.split("#")[1],d("getRelevanceList",{tenantId:t.tenantId},function(i){if(0===i.data.length)return void a.errorPrompt("未创建关联",!0);t.relevanceList=i.data,t.tenantAvatar=s.getAvatarsFullPath(i.data[0].tenantAvatar,t.domain),t.defaultAvatar=t.staticPath?t.staticPath+"/img/default_avatar.png":"static/img/default_avatar.png",t.defaultAgentName=i.data[0].tenantName,t.logo=t.logo||i.data[0].tenantLogo,t.toUser=t.toUser||i.data[0].imServiceNumber,t.orgName=t.orgName||i.data[0].orgName,t.appName=t.appName||i.data[0].appName,t.channelid=t.channelid||i.data[0].channelId,t.appKey=t.appKey||t.orgName+"#"+t.appName,t.restServer=t.restServer||i.data[0].restDomain;var r=t.restServer?t.restServer.match(/vip\d/):"";r=r&&r.length?"-"+r[0]:"",t.xmppServer=t.xmppServer||"im-api"+r+".easemob.com",a.init(),n?(t.toUser=n.agentImName,n.userName?(t.user={username:n.userName,password:n.userPassword},a.cachedCommandMessage={ext:{weichat:{agentUsername:n.agentUserName}}},a.ready(),a.show(),transfer.send({event:c.EVENTS.SHOW},e.transfer.to),transfer.send({event:c.EVENTS.CACHEUSER,data:{username:n.userName,group:t.user.emgroup}},e.transfer.to)):d("getPassword",{userId:t.user.username,tenantId:t.tenantId},function(o){var i=o.data;i?(t.user.password=i,a.cachedCommandMessage={ext:{weichat:{agentUsername:n.agentUserName}}},a.ready(),a.show(),transfer.send({event:c.EVENTS.SHOW},e.transfer.to)):console.warn("用户不存在！")})):t.user.username&&(t.user.password||t.user.token)?a.ready():t.wechatAuth?easemobim.wechat(function(e){try{e=JSON.parse(e)}catch(n){e=null}if(e){t.visitor=t.visitor||{},t.visitor.userNickname=e.nickname;var i=t.tenantId+"_"+t.orgName+"_"+t.appName+"_"+t.toUser+"_"+e.openid;easemobim.emajax({url:"/v1/webimplugin/visitors/wechat/"+i+"?tenantId="+t.tenantId,data:{orgName:t.orgName,appName:t.appName,imServiceNumber:t.toUser},type:"POST",success:function(e){try{e=JSON.parse(e)}catch(n){e=null}e&&"OK"===e.status?(t.user.username=e.entity.userId,t.user.password=e.entity.userPassword,a.ready()):o.go(t)},error:function(e){o.go(t)}})}else o.go(t)}):t.user.username?d("getPassword",{userId:t.user.username,tenantId:t.tenantId},function(e){e.data?(t.user.password=e.data,a.ready()):o.go(t)}):o.go(t)})},go:function(t){d("createVisitor",{orgName:t.orgName,appName:t.appName,imServiceNumber:t.toUser,tenantId:t.tenantId},function(n){t.isNewUser=!0,t.user.username=n.data.userId,t.user.password=n.data.userPassword,s.isTop?s.set("root"+t.tenantId+t.emgroup,t.user.username):transfer.send({event:c.EVENTS.CACHEUSER,data:{username:t.user.username,group:t.user.emgroup}},e.transfer.to),a.ready()})},open:function(){a.show()},close:function(){a.close()}};easemobim.reCreateImUser=_.once(function(){d("createVisitor",{orgName:r.orgName,appName:r.appName,imServiceNumber:r.toUser,tenantId:r.tenantId},function(t){r.isNewUser=!0,r.user.username=t.data.userId,r.user.password=t.data.userPassword,s.isTop?s.set("root"+r.tenantId+r.emgroup,r.user.username):transfer.send({event:c.EVENTS.CACHEUSER,data:{username:r.user.username,group:r.user.emgroup}},e.transfer.to),a.open()})})}(window,void 0);