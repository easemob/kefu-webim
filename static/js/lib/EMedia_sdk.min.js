!function(e){function t(s){if(n[s])return n[s].exports;var o=n[s]={exports:{},id:s,loaded:!1};return e[s].call(o.exports,o,o.exports,t),o.loaded=!0,o.exports}var n={};t.m=e,t.c=n,t.p="./",t(0)}([function(e,t,n){e.exports=n(3)},,,function(e,t,n){var s,o,r;(function(e){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=n(5);window.emedia=window.emedia||{},emedia.util=c,emedia.config=function(e){e=c.extend({},e);for(var t in e)emedia.config[t]=e[t],"logLevel"===t&&(emedia.LOG_LEVEL=e[t])},emedia.config({autoSub:!0,onlyEnter:!1,reconnect:13,reconnectDelay:3e3,getCopyIntervalMillis:17e3,checkConnectIntervalMillis:1e3,iceRebuildCount:3,iceRebuildIntervalMillis:500,enterTimeout:2e4});var a=n(6),d=n(8);emedia.Service=a,emedia.event=d,function(n,c){"object"===i(e)&&"object"===i(e.exports)?e.exports=c():(o=[],void 0!==(r="function"==typeof(s=c)?s.apply(t,o):s)&&(e.exports=r))}(0,function(){return emedia}),/Chrome/.test(navigator.userAgent)&&(emedia.supportPRAnswer=navigator.userAgent.split("Chrome/")[1].split(".")[0]>=50),emedia.LOG_LEVEL=0,emedia.isWebRTC=(/Firefox/.test(navigator.userAgent)||/WebKit/.test(navigator.userAgent))&&/^https\:$/.test(window.location.protocol),emedia.isFirefox=/Firefox/.test(navigator.userAgent),emedia.isChrome=/Chrome/.test(navigator.userAgent),emedia.isSafari=!/Chrome/.test(navigator.userAgent)&&/Safari/.test(navigator.userAgent),emedia.config({baseAcptOps:[107,300,302,303,304,301,204,206,400,401,1001,100201,100202,100203]}),emedia.config({clientType:"WEB",version:"1.1.2",userAgent:navigator.userAgent,acptOps:[]})}).call(t,n(4)(e))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,t){"use strict";function n(){}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var s,o=e,r=[];if(n=n||o.length,t)for(s=0;s<t;s++)r[s]=o[0|Math.random()*n];else{var i;for(r[8]=r[13]=r[18]=r[23]="-",r[14]="4",s=0;s<36;s++)r[s]||(i=0|16*Math.random(),r[s]=o[19==s?3&i|8:i])}return r.join("")},Math.uuidFast=function(){for(var t,n=e,s=new Array(36),o=0,r=0;r<36;r++)8==r||13==r||18==r||23==r?s[r]="-":14==r?s[r]="4":(o<=2&&(o=33554432+16777216*Math.random()|0),t=15&o,o>>=4,s[r]=n[19==r?3&t|8:t]);return s.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}}();var o=function(e){function t(t,s){if(!(emedia&&emedia.LOG_LEVEL&&t<emedia.LOG_LEVEL)){var o=[];o.push(t),o.push(e||"");for(var r=0;r<s.length;r++)o.push(s[r]);n.log.apply(n,o)}}var n=this,s={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,FATAL:5},o=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"];this.log=function(){var e=arguments[0];e=arguments[0]=o[e],console.log.apply(console,arguments)},this.trace=function(){this.log&&t(s.TRACE,arguments)},this.debug=function(){this.log&&t(s.DEBUG,arguments)},this.info=function(){this.log&&t(s.INFO,arguments)},this.warn=function(){this.log&&t(s.WARN,arguments)},this.error=function(){this.log&&t(s.ERROR,arguments)},this.fatal=function(){this.log&&t(s.FATAL,arguments)}};n.prototype.logger=new o,n.prototype.tagLogger=function(e){return new o(e)},n.prototype.parseJSON=function(e){return JSON.parse(e)};n.prototype.stringifyJSON=function(e){return JSON.stringify(e)};var r={},i=r.toString,c=r.hasOwnProperty,a=c.toString,d=a.call(Object);n.prototype.isPlainObject=function(e){var t,n;return!(!e||"[object Object]"!==i.call(e))&&(!(t=Object.getPrototypeOf(e))||"function"==typeof(n=c.call(t,"constructor")&&t.constructor)&&a.call(n)===d)};n.prototype.isArray=Array.isArray,n.prototype.isEmptyObject=function(e){var t;for(t in e)return!1;return!0},n.prototype.type=function(e){return null==e?e+"":"object"===(void 0===e?"undefined":s(e))||"function"==typeof e?r[i.call(e)]||"object":void 0===e?"undefined":s(e)},n.prototype.extend=function(){var e,t,n,o,r,i,c=this,a=arguments[0]||{},d=1,u=arguments.length,f=!1;for("boolean"==typeof a&&(f=a,a=arguments[d]||{},d++),"object"===(void 0===a?"undefined":s(a))||c.isFunction(a)||(a={}),d===u&&(a=this,d--);d<u;d++)if(null!=(e=arguments[d]))for(t in e)n=a[t],a!==(o=e[t])&&(f&&o&&(c.isPlainObject(o)||(r=c.isArray(o)))?(r?(r=!1,i=n&&c.isArray(n)?n:[]):i=n&&c.isPlainObject(n)?n:{},a[t]=c.extend(f,i,o)):void 0!==o&&(a[t]=o));return a},n.prototype.removeAttribute=function(e,t){var n=e[t];return delete e[t],n},n.prototype.prototypeExtend=n.prototype.classExtend=function(){function e(){for(var e=0;e<arguments.length;e++){var n=arguments[e]||{};t.extend(!0,this,n)}this.__init__&&this.__init__()}for(var t=this,n=0;n<arguments.length;n++){var s=arguments[n]||{};"function"==typeof s&&(s=s.prototype),t.extend(!0,e.prototype,s)}return e.extend||(e.extend=function(n){return t.prototypeExtend(e,n)}),e},n.prototype.hasLocalStorage=function(e){return null!=localStorage.getItem(e)&&"{}"!=localStorage.getItem(e)},n.prototype.toggleClass=function(e,t){e.hasClass(t)?e.removeClass(t):e.addClass(t)},n.prototype.setCookie=function(e,t,n){var s=new Date;s.setTime(s.getTime()+60*n*60*1e3),document.cookie=e+"="+escape(t)+";expires="+s.toGMTString()},n.prototype.getCookie=function(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null},n.prototype.parseURL=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null},n.prototype.forEach=function(e,t){if(e&&!this.isEmptyObject(e)){e=e||{};var n=this.extend(!1,{},e);for(var s in n)t(s,e[s])}},e.exports=new n},function(e,t,n){"use strict";var s=n(5),o=s.tagLogger("Service"),r=n(7),i=n(9),c=n(8),a=n(13),d=new(n(14))({onExtLoaded:function(){o.info("Share desktop ext. had loaded.")}}),u=n(12);e.exports=s.prototypeExtend({__init__:function(){var e=this,t=s.parseURL("__log_level___");t&&(emedia.LOG_LEVEL=parseInt(t)),e.namespace=Math.uuidFast(),window.__easemob_current_mservice=this},AVPubstream:u.extend({__init__:function(){var e=this;e.type=0,e._located=!0,e.constaints&&(e.constaints.video||(e.voff=1),e.constaints.audio||(e.aoff=1)),e.constaints||(e.constaints={audio:!0,video:!0})}}),ShareDesktopPubstream:u.extend({__init__:function(){var e=this;e.type=1,e._located=!0}}),__assertCurrent:function(){var e=this;if(!e.current)throw"Please call emedia.service.setup(ticket)";if(e.current.closed)throw"current closed"},openUserMedia:function(e){var t=this;if(!e)throw"require pubS";return{then:function(n,s){if(e instanceof t.AVPubstream)t._openCamera(e,n,s);else{if(!(e instanceof t.ShareDesktopPubstream))throw"Unspported pubS";t._openSharedDesktop(e,n,s)}}}},_openSharedDesktop:function(e,t,n){var s=this;d.openDesktopMedia(null,function(r){if(r instanceof c.OpenDesktopMedia){var i=r.desktopStreamId;o.warn("desktop streamId",i);var a={audio:!1,video:{mandatory:e.mandatory||{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxWidth:window.screen.width>1920?window.screen.width:1920,maxHeight:window.screen.height>1080?window.screen.height:1080},optional:[]}};delete e.mandatory,s.__getUserMedia(a,function(n,o){e.localStream=o,t&&t(s.current,o)},n)}else s.current&&s.current.onEvent(new c.ShareDesktopExtensionNotFound({member:s.current})),n&&n(r)})},_openCamera:function(e,t,n){var s=this,o=e.constaints||{audio:!0,video:!0};s.__getUserMedia(o,function(n,o){s.__controlStream(e,o),e.localStream=o,t&&t(s.current,o)},n)},__controlStream:function(e,t){t&&t.getVideoTracks().forEach(function(t){t.enabled=!e.voff}),t&&t.getAudioTracks().forEach(function(t){t.enabled=!e.aoff})},__getUserMedia:function(e,t,n){var s,r=this;navigator.mediaDevices.getUserMedia(e).then(function(e){s=e;var n=e.getVideoTracks(),i=e.getAudioTracks();n.length>0&&o.debug("Using video device: "+n[0].label),i.length>0&&o.debug("Using audio device: "+i[0].label),t&&t(r.current,e)}).catch(function(e){o.debug("[WebRTC-API] getUserMedia() error: ",e),s&&s.getTracks().forEach(function(e){e.stop()}),r.current&&r.current.onEvent(new c.OpenMediaError({member:r.current,event:e})),n&&n(new c.OpenMediaError({member:r.current,event:e}))})},setup:function(e,t){var n=this;o.debug("recv ticket",e,t);var r=t=t||{};if(s.isPlainObject(t))t=JSON.stringify(t);else try{r=JSON.parse(t)}catch(e){}"string"==typeof e&&(e=JSON.parse(e));var d=e.memName;if(n.current&&!n.current.closed){var u=new c.CurrentCalling;throw n.current.onEvent(u),u}var f=i.extend(a);return n.current=new f({autoSub:emedia.config.autoSub,getCopyIntervalMillis:emedia.config.getCopyIntervalMillis,sysUserId:d,resource:n.resource,nickName:n.nickName,ticket:e,ext:t,extObj:r,sessionFactory:function(){return n.newSession(this,e)}},n.listeners||{})},exit:function(e){this.current&&this.current.exit(e)},join:function(e,t){o.debug("begin join ...");var n=this;n.__assertCurrent(),n.current._session._sessionId=void 0,n.current.join(e,t)},withpublish:function(e){var t=this;if(!e||!e.localStream)throw"pubS null or stream not open";return t.__assertCurrent(),t.current._session._sessionId=void 0,t.current.withpublish(e)},push:function(e,t,n){o.debug("begin push ...");var s=this;if(2===arguments.length&&(n=t,t=void 0),!e||!e.localStream)throw"pubS or stream open";s.__assertCurrent(),s.current.push(e,t,n,!1)},subscribe:function(e,t,n,o){var r=this;r.__assertCurrent(),2==arguments.length&&(n=t,t=void 0),t&&s.isPlainObject(t)&&(o=t,t=void 0),n&&s.isPlainObject(n)&&(o=n,n=void 0),o||(o={subSVideo:!0,subSAudio:!0});var i=r.current._getWebrtc(e);i&&i.isConnected()&&!emedia.isSafari?r.current.subscribeStream(i._rtcId,e,n,o):(i&&r.current.closeWebrtc(i.getRtcId(),!0,!1),r.current.createWebrtcAndSubscribeStream(e,{onGotRemote:function(e){t&&t(e)},onEvent:function(e){n&&n(e)}},void 0,o))},closePubstream:function(e){e.located()&&(e._localMediaStream&&e._localMediaStream.getTracks().forEach(function(e){e.stop()}),e.localStream&&e.localStream.getTracks().forEach(function(e){e.stop()}))},hungup:function(e){var t=this;t.__assertCurrent();var n=t.current,s=n._cacheStreams[e],o=s.rtcId;if(o&&(n.closeWebrtc(o),s.located()&&(1!==s.type&&s._localMediaStream&&s._localMediaStream.getTracks().forEach(function(e){e.stop()}),n._cacheStreams[e]&&n.onRemoveStream(s),delete n._cacheStreams[e])),s&&!s.located()){n._linkedStreams[s.id]&&delete n._linkedStreams[s.id];var r=new u(s);r.rtcId=void 0,r._webrtc=void 0,r.mediaStream=null,n.onUpdateStream(r,new r.Update(r))}},freezeFrameRemote:function(e,t,n){var s=this;s.__assertCurrent();var o=s.current,r=o._linkedStreams[e];if(!r||r.located())throw e+" not exsits or locate, not connect";var i=!r.freezeFrame,a={op2:20,streamId:e,frz:i?1:0},d=o.newMessage({op:1002,memId:r.owner.id,arg:JSON.stringify(a),_reqOps:[100204]});r.freezeFrame=i,o.postMessage(d,function(e){if(0!=e.result){var s=new c.RemoteControlFail({stream:r,failed:e.result,cause:e.msg});return o.onEvent(s),r.freezeFrame=!r.freezeFrame,void(n&&n(s,r.freezeFrame))}t&&t(r.freezeFrame)})},capturePictureRemote:function(e,t,n,s){var o=this;o.__assertCurrent();var r=o.current,i=r._linkedStreams[e];if(!i||i.located())throw e+" not exsits or locate, not connect";var a={op2:20,streamId:e,pic:1,rspBase64Pic:!0};t&&(a.rspBase64Pic=!0);var d=r.newMessage({op:1002,memId:i.owner.id,arg:JSON.stringify(a),_reqOps:[100205]});r.postMessage(d,function(e){if(0!=e.result){var o=new c.RemoteControlFail({stream:i,failed:e.result,cause:e.msg});return r.onEvent(o),void(s&&s(o))}if(t)if(e.arg){var a=JSON.parse(e.arg);n&&n(a.pic)}else s&&s(new c.RemoteControlFail({stream:i,failed:e.result,cause:"Not found base64 pic"}));else n&&n()})},zoomRemote:function(e,t,n){var s=this;s.__assertCurrent();var o=s.current,r=o._linkedStreams[e];if(!r||r.located())throw e+" not exsits or locate, not connect";r._zoom||(r._zoom=1);var i=r._zoom*t;if(!(i<1)){r._zoom=i;var a={op2:20,streamId:e,zoom:Math.round(1e4*i)},d=o.newMessage({op:1002,memId:r.owner.id,arg:JSON.stringify(a),_reqOps:[100201]});o.postMessage(d,function(e){if(0!=e.result){var t=new c.RemoteControlFail({stream:r,failed:e.result,cause:e.msg});return o.onEvent(t),void(n&&n(t))}})}},_getPosition:function(e){for(var t=0,n=0;e;)n+=e.offsetLeft,t+=e.offsetTop,e=e.offsetParent;return{clientX:n,clientY:t}},focusExpoRemote:function(e,t,n,s){var r=this,i=n||window.event,c=document.documentElement.scrollLeft||document.body.scrollLeft,a=document.documentElement.scrollTop||document.body.scrollTop,d=i.pageX||i.clientX+c,u=i.pageY||i.clientY+a,f=r._getPosition(t);o.info("Video tag position ",f.clientX,":",f.clientY);var l=t.videoWidth,m=t.videoHeight;if(m>l){p=l/m;l=(m=t.offsetHeight)*p,f.clientX+=(t.offsetWidth-l)/2}else{var p=m/l;m=(l=t.offsetWidth)*p,f.clientY+=(t.offsetHeight-m)/2}o.info("Media position ",f.clientX,":",f.clientY),o.info("Media xy ",l,":",m),o.info("Click position ",d,":",u),r._focusExpo(e,l,m,d-f.clientX,u-f.clientY,s)},_focusExpo:function(e,t,n,s,o,r){var i=this;if(!(s<=0||s>t||o<=0||o>n)){i.__assertCurrent();var a=i.current,d=a._linkedStreams[e];if(!d||d.located())throw e+" not exsits or locate, not connect";var u={op2:20,streamId:e,focus:1,expo:1,x:0===t?0:Math.round(1e4*s/t),y:0===n?0:Math.round(1e4*o/n)},f=a.newMessage({op:1002,memId:d.owner.id,arg:JSON.stringify(u),_reqOps:[100202,100203]});a.postMessage(f,function(e){if(0!=e.result){var t=new c.RemoteControlFail({stream:d,failed:e.result,cause:e.msg});return a.onEvent(t),void(r&&r(t))}})}},_republish:function(e,t,n){var s,o=this;if(e.id){var r=o.current.__getWebrtcFor(e.id);r&&o.current.closeWebrtc(r,!0),s=o.current._getWebrtc(e.id)}e._localMediaStream&&e._localMediaStream.getTracks().forEach(function(e){e.stop()}),setTimeout(function(){var r=new o.AVPubstream(e);o.openUserMedia(r).then(function(){e.localStream=r.localStream,e.isRepublished=!0,e.optimalVideoCodecs=e.optimalVideoCodecs||s&&s.optimalVideoCodecs,o.push(e,t,n)},n)},500)},voff:function(e,t,n){function s(){e.getMediaStream()&&e.getMediaStream().getVideoTracks().forEach(function(e){e.enabled=!t}),o.current&&o.current.voff(e,t)}var o=this;if(t=t?1:0,e.voff=t,e.constaints&&!e.constaints.video)return e.constaints.video=!0,void o._republish(e,function(){s()},function(t){t instanceof emedia.event.OpenMediaError&&(e.constaints.video=!1),n&&n(t)});s()},aoff:function(e,t,n){function s(){e.getMediaStream()&&e.getMediaStream().getAudioTracks().forEach(function(e){e.enabled=!t}),o.current&&o.current.aoff(e,t)}var o=this;if(t=t?1:0,e.aoff=t,e.constaints&&!e.constaints.audio)return e.constaints.audio=!0,void o._republish(e,function(){s()},function(t){t instanceof emedia.event.OpenMediaError&&(e.constaints.audio=!1),n&&n(t)});s()},iceing:function(e){var t=this;return s.isPlainObject(t.current._linkedStreams[e])},recording:function(e){var t=this;return s.isPlainObject(t.current._records[e])},startRecord:function(e,t){var n=this,s=n.current._linkedStreams[e];if(!s)throw e+" not at linked streams";s._webrtc||t&&t(!1),n.current.startRecord(s,t)},stopRecord:function(e,t){var n=this,s=n.current._records[e];if(!s)throw e+" not at recording streams";n.current.stopRecord(s,t)},getCurrentMembers:function(){return this.current.getCurrentMembers()},newSession:function(e,t){return new r({ticket:t,owner:e,onTcklC:function(t){e.onTcklC(t.rtcId,t.cands)},onAcptC:function(t){e.onAcptC(t.rtcId,t.sdp,t.cands)},onAnsC:function(t){e.onAnsC(t.rtcId,t.sdp,t.cands)},onTermC:function(t){o.info("Server termc rtc: ",t.rtcId,t.message||t.msg),21===t.endReason||22===t.endReason?s.forEach(e._cacheStreams,function(n,s){if(s.rtcId===t.rtcId){var o;o=21===t.endReason?new emedia.event.SwitchVCodes({stream:s,useVCodes:t.useVCodes}):new emedia.event.SubFailNotSupportVCodes({stream:s}),e.onEvent(o)}}):e.closeWebrtc(t.rtcId,!1,!0)},onEnter:function(t){e.onEnter(t.cver,t.mem)},onExit:function(t){e.onExit(t.cver,t.memId,t.reason)},onPub:function(t){e.onPub(t.cver,t.memId,t.pubS)},onUnpub:function(t){e.onUnpub(t.cver,t.memId,t.pubSId)},onMems:function(e){},onClose:function(t){e.onClose(t.cver,t.confrId)},onEvent:function(t){e.onEvent(t)},onStreamControl:function(t){e.onStreamControl(t.cver,t.streamId,t.voff,t.aoff)},onRemoteControl:function(t){o.error("Web not support remote control");var n=e.newMessage({op:1001,tsxId:t.tsxId,memId:t.memId,arg:t.arg,result:-507,msg:"Web not support the remote control."});e.postMessage(n,function(e){o.error("Send remote control response. the result = ",e.result,e.msg||"")})}})}})},function(e,t,n){"use strict";function s(e,t,n){function s(e,s){try{a.onWebsocketEvent(new c.WSClose({url:a.thisWsUri,retry:n,online:a.online,cause:e,event:s,session:a}))}finally{t&&t(new c.WSClose({url:a.thisWsUri,retry:n,online:a.online,cause:e,event:s,session:a}))}}function o(e){if(a.connected(a.thisWsUri)){if(r.isPlainObject(e)&&!(e instanceof d))throw"message not a Messages";a.sessId&&e.sessId!=a.sessId?i.info("self.sessId && message.sessId != self.sessId",e):(a.thisWsUri===a._websocket.url&&a._websocket.send(JSON.stringify(e)),a.thisWsUri===a._websocket.url&&i.info("Done send: req:",e,a._websocket.url),a.thisWsUri===a._websocket.url||i.info("Donot send(url not equal): req:",e,a._websocket.url))}else i.debug("current dont connect. the message = ",e)}var a=this;if(a.connected(a.thisWsUri))return e&&e(a),i.info("Session connected. dont continue connect"),void(a.notifyNewMessage&&a.notifyNewMessage());if(a.online){a.notifyNewMessage=function(){if(a.connected(a.thisWsUri)){if(0===a._bufferedMessages.length)return;for(var e,t=[];e=a._bufferedMessages.shift();)if(e.sessId||a.sessId||200==e.op){if(200===e.op){o(e);break}a.sessId&&!e.sessId&&(e.sessId=a.sessId);var s=o(e);s&&t.push(s)}else t.push(e);t.length>0&&Array.prototype.push.apply(a._bufferedMessages,t)}else if(0!==n&&a.online){if(!a.connected()){c=r.extend(!1,{},a._callbacks);for(var i in c)102!==(u=c[i]).op&&105!==u.op&&1e3!==u.op||a.onMessage({op:1001,tsxId:i,result:-9527,msg:"websocket disconnect",retrying:!0})}}else{var c=r.extend(!1,{},a._callbacks),d=[];for(var i in c){var u=c[i];!(n>0)||a.online||107!==u.op&&201!==u.op&&204!==u.op&&206!==u.op&&400!==u.op&&500!==u.op?a.onMessage({op:1001,tsxId:i,result:-9527,msg:"sdk rsp fail. retry fail or online = "+a.online}):d.push(u)}a._bufferedMessages=a._bufferedMessages||[],d.length>0&&Array.prototype.push.apply(a._bufferedMessages,d)}},i.info("Session begin connect.");var u=a._websocket;u&&(i.warn("will close. websocket state",u.readyState,u.url,a.thisWsUri),u.close(1e3));try{i.warn("Connecting",a.thisWsUri,n),u=a._websocket=new WebSocket(a.thisWsUri)}catch(e){return i.error(e),void s(e)}u.onopen=function(n){var s=this.url;if(s===a.thisWsUri)try{i.info("websocket connected:",s),t&&(t=null),e&&e(a),a.onWebsocketEvent(new c.WSConnected({event:n,session:a}))}finally{}else i.error("ignore the onopen. caused by websocket url not ",a.thisWsUri,s)},u.onmessage=function(e){var t=this.url;if(t===a.thisWsUri){i.debug("recv data",e.data);var n=JSON.parse(e.data);n&&1001==n.op&&i.debug("recv message: rsp:",n),n&&1001!=n.op&&i.info("recv message: evt:",n),a.onMessage(n)}else i.error("ignore recv data. caused by websocket url not ",a.thisWsUri,t,e.data)},u.onclose=function(e){var t=this.url;i.info("Disconnected:",t,a.thisWsUri,e),t===a.thisWsUri?(a.notifyNewMessage(),1e3!==e.code&&s(void 0,e)):i.error("ignore onclose. caused by websocket url not ",a.thisWsUri,t)},u.onerror=function(e){i.info("On error:",e),a.onWebsocketEvent(new c.WSError({event:e,online:a.online,session:a,url:this.url}))}}else s()}var o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=n(5),i=r.tagLogger("Sess"),c=n(8),a=0,d=r.prototypeExtend({setSessId:function(e){return e&&(this.sessId=e),this},setOp:function(e){return e&&(this.op=e),200===e&&(this.res={type:emedia.config.clientType,ver:emedia.config.version,agent:emedia.config.userAgent,ops:emedia.config.acptOps}),this},setTsxId:function(e){return e&&(this.tsxId=e),this},setTicket:function(e){return e&&(this.tkt=e),this},setSdp:function(e){return e&&(this.sdp=e),this},setCands:function(e){return e&&(this.cands=e),this},setSubSId:function(e){return e&&(this.subSId=e),this},setPubS:function(e){e&&(this.pubS=r.extend(!1,{},e));var t=this.pubS;return t.ext&&r.isPlainObject(t.ext)&&(t.ext=JSON.stringify(t.ext)),t&&r.forEach(t,function(e,n){(r.isPlainObject(n)||"function"==typeof n)&&r.removeAttribute(t,e)}),t&&r.removeAttribute(t,"localStream"),t&&r.removeAttribute(t,"_localMediaStream"),t&&r.removeAttribute(t,"_webrtc"),this},setRtcId:function(e){return e&&(this.rtcId=e),this},setCver:function(e){return e&&(this.cver=e),this},setEndReason:function(e){return e&&(this.endReason=e),this},setNickName:function(e){return e&&(this.nickName=e),this},setResource:function(e){return e&&(this.resource=e),this},setReason:function(e){return e&&(this.reason=e),this},setConfrId:function(e){return e&&(this.confrId=e),this},setVoff:function(e){return void 0===e||(this.voff=e?1:0),this},setAoff:function(e){return void 0===e||(this.aoff=e?1:0),this},setFlag:function(e){return 0===e&&(this.flag=0),1===e&&(this.flag=1),this},setExt:function(e){return e&&r.isPlainObject(e)&&(e=JSON.stringify(e)),e&&(this.ext=e),this}});window.__session_globalCount=0,e.exports=r.prototypeExtend({_events:{0:"onReqP2P",1:"onNewCfr",2:"onDelCfr",3:"onReqTkt",100:"onPing",101:"onPong",102:"onInitC",103:"onReqC",104:"onAcptC",105:"onTcklC",106:"onAnsC",107:"onTermC",300:"onEnter",301:"onExit",302:"onPub",303:"onUnpub",304:"onMems",204:"onClose",400:"onStreamControl",401:"onJoin",1002:"onRemoteControl"},__init__:function(){var e=this;e._bufferedMessages=[],e._callbacks={},navigator.onLine?e.online=!0:e.online=!1,window.addEventListener("online",function(t){e.online=!0,i.warn("online online online"),e.closed||e._reconnect(emedia.config.reconnect)},!0),window.addEventListener("offline",function(t){e.online=!1,i.warn("offline offline offline"),e.__checkConnectIntervalId&&clearTimeout(e.__checkConnectIntervalId),e.__retryConnectIntervalId&&clearTimeout(e.__retryConnectIntervalId),e.__retryConnectIntervalId&&delete e.__retryConnectIntervalId,e._websocket&&e._websocket.close(1e3)},!0),i.warn("online status = ",e.online)},_nextWsUri:function(){var e=this.ticket.url;return e.indexOf("?")>=0?e+="&"+a++:e+="?"+a++,e},_reconnect:function(e){function t(){i.warn("Reconnected. at ",e,s._websocket.url),s.__retryConnectIntervalId&&clearTimeout(s.__retryConnectIntervalId),s.__retryConnectIntervalId&&delete s.__retryConnectIntervalId;var t=s.newMessage().setOp(200).setSessId(s._sessionId).setTicket(s.ticket).setNickName(s.nickName||s.ticket.memName).setResource(s.resource).setExt(s.owner.ext);s.postMessage(t,function(e){if(0==e.result)s.onEvent(new c.EnterSuccess),s.owner.onMembers(e.cver,e.mems),s.owner.onStreams(e.cver,e.streams),s.notifyNewMessage();else try{s.onEvent(new c.EnterFail({me:s.owner,cause:new c.RspFail({request:t,response:e})}))}finally{-9527!==e.result&&s.onEvent(new c.ServerRefuseEnter({failed:e.result,msg:e.msg}))}})}function n(o){if(e<=0)return i.warn("Reconnect end. but fail.",o.url,e),void(s.__retryConnectIntervalId&&delete s.__retryConnectIntervalId);e&&(s.__retryConnectIntervalId=setTimeout(function(){s.connect(t,n,--e)},emedia.config.reconnectDelay))}var s=this;s.connect(t,n,--e)},__checkConnect:function(){var e=this;e.__checkConnectIntervalId&&clearTimeout(e.__checkConnectIntervalId),emedia.config.checkConnectIntervalMillis&&(e.__checkConnectIntervalId=setTimeout(function(){try{e.online&&!e.connected()&&(e.__retryConnectIntervalId&&i.debug("online, reconnecting..."),e.__retryConnectIntervalId||i.debug("online, but disconnect. will reconnect"),e.__retryConnectIntervalId||e._reconnect(emedia.config.reconnect))}finally{e.__checkConnect()}},emedia.config.checkConnectIntervalMillis))},connect:function(e,t,n){var o=this,r=o.thisWsUri=o._nextWsUri();void 0!==n&&i.warn("begin connect... at retry = ",n,r),s.call(o,function(){try{e.apply(o,arguments)}finally{o.__checkConnect()}},function(e){try{t.apply(o,arguments)}finally{n||e.url!==r||o.onEvent(new c.ServerRefuseEnter({failed:-95270,msg:"sdk reconnect fail. "+r+"|"+e.url}))}},n)},connected:function(e){var t=this;return t.online&&t._websocket&&(!e||e===t._websocket.url)&&t._websocket.readyState==WebSocket.OPEN},onWebsocketEvent:function(e){this.onEvent(e)},register:function(e){if("object"===(void 0===e?"undefined":o(e)))for(var t in e)this.bind(t,e[t])},bind:function(e,t){var n,s=this;if(!(n=s._events[e]))throw"Not supported event = "+e;s[n]=t},getSessionId:function(){return this._sessionId},newMessage:function(e){return new d(e)},__modifyMessage:function(e){if(e&&e.sdp&&("string"==typeof e.sdp&&(e.sdp=r.parseJSON(e.sdp)),e.sdp.type&&(e.sdp.type=e.sdp.type.toLowerCase())),e&&e.cands){"string"==typeof e.cands&&(e.cands=r.parseJSON(e.cands));for(var t=0;t<e.cands.length;t++)"string"==typeof e.cands[t]&&(e.cands[t]=r.parseJSON(e.cands[t])),e.cands[t].sdpMLineIndex=e.cands[t].mlineindex,e.cands[t].sdpMid=e.cands[t].mid,delete e.cands[t].mlineindex,delete e.cands[t].mid}if(e&&e.mems){if(!r.isArray(e.mems))return;var n=e.mems;e.mems={},r.forEach(n,function(t,n){e.mems[n.id]=n;var s=n.acptOps={};if(r.forEach(emedia.config.baseAcptOps,function(e,t){s[t]=!0}),n.res&&r.forEach(n.res.ops,function(e,t){s[t]=!0}),n&&n.ext)try{e.mems[n.id].ext=JSON.parse(n.ext)}catch(e){i.error(e)}})}if(e&&e.mem){var s=e.mem.acptOps={};if(r.forEach(emedia.config.baseAcptOps,function(e,t){s[t]=!0}),e.mem.res&&r.forEach(e.mem.res.ops,function(e,t){s[t]=!0}),e.mem&&e.mem.ext)try{e.mem.ext=JSON.parse(e.mem.ext)}catch(e){i.error(e)}}if(e&&e.streams){if(!r.isArray(e.streams))return;var o=e.streams;e.streams={},r.forEach(o,function(t,n){if(e.streams[n.id]=n,n&&n.ext)try{e.streams[n.id].ext=JSON.parse(n.ext)}catch(e){i.error(e)}})}if(e&&e.pubS&&e.pubS&&e.pubS.ext)try{e.pubS.ext=JSON.parse(e.pubS.ext)}catch(e){i.error(e)}if(e&&e.ext)try{e.ext=JSON.parse(e.ext)}catch(e){i.error(e)}},onMessage:function(e){var t=this;if(1001!=e.op&&!e.sessId)throw"message sessId error. server evt data error";if(1001!=e.op&&t._sessionId&&t._sessionId!=e.sessId)throw"message sessId error. server and local not equal";t.__modifyMessage(e);var n=r.removeAttribute(t._callbacks,e.tsxId);if(n&&200===n.op)if(t._sessionId=e.sessId,0===e.result){for(var s in t._bufferedMessages){var o=t._bufferedMessages[s];o.sessId||200===o.op||(o.sessId=e.sessId)}setTimeout(function(){t.notifyNewMessage()},100)}else for(var a;a=t._bufferedMessages.shift();)200!==a.op&&t.onMessage({op:1001,tsxId:a.tsxId,result:-9527,msg:"sdk enter fail. sdk callback. enter result = "+e.result});if(t.onEvent(new c.RecvResponse({request:n,response:e})),n&&n.__callback__)n.__callback__(e);else if(e.op&&1001!=e.op){var d,u=e.op;if(!(d=t._events[u])||!(d=t[d]))throw e;d(e)}else i.trace("Igron message. caused by op not found.",e)},__modifyMessageForPost:function(e){if(e.cands){for(var t=[],n=e.cands,s=0;s<n.length;s++){var o;o="string"==typeof n[s]?{type:"candidate",candidate:n[s],mlineindex:0,mid:"audio"}:{type:"candidate",candidate:n[s].candidate,mlineindex:n[s].sdpMLineIndex,mid:n[s].sdpMid},t.push(o)}e.cands=t}if(e.sdp&&r.isPlainObject(e.sdp)){var i={type:e.sdp.type,sdp:e.sdp.sdp};e.sdp=i,e.sdp.type=e.sdp.type.toUpperCase(),e.sdp=r.stringifyJSON(e.sdp)}return e},postMessage:function(e,t){var n=this;if(e.tsxId||e.setTsxId("MSG"+Date.now()+"-"+__session_globalCount++),e.memId){var s=n.owner._cacheMembers[e.memId];if(!s)return void(t&&t({op:1001,tsxId:e.tsxId,result:-507,msg:" member not found at local. memberId = "+e.memId}));var o=e._reqOps;o||(o=[]).push(e.op);for(var c in o){var a=o[c];if(!s.acptOps[a])return void(t&&t({op:1001,tsxId:e.tsxId,result:-507,msg:" member not accept op "+a+", "+e.memId}))}}r.removeAttribute(e,"_reqOps"),n._sessionId&&n._sessionId!=e.sessId?t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"sessionId not excepted."}):n.closed?t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"session closed"}):(n.__modifyMessageForPost(e),200===e.op?(n._bufferedMessages.unshift(e),t&&setTimeout(function(){n._callbacks[e.tsxId]&&(i.error("Enter timeout. fail."),n.onMessage({op:1001,tsxId:e.tsxId,result:-9527,msg:"enter timeout. millis = "+emedia.config.enterTimeout}))},emedia.config.enterTimeout)):n._bufferedMessages.push(e),n._callbacks[e.tsxId]=r.extend(e,{__callback__:t}),n.notifyNewMessage&&n.notifyNewMessage())},close:function(e){i.warn("sessiong closing, reason = ",e);var t=this;t.notifyNewMessage&&t.notifyNewMessage(),t.closed=!0,t.seqno=0,t._websocket&&(0==e||100==e?t._websocket.close(1e3):t._websocket.close()),t.__retryConnectIntervalId&&clearTimeout(t.__retryConnectIntervalId),t.__retryConnectIntervalId&&delete t.__retryConnectIntervalId,t.__checkConnectIntervalId&&clearTimeout(t.__checkConnectIntervalId),t.__checkConnectIntervalId&&delete t.__checkConnectIntervalId,t.owner=null,t._bufferedMessages=[],t._callbacks={},i.warn("session closed")}})},function(e,t,n){"use strict";var s=n(5),o=(s.logger,s.prototypeExtend({msg:"",__init__:function(){this.day=new Date},execTime:function(){var e=this.day.getHours();e<10&&(e="0"+e);var t=this.day.getMinutes();t<10&&(t="0"+t);var n=this.day.getSeconds();return n<10&&(n="0"+n),e+":"+t+":"+n}})),r=o.extend({_webrtcDesc:function(){this.webrtc;return this.webrtc.getRtcId()}});e.exports={Exception:o.extend(),WSClose:o.extend({message:function(){var e=this.execTime()+" WSClose: Websocket close ("+(this.retry||0)+").";return this.online||(e+=" offline."),this.event&&(e+=" wscode: "+this.event.code),this.cause&&(e+=" cause: "+this.cause.message),this.url&&(e+=" url: "+this.url),e+=" retry: "+(this.retry||0),this.session&&this.session.getSessionId()&&(e=e+", sess = "+this.session.getSessionId()),e}}),WSError:o.extend({message:function(){var e=this.execTime()+" WSError: Websocket error. ready state:"+(this.event.srcElement&&this.event.srcElement.readyState||this.event.currentTarget.readyState)+". online = "+this.online;return this.session&&this.session.getSessionId()&&(e=e+", sess = "+this.session.getSessionId()),this.url&&(e+=" url: "+this.url),e}}),WSConnected:o.extend({message:function(){var e=this.execTime()+" WSConnected: Websocket success. ready state:"+(this.event.srcElement&&this.event.srcElement.readyState||this.event.currentTarget.readyState);return this.session&&this.session.getSessionId()&&(e=e+", sess = "+this.session.getSessionId()),e}}),ICEChanage:r.extend({message:function(){return this.execTime()+" ICEChanage: "+this._webrtcDesc()+" state: "+this.state}}),AddIceCandError:r.extend({message:function(){return this.execTime()+" AddIceCandError: "+this._webrtcDesc()+", add cand error"}}),ICEConnectFail:r.extend({message:function(){return this.execTime()+" ICEConnectFail: "+this._webrtcDesc()+" failed"}}),ICEConnected:r.extend({message:function(){return this.execTime()+" ICEConnected: "+this._webrtcDesc()+" connected"}}),ICEDisconnected:r.extend({message:function(){return this.execTime()+" ICEDisconnected: "+this._webrtcDesc()+" disconnected"}}),ICEClosed:r.extend({message:function(){return this.execTime()+" ICEClosed: "+this._webrtcDesc()+" closed"}}),ICERemoteMediaStream:r.extend({message:function(){return this.execTime()+" ICERemoteMediaStream: "+this._webrtcDesc()+" got remote stream"}}),StreamState:o.extend({message:function(){return this.execTime()+" StreamState:  stream "+this.stream.id+" state: "+this.state+" "+this.msg},iceFail:function(){this.state=1,this.msg="network anomaly. media lost"}}),OpenMediaError:o.extend({message:function(){return this.execTime()+" OpenMediaError:  open media error. caused by "+this.event.toString()}}),Hangup:o.extend({message:function(){return this.self?"hangup id = "+(this.self.id||"--")+" reason："+(this.reason||0):this.execTime()+" Hangup: "+(this.parnter&&(this.parnter.name||this.parnter.id||" ")||"")+" hangup, reason："+(this.reason||0)}}),ServerRefuseEnter:o.extend({message:function(){return this.execTime()+" ServerRefuseEnter: server refuse, cause："+this.failed+", msg:"+(this.msg||"")}}),RspFail:o.extend({__init__:function(){this.day=new Date,this.failed=this.response.result,this.msg=this.response.msg||this.response.message||"--"},message:function(){return this.execTime()+" RspFail: "+this.request.tsxId+", "+(this.response.sessId||"--")+" op: "+this.request.op+", cause: "+this.failed+" "+this.msg}}),RecvResponse:o.extend({__init__:function(){this.day=new Date,this.failed=this.response.result,this.msg=this.response.msg},message:function(){return this.request?this.execTime()+" RecvResponse: "+(this.request&&this.request.tsxId)+", "+(this.response.sessId||"--")+" op: "+(this.request&&this.request.op)+", cause: "+this.failed+" "+this.msg:this.execTime()+" RecvMessage: "+(this.response&&this.response.tsxId)+", "+(this.response.sessId||"--")+" op: "+(this.response&&this.response.op)+" "+this.msg}}),EnterFail:o.extend({message:function(){return this.execTime()+" EnterFail: enter fail："+(this.cause?this.cause.message():"unkown")}}),EnterSuccess:o.extend({message:function(){return this.execTime()+" EnterSuccess: enter success"}}),PushSuccess:o.extend({message:function(){return this.execTime()+" PushSuccess: push success, streamId = "+this.stream.id+", "+this.stream.optimalVideoCodecs+", webrtc = "+this.stream.rtcId}}),PushFail:o.extend({message:function(){return this.execTime()+" PushFail: push fail, streamId = "+this.stream.id+", "+this.stream.optimalVideoCodecs+", webrtc = "+this.stream.rtcId+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),RemoteControlFail:o.extend({message:function(){return this.execTime()+" RemoteControlFail: remote control fail, streamId = "+this.stream.id+" failed = "+this.failed+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubSuccess:o.extend({message:function(){return this.execTime()+" SubSuccess: sub success, streamId = "+this.stream.id+", "+this.stream.vcodes+", webrtc = "+this.stream.rtcId}}),SubFail:o.extend({message:function(){return this.execTime()+" SubFail: sub fail, streamId = "+this.stream.id+", "+this.stream.vcodes+", webrtc = "+this.stream.rtcId+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubFailNotSupportVCodes:o.extend({message:function(){return this.execTime()+" SubFailNotSupportVCodes: sub fail, streamId = "+this.stream.id+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubFailSafariNotAllowSubBeforePub:o.extend({message:function(){return this.execTime()+" SubFailSafariNotAllowSubBeforePub: sub fail, streamId = "+this.stream.id+" cause：Safari without access to capture devices, WebKit only exposes Server Reflexive and TURN ICE candidates, which expose IPs that could already be gathered by websites."}}),SwitchVCodes:o.extend({message:function(){return this.execTime()+" SwitchVCodes: pub streamId = "+this.stream.id}}),CurrentCalling:o.extend({message:function(){return this.execTime()+" CurrentCalling: warn! current calling..."}}),OpenDesktopMedia:o.extend({message:function(){return this.execTime()+" OpenDesktopMedia: shared desktop, desktopStreamId = "+desktopStreamId}}),OpenDesktopMediaAccessDenied:o.extend({message:function(){return this.execTime()+" OpenDesktopMediaAccessDenied: shared desktop not allow"}}),ShareDesktopExtensionNotFound:o.extend({message:function(){return this.execTime()+" ShareDesktopExtensionNotFound: shared desktop plugin required"}})}},function(e,t,n){"use strict";var s=n(5),o=s.tagLogger("Me"),r=n(10),i=n(8),c=n(12),a=r.extend({__init__:function(){var e=this;if(e._session||e.sessionFactory&&(e._session=e.sessionFactory()),!e._session)throw"Require session";e._cver=0,e._cacheMembers={},e._cacheStreams={},e._linkedStreams={},e._maybeNotExistStreams={},e._records={},e._ices={},e.closed=!1},getCurrentMembers:function(){var e=this,t=[];return s.forEach(e._cacheMembers,function(e,n){var o=s.extend(!0,{},n);t.push(o)}),t},newStream:function(e){var t=this;return new(c.extend({__init__:function(){var e=this;if(e.rtcId||e._webrtc&&(e.rtcId=e._webrtc.getRtcId()),e._webrtc||e.rtcId&&(e._webrtc=t._ices[e.rtcId]),e.memId&&!e.owner&&(e.owner=s.extend({},t._cacheMembers[e.memId]),!e.owner&&!e.located()))throw"Remote stream, not owner. it = "+e.id}}))(e)},getConfrId:function(){return this.ticket.confrId},isCaller:function(){var e=this;return e.isP2P()&&e.ticket.caller==e.name},isCallee:function(){var e=this;return e.isP2P()&&e.ticket.callee==e.name},isP2P:function(){var e=this;return e.ticket&&("P2P"==e.ticket.type||"p2p"==e.ticket.type)},isConfr:function(){var e=this;return e.ticket&&("CONFR"==e.ticket.type||"confr"==e.ticket.type)},onEvent:function(e){},join:function(e,t){function n(e){try{if(e instanceof i.WSClose&&e.retry)return;e instanceof i.EnterFail||(e=new i.EnterFail({attendee:c,cause:e})),c.onEvent(e),t&&t(e)}finally{}}function s(t){if(0==t.result)c.reflushSupportVCodes(t.vcodes),c.setMemberId(t.memId),c.onEvent(new i.EnterSuccess),e&&e(t.memId),c.onMembers(t.cver,t.mems),c.onStreams(t.cver,t.streams);else try{n(new i.RspFail({request:r,response:t}))}finally{-9527!==t.result&&c.onEvent(new i.ServerRefuseEnter({failed:t.result,msg:t.msg}))}}o.debug("begin join ...");var r,c=this;c.connect(function(){r=c.newMessage().setOp(200).setTicket(c.ticket).setNickName(c.nickName||c.ticket.memName).setResource(c.resource).setExt(c.ext),c.postMessage(r,s)},n),o.debug("join",c.ticket.url)},withpublish:function(e){var t=this;if(!e||!e.localStream)throw"pubS null or stream not open";var n,s,r=e&&e.localStream;return{join:function(c,a){function d(e){try{if(e instanceof i.WSClose&&e.retry)return;e instanceof i.EnterFail||(e=new i.EnterFail({attendee:t,cause:e})),t.onEvent(e),a&&a(e)}finally{r&&r.getTracks().forEach(function(e){e.stop()}),s&&t.closeWebrtc(s.getRtcId())}}function u(o){if(0==o.result){t.reflushSupportVCodes(o.vcodes),t.setMemberId(o.memId),t.onEvent(new i.EnterSuccess);var r=t.newStream(e);r._localMediaStream=e.localStream,r.rtcId=s.getRtcId(),r._webrtc=s,r.id=o.streamId,r.owner={id:o.memId,nickName:t.nickName,name:t.sysUserId,ext:t.extObj},r.optimalVideoCodecs=f,c&&c(o.memId,r),t.onEvent(new i.PushSuccess({stream:r,hidden:!0})),o.sdp&&t.ansC(s.getRtcId(),o.sdp),o.cands&&t.tcklC(s.getRtcId(),o.cands),t.onMembers(o.cver,o.mems),t.onStreams(o.cver,o.streams)}else try{d(new i.RspFail({request:n,response:o}))}finally{-9527!==o.result&&t.onEvent(new i.ServerRefuseEnter({failed:o.result,msg:o.msg}))}}1===arguments.length&&(a=c,c=void 0);var f=t.getOptimalVideoCodecs();t.connect(function(){o.debug("enter and pubs");var r=e.localStream;s=t.createWebrtc({_rtcId:e.rtcId,optimalVideoCodecs:f}),t.setLocalStream(r,s.getRtcId()),t.doOffer(s.getRtcId(),function(o){n=t.newMessage().setOp(200).setTicket(t.ticket).setNickName(t.nickName||t.ticket.memName).setResource(t.resource).setSdp(o).setRtcId(s.getRtcId()).setPubS(e).setExt(t.ext),t.postMessage(n,u)})},d),o.debug("join",t.ticket.url)}}},push:function(e,t,n,s){function r(t){try{var o=a.newStream(e);o._localMediaStream=e.localStream,o._webrtc=u,o.rtcId=u&&u.getRtcId(),o.owner={id:a.getMemberId(),nickName:a.nickName,name:a.sysUserId,ext:a.extObj};var t=new i.PushFail({stream:o,cause:t,hidden:s&&!0===t.hidden});a.onEvent(t),t.hidden||n&&n(t)}finally{f&&!0!==t.hidden&&f.getTracks().forEach(function(e){e.stop()}),u&&a.closeWebrtc(u.getRtcId(),!0===t.hidden)}}function c(n,s){if(0==s.result){var o=a.newStream(e);o._localMediaStream=e.localStream,o._webrtc=n,o.rtcId=n.getRtcId(),o.id=s.streamId,o.owner={id:a.getMemberId(),nickName:a.nickName,name:a.sysUserId,ext:a.extObj},o.optimalVideoCodecs=l,a.onEvent(new i.PushSuccess({stream:o,hidden:!0})),t&&t(o),s.sdp&&a.ansC(n.getRtcId(),s.sdp),s.cands&&a.tcklC(n.getRtcId(),s.cands)}else r(new i.RspFail({request:d,response:s,hidden:!0===s.retrying}))}o.debug("begin push ...");var a=this;if(2===arguments.length&&(n=t,t=void 0),!e||!e.localStream)throw"pubS or stream open";var d,u,f=e.localStream,l=e.optimalVideoCodecs||a.getOptimalVideoCodecs();!function(e){o.debug("pubs");var t=e.localStream;u=a.createWebrtc({_rtcId:e.rtcId,optimalVideoCodecs:l}),a.setLocalStream(t,u.getRtcId()),a.doOffer(u.getRtcId(),function(t){d=a.newMessage().setOp(102).setRtcId(u.getRtcId()).setSdp(t).setPubS(e),a.postMessage(d,function(e){c(u,e)})})}(e),o.debug("push",a.ticket.url)},isSafari:function(){return/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)},isSafariButNotPushStream:function(){return!(!this.isSafari()||emedia._isSafariYetPushedStream)},createWebrtcAndSubscribeStream:function(e,t,n,r){function c(n){o.error("sub stream error",e,n),h&&f._webrtc&&f._webrtc.setSubArgs(h),h&&(f.subArgs=h),n=new i.SubFail({stream:f,hidden:!0===n.hidden,cause:n}),t&&t.onEvent&&t.onEvent(n),a.onEvent&&a.onEvent(n)}var a=this;t||(t={});var d=a._cacheStreams[e],u=a._cacheMembers[d.memId],f=d;if(r=r||f.subArgs||{subSVideo:!0,subSAudio:!0},a.isSafariButNotPushStream())c(s.extend(new i.SubFail,new i.SubFailSafariNotAllowSubBeforePub({stream:f})));else{var l=d.vcodes,m=u.vcodes,p=a.supportVCodes,_=a._getOptimalVideoCodecsSubset(l,m,p);r=r||f.subArgs;var h=f.subArgs,v={offerToReceiveAudio:!emedia.isSafari||r.subSAudio,offerToReceiveVideo:!emedia.isSafari||r.subSVideo&&!f.voff};v.offerToReceiveAudio||v.offerToReceiveVideo||(o.error("offerToReceiveAudio == false and offerToReceiveVideo == false"),console.error("offerToReceiveAudio == false and offerToReceiveVideo == false"));var S=a.createWebrtc({iceServerConfig:n,optimalVideoCodecs:_,offerOptions:v,onGotMediaStream:function(e){var n=new i.SubSuccess({stream:f,hidden:!0});t.onGotRemote&&t.onGotRemote(f),a.onEvent&&a.onEvent(n)}}),g=S.getRtcId();o.warn(g," sub stream ",e,_),f._webrtc=S,f.rtcId=g,f.owner=s.extend({},u),r&&f._webrtc&&f._webrtc.setSubArgs(r),r&&(f.subArgs=r),a.offerCall(g,null,e,c,function(){})}},_getOptimalVideoCodecsSubset:function(e,t,n){var o=this,r=[];if(e&&e.length>0&&n[e[0]]&&r.push(e[0]),0==r.length)for(var i=0;i<o._orderVCodes.length;i++)s.forEach(t,function(e,t){t==o._orderVCodes[i]&&r.push(t)});return r},subscribeStream:function(e,t,n,o){var r=this,c=r._ices[e],a=r._cacheStreams[t],d=r._cacheMembers[a.memId],u=a;u._webrtc=c,u.rtcId=e,u.owner=s.extend({},d);var f=u.subArgs;if(o=o||{subSVideo:!0,subSAudio:!0},u.subArgs=u.subArgs||{subSVideo:!0,subSAudio:!0},u._webrtc&&(u._webrtc.subArgs=u._webrtc.subArgs||{subSVideo:!0,subSAudio:!0}),!u.subArgs.subSVideo&&o.subSVideo&&!u.voff){var l=a.vcodes,m=d.vcodes,p=r.supportVCodes;r._getOptimalVideoCodecsSubset(l,m,p)}o&&u._webrtc&&u._webrtc.setSubArgs(o),o&&(u.subArgs=o);var _=r.newMessage().setOp(205).setRtcId(e).setSubSId(t);o&&s.extend(_,o),r.postMessage(_,function(e){if(0!=e.result){f&&u._webrtc&&u._webrtc.setSubArgs(f),f&&(u.subArgs=f);t=new i.SubFail({stream:u,cause:new i.RspFail({request:_,response:e})});return n&&n(t),void r.onEvent(t)}var t=new i.SubSuccess({stream:u,hidden:!0});r._updateRemoteStream(u,u._webrtc.getRemoteStream()),r.onEvent(t)})},unsubscribeStream:function(e){var t=this,n=t._cacheStreams[e],s=n._webrtc&&n._webrtc.getRtcId();if(s){try{var o=t.newMessage().setOp(206).setRtcId(s).setSubSId(e);t.postMessage(o)}finally{t.closeWebrtc(s)}return s}},onEnter:function(e,t){var n=this;if(e&&(n._cver=e),t&&!n._cacheMembers[t.id]){n._cacheMembers[t.id]=t;var o={};t.res&&t.res.vcodes&&t.res.vcodes.length>0&&s.forEach(t.res.vcodes,function(e,t){o[t]||(o[t]=!0,n.supportVCodes[t]&&n.supportVCodes[t]++)}),n.onAddMember(t)}},_onFinally:function(){var e=this;e._cacheMembers={},e._cacheStreams={},e._linkedStreams={},e._ices={},e._maybeNotExistStreams={},o.warn("finally. all clean.")},onExit:function(e,t,n){var r=this;if(e&&(r._cver=e),t!=r.getMemberId()){var c=r._cacheMembers[t];c&&(c.res&&c.res.vcodes&&c.res.vcodes.length>0&&s.forEach(c.res.vcodes,function(e,t){r.supportVCodes[t]--}),r._onRemoveMember(c,n),r.onEvent(new i.Hangup({reason:n,parnter:c})))}else{o.warn("Me exit. ",n,t);try{r.closed||r.close(n)}catch(e){r.onEvent(new i.Hangup({reason:n,self:{id:r._memberId}})),r.onMeExit&&r.onMeExit(n),o.error(e)}}},onPub:function(e,t,n){var r=this;if(!r._cacheMembers[t])throw"No found member. when pub";var i=r.newStream(n),c=r._cacheStreams[n.id];if(e&&(r._cver=e),c&&i.sver!==c.sver)return o.info("Onpub. the steam ",c.id," republish. sver ",c.sver,i.sver),!i||i.aoff===c.aoff&&i.voff==c.voff||r.onStreamControl(void 0,n.id,i.voff,i.aoff),s.extend(c,i),void r._onRepublishStream(c);var a=i;if(a.owner=r._cacheMembers[t],r._cacheStreams[n.id]=a,r.onAddStream(r.newStream(a)),r.autoSub){if(r.isSafariButNotPushStream())return a._autoSubWhenPushStream=!0,void o.warn("Dont auto sub stream ",a.id,", caused by safari not pub stream");r.createWebrtcAndSubscribeStream(n.id,{onGotRemote:function(e){}})}},onUnpub:function(e,t,n){var s=this,o=s._cacheStreams[n];s._onRemovePubstream(s._cacheMembers[t],o),e&&(s._cver=e)},onClose:function(e,t,n){var s=this;try{s.close(n||0)}finally{s.onConfrClose&&s.onConfrClose(t,n)}},__getWebrtcFor:function(e){var t=this._cacheStreams[e]._webrtc;return t&&t.getRtcId()},_getWebrtc:function(e){return this._cacheStreams[e]._webrtc},_updateRemoteStream:function(e,t){t&&t.getAudioTracks().forEach(function(t){t.enabled=!(e.aoff||e.subArgs&&!1===e.subArgs.subSAudio)}),t&&t.getVideoTracks().forEach(function(t){t.enabled=!(e.voff||e.subArgs&&!1===e.subArgs.subSVideo)})},onStreamControl:function(e,t,n,s){var o=this;(i=o._cacheStreams[t]).voff=n,i.aoff=s;var r=i._webrtc;r&&r._remoteStream&&o._updateRemoteStream(i,r._remoteStream);var i=o.newStream(i);o.onUpdateStream&&o.onUpdateStream(i,new i.Update({voff:n,aoff:s})),e&&(o._cver=e)},aoff:function(e,t,n){var s=this,o=s.__getWebrtcFor(e.id);if(!o)throw"pubS not publish"+e.id;s._linkedStreams[e.id].aoff=t;var r=s.newMessage().setOp(400).setRtcId(o).setVoff(e.voff).setAoff(t);s.postMessage(r,n)},voff:function(e,t,n){var s=this,o=s.__getWebrtcFor(e.id);if(!o)throw"pubS not publish"+e.id;s._linkedStreams[e.id].voff=t;var r=s.newMessage().setOp(400).setRtcId(o).setVoff(t).setAoff(e.aoff);s.postMessage(r,n)},startRecord:function(e,t){var n=this,r=e.rtcId,i=n.newMessage().setOp(500).setRtcId(r).setFlag(1);n.postMessage(i,function(i){o.warn("record ",r,i.result,i.msg),t&&t(0===i.result),0===i.result&&(n._records[e.id]=s.extend(!1,{},e))})},stopRecord:function(e,t){var n=this,r=e.rtcId,i=n.newMessage().setOp(500).setRtcId(r).setFlag(0);n.postMessage(i,function(e){o.warn("stop record ",r,e.result,e.msg),t&&t(0===e.result)}),n._records[e.id]&&s.removeAttribute(n._records,e.id)},onMembers:function(e,t){var n=this,o=[];s.forEach(n._cacheStreams,function(e,n){t[e]||o.push(n)}),s.forEach(o,function(e,t){n.onExit(void 0,t.id)});var r=[];s.forEach(t,function(e,t){e!=n.getMemberId()&&(n._cacheStreams[e]||r.push(t))}),s.forEach(r,function(e,t){n.onEnter(void 0,t)}),e&&(n._cver=e)},onStreams:function(e,t){var n=this,o=[];s.forEach(n._cacheStreams,function(e,n){n.located()||t[e]||o.push(n)}),s.forEach(o,function(e,t){n.onUnpub(void 0,t.memId,t.id)});var r=[];s.forEach(t,function(e,t){t.memId!=n.getMemberId()&&(n._cacheStreams[e]||r.push(t))}),s.forEach(r,function(e,t){n.onPub(void 0,t.memId,t)}),s.forEach(n._cacheStreams,function(e,o){var r;o.located()||(r=t[e]),!r||r.aoff===o.aoff&&r.voff==o.voff||n.onStreamControl(void 0,e,r.voff,r.aoff),r&&r.sver!==o.sver&&(s.extend(o,r),n._onRepublishStream(o))}),e&&(n._cver=e)},_onRemoveMember:function(e,t){var n=this;o.info("remove",e,t);var r=[];s.forEach(n._cacheStreams,function(t,n){n.memId===e.id&&r.push(n)}),s.forEach(r,function(e,s){n._onRemovePubstream(s.owner,s,t)}),s.removeAttribute(n._cacheMembers,e.id),n.onRemoveMember&&n.onRemoveMember(e,t)},_onRemovePubstream:function(e,t){var n=this;if(t){n.unsubscribeStream(t.id),s.removeAttribute(n._cacheStreams,t.id);if(n.onRemoveStream){var t=n.newStream(t);n.onRemoveStream(t)}}},_onRepublishStream:function(e){var t=this;if(t._ices[e.rtcId]&&!t._maybeNotExistStreams[e.id]){t.unsubscribeStream(e.id);t.createWebrtcAndSubscribeStream(e.id,{onGotRemote:function(e){}})}},onAddMember:function(e){},onRemoveMember:function(e,t){},onAddStream:function(e){},onRemoveStream:function(e){},onUpdateStream:function(e,t){}});e.exports=a},function(e,t,n){"use strict";var s=n(5),o=s.tagLogger("Member"),r=n(8),i=n(11);e.exports=s.prototypeExtend({__init__:function(){var e=this;if(!e._session)throw"Require session";e.closed=!1,e._ices={},e.supportVCodes={}},reflushSupportVCodes:function(e){var t=this;t.supportVCodes={},t._orderVCodes=e,e&&0!=e.length?s.forEach(e,function(e,n){t.supportVCodes[n]=1}):o.warn("Not config support vcodes")},getOptimalVideoCodecs:function(){var e=this;if(!e._orderVCodes||0==e._orderVCodes.length)return/Chrome/.test(navigator.userAgent)?"VP8":/Safari/.test(navigator.userAgent)?"H264":"VP8";var t=0;s.forEach(e._cacheMembers,function(){t++});for(var n,o=0,r=0;r<e._orderVCodes.length;r++){var i=e._orderVCodes[r];if(0==o&&(o=e.supportVCodes[i]),e.supportVCodes[i]>t)return i;e.supportVCodes[i]>o&&(o=e.supportVCodes[i],n=i)}return n},setMemberId:function(e){this._memberId=e},getMemberId:function(){return this._memberId},createWebrtc:function(e){var t=this,n=new i({onIceStateChange:function(e){var s=e.target.iceConnectionState;return o.debug("evt.target ice state",s),"failed"==s?(t.onEvent(new r.ICEConnectFail({webrtc:n,event:e})),void(n.onEvent&&n.onEvent(new r.ICEConnectFail({webrtc:n,event:e})))):"connected"==s?(t.onEvent(new r.ICEConnected({webrtc:n,event:e})),void(n.onEvent=null)):"closed"==s?(t.onEvent(new r.ICEClosed({webrtc:n})),void(n.onEvent&&n.onEvent(new r.ICEClosed({webrtc:n})))):"disconnected"==s?(t.onEvent(new r.ICEDisconnected({webrtc:n})),void(n.onEvent&&n.onEvent(new r.ICEDisconnected({webrtc:n})))):void(t._onIceStateChange&&t._onIceStateChange(n,e))},onIceCandidate:function(e){t._onIceCandidate&&e&&t._onIceCandidate(n,e)},onGotRemoteStream:function(e){o.info("got stream.",n,e),n.onGotMediaStream&&n.onGotMediaStream(e),t.onEvent(new r.ICERemoteMediaStream({webrtc:n}))},onAddIceCandidateError:function(e){t.onEvent(new r.AddIceCandError({webrtc:n,event:e}))},onSetSessionDescriptionError:function(e){o.error("onSetSessionDescriptionError : Failed to set session description: "+e.toString()),t.onEvent&&t.onEvent(new r.ICEConnectFail({webrtc:n,event:e}))},onCreateSessionDescriptionError:function(e){o.error("Failed to create session description: "+e.toString()),t.onEvent&&t.onEvent(new r.ICEConnectFail({webrtc:n,event:e}))}},e||{});return t._ices||(t._ices={}),t._ices[n.getRtcId()]&&t.closeWebrtc(n.getRtcId(),!0,!1),t._ices[n.getRtcId()]=n,t._ices[n.__id]=n,t._iceCreateRtcPeerConnection(n.getRtcId()),o.debug("create rtc ",n),n},connect:function(e,t){this._session.connect(e,t)},connected:function(){return this._session.connected()},newMessage:function(e){return this._session.newMessage(e||{})},postMessage:function(e,t){var n=this;try{e.sessId||e.setSessId(n._session._sessionId),n._session.postMessage(e,t)}catch(n){t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"post message. exception"}),o.error(n)}},onEvent:function(e){},_onIceStateChange:function(e,t){var n=this;o.info(e.getRtcId(),t),n.onEvent(new r.ICEChanage({webrtc:e,event:t,state:t.target.iceConnectionState}))},_onIceCandidate:function(e,t){var n,o=this;s.isArray(t)?n=t:(n=[]).push(t);var i=o.newMessage().setOp(105).setRtcId(e.getRtcId()).setCands(n);o.postMessage(i,function(e){0==e.result||o.onEvent(new r.RspFail({request:i,response:e}))})},_initC:function(e,t,n,i,c,a){var d=this;if(t&&t.rtcId!==e.getRtcId())throw"stream and webrtc rtcId not equal.";var u=d.newMessage().setOp(102).setRtcId(e.getRtcId()).setSdp(n).setSubSId(i);e.subArgs&&s.extend(u,e.subArgs),t&&t.located()&&u.setPubS(t),d.postMessage(u,function(n){if(0!=n.result)return d.onEvent(new r.RspFail({request:u,response:n})),void(c&&c(new r.RspFail({request:u,response:n,hidden:!0===n.retrying})));t&&!t.id&&n.streamId&&(t.id=n.streamId);try{a&&a()}catch(e){o.error(e)}n.sdp&&d.ansC(e.getRtcId(),n.sdp,n.cands),n.mems&&d.onMembers&&d.onMembers(n.cver,n.mems),n.streams&&d.onStreams&&d.onStreams(n.cver,n.streams)})},_acptC:function(e,t,n){var s=this,o=s.newMessage().setOp(104).setRtcId(e.getRtcId()).setSdp(t);s.postMessage(o,function(e){if(0!=e.result)return s.onEvent(new r.RspFail({request:o,response:e})),void(n&&n(new r.RspFail({request:o,response:e})))})},_ansC:function(e,t,n){var s=this,o=s.newMessage().setOp(106).setRtcId(e.getRtcId()).setSdp(t);s.postMessage(o,function(e){if(0!=e.result)return s.onEvent(new r.RspFail({request:o,response:e})),void(n&&n(new r.RspFail({request:o,response:e})))})},_termC:function(e,t,n){var s=this,o=s.newMessage().setOp(107).setRtcId(e.getRtcId()).setEndReason(t);s.postMessage(o,function(e){if(0!=e.result)return s.onEvent(new r.RspFail({request:o,response:e})),void(n&&n(new r.RspFail({request:o,response:e})))})},_iceCreateRtcPeerConnection:function(e){this._ices[e].createRtcPeerConnection(),o.debug("create rtc peer connection",e)},doOffer:function(e,t,n){this._ices[e].createOffer(function(e){t(e)})},offerCall:function(e,t,n,s,o){var r=this,i=r._ices[e];i.createOffer(function(e){r._initC&&r._initC(i,t,e,n,s,o)})},accept:function(e,t){var n=this,s=n._ices[e];s.createPRAnswer(function(e){n._acptC&&n._acptC(s,e,t)})},answer:function(e,t){var n=this,s=n._ices[e];s.createAnswer(function(e){n._ansC&&n._ansC(s,e,t)})},onTcklC:function(e,t){this._addIceCandidate(t,e)},onAcptC:function(e,t,n){var s=this;s._iceSetRemoteSDP(t,e),n&&s._addIceCandidate(n,e)},onAnsC:function(e,t,n){var s=this;s._iceSetRemoteSDP(t,e),n&&s._addIceCandidate(n,e)},_addIceCandidate:function(e,t){var n=this;e&&0!=e.length?n._ices[t].addIceCandidate(e):o.warn("drop cands",e)},closeWebrtc:function(e,t,n){var r=this,i=r._ices[e];if(!i||i.closed)return o.warn("Webrtc not exsits or closed",i&&i.closed),void(n&&i&&s.forEach(r._cacheStreams,function(t,n){n.rtcId===e&&delete r._linkedStreams[t]}));r._records&&function(){var t=function(e){try{r.stopRecord(e)}catch(e){o.error(e)}finally{s.removeAttribute(r._records,e.id)}};s.forEach(r._records,function(n,s){s.rtcId===e&&t(s)})}();try{n||i&&r._termC(i,t&&i._localStream?-10:0)}finally{i&&i.close(),i&&r.onWebrtcTermC&&r.onWebrtcTermC(i),t||i&&s.forEach(r._cacheStreams,function(t,s){s.rtcId===e&&(s.located()&&(s._localMediaStream&&s._localMediaStream.getTracks().forEach(function(e){e.stop()}),r._cacheStreams[t]&&r._linkedStreams[t]&&r.onRemoveStream(s),delete r._cacheStreams[t],o.info("Remove stream",t,". from cache")),n&&delete r._linkedStreams[t])})}return i},__close:function(e){o.warn("closing, reason = ",e);var t=this;if(!t.closed){if(t.closed=!0,t.__getCopyInterval&&(clearInterval(t.__getCopyInterval),o.warn("Stop interval get copy")),t._ices)for(var n in t._ices)t.closeWebrtc(n);var s=t.newMessage().setOp(201).setReason(e||0);t.postMessage(s)}},exit:function(e){var t=this;e?(e&&t._closeMyConfr(11),setTimeout(function(){t.close(0)},100)):t.close(0)},_closeMyConfr:function(e){var t=this,n=t.newMessage().setOp(204).setReason(e||0);t.postMessage(n,function(e){o.warn("Close confr ",e.result,e.msg)})},close:function(e,t){var n=this;if(!n.closed)try{s.forEach(n._cacheStreams||{},function(e,t){t.located()&&t._localMediaStream&&t._localMediaStream.getTracks().forEach(function(e){e.stop()})}),n.__close(e)}finally{setTimeout(function(){n._session&&n._session.close(e)},500),n.onEvent(new r.Hangup({reason:e,failed:t,self:{id:n._memberId}})),n.onMeExit&&n.onMeExit(e,t),n._onFinally&&n._onFinally()}},webrtcState:function(e){return this._ices[e].iceConnectionState()},_iceSetRemoteSDP:function(e,t){this._ices[t].setRemoteDescription(e)},setLocalStream:function(e,t){this._ices[t].setLocalStream(e)},onWebrtcTermC:function(e){}})},function(e,t,n){"use strict";var s=n(5),o=s.tagLogger("Webrtc"),r=(n(8),{headerSection:null,audioSection:null,videoSection:null,_parseHeaderSection:function(e){var t=e.indexOf("m=audio");return t>=0?e.slice(0,t):(t=e.indexOf("m=video"),t>=0?e.slice(0,t):e)},_parseAudioSection:function(e){var t=e.indexOf("m=audio");if(t>=0){var n=e.indexOf("m=video");return e.slice(t,n<0?e.length:n)}},_parseVideoSection:function(e){var t=e.indexOf("m=video");if(t>=0)return e.slice(t)},spiltSection:function(e){var t=this;t._preSDP=e,t.headerSection=t._parseHeaderSection(e),t.audioSection=t._parseAudioSection(e),t.videoSection=t._parseVideoSection(e)},updateVCodes:function(e){var t=this;if(e&&t.videoSection){"string"==typeof e&&((i=[]).push(e),e=i);for(var n={},r=/a=rtpmap:(\d+) ([A-Za-z0-9]+)\/.*/gi,i=t._parseLine(t.videoSection,r),c=0;c<i.length;c++){var a=i[++c];n[i[++c]]=a}var d=/a=fmtp:(\d+) .*profile-level-id=42e01f;?.*/gi,u=t._parseLine(t.videoSection,d);u&&u.length>=2&&(n.H264=u[1]);for(var f=[],c=0;c<e.length;c++){var l=n[e[c]];l&&f.push(l)}var m=t.videoSection.indexOf("\r"),p=t.videoSection.substring(0,m),_=p.split(" ");Array.prototype.push.apply(f,_.slice(3));var h=[],v={};s.forEach(f,function(e,t){0==h.length?(h.push(t),v[t]=!0):v[t]||(h.push(t),v[t]=!0)}),_.splice(3,_.length-3,h.join(" ")),p=_.join(" "),o.warn(p),t.videoSection=p+t.videoSection.substring(m)}},removeSSRC:function(e){for(var t=[],n=e.split(/a=ssrc:[^\n]+/g),s=0;s<n.length;s++)"\n"!=n[s]&&t.push(n[s]);return t.join("\n")},removeField_msid:function(e){for(var t=[],n=e.split(/a=msid:[^\n]+/g),s=0;s<n.length;s++)"\n"!=n[s]&&t.push(n[s]);e=t.join("\n"),t=[],n=e.split(/[\n]+/g);for(s=0;s<n.length;s++)"\n"!=n[s]&&t.push(n[s]);return t.join("\n")},updateHeaderMsidSemantic:function(e){var t=this,n="a=msid-semantic: WMS "+e,s=t.headerSection.split(/a=msid\-semantic: WMS.*/g),o=[];switch(s.length){case 1:o.push(s[0]);break;case 2:o.push(s[0]),o.push(n),o.push("\n");break;case 3:o.push(s[0]),o.push(n),o.push("\n"),o.push(s[2]),o.push("\n")}return t.headerSection=o.join("")},updateAudioSSRCSection:function(e,t,n,s){var o=this;o.audioSection&&(o.audioSection=o.removeSSRC(o.audioSection)),o.audioSection&&(o.audioSection=o.removeField_msid(o.audioSection)),o.audioSection&&(o.audioSection=o.audioSection+o.ssrcSection(e,t,n,s))},updateVideoSSRCSection:function(e,t,n,s){var o=this;o.videoSection&&(o.videoSection=o.removeSSRC(o.videoSection)),o.videoSection&&(o.videoSection=o.removeField_msid(o.videoSection)),o.videoSection&&(o.videoSection=o.videoSection+o.ssrcSection(e,t,n,s))},getUpdatedSDP:function(){var e=this,t="";return e.headerSection&&(t+=e.headerSection),e.audioSection&&(t+=e.audioSection),e.videoSection&&(t+=e.videoSection),t},parseMsidSemantic:function(e){var t=this,n=/a=msid\-semantic:\s*WMS (\S+)/gi,s=t._parseLine(e,n);return s&&2==s.length&&(t.msidSemantic={line:s[0],WMS:s[1]}),t.msidSemantic},ssrcSection:function(e,t,n,s){return["a=ssrc:"+e+" cname:"+t,"a=ssrc:"+e+" msid:"+n+" "+s,"a=ssrc:"+e+" mslabel:"+n,"a=ssrc:"+e+" label:"+s,""].join("\n")},parseSSRC:function(e){var t=this,n=new RegExp("a=(ssrc):(\\d+) (\\S+):(\\S+)","ig"),s=t._parseLine(e,n);if(s){for(var o={lines:[],updateSSRCSection:t.ssrcSection},r=0;r<s.length;r++){var i=s[r];if(i.indexOf("a=ssrc")>=0)o.lines.push(i);else switch(i){case"ssrc":case"cname":case"msid":case"mslabel":case"label":o[i]=s[++r]}}return o}},_parseLine:function(e,t){for(var n,s=[];null!=(n=t.exec(e));)for(var o=0;o<n.length;o++)s.push(n[o]);if(s.length>0)return s}}),i=function(e){s.extend(this,r),this.spiltSection(e)};window.__rtc_globalCount=0;var c=s.prototypeExtend({closed:!1,sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},offerOptions:{offerToReceiveAudio:!0,offerToReceiveVideo:!0},optimalVideoCodecs:null,optimalAudioCodecs:null,__init__:function(){var e=this;e._rtcId||(e._rtcId="RTC"+__rtc_globalCount++),e.__id="_i_"+__rtc_globalCount++,e.__setRemoteSDP=!1,e.__tmpRemoteCands=[],e.__tmpLocalCands=[],e._rtcPeerConnection=null,o.info("Webrtc created. rtcId = ",e._rtcId,", __id = ",e.__id)},getRtcId:function(){return this._rtcId},iceState:function(){return this._rtcPeerConnection.iceConnectionState},setSubArgs:function(e){this.subArgs=e},updateRemoteBySubArgs:function(e){var t=this;t._remoteStream&&t._remoteStream.getVideoTracks().forEach(function(e){e.enabled=!(t.subArgs&&!1===t.subArgs.subSVideo)}),t._remoteStream&&t._remoteStream.getAudioTracks().forEach(function(e){e.enabled=!(t.subArgs&&!1===t.subArgs.subSAudio)})},createRtcPeerConnection:function(e){var t=this;o.debug("begin create RtcPeerConnection ......",t._rtcId,"closed:",t.closed),e||(e=t.iceServerConfig),e?(!e.iceServers&&(e.iceServers=[]),e.rtcpMuxPolicy="require",e.bundlePolicy="max-bundle",e.relayOnly&&(e.iceTransportPolicy="relay")):e=null,o.debug("RtcPeerConnection config:",e,t._rtcId,"closed:",t.closed);var n=t._rtcPeerConnection=new RTCPeerConnection(e);o.debug("created local peer connection object",n,t._rtcId),n.onicecandidate=function(e){if("icecandidate"!=e.type||null!=e.candidate&&!/ tcp /.test(e.candidate.candidate)){if(!e.candidate.candidate)throw"Not found candidate. candidate is error, "+e.candidate.candidate;if(!t.__setRemoteSDP)return(t.__tmpLocalCands||(t.__tmpLocalCands={})).push(e.candidate),void o.debug("On ICE candidate but tmp buffer caused by not set remote sdp: ",e.candidate.candidate,t._rtcId,"closed:",t.closed);o.debug("On ICE candidate: ",e.candidate.candidate,t._rtcId,"closed:",t.closed),t.onIceCandidate(e.candidate)}},n.onicestatechange=function(e){o.debug("ice connect state",t.webRtc.iceConnectionState(),"evt.target state",e.target.iceConnectionState,t._rtcId,"closed:",t.closed),t.onIceStateChange(e)},n.oniceconnectionstatechange=function(e){t.onIceStateChange(e)},n.onaddstream=function(e){t._onGotRemoteStream(e)}},setLocalStream:function(e){this._localStream=e,this._rtcPeerConnection.addStream(e),o.debug("Added local stream to RtcPeerConnection",e,self._rtcId,"closed:",this.closed)},getLocalStream:function(){return this._localStream},getRemoteStream:function(){return this._remoteStream},createOffer:function(e,t){var n=this;return o.debug("createOffer start..."),n._rtcPeerConnection.createOffer(n.offerOptions).then(function(t){if(n.offerDescription=t,o.debug("setLocalDescription start",n._rtcId,"closed:",n.closed,n.optimalVideoCodecs),n.optimalVideoCodecs&&("string"==typeof n.optimalVideoCodecs||n.optimalVideoCodecs.length>0)){var s=new i(t.sdp);s.updateVCodes(n.optimalVideoCodecs),t.sdp=s.getUpdatedSDP()}n._rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSessionDescriptionSuccess,n.onSetSessionDescriptionError).then(function(){(e||n.onCreateOfferSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createPRAnswer:function(e,t){var n=this;return o.info(" createPRAnswer start","closed:",n.closed),n._rtcPeerConnection.createAnswer(n.sdpConstraints).then(function(t){o.debug("_____________PRAnswer ",t.sdp,n._rtcId,"closed:",n.closed),t.type="pranswer",t.sdp=t.sdp.replace(/a=recvonly/g,"a=inactive"),n.__prAnswerDescription=t,o.debug("inactive PRAnswer ",t.sdp,n._rtcId,"closed:",n.closed),o.debug("setLocalDescription start",n._rtcId,"closed:",n.closed),n._rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){var s=new i(t.sdp);s.updateHeaderMsidSemantic("MS_0000"),s.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),s.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=s.getUpdatedSDP(),o.debug("Send PRAnswer ",t.sdp,n._rtcId,"closed:",n.closed),(e||n.onCreatePRAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createAnswer:function(e,t){var n=this;return o.info("createAnswer start","closed:",n.closed),n._rtcPeerConnection.createAnswer(n.sdpConstraints).then(function(t){if(o.debug("_____________________Answer ",t.sdp,n._rtcId,"closed:",n.closed),t.type="answer",emedia.supportPRAnswer){var s=new i(t.sdp),r=s.parseMsidSemantic(s.headerSection);"*"==r.WMS&&s.updateHeaderMsidSemantic(r.WMS="MS_0000");var c=s.parseSSRC(s.audioSection),a=s.parseSSRC(s.videoSection);s.updateAudioSSRCSection(1e3,"CHROME0000",r.WMS,c.label||"LABEL_AUDIO_1000"),a&&s.updateVideoSSRCSection(2e3,"CHROME0000",r.WMS,a.label||"LABEL_VIDEO_2000"),t.sdp=s.getUpdatedSDP()}n.__answerDescription=t,o.debug("Answer ",t.sdp,n._rtcId,"closed:",n.closed),o.debug("setLocalDescription start",n._rtcId,"closed:",n.closed),n._rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){if(emedia.supportPRAnswer){var s=new i(t.sdp);s.updateHeaderMsidSemantic("MS_0000"),s.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),s.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=s.getUpdatedSDP()}o.debug("Send Answer ",t.sdp,n._rtcId,"closed:",n.closed),(e||n.onCreateAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},close:function(e){var t=this;if(o.warn("webrtc closing","closed:",t._rtcId,t.closed),!t.closed){t.closed=!0;try{t._rtcPeerConnection&&t._rtcPeerConnection.close()}catch(e){o.error(e)}finally{t._remoteStream&&t._remoteStream.getTracks().forEach(function(e){e.stop()}),t._remoteStream=null,t.onClose&&t.onClose(),o.warn("webrtc closed. closed:",t._rtcId,t.closed)}}},addIceCandidate:function(e){var t=this;if(t._rtcPeerConnection){o.debug("Add ICE candidate: ",e,t._rtcId,"closed:",t.closed);var n=s.isArray(e)?e:[];if(!s.isArray(e)&&n.push(e),!t.__setRemoteSDP)return Array.prototype.push.apply(t.__tmpRemoteCands||(t.__tmpRemoteCands={}),n),void o.debug("Add ICE candidate but tmp buffer caused by not set remote sdp: ",e,t._rtcId,"closed:",t.closed);for(var r=0;r<n.length;r++)e=n[r],t._rtcPeerConnection.addIceCandidate(new RTCIceCandidate(e)).then(t.onAddIceCandidateSuccess,t.onAddIceCandidateError)}},setRemoteDescription:function(e){var t=this;return o.debug("setRemoteDescription start. ",e,t._rtcId,"closed:",t.closed),e.sdp=e.sdp.replace(/UDP\/TLS\/RTP\/SAVPF/g,"RTP/SAVPF"),o.debug("setRemoteDescription.",e,"closed:",t.closed),e=new RTCSessionDescription(e),t._rtcPeerConnection.setRemoteDescription(e).then(function(){t.__setRemoteSDP=!0,t.onSetRemoteSuccess.apply(t,arguments),t.__tmpLocalCands&&t.__tmpLocalCands.length>0&&(o.debug("After setRemoteDescription. send cands",t._rtcId,"closed:",t.closed),t.onIceCandidate(t.__tmpLocalCands),t.__tmpLocalCands=[]),t.__tmpRemoteCands&&t.__tmpRemoteCands.length>0&&(o.debug("After setRemoteDescription. add tmp cands",t._rtcId,"closed:",t.closed),t.addIceCandidate(t.__tmpRemoteCands),t.__tmpRemoteCands=[])},t.onSetSessionDescriptionError)},iceConnectionState:function(){return this._rtcPeerConnection.iceConnectionState},isConnected:function(){var e=this._rtcPeerConnection.iceConnectionState;return"connected"===e||"completed"===e},_onGotRemoteStream:function(e){o.debug("onGotRemoteStream.",self._rtcId,e),this._remoteStream=e.stream,this.onGotRemoteStream(this._remoteStream,e),o.debug("received remote stream, you will see the other.",self._rtcId,"closed:",this.closed)},onSetRemoteSuccess:function(){o.info("onSetRemoteSuccess complete",self._rtcId)},onSetLocalSuccess:function(){o.info("setLocalDescription complete",self._rtcId)},onAddIceCandidateSuccess:function(){o.debug("addIceCandidate success",self._rtcId)},onAddIceCandidateError:function(e){o.debug("failed to add ICE Candidate: "+e.toString(),self._rtcId)},onIceCandidate:function(e){o.debug("onIceCandidate : ICE candidate: \n"+e,self._rtcId)},onIceStateChange:function(e){o.debug("onIceStateChange : ICE state change event: ",self._rtcId)},onCreateSessionDescriptionError:function(e){o.error("Failed to create session description: "+e.toString(),self._rtcId)},onCreateOfferSuccess:function(e){o.debug("create offer success",self._rtcId)},onCreatePRAnswerSuccess:function(e){o.debug("create answer success",self._rtcId)},onCreateAnswerSuccess:function(e){o.debug("create answer success",self._rtcId)},onSetSessionDescriptionError:function(e){o.error("onSetSessionDescriptionError : Failed to set session description: "+e.toString(),self._rtcId)},onSetLocalSessionDescriptionSuccess:function(){o.debug("onSetLocalSessionDescriptionSuccess : setLocalDescription complete",self._rtcId)},onGotRemoteStream:function(e){o.debug("Got remote stream. ",e,self._rtcId)}});e.exports=c},function(e,t,n){"use strict";var s=n(5);e.exports=s.prototypeExtend({Update:s.prototypeExtend({ifAoff:function(e){this.if("aoff",e)},ifVoff:function(e){this.if("voff",e)},ifMediaStream:function(e){this.if("mediaStream",e)},if:function(e,t){void 0!==this[e]&&t(this[e])}}),located:function(){return this._located||!1},webrtc:function(e){return e&&(this._webrtc=e),this},getMediaStream:function(){return this._located?this._localMediaStream:this._webrtc&&this._webrtc.getRemoteStream()},ifMediaStream:function(e){void 0===this.mediaStream?this._located&&void 0!==this._localMediaStream?e(this._localMediaStream):this._located||!this._webrtc||void 0===this._webrtc.getRemoteStream()||e(this._webrtc.getRemoteStream()):e(this.mediaStream)},getHtmlDOMID:function(){return"_m_"+this.owner.id+"_s_"+this.id}})},function(e,t,n){"use strict";var s=n(5),o=s.tagLogger("Handler"),r=n(8),i=s.prototypeExtend({onEvent:function(e){function t(){try{n.handleEvent(e)}catch(e){o.error(e)}}var n=this;if(e&&o.warn("[EVT]",e.message(),e.hidden||""),e instanceof r.ServerRefuseEnter&&e.failed&&-95270===e.failed&&(e.failed=-9527),e instanceof emedia.event.StreamState&&e.stream&&e.stream.located())t();else try{e.hidden||n.onNotifyEvent&&n.onNotifyEvent(e)}finally{t()}},handleEvent:function(e){var t=this;if(e instanceof r.RecvResponse)t._onRecvResponse(e);else if(e instanceof r.ServerRefuseEnter)o.warn("Server refuse, ",e.failed,e.msg),t.onServerRefuseEnter(e);else if(e instanceof r.EnterFail)o.warn("Enter fail, result = ",e.failed),t.onEnterFail();else if(e instanceof r.WSClose)t.onWSClose();else if(e instanceof r.WSConnected)o.warn("Websocket connected");else if(e instanceof r.ICEConnected){a=e.webrtc;t.onICEConnected(a)}else if(e instanceof r.ICEConnectFail){a=e.webrtc;t.onICEConnectFail(a)}else if(e instanceof r.ICEDisconnected){a=e.webrtc;t.onICEDisconnected(a)}else if(e instanceof r.ICEClosed){a=e.webrtc;t.onICEClosed(a)}else if(e instanceof r.ICERemoteMediaStream)t.onICERemoteMediaStream(e.webrtc);else if(e instanceof r.PushSuccess){t._cacheStreams[e.stream.id]=t._linkedStreams[e.stream.id]=e.stream;n=t.newStream(e.stream);if(e.hidden&&!t._maybeNotExistStreams[e.stream.id]&&!n.isRepublished)return void t.onAddStream(n);t.isSafari()&&(emedia._isSafariYetPushedStream=!0);try{n&&(n.mediaStream=n.getMediaStream()),n&&t.onUpdateStream(n,new n.Update({voff:n.voff,aoff:n.aoff,mediaStream:n.mediaStream}))}finally{t.isSafari()&&s.forEach(t._cacheStreams,function(e,n){!0===n._autoSubWhenPushStream&&(s.removeAttribute(n,"_autoSubWhenPushStream"),t.createWebrtcAndSubscribeStream(n.id))})}}else if(e instanceof r.SubSuccess)t._linkedStreams[e.stream.id]=e.stream,e.stream._zoom=1;else if(e instanceof r.PushFail){if(!0!==e.hidden&&s.removeAttribute(t._linkedStreams,e.stream.id)){var n=t.newStream(e.stream);t.onRemoveStream(n)}}else if(e instanceof r.SubFail)!0!==e.hidden&&(delete t._linkedStreams[e.stream.id],(n=t.newStream(e.stream)).rtcId=void 0,n._webrtc=void 0,n.mediaStream=null,t.onUpdateStream(n,new n.Update(n)));else if(e instanceof r.SubFailNotSupportVCodes){i=e.stream;o.warn("Rtc donot support pub VCodes. close. sub fail.",i.rtcId," -> ",i.id);try{t.onNotSupportPublishVideoCodecs&&t.onNotSupportPublishVideoCodecs(i)}catch(e){o.error(e)}}else if(e instanceof r.EnterSuccess)t.onEnterSuccess();else if(e instanceof r.SwitchVCodes){var i=e.stream,c=e.useVCodes,a=i._webrtc;o.warn("Rtc switch VCodes. ",i.id,c),c&&0!=c.length||o.warn("Rtc switch VCodes. error! useVCodes is empty ",i.id,c),i.optimalVideoCodecs=c,a&&t.closeWebrtc(a.getRtcId(),!0),setTimeout(function(){i.iceRebuildCount=1,t.iceRebuild(i),o.warn("Rtc switch VCodes. iceRebuild end.",i.id,c)},300)}},_onRecvResponse:function(e){var t=this,n=e.request,s=e.response;if(n&&s&&200!==n.op&&0!==s.result){o.error("Server refuse. when request = ",n);var r=e.failed;switch(r){case-9527:case-95270:break;case-500:case-502:case-504:case-508:case-510:t.close(4,r);break;case-506:t.close(11,r);break;case-501:t.close(11,r)}}},onServerRefuseEnter:function(e){var t=this,n=e.failed;switch(n){case-9527:case-95270:t.close(4,-9527);break;case-500:case-502:case-504:case-508:case-510:t.close(4,n);break;case-506:t.close(11,n);break;default:t.close(2)}},onEnterFail:function(){var e=this;e.__getCopyInterval&&clearInterval(e.__getCopyInterval)},onEnterSuccess:function(){var e=this;setTimeout(function(){e._failIcesRebuild()},200),e.getCopyIntervalMillis&&e.getCopyIntervalMillis>0&&(o.warn("Run interval get copy. interval = ",e.getCopyIntervalMillis),e.__getCopyInterval&&clearInterval(e.__getCopyInterval),e.__getCopyInterval=setInterval(function(){e._session.connected()?e._sysCopy.apply(e):(o.warn("Warn! cannot get copy. cause offline."),e.__getCopyInterval&&clearInterval(e.__getCopyInterval))},e.getCopyIntervalMillis))},onWSClose:function(){var e=this;e.__getCopyInterval&&clearInterval(e.__getCopyInterval),o.info("Websocket closed.")},onICEDisconnected:function(e){var t=this;t.__networkWeakInterval&&clearTimeout(t.__networkWeakInterval),t.__networkWeakInterval=setTimeout(function(){t.onNetworkWeak&&t.onNetworkWeak()},1e3),s.forEach(t._linkedStreams,function(n,r){if(r.rtcId==e.getRtcId()){t._maybeNotExistStreams[n]||((t._maybeNotExistStreams[n]=s.extend({},r)).iceRebuildCount=1),o.info("Stream maybe not exist. caused by disconnected",r.id)}})},onICEConnectFail:function(e){var t=this;for(var n in t._linkedStreams){var i=t._linkedStreams[n];if(i.rtcId==e.getRtcId()){var c;if((c=t._maybeNotExistStreams[n])||((c=t._maybeNotExistStreams[n]=s.extend({},i)).iceRebuildCount=1),c){var a=new r.StreamState({stream:c});a.iceFail(),t.onEvent(a)}if(o.info("ice fail. webrtc = ",e.getRtcId()," problem stream is ",c.iceRebuildCount,c.id),c.iceRebuildCount>emedia.config.iceRebuildCount)o.info("ice fail. webrtc = ",e.getRtcId()," rebuild fail. problem stream is ",c.id),c.located()?t.onEvent(new r.PushFail({stream:i,cause:"pub ice rebuild failed."})):t.onEvent(new r.SubFail({stream:i,cause:"sub ice rebuild failed."})),t.closeWebrtc(e.getRtcId(),!1);else{var d=t._records[c.id];o.info("ice fail. webrtc = ",e.getRtcId()," will rebuild. remain local stream. ",c.id),t.closeWebrtc(e.getRtcId(),!0),d&&(t._records[c.id]=d),setTimeout(function(){t.iceRebuild(c)},emedia.config.iceRebuildIntervalMillis),o.info("ice fail. webrtc = ",e.getRtcId()," will rebuild. problem stream is ",c.id)}}}},onICEClosed:function(e){var t=this;if(e.closed){o.warn("Webrtc will be removed. by __id = ",e.__id,", rtcId = ",e.getRtcId());var n=s.removeAttribute(t._ices,e.__id);n?o.warn("Webrtc removed. by id = ",n.__id,", rtcId = ",n.getRtcId()):o.warn("Webrtc removed. by id = ",e.__id,", rtcId = ",e.getRtcId());var r=t._ices[e.getRtcId()];r&&r.__id===n.__id&&(n=s.removeAttribute(t._ices,e.getRtcId()),o.warn("Webrtc removed. by rtcId = ",n.getRtcId(),", __id = ",n.__id))}else o.info("ICE self closed. not allow. will rebuild",e.getRtcId()),t.onICEConnectFail(e)},onICEConnected:function(e){var t=this;s.forEach(t._cacheStreams,function(n,i){if(i.rtcId==e.getRtcId())if(t._maybeNotExistStreams[n]){s.removeAttribute(t._maybeNotExistStreams,i.id),t._linkedStreams[n]=i,o.info("ice reconnected. webrtc = ",e.getRtcId(),"will update stream = ",i.id);var c=t._records[i.id];c&&c.rtcId!==i.rtcId&&(t.startRecord(i),o.warn("Re record. for ",i.id,", after rebuild ice.",c.rtcId,"->",i.rtcId))}else o.info("ice connected. webrtc = ",e.getRtcId(),i.id),i.located()&&t.onEvent(new r.PushSuccess({stream:i})),i.located()||t.onEvent(new r.SubSuccess({stream:i}))})},onICERemoteMediaStream:function(e){var t=this;s.forEach(t._cacheStreams,function(n,s){s.rtcId!=e.getRtcId()||s.located()||((s=t.newStream(s)).mediaStream=s.getMediaStream(),t._updateRemoteStream(s,s.mediaStream),t.onUpdateStream(s,new s.Update({mediaStream:s.mediaStream})))})},_failIcesRebuild:function(){var e=this;s.forEach(e._maybeNotExistStreams,function(t,n){setTimeout(function(){e.iceRebuild(n)},100)})},iceRebuild:function(e){var t=this;return t.connected()?t._linkedStreams[e.id]&&t._cacheStreams[e.id]?void(e.iceRebuildCount>emedia.config.iceRebuildCount?(o.info("ice rebuild fail. count too many. stream is ",e.id),e.located()?t.onEvent(new r.PushFail({stream:e,cause:"pub ice rebuild failed."})):t.onEvent(new r.SubFail({stream:e,cause:"sub ice rebuild failed."}))):t.connected()?(o.info("ice try rebuild. count",e.iceRebuildCount,". stream is ",e.id),t.rebuildIce(e),e.iceRebuildCount++):o.warn("ice rebuild. stop. cause by not websocket disconnect",e.id)):(o.info("ice rebuild fail. it yet closed. stream is ",e.id,e.rtcId),s.removeAttribute(t._maybeNotExistStreams,e.id),void s.removeAttribute(t._linkedStreams,e.id)):(e.iceRebuildCount=1,void o.warn("Websocket disconnect. waiting. rebuild count reset",e.iceRebuildCount,e.id))},rebuildIce:function(e){var t=this;t._cacheStreams[e.id]?(o.warn("Begin rebuild ice ",e.iceRebuildCount,e.id),e.located()?(e.isRepublished=!0,t.push(e,void 0,void 0,!0)):t.createWebrtcAndSubscribeStream(e.id),o.warn("Finish rebuild ice ",e.iceRebuildCount,e.id,t._cacheStreams[e.id].rtcId)):o.warn("Begin rebuild ice. not found stream at local",e.iceRebuildCount,e.id)},_sysCopy:function(){var e=this,t=e.newMessage().setOp(1e3).setCver(e._cver||0);e.postMessage(t,function(t){0==t.result?(e._cver||0)<t.cver&&(e._cver=t.cver,e.onMembers(t.cver,t.mems||{}),e.onStreams(t.cver,t.streams||{}),o.info("Got copy success.")):o.error("Get copy fail. result = ",t.result)})}});e.exports=i},function(e,t,n){"use strict";var s=n(5),o=s.tagLogger("Desktop"),r=n(8);window.__shareDesktopMessageCount__=0,e.exports=s.prototypeExtend({__RTC_PAGE_MSG_TYPE__:"RTC-SD-PAGE",__RTC_EXT_MSG_TYPE__:"RTC-SD-EXT",__init__:function(){var e=this;e.__extLoaded=e.rsdExtLoaded(),e.__extLoaded&&e.__onRsdExtLoad(),window.addEventListener("load",function(t){if(!e.__extLoaded){var n=e.rsdExtLoaded();e.__extLoaded=n}}),window.addEventListener("message",function(t){if(t.data){var n=t.data;n.type&&n.type===e.__RTC_EXT_MSG_TYPE__&&n.evname&&(o.info("got ext-msg: ",n),"extLoaded"!==n.evname?e.__onMessage(n):e.__extLoaded||(e.__extLoaded=!0,setTimeout(e.__onRsdExtLoad(),50)))}})},rsdExtLoaded:function(){return!!document.getElementById("RTC-Share-Deskto-installed-ele-rat1abrr")},__sendMessage:function(e,t){var n=this,s="tsx_"+__shareDesktopMessageCount__+++"_"+Math.random().toString(36).substr(2,4);if(!n.__extLoaded)throw"Rtc share desktop not loaded";e.tsxId=s,n["on_"+s]=function(){t&&t.apply(n,arguments),delete n["on_"+s]},window.postMessage(e,"*")},__onMessage:function(e){var t=this,n=e.tsxId;t["on_"+n]&&t["on_"+n](e)},__onRsdExtLoad:function(){var e=this;e.onExtLoaded&&e.onExtLoaded()},openDesktopMedia:function(e,t){var n=this;if(n.__extLoaded&&n.rsdExtLoaded()){var s={type:n.__RTC_PAGE_MSG_TYPE__,evname:"chooseDesktopMedia",screenOptions:e};n.__sendMessage(s,function(e){t("onAccessApproved"===e.evname&&e.streamId?new r.OpenDesktopMedia({desktopStreamId:e.streamId}):new r.OpenDesktopMediaAccessDenied)})}else t(new r.ShareDesktopExtensionNotFound)}})}]);