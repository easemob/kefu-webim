!function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={exports:{},id:r,loaded:!1};return e[r].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var n={};return t.m=e,t.c=n,t.p="",t(0)}([function(e,t){!function(e){function t(r){if(n[r])return n[r].exports;var s=n[r]={exports:{},id:r,loaded:!1};return e[r].call(s.exports,s,s.exports,t),s.loaded=!0,s.exports}var n={};return t.m=e,t.c=n,t.p="./",t(0)}([function(e,t,n){e.exports=n(3)},,,function(e,t,n){var r,s,o;(function(e){"use strict";var i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},c=n(5);window.emedia=window.emedia||{},emedia.util=c,emedia.config=function(e){e=c.extend({},e);for(var t in e)emedia.config[t]=e[t],"logLevel"===t&&(emedia.LOG_LEVEL=e[t])},emedia.config({autoSub:!0,onlyEnter:!1,reconnect:13,reconnectDelay:3e3,getCopyIntervalMillis:17e3,checkConnectIntervalMillis:1e3,iceRebuildCount:3,iceRebuildIntervalMillis:500,enterTimeout:2e4});var a=n(6),d=n(8);emedia.Service=a,emedia.event=d,function(n,c){"object"===i(e)&&"object"===i(e.exports)?e.exports=c():(s=[],r=c,o="function"==typeof r?r.apply(t,s):r,!(void 0!==o&&(e.exports=o)))}(void 0,function(){return emedia}),/Chrome/.test(navigator.userAgent)&&(emedia.supportPRAnswer=navigator.userAgent.split("Chrome/")[1].split(".")[0]>=50),emedia.LOG_LEVEL=0,emedia.isWebRTC=(/Firefox/.test(navigator.userAgent)||/WebKit/.test(navigator.userAgent))&&/^https\:$/.test(window.location.protocol),emedia.isFirefox=/Firefox/.test(navigator.userAgent),emedia.isChrome=/Chrome/.test(navigator.userAgent),emedia.isSafari=!/Chrome/.test(navigator.userAgent)&&/Safari/.test(navigator.userAgent),emedia.config({baseAcptOps:[107,300,302,303,304,301,204,206,400,401,1001,100201,100202,100203]}),emedia.config({clientType:"WEB",version:"1.1.2",userAgent:navigator.userAgent,acptOps:[]})}).call(t,n(4)(e))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children=[],e.webpackPolyfill=1),e}},function(e,t){"use strict";function n(){}var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(){var e="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split("");Math.uuid=function(t,n){var r,s=e,o=[];if(n=n||s.length,t)for(r=0;r<t;r++)o[r]=s[0|Math.random()*n];else{var i;for(o[8]=o[13]=o[18]=o[23]="-",o[14]="4",r=0;r<36;r++)o[r]||(i=0|16*Math.random(),o[r]=s[19==r?3&i|8:i])}return o.join("")},Math.uuidFast=function(){for(var t,n=e,r=new Array(36),s=0,o=0;o<36;o++)8==o||13==o||18==o||23==o?r[o]="-":14==o?r[o]="4":(s<=2&&(s=33554432+16777216*Math.random()|0),t=15&s,s>>=4,r[o]=n[19==o?3&t|8:t]);return r.join("")},Math.uuidCompact=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0,n="x"==e?t:3&t|8;return n.toString(16)})}}();var s=function(e){function t(t,r){if(!(emedia&&emedia.LOG_LEVEL&&t<emedia.LOG_LEVEL)){var s=[];s.push(t),s.push(e||"");for(var o=0;o<r.length;o++)s.push(r[o]);n.log.apply(n,s)}}var n=this,r={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,FATAL:5},s=["TRACE","DEBUG","INFO","WARN","ERROR","FATAL"];this.log=function(){var e=arguments[0];e=arguments[0]=s[e],console.log.apply(console,arguments)},this.trace=function(){this.log&&t(r.TRACE,arguments)},this.debug=function(){this.log&&t(r.DEBUG,arguments)},this.info=function(){this.log&&t(r.INFO,arguments)},this.warn=function(){this.log&&t(r.WARN,arguments)},this.error=function(){this.log&&t(r.ERROR,arguments)},this.fatal=function(){this.log&&t(r.FATAL,arguments)}};n.prototype.logger=new s,n.prototype.tagLogger=function(e){return new s(e)},n.prototype.parseJSON=function(e){return JSON.parse(e)};var o=(n.prototype.stringifyJSON=function(e){return JSON.stringify(e)},{}),i=o.toString,c=o.hasOwnProperty,a=c.toString,d=a.call(Object);n.prototype.isPlainObject=function(e){var t,n;return!(!e||"[object Object]"!==i.call(e))&&(!(t=Object.getPrototypeOf(e))||(n=c.call(t,"constructor")&&t.constructor,"function"==typeof n&&a.call(n)===d))};n.prototype.isArray=Array.isArray,n.prototype.isEmptyObject=function(e){var t;for(t in e)return!1;return!0},n.prototype.type=function(e){return null==e?e+"":"object"===("undefined"==typeof e?"undefined":r(e))||"function"==typeof e?o[i.call(e)]||"object":"undefined"==typeof e?"undefined":r(e)},n.prototype.extend=function(){var e,t,n,s,o,i,c=this,a=arguments[0]||{},d=1,u=arguments.length,f=!1;for("boolean"==typeof a&&(f=a,a=arguments[d]||{},d++),"object"===("undefined"==typeof a?"undefined":r(a))||c.isFunction(a)||(a={}),d===u&&(a=this,d--);d<u;d++)if(null!=(e=arguments[d]))for(t in e)n=a[t],s=e[t],a!==s&&(f&&s&&(c.isPlainObject(s)||(o=c.isArray(s)))?(o?(o=!1,i=n&&c.isArray(n)?n:[]):i=n&&c.isPlainObject(n)?n:{},a[t]=c.extend(f,i,s)):void 0!==s&&(a[t]=s));return a},n.prototype.removeAttribute=function(e,t){var n=e[t];return delete e[t],n},n.prototype.prototypeExtend=n.prototype.classExtend=function(){function e(){for(var e=0;e<arguments.length;e++){var n=arguments[e]||{};t.extend(!0,this,n)}this.__init__&&this.__init__()}for(var t=this,n=0;n<arguments.length;n++){var r=arguments[n]||{};"function"==typeof r&&(r=r.prototype),t.extend(!0,e.prototype,r)}return e.extend||(e.extend=function(n){return t.prototypeExtend(e,n)}),e},n.prototype.hasLocalStorage=function(e){return null!=localStorage.getItem(e)&&"{}"!=localStorage.getItem(e)},n.prototype.toggleClass=function(e,t){return e.hasClass(t)?void e.removeClass(t):void e.addClass(t)},n.prototype.setCookie=function(e,t,n){var r=new Date;r.setTime(r.getTime()+60*n*60*1e3),document.cookie=e+"="+escape(t)+";expires="+r.toGMTString()},n.prototype.getCookie=function(e){var t=document.cookie.match(new RegExp("(^| )"+e+"=([^;]*)(;|$)"));return null!=t?unescape(t[2]):null},n.prototype.parseURL=function(e){var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)","i"),n=window.location.search.substr(1).match(t);return null!=n?unescape(n[2]):null},n.prototype.forEach=function(e,t){if(e&&!this.isEmptyObject(e)){e=e||{};var n=this.extend(!1,{},e);for(var r in n)t(r,e[r])}},e.exports=new n},function(e,t,n){"use strict";var r=n(5),s=r.tagLogger("Service"),o=n(7),i=n(9),c=n(8),a=n(13),d=n(14),u=new d({onExtLoaded:function(){s.info("Share desktop ext. had loaded.")}}),f=n(12);e.exports=r.prototypeExtend({__init__:function(){var e=this,t=r.parseURL("__log_level___");t&&(emedia.LOG_LEVEL=parseInt(t)),e.namespace=Math.uuidFast(),window.__easemob_current_mservice=this},AVPubstream:f.extend({__init__:function(){var e=this;e.type=0,e._located=!0,e.constaints&&(e.constaints.video||(e.voff=1),e.constaints.audio||(e.aoff=1)),e.constaints||(e.constaints={audio:!0,video:!0})}}),ShareDesktopPubstream:f.extend({__init__:function(){var e=this;e.type=1,e._located=!0}}),__assertCurrent:function(){var e=this;if(!e.current)throw"Please call emedia.service.setup(ticket)";if(e.current.closed)throw"current closed"},openUserMedia:function(e){var t=this;if(!e)throw"require pubS";return{then:function(n,r){if(e instanceof t.AVPubstream)t._openCamera(e,n,r);else{if(!(e instanceof t.ShareDesktopPubstream))throw"Unspported pubS";t._openSharedDesktop(e,n,r)}}}},_openSharedDesktop:function(e,t,n){var r=this;u.openDesktopMedia(null,function(o){if(o instanceof c.OpenDesktopMedia){var i=o.desktopStreamId;s.warn("desktop streamId",i);var a={audio:!1,video:{mandatory:e.mandatory||{chromeMediaSource:"desktop",chromeMediaSourceId:i,maxWidth:window.screen.width>1920?window.screen.width:1920,maxHeight:window.screen.height>1080?window.screen.height:1080},optional:[]}};delete e.mandatory,r.__getUserMedia(a,function(n,s){e.localStream=s,t&&t(r.current,s)},n)}else r.current&&r.current.onEvent(new c.ShareDesktopExtensionNotFound({member:r.current})),n&&n(o)})},_openCamera:function(e,t,n){var r=this,s=e.constaints||{audio:!0,video:!0};r.__getUserMedia(s,function(n,s){r.__controlStream(e,s),e.localStream=s,t&&t(r.current,s)},n)},__controlStream:function(e,t){t&&t.getVideoTracks().forEach(function(t){t.enabled=!e.voff}),t&&t.getAudioTracks().forEach(function(t){t.enabled=!e.aoff})},__getUserMedia:function(e,t,n){var r,o=this;navigator.mediaDevices.getUserMedia(e).then(function(e){r=e;var n=e.getVideoTracks(),i=e.getAudioTracks();n.length>0&&s.debug("Using video device: "+n[0].label),i.length>0&&s.debug("Using audio device: "+i[0].label),t&&t(o.current,e)}).catch(function(e){s.debug("[WebRTC-API] getUserMedia() error: ",e),r&&r.getTracks().forEach(function(e){e.stop()}),o.current&&o.current.onEvent(new c.OpenMediaError({member:o.current,event:e})),n&&n(new c.OpenMediaError({member:o.current,event:e}))})},setup:function(e,t){var n=this;s.debug("recv ticket",e,t),t=t||{};var o=t;if(r.isPlainObject(t))t=JSON.stringify(t);else try{o=JSON.parse(t)}catch(d){}"string"==typeof e&&(e=JSON.parse(e));var u=e.memName;if(n.current&&!n.current.closed){var f=new c.CurrentCalling;throw n.current.onEvent(f),f}var l=i.extend(a),m=n.current=new l({autoSub:emedia.config.autoSub,getCopyIntervalMillis:emedia.config.getCopyIntervalMillis,sysUserId:u,resource:n.resource,nickName:n.nickName,ticket:e,ext:t,extObj:o,sessionFactory:function(){return n.newSession(this,e)}},n.listeners||{});return m},exit:function(e){this.current&&this.current.exit(e)},join:function(e,t){s.debug("begin join ...");var n=this;n.__assertCurrent(),n.current._session._sessionId=void 0,n.current.join(e,t)},withpublish:function(e){var t=this;if(!e||!e.localStream)throw"pubS null or stream not open";return t.__assertCurrent(),t.current._session._sessionId=void 0,t.current.withpublish(e)},push:function(e,t,n){s.debug("begin push ...");var r=this;if(2===arguments.length&&(n=t,t=void 0),!e||!e.localStream)throw"pubS or stream open";r.__assertCurrent(),r.current.push(e,t,n,!1)},subscribe:function(e,t,n,s){var o=this;o.__assertCurrent(),2==arguments.length&&(n=t,t=void 0),t&&r.isPlainObject(t)&&(s=t,t=void 0),n&&r.isPlainObject(n)&&(s=n,n=void 0),s||(s={subSVideo:!0,subSAudio:!0});var i=o.current._getWebrtc(e);return i&&i.isConnected()&&!emedia.isSafari?void o.current.subscribeStream(i._rtcId,e,n,s):(i&&o.current.closeWebrtc(i.getRtcId(),!0,!1),void o.current.createWebrtcAndSubscribeStream(e,{onGotRemote:function(e){t&&t(e)},onEvent:function(e){n&&n(e)}},void 0,s))},closePubstream:function(e){e.located()&&(e._localMediaStream&&e._localMediaStream.getTracks().forEach(function(e){e.stop()}),e.localStream&&e.localStream.getTracks().forEach(function(e){e.stop()}))},hungup:function(e){var t=this;t.__assertCurrent();var n=t.current,r=n._cacheStreams[e],s=r.rtcId;if(s&&(n.closeWebrtc(s),r.located()&&(1!==r.type&&r._localMediaStream&&r._localMediaStream.getTracks().forEach(function(e){e.stop()}),n._cacheStreams[e]&&n.onRemoveStream(r),delete n._cacheStreams[e])),r&&!r.located()){n._linkedStreams[r.id]&&delete n._linkedStreams[r.id];var o=new f(r);o.rtcId=void 0,o._webrtc=void 0,o.mediaStream=null,n.onUpdateStream(o,new o.Update(o))}},freezeFrameRemote:function(e,t,n){var r=this;r.__assertCurrent();var s=r.current,o=s._linkedStreams[e];if(!o||o.located())throw e+" not exsits or locate, not connect";var i=!o.freezeFrame,a={op2:20,streamId:e,frz:i?1:0},d=s.newMessage({op:1002,memId:o.owner.id,arg:JSON.stringify(a),_reqOps:[100204]});o.freezeFrame=i,s.postMessage(d,function(e){if(0!=e.result){var r=new c.RemoteControlFail({stream:o,failed:e.result,cause:e.msg});return s.onEvent(r),o.freezeFrame=!o.freezeFrame,void(n&&n(r,o.freezeFrame))}t&&t(o.freezeFrame)})},capturePictureRemote:function(e,t,n,r){var s=this;s.__assertCurrent();var o=s.current,i=o._linkedStreams[e];if(!i||i.located())throw e+" not exsits or locate, not connect";var a={op2:20,streamId:e,pic:1,rspBase64Pic:!0};t&&(a.rspBase64Pic=!0);var d=o.newMessage({op:1002,memId:i.owner.id,arg:JSON.stringify(a),_reqOps:[100205]});o.postMessage(d,function(e){if(0!=e.result){var s=new c.RemoteControlFail({stream:i,failed:e.result,cause:e.msg});return o.onEvent(s),void(r&&r(s))}if(!t)return void(n&&n());if(!e.arg)return void(r&&r(new c.RemoteControlFail({stream:i,failed:e.result,cause:"Not found base64 pic"})));var a=JSON.parse(e.arg);n&&n(a.pic)})},zoomRemote:function(e,t,n){var r=this;r.__assertCurrent();var s=r.current,o=s._linkedStreams[e];if(!o||o.located())throw e+" not exsits or locate, not connect";o._zoom||(o._zoom=1);var i=o._zoom*t;if(!(i<1)){o._zoom=i;var a={op2:20,streamId:e,zoom:Math.round(1e4*i)},d=s.newMessage({op:1002,memId:o.owner.id,arg:JSON.stringify(a),_reqOps:[100201]});s.postMessage(d,function(e){if(0!=e.result){var t=new c.RemoteControlFail({stream:o,failed:e.result,cause:e.msg});return s.onEvent(t),void(n&&n(t))}})}},_getPosition:function(e){for(var t=0,n=0;e;)n+=e.offsetLeft,t+=e.offsetTop,e=e.offsetParent;return{clientX:n,clientY:t}},focusExpoRemote:function(e,t,n,r){var o=this,i=n||window.event,c=document.documentElement.scrollLeft||document.body.scrollLeft,a=document.documentElement.scrollTop||document.body.scrollTop,d=i.pageX||i.clientX+c,u=i.pageY||i.clientY+a,f=o._getPosition(t);s.info("Video tag position ",f.clientX,":",f.clientY);var l=t.videoWidth,m=t.videoHeight;if(m>l){var p=l/m;m=t.offsetHeight,l=m*p,f.clientX+=(t.offsetWidth-l)/2}else{var p=m/l;l=t.offsetWidth,m=l*p,f.clientY+=(t.offsetHeight-m)/2}s.info("Media position ",f.clientX,":",f.clientY),s.info("Media xy ",l,":",m),s.info("Click position ",d,":",u),o._focusExpo(e,l,m,d-f.clientX,u-f.clientY,r)},_focusExpo:function(e,t,n,r,s,o){var i=this;if(!(r<=0||r>t||s<=0||s>n)){i.__assertCurrent();var a=i.current,d=a._linkedStreams[e];if(!d||d.located())throw e+" not exsits or locate, not connect";var u={op2:20,streamId:e,focus:1,expo:1,x:0===t?0:Math.round(1e4*r/t),y:0===n?0:Math.round(1e4*s/n)},f=a.newMessage({op:1002,memId:d.owner.id,arg:JSON.stringify(u),_reqOps:[100202,100203]});a.postMessage(f,function(e){if(0!=e.result){var t=new c.RemoteControlFail({stream:d,failed:e.result,cause:e.msg});return a.onEvent(t),void(o&&o(t))}})}},_republish:function(e,t,n){var r,s=this;if(e.id){var o=s.current.__getWebrtcFor(e.id);o&&s.current.closeWebrtc(o,!0),r=s.current._getWebrtc(e.id)}e._localMediaStream&&e._localMediaStream.getTracks().forEach(function(e){e.stop()}),setTimeout(function(){var o=new s.AVPubstream(e);s.openUserMedia(o).then(function(){e.localStream=o.localStream,e.isRepublished=!0,e.optimalVideoCodecs=e.optimalVideoCodecs||r&&r.optimalVideoCodecs,s.push(e,t,n)},n)},500)},voff:function(e,t,n){function r(){e.getMediaStream()&&e.getMediaStream().getVideoTracks().forEach(function(e){e.enabled=!t}),s.current&&s.current.voff(e,t)}var s=this;return t=t?1:0,e.voff=t,e.constaints&&!e.constaints.video?(e.constaints.video=!0,void s._republish(e,function(){r()},function(t){t instanceof emedia.event.OpenMediaError&&(e.constaints.video=!1),n&&n(t)})):void r()},aoff:function(e,t,n){function r(){e.getMediaStream()&&e.getMediaStream().getAudioTracks().forEach(function(e){e.enabled=!t}),s.current&&s.current.aoff(e,t)}var s=this;return t=t?1:0,e.aoff=t,e.constaints&&!e.constaints.audio?(e.constaints.audio=!0,void s._republish(e,function(){r()},function(t){t instanceof emedia.event.OpenMediaError&&(e.constaints.audio=!1),n&&n(t)})):void r()},iceing:function(e){var t=this;return r.isPlainObject(t.current._linkedStreams[e])},recording:function(e){var t=this;return r.isPlainObject(t.current._records[e])},startRecord:function(e,t){var n=this,r=n.current._linkedStreams[e];if(!r)throw e+" not at linked streams";r._webrtc||t&&t(!1),n.current.startRecord(r,t)},stopRecord:function(e,t){var n=this,r=n.current._records[e];if(!r)throw e+" not at recording streams";n.current.stopRecord(r,t)},getCurrentMembers:function(){var e=this;return e.current.getCurrentMembers()},newSession:function(e,t){var n=new o({ticket:t,owner:e,onTcklC:function(t){e.onTcklC(t.rtcId,t.cands)},onAcptC:function(t){e.onAcptC(t.rtcId,t.sdp,t.cands)},onAnsC:function(t){e.onAnsC(t.rtcId,t.sdp,t.cands)},onTermC:function(t){s.info("Server termc rtc: ",t.rtcId,t.message||t.msg),21===t.endReason||22===t.endReason?r.forEach(e._cacheStreams,function(n,r){if(r.rtcId===t.rtcId){var s;s=21===t.endReason?new emedia.event.SwitchVCodes({stream:r,useVCodes:t.useVCodes}):new emedia.event.SubFailNotSupportVCodes({stream:r}),e.onEvent(s)}}):e.closeWebrtc(t.rtcId,!1,!0)},onEnter:function(t){e.onEnter(t.cver,t.mem)},onExit:function(t){e.onExit(t.cver,t.memId,t.reason)},onPub:function(t){e.onPub(t.cver,t.memId,t.pubS)},onUnpub:function(t){e.onUnpub(t.cver,t.memId,t.pubSId)},onMems:function(e){},onClose:function(t){e.onClose(t.cver,t.confrId)},onEvent:function(t){e.onEvent(t)},onStreamControl:function(t){e.onStreamControl(t.cver,t.streamId,t.voff,t.aoff)},onRemoteControl:function(t){s.error("Web not support remote control");var n=e.newMessage({op:1001,tsxId:t.tsxId,memId:t.memId,arg:t.arg,result:-507,msg:"Web not support the remote control."});e.postMessage(n,function(e){s.error("Send remote control response. the result = ",e.result,e.msg||"")})}});return n}})},function(e,t,n){"use strict";function r(e,t,n){function r(e,r){try{u.onWebsocketEvent(new c.WSClose({url:u.thisWsUri,retry:n,online:u.online,cause:e,event:r,session:u}))}finally{t&&t(new c.WSClose({url:u.thisWsUri,retry:n,online:u.online,cause:e,event:r,session:u}))}}function s(e){if(!u.connected(u.thisWsUri))return void i.debug("current dont connect. the message = ",e);if(o.isPlainObject(e)&&!(e instanceof d))throw"message not a Messages";return u.sessId&&e.sessId!=u.sessId?void i.info("self.sessId && message.sessId != self.sessId",e):(u.thisWsUri===u._websocket.url&&u._websocket.send(JSON.stringify(e)),u.thisWsUri===u._websocket.url&&i.info("Done send: req:",e,u._websocket.url),void(u.thisWsUri===u._websocket.url||i.info("Donot send(url not equal): req:",e,u._websocket.url)))}function a(){if(u.connected(u.thisWsUri)){if(0===u._bufferedMessages.length)return;for(var e,t=[];e=u._bufferedMessages.shift();)if(e.sessId||u.sessId||200==e.op){if(200===e.op){s(e);break}u.sessId&&!e.sessId&&(e.sessId=u.sessId);var r=s(e);r&&t.push(r)}else t.push(e);t.length>0&&Array.prototype.push.apply(u._bufferedMessages,t)}else if(0!==n&&u.online){if(!u.connected()){var i=o.extend(!1,{},u._callbacks);for(var c in i){var a=i[c];102!==a.op&&105!==a.op&&1e3!==a.op||u.onMessage({op:1001,tsxId:c,result:-9527,msg:"websocket disconnect",retrying:!0})}}}else{var i=o.extend(!1,{},u._callbacks),d=[];for(var c in i){var a=i[c];!(n>0)||u.online||107!==a.op&&201!==a.op&&204!==a.op&&206!==a.op&&400!==a.op&&500!==a.op?u.onMessage({op:1001,tsxId:c,result:-9527,msg:"sdk rsp fail. retry fail or online = "+u.online}):d.push(a)}u._bufferedMessages=u._bufferedMessages||[],d.length>0&&Array.prototype.push.apply(u._bufferedMessages,d)}}var u=this;if(u.connected(u.thisWsUri))return e&&e(u),i.info("Session connected. dont continue connect"),void(u.notifyNewMessage&&u.notifyNewMessage());if(!u.online)return void r();u.notifyNewMessage=a,i.info("Session begin connect.");var f=u._websocket;f&&(i.warn("will close. websocket state",f.readyState,f.url,u.thisWsUri),f.close(1e3));try{i.warn("Connecting",u.thisWsUri,n),f=u._websocket=new WebSocket(u.thisWsUri)}catch(l){return i.error(l),void r(l)}f.onopen=function(n){var r=this.url;if(r!==u.thisWsUri)return void i.error("ignore the onopen. caused by websocket url not ",u.thisWsUri,r);try{i.info("websocket connected:",r),t&&(t=null),e&&e(u),u.onWebsocketEvent(new c.WSConnected({event:n,session:u}))}finally{}},f.onmessage=function(e){var t=this.url;if(t!==u.thisWsUri)return void i.error("ignore recv data. caused by websocket url not ",u.thisWsUri,t,e.data);i.debug("recv data",e.data);var n=JSON.parse(e.data);n&&1001==n.op&&i.debug("recv message: rsp:",n),n&&1001!=n.op&&i.info("recv message: evt:",n),u.onMessage(n)},f.onclose=function(e){var t=this.url;return i.info("Disconnected:",t,u.thisWsUri,e),t!==u.thisWsUri?void i.error("ignore onclose. caused by websocket url not ",u.thisWsUri,t):(u.notifyNewMessage(),void(1e3!==e.code&&r(void 0,e)))},f.onerror=function(e){i.info("On error:",e),u.onWebsocketEvent(new c.WSError({event:e,online:u.online,session:u,url:this.url}))}}var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},o=n(5),i=o.tagLogger("Sess"),c=n(8),a=0,d=o.prototypeExtend({setSessId:function(e){return e&&(this.sessId=e),this},setOp:function(e){return e&&(this.op=e),200===e&&(this.res={type:emedia.config.clientType,ver:emedia.config.version,agent:emedia.config.userAgent,ops:emedia.config.acptOps}),this},setTsxId:function(e){return e&&(this.tsxId=e),this},setTicket:function(e){return e&&(this.tkt=e),this},setSdp:function(e){return e&&(this.sdp=e),this},setCands:function(e){return e&&(this.cands=e),this},setSubSId:function(e){return e&&(this.subSId=e),this},setPubS:function(e){e&&(this.pubS=o.extend(!1,{},e));var t=this.pubS;return t.ext&&o.isPlainObject(t.ext)&&(t.ext=JSON.stringify(t.ext)),t&&o.forEach(t,function(e,n){(o.isPlainObject(n)||"function"==typeof n)&&o.removeAttribute(t,e)}),t&&o.removeAttribute(t,"localStream"),t&&o.removeAttribute(t,"_localMediaStream"),t&&o.removeAttribute(t,"_webrtc"),this},setRtcId:function(e){return e&&(this.rtcId=e),this},setCver:function(e){return e&&(this.cver=e),this},setEndReason:function(e){return e&&(this.endReason=e),this},setNickName:function(e){return e&&(this.nickName=e),this},setResource:function(e){return e&&(this.resource=e),this},setReason:function(e){return e&&(this.reason=e),this},setConfrId:function(e){return e&&(this.confrId=e),this},setVoff:function(e){return"undefined"==typeof e||(this.voff=e?1:0),this},setAoff:function(e){return"undefined"==typeof e||(this.aoff=e?1:0),this},setFlag:function(e){return 0===e&&(this.flag=0),1===e&&(this.flag=1),this},setExt:function(e){return e&&o.isPlainObject(e)&&(e=JSON.stringify(e)),e&&(this.ext=e),this}});window.__session_globalCount=0,e.exports=o.prototypeExtend({_events:{0:"onReqP2P",1:"onNewCfr",2:"onDelCfr",3:"onReqTkt",100:"onPing",101:"onPong",102:"onInitC",103:"onReqC",104:"onAcptC",105:"onTcklC",106:"onAnsC",107:"onTermC",300:"onEnter",301:"onExit",302:"onPub",303:"onUnpub",304:"onMems",204:"onClose",400:"onStreamControl",401:"onJoin",1002:"onRemoteControl"},__init__:function(){function e(){navigator.onLine?r.online=!0:r.online=!1}function t(e){r.online=!0,i.warn("online online online"),r.closed||r._reconnect(emedia.config.reconnect)}function n(e){r.online=!1,i.warn("offline offline offline"),r.__checkConnectIntervalId&&clearTimeout(r.__checkConnectIntervalId),r.__retryConnectIntervalId&&clearTimeout(r.__retryConnectIntervalId),r.__retryConnectIntervalId&&delete r.__retryConnectIntervalId,r._websocket&&r._websocket.close(1e3)}var r=this;r._bufferedMessages=[],r._callbacks={},e(),window.addEventListener("online",t,!0),window.addEventListener("offline",n,!0),i.warn("online status = ",r.online)},_nextWsUri:function(){var e=this,t=e.ticket.url;return t+=t.indexOf("?")>=0?"&"+a++:"?"+a++},_reconnect:function(e){function t(){i.warn("Reconnected. at ",e,r._websocket.url),r.__retryConnectIntervalId&&clearTimeout(r.__retryConnectIntervalId),r.__retryConnectIntervalId&&delete r.__retryConnectIntervalId;var t=r.newMessage().setOp(200).setSessId(r._sessionId).setTicket(r.ticket).setNickName(r.nickName||r.ticket.memName).setResource(r.resource).setExt(r.owner.ext);r.postMessage(t,function(e){if(0==e.result)r.onEvent(new c.EnterSuccess),r.owner.onMembers(e.cver,e.mems),r.owner.onStreams(e.cver,e.streams),r.notifyNewMessage();else try{r.onEvent(new c.EnterFail({me:r.owner,cause:new c.RspFail({request:t,response:e})}))}finally{e.result!==-9527&&r.onEvent(new c.ServerRefuseEnter({failed:e.result,msg:e.msg}))}})}function n(s){return e<=0?(i.warn("Reconnect end. but fail.",s.url,e),void(r.__retryConnectIntervalId&&delete r.__retryConnectIntervalId)):void(e&&(r.__retryConnectIntervalId=setTimeout(function(){r.connect(t,n,--e)},emedia.config.reconnectDelay)))}var r=this;r.connect(t,n,--e)},__checkConnect:function(){var e=this;e.__checkConnectIntervalId&&clearTimeout(e.__checkConnectIntervalId),emedia.config.checkConnectIntervalMillis&&(e.__checkConnectIntervalId=setTimeout(function(){try{e.online&&!e.connected()&&(e.__retryConnectIntervalId&&i.debug("online, reconnecting..."),e.__retryConnectIntervalId||i.debug("online, but disconnect. will reconnect"),e.__retryConnectIntervalId||e._reconnect(emedia.config.reconnect))}finally{e.__checkConnect()}},emedia.config.checkConnectIntervalMillis))},connect:function(e,t,n){function s(){try{e.apply(a,arguments)}finally{a.__checkConnect()}}function o(e){try{t.apply(a,arguments)}finally{n||e.url!==d||a.onEvent(new c.ServerRefuseEnter({failed:-95270,msg:"sdk reconnect fail. "+d+"|"+e.url}))}}var a=this,d=a.thisWsUri=a._nextWsUri();"undefined"!=typeof n&&i.warn("begin connect... at retry = ",n,d),r.call(a,s,o,n)},connected:function(e){var t=this,n=t.online&&t._websocket&&(!e||e===t._websocket.url)&&t._websocket.readyState==WebSocket.OPEN;return n},onWebsocketEvent:function(e){var t=this;t.onEvent(e)},register:function(e){if("object"===("undefined"==typeof e?"undefined":s(e)))for(var t in e)this.bind(t,e[t])},bind:function(e,t){var n,r=this;if(!(n=r._events[e]))throw"Not supported event = "+e;r[n]=t},getSessionId:function(){return this._sessionId},newMessage:function(e){return new d(e)},__modifyMessage:function(e){if(e&&e.sdp&&("string"==typeof e.sdp&&(e.sdp=o.parseJSON(e.sdp)),e.sdp.type&&(e.sdp.type=e.sdp.type.toLowerCase())),e&&e.cands){"string"==typeof e.cands&&(e.cands=o.parseJSON(e.cands));for(var t=0;t<e.cands.length;t++)"string"==typeof e.cands[t]&&(e.cands[t]=o.parseJSON(e.cands[t])),e.cands[t].sdpMLineIndex=e.cands[t].mlineindex,e.cands[t].sdpMid=e.cands[t].mid,delete e.cands[t].mlineindex,delete e.cands[t].mid}if(e&&e.mems){if(!o.isArray(e.mems))return;var n=e.mems;e.mems={},o.forEach(n,function(t,n){e.mems[n.id]=n;var r=n.acptOps={};if(o.forEach(emedia.config.baseAcptOps,function(e,t){r[t]=!0}),n.res&&o.forEach(n.res.ops,function(e,t){r[t]=!0}),n&&n.ext)try{e.mems[n.id].ext=JSON.parse(n.ext)}catch(s){i.error(s)}})}if(e&&e.mem){var r=e.mem.acptOps={};if(o.forEach(emedia.config.baseAcptOps,function(e,t){r[t]=!0}),e.mem.res&&o.forEach(e.mem.res.ops,function(e,t){r[t]=!0}),e.mem&&e.mem.ext)try{e.mem.ext=JSON.parse(e.mem.ext)}catch(s){i.error(s)}}if(e&&e.streams){if(!o.isArray(e.streams))return;var c=e.streams;e.streams={},o.forEach(c,function(t,n){if(e.streams[n.id]=n,n&&n.ext)try{e.streams[n.id].ext=JSON.parse(n.ext)}catch(r){i.error(r)}})}if(e&&e.pubS&&e.pubS&&e.pubS.ext)try{e.pubS.ext=JSON.parse(e.pubS.ext)}catch(s){i.error(s)}if(e&&e.ext)try{e.ext=JSON.parse(e.ext)}catch(s){i.error(s)}},onMessage:function(e){var t=this;if(1001!=e.op&&!e.sessId)throw"message sessId error. server evt data error";if(1001!=e.op&&t._sessionId&&t._sessionId!=e.sessId)throw"message sessId error. server and local not equal";t.__modifyMessage(e);var n=o.removeAttribute(t._callbacks,e.tsxId);if(n&&200===n.op)if(t._sessionId=e.sessId,0===e.result){for(var r in t._bufferedMessages){var s=t._bufferedMessages[r];s.sessId||200===s.op||(s.sessId=e.sessId)}setTimeout(function(){t.notifyNewMessage()},100)}else for(var a;a=t._bufferedMessages.shift();)200!==a.op&&t.onMessage({op:1001,tsxId:a.tsxId,result:-9527,msg:"sdk enter fail. sdk callback. enter result = "+e.result});if(t.onEvent(new c.RecvResponse({request:n,response:e})),n&&n.__callback__)return void n.__callback__(e);if(!e.op||1001==e.op)return void i.trace("Igron message. caused by op not found.",e);var d,u=e.op;if(!(d=t._events[u])||!(d=t[d]))throw e;d(e)},__modifyMessageForPost:function(e){if(e.cands){for(var t=[],n=e.cands,r=0;r<n.length;r++){var s;s="string"==typeof n[r]?{type:"candidate",candidate:n[r],mlineindex:0,mid:"audio"}:{type:"candidate",candidate:n[r].candidate,mlineindex:n[r].sdpMLineIndex,mid:n[r].sdpMid},t.push(s)}e.cands=t}if(e.sdp&&o.isPlainObject(e.sdp)){var i={type:e.sdp.type,sdp:e.sdp.sdp};e.sdp=i,e.sdp.type=e.sdp.type.toUpperCase(),e.sdp=o.stringifyJSON(e.sdp)}return e},postMessage:function(e,t){var n=this;if(e.tsxId||e.setTsxId("MSG"+Date.now()+"-"+__session_globalCount++),e.memId){var r=n.owner._cacheMembers[e.memId];if(!r)return void(t&&t({op:1001,tsxId:e.tsxId,result:-507,msg:" member not found at local. memberId = "+e.memId}));var s=e._reqOps;s||(s=[],s.push(e.op));for(var c in s){var a=s[c];if(!r.acptOps[a])return void(t&&t({op:1001,tsxId:e.tsxId,result:-507,msg:" member not accept op "+a+", "+e.memId}))}}return o.removeAttribute(e,"_reqOps"),n._sessionId&&n._sessionId!=e.sessId?void(t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"sessionId not excepted."})):n.closed?void(t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"session closed"})):(n.__modifyMessageForPost(e),200===e.op?(n._bufferedMessages.unshift(e),t&&setTimeout(function(){n._callbacks[e.tsxId]&&(i.error("Enter timeout. fail."),n.onMessage({op:1001,tsxId:e.tsxId,result:-9527,msg:"enter timeout. millis = "+emedia.config.enterTimeout}))},emedia.config.enterTimeout)):n._bufferedMessages.push(e),n._callbacks[e.tsxId]=o.extend(e,{__callback__:t}),void(n.notifyNewMessage&&n.notifyNewMessage()))},close:function(e){i.warn("sessiong closing, reason = ",e);var t=this;t.notifyNewMessage&&t.notifyNewMessage(),t.closed=!0,t.seqno=0,t._websocket&&(0==e||100==e?t._websocket.close(1e3):t._websocket.close()),t.__retryConnectIntervalId&&clearTimeout(t.__retryConnectIntervalId),t.__retryConnectIntervalId&&delete t.__retryConnectIntervalId,t.__checkConnectIntervalId&&clearTimeout(t.__checkConnectIntervalId),t.__checkConnectIntervalId&&delete t.__checkConnectIntervalId,t.owner=null,t._bufferedMessages=[],t._callbacks={},i.warn("session closed")}})},function(e,t,n){"use strict";var r=n(5),s=(r.logger,r.prototypeExtend({msg:"",__init__:function(){this.day=new Date},execTime:function(){var e=this.day.getHours();e<10&&(e="0"+e);var t=this.day.getMinutes();t<10&&(t="0"+t);var n=this.day.getSeconds();return n<10&&(n="0"+n),e+":"+t+":"+n}})),o=s.extend({_webrtcDesc:function(){var e=(this.webrtc,this.webrtc.getRtcId());return e}});e.exports={Exception:s.extend(),WSClose:s.extend({message:function i(){var i=this.execTime()+" WSClose: Websocket close ("+(this.retry||0)+").";return this.online||(i+=" offline."),this.event&&(i+=" wscode: "+this.event.code),this.cause&&(i+=" cause: "+this.cause.message),this.url&&(i+=" url: "+this.url),i+=" retry: "+(this.retry||0),this.session&&this.session.getSessionId()&&(i=i+", sess = "+this.session.getSessionId()),i}}),WSError:s.extend({message:function c(){var c=this.execTime()+" WSError: Websocket error. ready state:"+(this.event.srcElement&&this.event.srcElement.readyState||this.event.currentTarget.readyState)+". online = "+this.online;return this.session&&this.session.getSessionId()&&(c=c+", sess = "+this.session.getSessionId()),this.url&&(c+=" url: "+this.url),c}}),WSConnected:s.extend({message:function a(){var a=this.execTime()+" WSConnected: Websocket success. ready state:"+(this.event.srcElement&&this.event.srcElement.readyState||this.event.currentTarget.readyState);return this.session&&this.session.getSessionId()&&(a=a+", sess = "+this.session.getSessionId()),a}}),ICEChanage:o.extend({message:function(){return this.execTime()+" ICEChanage: "+this._webrtcDesc()+" state: "+this.state}}),AddIceCandError:o.extend({message:function(){return this.execTime()+" AddIceCandError: "+this._webrtcDesc()+", add cand error"}}),ICEConnectFail:o.extend({message:function(){return this.execTime()+" ICEConnectFail: "+this._webrtcDesc()+" failed"}}),ICEConnected:o.extend({message:function(){return this.execTime()+" ICEConnected: "+this._webrtcDesc()+" connected"}}),ICEDisconnected:o.extend({message:function(){return this.execTime()+" ICEDisconnected: "+this._webrtcDesc()+" disconnected"}}),ICEClosed:o.extend({
message:function(){return this.execTime()+" ICEClosed: "+this._webrtcDesc()+" closed"}}),ICERemoteMediaStream:o.extend({message:function(){return this.execTime()+" ICERemoteMediaStream: "+this._webrtcDesc()+" got remote stream"}}),StreamState:s.extend({message:function(){return this.execTime()+" StreamState:  stream "+this.stream.id+" state: "+this.state+" "+this.msg},iceFail:function(){this.state=1,this.msg="network anomaly. media lost"}}),OpenMediaError:s.extend({message:function(){return this.execTime()+" OpenMediaError:  open media error. caused by "+this.event.toString()}}),Hangup:s.extend({message:function(){return this.self?"hangup id = "+(this.self.id||"--")+" reason："+(this.reason||0):this.execTime()+" Hangup: "+(this.parnter&&(this.parnter.name||this.parnter.id||" ")||"")+" hangup, reason："+(this.reason||0)}}),ServerRefuseEnter:s.extend({message:function(){return this.execTime()+" ServerRefuseEnter: server refuse, cause："+this.failed+", msg:"+(this.msg||"")}}),RspFail:s.extend({__init__:function(){this.day=new Date,this.failed=this.response.result,this.msg=this.response.msg||this.response.message||"--"},message:function(){return this.execTime()+" RspFail: "+this.request.tsxId+", "+(this.response.sessId||"--")+" op: "+this.request.op+", cause: "+this.failed+" "+this.msg}}),RecvResponse:s.extend({__init__:function(){this.day=new Date,this.failed=this.response.result,this.msg=this.response.msg},message:function(){return this.request?this.execTime()+" RecvResponse: "+(this.request&&this.request.tsxId)+", "+(this.response.sessId||"--")+" op: "+(this.request&&this.request.op)+", cause: "+this.failed+" "+this.msg:this.execTime()+" RecvMessage: "+(this.response&&this.response.tsxId)+", "+(this.response.sessId||"--")+" op: "+(this.response&&this.response.op)+" "+this.msg}}),EnterFail:s.extend({message:function(){return this.execTime()+" EnterFail: enter fail："+(this.cause?this.cause.message():"unkown")}}),EnterSuccess:s.extend({message:function(){return this.execTime()+" EnterSuccess: enter success"}}),PushSuccess:s.extend({message:function(){return this.execTime()+" PushSuccess: push success, streamId = "+this.stream.id+", "+this.stream.optimalVideoCodecs+", webrtc = "+this.stream.rtcId}}),PushFail:s.extend({message:function(){return this.execTime()+" PushFail: push fail, streamId = "+this.stream.id+", "+this.stream.optimalVideoCodecs+", webrtc = "+this.stream.rtcId+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),RemoteControlFail:s.extend({message:function(){return this.execTime()+" RemoteControlFail: remote control fail, streamId = "+this.stream.id+" failed = "+this.failed+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubSuccess:s.extend({message:function(){return this.execTime()+" SubSuccess: sub success, streamId = "+this.stream.id+", "+this.stream.vcodes+", webrtc = "+this.stream.rtcId}}),SubFail:s.extend({message:function(){return this.execTime()+" SubFail: sub fail, streamId = "+this.stream.id+", "+this.stream.vcodes+", webrtc = "+this.stream.rtcId+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubFailNotSupportVCodes:s.extend({message:function(){return this.execTime()+" SubFailNotSupportVCodes: sub fail, streamId = "+this.stream.id+" cause："+(this.cause?this.cause.message?this.cause.message():this.cause:"unkown")}}),SubFailSafariNotAllowSubBeforePub:s.extend({message:function(){return this.execTime()+" SubFailSafariNotAllowSubBeforePub: sub fail, streamId = "+this.stream.id+" cause：Safari without access to capture devices, WebKit only exposes Server Reflexive and TURN ICE candidates, which expose IPs that could already be gathered by websites."}}),SwitchVCodes:s.extend({message:function(){return this.execTime()+" SwitchVCodes: pub streamId = "+this.stream.id}}),CurrentCalling:s.extend({message:function(){return this.execTime()+" CurrentCalling: warn! current calling..."}}),OpenDesktopMedia:s.extend({message:function(){return this.execTime()+" OpenDesktopMedia: shared desktop, desktopStreamId = "+desktopStreamId}}),OpenDesktopMediaAccessDenied:s.extend({message:function(){return this.execTime()+" OpenDesktopMediaAccessDenied: shared desktop not allow"}}),ShareDesktopExtensionNotFound:s.extend({message:function(){return this.execTime()+" ShareDesktopExtensionNotFound: shared desktop plugin required"}})}},function(e,t,n){"use strict";var r=n(5),s=r.tagLogger("Me"),o=n(10),i=n(8),c=n(12),a=o.extend({__init__:function(){var e=this;if(e._session||e.sessionFactory&&(e._session=e.sessionFactory()),!e._session)throw"Require session";e._cver=0,e._cacheMembers={},e._cacheStreams={},e._linkedStreams={},e._maybeNotExistStreams={},e._records={},e._ices={},e.closed=!1},getCurrentMembers:function(){var e=this,t=[];return r.forEach(e._cacheMembers,function(e,n){var s=r.extend(!0,{},n);t.push(s)}),t},newStream:function(e){var t=this,n=c.extend({__init__:function(){var e=this;if(e.rtcId||e._webrtc&&(e.rtcId=e._webrtc.getRtcId()),e._webrtc||e.rtcId&&(e._webrtc=t._ices[e.rtcId]),e.memId&&!e.owner&&(e.owner=r.extend({},t._cacheMembers[e.memId]),!e.owner&&!e.located()))throw"Remote stream, not owner. it = "+e.id}});return new n(e)},getConfrId:function(){return this.ticket.confrId},isCaller:function(){var e=this;return e.isP2P()&&e.ticket.caller==e.name},isCallee:function(){var e=this;return e.isP2P()&&e.ticket.callee==e.name},isP2P:function(){var e=this;return e.ticket&&("P2P"==e.ticket.type||"p2p"==e.ticket.type)},isConfr:function(){var e=this;return e.ticket&&("CONFR"==e.ticket.type||"confr"==e.ticket.type)},onEvent:function(e){},join:function(e,t){function n(e){try{if(e instanceof i.WSClose&&e.retry)return;e instanceof i.EnterFail||(e=new i.EnterFail({attendee:a,cause:e})),a.onEvent(e),t&&t(e)}finally{}}function r(t){if(0==t.result)a.reflushSupportVCodes(t.vcodes),a.setMemberId(t.memId),a.onEvent(new i.EnterSuccess),e&&e(t.memId),a.onMembers(t.cver,t.mems),a.onStreams(t.cver,t.streams);else try{n(new i.RspFail({request:c,response:t}))}finally{t.result!==-9527&&a.onEvent(new i.ServerRefuseEnter({failed:t.result,msg:t.msg}))}}function o(){c=a.newMessage().setOp(200).setTicket(a.ticket).setNickName(a.nickName||a.ticket.memName).setResource(a.resource).setExt(a.ext),a.postMessage(c,r)}s.debug("begin join ...");var c,a=this;a.connect(o,n),s.debug("join",a.ticket.url)},withpublish:function(e){function t(t,a){function d(e){try{if(e instanceof i.WSClose&&e.retry)return;e instanceof i.EnterFail||(e=new i.EnterFail({attendee:n,cause:e})),n.onEvent(e),a&&a(e)}finally{c&&c.getTracks().forEach(function(e){e.stop()}),o&&n.closeWebrtc(o.getRtcId())}}function u(s){if(0==s.result){n.reflushSupportVCodes(s.vcodes),n.setMemberId(s.memId),n.onEvent(new i.EnterSuccess);var c=n.newStream(e);c._localMediaStream=e.localStream,c.rtcId=o.getRtcId(),c._webrtc=o,c.id=s.streamId,c.owner={id:s.memId,nickName:n.nickName,name:n.sysUserId,ext:n.extObj},c.optimalVideoCodecs=l,t&&t(s.memId,c),n.onEvent(new i.PushSuccess({stream:c,hidden:!0})),s.sdp&&n.ansC(o.getRtcId(),s.sdp),s.cands&&n.tcklC(o.getRtcId(),s.cands),n.onMembers(s.cver,s.mems),n.onStreams(s.cver,s.streams)}else try{d(new i.RspFail({request:r,response:s}))}finally{s.result!==-9527&&n.onEvent(new i.ServerRefuseEnter({failed:s.result,msg:s.msg}))}}function f(){s.debug("enter and pubs");var t=e.localStream;o=n.createWebrtc({_rtcId:e.rtcId,optimalVideoCodecs:l}),n.setLocalStream(t,o.getRtcId()),n.doOffer(o.getRtcId(),function(t){r=n.newMessage().setOp(200).setTicket(n.ticket).setNickName(n.nickName||n.ticket.memName).setResource(n.resource).setSdp(t).setRtcId(o.getRtcId()).setPubS(e).setExt(n.ext),n.postMessage(r,u)})}1===arguments.length&&(a=t,t=void 0);var l=n.getOptimalVideoCodecs();n.connect(f,d),s.debug("join",n.ticket.url)}var n=this;if(!e||!e.localStream)throw"pubS null or stream not open";var r,o,c=e&&e.localStream;return{join:t}},push:function(e,t,n,r){function o(t){try{var s=d.newStream(e);s._localMediaStream=e.localStream,s._webrtc=f,s.rtcId=f&&f.getRtcId(),s.owner={id:d.getMemberId(),nickName:d.nickName,name:d.sysUserId,ext:d.extObj};var t=new i.PushFail({stream:s,cause:t,hidden:r&&t.hidden===!0});d.onEvent(t),t.hidden||n&&n(t)}finally{l&&t.hidden!==!0&&l.getTracks().forEach(function(e){e.stop()}),f&&d.closeWebrtc(f.getRtcId(),t.hidden===!0)}}function c(n,r){if(0!=r.result)return void o(new i.RspFail({request:u,response:r,hidden:r.retrying===!0}));var s=d.newStream(e);s._localMediaStream=e.localStream,s._webrtc=n,s.rtcId=n.getRtcId(),s.id=r.streamId,s.owner={id:d.getMemberId(),nickName:d.nickName,name:d.sysUserId,ext:d.extObj},s.optimalVideoCodecs=m,d.onEvent(new i.PushSuccess({stream:s,hidden:!0})),t&&t(s),r.sdp&&d.ansC(n.getRtcId(),r.sdp),r.cands&&d.tcklC(n.getRtcId(),r.cands)}function a(e){s.debug("pubs");var t=e.localStream;f=d.createWebrtc({_rtcId:e.rtcId,optimalVideoCodecs:m}),d.setLocalStream(t,f.getRtcId()),d.doOffer(f.getRtcId(),function(t){u=d.newMessage().setOp(102).setRtcId(f.getRtcId()).setSdp(t).setPubS(e),d.postMessage(u,function(e){c(f,e)})})}s.debug("begin push ...");var d=this;if(2===arguments.length&&(n=t,t=void 0),!e||!e.localStream)throw"pubS or stream open";var u,f,l=e.localStream,m=e.optimalVideoCodecs||d.getOptimalVideoCodecs();a(e),s.debug("push",d.ticket.url)},isSafari:function(){return/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)},isSafariButNotPushStream:function(){var e=this;return!(!e.isSafari()||emedia._isSafariYetPushedStream)},createWebrtcAndSubscribeStream:function(e,t,n,o){function c(n){s.error("sub stream error",e,n),h&&f._webrtc&&f._webrtc.setSubArgs(h),h&&(f.subArgs=h),n=new i.SubFail({stream:f,hidden:n.hidden===!0,cause:n}),t&&t.onEvent&&t.onEvent(n),a.onEvent&&a.onEvent(n)}var a=this;t||(t={});var d=a._cacheStreams[e],u=a._cacheMembers[d.memId],f=d;if(o=o||f.subArgs||{subSVideo:!0,subSAudio:!0},a.isSafariButNotPushStream())return void c(r.extend(new i.SubFail,new i.SubFailSafariNotAllowSubBeforePub({stream:f})));var l=d.vcodes,m=u.vcodes,p=a.supportVCodes,_=a._getOptimalVideoCodecsSubset(l,m,p);o=o||f.subArgs;var h=f.subArgs,v={offerToReceiveAudio:!emedia.isSafari||o.subSAudio,offerToReceiveVideo:!emedia.isSafari||o.subSVideo&&!f.voff};v.offerToReceiveAudio||v.offerToReceiveVideo||(s.error("offerToReceiveAudio == false and offerToReceiveVideo == false"),console.error("offerToReceiveAudio == false and offerToReceiveVideo == false"));var S=a.createWebrtc({iceServerConfig:n,optimalVideoCodecs:_,offerOptions:v,onGotMediaStream:function(e){var n=new i.SubSuccess({stream:f,hidden:!0});t.onGotRemote&&t.onGotRemote(f),a.onEvent&&a.onEvent(n)}}),g=S.getRtcId();s.warn(g," sub stream ",e,_),f._webrtc=S,f.rtcId=g,f.owner=r.extend({},u),o&&f._webrtc&&f._webrtc.setSubArgs(o),o&&(f.subArgs=o),a.offerCall(g,null,e,c,function(){})},_getOptimalVideoCodecsSubset:function(e,t,n){var s=this,o=[];if(e&&e.length>0&&n[e[0]]&&o.push(e[0]),0==o.length)for(var i=0;i<s._orderVCodes.length;i++)r.forEach(t,function(e,t){t==s._orderVCodes[i]&&o.push(t)});return o},subscribeStream:function(e,t,n,s){var o=this,c=o._ices[e],a=o._cacheStreams[t],d=o._cacheMembers[a.memId],u=a;u._webrtc=c,u.rtcId=e,u.owner=r.extend({},d);var f=u.subArgs;if(s=s||{subSVideo:!0,subSAudio:!0},u.subArgs=u.subArgs||{subSVideo:!0,subSAudio:!0},u._webrtc&&(u._webrtc.subArgs=u._webrtc.subArgs||{subSVideo:!0,subSAudio:!0}),!u.subArgs.subSVideo&&s.subSVideo&&!u.voff){var l=a.vcodes,m=d.vcodes,p=o.supportVCodes;o._getOptimalVideoCodecsSubset(l,m,p)}s&&u._webrtc&&u._webrtc.setSubArgs(s),s&&(u.subArgs=s);var _=o.newMessage().setOp(205).setRtcId(e).setSubSId(t);s&&r.extend(_,s),o.postMessage(_,function(e){if(0!=e.result){f&&u._webrtc&&u._webrtc.setSubArgs(f),f&&(u.subArgs=f);var t=new i.SubFail({stream:u,cause:new i.RspFail({request:_,response:e})});return n&&n(t),void o.onEvent(t)}var t=new i.SubSuccess({stream:u,hidden:!0});o._updateRemoteStream(u,u._webrtc.getRemoteStream()),o.onEvent(t)})},unsubscribeStream:function(e){var t=this,n=t._cacheStreams[e],r=n._webrtc&&n._webrtc.getRtcId();if(r){try{var s=t.newMessage().setOp(206).setRtcId(r).setSubSId(e);t.postMessage(s)}finally{t.closeWebrtc(r)}return r}},onEnter:function(e,t){var n=this;if(e&&(n._cver=e),t&&!n._cacheMembers[t.id]){n._cacheMembers[t.id]=t;var s={};t.res&&t.res.vcodes&&t.res.vcodes.length>0&&r.forEach(t.res.vcodes,function(e,t){s[t]||(s[t]=!0,n.supportVCodes[t]&&n.supportVCodes[t]++)}),n.onAddMember(t)}},_onFinally:function(){var e=this;e._cacheMembers={},e._cacheStreams={},e._linkedStreams={},e._ices={},e._maybeNotExistStreams={},s.warn("finally. all clean.")},onExit:function(e,t,n){var o=this;if(e&&(o._cver=e),t!=o.getMemberId()){var c=o._cacheMembers[t];c&&(c.res&&c.res.vcodes&&c.res.vcodes.length>0&&r.forEach(c.res.vcodes,function(e,t){o.supportVCodes[t]--}),o._onRemoveMember(c,n),o.onEvent(new i.Hangup({reason:n,parnter:c})))}else{s.warn("Me exit. ",n,t);try{o.closed||o.close(n)}catch(a){o.onEvent(new i.Hangup({reason:n,self:{id:o._memberId}})),o.onMeExit&&o.onMeExit(n),s.error(a)}}},onPub:function(e,t,n){var o=this;if(!o._cacheMembers[t])throw"No found member. when pub";var i=o.newStream(n),c=o._cacheStreams[n.id];if(e&&(o._cver=e),c&&i.sver!==c.sver)return s.info("Onpub. the steam ",c.id," republish. sver ",c.sver,i.sver),!i||i.aoff===c.aoff&&i.voff==c.voff||o.onStreamControl(void 0,n.id,i.voff,i.aoff),r.extend(c,i),void o._onRepublishStream(c);var a=i;if(a.owner=o._cacheMembers[t],o._cacheStreams[n.id]=a,o.onAddStream(o.newStream(a)),o.autoSub){if(o.isSafariButNotPushStream())return a._autoSubWhenPushStream=!0,void s.warn("Dont auto sub stream ",a.id,", caused by safari not pub stream");o.createWebrtcAndSubscribeStream(n.id,{onGotRemote:function(e){}})}},onUnpub:function(e,t,n){var r=this,s=r._cacheStreams[n];r._onRemovePubstream(r._cacheMembers[t],s),e&&(r._cver=e)},onClose:function(e,t,n){var r=this;try{r.close(n||0)}finally{r.onConfrClose&&r.onConfrClose(t,n)}},__getWebrtcFor:function(e){var t=this,n=t._cacheStreams[e]._webrtc;return n&&n.getRtcId()},_getWebrtc:function(e){var t=this,n=t._cacheStreams[e]._webrtc;return n},_updateRemoteStream:function(e,t){t&&t.getAudioTracks().forEach(function(t){t.enabled=!(e.aoff||e.subArgs&&e.subArgs.subSAudio===!1)}),t&&t.getVideoTracks().forEach(function(t){t.enabled=!(e.voff||e.subArgs&&e.subArgs.subSVideo===!1)})},onStreamControl:function(e,t,n,r){var s=this,o=s._cacheStreams[t];o.voff=n,o.aoff=r;var i=o._webrtc;i&&i._remoteStream&&s._updateRemoteStream(o,i._remoteStream);var o=s.newStream(o);s.onUpdateStream&&s.onUpdateStream(o,new o.Update({voff:n,aoff:r})),e&&(s._cver=e)},aoff:function(e,t,n){var r=this,s=r.__getWebrtcFor(e.id);if(!s)throw"pubS not publish"+e.id;r._linkedStreams[e.id].aoff=t;var o=r.newMessage().setOp(400).setRtcId(s).setVoff(e.voff).setAoff(t);r.postMessage(o,n)},voff:function(e,t,n){var r=this,s=r.__getWebrtcFor(e.id);if(!s)throw"pubS not publish"+e.id;r._linkedStreams[e.id].voff=t;var o=r.newMessage().setOp(400).setRtcId(s).setVoff(t).setAoff(e.aoff);r.postMessage(o,n)},startRecord:function d(e,t){var n=this,o=e.rtcId,d=n.newMessage().setOp(500).setRtcId(o).setFlag(1);n.postMessage(d,function(i){s.warn("record ",o,i.result,i.msg),t&&t(0===i.result),0===i.result&&(n._records[e.id]=r.extend(!1,{},e))})},stopRecord:function u(e,t){var n=this,o=e.rtcId,u=n.newMessage().setOp(500).setRtcId(o).setFlag(0);n.postMessage(u,function(e){s.warn("stop record ",o,e.result,e.msg),t&&t(0===e.result)}),n._records[e.id]&&r.removeAttribute(n._records,e.id)},onMembers:function(e,t){var n=this,s=[];r.forEach(n._cacheStreams,function(e,n){t[e]||s.push(n)}),r.forEach(s,function(e,t){n.onExit(void 0,t.id)});var o=[];r.forEach(t,function(e,t){e!=n.getMemberId()&&(n._cacheStreams[e]||o.push(t))}),r.forEach(o,function(e,t){n.onEnter(void 0,t)}),e&&(n._cver=e)},onStreams:function(e,t){var n=this,s=[];r.forEach(n._cacheStreams,function(e,n){n.located()||t[e]||s.push(n)}),r.forEach(s,function(e,t){n.onUnpub(void 0,t.memId,t.id)});var o=[];r.forEach(t,function(e,t){t.memId!=n.getMemberId()&&(n._cacheStreams[e]||o.push(t))}),r.forEach(o,function(e,t){n.onPub(void 0,t.memId,t)}),r.forEach(n._cacheStreams,function(e,s){var o;s.located()||(o=t[e]),!o||o.aoff===s.aoff&&o.voff==s.voff||n.onStreamControl(void 0,e,o.voff,o.aoff),o&&o.sver!==s.sver&&(r.extend(s,o),n._onRepublishStream(s))}),e&&(n._cver=e)},_onRemoveMember:function(e,t){var n=this;s.info("remove",e,t);var o=[];r.forEach(n._cacheStreams,function(t,n){n.memId===e.id&&o.push(n)}),r.forEach(o,function(e,r){n._onRemovePubstream(r.owner,r,t)}),r.removeAttribute(n._cacheMembers,e.id),n.onRemoveMember&&n.onRemoveMember(e,t)},_onRemovePubstream:function(e,t){var n=this;if(t){n.unsubscribeStream(t.id),r.removeAttribute(n._cacheStreams,t.id);if(n.onRemoveStream){var t=n.newStream(t);n.onRemoveStream(t)}}},_onRepublishStream:function(e){var t=this;if(t._ices[e.rtcId]&&!t._maybeNotExistStreams[e.id]){t.unsubscribeStream(e.id);t.createWebrtcAndSubscribeStream(e.id,{onGotRemote:function(e){}})}},onAddMember:function(e){},onRemoveMember:function(e,t){},onAddStream:function(e){},onRemoveStream:function(e){},onUpdateStream:function(e,t){}});e.exports=a},function(e,t,n){"use strict";var r=n(5),s=r.tagLogger("Member"),o=n(8),i=n(11);e.exports=r.prototypeExtend({__init__:function(){var e=this;if(!e._session)throw"Require session";e.closed=!1,e._ices={},e.supportVCodes={}},reflushSupportVCodes:function(e){var t=this;return t.supportVCodes={},t._orderVCodes=e,e&&0!=e.length?void r.forEach(e,function(e,n){t.supportVCodes[n]=1}):void s.warn("Not config support vcodes")},getOptimalVideoCodecs:function(){var e=this;if(!e._orderVCodes||0==e._orderVCodes.length)return/Chrome/.test(navigator.userAgent)?"VP8":/Safari/.test(navigator.userAgent)?"H264":"VP8";var t=0;r.forEach(e._cacheMembers,function(){t++});for(var n,s=0,o=0;o<e._orderVCodes.length;o++){var i=e._orderVCodes[o];if(0==s&&(s=e.supportVCodes[i]),e.supportVCodes[i]>t)return i;e.supportVCodes[i]>s&&(s=e.supportVCodes[i],n=i)}return n},setMemberId:function(e){this._memberId=e},getMemberId:function(){return this._memberId},createWebrtc:function(e){var t=this,n=new i({onIceStateChange:function(e){var r=e.target.iceConnectionState;return s.debug("evt.target ice state",r),"failed"==r?(t.onEvent(new o.ICEConnectFail({webrtc:n,event:e})),void(n.onEvent&&n.onEvent(new o.ICEConnectFail({webrtc:n,event:e})))):"connected"==r?(t.onEvent(new o.ICEConnected({webrtc:n,event:e})),void(n.onEvent=null)):"closed"==r?(t.onEvent(new o.ICEClosed({webrtc:n})),void(n.onEvent&&n.onEvent(new o.ICEClosed({webrtc:n})))):"disconnected"==r?(t.onEvent(new o.ICEDisconnected({webrtc:n})),void(n.onEvent&&n.onEvent(new o.ICEDisconnected({webrtc:n})))):void(t._onIceStateChange&&t._onIceStateChange(n,e))},onIceCandidate:function(e){t._onIceCandidate&&e&&t._onIceCandidate(n,e)},onGotRemoteStream:function(e){s.info("got stream.",n,e),n.onGotMediaStream&&n.onGotMediaStream(e),t.onEvent(new o.ICERemoteMediaStream({webrtc:n}))},onAddIceCandidateError:function(e){t.onEvent(new o.AddIceCandError({webrtc:n,event:e}))},onSetSessionDescriptionError:function(e){s.error("onSetSessionDescriptionError : Failed to set session description: "+e.toString()),t.onEvent&&t.onEvent(new o.ICEConnectFail({webrtc:n,event:e}))},onCreateSessionDescriptionError:function(e){s.error("Failed to create session description: "+e.toString()),t.onEvent&&t.onEvent(new o.ICEConnectFail({webrtc:n,event:e}))}},e||{});return t._ices||(t._ices={}),t._ices[n.getRtcId()]&&t.closeWebrtc(n.getRtcId(),!0,!1),t._ices[n.getRtcId()]=n,t._ices[n.__id]=n,t._iceCreateRtcPeerConnection(n.getRtcId()),s.debug("create rtc ",n),n},connect:function(e,t){var n=this;n._session.connect(e,t)},connected:function(){var e=this;return e._session.connected()},newMessage:function(e){var t=this;return t._session.newMessage(e||{})},postMessage:function(e,t){var n=this;try{e.sessId||e.setSessId(n._session._sessionId),n._session.postMessage(e,t)}catch(r){t&&t({op:1001,tsxId:e.tsxId,result:-9527,msg:"post message. exception"}),s.error(r)}},onEvent:function(e){},_onIceStateChange:function(e,t){var n=this;s.info(e.getRtcId(),t),n.onEvent(new o.ICEChanage({webrtc:e,event:t,state:t.target.iceConnectionState}))},_onIceCandidate:function(e,t){var n,s=this;r.isArray(t)?n=t:(n=[],n.push(t));var i=s.newMessage().setOp(105).setRtcId(e.getRtcId()).setCands(n);s.postMessage(i,function(e){if(0!=e.result)return void s.onEvent(new o.RspFail({request:i,response:e}))})},_initC:function(e,t,n,i,c,a){var d=this;if(t&&t.rtcId!==e.getRtcId())throw"stream and webrtc rtcId not equal.";var u=d.newMessage().setOp(102).setRtcId(e.getRtcId()).setSdp(n).setSubSId(i);e.subArgs&&r.extend(u,e.subArgs),t&&t.located()&&u.setPubS(t),d.postMessage(u,function(n){if(0!=n.result)return d.onEvent(new o.RspFail({request:u,response:n})),void(c&&c(new o.RspFail({request:u,response:n,hidden:n.retrying===!0})));t&&!t.id&&n.streamId&&(t.id=n.streamId);try{a&&a()}catch(r){s.error(r)}n.sdp&&d.ansC(e.getRtcId(),n.sdp,n.cands),n.mems&&d.onMembers&&d.onMembers(n.cver,n.mems),n.streams&&d.onStreams&&d.onStreams(n.cver,n.streams)})},_acptC:function(e,t,n){var r=this,s=r.newMessage().setOp(104).setRtcId(e.getRtcId()).setSdp(t);r.postMessage(s,function(e){if(0!=e.result)return r.onEvent(new o.RspFail({request:s,response:e})),void(n&&n(new o.RspFail({request:s,response:e})))})},_ansC:function(e,t,n){var r=this,s=r.newMessage().setOp(106).setRtcId(e.getRtcId()).setSdp(t);r.postMessage(s,function(e){if(0!=e.result)return r.onEvent(new o.RspFail({request:s,response:e})),void(n&&n(new o.RspFail({request:s,response:e})))})},_termC:function(e,t,n){var r=this,s=r.newMessage().setOp(107).setRtcId(e.getRtcId()).setEndReason(t);r.postMessage(s,function(e){if(0!=e.result)return r.onEvent(new o.RspFail({request:s,response:e})),void(n&&n(new o.RspFail({request:s,response:e})))})},_iceCreateRtcPeerConnection:function(e){var t=this;t._ices[e].createRtcPeerConnection(),s.debug("create rtc peer connection",e)},doOffer:function(e,t,n){var r=this,s=r._ices[e];s.createOffer(function(e){t(e)})},offerCall:function(e,t,n,r,s){var o=this,i=o._ices[e];i.createOffer(function(e){o._initC&&o._initC(i,t,e,n,r,s)})},accept:function(e,t){var n=this,r=n._ices[e];r.createPRAnswer(function(e){n._acptC&&n._acptC(r,e,t)})},answer:function(e,t){var n=this,r=n._ices[e];r.createAnswer(function(e){n._ansC&&n._ansC(r,e,t)})},onTcklC:function(e,t){var n=this;n._addIceCandidate(t,e)},onAcptC:function(e,t,n){var r=this;r._iceSetRemoteSDP(t,e),n&&r._addIceCandidate(n,e)},onAnsC:function(e,t,n){var r=this;r._iceSetRemoteSDP(t,e),n&&r._addIceCandidate(n,e)},_addIceCandidate:function(e,t){var n=this;if(!e||0==e.length)return void s.warn("drop cands",e);var r=n._ices[t];r.addIceCandidate(e)},closeWebrtc:function(e,t,n){var o=this,i=o._ices[e];if(!i||i.closed)return s.warn("Webrtc not exsits or closed",i&&i.closed),void(n&&i&&r.forEach(o._cacheStreams,function(t,n){n.rtcId===e&&delete o._linkedStreams[t]}));o._records&&!function(){var t=function(e){try{o.stopRecord(e)}catch(t){s.error(t)}finally{r.removeAttribute(o._records,e.id)}};r.forEach(o._records,function(n,r){r.rtcId===e&&t(r)})}();try{n||i&&o._termC(i,t&&i._localStream?-10:0)}finally{i&&i.close(),i&&o.onWebrtcTermC&&o.onWebrtcTermC(i),t||i&&r.forEach(o._cacheStreams,function(t,r){r.rtcId===e&&(r.located()&&(r._localMediaStream&&r._localMediaStream.getTracks().forEach(function(e){e.stop()}),o._cacheStreams[t]&&o._linkedStreams[t]&&o.onRemoveStream(r),delete o._cacheStreams[t],s.info("Remove stream",t,". from cache")),n&&delete o._linkedStreams[t])})}return i},__close:function(e){s.warn("closing, reason = ",e);var t=this;if(!t.closed){if(t.closed=!0,t.__getCopyInterval&&(clearInterval(t.__getCopyInterval),s.warn("Stop interval get copy")),t._ices)for(var n in t._ices)t.closeWebrtc(n);var r=t.newMessage().setOp(201).setReason(e||0);t.postMessage(r)}},exit:function(e){var t=this;return e?(e&&t._closeMyConfr(11),void setTimeout(function(){t.close(0)},100)):void t.close(0)},_closeMyConfr:function(e){var t=this,n=t.newMessage().setOp(204).setReason(e||0);t.postMessage(n,function(e){s.warn("Close confr ",e.result,e.msg)})},close:function(e,t){var n=this;if(!n.closed)try{r.forEach(n._cacheStreams||{},function(e,t){t.located()&&t._localMediaStream&&t._localMediaStream.getTracks().forEach(function(e){e.stop()})}),n.__close(e)}finally{setTimeout(function(){n._session&&n._session.close(e)},500),n.onEvent(new o.Hangup({reason:e,failed:t,self:{id:n._memberId}})),n.onMeExit&&n.onMeExit(e,t),n._onFinally&&n._onFinally()}},webrtcState:function(e){var t=this,n=t._ices[e];return n.iceConnectionState()},_iceSetRemoteSDP:function(e,t){var n=this,r=n._ices[t];r.setRemoteDescription(e)},setLocalStream:function(e,t){var n=this,r=n._ices[t];r.setLocalStream(e)},onWebrtcTermC:function(e){}})},function(e,t,n){"use strict";var r=n(5),s=r.tagLogger("Webrtc"),o=(n(8),{headerSection:null,audioSection:null,videoSection:null,_parseHeaderSection:function(e){var t=e.indexOf("m=audio");return t>=0?e.slice(0,t):(t=e.indexOf("m=video"),t>=0?e.slice(0,t):e)},_parseAudioSection:function(e){var t=e.indexOf("m=audio");if(t>=0){var n=e.indexOf("m=video");return e.slice(t,n<0?e.length:n)}},_parseVideoSection:function(e){var t=e.indexOf("m=video");if(t>=0)return e.slice(t)},spiltSection:function(e){var t=this;t._preSDP=e,t.headerSection=t._parseHeaderSection(e),t.audioSection=t._parseAudioSection(e),t.videoSection=t._parseVideoSection(e)},updateVCodes:function(e){var t=this;if(e&&t.videoSection){if("string"==typeof e){var n=[];n.push(e),e=n}for(var o={},i=/a=rtpmap:(\d+) ([A-Za-z0-9]+)\/.*/gi,n=t._parseLine(t.videoSection,i),c=0;c<n.length;c++){var a=n[++c],d=n[++c];o[d]=a}var u=/a=fmtp:(\d+) .*profile-level-id=42e01f;?.*/gi,f=t._parseLine(t.videoSection,u);f&&f.length>=2&&(o.H264=f[1]);for(var l=[],c=0;c<e.length;c++){var m=o[e[c]];m&&l.push(m)}var p=t.videoSection.indexOf("\r"),_=t.videoSection.substring(0,p),h=_.split(" ");Array.prototype.push.apply(l,h.slice(3));var v=[],S={};r.forEach(l,function(e,t){0==v.length?(v.push(t),S[t]=!0):S[t]||(v.push(t),S[t]=!0)}),h.splice(3,h.length-3,v.join(" ")),_=h.join(" "),s.warn(_),t.videoSection=_+t.videoSection.substring(p)}},removeSSRC:function(e){for(var t=[],n=e.split(/a=ssrc:[^\n]+/g),r=0;r<n.length;r++)"\n"!=n[r]&&t.push(n[r]);return t.join("\n")},removeField_msid:function(e){for(var t=[],n=e.split(/a=msid:[^\n]+/g),r=0;r<n.length;r++)"\n"!=n[r]&&t.push(n[r]);e=t.join("\n"),t=[],n=e.split(/[\n]+/g);for(var r=0;r<n.length;r++)"\n"!=n[r]&&t.push(n[r]);return t.join("\n")},updateHeaderMsidSemantic:function(e){var t=this,n="a=msid-semantic: WMS "+e,r=t.headerSection.split(/a=msid\-semantic: WMS.*/g),s=[];switch(r.length){case 1:s.push(r[0]);break;case 2:s.push(r[0]),s.push(n),s.push("\n");break;case 3:s.push(r[0]),s.push(n),s.push("\n"),s.push(r[2]),s.push("\n")}return t.headerSection=s.join("")},updateAudioSSRCSection:function(e,t,n,r){var s=this;s.audioSection&&(s.audioSection=s.removeSSRC(s.audioSection)),s.audioSection&&(s.audioSection=s.removeField_msid(s.audioSection)),s.audioSection&&(s.audioSection=s.audioSection+s.ssrcSection(e,t,n,r))},updateVideoSSRCSection:function(e,t,n,r){var s=this;s.videoSection&&(s.videoSection=s.removeSSRC(s.videoSection)),s.videoSection&&(s.videoSection=s.removeField_msid(s.videoSection)),s.videoSection&&(s.videoSection=s.videoSection+s.ssrcSection(e,t,n,r))},getUpdatedSDP:function(){var e=this,t="";return e.headerSection&&(t+=e.headerSection),e.audioSection&&(t+=e.audioSection),e.videoSection&&(t+=e.videoSection),t},parseMsidSemantic:function(e){var t=this,n=/a=msid\-semantic:\s*WMS (\S+)/gi,r=t._parseLine(e,n);return r&&2==r.length&&(t.msidSemantic={line:r[0],WMS:r[1]}),t.msidSemantic},ssrcSection:function(e,t,n,r){var s=["a=ssrc:"+e+" cname:"+t,"a=ssrc:"+e+" msid:"+n+" "+r,"a=ssrc:"+e+" mslabel:"+n,"a=ssrc:"+e+" label:"+r,""];return s.join("\n")},parseSSRC:function(e){var t=this,n=new RegExp("a=(ssrc):(\\d+) (\\S+):(\\S+)","ig"),r=t._parseLine(e,n);if(r){for(var s={lines:[],updateSSRCSection:t.ssrcSection},o=0;o<r.length;o++){var i=r[o];if(i.indexOf("a=ssrc")>=0)s.lines.push(i);else switch(i){case"ssrc":case"cname":case"msid":case"mslabel":case"label":s[i]=r[++o]}}return s}},_parseLine:function(e,t){for(var n,r=[];null!=(n=t.exec(e));)for(var s=0;s<n.length;s++)r.push(n[s]);if(r.length>0)return r}}),i=function(e){r.extend(this,o),this.spiltSection(e)};window.__rtc_globalCount=0;var c=r.prototypeExtend({closed:!1,sdpConstraints:{mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},offerOptions:{offerToReceiveAudio:!0,offerToReceiveVideo:!0},optimalVideoCodecs:null,optimalAudioCodecs:null,__init__:function(){var e=this;e._rtcId||(e._rtcId="RTC"+__rtc_globalCount++),e.__id="_i_"+__rtc_globalCount++,e.__setRemoteSDP=!1,e.__tmpRemoteCands=[],e.__tmpLocalCands=[],e._rtcPeerConnection=null,s.info("Webrtc created. rtcId = ",e._rtcId,", __id = ",e.__id)},getRtcId:function(){return this._rtcId},iceState:function(){var e=this;return e._rtcPeerConnection.iceConnectionState},setSubArgs:function(e){var t=this;t.subArgs=e},updateRemoteBySubArgs:function(e){var t=this;t._remoteStream&&t._remoteStream.getVideoTracks().forEach(function(e){e.enabled=!(t.subArgs&&t.subArgs.subSVideo===!1)}),t._remoteStream&&t._remoteStream.getAudioTracks().forEach(function(e){e.enabled=!(t.subArgs&&t.subArgs.subSAudio===!1)})},createRtcPeerConnection:function(e){var t=this;s.debug("begin create RtcPeerConnection ......",t._rtcId,"closed:",t.closed),e||(e=t.iceServerConfig),e?(!e.iceServers&&(e.iceServers=[]),e.rtcpMuxPolicy="require",e.bundlePolicy="max-bundle",e.relayOnly&&(e.iceTransportPolicy="relay")):e=null,s.debug("RtcPeerConnection config:",e,t._rtcId,"closed:",t.closed);var n=t._rtcPeerConnection=new RTCPeerConnection(e);s.debug("created local peer connection object",n,t._rtcId),n.onicecandidate=function(e){if("icecandidate"!=e.type||null!=e.candidate&&!/ tcp /.test(e.candidate.candidate)){if(!e.candidate.candidate)throw"Not found candidate. candidate is error, "+e.candidate.candidate;if(!t.__setRemoteSDP)return(t.__tmpLocalCands||(t.__tmpLocalCands={})).push(e.candidate),void s.debug("On ICE candidate but tmp buffer caused by not set remote sdp: ",e.candidate.candidate,t._rtcId,"closed:",t.closed);s.debug("On ICE candidate: ",e.candidate.candidate,t._rtcId,"closed:",t.closed),t.onIceCandidate(e.candidate)}},n.onicestatechange=function(e){s.debug("ice connect state",t.webRtc.iceConnectionState(),"evt.target state",e.target.iceConnectionState,t._rtcId,"closed:",t.closed),t.onIceStateChange(e)},n.oniceconnectionstatechange=function(e){t.onIceStateChange(e)},n.onaddstream=function(e){t._onGotRemoteStream(e)}},setLocalStream:function(e){this._localStream=e,this._rtcPeerConnection.addStream(e),s.debug("Added local stream to RtcPeerConnection",e,self._rtcId,"closed:",this.closed)},getLocalStream:function(){return this._localStream},getRemoteStream:function(){return this._remoteStream},createOffer:function(e,t){var n=this;return s.debug("createOffer start..."),n._rtcPeerConnection.createOffer(n.offerOptions).then(function(t){if(n.offerDescription=t,s.debug("setLocalDescription start",n._rtcId,"closed:",n.closed,n.optimalVideoCodecs),n.optimalVideoCodecs&&("string"==typeof n.optimalVideoCodecs||n.optimalVideoCodecs.length>0)){var r=new i(t.sdp);r.updateVCodes(n.optimalVideoCodecs),t.sdp=r.getUpdatedSDP()}n._rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSessionDescriptionSuccess,n.onSetSessionDescriptionError).then(function(){(e||n.onCreateOfferSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createPRAnswer:function(e,t){var n=this;return s.info(" createPRAnswer start","closed:",n.closed),n._rtcPeerConnection.createAnswer(n.sdpConstraints).then(function(t){s.debug("_____________PRAnswer ",t.sdp,n._rtcId,"closed:",n.closed),t.type="pranswer",t.sdp=t.sdp.replace(/a=recvonly/g,"a=inactive"),n.__prAnswerDescription=t,s.debug("inactive PRAnswer ",t.sdp,n._rtcId,"closed:",n.closed),
s.debug("setLocalDescription start",n._rtcId,"closed:",n.closed),n._rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){var r=new i(t.sdp);r.updateHeaderMsidSemantic("MS_0000"),r.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),r.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=r.getUpdatedSDP(),s.debug("Send PRAnswer ",t.sdp,n._rtcId,"closed:",n.closed),(e||n.onCreatePRAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},createAnswer:function(e,t){var n=this;return s.info("createAnswer start","closed:",n.closed),n._rtcPeerConnection.createAnswer(n.sdpConstraints).then(function(t){if(s.debug("_____________________Answer ",t.sdp,n._rtcId,"closed:",n.closed),t.type="answer",emedia.supportPRAnswer){var r=new i(t.sdp),o=r.parseMsidSemantic(r.headerSection);"*"==o.WMS&&r.updateHeaderMsidSemantic(o.WMS="MS_0000");var c=r.parseSSRC(r.audioSection),a=r.parseSSRC(r.videoSection);r.updateAudioSSRCSection(1e3,"CHROME0000",o.WMS,c.label||"LABEL_AUDIO_1000"),a&&r.updateVideoSSRCSection(2e3,"CHROME0000",o.WMS,a.label||"LABEL_VIDEO_2000"),t.sdp=r.getUpdatedSDP()}n.__answerDescription=t,s.debug("Answer ",t.sdp,n._rtcId,"closed:",n.closed),s.debug("setLocalDescription start",n._rtcId,"closed:",n.closed),n._rtcPeerConnection.setLocalDescription(t).then(n.onSetLocalSuccess,n.onSetSessionDescriptionError).then(function(){if(emedia.supportPRAnswer){var r=new i(t.sdp);r.updateHeaderMsidSemantic("MS_0000"),r.updateAudioSSRCSection(1e3,"CHROME0000","MS_0000","LABEL_AUDIO_1000"),r.updateVideoSSRCSection(2e3,"CHROME0000","MS_0000","LABEL_VIDEO_2000"),t.sdp=r.getUpdatedSDP()}s.debug("Send Answer ",t.sdp,n._rtcId,"closed:",n.closed),(e||n.onCreateAnswerSuccess)(t)})},t||n.onCreateSessionDescriptionError)},close:function(e){var t=this;if(s.warn("webrtc closing","closed:",t._rtcId,t.closed),!t.closed){t.closed=!0;try{t._rtcPeerConnection&&t._rtcPeerConnection.close()}catch(n){s.error(n)}finally{t._remoteStream&&t._remoteStream.getTracks().forEach(function(e){e.stop()}),t._remoteStream=null,t.onClose&&t.onClose(),s.warn("webrtc closed. closed:",t._rtcId,t.closed)}}},addIceCandidate:function(e){var t=this;if(t._rtcPeerConnection){s.debug("Add ICE candidate: ",e,t._rtcId,"closed:",t.closed);var n=r.isArray(e)?e:[];if(!r.isArray(e)&&n.push(e),!t.__setRemoteSDP)return Array.prototype.push.apply(t.__tmpRemoteCands||(t.__tmpRemoteCands={}),n),void s.debug("Add ICE candidate but tmp buffer caused by not set remote sdp: ",e,t._rtcId,"closed:",t.closed);for(var o=0;o<n.length;o++)e=n[o],t._rtcPeerConnection.addIceCandidate(new RTCIceCandidate(e)).then(t.onAddIceCandidateSuccess,t.onAddIceCandidateError)}},setRemoteDescription:function(e){var t=this;return s.debug("setRemoteDescription start. ",e,t._rtcId,"closed:",t.closed),e.sdp=e.sdp.replace(/UDP\/TLS\/RTP\/SAVPF/g,"RTP/SAVPF"),s.debug("setRemoteDescription.",e,"closed:",t.closed),e=new RTCSessionDescription(e),t._rtcPeerConnection.setRemoteDescription(e).then(function(){t.__setRemoteSDP=!0,t.onSetRemoteSuccess.apply(t,arguments),t.__tmpLocalCands&&t.__tmpLocalCands.length>0&&(s.debug("After setRemoteDescription. send cands",t._rtcId,"closed:",t.closed),t.onIceCandidate(t.__tmpLocalCands),t.__tmpLocalCands=[]),t.__tmpRemoteCands&&t.__tmpRemoteCands.length>0&&(s.debug("After setRemoteDescription. add tmp cands",t._rtcId,"closed:",t.closed),t.addIceCandidate(t.__tmpRemoteCands),t.__tmpRemoteCands=[])},t.onSetSessionDescriptionError)},iceConnectionState:function(){var e=this;return e._rtcPeerConnection.iceConnectionState},isConnected:function(){var e=this,t=e._rtcPeerConnection.iceConnectionState;return"connected"===t||"completed"===t},_onGotRemoteStream:function(e){s.debug("onGotRemoteStream.",self._rtcId,e),this._remoteStream=e.stream,this.onGotRemoteStream(this._remoteStream,e),s.debug("received remote stream, you will see the other.",self._rtcId,"closed:",this.closed)},onSetRemoteSuccess:function(){s.info("onSetRemoteSuccess complete",self._rtcId)},onSetLocalSuccess:function(){s.info("setLocalDescription complete",self._rtcId)},onAddIceCandidateSuccess:function(){s.debug("addIceCandidate success",self._rtcId)},onAddIceCandidateError:function(e){s.debug("failed to add ICE Candidate: "+e.toString(),self._rtcId)},onIceCandidate:function(e){s.debug("onIceCandidate : ICE candidate: \n"+e,self._rtcId)},onIceStateChange:function(e){s.debug("onIceStateChange : ICE state change event: ",self._rtcId)},onCreateSessionDescriptionError:function(e){s.error("Failed to create session description: "+e.toString(),self._rtcId)},onCreateOfferSuccess:function(e){s.debug("create offer success",self._rtcId)},onCreatePRAnswerSuccess:function(e){s.debug("create answer success",self._rtcId)},onCreateAnswerSuccess:function(e){s.debug("create answer success",self._rtcId)},onSetSessionDescriptionError:function(e){s.error("onSetSessionDescriptionError : Failed to set session description: "+e.toString(),self._rtcId)},onSetLocalSessionDescriptionSuccess:function(){s.debug("onSetLocalSessionDescriptionSuccess : setLocalDescription complete",self._rtcId)},onGotRemoteStream:function(e){s.debug("Got remote stream. ",e,self._rtcId)}});e.exports=c},function(e,t,n){"use strict";var r=n(5);e.exports=r.prototypeExtend({Update:r.prototypeExtend({ifAoff:function(e){this.if("aoff",e)},ifVoff:function(e){this.if("voff",e)},ifMediaStream:function(e){this.if("mediaStream",e)},if:function(e,t){"undefined"!=typeof this[e]&&t(this[e])}}),located:function(){return this._located||!1},webrtc:function(e){return e&&(this._webrtc=e),this},getMediaStream:function(){return this._located?this._localMediaStream:this._webrtc&&this._webrtc.getRemoteStream()},ifMediaStream:function(e){return"undefined"!=typeof this.mediaStream?void e(this.mediaStream):this._located&&"undefined"!=typeof this._localMediaStream?void e(this._localMediaStream):!this._located&&this._webrtc&&"undefined"!=typeof this._webrtc.getRemoteStream()?void e(this._webrtc.getRemoteStream()):void 0},getHtmlDOMID:function(){return"_m_"+this.owner.id+"_s_"+this.id}})},function(e,t,n){"use strict";var r=n(5),s=r.tagLogger("Handler"),o=n(8),i=r.prototypeExtend({onEvent:function(e){function t(){try{n.handleEvent(e)}catch(t){s.error(t)}}var n=this;if(e&&s.warn("[EVT]",e.message(),e.hidden||""),e instanceof o.ServerRefuseEnter&&e.failed&&e.failed===-95270&&(e.failed=-9527),e instanceof emedia.event.StreamState&&e.stream&&e.stream.located())return void t();try{e.hidden||n.onNotifyEvent&&n.onNotifyEvent(e)}finally{t()}},handleEvent:function(e){var t=this;if(e instanceof o.RecvResponse)t._onRecvResponse(e);else if(e instanceof o.ServerRefuseEnter)s.warn("Server refuse, ",e.failed,e.msg),t.onServerRefuseEnter(e);else if(e instanceof o.EnterFail)s.warn("Enter fail, result = ",e.failed),t.onEnterFail();else if(e instanceof o.WSClose)t.onWSClose();else if(e instanceof o.WSConnected)s.warn("Websocket connected");else if(e instanceof o.ICEConnected){var n=e.webrtc;t.onICEConnected(n)}else if(e instanceof o.ICEConnectFail){var n=e.webrtc;t.onICEConnectFail(n)}else if(e instanceof o.ICEDisconnected){var n=e.webrtc;t.onICEDisconnected(n)}else if(e instanceof o.ICEClosed){var n=e.webrtc;t.onICEClosed(n)}else if(e instanceof o.ICERemoteMediaStream)t.onICERemoteMediaStream(e.webrtc);else if(e instanceof o.PushSuccess){t._cacheStreams[e.stream.id]=t._linkedStreams[e.stream.id]=e.stream;var i=t.newStream(e.stream);if(e.hidden&&!t._maybeNotExistStreams[e.stream.id]&&!i.isRepublished)return void t.onAddStream(i);t.isSafari()&&(emedia._isSafariYetPushedStream=!0);try{i&&(i.mediaStream=i.getMediaStream()),i&&t.onUpdateStream(i,new i.Update({voff:i.voff,aoff:i.aoff,mediaStream:i.mediaStream}))}finally{t.isSafari()&&r.forEach(t._cacheStreams,function(e,n){n._autoSubWhenPushStream===!0&&(r.removeAttribute(n,"_autoSubWhenPushStream"),t.createWebrtcAndSubscribeStream(n.id))})}}else if(e instanceof o.SubSuccess)t._linkedStreams[e.stream.id]=e.stream,e.stream._zoom=1;else if(e instanceof o.PushFail){if(e.hidden!==!0){var c=r.removeAttribute(t._linkedStreams,e.stream.id);if(c){var i=t.newStream(e.stream);t.onRemoveStream(i)}}}else if(e instanceof o.SubFail){if(e.hidden!==!0){delete t._linkedStreams[e.stream.id];var i=t.newStream(e.stream);i.rtcId=void 0,i._webrtc=void 0,i.mediaStream=null,t.onUpdateStream(i,new i.Update(i))}}else if(e instanceof o.SubFailNotSupportVCodes){var a=e.stream;s.warn("Rtc donot support pub VCodes. close. sub fail.",a.rtcId," -> ",a.id);try{t.onNotSupportPublishVideoCodecs&&t.onNotSupportPublishVideoCodecs(a)}catch(d){s.error(d)}}else if(e instanceof o.EnterSuccess)t.onEnterSuccess();else if(e instanceof o.SwitchVCodes){var a=e.stream,u=e.useVCodes,n=a._webrtc;s.warn("Rtc switch VCodes. ",a.id,u),u&&0!=u.length||s.warn("Rtc switch VCodes. error! useVCodes is empty ",a.id,u),a.optimalVideoCodecs=u,n&&t.closeWebrtc(n.getRtcId(),!0),setTimeout(function(){a.iceRebuildCount=1,t.iceRebuild(a),s.warn("Rtc switch VCodes. iceRebuild end.",a.id,u)},300)}},_onRecvResponse:function(e){var t=this,n=e.request,r=e.response;if(n&&r&&200!==n.op&&0!==r.result){s.error("Server refuse. when request = ",n);var o=e.failed;switch(o){case-9527:case-95270:break;case-500:case-502:case-504:case-508:case-510:t.close(4,o);break;case-506:t.close(11,o);break;case-501:t.close(11,o)}}},onServerRefuseEnter:function(e){var t=this,n=e.failed;switch(n){case-9527:case-95270:t.close(4,-9527);break;case-500:case-502:case-504:case-508:case-510:t.close(4,n);break;case-506:t.close(11,n);break;default:t.close(2)}},onEnterFail:function(){var e=this;e.__getCopyInterval&&clearInterval(e.__getCopyInterval)},onEnterSuccess:function(){var e=this;setTimeout(function(){e._failIcesRebuild()},200),e.getCopyIntervalMillis&&e.getCopyIntervalMillis>0&&(s.warn("Run interval get copy. interval = ",e.getCopyIntervalMillis),e.__getCopyInterval&&clearInterval(e.__getCopyInterval),e.__getCopyInterval=setInterval(function(){e._session.connected()?e._sysCopy.apply(e):(s.warn("Warn! cannot get copy. cause offline."),e.__getCopyInterval&&clearInterval(e.__getCopyInterval))},e.getCopyIntervalMillis))},onWSClose:function(){var e=this;e.__getCopyInterval&&clearInterval(e.__getCopyInterval),s.info("Websocket closed.")},onICEDisconnected:function(e){var t=this;t.__networkWeakInterval&&clearTimeout(t.__networkWeakInterval),t.__networkWeakInterval=setTimeout(function(){t.onNetworkWeak&&t.onNetworkWeak()},1e3),r.forEach(t._linkedStreams,function(n,o){if(o.rtcId==e.getRtcId()){var i;(i=t._maybeNotExistStreams[n])||(i=t._maybeNotExistStreams[n]=r.extend({},o),i.iceRebuildCount=1),s.info("Stream maybe not exist. caused by disconnected",o.id)}})},onICEConnectFail:function(e){var t=this;for(var n in t._linkedStreams){var i=t._linkedStreams[n];if(i.rtcId==e.getRtcId()){var c;if((c=t._maybeNotExistStreams[n])||(c=t._maybeNotExistStreams[n]=r.extend({},i),c.iceRebuildCount=1),c){var a=new o.StreamState({stream:c});a.iceFail(),t.onEvent(a)}if(s.info("ice fail. webrtc = ",e.getRtcId()," problem stream is ",c.iceRebuildCount,c.id),c.iceRebuildCount>emedia.config.iceRebuildCount)s.info("ice fail. webrtc = ",e.getRtcId()," rebuild fail. problem stream is ",c.id),c.located()?t.onEvent(new o.PushFail({stream:i,cause:"pub ice rebuild failed."})):t.onEvent(new o.SubFail({stream:i,cause:"sub ice rebuild failed."})),t.closeWebrtc(e.getRtcId(),!1);else{var d=t._records[c.id];s.info("ice fail. webrtc = ",e.getRtcId()," will rebuild. remain local stream. ",c.id),t.closeWebrtc(e.getRtcId(),!0),d&&(t._records[c.id]=d),setTimeout(function(){t.iceRebuild(c)},emedia.config.iceRebuildIntervalMillis),s.info("ice fail. webrtc = ",e.getRtcId()," will rebuild. problem stream is ",c.id)}}}},onICEClosed:function(e){var t=this;if(e.closed){s.warn("Webrtc will be removed. by __id = ",e.__id,", rtcId = ",e.getRtcId());var n=r.removeAttribute(t._ices,e.__id);n?s.warn("Webrtc removed. by id = ",n.__id,", rtcId = ",n.getRtcId()):s.warn("Webrtc removed. by id = ",e.__id,", rtcId = ",e.getRtcId());var o=t._ices[e.getRtcId()];o&&o.__id===n.__id&&(n=r.removeAttribute(t._ices,e.getRtcId()),s.warn("Webrtc removed. by rtcId = ",n.getRtcId(),", __id = ",n.__id))}else s.info("ICE self closed. not allow. will rebuild",e.getRtcId()),t.onICEConnectFail(e)},onICEConnected:function(e){var t=this;r.forEach(t._cacheStreams,function(n,i){if(i.rtcId==e.getRtcId())if(t._maybeNotExistStreams[n]){r.removeAttribute(t._maybeNotExistStreams,i.id),t._linkedStreams[n]=i,s.info("ice reconnected. webrtc = ",e.getRtcId(),"will update stream = ",i.id);var c=t._records[i.id];c&&c.rtcId!==i.rtcId&&(t.startRecord(i),s.warn("Re record. for ",i.id,", after rebuild ice.",c.rtcId,"->",i.rtcId))}else s.info("ice connected. webrtc = ",e.getRtcId(),i.id),i.located()&&t.onEvent(new o.PushSuccess({stream:i})),i.located()||t.onEvent(new o.SubSuccess({stream:i}))})},onICERemoteMediaStream:function(e){var t=this;r.forEach(t._cacheStreams,function(n,r){if(r.rtcId==e.getRtcId()&&!r.located()){var r=t.newStream(r);r.mediaStream=r.getMediaStream(),t._updateRemoteStream(r,r.mediaStream),t.onUpdateStream(r,new r.Update({mediaStream:r.mediaStream}))}})},_failIcesRebuild:function(){var e=this,t=1;r.forEach(e._maybeNotExistStreams,function(n,r){setTimeout(function(){e.iceRebuild(r)},100*t)})},iceRebuild:function(e){var t=this;return t.connected()?t._linkedStreams[e.id]&&t._cacheStreams[e.id]?void(e.iceRebuildCount>emedia.config.iceRebuildCount?(s.info("ice rebuild fail. count too many. stream is ",e.id),e.located()?t.onEvent(new o.PushFail({stream:e,cause:"pub ice rebuild failed."})):t.onEvent(new o.SubFail({stream:e,cause:"sub ice rebuild failed."}))):t.connected()?(s.info("ice try rebuild. count",e.iceRebuildCount,". stream is ",e.id),t.rebuildIce(e),e.iceRebuildCount++):s.warn("ice rebuild. stop. cause by not websocket disconnect",e.id)):(s.info("ice rebuild fail. it yet closed. stream is ",e.id,e.rtcId),r.removeAttribute(t._maybeNotExistStreams,e.id),void r.removeAttribute(t._linkedStreams,e.id)):(e.iceRebuildCount=1,void s.warn("Websocket disconnect. waiting. rebuild count reset",e.iceRebuildCount,e.id))},rebuildIce:function(e){var t=this;return t._cacheStreams[e.id]?(s.warn("Begin rebuild ice ",e.iceRebuildCount,e.id),e.located()?(e.isRepublished=!0,t.push(e,void 0,void 0,!0)):t.createWebrtcAndSubscribeStream(e.id),void s.warn("Finish rebuild ice ",e.iceRebuildCount,e.id,t._cacheStreams[e.id].rtcId)):void s.warn("Begin rebuild ice. not found stream at local",e.iceRebuildCount,e.id)},_sysCopy:function(){var e=this,t=e.newMessage().setOp(1e3).setCver(e._cver||0);e.postMessage(t,function(t){return 0!=t.result?void s.error("Get copy fail. result = ",t.result):void((e._cver||0)<t.cver&&(e._cver=t.cver,e.onMembers(t.cver,t.mems||{}),e.onStreams(t.cver,t.streams||{}),s.info("Got copy success.")))})}});e.exports=i},function(e,t,n){"use strict";var r=n(5),s=r.tagLogger("Desktop"),o=n(8);window.__shareDesktopMessageCount__=0,e.exports=r.prototypeExtend({__RTC_PAGE_MSG_TYPE__:"RTC-SD-PAGE",__RTC_EXT_MSG_TYPE__:"RTC-SD-EXT",__init__:function(){var e=this;e.__extLoaded=e.rsdExtLoaded(),e.__extLoaded&&e.__onRsdExtLoad(),window.addEventListener("load",function(t){if(!e.__extLoaded){var n=e.rsdExtLoaded();e.__extLoaded=n}}),window.addEventListener("message",function(t){if(t.data){var n=t.data;if(n.type&&n.type===e.__RTC_EXT_MSG_TYPE__&&n.evname)return s.info("got ext-msg: ",n),"extLoaded"===n.evname?void(e.__extLoaded||(e.__extLoaded=!0,setTimeout(e.__onRsdExtLoad(),50))):void e.__onMessage(n)}})},rsdExtLoaded:function(){var e=document.getElementById("RTC-Share-Deskto-installed-ele-rat1abrr");return!!e},__sendMessage:function(e,t){var n=this,r="tsx_"+__shareDesktopMessageCount__++ +"_"+Math.random().toString(36).substr(2,4);if(!n.__extLoaded)throw"Rtc share desktop not loaded";e.tsxId=r,n["on_"+r]=function(){t&&t.apply(n,arguments),delete n["on_"+r]},window.postMessage(e,"*")},__onMessage:function(e){var t=this,n=e.tsxId;t["on_"+n]&&t["on_"+n](e)},__onRsdExtLoad:function(){var e=this;e.onExtLoaded&&e.onExtLoaded()},openDesktopMedia:function(e,t){var n=this;if(!n.__extLoaded||!n.rsdExtLoaded())return void t(new o.ShareDesktopExtensionNotFound);var r={type:n.__RTC_PAGE_MSG_TYPE__,evname:"chooseDesktopMedia",screenOptions:e};n.__sendMessage(r,function(e){t("onAccessApproved"===e.evname&&e.streamId?new o.OpenDesktopMedia({desktopStreamId:e.streamId}):new o.OpenDesktopMediaAccessDenied)})}})}])}]);